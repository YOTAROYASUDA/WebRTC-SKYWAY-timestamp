(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function i(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=i(r);fetch(r.href,s)}})();var K_=Object.create,El=Object.defineProperty,X_=Object.defineProperties,$_=Object.getOwnPropertyDescriptor,Z_=Object.getOwnPropertyDescriptors,mh=Object.getOwnPropertyNames,dp=Object.getOwnPropertySymbols,Y_=Object.getPrototypeOf,nm=Object.prototype.hasOwnProperty,J_=Object.prototype.propertyIsEnumerable,Na=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),Q_=t=>{throw TypeError(t)},ns=Math.pow,au=(t,e,i)=>e in t?El(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,ae=(t,e)=>{for(var i in e||(e={}))nm.call(e,i)&&au(t,i,e[i]);if(dp)for(var i of dp(e))J_.call(e,i)&&au(t,i,e[i]);return t},we=(t,e)=>X_(t,Z_(e)),e0=(t,e)=>function(){return t&&(e=(0,t[mh(t)[0]])(t=0)),e},Fe=(t,e)=>function(){return e||(0,t[mh(t)[0]])((e={exports:{}}).exports,e),e.exports},rm=(t,e)=>{for(var i in e)El(t,i,{get:e[i],enumerable:!0})},t0=(t,e,i,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of mh(e))!nm.call(t,r)&&r!==i&&El(t,r,{get:()=>e[r],enumerable:!(n=$_(e,r))||n.enumerable});return t},Hn=(t,e,i)=>(i=t!=null?K_(Y_(t)):{},t0(!t||!t.__esModule?El(i,"default",{value:t,enumerable:!0}):i,t)),La=(t,e,i)=>au(t,typeof e!="symbol"?e+"":e,i),j=(t,e,i)=>new Promise((n,r)=>{var s=h=>{try{c(i.next(h))}catch(d){r(d)}},o=h=>{try{c(i.throw(h))}catch(d){r(d)}},c=h=>h.done?n(h.value):Promise.resolve(h.value).then(s,o);c((i=i.apply(t,e)).next())}),ja=function(t,e){this[0]=t,this[1]=e},sm=(t,e,i)=>{var n=(o,c,h,d)=>{try{var p=i[o](c),v=(c=p.value)instanceof ja,g=p.done;Promise.resolve(v?c[0]:c).then(_=>v?n(o==="return"?o:"next",c[1]?{done:_.done,value:_.value}:_,h,d):h({value:_,done:g})).catch(_=>n("throw",_,h,d))}catch(_){d(_)}},r=o=>s[o]=c=>new Promise((h,d)=>n(o,c,h,d)),s={};return i=i.apply(t,e),s[Na("asyncIterator")]=()=>s,r("next"),r("throw"),r("return"),s},am=t=>{var e=t[Na("asyncIterator")],i=!1,n,r={};return e==null?(e=t[Na("iterator")](),n=s=>r[s]=o=>e[s](o)):(e=e.call(t),n=s=>r[s]=o=>{if(i){if(i=!1,s==="throw")throw o;return o}return i=!0,{done:!1,value:new ja(new Promise(c=>{var h=e[s](o);h instanceof Object||Q_("Object expected"),c(h)}),1)}}),r[Na("iterator")]=()=>r,n("next"),"throw"in e?n("throw"):r.throw=s=>{throw s},"return"in e&&n("return"),r},i0=(t,e,i)=>(e=t[Na("asyncIterator")])?e.call(t):(t=t[Na("iterator")](),e={},i=(n,r)=>(r=t[n])&&(e[n]=s=>new Promise((o,c,h)=>(s=r.call(t,s),h=s.done,Promise.resolve(s.value).then(d=>o({value:d,done:h}),c)))),i("next"),i("return"),e),Oa,ne=e0({"shims/process.js"(){Oa=void 0}}),n0=Fe({"../../node_modules/bowser/es5.js"(t,e){ne(),function(i,n){typeof t=="object"&&typeof e=="object"?e.exports=n():typeof define=="function"&&define.amd?define([],n):typeof t=="object"?t.bowser=n():i.bowser=n()}(t,function(){return function(i){var n={};function r(s){if(n[s])return n[s].exports;var o=n[s]={i:s,l:!1,exports:{}};return i[s].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=i,r.c=n,r.d=function(s,o,c){r.o(s,o)||Object.defineProperty(s,o,{enumerable:!0,get:c})},r.r=function(s){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(s,"__esModule",{value:!0})},r.t=function(s,o){if(1&o&&(s=r(s)),8&o||4&o&&typeof s=="object"&&s&&s.__esModule)return s;var c=Object.create(null);if(r.r(c),Object.defineProperty(c,"default",{enumerable:!0,value:s}),2&o&&typeof s!="string")for(var h in s)r.d(c,h,(function(d){return s[d]}).bind(null,h));return c},r.n=function(s){var o=s&&s.__esModule?function(){return s.default}:function(){return s};return r.d(o,"a",o),o},r.o=function(s,o){return Object.prototype.hasOwnProperty.call(s,o)},r.p="",r(r.s=90)}({17:function(i,n,r){n.__esModule=!0,n.default=void 0;var s=r(18),o=function(){function c(){}return c.getFirstMatch=function(h,d){var p=d.match(h);return p&&p.length>0&&p[1]||""},c.getSecondMatch=function(h,d){var p=d.match(h);return p&&p.length>1&&p[2]||""},c.matchAndReturnConst=function(h,d,p){if(h.test(d))return p},c.getWindowsVersionName=function(h){switch(h){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}},c.getMacOSVersionName=function(h){var d=h.split(".").splice(0,2).map(function(p){return parseInt(p,10)||0});if(d.push(0),d[0]===10)switch(d[1]){case 5:return"Leopard";case 6:return"Snow Leopard";case 7:return"Lion";case 8:return"Mountain Lion";case 9:return"Mavericks";case 10:return"Yosemite";case 11:return"El Capitan";case 12:return"Sierra";case 13:return"High Sierra";case 14:return"Mojave";case 15:return"Catalina";default:return}},c.getAndroidVersionName=function(h){var d=h.split(".").splice(0,2).map(function(p){return parseInt(p,10)||0});if(d.push(0),!(d[0]===1&&d[1]<5))return d[0]===1&&d[1]<6?"Cupcake":d[0]===1&&d[1]>=6?"Donut":d[0]===2&&d[1]<2?"Eclair":d[0]===2&&d[1]===2?"Froyo":d[0]===2&&d[1]>2?"Gingerbread":d[0]===3?"Honeycomb":d[0]===4&&d[1]<1?"Ice Cream Sandwich":d[0]===4&&d[1]<4?"Jelly Bean":d[0]===4&&d[1]>=4?"KitKat":d[0]===5?"Lollipop":d[0]===6?"Marshmallow":d[0]===7?"Nougat":d[0]===8?"Oreo":d[0]===9?"Pie":void 0},c.getVersionPrecision=function(h){return h.split(".").length},c.compareVersions=function(h,d,p){p===void 0&&(p=!1);var v=c.getVersionPrecision(h),g=c.getVersionPrecision(d),_=Math.max(v,g),S=0,E=c.map([h,d],function(M){var R=_-c.getVersionPrecision(M),N=M+new Array(R+1).join(".0");return c.map(N.split("."),function(b){return new Array(20-b.length).join("0")+b}).reverse()});for(p&&(S=_-Math.min(v,g)),_-=1;_>=S;){if(E[0][_]>E[1][_])return 1;if(E[0][_]===E[1][_]){if(_===S)return 0;_-=1}else if(E[0][_]<E[1][_])return-1}},c.map=function(h,d){var p,v=[];if(Array.prototype.map)return Array.prototype.map.call(h,d);for(p=0;p<h.length;p+=1)v.push(d(h[p]));return v},c.find=function(h,d){var p,v;if(Array.prototype.find)return Array.prototype.find.call(h,d);for(p=0,v=h.length;p<v;p+=1){var g=h[p];if(d(g,p))return g}},c.assign=function(h){for(var d,p,v=h,g=arguments.length,_=new Array(g>1?g-1:0),S=1;S<g;S++)_[S-1]=arguments[S];if(Object.assign)return Object.assign.apply(Object,[h].concat(_));var E=function(){var M=_[d];typeof M=="object"&&M!==null&&Object.keys(M).forEach(function(R){v[R]=M[R]})};for(d=0,p=_.length;d<p;d+=1)E();return h},c.getBrowserAlias=function(h){return s.BROWSER_ALIASES_MAP[h]},c.getBrowserTypeByAlias=function(h){return s.BROWSER_MAP[h]||""},c}();n.default=o,i.exports=n.default},18:function(i,n,r){n.__esModule=!0,n.ENGINE_MAP=n.OS_MAP=n.PLATFORMS_MAP=n.BROWSER_MAP=n.BROWSER_ALIASES_MAP=void 0,n.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"},n.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"},n.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"},n.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"},n.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"}},90:function(i,n,r){n.__esModule=!0,n.default=void 0;var s,o=(s=r(91))&&s.__esModule?s:{default:s},c=r(18);function h(p,v){for(var g=0;g<v.length;g++){var _=v[g];_.enumerable=_.enumerable||!1,_.configurable=!0,"value"in _&&(_.writable=!0),Object.defineProperty(p,_.key,_)}}var d=function(){function p(){}var v,g,_;return p.getParser=function(S,E){if(E===void 0&&(E=!1),typeof S!="string")throw new Error("UserAgent should be a string");return new o.default(S,E)},p.parse=function(S){return new o.default(S).getResult()},v=p,_=[{key:"BROWSER_MAP",get:function(){return c.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return c.ENGINE_MAP}},{key:"OS_MAP",get:function(){return c.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return c.PLATFORMS_MAP}}],(g=null)&&h(v.prototype,g),_&&h(v,_),p}();n.default=d,i.exports=n.default},91:function(i,n,r){n.__esModule=!0,n.default=void 0;var s=p(r(92)),o=p(r(93)),c=p(r(94)),h=p(r(95)),d=p(r(17));function p(g){return g&&g.__esModule?g:{default:g}}var v=function(){function g(S,E){if(E===void 0&&(E=!1),S==null||S==="")throw new Error("UserAgent parameter can't be empty");this._ua=S,this.parsedResult={},E!==!0&&this.parse()}var _=g.prototype;return _.getUA=function(){return this._ua},_.test=function(S){return S.test(this._ua)},_.parseBrowser=function(){var S=this;this.parsedResult.browser={};var E=d.default.find(s.default,function(M){if(typeof M.test=="function")return M.test(S);if(M.test instanceof Array)return M.test.some(function(R){return S.test(R)});throw new Error("Browser's test function is not valid")});return E&&(this.parsedResult.browser=E.describe(this.getUA())),this.parsedResult.browser},_.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},_.getBrowserName=function(S){return S?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},_.getBrowserVersion=function(){return this.getBrowser().version},_.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},_.parseOS=function(){var S=this;this.parsedResult.os={};var E=d.default.find(o.default,function(M){if(typeof M.test=="function")return M.test(S);if(M.test instanceof Array)return M.test.some(function(R){return S.test(R)});throw new Error("Browser's test function is not valid")});return E&&(this.parsedResult.os=E.describe(this.getUA())),this.parsedResult.os},_.getOSName=function(S){var E=this.getOS().name;return S?String(E).toLowerCase()||"":E||""},_.getOSVersion=function(){return this.getOS().version},_.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},_.getPlatformType=function(S){S===void 0&&(S=!1);var E=this.getPlatform().type;return S?String(E).toLowerCase()||"":E||""},_.parsePlatform=function(){var S=this;this.parsedResult.platform={};var E=d.default.find(c.default,function(M){if(typeof M.test=="function")return M.test(S);if(M.test instanceof Array)return M.test.some(function(R){return S.test(R)});throw new Error("Browser's test function is not valid")});return E&&(this.parsedResult.platform=E.describe(this.getUA())),this.parsedResult.platform},_.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},_.getEngineName=function(S){return S?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},_.parseEngine=function(){var S=this;this.parsedResult.engine={};var E=d.default.find(h.default,function(M){if(typeof M.test=="function")return M.test(S);if(M.test instanceof Array)return M.test.some(function(R){return S.test(R)});throw new Error("Browser's test function is not valid")});return E&&(this.parsedResult.engine=E.describe(this.getUA())),this.parsedResult.engine},_.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},_.getResult=function(){return d.default.assign({},this.parsedResult)},_.satisfies=function(S){var E=this,M={},R=0,N={},b=0;if(Object.keys(S).forEach(function(z){var K=S[z];typeof K=="string"?(N[z]=K,b+=1):typeof K=="object"&&(M[z]=K,R+=1)}),R>0){var m=Object.keys(M),w=d.default.find(m,function(z){return E.isOS(z)});if(w){var T=this.satisfies(M[w]);if(T!==void 0)return T}var P=d.default.find(m,function(z){return E.isPlatform(z)});if(P){var L=this.satisfies(M[P]);if(L!==void 0)return L}}if(b>0){var k=Object.keys(N),I=d.default.find(k,function(z){return E.isBrowser(z,!0)});if(I!==void 0)return this.compareVersion(N[I])}},_.isBrowser=function(S,E){E===void 0&&(E=!1);var M=this.getBrowserName().toLowerCase(),R=S.toLowerCase(),N=d.default.getBrowserTypeByAlias(R);return E&&N&&(R=N.toLowerCase()),R===M},_.compareVersion=function(S){var E=[0],M=S,R=!1,N=this.getBrowserVersion();if(typeof N=="string")return S[0]===">"||S[0]==="<"?(M=S.substr(1),S[1]==="="?(R=!0,M=S.substr(2)):E=[],S[0]===">"?E.push(1):E.push(-1)):S[0]==="="?M=S.substr(1):S[0]==="~"&&(R=!0,M=S.substr(1)),E.indexOf(d.default.compareVersions(N,M,R))>-1},_.isOS=function(S){return this.getOSName(!0)===String(S).toLowerCase()},_.isPlatform=function(S){return this.getPlatformType(!0)===String(S).toLowerCase()},_.isEngine=function(S){return this.getEngineName(!0)===String(S).toLowerCase()},_.is=function(S,E){return E===void 0&&(E=!1),this.isBrowser(S,E)||this.isOS(S)||this.isPlatform(S)},_.some=function(S){var E=this;return S===void 0&&(S=[]),S.some(function(M){return E.is(M)})},g}();n.default=v,i.exports=n.default},92:function(i,n,r){n.__esModule=!0,n.default=void 0;var s,o=(s=r(17))&&s.__esModule?s:{default:s},c=/version\/(\d+(\.?_?\d+)+)/i,h=[{test:[/googlebot/i],describe:function(d){var p={name:"Googlebot"},v=o.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/opera/i],describe:function(d){var p={name:"Opera"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/opr\/|opios/i],describe:function(d){var p={name:"Opera"},v=o.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/SamsungBrowser/i],describe:function(d){var p={name:"Samsung Internet for Android"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/Whale/i],describe:function(d){var p={name:"NAVER Whale Browser"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/MZBrowser/i],describe:function(d){var p={name:"MZ Browser"},v=o.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/focus/i],describe:function(d){var p={name:"Focus"},v=o.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/swing/i],describe:function(d){var p={name:"Swing"},v=o.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/coast/i],describe:function(d){var p={name:"Opera Coast"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(d){var p={name:"Opera Touch"},v=o.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/yabrowser/i],describe:function(d){var p={name:"Yandex Browser"},v=o.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/ucbrowser/i],describe:function(d){var p={name:"UC Browser"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/Maxthon|mxios/i],describe:function(d){var p={name:"Maxthon"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/epiphany/i],describe:function(d){var p={name:"Epiphany"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/puffin/i],describe:function(d){var p={name:"Puffin"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/sleipnir/i],describe:function(d){var p={name:"Sleipnir"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/k-meleon/i],describe:function(d){var p={name:"K-Meleon"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/micromessenger/i],describe:function(d){var p={name:"WeChat"},v=o.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/qqbrowser/i],describe:function(d){var p={name:/qqbrowserlite/i.test(d)?"QQ Browser Lite":"QQ Browser"},v=o.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/msie|trident/i],describe:function(d){var p={name:"Internet Explorer"},v=o.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/\sedg\//i],describe:function(d){var p={name:"Microsoft Edge"},v=o.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/edg([ea]|ios)/i],describe:function(d){var p={name:"Microsoft Edge"},v=o.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/vivaldi/i],describe:function(d){var p={name:"Vivaldi"},v=o.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/seamonkey/i],describe:function(d){var p={name:"SeaMonkey"},v=o.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/sailfish/i],describe:function(d){var p={name:"Sailfish"},v=o.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,d);return v&&(p.version=v),p}},{test:[/silk/i],describe:function(d){var p={name:"Amazon Silk"},v=o.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/phantom/i],describe:function(d){var p={name:"PhantomJS"},v=o.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/slimerjs/i],describe:function(d){var p={name:"SlimerJS"},v=o.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(d){var p={name:"BlackBerry"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/(web|hpw)[o0]s/i],describe:function(d){var p={name:"WebOS Browser"},v=o.default.getFirstMatch(c,d)||o.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/bada/i],describe:function(d){var p={name:"Bada"},v=o.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/tizen/i],describe:function(d){var p={name:"Tizen"},v=o.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/qupzilla/i],describe:function(d){var p={name:"QupZilla"},v=o.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/firefox|iceweasel|fxios/i],describe:function(d){var p={name:"Firefox"},v=o.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/electron/i],describe:function(d){var p={name:"Electron"},v=o.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/MiuiBrowser/i],describe:function(d){var p={name:"Miui"},v=o.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/chromium/i],describe:function(d){var p={name:"Chromium"},v=o.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,d)||o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/chrome|crios|crmo/i],describe:function(d){var p={name:"Chrome"},v=o.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/GSA/i],describe:function(d){var p={name:"Google Search"},v=o.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:function(d){var p=!d.test(/like android/i),v=d.test(/android/i);return p&&v},describe:function(d){var p={name:"Android Browser"},v=o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/playstation 4/i],describe:function(d){var p={name:"PlayStation 4"},v=o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/safari|applewebkit/i],describe:function(d){var p={name:"Safari"},v=o.default.getFirstMatch(c,d);return v&&(p.version=v),p}},{test:[/.*/i],describe:function(d){var p=d.search("\\(")!==-1?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return{name:o.default.getFirstMatch(p,d),version:o.default.getSecondMatch(p,d)}}}];n.default=h,i.exports=n.default},93:function(i,n,r){n.__esModule=!0,n.default=void 0;var s,o=(s=r(17))&&s.__esModule?s:{default:s},c=r(18),h=[{test:[/Roku\/DVP/],describe:function(d){var p=o.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,d);return{name:c.OS_MAP.Roku,version:p}}},{test:[/windows phone/i],describe:function(d){var p=o.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,d);return{name:c.OS_MAP.WindowsPhone,version:p}}},{test:[/windows /i],describe:function(d){var p=o.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,d),v=o.default.getWindowsVersionName(p);return{name:c.OS_MAP.Windows,version:p,versionName:v}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(d){var p={name:c.OS_MAP.iOS},v=o.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,d);return v&&(p.version=v),p}},{test:[/macintosh/i],describe:function(d){var p=o.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,d).replace(/[_\s]/g,"."),v=o.default.getMacOSVersionName(p),g={name:c.OS_MAP.MacOS,version:p};return v&&(g.versionName=v),g}},{test:[/(ipod|iphone|ipad)/i],describe:function(d){var p=o.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,d).replace(/[_\s]/g,".");return{name:c.OS_MAP.iOS,version:p}}},{test:function(d){var p=!d.test(/like android/i),v=d.test(/android/i);return p&&v},describe:function(d){var p=o.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,d),v=o.default.getAndroidVersionName(p),g={name:c.OS_MAP.Android,version:p};return v&&(g.versionName=v),g}},{test:[/(web|hpw)[o0]s/i],describe:function(d){var p=o.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,d),v={name:c.OS_MAP.WebOS};return p&&p.length&&(v.version=p),v}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(d){var p=o.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,d)||o.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,d)||o.default.getFirstMatch(/\bbb(\d+)/i,d);return{name:c.OS_MAP.BlackBerry,version:p}}},{test:[/bada/i],describe:function(d){var p=o.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,d);return{name:c.OS_MAP.Bada,version:p}}},{test:[/tizen/i],describe:function(d){var p=o.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,d);return{name:c.OS_MAP.Tizen,version:p}}},{test:[/linux/i],describe:function(){return{name:c.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return{name:c.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(d){var p=o.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,d);return{name:c.OS_MAP.PlayStation4,version:p}}}];n.default=h,i.exports=n.default},94:function(i,n,r){n.__esModule=!0,n.default=void 0;var s,o=(s=r(17))&&s.__esModule?s:{default:s},c=r(18),h=[{test:[/googlebot/i],describe:function(){return{type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(d){var p=o.default.getFirstMatch(/(can-l01)/i,d)&&"Nova",v={type:c.PLATFORMS_MAP.mobile,vendor:"Huawei"};return p&&(v.model=p),v}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return{type:c.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return{type:c.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return{type:c.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return{type:c.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return{type:c.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return{type:c.PLATFORMS_MAP.tablet}}},{test:function(d){var p=d.test(/ipod|iphone/i),v=d.test(/like (ipod|iphone)/i);return p&&!v},describe:function(d){var p=o.default.getFirstMatch(/(ipod|iphone)/i,d);return{type:c.PLATFORMS_MAP.mobile,vendor:"Apple",model:p}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return{type:c.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return{type:c.PLATFORMS_MAP.mobile}}},{test:function(d){return d.getBrowserName(!0)==="blackberry"},describe:function(){return{type:c.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(d){return d.getBrowserName(!0)==="bada"},describe:function(){return{type:c.PLATFORMS_MAP.mobile}}},{test:function(d){return d.getBrowserName()==="windows phone"},describe:function(){return{type:c.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(d){var p=Number(String(d.getOSVersion()).split(".")[0]);return d.getOSName(!0)==="android"&&p>=3},describe:function(){return{type:c.PLATFORMS_MAP.tablet}}},{test:function(d){return d.getOSName(!0)==="android"},describe:function(){return{type:c.PLATFORMS_MAP.mobile}}},{test:function(d){return d.getOSName(!0)==="macos"},describe:function(){return{type:c.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(d){return d.getOSName(!0)==="windows"},describe:function(){return{type:c.PLATFORMS_MAP.desktop}}},{test:function(d){return d.getOSName(!0)==="linux"},describe:function(){return{type:c.PLATFORMS_MAP.desktop}}},{test:function(d){return d.getOSName(!0)==="playstation 4"},describe:function(){return{type:c.PLATFORMS_MAP.tv}}},{test:function(d){return d.getOSName(!0)==="roku"},describe:function(){return{type:c.PLATFORMS_MAP.tv}}}];n.default=h,i.exports=n.default},95:function(i,n,r){n.__esModule=!0,n.default=void 0;var s,o=(s=r(17))&&s.__esModule?s:{default:s},c=r(18),h=[{test:function(d){return d.getBrowserName(!0)==="microsoft edge"},describe:function(d){if(/\sedg\//i.test(d))return{name:c.ENGINE_MAP.Blink};var p=o.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,d);return{name:c.ENGINE_MAP.EdgeHTML,version:p}}},{test:[/trident/i],describe:function(d){var p={name:c.ENGINE_MAP.Trident},v=o.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:function(d){return d.test(/presto/i)},describe:function(d){var p={name:c.ENGINE_MAP.Presto},v=o.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:function(d){var p=d.test(/gecko/i),v=d.test(/like gecko/i);return p&&!v},describe:function(d){var p={name:c.ENGINE_MAP.Gecko},v=o.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return{name:c.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(d){var p={name:c.ENGINE_MAP.WebKit},v=o.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,d);return v&&(p.version=v),p}}];n.default=h,i.exports=n.default}})})}}),gh=Fe({"../../node_modules/sdp-transform/lib/grammar.js"(t,e){ne();var i=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(n){return n.encoding?"rtpmap:%d %s/%s/%s":n.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(n){return n.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(n){return n.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(n){return"extmap:%d"+(n.direction?"/%s":"%v")+(n["encrypt-uri"]?" %s":"%v")+" %s"+(n.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(n){return n.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(n){var r="candidate:%s %d %s %d %s %d typ %s";return r+=n.raddr!=null?" raddr %s rport %d":"%v%v",r+=n.tcptype!=null?" tcptype %s":"%v",n.generation!=null&&(r+=" generation %d"),r+=n["network-id"]!=null?" network-id %d":"%v",r+=n["network-cost"]!=null?" network-cost %d":"%v",r}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(n){var r="ssrc:%d";return n.attribute!=null&&(r+=" %s",n.value!=null&&(r+=":%s")),r}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(n){return n.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(n){return n.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(n){return"imageattr:%s %s %s"+(n.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(n){return"simulcast:%s %s"+(n.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(n){return"ts-refclk:%s"+(n.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(n){var r="mediaclk:";return r+=n.id!=null?"id=%s %s":"%v%s",r+=n.mediaClockValue!=null?"=%s":"",r+=n.rateNumerator!=null?" rate=%s":"",r+=n.rateDenominator!=null?"/%s":"",r}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(i).forEach(function(n){var r=i[n];r.forEach(function(s){s.reg||(s.reg=/(.*)/),s.format||(s.format="%s")})})}}),r0=Fe({"../../node_modules/sdp-transform/lib/parser.js"(t){ne();var e=function(c){return String(Number(c))===c?Number(c):c},i=function(c,h,d,p){if(p&&!d)h[p]=e(c[1]);else for(var v=0;v<d.length;v+=1)c[v+1]!=null&&(h[d[v]]=e(c[v+1]))},n=function(c,h,d){var p=c.name&&c.names;c.push&&!h[c.push]?h[c.push]=[]:p&&!h[c.name]&&(h[c.name]={});var v=c.push?{}:p?h[c.name]:h;i(d.match(c.reg),v,c.names,c.name),c.push&&h[c.push].push(v)},r=gh(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(c){var h={},d=[],p=h;return c.split(/(\r\n|\r|\n)/).filter(s).forEach(function(v){var g=v[0],_=v.slice(2);g==="m"&&(d.push({rtp:[],fmtp:[]}),p=d[d.length-1]);for(var S=0;S<(r[g]||[]).length;S+=1){var E=r[g][S];if(E.reg.test(_))return n(E,p,_)}}),h.media=d,h};var o=function(c,h){var d=h.split(/=(.+)/,2);return d.length===2?c[d[0]]=e(d[1]):d.length===1&&h.length>1&&(c[d[0]]=void 0),c};t.parseParams=function(c){return c.split(/;\s?/).reduce(o,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(c){return c.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(c){for(var h=[],d=c.split(" ").map(e),p=0;p<d.length;p+=3)h.push({component:d[p],ip:d[p+1],port:d[p+2]});return h},t.parseImageAttributes=function(c){return c.split(" ").map(function(h){return h.substring(1,h.length-1).split(",").reduce(o,{})})},t.parseSimulcastStreamList=function(c){return c.split(";").map(function(h){return h.split(",").map(function(d){var p,v=!1;return d[0]!=="~"?p=e(d):(p=e(d.substring(1,d.length)),v=!0),{scid:p,paused:v}})})}}}),s0=Fe({"../../node_modules/sdp-transform/lib/writer.js"(t,e){ne();var i=gh(),n=/%[sdv%]/g,r=function(h){var d=1,p=arguments,v=p.length;return h.replace(n,function(g){if(d>=v)return g;var _=p[d];switch(d+=1,g){case"%%":return"%";case"%s":return String(_);case"%d":return Number(_);case"%v":return""}})},s=function(h,d,p){var v=d.format instanceof Function?d.format(d.push?p:p[d.name]):d.format,g=[h+"="+v];if(d.names)for(var _=0;_<d.names.length;_+=1){var S=d.names[_];d.name?g.push(p[d.name][S]):g.push(p[d.names[_]])}else g.push(p[d.name]);return r.apply(null,g)},o=["v","o","s","i","u","e","p","c","b","t","r","z","a"],c=["i","c","b","a"];e.exports=function(h,d){d=d||{},h.version==null&&(h.version=0),h.name==null&&(h.name=" "),h.media.forEach(function(_){_.payloads==null&&(_.payloads="")});var p=d.outerOrder||o,v=d.innerOrder||c,g=[];return p.forEach(function(_){i[_].forEach(function(S){S.name in h&&h[S.name]!=null?g.push(s(_,S,h)):S.push in h&&h[S.push]!=null&&h[S.push].forEach(function(E){g.push(s(_,S,E))})})}),h.media.forEach(function(_){g.push(s("m",i.m[0],_)),v.forEach(function(S){i[S].forEach(function(E){E.name in _&&_[E.name]!=null?g.push(s(S,E,_)):E.push in _&&_[E.push]!=null&&_[E.push].forEach(function(M){g.push(s(S,E,M))})})})}),g.join(`\r
`)+`\r
`}}}),ln=Fe({"../../node_modules/sdp-transform/lib/index.js"(t){ne();var e=r0(),i=s0(),n=gh();t.grammar=n,t.write=i,t.parse=e.parse,t.parseParams=e.parseParams,t.parseFmtpConfig=e.parseFmtpConfig,t.parsePayloads=e.parsePayloads,t.parseRemoteCandidates=e.parseRemoteCandidates,t.parseImageAttributes=e.parseImageAttributes,t.parseSimulcastStreamList=e.parseSimulcastStreamList}}),om=Fe({"../../node_modules/ua-parser-js/src/ua-parser.js"(t,e){ne(),function(i,n){var r="1.0.40",s="",o="?",c="function",h="undefined",d="object",p="string",v="major",g="model",_="name",S="type",E="vendor",M="version",R="architecture",N="console",b="mobile",m="tablet",w="smarttv",T="wearable",P="embedded",L=500,k="Amazon",I="Apple",z="ASUS",K="BlackBerry",$="Browser",te="Chrome",ee="Edge",de="Firefox",X="Google",le="Huawei",_e="LG",Se="Microsoft",De="Motorola",We="Opera",Ve="Samsung",Me="Sharp",ze="Sony",ht="Xiaomi",nt="Zebra",rt="Facebook",jt="Chromium OS",Ct="Mac OS",li=" Browser",di=function(Pe,Oe){var Ce={};for(var tt in Pe)Oe[tt]&&Oe[tt].length%2===0?Ce[tt]=Oe[tt].concat(Pe[tt]):Ce[tt]=Pe[tt];return Ce},zt=function(Pe){for(var Oe={},Ce=0;Ce<Pe.length;Ce++)Oe[Pe[Ce].toUpperCase()]=Pe[Ce];return Oe},he=function(Pe,Oe){return typeof Pe===p?mi(Oe).indexOf(mi(Pe))!==-1:!1},mi=function(Pe){return Pe.toLowerCase()},ti=function(Pe){return typeof Pe===p?Pe.replace(/[^\d\.]/g,s).split(".")[0]:n},si=function(Pe,Oe){if(typeof Pe===p)return Pe=Pe.replace(/^\s\s*/,s),typeof Oe===h?Pe:Pe.substring(0,L)},yt=function(Pe,Oe){for(var Ce=0,tt,et,ut,Qe,Ie,it;Ce<Oe.length&&!Ie;){var Pt=Oe[Ce],Mt=Oe[Ce+1];for(tt=et=0;tt<Pt.length&&!Ie&&Pt[tt];)if(Ie=Pt[tt++].exec(Pe),Ie)for(ut=0;ut<Mt.length;ut++)it=Ie[++et],Qe=Mt[ut],typeof Qe===d&&Qe.length>0?Qe.length===2?typeof Qe[1]==c?this[Qe[0]]=Qe[1].call(this,it):this[Qe[0]]=Qe[1]:Qe.length===3?typeof Qe[1]===c&&!(Qe[1].exec&&Qe[1].test)?this[Qe[0]]=it?Qe[1].call(this,it,Qe[2]):n:this[Qe[0]]=it?it.replace(Qe[1],Qe[2]):n:Qe.length===4&&(this[Qe[0]]=it?Qe[3].call(this,it.replace(Qe[1],Qe[2])):n):this[Qe]=it||n;Ce+=2}},Xt=function(Pe,Oe){for(var Ce in Oe)if(typeof Oe[Ce]===d&&Oe[Ce].length>0){for(var tt=0;tt<Oe[Ce].length;tt++)if(he(Oe[Ce][tt],Pe))return Ce===o?n:Ce}else if(he(Oe[Ce],Pe))return Ce===o?n:Ce;return Oe.hasOwnProperty("*")?Oe["*"]:Pe},Rt={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},Ut={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Ii={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[M,[_,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[M,[_,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[_,M],[/opios[\/ ]+([\w\.]+)/i],[M,[_,We+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[M,[_,We+" GX"]],[/\bopr\/([\w\.]+)/i],[M,[_,We]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[M,[_,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[M,[_,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[_,M],[/quark(?:pc)?\/([-\w\.]+)/i],[M,[_,"Quark"]],[/\bddg\/([\w\.]+)/i],[M,[_,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[M,[_,"UC"+$]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[M,[_,"WeChat"]],[/konqueror\/([\w\.]+)/i],[M,[_,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[M,[_,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[M,[_,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[M,[_,"Smart Lenovo "+$]],[/(avast|avg)\/([\w\.]+)/i],[[_,/(.+)/,"$1 Secure "+$],M],[/\bfocus\/([\w\.]+)/i],[M,[_,de+" Focus"]],[/\bopt\/([\w\.]+)/i],[M,[_,We+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[M,[_,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[M,[_,"Dolphin"]],[/coast\/([\w\.]+)/i],[M,[_,We+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[M,[_,"MIUI"+li]],[/fxios\/([\w\.-]+)/i],[M,[_,de]],[/\bqihoobrowser\/?([\w\.]*)/i],[M,[_,"360"]],[/\b(qq)\/([\w\.]+)/i],[[_,/(.+)/,"$1Browser"],M],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[_,/(.+)/,"$1"+li],M],[/samsungbrowser\/([\w\.]+)/i],[M,[_,Ve+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[M,[_,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[_,"Sogou Mobile"],M],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[_,M],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[_],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[M,_],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[_,rt],M],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[_,M],[/\bgsa\/([\w\.]+) .*safari\//i],[M,[_,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[M,[_,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[M,[_,te+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[_,te+" WebView"],M],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[M,[_,"Android "+$]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[_,M],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[M,[_,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[M,_],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[_,[M,Xt,Rt]],[/(webkit|khtml)\/([\w\.]+)/i],[_,M],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[_,"Netscape"],M],[/(wolvic|librewolf)\/([\w\.]+)/i],[_,M],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[M,[_,de+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[_,[M,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[_,[M,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[R,"amd64"]],[/(ia32(?=;))/i],[[R,mi]],[/((?:i[346]|x)86)[;\)]/i],[[R,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[R,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[R,"armhf"]],[/windows (ce|mobile); ppc;/i],[[R,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[R,/ower/,s,mi]],[/(sun4\w)[;\)]/i],[[R,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[R,mi]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[g,[E,Ve],[S,m]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[g,[E,Ve],[S,b]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[g,[E,I],[S,b]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[g,[E,I],[S,m]],[/(macintosh);/i],[g,[E,I]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[g,[E,Me],[S,b]],[/(?:honor)([-\w ]+)[;\)]/i],[g,[E,"Honor"],[S,b]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[g,[E,le],[S,m]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[g,[E,le],[S,b]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i],[[g,/_/g," "],[E,ht],[S,b]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[g,/_/g," "],[E,ht],[S,m]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[g,[E,"OPPO"],[S,b]],[/\b(opd2\d{3}a?) bui/i],[g,[E,"OPPO"],[S,m]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[g,[E,"Vivo"],[S,b]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[g,[E,"Realme"],[S,b]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[g,[E,De],[S,b]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[g,[E,De],[S,m]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[g,[E,_e],[S,m]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[g,[E,_e],[S,b]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[g,[E,"Lenovo"],[S,m]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[g,/_/g," "],[E,"Nokia"],[S,b]],[/(pixel c)\b/i],[g,[E,X],[S,m]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[g,[E,X],[S,b]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[g,[E,ze],[S,b]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[g,"Xperia Tablet"],[E,ze],[S,m]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[g,[E,"OnePlus"],[S,b]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[g,[E,k],[S,m]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[g,/(.+)/g,"Fire Phone $1"],[E,k],[S,b]],[/(playbook);[-\w\),; ]+(rim)/i],[g,E,[S,m]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[g,[E,K],[S,b]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[g,[E,z],[S,m]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[g,[E,z],[S,b]],[/(nexus 9)/i],[g,[E,"HTC"],[S,m]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[E,[g,/_/g," "],[S,b]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[g,[E,"TCL"],[S,m]],[/(itel) ((\w+))/i],[[E,mi],g,[S,Xt,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[g,[E,"Acer"],[S,m]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[g,[E,"Meizu"],[S,b]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[g,[E,"Ulefone"],[S,b]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[g,[E,"Energizer"],[S,b]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[g,[E,"Cat"],[S,b]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[g,[E,"Smartfren"],[S,b]],[/droid.+; (a(?:015|06[35]|142p?))/i],[g,[E,"Nothing"],[S,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (imo) ((?!tab)[\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[E,g,[S,b]],[/(imo) (tab \w+)/i,/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[E,g,[S,m]],[/(surface duo)/i],[g,[E,Se],[S,m]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[g,[E,"Fairphone"],[S,b]],[/(u304aa)/i],[g,[E,"AT&T"],[S,b]],[/\bsie-(\w*)/i],[g,[E,"Siemens"],[S,b]],[/\b(rct\w+) b/i],[g,[E,"RCA"],[S,m]],[/\b(venue[\d ]{2,7}) b/i],[g,[E,"Dell"],[S,m]],[/\b(q(?:mv|ta)\w+) b/i],[g,[E,"Verizon"],[S,m]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[g,[E,"Barnes & Noble"],[S,m]],[/\b(tm\d{3}\w+) b/i],[g,[E,"NuVision"],[S,m]],[/\b(k88) b/i],[g,[E,"ZTE"],[S,m]],[/\b(nx\d{3}j) b/i],[g,[E,"ZTE"],[S,b]],[/\b(gen\d{3}) b.+49h/i],[g,[E,"Swiss"],[S,b]],[/\b(zur\d{3}) b/i],[g,[E,"Swiss"],[S,m]],[/\b((zeki)?tb.*\b) b/i],[g,[E,"Zeki"],[S,m]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[E,"Dragon Touch"],g,[S,m]],[/\b(ns-?\w{0,9}) b/i],[g,[E,"Insignia"],[S,m]],[/\b((nxa|next)-?\w{0,9}) b/i],[g,[E,"NextBook"],[S,m]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[E,"Voice"],g,[S,b]],[/\b(lvtel\-)?(v1[12]) b/i],[[E,"LvTel"],g,[S,b]],[/\b(ph-1) /i],[g,[E,"Essential"],[S,b]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[g,[E,"Envizen"],[S,m]],[/\b(trio[-\w\. ]+) b/i],[g,[E,"MachSpeed"],[S,m]],[/\btu_(1491) b/i],[g,[E,"Rotor"],[S,m]],[/(shield[\w ]+) b/i],[g,[E,"Nvidia"],[S,m]],[/(sprint) (\w+)/i],[E,g,[S,b]],[/(kin\.[onetw]{3})/i],[[g,/\./g," "],[E,Se],[S,b]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[g,[E,nt],[S,m]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[g,[E,nt],[S,b]],[/smart-tv.+(samsung)/i],[E,[S,w]],[/hbbtv.+maple;(\d+)/i],[[g,/^/,"SmartTV"],[E,Ve],[S,w]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[E,_e],[S,w]],[/(apple) ?tv/i],[E,[g,I+" TV"],[S,w]],[/crkey/i],[[g,te+"cast"],[E,X],[S,w]],[/droid.+aft(\w+)( bui|\))/i],[g,[E,k],[S,w]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[g,[E,Me],[S,w]],[/(bravia[\w ]+)( bui|\))/i],[g,[E,ze],[S,w]],[/(mitv-\w{5}) bui/i],[g,[E,ht],[S,w]],[/Hbbtv.*(technisat) (.*);/i],[E,g,[S,w]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[E,si],[g,si],[S,w]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[S,w]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[E,g,[S,N]],[/droid.+; (shield) bui/i],[g,[E,"Nvidia"],[S,N]],[/(playstation [345portablevi]+)/i],[g,[E,ze],[S,N]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[g,[E,Se],[S,N]],[/\b(sm-[lr]\d\d[05][fnuw]?s?)\b/i],[g,[E,Ve],[S,T]],[/((pebble))app/i],[E,g,[S,T]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[g,[E,I],[S,T]],[/droid.+; (glass) \d/i],[g,[E,X],[S,T]],[/droid.+; (wt63?0{2,3})\)/i],[g,[E,nt],[S,T]],[/droid.+; (glass) \d/i],[g,[E,X],[S,T]],[/(pico) (4|neo3(?: link|pro)?)/i],[E,g,[S,T]],[/; (quest( \d| pro)?)/i],[g,[E,rt],[S,T]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[E,[S,P]],[/(aeobc)\b/i],[g,[E,k],[S,P]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[g,[S,b]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[g,[S,m]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[S,m]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[S,b]],[/(android[-\w\. ]{0,9});.+buil/i],[g,[E,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[M,[_,ee+"HTML"]],[/(arkweb)\/([\w\.]+)/i],[_,M],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[M,[_,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[_,M],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[M,_]],os:[[/microsoft (windows) (vista|xp)/i],[_,M],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[_,[M,Xt,Ut]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[M,Xt,Ut],[_,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[M,/_/g,"."],[_,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[_,Ct],[M,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[M,_],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish|openharmony)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[_,M],[/\(bb(10);/i],[M,[_,K]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[M,[_,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[M,[_,de+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[M,[_,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[M,[_,"watchOS"]],[/crkey\/([\d\.]+)/i],[M,[_,te+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[_,jt],M],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[_,M],[/(sunos) ?([\w\.\d]*)/i],[[_,"Solaris"],M],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[_,M]]},ue=function(Pe,Oe){if(typeof Pe===d&&(Oe=Pe,Pe=n),!(this instanceof ue))return new ue(Pe,Oe).getResult();var Ce=typeof i!==h&&i.navigator?i.navigator:n,tt=Pe||(Ce&&Ce.userAgent?Ce.userAgent:s),et=Ce&&Ce.userAgentData?Ce.userAgentData:n,ut=Oe?di(Ii,Oe):Ii,Qe=Ce&&Ce.userAgent==tt;return this.getBrowser=function(){var Ie={};return Ie[_]=n,Ie[M]=n,yt.call(Ie,tt,ut.browser),Ie[v]=ti(Ie[M]),Qe&&Ce&&Ce.brave&&typeof Ce.brave.isBrave==c&&(Ie[_]="Brave"),Ie},this.getCPU=function(){var Ie={};return Ie[R]=n,yt.call(Ie,tt,ut.cpu),Ie},this.getDevice=function(){var Ie={};return Ie[E]=n,Ie[g]=n,Ie[S]=n,yt.call(Ie,tt,ut.device),Qe&&!Ie[S]&&et&&et.mobile&&(Ie[S]=b),Qe&&Ie[g]=="Macintosh"&&Ce&&typeof Ce.standalone!==h&&Ce.maxTouchPoints&&Ce.maxTouchPoints>2&&(Ie[g]="iPad",Ie[S]=m),Ie},this.getEngine=function(){var Ie={};return Ie[_]=n,Ie[M]=n,yt.call(Ie,tt,ut.engine),Ie},this.getOS=function(){var Ie={};return Ie[_]=n,Ie[M]=n,yt.call(Ie,tt,ut.os),Qe&&!Ie[_]&&et&&et.platform&&et.platform!="Unknown"&&(Ie[_]=et.platform.replace(/chrome os/i,jt).replace(/macos/i,Ct)),Ie},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return tt},this.setUA=function(Ie){return tt=typeof Ie===p&&Ie.length>L?si(Ie,L):Ie,this},this.setUA(tt),this};ue.VERSION=r,ue.BROWSER=zt([_,M,v]),ue.CPU=zt([R]),ue.DEVICE=zt([g,E,S,N,b,w,m,T,P]),ue.ENGINE=ue.OS=zt([_,M]),typeof t!==h?(typeof e!==h&&e.exports&&(t=e.exports=ue),t.UAParser=ue):typeof define===c&&define.amd?define(function(){return ue}):typeof i!==h&&(i.UAParser=ue);var ie=typeof i!==h&&(i.jQuery||i.Zepto);if(ie&&!ie.ua){var Re=new ue;ie.ua=Re.getResult(),ie.ua.get=function(){return Re.getUA()},ie.ua.set=function(Pe){Re.setUA(Pe);var Oe=Re.getResult();for(var Ce in Oe)ie.ua[Ce]=Oe[Ce]}}}(typeof window=="object"?window:t)}}),a0=Fe({"../../node_modules/jsrsasign/lib/jsrsasign.js"(t){ne();var e={};e.userAgent=!1;var i={},n="11.1.0",r="jsrsasign(all) 11.1.0 (2024-02-01) (c) 2010-2023 Kenji Urushima | kjur.github.io/jsrsasign/license",s=s||function(a,l){var u={},f=u.lib={},x=f.Base=function(){function A(){}return{extend:function(B){A.prototype=this;var O=new A;return B&&O.mixIn(B),O.hasOwnProperty("init")||(O.init=function(){O.$super.init.apply(this,arguments)}),O.init.prototype=O,O.$super=this,O},create:function(){var B=this.extend();return B.init.apply(B,arguments),B},init:function(){},mixIn:function(B){for(var O in B)B.hasOwnProperty(O)&&(this[O]=B[O]);B.hasOwnProperty("toString")&&(this.toString=B.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),y=f.WordArray=x.extend({init:function(A,B){A=this.words=A||[],B!=l?this.sigBytes=B:this.sigBytes=A.length*4},toString:function(A){return(A||D).stringify(this)},concat:function(A){var B=this.words,O=A.words,H=this.sigBytes,q=A.sigBytes;if(this.clamp(),H%4)for(var Z=0;Z<q;Z++){var ce=O[Z>>>2]>>>24-Z%4*8&255;B[H+Z>>>2]|=ce<<24-(H+Z)%4*8}else for(var Z=0;Z<q;Z+=4)B[H+Z>>>2]=O[Z>>>2];return this.sigBytes+=q,this},clamp:function(){var A=this.words,B=this.sigBytes;A[B>>>2]&=4294967295<<32-B%4*8,A.length=a.ceil(B/4)},clone:function(){var A=x.clone.call(this);return A.words=this.words.slice(0),A},random:function(A){for(var B=[],O=0;O<A;O+=4)B.push(a.random()*4294967296|0);return new y.init(B,A)}}),F=u.enc={},D=F.Hex={stringify:function(A){for(var B=A.words,O=A.sigBytes,H=[],q=0;q<O;q++){var Z=B[q>>>2]>>>24-q%4*8&255;H.push((Z>>>4).toString(16)),H.push((Z&15).toString(16))}return H.join("")},parse:function(A){for(var B=A.length,O=[],H=0;H<B;H+=2)O[H>>>3]|=parseInt(A.substr(H,2),16)<<24-H%8*4;return new y.init(O,B/2)}},V=F.Latin1={stringify:function(A){for(var B=A.words,O=A.sigBytes,H=[],q=0;q<O;q++){var Z=B[q>>>2]>>>24-q%4*8&255;H.push(String.fromCharCode(Z))}return H.join("")},parse:function(A){for(var B=A.length,O=[],H=0;H<B;H++)O[H>>>2]|=(A.charCodeAt(H)&255)<<24-H%4*8;return new y.init(O,B)}},U=F.Utf8={stringify:function(A){try{return decodeURIComponent(escape(V.stringify(A)))}catch{throw new Error("Malformed UTF-8 data")}},parse:function(A){return V.parse(unescape(encodeURIComponent(A)))}},W=f.BufferedBlockAlgorithm=x.extend({reset:function(){this._data=new y.init,this._nDataBytes=0},_append:function(A){typeof A=="string"&&(A=U.parse(A)),this._data.concat(A),this._nDataBytes+=A.sigBytes},_process:function(A){var B=this._data,O=B.words,H=B.sigBytes,q=this.blockSize,Z=q*4,ce=H/Z;A?ce=a.ceil(ce):ce=a.max((ce|0)-this._minBufferSize,0);var fe=ce*q,pe=a.min(fe*4,H);if(fe){for(var ge=0;ge<fe;ge+=q)this._doProcessBlock(O,ge);var Y=O.splice(0,fe);B.sigBytes-=pe}return new y.init(Y,pe)},clone:function(){var A=x.clone.call(this);return A._data=this._data.clone(),A},_minBufferSize:0});f.Hasher=W.extend({cfg:x.extend(),init:function(A){this.cfg=this.cfg.extend(A),this.reset()},reset:function(){W.reset.call(this),this._doReset()},update:function(A){return this._append(A),this._process(),this},finalize:function(A){A&&this._append(A);var B=this._doFinalize();return B},blockSize:512/32,_createHelper:function(A){return function(B,O){return new A.init(O).finalize(B)}},_createHmacHelper:function(A){return function(B,O){return new G.HMAC.init(A,O).finalize(B)}}});var G=u.algo={};return u}(Math);(function(a){var x=s,l=x.lib,u=l.Base,f=l.WordArray,x=x.x64={};x.Word=u.extend({init:function(y,F){this.high=y,this.low=F}}),x.WordArray=u.extend({init:function(y,F){y=this.words=y||[],this.sigBytes=F!=a?F:8*y.length},toX32:function(){for(var y=this.words,F=y.length,D=[],V=0;V<F;V++){var U=y[V];D.push(U.high),D.push(U.low)}return f.create(D,this.sigBytes)},clone:function(){for(var y=u.clone.call(this),F=y.words=this.words.slice(0),D=F.length,V=0;V<D;V++)F[V]=F[V].clone();return y}})})(),s.lib.Cipher||function(a){var B=s,l=B.lib,u=l.Base,f=l.WordArray,x=l.BufferedBlockAlgorithm,y=B.enc.Base64,F=B.algo.EvpKDF,D=l.Cipher=x.extend({cfg:u.extend(),createEncryptor:function(H,q){return this.create(this._ENC_XFORM_MODE,H,q)},createDecryptor:function(H,q){return this.create(this._DEC_XFORM_MODE,H,q)},init:function(H,q,Z){this.cfg=this.cfg.extend(Z),this._xformMode=H,this._key=q,this.reset()},reset:function(){x.reset.call(this),this._doReset()},process:function(H){return this._append(H),this._process()},finalize:function(H){return H&&this._append(H),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(H){return{encrypt:function(q,Z,ce){return(typeof Z=="string"?O:A).encrypt(H,q,Z,ce)},decrypt:function(q,Z,ce){return(typeof Z=="string"?O:A).decrypt(H,q,Z,ce)}}}});l.StreamCipher=D.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var G=B.mode={},V=function(H,q,Z){var ce=this._iv;ce?this._iv=a:ce=this._prevBlock;for(var fe=0;fe<Z;fe++)H[q+fe]^=ce[fe]},U=(l.BlockCipherMode=u.extend({createEncryptor:function(H,q){return this.Encryptor.create(H,q)},createDecryptor:function(H,q){return this.Decryptor.create(H,q)},init:function(H,q){this._cipher=H,this._iv=q}})).extend();U.Encryptor=U.extend({processBlock:function(H,q){var Z=this._cipher,ce=Z.blockSize;V.call(this,H,q,ce),Z.encryptBlock(H,q),this._prevBlock=H.slice(q,q+ce)}}),U.Decryptor=U.extend({processBlock:function(H,q){var Z=this._cipher,ce=Z.blockSize,fe=H.slice(q,q+ce);Z.decryptBlock(H,q),V.call(this,H,q,ce),this._prevBlock=fe}}),G=G.CBC=U,U=(B.pad={}).Pkcs7={pad:function(H,q){for(var Z=4*q,Z=Z-H.sigBytes%Z,ce=Z<<24|Z<<16|Z<<8|Z,fe=[],pe=0;pe<Z;pe+=4)fe.push(ce);Z=f.create(fe,Z),H.concat(Z)},unpad:function(H){H.sigBytes-=H.words[H.sigBytes-1>>>2]&255}},l.BlockCipher=D.extend({cfg:D.cfg.extend({mode:G,padding:U}),reset:function(){D.reset.call(this);var q=this.cfg,H=q.iv,q=q.mode;if(this._xformMode==this._ENC_XFORM_MODE)var Z=q.createEncryptor;else Z=q.createDecryptor,this._minBufferSize=1;this._mode=Z.call(q,this,H&&H.words)},_doProcessBlock:function(H,q){this._mode.processBlock(H,q)},_doFinalize:function(){var H=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){H.pad(this._data,this.blockSize);var q=this._process(!0)}else q=this._process(!0),H.unpad(q);return q},blockSize:4});var W=l.CipherParams=u.extend({init:function(H){this.mixIn(H)},toString:function(H){return(H||this.formatter).stringify(this)}}),G=(B.format={}).OpenSSL={stringify:function(H){var q=H.ciphertext;return H=H.salt,(H?f.create([1398893684,1701076831]).concat(H).concat(q):q).toString(y)},parse:function(H){H=y.parse(H);var q=H.words;if(q[0]==1398893684&&q[1]==1701076831){var Z=f.create(q.slice(2,4));q.splice(0,4),H.sigBytes-=16}return W.create({ciphertext:H,salt:Z})}},A=l.SerializableCipher=u.extend({cfg:u.extend({format:G}),encrypt:function(H,q,Z,ce){ce=this.cfg.extend(ce);var fe=H.createEncryptor(Z,ce);return q=fe.finalize(q),fe=fe.cfg,W.create({ciphertext:q,key:Z,iv:fe.iv,algorithm:H,mode:fe.mode,padding:fe.padding,blockSize:H.blockSize,formatter:ce.format})},decrypt:function(H,q,Z,ce){return ce=this.cfg.extend(ce),q=this._parse(q,ce.format),H.createDecryptor(Z,ce).finalize(q.ciphertext)},_parse:function(H,q){return typeof H=="string"?q.parse(H,this):H}}),B=(B.kdf={}).OpenSSL={execute:function(H,q,Z,ce){return ce||(ce=f.random(8)),H=F.create({keySize:q+Z}).compute(H,ce),Z=f.create(H.words.slice(q),4*Z),H.sigBytes=4*q,W.create({key:H,iv:Z,salt:ce})}},O=l.PasswordBasedCipher=A.extend({cfg:A.cfg.extend({kdf:B}),encrypt:function(H,q,Z,ce){return ce=this.cfg.extend(ce),Z=ce.kdf.execute(Z,H.keySize,H.ivSize),ce.iv=Z.iv,H=A.encrypt.call(this,H,q,Z.key,ce),H.mixIn(Z),H},decrypt:function(H,q,Z,ce){return ce=this.cfg.extend(ce),q=this._parse(q,ce.format),Z=ce.kdf.execute(Z,H.keySize,H.ivSize,q.salt),ce.iv=Z.iv,A.decrypt.call(this,H,q,Z.key,ce)}})}(),function(){for(var a=s,l=a.lib.BlockCipher,Y=a.algo,u=[],f=[],x=[],y=[],F=[],D=[],V=[],U=[],W=[],G=[],A=[],B=0;256>B;B++)A[B]=128>B?B<<1:B<<1^283;for(var O=0,H=0,B=0;256>B;B++){var q=H^H<<1^H<<2^H<<3^H<<4,q=q>>>8^q&255^99;u[O]=q,f[q]=O;var Z=A[O],ce=A[Z],fe=A[ce],pe=257*A[q]^16843008*q;x[O]=pe<<24|pe>>>8,y[O]=pe<<16|pe>>>16,F[O]=pe<<8|pe>>>24,D[O]=pe,pe=16843009*fe^65537*ce^257*Z^16843008*O,V[q]=pe<<24|pe>>>8,U[q]=pe<<16|pe>>>16,W[q]=pe<<8|pe>>>24,G[q]=pe,O?(O=Z^A[A[A[fe^Z]]],H^=A[A[H]]):O=H=1}var ge=[0,1,2,4,8,16,32,64,128,27,54],Y=Y.AES=l.extend({_doReset:function(){for(var J=this._key,Q=J.words,re=J.sigBytes/4,J=4*((this._nRounds=re+6)+1),oe=this._keySchedule=[],me=0;me<J;me++)if(me<re)oe[me]=Q[me];else{var ye=oe[me-1];me%re?6<re&&me%re==4&&(ye=u[ye>>>24]<<24|u[ye>>>16&255]<<16|u[ye>>>8&255]<<8|u[ye&255]):(ye=ye<<8|ye>>>24,ye=u[ye>>>24]<<24|u[ye>>>16&255]<<16|u[ye>>>8&255]<<8|u[ye&255],ye^=ge[me/re|0]<<24),oe[me]=oe[me-re]^ye}for(Q=this._invKeySchedule=[],re=0;re<J;re++)me=J-re,ye=re%4?oe[me]:oe[me-4],Q[re]=4>re||4>=me?ye:V[u[ye>>>24]]^U[u[ye>>>16&255]]^W[u[ye>>>8&255]]^G[u[ye&255]]},encryptBlock:function(Q,re){this._doCryptBlock(Q,re,this._keySchedule,x,y,F,D,u)},decryptBlock:function(Q,re){var J=Q[re+1];Q[re+1]=Q[re+3],Q[re+3]=J,this._doCryptBlock(Q,re,this._invKeySchedule,V,U,W,G,f),J=Q[re+1],Q[re+1]=Q[re+3],Q[re+3]=J},_doCryptBlock:function(Q,re,J,oe,me,ye,Be,be){for(var Te=this._nRounds,tn=Q[re]^J[0],an=Q[re+1]^J[1],nn=Q[re+2]^J[2],Vi=Q[re+3]^J[3],He=4,qe=1;qe<Te;qe++)var pn=oe[tn>>>24]^me[an>>>16&255]^ye[nn>>>8&255]^Be[Vi&255]^J[He++],Ni=oe[an>>>24]^me[nn>>>16&255]^ye[Vi>>>8&255]^Be[tn&255]^J[He++],Ti=oe[nn>>>24]^me[Vi>>>16&255]^ye[tn>>>8&255]^Be[an&255]^J[He++],Vi=oe[Vi>>>24]^me[tn>>>16&255]^ye[an>>>8&255]^Be[nn&255]^J[He++],tn=pn,an=Ni,nn=Ti;pn=(be[tn>>>24]<<24|be[an>>>16&255]<<16|be[nn>>>8&255]<<8|be[Vi&255])^J[He++],Ni=(be[an>>>24]<<24|be[nn>>>16&255]<<16|be[Vi>>>8&255]<<8|be[tn&255])^J[He++],Ti=(be[nn>>>24]<<24|be[Vi>>>16&255]<<16|be[tn>>>8&255]<<8|be[an&255])^J[He++],Vi=(be[Vi>>>24]<<24|be[tn>>>16&255]<<16|be[an>>>8&255]<<8|be[nn&255])^J[He++],Q[re]=pn,Q[re+1]=Ni,Q[re+2]=Ti,Q[re+3]=Vi},keySize:8});a.AES=l._createHelper(Y)}(),function(){function a(A,B){var O=(this._lBlock>>>A^this._rBlock)&B;this._rBlock^=O,this._lBlock^=O<<A}function l(A,B){var O=(this._rBlock>>>A^this._lBlock)&B;this._lBlock^=O,this._rBlock^=O<<A}var u=s,x=u.lib,f=x.WordArray,x=x.BlockCipher,y=u.algo,F=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],D=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],V=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],U=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],W=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],G=y.DES=x.extend({_doReset:function(){for(var A=this._key.words,B=[],O=0;56>O;O++){var H=F[O]-1;B[O]=A[H>>>5]>>>31-H%32&1}for(A=this._subKeys=[],H=0;16>H;H++){for(var q=A[H]=[],Z=V[H],O=0;24>O;O++)q[O/6|0]|=B[(D[O]-1+Z)%28]<<31-O%6,q[4+(O/6|0)]|=B[28+(D[O+24]-1+Z)%28]<<31-O%6;for(q[0]=q[0]<<1|q[0]>>>31,O=1;7>O;O++)q[O]>>>=4*(O-1)+3;q[7]=q[7]<<5|q[7]>>>27}for(B=this._invSubKeys=[],O=0;16>O;O++)B[O]=A[15-O]},encryptBlock:function(A,B){this._doCryptBlock(A,B,this._subKeys)},decryptBlock:function(A,B){this._doCryptBlock(A,B,this._invSubKeys)},_doCryptBlock:function(A,B,O){this._lBlock=A[B],this._rBlock=A[B+1],a.call(this,4,252645135),a.call(this,16,65535),l.call(this,2,858993459),l.call(this,8,16711935),a.call(this,1,1431655765);for(var H=0;16>H;H++){for(var q=O[H],Z=this._lBlock,ce=this._rBlock,fe=0,pe=0;8>pe;pe++)fe|=U[pe][((ce^q[pe])&W[pe])>>>0];this._lBlock=ce,this._rBlock=Z^fe}O=this._lBlock,this._lBlock=this._rBlock,this._rBlock=O,a.call(this,1,1431655765),l.call(this,8,16711935),l.call(this,2,858993459),a.call(this,16,65535),a.call(this,4,252645135),A[B]=this._lBlock,A[B+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});u.DES=x._createHelper(G),y=y.TripleDES=x.extend({_doReset:function(){var A=this._key.words;this._des1=G.createEncryptor(f.create(A.slice(0,2))),this._des2=G.createEncryptor(f.create(A.slice(2,4))),this._des3=G.createEncryptor(f.create(A.slice(4,6)))},encryptBlock:function(A,B){this._des1.encryptBlock(A,B),this._des2.decryptBlock(A,B),this._des3.encryptBlock(A,B)},decryptBlock:function(A,B){this._des3.decryptBlock(A,B),this._des2.encryptBlock(A,B),this._des1.decryptBlock(A,B)},keySize:6,ivSize:2,blockSize:2}),u.TripleDES=x._createHelper(y)}(),function(){var a=s,l=a.lib.WordArray;a.enc.Base64={stringify:function(u){var f=u.words,x=u.sigBytes,y=this._map;u.clamp(),u=[];for(var F=0;F<x;F+=3)for(var D=(f[F>>>2]>>>24-8*(F%4)&255)<<16|(f[F+1>>>2]>>>24-8*((F+1)%4)&255)<<8|f[F+2>>>2]>>>24-8*((F+2)%4)&255,V=0;4>V&&F+.75*V<x;V++)u.push(y.charAt(D>>>6*(3-V)&63));if(f=y.charAt(64))for(;u.length%4;)u.push(f);return u.join("")},parse:function(u){var f=u.length,x=this._map,y=x.charAt(64);y&&(y=u.indexOf(y),y!=-1&&(f=y));for(var y=[],F=0,D=0;D<f;D++)if(D%4){var V=x.indexOf(u.charAt(D-1))<<2*(D%4),U=x.indexOf(u.charAt(D))>>>6-2*(D%4);y[F>>>2]|=(V|U)<<24-8*(F%4),F++}return l.create(y,F)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(a){function l(G,A,B,O,H,q,Z){return G=G+(A&B|~A&O)+H+Z,(G<<q|G>>>32-q)+A}function u(G,A,B,O,H,q,Z){return G=G+(A&O|B&~O)+H+Z,(G<<q|G>>>32-q)+A}function f(G,A,B,O,H,q,Z){return G=G+(A^B^O)+H+Z,(G<<q|G>>>32-q)+A}function x(G,A,B,O,H,q,Z){return G=G+(B^(A|~O))+H+Z,(G<<q|G>>>32-q)+A}for(var y=s,V=y.lib,F=V.WordArray,D=V.Hasher,V=y.algo,U=[],W=0;64>W;W++)U[W]=4294967296*a.abs(a.sin(W+1))|0;V=V.MD5=D.extend({_doReset:function(){this._hash=new F.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(G,A){for(var B=0;16>B;B++){var O=A+B,H=G[O];G[O]=(H<<8|H>>>24)&16711935|(H<<24|H>>>8)&4278255360}var B=this._hash.words,O=G[A+0],H=G[A+1],q=G[A+2],Z=G[A+3],ce=G[A+4],fe=G[A+5],pe=G[A+6],ge=G[A+7],Y=G[A+8],Q=G[A+9],re=G[A+10],J=G[A+11],oe=G[A+12],me=G[A+13],ye=G[A+14],Be=G[A+15],be=B[0],qe=B[1],He=B[2],Te=B[3],be=l(be,qe,He,Te,O,7,U[0]),Te=l(Te,be,qe,He,H,12,U[1]),He=l(He,Te,be,qe,q,17,U[2]),qe=l(qe,He,Te,be,Z,22,U[3]),be=l(be,qe,He,Te,ce,7,U[4]),Te=l(Te,be,qe,He,fe,12,U[5]),He=l(He,Te,be,qe,pe,17,U[6]),qe=l(qe,He,Te,be,ge,22,U[7]),be=l(be,qe,He,Te,Y,7,U[8]),Te=l(Te,be,qe,He,Q,12,U[9]),He=l(He,Te,be,qe,re,17,U[10]),qe=l(qe,He,Te,be,J,22,U[11]),be=l(be,qe,He,Te,oe,7,U[12]),Te=l(Te,be,qe,He,me,12,U[13]),He=l(He,Te,be,qe,ye,17,U[14]),qe=l(qe,He,Te,be,Be,22,U[15]),be=u(be,qe,He,Te,H,5,U[16]),Te=u(Te,be,qe,He,pe,9,U[17]),He=u(He,Te,be,qe,J,14,U[18]),qe=u(qe,He,Te,be,O,20,U[19]),be=u(be,qe,He,Te,fe,5,U[20]),Te=u(Te,be,qe,He,re,9,U[21]),He=u(He,Te,be,qe,Be,14,U[22]),qe=u(qe,He,Te,be,ce,20,U[23]),be=u(be,qe,He,Te,Q,5,U[24]),Te=u(Te,be,qe,He,ye,9,U[25]),He=u(He,Te,be,qe,Z,14,U[26]),qe=u(qe,He,Te,be,Y,20,U[27]),be=u(be,qe,He,Te,me,5,U[28]),Te=u(Te,be,qe,He,q,9,U[29]),He=u(He,Te,be,qe,ge,14,U[30]),qe=u(qe,He,Te,be,oe,20,U[31]),be=f(be,qe,He,Te,fe,4,U[32]),Te=f(Te,be,qe,He,Y,11,U[33]),He=f(He,Te,be,qe,J,16,U[34]),qe=f(qe,He,Te,be,ye,23,U[35]),be=f(be,qe,He,Te,H,4,U[36]),Te=f(Te,be,qe,He,ce,11,U[37]),He=f(He,Te,be,qe,ge,16,U[38]),qe=f(qe,He,Te,be,re,23,U[39]),be=f(be,qe,He,Te,me,4,U[40]),Te=f(Te,be,qe,He,O,11,U[41]),He=f(He,Te,be,qe,Z,16,U[42]),qe=f(qe,He,Te,be,pe,23,U[43]),be=f(be,qe,He,Te,Q,4,U[44]),Te=f(Te,be,qe,He,oe,11,U[45]),He=f(He,Te,be,qe,Be,16,U[46]),qe=f(qe,He,Te,be,q,23,U[47]),be=x(be,qe,He,Te,O,6,U[48]),Te=x(Te,be,qe,He,ge,10,U[49]),He=x(He,Te,be,qe,ye,15,U[50]),qe=x(qe,He,Te,be,fe,21,U[51]),be=x(be,qe,He,Te,oe,6,U[52]),Te=x(Te,be,qe,He,Z,10,U[53]),He=x(He,Te,be,qe,re,15,U[54]),qe=x(qe,He,Te,be,H,21,U[55]),be=x(be,qe,He,Te,Y,6,U[56]),Te=x(Te,be,qe,He,Be,10,U[57]),He=x(He,Te,be,qe,pe,15,U[58]),qe=x(qe,He,Te,be,me,21,U[59]),be=x(be,qe,He,Te,ce,6,U[60]),Te=x(Te,be,qe,He,J,10,U[61]),He=x(He,Te,be,qe,q,15,U[62]),qe=x(qe,He,Te,be,Q,21,U[63]);B[0]=B[0]+be|0,B[1]=B[1]+qe|0,B[2]=B[2]+He|0,B[3]=B[3]+Te|0},_doFinalize:function(){var G=this._data,A=G.words,B=8*this._nDataBytes,O=8*G.sigBytes;A[O>>>5]|=128<<24-O%32;var H=a.floor(B/4294967296);for(A[(O+64>>>9<<4)+15]=(H<<8|H>>>24)&16711935|(H<<24|H>>>8)&4278255360,A[(O+64>>>9<<4)+14]=(B<<8|B>>>24)&16711935|(B<<24|B>>>8)&4278255360,G.sigBytes=4*(A.length+1),this._process(),G=this._hash,A=G.words,B=0;4>B;B++)O=A[B],A[B]=(O<<8|O>>>24)&16711935|(O<<24|O>>>8)&4278255360;return G},clone:function(){var G=D.clone.call(this);return G._hash=this._hash.clone(),G}}),y.MD5=D._createHelper(V),y.HmacMD5=D._createHmacHelper(V)}(Math),function(){var a=s,x=a.lib,l=x.WordArray,u=x.Hasher,f=[],x=a.algo.SHA1=u.extend({_doReset:function(){this._hash=new l.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(y,F){for(var D=this._hash.words,V=D[0],U=D[1],W=D[2],G=D[3],A=D[4],B=0;80>B;B++){if(16>B)f[B]=y[F+B]|0;else{var O=f[B-3]^f[B-8]^f[B-14]^f[B-16];f[B]=O<<1|O>>>31}O=(V<<5|V>>>27)+A+f[B],O=20>B?O+((U&W|~U&G)+1518500249):40>B?O+((U^W^G)+1859775393):60>B?O+((U&W|U&G|W&G)-1894007588):O+((U^W^G)-899497514),A=G,G=W,W=U<<30|U>>>2,U=V,V=O}D[0]=D[0]+V|0,D[1]=D[1]+U|0,D[2]=D[2]+W|0,D[3]=D[3]+G|0,D[4]=D[4]+A|0},_doFinalize:function(){var y=this._data,F=y.words,D=8*this._nDataBytes,V=8*y.sigBytes;return F[V>>>5]|=128<<24-V%32,F[(V+64>>>9<<4)+14]=Math.floor(D/4294967296),F[(V+64>>>9<<4)+15]=D,y.sigBytes=4*F.length,this._process(),this._hash},clone:function(){var y=u.clone.call(this);return y._hash=this._hash.clone(),y}});a.SHA1=u._createHelper(x),a.HmacSHA1=u._createHmacHelper(x)}(),function(a){for(var l=s,B=l.lib,u=B.WordArray,f=B.Hasher,B=l.algo,x=[],y=[],F=function(H){return 4294967296*(H-(H|0))|0},D=2,V=0;64>V;){var U;e:{U=D;for(var W=a.sqrt(U),G=2;G<=W;G++)if(!(U%G)){U=!1;break e}U=!0}U&&(8>V&&(x[V]=F(a.pow(D,.5))),y[V]=F(a.pow(D,1/3)),V++),D++}var A=[],B=B.SHA256=f.extend({_doReset:function(){this._hash=new u.init(x.slice(0))},_doProcessBlock:function(O,H){for(var q=this._hash.words,Z=q[0],ce=q[1],fe=q[2],pe=q[3],ge=q[4],Y=q[5],Q=q[6],re=q[7],J=0;64>J;J++){if(16>J)A[J]=O[H+J]|0;else{var oe=A[J-15],me=A[J-2];A[J]=((oe<<25|oe>>>7)^(oe<<14|oe>>>18)^oe>>>3)+A[J-7]+((me<<15|me>>>17)^(me<<13|me>>>19)^me>>>10)+A[J-16]}oe=re+((ge<<26|ge>>>6)^(ge<<21|ge>>>11)^(ge<<7|ge>>>25))+(ge&Y^~ge&Q)+y[J]+A[J],me=((Z<<30|Z>>>2)^(Z<<19|Z>>>13)^(Z<<10|Z>>>22))+(Z&ce^Z&fe^ce&fe),re=Q,Q=Y,Y=ge,ge=pe+oe|0,pe=fe,fe=ce,ce=Z,Z=oe+me|0}q[0]=q[0]+Z|0,q[1]=q[1]+ce|0,q[2]=q[2]+fe|0,q[3]=q[3]+pe|0,q[4]=q[4]+ge|0,q[5]=q[5]+Y|0,q[6]=q[6]+Q|0,q[7]=q[7]+re|0},_doFinalize:function(){var O=this._data,H=O.words,q=8*this._nDataBytes,Z=8*O.sigBytes;return H[Z>>>5]|=128<<24-Z%32,H[(Z+64>>>9<<4)+14]=a.floor(q/4294967296),H[(Z+64>>>9<<4)+15]=q,O.sigBytes=4*H.length,this._process(),this._hash},clone:function(){var O=f.clone.call(this);return O._hash=this._hash.clone(),O}});l.SHA256=f._createHelper(B),l.HmacSHA256=f._createHmacHelper(B)}(Math),function(){var a=s,l=a.lib.WordArray,f=a.algo,u=f.SHA256,f=f.SHA224=u.extend({_doReset:function(){this._hash=new l.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var x=u._doFinalize.call(this);return x.sigBytes-=4,x}});a.SHA224=u._createHelper(f),a.HmacSHA224=u._createHmacHelper(f)}(),function(){function a(){return f.create.apply(f,arguments)}for(var l=s,u=l.lib.Hasher,y=l.x64,f=y.Word,x=y.WordArray,y=l.algo,F=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],D=[],V=0;80>V;V++)D[V]=a();y=y.SHA512=u.extend({_doReset:function(){this._hash=new x.init([new f.init(1779033703,4089235720),new f.init(3144134277,2227873595),new f.init(1013904242,4271175723),new f.init(2773480762,1595750129),new f.init(1359893119,2917565137),new f.init(2600822924,725511199),new f.init(528734635,4215389547),new f.init(1541459225,327033209)])},_doProcessBlock:function(U,W){for(var ce=this._hash.words,G=ce[0],A=ce[1],B=ce[2],O=ce[3],H=ce[4],q=ce[5],Z=ce[6],ce=ce[7],fe=G.high,pe=G.low,ge=A.high,Y=A.low,Q=B.high,re=B.low,J=O.high,oe=O.low,me=H.high,ye=H.low,Be=q.high,be=q.low,Te=Z.high,He=Z.low,qe=ce.high,pn=ce.low,Ni=fe,Ti=pe,Vi=ge,tn=Y,an=Q,nn=re,lo=J,bn=oe,ei=me,bi=ye,Li=Be,Oi=be,In=Te,Bi=He,uo=qe,Fs=pn,dr=0;80>dr;dr++){var ls=D[dr];if(16>dr)var Jn=ls.high=U[W+2*dr]|0,pi=ls.low=U[W+2*dr+1]|0;else{var Jn=D[dr-15],pi=Jn.high,Dr=Jn.low,Jn=(pi>>>1|Dr<<31)^(pi>>>8|Dr<<24)^pi>>>7,Dr=(Dr>>>1|pi<<31)^(Dr>>>8|pi<<24)^(Dr>>>7|pi<<25),Ns=D[dr-2],pi=Ns.high,Ai=Ns.low,Ns=(pi>>>19|Ai<<13)^(pi<<3|Ai>>>29)^pi>>>6,Ai=(Ai>>>19|pi<<13)^(Ai<<3|pi>>>29)^(Ai>>>6|pi<<26),pi=D[dr-7],ud=pi.high,cs=D[dr-16],Ir=cs.high,cs=cs.low,pi=Dr+pi.low,Jn=Jn+ud+(pi>>>0<Dr>>>0?1:0),pi=pi+Ai,Jn=Jn+Ns+(pi>>>0<Ai>>>0?1:0),pi=pi+cs,Jn=Jn+Ir+(pi>>>0<cs>>>0?1:0);ls.high=Jn,ls.low=pi}var ud=ei&Li^~ei&In,cs=bi&Oi^~bi&Bi,ls=Ni&Vi^Ni&an^Vi&an,q_=Ti&tn^Ti&nn^tn&nn,Dr=(Ni>>>28|Ti<<4)^(Ni<<30|Ti>>>2)^(Ni<<25|Ti>>>7),Ns=(Ti>>>28|Ni<<4)^(Ti<<30|Ni>>>2)^(Ti<<25|Ni>>>7),Ai=F[dr],W_=Ai.high,lp=Ai.low,Ai=Fs+((bi>>>14|ei<<18)^(bi>>>18|ei<<14)^(bi<<23|ei>>>9)),Ir=uo+((ei>>>14|bi<<18)^(ei>>>18|bi<<14)^(ei<<23|bi>>>9))+(Ai>>>0<Fs>>>0?1:0),Ai=Ai+cs,Ir=Ir+ud+(Ai>>>0<cs>>>0?1:0),Ai=Ai+lp,Ir=Ir+W_+(Ai>>>0<lp>>>0?1:0),Ai=Ai+pi,Ir=Ir+Jn+(Ai>>>0<pi>>>0?1:0),pi=Ns+q_,ls=Dr+ls+(pi>>>0<Ns>>>0?1:0),uo=In,Fs=Bi,In=Li,Bi=Oi,Li=ei,Oi=bi,bi=bn+Ai|0,ei=lo+Ir+(bi>>>0<bn>>>0?1:0)|0,lo=an,bn=nn,an=Vi,nn=tn,Vi=Ni,tn=Ti,Ti=Ai+pi|0,Ni=Ir+ls+(Ti>>>0<Ai>>>0?1:0)|0}pe=G.low=pe+Ti,G.high=fe+Ni+(pe>>>0<Ti>>>0?1:0),Y=A.low=Y+tn,A.high=ge+Vi+(Y>>>0<tn>>>0?1:0),re=B.low=re+nn,B.high=Q+an+(re>>>0<nn>>>0?1:0),oe=O.low=oe+bn,O.high=J+lo+(oe>>>0<bn>>>0?1:0),ye=H.low=ye+bi,H.high=me+ei+(ye>>>0<bi>>>0?1:0),be=q.low=be+Oi,q.high=Be+Li+(be>>>0<Oi>>>0?1:0),He=Z.low=He+Bi,Z.high=Te+In+(He>>>0<Bi>>>0?1:0),pn=ce.low=pn+Fs,ce.high=qe+uo+(pn>>>0<Fs>>>0?1:0)},_doFinalize:function(){var U=this._data,W=U.words,G=8*this._nDataBytes,A=8*U.sigBytes;return W[A>>>5]|=128<<24-A%32,W[(A+128>>>10<<5)+30]=Math.floor(G/4294967296),W[(A+128>>>10<<5)+31]=G,U.sigBytes=4*W.length,this._process(),this._hash.toX32()},clone:function(){var U=u.clone.call(this);return U._hash=this._hash.clone(),U},blockSize:32}),l.SHA512=u._createHelper(y),l.HmacSHA512=u._createHmacHelper(y)}(),function(){var a=s,x=a.x64,l=x.Word,u=x.WordArray,x=a.algo,f=x.SHA512,x=x.SHA384=f.extend({_doReset:function(){this._hash=new u.init([new l.init(3418070365,3238371032),new l.init(1654270250,914150663),new l.init(2438529370,812702999),new l.init(355462360,4144912697),new l.init(1731405415,4290775857),new l.init(2394180231,1750603025),new l.init(3675008525,1694076839),new l.init(1203062813,3204075428)])},_doFinalize:function(){var y=f._doFinalize.call(this);return y.sigBytes-=16,y}});a.SHA384=f._createHelper(x),a.HmacSHA384=f._createHmacHelper(x)}(),function(){var a=s,U=a.lib,l=U.WordArray,u=U.Hasher,U=a.algo,f=l.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),x=l.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),y=l.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),F=l.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),D=l.create([0,1518500249,1859775393,2400959708,2840853838]),V=l.create([1352829926,1548603684,1836072691,2053994217,0]),U=U.RIPEMD160=u.extend({_doReset:function(){this._hash=l.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(W,G){for(var A=0;16>A;A++){var B=G+A,O=W[B];W[B]=(O<<8|O>>>24)&16711935|(O<<24|O>>>8)&4278255360}var B=this._hash.words,O=D.words,H=V.words,q=f.words,Z=x.words,ce=y.words,fe=F.words,pe,ge,Y,Q,re,J,oe,me,ye,Be;J=pe=B[0],oe=ge=B[1],me=Y=B[2],ye=Q=B[3],Be=re=B[4];for(var be,A=0;80>A;A+=1)be=pe+W[G+q[A]]|0,be=16>A?be+((ge^Y^Q)+O[0]):32>A?be+((ge&Y|~ge&Q)+O[1]):48>A?be+(((ge|~Y)^Q)+O[2]):64>A?be+((ge&Q|Y&~Q)+O[3]):be+((ge^(Y|~Q))+O[4]),be|=0,be=be<<ce[A]|be>>>32-ce[A],be=be+re|0,pe=re,re=Q,Q=Y<<10|Y>>>22,Y=ge,ge=be,be=J+W[G+Z[A]]|0,be=16>A?be+((oe^(me|~ye))+H[0]):32>A?be+((oe&ye|me&~ye)+H[1]):48>A?be+(((oe|~me)^ye)+H[2]):64>A?be+((oe&me|~oe&ye)+H[3]):be+((oe^me^ye)+H[4]),be|=0,be=be<<fe[A]|be>>>32-fe[A],be=be+Be|0,J=Be,Be=ye,ye=me<<10|me>>>22,me=oe,oe=be;be=B[1]+Y+ye|0,B[1]=B[2]+Q+Be|0,B[2]=B[3]+re+J|0,B[3]=B[4]+pe+oe|0,B[4]=B[0]+ge+me|0,B[0]=be},_doFinalize:function(){var W=this._data,G=W.words,A=8*this._nDataBytes,B=8*W.sigBytes;for(G[B>>>5]|=128<<24-B%32,G[(B+64>>>9<<4)+14]=(A<<8|A>>>24)&16711935|(A<<24|A>>>8)&4278255360,W.sigBytes=4*(G.length+1),this._process(),W=this._hash,G=W.words,A=0;5>A;A++)B=G[A],G[A]=(B<<8|B>>>24)&16711935|(B<<24|B>>>8)&4278255360;return W},clone:function(){var W=u.clone.call(this);return W._hash=this._hash.clone(),W}});a.RIPEMD160=u._createHelper(U),a.HmacRIPEMD160=u._createHmacHelper(U)}(),function(){var a=s,l=a.enc.Utf8;a.algo.HMAC=a.lib.Base.extend({init:function(u,f){u=this._hasher=new u.init,typeof f=="string"&&(f=l.parse(f));var x=u.blockSize,y=4*x;f.sigBytes>y&&(f=u.finalize(f)),f.clamp();for(var F=this._oKey=f.clone(),D=this._iKey=f.clone(),V=F.words,U=D.words,W=0;W<x;W++)V[W]^=1549556828,U[W]^=909522486;F.sigBytes=D.sigBytes=y,this.reset()},reset:function(){var u=this._hasher;u.reset(),u.update(this._iKey)},update:function(u){return this._hasher.update(u),this},finalize:function(u){var f=this._hasher;return u=f.finalize(u),f.reset(),f.finalize(this._oKey.clone().concat(u))}})}(),function(){var a=s,f=a.lib,l=f.Base,u=f.WordArray,f=a.algo,x=f.HMAC,y=f.PBKDF2=l.extend({cfg:l.extend({keySize:4,hasher:f.SHA1,iterations:1}),init:function(F){this.cfg=this.cfg.extend(F)},compute:function(F,D){for(var O=this.cfg,V=x.create(O.hasher,F),U=u.create(),W=u.create([1]),G=U.words,A=W.words,B=O.keySize,O=O.iterations;G.length<B;){var H=V.update(D).finalize(W);V.reset();for(var q=H.words,Z=q.length,ce=H,fe=1;fe<O;fe++){ce=V.finalize(ce),V.reset();for(var pe=ce.words,ge=0;ge<Z;ge++)q[ge]^=pe[ge]}U.concat(H),A[0]++}return U.sigBytes=4*B,U}});a.PBKDF2=function(F,D,V){return y.create(V).compute(F,D)}}();var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c="=";function h(a){var l,u,f="";for(l=0;l+3<=a.length;l+=3)u=parseInt(a.substring(l,l+3),16),f+=o.charAt(u>>6)+o.charAt(u&63);for(l+1==a.length?(u=parseInt(a.substring(l,l+1),16),f+=o.charAt(u<<2)):l+2==a.length&&(u=parseInt(a.substring(l,l+2),16),f+=o.charAt(u>>2)+o.charAt((u&3)<<4));(f.length&3)>0;)f+=c;return f}function d(a){var l="",u,f=0,x,y;for(u=0;u<a.length&&a.charAt(u)!=c;++u)y=o.indexOf(a.charAt(u)),!(y<0)&&(f==0?(l+=T(y>>2),x=y&3,f=1):f==1?(l+=T(x<<2|y>>4),x=y&15,f=2):f==2?(l+=T(x),l+=T(y>>2),x=y&3,f=3):(l+=T(x<<2|y>>4),l+=T(y&15),f=0));return f==1&&(l+=T(x<<2)),l}function p(a){var l=d(a),u,f=new Array;for(u=0;2*u<l.length;++u)f[u]=parseInt(l.substring(2*u,2*u+2),16);return f}var v;function g(a,l,u){a!=null&&(typeof a=="number"?this.fromNumber(a,l,u):l==null&&typeof a!="string"?this.fromString(a,256):this.fromString(a,l))}function _(){return new g(null)}function S(a,l,u,f,x,y){for(;--y>=0;){var F=l*this[a++]+u[f]+x;x=Math.floor(F/67108864),u[f++]=F&67108863}return x}function E(a,l,u,f,x,y){for(var F=l&32767,D=l>>15;--y>=0;){var V=this[a]&32767,U=this[a++]>>15,W=D*V+U*F;V=F*V+((W&32767)<<15)+u[f]+(x&1073741823),x=(V>>>30)+(W>>>15)+D*U+(x>>>30),u[f++]=V&1073741823}return x}function M(a,l,u,f,x,y){for(var F=l&16383,D=l>>14;--y>=0;){var V=this[a]&16383,U=this[a++]>>14,W=D*V+U*F;V=F*V+((W&16383)<<14)+u[f]+x,x=(V>>28)+(W>>14)+D*U,u[f++]=V&268435455}return x}e.appName=="Microsoft Internet Explorer"?(g.prototype.am=E,v=30):e.appName!="Netscape"?(g.prototype.am=S,v=26):(g.prototype.am=M,v=28),g.prototype.DB=v,g.prototype.DM=(1<<v)-1,g.prototype.DV=1<<v;var R=52;g.prototype.FV=Math.pow(2,R),g.prototype.F1=R-v,g.prototype.F2=2*v-R;var N="0123456789abcdefghijklmnopqrstuvwxyz",b=new Array,m,w;for(m=48,w=0;w<=9;++w)b[m++]=w;for(m=97,w=10;w<36;++w)b[m++]=w;for(m=65,w=10;w<36;++w)b[m++]=w;function T(a){return N.charAt(a)}function P(a,l){var u=b[a.charCodeAt(l)];return u??-1}function L(a){for(var l=this.t-1;l>=0;--l)a[l]=this[l];a.t=this.t,a.s=this.s}function k(a){this.t=1,this.s=a<0?-1:0,a>0?this[0]=a:a<-1?this[0]=a+this.DV:this.t=0}function I(a){var l=_();return l.fromInt(a),l}function z(a,l){var u;if(l==16)u=4;else if(l==8)u=3;else if(l==256)u=8;else if(l==2)u=1;else if(l==32)u=5;else if(l==4)u=2;else{this.fromRadix(a,l);return}this.t=0,this.s=0;for(var f=a.length,x=!1,y=0;--f>=0;){var F=u==8?a[f]&255:P(a,f);if(F<0){a.charAt(f)=="-"&&(x=!0);continue}x=!1,y==0?this[this.t++]=F:y+u>this.DB?(this[this.t-1]|=(F&(1<<this.DB-y)-1)<<y,this[this.t++]=F>>this.DB-y):this[this.t-1]|=F<<y,y+=u,y>=this.DB&&(y-=this.DB)}u==8&&(a[0]&128)!=0&&(this.s=-1,y>0&&(this[this.t-1]|=(1<<this.DB-y)-1<<y)),this.clamp(),x&&g.ZERO.subTo(this,this)}function K(){for(var a=this.s&this.DM;this.t>0&&this[this.t-1]==a;)--this.t}function $(a){if(this.s<0)return"-"+this.negate().toString(a);var l;if(a==16)l=4;else if(a==8)l=3;else if(a==2)l=1;else if(a==32)l=5;else if(a==4)l=2;else return this.toRadix(a);var u=(1<<l)-1,f,x=!1,y="",F=this.t,D=this.DB-F*this.DB%l;if(F-- >0)for(D<this.DB&&(f=this[F]>>D)>0&&(x=!0,y=T(f));F>=0;)D<l?(f=(this[F]&(1<<D)-1)<<l-D,f|=this[--F]>>(D+=this.DB-l)):(f=this[F]>>(D-=l)&u,D<=0&&(D+=this.DB,--F)),f>0&&(x=!0),x&&(y+=T(f));return x?y:"0"}function te(){var a=_();return g.ZERO.subTo(this,a),a}function ee(){return this.s<0?this.negate():this}function de(a){var l=this.s-a.s;if(l!=0)return l;var u=this.t;if(l=u-a.t,l!=0)return this.s<0?-l:l;for(;--u>=0;)if((l=this[u]-a[u])!=0)return l;return 0}function X(a){var l=1,u;return(u=a>>>16)!=0&&(a=u,l+=16),(u=a>>8)!=0&&(a=u,l+=8),(u=a>>4)!=0&&(a=u,l+=4),(u=a>>2)!=0&&(a=u,l+=2),(u=a>>1)!=0&&(a=u,l+=1),l}function le(){return this.t<=0?0:this.DB*(this.t-1)+X(this[this.t-1]^this.s&this.DM)}function _e(a,l){var u;for(u=this.t-1;u>=0;--u)l[u+a]=this[u];for(u=a-1;u>=0;--u)l[u]=0;l.t=this.t+a,l.s=this.s}function Se(a,l){for(var u=a;u<this.t;++u)l[u-a]=this[u];l.t=Math.max(this.t-a,0),l.s=this.s}function De(a,l){var u=a%this.DB,f=this.DB-u,x=(1<<f)-1,y=Math.floor(a/this.DB),F=this.s<<u&this.DM,D;for(D=this.t-1;D>=0;--D)l[D+y+1]=this[D]>>f|F,F=(this[D]&x)<<u;for(D=y-1;D>=0;--D)l[D]=0;l[y]=F,l.t=this.t+y+1,l.s=this.s,l.clamp()}function We(a,l){l.s=this.s;var u=Math.floor(a/this.DB);if(u>=this.t){l.t=0;return}var f=a%this.DB,x=this.DB-f,y=(1<<f)-1;l[0]=this[u]>>f;for(var F=u+1;F<this.t;++F)l[F-u-1]|=(this[F]&y)<<x,l[F-u]=this[F]>>f;f>0&&(l[this.t-u-1]|=(this.s&y)<<x),l.t=this.t-u,l.clamp()}function Ve(a,l){for(var u=0,f=0,x=Math.min(a.t,this.t);u<x;)f+=this[u]-a[u],l[u++]=f&this.DM,f>>=this.DB;if(a.t<this.t){for(f-=a.s;u<this.t;)f+=this[u],l[u++]=f&this.DM,f>>=this.DB;f+=this.s}else{for(f+=this.s;u<a.t;)f-=a[u],l[u++]=f&this.DM,f>>=this.DB;f-=a.s}l.s=f<0?-1:0,f<-1?l[u++]=this.DV+f:f>0&&(l[u++]=f),l.t=u,l.clamp()}function Me(a,l){var u=this.abs(),f=a.abs(),x=u.t;for(l.t=x+f.t;--x>=0;)l[x]=0;for(x=0;x<f.t;++x)l[x+u.t]=u.am(0,f[x],l,x,0,u.t);l.s=0,l.clamp(),this.s!=a.s&&g.ZERO.subTo(l,l)}function ze(a){for(var l=this.abs(),u=a.t=2*l.t;--u>=0;)a[u]=0;for(u=0;u<l.t-1;++u){var f=l.am(u,l[u],a,2*u,0,1);(a[u+l.t]+=l.am(u+1,2*l[u],a,2*u+1,f,l.t-u-1))>=l.DV&&(a[u+l.t]-=l.DV,a[u+l.t+1]=1)}a.t>0&&(a[a.t-1]+=l.am(u,l[u],a,2*u,0,1)),a.s=0,a.clamp()}function ht(a,l,u){var f=a.abs();if(!(f.t<=0)){var x=this.abs();if(x.t<f.t){l!=null&&l.fromInt(0),u!=null&&this.copyTo(u);return}u==null&&(u=_());var y=_(),F=this.s,D=a.s,V=this.DB-X(f[f.t-1]);V>0?(f.lShiftTo(V,y),x.lShiftTo(V,u)):(f.copyTo(y),x.copyTo(u));var U=y.t,W=y[U-1];if(W!=0){var G=W*(1<<this.F1)+(U>1?y[U-2]>>this.F2:0),A=this.FV/G,B=(1<<this.F1)/G,O=1<<this.F2,H=u.t,q=H-U,Z=l??_();for(y.dlShiftTo(q,Z),u.compareTo(Z)>=0&&(u[u.t++]=1,u.subTo(Z,u)),g.ONE.dlShiftTo(U,Z),Z.subTo(y,y);y.t<U;)y[y.t++]=0;for(;--q>=0;){var ce=u[--H]==W?this.DM:Math.floor(u[H]*A+(u[H-1]+O)*B);if((u[H]+=y.am(0,ce,u,q,0,U))<ce)for(y.dlShiftTo(q,Z),u.subTo(Z,u);u[H]<--ce;)u.subTo(Z,u)}l!=null&&(u.drShiftTo(U,l),F!=D&&g.ZERO.subTo(l,l)),u.t=U,u.clamp(),V>0&&u.rShiftTo(V,u),F<0&&g.ZERO.subTo(u,u)}}}function nt(a){var l=_();return this.abs().divRemTo(a,null,l),this.s<0&&l.compareTo(g.ZERO)>0&&a.subTo(l,l),l}function rt(a){this.m=a}function jt(a){return a.s<0||a.compareTo(this.m)>=0?a.mod(this.m):a}function Ct(a){return a}function li(a){a.divRemTo(this.m,null,a)}function di(a,l,u){a.multiplyTo(l,u),this.reduce(u)}function zt(a,l){a.squareTo(l),this.reduce(l)}rt.prototype.convert=jt,rt.prototype.revert=Ct,rt.prototype.reduce=li,rt.prototype.mulTo=di,rt.prototype.sqrTo=zt;function he(){if(this.t<1)return 0;var a=this[0];if((a&1)==0)return 0;var l=a&3;return l=l*(2-(a&15)*l)&15,l=l*(2-(a&255)*l)&255,l=l*(2-((a&65535)*l&65535))&65535,l=l*(2-a*l%this.DV)%this.DV,l>0?this.DV-l:-l}function mi(a){this.m=a,this.mp=a.invDigit(),this.mpl=this.mp&32767,this.mph=this.mp>>15,this.um=(1<<a.DB-15)-1,this.mt2=2*a.t}function ti(a){var l=_();return a.abs().dlShiftTo(this.m.t,l),l.divRemTo(this.m,null,l),a.s<0&&l.compareTo(g.ZERO)>0&&this.m.subTo(l,l),l}function si(a){var l=_();return a.copyTo(l),this.reduce(l),l}function yt(a){for(;a.t<=this.mt2;)a[a.t++]=0;for(var l=0;l<this.m.t;++l){var u=a[l]&32767,f=u*this.mpl+((u*this.mph+(a[l]>>15)*this.mpl&this.um)<<15)&a.DM;for(u=l+this.m.t,a[u]+=this.m.am(0,f,a,l,0,this.m.t);a[u]>=a.DV;)a[u]-=a.DV,a[++u]++}a.clamp(),a.drShiftTo(this.m.t,a),a.compareTo(this.m)>=0&&a.subTo(this.m,a)}function Xt(a,l){a.squareTo(l),this.reduce(l)}function Rt(a,l,u){a.multiplyTo(l,u),this.reduce(u)}mi.prototype.convert=ti,mi.prototype.revert=si,mi.prototype.reduce=yt,mi.prototype.mulTo=Rt,mi.prototype.sqrTo=Xt;function Ut(){return(this.t>0?this[0]&1:this.s)==0}function Ii(a,l){if(a>4294967295||a<1)return g.ONE;var u=_(),f=_(),x=l.convert(this),y=X(a)-1;for(x.copyTo(u);--y>=0;)if(l.sqrTo(u,f),(a&1<<y)>0)l.mulTo(f,x,u);else{var F=u;u=f,f=F}return l.revert(u)}function ue(a,l){var u;return a<256||l.isEven()?u=new rt(l):u=new mi(l),this.exp(a,u)}g.prototype.copyTo=L,g.prototype.fromInt=k,g.prototype.fromString=z,g.prototype.clamp=K,g.prototype.dlShiftTo=_e,g.prototype.drShiftTo=Se,g.prototype.lShiftTo=De,g.prototype.rShiftTo=We,g.prototype.subTo=Ve,g.prototype.multiplyTo=Me,g.prototype.squareTo=ze,g.prototype.divRemTo=ht,g.prototype.invDigit=he,g.prototype.isEven=Ut,g.prototype.exp=Ii,g.prototype.toString=$,g.prototype.negate=te,g.prototype.abs=ee,g.prototype.compareTo=de,g.prototype.bitLength=le,g.prototype.mod=nt,g.prototype.modPowInt=ue,g.ZERO=I(0),g.ONE=I(1);function ie(){var a=_();return this.copyTo(a),a}function Re(){if(this.s<0){if(this.t==1)return this[0]-this.DV;if(this.t==0)return-1}else{if(this.t==1)return this[0];if(this.t==0)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function Pe(){return this.t==0?this.s:this[0]<<24>>24}function Oe(){return this.t==0?this.s:this[0]<<16>>16}function Ce(a){return Math.floor(Math.LN2*this.DB/Math.log(a))}function tt(){return this.s<0?-1:this.t<=0||this.t==1&&this[0]<=0?0:1}function et(a){if(a==null&&(a=10),this.signum()==0||a<2||a>36)return"0";var l=this.chunkSize(a),u=Math.pow(a,l),f=I(u),x=_(),y=_(),F="";for(this.divRemTo(f,x,y);x.signum()>0;)F=(u+y.intValue()).toString(a).substr(1)+F,x.divRemTo(f,x,y);return y.intValue().toString(a)+F}function ut(a,l){this.fromInt(0),l==null&&(l=10);for(var u=this.chunkSize(l),f=Math.pow(l,u),x=!1,y=0,F=0,D=0;D<a.length;++D){var V=P(a,D);if(V<0){a.charAt(D)=="-"&&this.signum()==0&&(x=!0);continue}F=l*F+V,++y>=u&&(this.dMultiply(f),this.dAddOffset(F,0),y=0,F=0)}y>0&&(this.dMultiply(Math.pow(l,y)),this.dAddOffset(F,0)),x&&g.ZERO.subTo(this,this)}function Qe(a,l,u){if(typeof l=="number")if(a<2)this.fromInt(1);else for(this.fromNumber(a,u),this.testBit(a-1)||this.bitwiseTo(g.ONE.shiftLeft(a-1),ot,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(l);)this.dAddOffset(2,0),this.bitLength()>a&&this.subTo(g.ONE.shiftLeft(a-1),this);else{var f=new Array,x=a&7;f.length=(a>>3)+1,l.nextBytes(f),x>0?f[0]&=(1<<x)-1:f[0]=0,this.fromString(f,256)}}function Ie(){var a=this.t,l=new Array;l[0]=this.s;var u=this.DB-a*this.DB%8,f,x=0;if(a-- >0)for(u<this.DB&&(f=this[a]>>u)!=(this.s&this.DM)>>u&&(l[x++]=f|this.s<<this.DB-u);a>=0;)u<8?(f=(this[a]&(1<<u)-1)<<8-u,f|=this[--a]>>(u+=this.DB-8)):(f=this[a]>>(u-=8)&255,u<=0&&(u+=this.DB,--a)),(f&128)!=0&&(f|=-256),x==0&&(this.s&128)!=(f&128)&&++x,(x>0||f!=this.s)&&(l[x++]=f);return l}function it(a){return this.compareTo(a)==0}function Pt(a){return this.compareTo(a)<0?this:a}function Mt(a){return this.compareTo(a)>0?this:a}function st(a,l,u){var f,x,y=Math.min(a.t,this.t);for(f=0;f<y;++f)u[f]=l(this[f],a[f]);if(a.t<this.t){for(x=a.s&this.DM,f=y;f<this.t;++f)u[f]=l(this[f],x);u.t=this.t}else{for(x=this.s&this.DM,f=y;f<a.t;++f)u[f]=l(x,a[f]);u.t=a.t}u.s=l(this.s,a.s),u.clamp()}function kt(a,l){return a&l}function ve(a){var l=_();return this.bitwiseTo(a,kt,l),l}function ot(a,l){return a|l}function Ke(a){var l=_();return this.bitwiseTo(a,ot,l),l}function bt(a,l){return a^l}function Ze(a){var l=_();return this.bitwiseTo(a,bt,l),l}function Ge(a,l){return a&~l}function St(a){var l=_();return this.bitwiseTo(a,Ge,l),l}function Bt(){for(var a=_(),l=0;l<this.t;++l)a[l]=this.DM&~this[l];return a.t=this.t,a.s=~this.s,a}function Ci(a){var l=_();return a<0?this.rShiftTo(-a,l):this.lShiftTo(a,l),l}function ui(a){var l=_();return a<0?this.lShiftTo(-a,l):this.rShiftTo(a,l),l}function Vn(a){if(a==0)return-1;var l=0;return(a&65535)==0&&(a>>=16,l+=16),(a&255)==0&&(a>>=8,l+=8),(a&15)==0&&(a>>=4,l+=4),(a&3)==0&&(a>>=2,l+=2),(a&1)==0&&++l,l}function ar(){for(var a=0;a<this.t;++a)if(this[a]!=0)return a*this.DB+Vn(this[a]);return this.s<0?this.t*this.DB:-1}function ic(a){for(var l=0;a!=0;)a&=a-1,++l;return l}function nc(){for(var a=0,l=this.s&this.DM,u=0;u<this.t;++u)a+=ic(this[u]^l);return a}function zr(a){var l=Math.floor(a/this.DB);return l>=this.t?this.s!=0:(this[l]&1<<a%this.DB)!=0}function ro(a,l){var u=g.ONE.shiftLeft(a);return this.bitwiseTo(u,l,u),u}function rc(a){return this.changeBit(a,ot)}function sc(a){return this.changeBit(a,Ge)}function da(a){return this.changeBit(a,bt)}function ac(a,l){for(var u=0,f=0,x=Math.min(a.t,this.t);u<x;)f+=this[u]+a[u],l[u++]=f&this.DM,f>>=this.DB;if(a.t<this.t){for(f+=a.s;u<this.t;)f+=this[u],l[u++]=f&this.DM,f>>=this.DB;f+=this.s}else{for(f+=this.s;u<a.t;)f+=a[u],l[u++]=f&this.DM,f>>=this.DB;f+=a.s}l.s=f<0?-1:0,f>0?l[u++]=f:f<-1&&(l[u++]=this.DV+f),l.t=u,l.clamp()}function ua(a){var l=_();return this.addTo(a,l),l}function oc(a){var l=_();return this.subTo(a,l),l}function cc(a){var l=_();return this.multiplyTo(a,l),l}function Xl(){var a=_();return this.squareTo(a),a}function $l(a){var l=_();return this.divRemTo(a,l,null),l}function Zl(a){var l=_();return this.divRemTo(a,null,l),l}function Yl(a){var l=_(),u=_();return this.divRemTo(a,l,u),new Array(l,u)}function Jl(a){this[this.t]=this.am(0,a-1,this,0,0,this.t),++this.t,this.clamp()}function Ql(a,l){if(a!=0){for(;this.t<=l;)this[this.t++]=0;for(this[l]+=a;this[l]>=this.DV;)this[l]-=this.DV,++l>=this.t&&(this[this.t++]=0),++this[l]}}function se(){}function xe(a){return a}function Ne(a,l,u){a.multiplyTo(l,u)}function Le(a,l){a.squareTo(l)}se.prototype.convert=xe,se.prototype.revert=xe,se.prototype.mulTo=Ne,se.prototype.sqrTo=Le;function Ee(a){return this.exp(a,new se)}function Ye(a,l,u){var f=Math.min(this.t+a.t,l);for(u.s=0,u.t=f;f>0;)u[--f]=0;var x;for(x=u.t-this.t;f<x;++f)u[f+this.t]=this.am(0,a[f],u,f,0,this.t);for(x=Math.min(a.t,l);f<x;++f)this.am(0,a[f],u,f,0,l-f);u.clamp()}function dt(a,l,u){--l;var f=u.t=this.t+a.t-l;for(u.s=0;--f>=0;)u[f]=0;for(f=Math.max(l-this.t,0);f<a.t;++f)u[this.t+f-l]=this.am(l-f,a[f],u,0,0,this.t+f-l);u.clamp(),u.drShiftTo(1,u)}function mt(a){this.r2=_(),this.q3=_(),g.ONE.dlShiftTo(2*a.t,this.r2),this.mu=this.r2.divide(a),this.m=a}function vt(a){if(a.s<0||a.t>2*this.m.t)return a.mod(this.m);if(a.compareTo(this.m)<0)return a;var l=_();return a.copyTo(l),this.reduce(l),l}function It(a){return a}function Nt(a){for(a.drShiftTo(this.m.t-1,this.r2),a.t>this.m.t+1&&(a.t=this.m.t+1,a.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);a.compareTo(this.r2)<0;)a.dAddOffset(1,this.m.t+1);for(a.subTo(this.r2,a);a.compareTo(this.m)>=0;)a.subTo(this.m,a)}function Tt(a,l){a.squareTo(l),this.reduce(l)}function Zt(a,l,u){a.multiplyTo(l,u),this.reduce(u)}mt.prototype.convert=vt,mt.prototype.revert=It,mt.prototype.reduce=Nt,mt.prototype.mulTo=Zt,mt.prototype.sqrTo=Tt;function hi(a,l){var u=a.bitLength(),f,x=I(1),y;if(u<=0)return x;u<18?f=1:u<48?f=3:u<144?f=4:u<768?f=5:f=6,u<8?y=new rt(l):l.isEven()?y=new mt(l):y=new mi(l);var F=new Array,D=3,V=f-1,U=(1<<f)-1;if(F[1]=y.convert(this),f>1){var W=_();for(y.sqrTo(F[1],W);D<=U;)F[D]=_(),y.mulTo(W,F[D-2],F[D]),D+=2}var G=a.t-1,A,B=!0,O=_(),H;for(u=X(a[G])-1;G>=0;){for(u>=V?A=a[G]>>u-V&U:(A=(a[G]&(1<<u+1)-1)<<V-u,G>0&&(A|=a[G-1]>>this.DB+u-V)),D=f;(A&1)==0;)A>>=1,--D;if((u-=D)<0&&(u+=this.DB,--G),B)F[A].copyTo(x),B=!1;else{for(;D>1;)y.sqrTo(x,O),y.sqrTo(O,x),D-=2;D>0?y.sqrTo(x,O):(H=x,x=O,O=H),y.mulTo(O,F[A],x)}for(;G>=0&&(a[G]&1<<u)==0;)y.sqrTo(x,O),H=x,x=O,O=H,--u<0&&(u=this.DB-1,--G)}return y.revert(x)}function Mi(a){var l=this.s<0?this.negate():this.clone(),u=a.s<0?a.negate():a.clone();if(l.compareTo(u)<0){var f=l;l=u,u=f}var x=l.getLowestSetBit(),y=u.getLowestSetBit();if(y<0)return l;for(x<y&&(y=x),y>0&&(l.rShiftTo(y,l),u.rShiftTo(y,u));l.signum()>0;)(x=l.getLowestSetBit())>0&&l.rShiftTo(x,l),(x=u.getLowestSetBit())>0&&u.rShiftTo(x,u),l.compareTo(u)>=0?(l.subTo(u,l),l.rShiftTo(1,l)):(u.subTo(l,u),u.rShiftTo(1,u));return y>0&&u.lShiftTo(y,u),u}function Fi(a){if(a<=0)return 0;var l=this.DV%a,u=this.s<0?a-1:0;if(this.t>0)if(l==0)u=this[0]%a;else for(var f=this.t-1;f>=0;--f)u=(l*u+this[f])%a;return u}function ii(a){var l=a.isEven();if(this.isEven()&&l||a.signum()==0)return g.ZERO;for(var u=a.clone(),f=this.clone(),x=I(1),y=I(0),F=I(0),D=I(1);u.signum()!=0;){for(;u.isEven();)u.rShiftTo(1,u),l?((!x.isEven()||!y.isEven())&&(x.addTo(this,x),y.subTo(a,y)),x.rShiftTo(1,x)):y.isEven()||y.subTo(a,y),y.rShiftTo(1,y);for(;f.isEven();)f.rShiftTo(1,f),l?((!F.isEven()||!D.isEven())&&(F.addTo(this,F),D.subTo(a,D)),F.rShiftTo(1,F)):D.isEven()||D.subTo(a,D),D.rShiftTo(1,D);u.compareTo(f)>=0?(u.subTo(f,u),l&&x.subTo(F,x),y.subTo(D,y)):(f.subTo(u,f),l&&F.subTo(x,F),D.subTo(y,D))}if(f.compareTo(g.ONE)!=0)return g.ZERO;if(D.compareTo(a)>=0)return D.subtract(a);if(D.signum()<0)D.addTo(a,D);else return D;return D.signum()<0?D.add(a):D}var _t=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],$i=(1<<26)/_t[_t.length-1];function ai(a){var l,u=this.abs();if(u.t==1&&u[0]<=_t[_t.length-1]){for(l=0;l<_t.length;++l)if(u[0]==_t[l])return!0;return!1}if(u.isEven())return!1;for(l=1;l<_t.length;){for(var f=_t[l],x=l+1;x<_t.length&&f<$i;)f*=_t[x++];for(f=u.modInt(f);l<x;)if(f%_t[l++]==0)return!1}return u.millerRabin(a)}function zn(a){var l=this.subtract(g.ONE),u=l.getLowestSetBit();if(u<=0)return!1;var f=l.shiftRight(u);a=a+1>>1,a>_t.length&&(a=_t.length);for(var x=_(),y=0;y<a;++y){x.fromInt(_t[Math.floor(Math.random()*_t.length)]);var F=x.modPow(f,this);if(F.compareTo(g.ONE)!=0&&F.compareTo(l)!=0){for(var D=1;D++<u&&F.compareTo(l)!=0;)if(F=F.modPowInt(2,this),F.compareTo(g.ONE)==0)return!1;if(F.compareTo(l)!=0)return!1}}return!0}g.prototype.chunkSize=Ce,g.prototype.toRadix=et,g.prototype.fromRadix=ut,g.prototype.fromNumber=Qe,g.prototype.bitwiseTo=st,g.prototype.changeBit=ro,g.prototype.addTo=ac,g.prototype.dMultiply=Jl,g.prototype.dAddOffset=Ql,g.prototype.multiplyLowerTo=Ye,g.prototype.multiplyUpperTo=dt,g.prototype.modInt=Fi,g.prototype.millerRabin=zn,g.prototype.clone=ie,g.prototype.intValue=Re,g.prototype.byteValue=Pe,g.prototype.shortValue=Oe,g.prototype.signum=tt,g.prototype.toByteArray=Ie,g.prototype.equals=it,g.prototype.min=Pt,g.prototype.max=Mt,g.prototype.and=ve,g.prototype.or=Ke,g.prototype.xor=Ze,g.prototype.andNot=St,g.prototype.not=Bt,g.prototype.shiftLeft=Ci,g.prototype.shiftRight=ui,g.prototype.getLowestSetBit=ar,g.prototype.bitCount=nc,g.prototype.testBit=zr,g.prototype.setBit=rc,g.prototype.clearBit=sc,g.prototype.flipBit=da,g.prototype.add=ua,g.prototype.subtract=oc,g.prototype.multiply=cc,g.prototype.divide=$l,g.prototype.remainder=Zl,g.prototype.divideAndRemainder=Yl,g.prototype.modPow=hi,g.prototype.modInverse=ii,g.prototype.pow=Ee,g.prototype.gcd=Mi,g.prototype.isProbablePrime=ai,g.prototype.square=Xl;function Pr(){this.i=0,this.j=0,this.S=new Array}function _n(a){var l,u,f;for(l=0;l<256;++l)this.S[l]=l;for(u=0,l=0;l<256;++l)u=u+this.S[l]+a[l%a.length]&255,f=this.S[l],this.S[l]=this.S[u],this.S[u]=f;this.i=0,this.j=0}function Is(){var a;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,a=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=a,this.S[a+this.S[this.i]&255]}Pr.prototype.init=_n,Pr.prototype.next=Is;function Ri(){return new Pr}var un=256,sn,_i,ri;function so(a){_i[ri++]^=a&255,_i[ri++]^=a>>8&255,_i[ri++]^=a>>16&255,_i[ri++]^=a>>24&255,ri>=un&&(ri-=un)}function or(){so(new Date().getTime())}if(_i==null){if(_i=new Array,ri=0,i!==void 0&&(i.crypto!==void 0||i.msCrypto!==void 0)){if(ed=i.crypto||i.msCrypto,ed.getRandomValues)for(td=new Uint8Array(32),ed.getRandomValues(td),cr=0;cr<32;++cr)_i[ri++]=td[cr];else if(e.appName=="Netscape"&&e.appVersion<"5")for(id=i.crypto.random(32),cr=0;cr<id.length;++cr)_i[ri++]=id.charCodeAt(cr)&255}for(;ri<un;)cr=Math.floor(65536*Math.random()),_i[ri++]=cr>>>8,_i[ri++]=cr&255;ri=0,or()}var cr,ed,td,id;function Wv(){if(sn==null){for(or(),sn=Ri(),sn.init(_i),ri=0;ri<_i.length;++ri)_i[ri]=0;ri=0}return sn.next()}function Kv(a){var l;for(l=0;l<a.length;++l)a[l]=Wv()}function ha(){}ha.prototype.nextBytes=Kv;function Pn(a,l){return new g(a,l)}function Lt(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function Xv(a,l){if(this.isPublic=!0,this.isPrivate=!1,typeof a!="string")this.n=a,this.e=l;else if(a!=null&&l!=null&&a.length>0&&l.length>0)this.n=Pn(a,16),this.e=parseInt(l,16);else throw"Invalid RSA public key"}function $v(a){return a.modPowInt(this.e,this.n)}Lt.prototype.doPublic=$v,Lt.prototype.setPublic=Xv,Lt.prototype.type="RSA";function Zv(a,l,u){if(this.isPrivate=!0,typeof a!="string")this.n=a,this.e=l,this.d=u;else if(a!=null&&l!=null&&a.length>0&&l.length>0)this.n=Pn(a,16),this.e=parseInt(l,16),this.d=Pn(u,16);else throw"Invalid RSA private key"}function Yv(a,l,u,f,x,y,F,D){if(this.isPrivate=!0,this.isPublic=!1,a==null)throw"RSASetPrivateEx N == null";if(l==null)throw"RSASetPrivateEx E == null";if(a.length==0)throw"RSASetPrivateEx N.length == 0";if(l.length==0)throw"RSASetPrivateEx E.length == 0";if(a!=null&&l!=null&&a.length>0&&l.length>0)this.n=Pn(a,16),this.e=parseInt(l,16),this.d=Pn(u,16),this.p=Pn(f,16),this.q=Pn(x,16),this.dmp1=Pn(y,16),this.dmq1=Pn(F,16),this.coeff=Pn(D,16);else throw"Invalid RSA private key in RSASetPrivateEx"}function Jv(a,l){var u=new ha,f=a>>1;this.e=parseInt(l,16);for(var x=new g(l,16),y=a/2-100,F=g.ONE.shiftLeft(y);;){for(;this.p=new g(a-f,1,u),!(this.p.subtract(g.ONE).gcd(x).compareTo(g.ONE)==0&&this.p.isProbablePrime(10)););for(;this.q=new g(f,1,u),!(this.q.subtract(g.ONE).gcd(x).compareTo(g.ONE)==0&&this.q.isProbablePrime(10)););if(this.p.compareTo(this.q)<=0){var D=this.p;this.p=this.q,this.q=D}var V=this.q.subtract(this.p).abs();if(!(V.bitLength()<y||V.compareTo(F)<=0)){var U=this.p.subtract(g.ONE),W=this.q.subtract(g.ONE),G=U.multiply(W);if(G.gcd(x).compareTo(g.ONE)==0&&(this.n=this.p.multiply(this.q),this.n.bitLength()==a)){this.d=x.modInverse(G),this.dmp1=this.d.mod(U),this.dmq1=this.d.mod(W),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0}function Qv(a){if(this.p==null||this.q==null)return a.modPow(this.d,this.n);for(var l=a.mod(this.p).modPow(this.dmp1,this.p),u=a.mod(this.q).modPow(this.dmq1,this.q);l.compareTo(u)<0;)l=l.add(this.p);return l.subtract(u).multiply(this.coeff).mod(this.p).multiply(this.q).add(u)}Lt.prototype.doPrivate=Qv,Lt.prototype.setPrivate=Zv,Lt.prototype.setPrivateEx=Yv,Lt.prototype.generate=Jv;function Zi(a,l){this.x=l,this.q=a}function e_(a){return a==this?!0:this.q.equals(a.q)&&this.x.equals(a.x)}function t_(){return this.x}function i_(){return new Zi(this.q,this.x.negate().mod(this.q))}function n_(a){return new Zi(this.q,this.x.add(a.toBigInteger()).mod(this.q))}function r_(a){return new Zi(this.q,this.x.subtract(a.toBigInteger()).mod(this.q))}function s_(a){return new Zi(this.q,this.x.multiply(a.toBigInteger()).mod(this.q))}function a_(){return new Zi(this.q,this.x.square().mod(this.q))}function o_(a){return new Zi(this.q,this.x.multiply(a.toBigInteger().modInverse(this.q)).mod(this.q))}Zi.prototype.equals=e_,Zi.prototype.toBigInteger=t_,Zi.prototype.negate=i_,Zi.prototype.add=n_,Zi.prototype.subtract=r_,Zi.prototype.multiply=s_,Zi.prototype.square=a_,Zi.prototype.divide=o_,Zi.prototype.sqrt=function(){return new Zi(this.q,this.x.sqrt().mod(this.q))};function oi(a,l,u,f){this.curve=a,this.x=l,this.y=u,f==null?this.z=g.ONE:this.z=f,this.zinv=null}function c_(){return this.zinv==null&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function l_(){return this.zinv==null&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function d_(a){if(a==this)return!0;if(this.isInfinity())return a.isInfinity();if(a.isInfinity())return this.isInfinity();var l,u;return l=a.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(a.z)).mod(this.curve.q),l.equals(g.ZERO)?(u=a.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(a.z)).mod(this.curve.q),u.equals(g.ZERO)):!1}function u_(){return this.x==null&&this.y==null?!0:this.z.equals(g.ZERO)&&!this.y.toBigInteger().equals(g.ZERO)}function h_(){return new oi(this.curve,this.x,this.y.negate(),this.z)}function p_(a){if(this.isInfinity())return a;if(a.isInfinity())return this;var l=a.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(a.z)).mod(this.curve.q),u=a.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(a.z)).mod(this.curve.q);if(g.ZERO.equals(u))return g.ZERO.equals(l)?this.twice():this.curve.getInfinity();var f=new g("3"),x=this.x.toBigInteger(),y=this.y.toBigInteger();a.x.toBigInteger(),a.y.toBigInteger();var F=u.square(),D=F.multiply(u),V=x.multiply(F),U=l.square().multiply(this.z),W=U.subtract(V.shiftLeft(1)).multiply(a.z).subtract(D).multiply(u).mod(this.curve.q),G=V.multiply(f).multiply(l).subtract(y.multiply(D)).subtract(U.multiply(l)).multiply(a.z).add(l.multiply(D)).mod(this.curve.q),A=D.multiply(this.z).multiply(a.z).mod(this.curve.q);return new oi(this.curve,this.curve.fromBigInteger(W),this.curve.fromBigInteger(G),A)}function f_(){if(this.isInfinity())return this;if(this.y.toBigInteger().signum()==0)return this.curve.getInfinity();var a=new g("3"),l=this.x.toBigInteger(),u=this.y.toBigInteger(),f=u.multiply(this.z),x=f.multiply(u).mod(this.curve.q),y=this.curve.a.toBigInteger(),F=l.square().multiply(a);g.ZERO.equals(y)||(F=F.add(this.z.square().multiply(y))),F=F.mod(this.curve.q);var D=F.square().subtract(l.shiftLeft(3).multiply(x)).shiftLeft(1).multiply(f).mod(this.curve.q),V=F.multiply(a).multiply(l).subtract(x.shiftLeft(1)).shiftLeft(2).multiply(x).subtract(F.square().multiply(F)).mod(this.curve.q),U=f.square().multiply(f).shiftLeft(3).mod(this.curve.q);return new oi(this.curve,this.curve.fromBigInteger(D),this.curve.fromBigInteger(V),U)}function m_(a){if(this.isInfinity())return this;if(a.signum()==0)return this.curve.getInfinity();var l=a,u=l.multiply(new g("3")),f=this.negate(),x=this,y=this.curve.q.subtract(a),F=y.multiply(new g("3")),D=new oi(this.curve,this.x,this.y),V=D.negate(),U;for(U=u.bitLength()-2;U>0;--U){x=x.twice();var W=u.testBit(U),G=l.testBit(U);W!=G&&(x=x.add(W?this:f))}for(U=F.bitLength()-2;U>0;--U){D=D.twice();var A=F.testBit(U),B=y.testBit(U);A!=B&&(D=D.add(A?D:V))}return x}function g_(a,l,u){var f;a.bitLength()>u.bitLength()?f=a.bitLength()-1:f=u.bitLength()-1;for(var x=this.curve.getInfinity(),y=this.add(l);f>=0;)x=x.twice(),a.testBit(f)?u.testBit(f)?x=x.add(y):x=x.add(this):u.testBit(f)&&(x=x.add(l)),--f;return x}oi.prototype.getX=c_,oi.prototype.getY=l_,oi.prototype.equals=d_,oi.prototype.isInfinity=u_,oi.prototype.negate=h_,oi.prototype.add=p_,oi.prototype.twice=f_,oi.prototype.multiply=m_,oi.prototype.multiplyTwo=g_;function Gr(a,l,u){this.q=a,this.a=this.fromBigInteger(l),this.b=this.fromBigInteger(u),this.infinity=new oi(this,null,null)}function v_(){return this.q}function __(){return this.a}function b_(){return this.b}function y_(a){return a==this?!0:this.q.equals(a.q)&&this.a.equals(a.a)&&this.b.equals(a.b)}function S_(){return this.infinity}function w_(a){return new Zi(this.q,a)}function x_(a){switch(parseInt(a.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var l=a.substr(0,2);a.substr(2);var u=this.fromBigInteger(new g(V,16)),f=this.getA(),x=this.getB(),y=u.square().add(f).multiply(u).add(x),F=y.sqrt();return l=="03"&&(F=F.negate()),new oi(this,u,F);case 4:case 6:case 7:var D=(a.length-2)/2,V=a.substr(2,D),U=a.substr(D+2,D);return new oi(this,this.fromBigInteger(new g(V,16)),this.fromBigInteger(new g(U,16)));default:return null}}Gr.prototype.getQ=v_,Gr.prototype.getA=__,Gr.prototype.getB=b_,Gr.prototype.equals=y_,Gr.prototype.getInfinity=S_,Gr.prototype.fromBigInteger=w_,Gr.prototype.decodePointHex=x_,Zi.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},oi.prototype.getEncoded=function(a){var l=function(y,F){var D=y.toByteArrayUnsigned();if(F<D.length)D=D.slice(D.length-F);else for(;F>D.length;)D.unshift(0);return D},u=this.getX().toBigInteger(),f=this.getY().toBigInteger(),x=l(u,32);return a?f.isEven()?x.unshift(2):x.unshift(3):(x.unshift(4),x=x.concat(l(f,32))),x},oi.decodeFrom=function(a,l){l[0];var u=l.length-1,f=l.slice(1,1+u/2),x=l.slice(1+u/2,1+u);f.unshift(0),x.unshift(0);var y=new g(f),F=new g(x);return new oi(a,a.fromBigInteger(y),a.fromBigInteger(F))},oi.decodeFromHex=function(a,l){l.substr(0,2);var u=l.length-2,f=l.substr(2,u/2),x=l.substr(2+u/2,u/2),y=new g(f,16),F=new g(x,16);return new oi(a,a.fromBigInteger(y),a.fromBigInteger(F))},oi.prototype.add2D=function(a){if(this.isInfinity())return a;if(a.isInfinity())return this;if(this.x.equals(a.x))return this.y.equals(a.y)?this.twice():this.curve.getInfinity();var l=a.x.subtract(this.x),u=a.y.subtract(this.y),f=u.divide(l),x=f.square().subtract(this.x).subtract(a.x),y=f.multiply(this.x.subtract(x)).subtract(this.y);return new oi(this.curve,x,y)},oi.prototype.twice2D=function(){if(this.isInfinity())return this;if(this.y.toBigInteger().signum()==0)return this.curve.getInfinity();var a=this.curve.fromBigInteger(g.valueOf(2)),l=this.curve.fromBigInteger(g.valueOf(3)),u=this.x.square().multiply(l).add(this.curve.a).divide(this.y.multiply(a)),f=u.square().subtract(this.x.multiply(a)),x=u.multiply(this.x.subtract(f)).subtract(this.y);return new oi(this.curve,f,x)},oi.prototype.multiply2D=function(a){if(this.isInfinity())return this;if(a.signum()==0)return this.curve.getInfinity();var l=a,u=l.multiply(new g("3")),f=this.negate(),x=this,y;for(y=u.bitLength()-2;y>0;--y){x=x.twice();var F=u.testBit(y),D=l.testBit(y);F!=D&&(x=x.add2D(F?this:f))}return x},oi.prototype.isOnCurve=function(){var a=this.getX().toBigInteger(),l=this.getY().toBigInteger(),u=this.curve.getA().toBigInteger(),f=this.curve.getB().toBigInteger(),x=this.curve.getQ(),y=l.multiply(l).mod(x),F=a.multiply(a).multiply(a).add(u.multiply(a)).add(f).mod(x);return y.equals(F)},oi.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},oi.prototype.validate=function(){var a=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var l=this.getX().toBigInteger(),u=this.getY().toBigInteger();if(l.compareTo(g.ONE)<0||l.compareTo(a.subtract(g.ONE))>0)throw new Error("x coordinate out of bounds");if(u.compareTo(g.ONE)<0||u.compareTo(a.subtract(g.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(a).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};var Wh=function(){var a="(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)",l='(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))',u='(?:"'+l+'*")',f=new RegExp("(?:false|true|null|[\\{\\}\\[\\]]|"+a+"|"+u+")","g"),x=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),y={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:`
`,r:"\r",t:"	"};function F(W,G,A){return G?y[G]:String.fromCharCode(parseInt(A,16))}var D=new String(""),V="\\",U=Object.hasOwnProperty;return function(W,G){var A=W.match(f),B,O=A[0],H=!1;O==="{"?B={}:O==="["?B=[]:(B=[],H=!0);for(var q,Z=[B],ce=1-H,fe=A.length;ce<fe;++ce){O=A[ce];var pe;switch(O.charCodeAt(0)){default:pe=Z[0],pe[q||pe.length]=+O,q=void 0;break;case 34:if(O=O.substring(1,O.length-1),O.indexOf(V)!==-1&&(O=O.replace(x,F)),pe=Z[0],!q)if(pe instanceof Array)q=pe.length;else{q=O||D;break}pe[q]=O,q=void 0;break;case 91:pe=Z[0],Z.unshift(pe[q||pe.length]=[]),q=void 0;break;case 93:Z.shift();break;case 102:pe=Z[0],pe[q||pe.length]=!1,q=void 0;break;case 110:pe=Z[0],pe[q||pe.length]=null,q=void 0;break;case 116:pe=Z[0],pe[q||pe.length]=!0,q=void 0;break;case 123:pe=Z[0],Z.unshift(pe[q||pe.length]={}),q=void 0;break;case 125:Z.shift();break}}if(H){if(Z.length!==1)throw new Error;B=B[0]}else if(Z.length)throw new Error;if(G){var ge=function(Y,Q){var re=Y[Q];if(re&&typeof re=="object"){var J=null;for(var oe in re)if(U.call(re,oe)&&re!==Y){var me=ge(re,oe);me!==void 0?re[oe]=me:(J||(J=[]),J.push(oe))}if(J)for(var ye=J.length;--ye>=0;)delete re[J[ye]]}return G.call(Y,Q,re)};B=ge({"":B},"")}return B}}();(typeof C>"u"||!C)&&(C={}),(typeof C.asn1>"u"||!C.asn1)&&(C.asn1={}),C.asn1.ASN1Util=new function(){this.integerToByteHex=function(a){var l=a.toString(16);return l.length%2==1&&(l="0"+l),l},this.bigIntToMinTwosComplementsHex=function(a){return co(a)},this.getPEMStringFromHex=function(a,l){return hn(a,l)},this.newObject=function(a){var l=C,u=l.asn1,f=u.ASN1Object,x=u.DERBoolean,y=u.DERInteger,F=u.DERBitString,D=u.DEROctetString,V=u.DERNull,U=u.DERObjectIdentifier,W=u.DEREnumerated,G=u.DERUTF8String,A=u.DERNumericString,B=u.DERPrintableString,O=u.DERTeletexString,H=u.DERIA5String,q=u.DERUTCTime,Z=u.DERGeneralizedTime,ce=u.DERVisibleString,fe=u.DERBMPString,pe=u.DERSequence,ge=u.DERSet,Y=u.DERTaggedObject,Q=u.ASN1Util.newObject;if(a instanceof u.ASN1Object)return a;var re=Object.keys(a);if(re.length!=1)throw new Error("key of param shall be only one.");var J=re[0];if(":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+J+":")==-1)throw new Error("undefined key: "+J);if(J=="bool")return new x(a[J]);if(J=="int")return new y(a[J]);if(J=="bitstr")return new F(a[J]);if(J=="octstr")return new D(a[J]);if(J=="null")return new V(a[J]);if(J=="oid")return new U(a[J]);if(J=="enum")return new W(a[J]);if(J=="utf8str")return new G(a[J]);if(J=="numstr")return new A(a[J]);if(J=="prnstr")return new B(a[J]);if(J=="telstr")return new O(a[J]);if(J=="ia5str")return new H(a[J]);if(J=="utctime")return new q(a[J]);if(J=="gentime")return new Z(a[J]);if(J=="visstr")return new ce(a[J]);if(J=="bmpstr")return new fe(a[J]);if(J=="asn1")return new f(a[J]);if(J=="seq"){for(var oe=a[J],me=[],ye=0;ye<oe.length;ye++){var Be=Q(oe[ye]);me.push(Be)}return new pe({array:me})}if(J=="set"){for(var oe=a[J],me=[],ye=0;ye<oe.length;ye++){var Be=Q(oe[ye]);me.push(Be)}return new ge({array:me})}if(J=="tag"){var be=a[J];if(Object.prototype.toString.call(be)==="[object Array]"&&be.length==3){var Te=Q(be[2]);return new Y({tag:be[0],explicit:be[1],obj:Te})}else return new Y(be)}},this.jsonToASN1HEX=function(a){var l=this.newObject(a);return l.tohex()}},C.asn1.ASN1Util.oidHexToInt=function(a){for(var x="",l=parseInt(a.substr(0,2),16),u=Math.floor(l/40),f=l%40,x=u+"."+f,y="",F=2;F<a.length;F+=2){var D=parseInt(a.substr(F,2),16),V=("00000000"+D.toString(2)).slice(-8);if(y=y+V.substr(1,7),V.substr(0,1)=="0"){var U=new g(y,2);x=x+"."+U.toString(10),y=""}}return x},C.asn1.ASN1Util.oidIntToHex=function(a){var l=function(D){var V=D.toString(16);return V.length==1&&(V="0"+V),V},u=function(D){var V="",U=new g(D,10),W=U.toString(2),G=7-W.length%7;G==7&&(G=0);for(var A="",B=0;B<G;B++)A+="0";W=A+W;for(var B=0;B<W.length-1;B+=7){var O=W.substr(B,7);B!=W.length-7&&(O="1"+O),V+=l(parseInt(O,2))}return V};if(!a.match(/^[0-9.]+$/))throw"malformed oid string: "+a;var f="",x=a.split("."),y=parseInt(x[0])*40+parseInt(x[1]);f+=l(y),x.splice(0,2);for(var F=0;F<x.length;F++)f+=u(x[F]);return f},C.asn1.ASN1Object=function(a){var l="";this.params=null,this.getLengthHexFromValue=function(){if(typeof this.hV>"u"||this.hV==null)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n="+l.length+",v="+this.hV);var u=this.hV.length/2,f=u.toString(16);if(f.length%2==1&&(f="0"+f),u<128)return f;var x=f.length/2;if(x>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+u.toString(16));var y=128+x;return y.toString(16)+f},this.tohex=function(){return(this.hTLV==null||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(u){this.params=u},a!=null&&a.tlv!=null&&(this.hTLV=a.tlv,this.isModified=!1)},C.asn1.DERAbstractString=function(a){C.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(l){this.hTLV=null,this.isModified=!0,this.s=l,this.hV=dc(this.s).toLowerCase()},this.setStringHex=function(l){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=l},this.getFreshValueHex=function(){return this.hV},typeof a<"u"&&(typeof a=="string"?this.setString(a):typeof a.str<"u"?this.setString(a.str):typeof a.hex<"u"&&this.setStringHex(a.hex))},Ue(C.asn1.DERAbstractString,C.asn1.ASN1Object),C.asn1.DERAbstractTime=function(a){C.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(l){var u=l.getTime()+l.getTimezoneOffset()*6e4,f=new Date(u);return f},this.formatDate=function(l,u,f){var x=this.zeroPadding,y=this.localDateToUTC(l),F=String(y.getFullYear());u=="utc"&&(F=F.substr(2,2));var D=x(String(y.getMonth()+1),2),V=x(String(y.getDate()),2),U=x(String(y.getHours()),2),W=x(String(y.getMinutes()),2),G=x(String(y.getSeconds()),2),A=F+D+V+U+W+G;if(f===!0){var B=y.getMilliseconds();if(B!=0){var O=x(String(B),3);O=O.replace(/[0]+$/,""),A=A+"."+O}}return A+"Z"},this.zeroPadding=function(l,u){return l.length>=u?l:new Array(u-l.length+1).join("0")+l},this.setByParam=function(l){this.hV=null,this.hTLV=null,this.params=l},this.getString=function(){},this.setString=function(l){this.hTLV=null,this.isModified=!0,this.params==null&&(this.params={}),this.params.str=l},this.setByDate=function(l){this.hTLV=null,this.isModified=!0,this.params==null&&(this.params={}),this.params.date=l},this.setByDateValue=function(l,u,f,x,y,F){var D=new Date(Date.UTC(l,u-1,f,x,y,F,0));this.setByDate(D)},this.getFreshValueHex=function(){return this.hV}},Ue(C.asn1.DERAbstractTime,C.asn1.ASN1Object),C.asn1.DERAbstractStructured=function(a){C.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(l){this.hTLV=null,this.isModified=!0,this.asn1Array=l},this.appendASN1Object=function(l){this.hTLV=null,this.isModified=!0,this.asn1Array.push(l)},this.asn1Array=new Array,typeof a<"u"&&typeof a.array<"u"&&(this.asn1Array=a.array)},Ue(C.asn1.DERAbstractStructured,C.asn1.ASN1Object),C.asn1.DERBoolean=function(a){C.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",a==!1?this.hTLV="010100":this.hTLV="0101ff"},Ue(C.asn1.DERBoolean,C.asn1.ASN1Object),C.asn1.DERInteger=function(a){C.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.params=null;var l=co;this.setByBigInteger=function(u){this.isModified=!0,this.params={bigint:u}},this.setByInteger=function(u){this.isModified=!0,this.params=u},this.setValueHex=function(u){this.isModified=!0,this.params={hex:u}},this.getFreshValueHex=function(){var u=this.params,f=null;if(u==null)throw new Error("value not set");if(typeof u=="object"&&u.hex!=null)return this.hV=u.hex,this.hV;if(typeof u=="number")f=new g(String(u),10);else if(u.int!=null)f=new g(String(u.int),10);else if(u.bigint!=null)f=u.bigint;else throw new Error("wrong parameter");return this.hV=l(f),this.hV},a!=null&&(this.params=a)},Ue(C.asn1.DERInteger,C.asn1.ASN1Object),C.asn1.DERBitString=function(a){if(a!==void 0&&typeof a.obj<"u"){var l=C.asn1.ASN1Util.newObject(a.obj);a.hex="00"+l.tohex()}C.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(u){this.hTLV=null,this.isModified=!0,this.hV=u},this.setUnusedBitsAndHexValue=function(u,f){if(u<0||7<u)throw"unused bits shall be from 0 to 7: u = "+u;var x="0"+u;this.hTLV=null,this.isModified=!0,this.hV=x+f},this.setByBinaryString=function(u){u=u.replace(/0+$/,"");var f=8-u.length%8;f==8&&(f=0),u+="0000000".substr(0,f);for(var x="",y=0;y<u.length-1;y+=8){var F=u.substr(y,8),D=parseInt(F,2).toString(16);D.length==1&&(D="0"+D),x+=D}this.hTLV=null,this.isModified=!0,this.hV="0"+f+x},this.setByBooleanArray=function(u){for(var f="",x=0;x<u.length;x++)u[x]==!0?f+="1":f+="0";this.setByBinaryString(f)},this.newFalseArray=function(u){for(var f=new Array(u),x=0;x<u;x++)f[x]=!1;return f},this.getFreshValueHex=function(){return this.hV},typeof a<"u"&&(typeof a=="string"&&a.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(a):typeof a.hex<"u"?this.setHexValueIncludingUnusedBits(a.hex):typeof a.bin<"u"?this.setByBinaryString(a.bin):typeof a.array<"u"&&this.setByBooleanArray(a.array))},Ue(C.asn1.DERBitString,C.asn1.ASN1Object),C.asn1.DEROctetString=function(a){if(a!==void 0&&typeof a.obj<"u"){var l=C.asn1.ASN1Util.newObject(a.obj);a.hex=l.tohex()}C.asn1.DEROctetString.superclass.constructor.call(this,a),this.hT="04"},Ue(C.asn1.DEROctetString,C.asn1.DERAbstractString),C.asn1.DERNull=function(){C.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},Ue(C.asn1.DERNull,C.asn1.ASN1Object),C.asn1.DERObjectIdentifier=function(a){C.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(l){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=l},this.setValueOidString=function(l){var u=tp(l);if(u==null)throw new Error("malformed oid string: "+l);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=u},this.setValueName=function(l){var u=C.asn1.x509.OID.name2oid(l);if(u!=="")this.setValueOidString(u);else throw new Error("DERObjectIdentifier oidName undefined: "+l)},this.setValueNameOrOid=function(l){l.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(l):this.setValueName(l)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(l){typeof l=="string"?this.setValueNameOrOid(l):l.oid!==void 0?this.setValueNameOrOid(l.oid):l.name!==void 0?this.setValueNameOrOid(l.name):l.hex!==void 0&&this.setValueHex(l.hex)},a!==void 0&&this.setByParam(a)},Ue(C.asn1.DERObjectIdentifier,C.asn1.ASN1Object),C.asn1.DEREnumerated=function(a){C.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(l){this.hTLV=null,this.isModified=!0,this.hV=co(l)},this.setByInteger=function(l){var u=new g(String(l),10);this.setByBigInteger(u)},this.setValueHex=function(l){this.hV=l},this.getFreshValueHex=function(){return this.hV},typeof a<"u"&&(typeof a.int<"u"?this.setByInteger(a.int):typeof a=="number"?this.setByInteger(a):typeof a.hex<"u"&&this.setValueHex(a.hex))},Ue(C.asn1.DEREnumerated,C.asn1.ASN1Object),C.asn1.DERUTF8String=function(a){C.asn1.DERUTF8String.superclass.constructor.call(this,a),this.hT="0c"},Ue(C.asn1.DERUTF8String,C.asn1.DERAbstractString),C.asn1.DERNumericString=function(a){C.asn1.DERNumericString.superclass.constructor.call(this,a),this.hT="12"},Ue(C.asn1.DERNumericString,C.asn1.DERAbstractString),C.asn1.DERPrintableString=function(a){C.asn1.DERPrintableString.superclass.constructor.call(this,a),this.hT="13"},Ue(C.asn1.DERPrintableString,C.asn1.DERAbstractString),C.asn1.DERTeletexString=function(a){C.asn1.DERTeletexString.superclass.constructor.call(this,a),this.hT="14"},Ue(C.asn1.DERTeletexString,C.asn1.DERAbstractString),C.asn1.DERIA5String=function(a){C.asn1.DERIA5String.superclass.constructor.call(this,a),this.hT="16"},Ue(C.asn1.DERIA5String,C.asn1.DERAbstractString),C.asn1.DERVisibleString=function(a){C.asn1.DERIA5String.superclass.constructor.call(this,a),this.hT="1a"},Ue(C.asn1.DERVisibleString,C.asn1.DERAbstractString),C.asn1.DERBMPString=function(a){C.asn1.DERBMPString.superclass.constructor.call(this,a),this.hT="1e"},Ue(C.asn1.DERBMPString,C.asn1.DERAbstractString),C.asn1.DERUTCTime=function(a){C.asn1.DERUTCTime.superclass.constructor.call(this,a),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var l=this.params;if(this.params==null&&(l={date:new Date}),typeof l=="string")if(l.match(/^[0-9]{12}Z$/)||l.match(/^[0-9]{12}\.[0-9]+Z$/))this.hV=An(l);else throw new Error("malformed string for UTCTime: "+l);else if(l.str!=null)this.hV=An(l.str);else if(l.date==null&&l.millis==!0){var u=new Date;this.hV=An(this.formatDate(u,"utc",!0))}else if(l.date!=null&&l.date instanceof Date){var f=l.millis===!0;this.hV=An(this.formatDate(l.date,"utc",f))}else l instanceof Date&&(this.hV=An(this.formatDate(l,"utc")));if(this.hV==null)throw new Error("parameter not specified properly for UTCTime");return this.hV},a!=null&&this.setByParam(a)},Ue(C.asn1.DERUTCTime,C.asn1.DERAbstractTime),C.asn1.DERGeneralizedTime=function(a){C.asn1.DERGeneralizedTime.superclass.constructor.call(this,a),this.hT="18",this.params=a,this.getFreshValueHex=function(){var l=this.params;if(this.params==null&&(l={date:new Date}),typeof l=="string")if(l.match(/^[0-9]{14}Z$/)||l.match(/^[0-9]{14}\.[0-9]+Z$/))this.hV=An(l);else throw new Error("malformed string for GeneralizedTime: "+l);else if(l.str!=null)this.hV=An(l.str);else if(l.date==null&&l.millis==!0){var u=new Date;this.hV=An(this.formatDate(u,"gen",!0))}else if(l.date!=null&&l.date instanceof Date){var f=l.millis===!0;this.hV=An(this.formatDate(l.date,"gen",f))}else l instanceof Date&&(this.hV=An(this.formatDate(l,"gen")));if(this.hV==null)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},a!=null&&this.setByParam(a)},Ue(C.asn1.DERGeneralizedTime,C.asn1.DERAbstractTime),C.asn1.DERSequence=function(a){C.asn1.DERSequence.superclass.constructor.call(this,a),this.hT="30",this.getFreshValueHex=function(){for(var l="",u=0;u<this.asn1Array.length;u++){var f=this.asn1Array[u];l+=f.tohex()}return this.hV=l,this.hV}},Ue(C.asn1.DERSequence,C.asn1.DERAbstractStructured),C.asn1.DERSet=function(a){C.asn1.DERSet.superclass.constructor.call(this,a),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var l=new Array,u=0;u<this.asn1Array.length;u++){var f=this.asn1Array[u];l.push(f.tohex())}return this.sortFlag==!0&&l.sort(),this.hV=l.join(""),this.hV},typeof a<"u"&&typeof a.sortflag<"u"&&a.sortflag==!1&&(this.sortFlag=!1)},Ue(C.asn1.DERSet,C.asn1.DERAbstractStructured),C.asn1.DERTaggedObject=function(a){C.asn1.DERTaggedObject.superclass.constructor.call(this);var l=C.asn1,u=Xe,f=u.getV;u.isASN1HEX;var x=l.ASN1Util.newObject;this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(y,F,D){this.params={tag:F,explicit:y,obj:D}},this.getFreshValueHex=function(){var y=this.params;if(y.explicit==null&&(y.explicit=!0),y.tage!=null&&(y.tag=y.tage,y.explicit=!0),y.tagi!=null&&(y.tag=y.tagi,y.explicit=!1),y.str!=null)this.hV=dc(y.str);else if(y.hex!=null)this.hV=y.hex;else if(y.obj!=null){var F;y.obj instanceof l.ASN1Object?F=y.obj.tohex():typeof y.obj=="object"&&(F=x(y.obj).tohex()),y.explicit?this.hV=F:this.hV=f(F,0)}else throw new Error("str, hex nor obj not specified");return y.tag==null&&(y.tag="a0"),this.hT=y.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(y){this.params=y},a!==void 0&&this.setByParam(a)},Ue(C.asn1.DERTaggedObject,C.asn1.ASN1Object);var Xe=new function(){};Xe.getLblen=function(a,l){if(a.substr(l+2,1)!="8")return 1;var u=parseInt(a.substr(l+3,1));return u==0?-1:0<u&&u<10?u+1:-2},Xe.getL=function(a,l){var u=Xe.getLblen(a,l);return u<1?"":a.substr(l+2,u*2)},Xe.getVblen=function(a,l){var u,f;return u=Xe.getL(a,l),u==""?-1:(u.substr(0,1)==="8"?f=new g(u.substr(2),16):f=new g(u,16),f.intValue())},Xe.getVidx=function(a,l){var u=Xe.getLblen(a,l);return u<0?u:l+(u+1)*2},Xe.getV=function(a,l){var u=Xe.getVidx(a,l),f=Xe.getVblen(a,l);return a.substr(u,f*2)},Xe.getTLV=function(a,l){return a.substr(l,2)+Xe.getL(a,l)+Xe.getV(a,l)},Xe.getTLVblen=function(a,l){return 2+Xe.getLblen(a,l)*2+Xe.getVblen(a,l)*2},Xe.getNextSiblingIdx=function(a,l){var u=Xe.getVidx(a,l),f=Xe.getVblen(a,l);return u+f*2},Xe.getChildIdx=function(a,l){var u=Xe,f=[],x,y,F;x=u.getVidx(a,l),y=u.getVblen(a,l)*2,a.substr(l,2)=="03"&&(x+=2,y-=2),F=0;for(var D=x;F<=y;){var V=u.getTLVblen(a,D);if(F+=V,F<=y&&f.push(D),D+=V,F>=y)break}return f},Xe.getNthChildIdx=function(a,l,u){var f=Xe.getChildIdx(a,l);return f[u]},Xe.getIdxbyList=function(a,l,u,f){var x=Xe,y,F;return u.length==0?f!==void 0&&a.substr(l,2)!==f?-1:l:(y=u.shift(),F=x.getChildIdx(a,l),y>=F.length?-1:x.getIdxbyList(a,F[y],u,f))},Xe.getIdxbyListEx=function(a,l,u,f){var x=Xe,y,F;if(u.length==0)return f!==void 0&&a.substr(l,2)!==f?-1:l;y=u.shift(),F=x.getChildIdx(a,l);for(var D=0,V=0;V<F.length;V++){var U=a.substr(F[V],2);if(typeof y=="number"&&!x.isContextTag(U)&&D==y||typeof y=="string"&&x.isContextTag(U,y))return x.getIdxbyListEx(a,F[V],u,f);x.isContextTag(U)||D++}return-1},Xe.getTLVbyList=function(a,l,u,f){var x=Xe,y=x.getIdxbyList(a,l,u,f);return y==-1||y>=a.length?null:x.getTLV(a,y)},Xe.getTLVbyListEx=function(a,l,u,f){var x=Xe,y=x.getIdxbyListEx(a,l,u,f);return y==-1?null:x.getTLV(a,y)},Xe.getVbyList=function(a,l,u,f,x){var y=Xe,F,D;return F=y.getIdxbyList(a,l,u,f),F==-1||F>=a.length?null:(D=y.getV(a,F),x===!0&&(D=D.substr(2)),D)},Xe.getVbyListEx=function(a,l,u,f,x){var y=Xe,F,D;return F=y.getIdxbyListEx(a,l,u,f),F==-1?null:(D=y.getV(a,F),a.substr(F,2)=="03"&&x!==!1&&(D=D.substr(2)),D)},Xe.getInt=function(a,l,u){u==null&&(u=-1);try{var f=a.substr(l,2);if(f!="02"&&f!="03")return u;var x=Xe.getV(a,l);return f=="02"?parseInt(x,16):np(x)}catch{return u}},Xe.getOID=function(a,l,u){u==null&&(u=null);try{if(a.substr(l,2)!="06")return u;var f=Xe.getV(a,l);return gc(f)}catch{return u}},Xe.getOIDName=function(a,l,u){u==null&&(u=null);try{var f=Xe.getOID(a,l,u);if(f==u)return u;var x=C.asn1.x509.OID.oid2name(f);return x==""?f:x}catch{return u}},Xe.getString=function(a,l,u){u==null&&(u=null);try{var f=Xe.getV(a,l);return Dn(f)}catch{return u}},Xe.hextooidstr=function(a){var l=function(G,A){return G.length>=A?G:new Array(A-G.length+1).join("0")+G},u=[],f=a.substr(0,2),x=parseInt(f,16);u[0]=new String(Math.floor(x/40)),u[1]=new String(x%40);for(var y=a.substr(2),F=[],D=0;D<y.length/2;D++)F.push(parseInt(y.substr(D*2,2),16));for(var V=[],U="",D=0;D<F.length;D++)F[D]&128?U=U+l((F[D]&127).toString(2),7):(U=U+l((F[D]&127).toString(2),7),V.push(new String(parseInt(U,2))),U="");var W=u.join(".");return V.length>0&&(W=W+"."+V.join(".")),W},Xe.dump=function(a,l,u,f){var x=Xe,y=x.getV,F=x.dump,D=x.getChildIdx,V=a;a instanceof C.asn1.ASN1Object&&(V=a.tohex());var U=function(Q,re){if(Q.length<=re*2)return Q;var J=Q.substr(0,re)+"..(total "+Q.length/2+"bytes).."+Q.substr(Q.length-re,re);return J};l===void 0&&(l={ommit_long_octet:32}),u===void 0&&(u=0),f===void 0&&(f="");var W=l.ommit_long_octet,ge=V.substr(u,2);if(ge=="01"){var G=y(V,u);return G=="00"?f+`BOOLEAN FALSE
`:f+`BOOLEAN TRUE
`}if(ge=="02"){var G=y(V,u);return f+"INTEGER "+U(G,W)+`
`}if(ge=="03"){var G=y(V,u);if(x.isASN1HEX(G.substr(2))){var A=f+`BITSTRING, encapsulates
`;return A=A+F(G.substr(2),l,0,f+"  "),A}else return f+"BITSTRING "+U(G,W)+`
`}if(ge=="04"){var G=y(V,u);if(x.isASN1HEX(G)){var A=f+`OCTETSTRING, encapsulates
`;return A=A+F(G,l,0,f+"  "),A}else return f+"OCTETSTRING "+U(G,W)+`
`}if(ge=="05")return f+`NULL
`;if(ge=="06"){var B=y(V,u),O=C.asn1.ASN1Util.oidHexToInt(B),H=C.asn1.x509.OID.oid2name(O),q=O.replace(/\./g," ");return H!=""?f+"ObjectIdentifier "+H+" ("+q+`)
`:f+"ObjectIdentifier ("+q+`)
`}if(ge=="0a")return f+"ENUMERATED "+parseInt(y(V,u))+`
`;if(ge=="0c")return f+"UTF8String '"+gi(y(V,u))+`'
`;if(ge=="13")return f+"PrintableString '"+gi(y(V,u))+`'
`;if(ge=="14")return f+"TeletexString '"+gi(y(V,u))+`'
`;if(ge=="16")return f+"IA5String '"+gi(y(V,u))+`'
`;if(ge=="17")return f+"UTCTime "+gi(y(V,u))+`
`;if(ge=="18")return f+"GeneralizedTime "+gi(y(V,u))+`
`;if(ge=="1a")return f+"VisualString '"+gi(y(V,u))+`'
`;if(ge=="1e")return f+"BMPString '"+cd(y(V,u))+`'
`;if(ge=="30"){if(V.substr(u,4)=="3000")return f+`SEQUENCE {}
`;var A=f+`SEQUENCE
`,Z=D(V,u),ce=l;if((Z.length==2||Z.length==3)&&V.substr(Z[0],2)=="06"&&V.substr(Z[Z.length-1],2)=="04"){var H=x.oidname(y(V,Z[0])),fe=JSON.parse(JSON.stringify(l));fe.x509ExtName=H,ce=fe}for(var pe=0;pe<Z.length;pe++)A=A+F(V,ce,Z[pe],f+"  ");return A}if(ge=="31"){for(var A=f+`SET
`,Z=D(V,u),pe=0;pe<Z.length;pe++)A=A+F(V,l,Z[pe],f+"  ");return A}var ge=parseInt(ge,16);if((ge&128)!=0){var Y=ge&31;if((ge&32)!=0){for(var A=f+"["+Y+`]
`,Z=D(V,u),pe=0;pe<Z.length;pe++)A=A+F(V,l,Z[pe],f+"  ");return A}else{var G=y(V,u);if(Xe.isASN1HEX(G)){var A=f+"["+Y+`]
`;return A=A+F(G,l,0,f+"  "),A}else(G.substr(0,8)=="68747470"||l.x509ExtName==="subjectAltName"&&Y==2)&&(G=gi(G));var A=f+"["+Y+"] "+G+`
`;return A}}return f+"UNKNOWN("+ge+") "+y(V,u)+`
`},Xe.parse=function(a){var l=Xe,u=l.parse,f=l.isASN1HEX,x=l.getV,y=l.getTLV,F=l.getChildIdx,D=C.asn1,V=D.ASN1Util.oidHexToInt,U=D.x509.OID.oid2name,W=gi,G=cd,A=P_,B={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},O=function(J){for(var oe=[],me=F(J,0),ye=0;ye<me.length;ye++){var Be=me[ye],be=y(J,Be),Te=u(be);oe.push(Te)}return oe},H=a.substr(0,2),q={},Z=x(a,0);if(H=="01")return a=="0101ff"?{bool:!0}:{bool:!1};if(H=="02")return{int:{hex:Z}};if(H=="03")try{if(Z.substr(0,2)!="00")throw"not encap";var ce=Z.substr(2);if(!f(ce))throw"not encap";return{bitstr:{obj:u(ce)}}}catch{var fe=null;return Z.length<=10&&(fe=sp(Z)),fe==null?{bitstr:{hex:Z}}:{bitstr:{bin:fe}}}else if(H=="04")try{if(!f(Z))throw"not encap";return{octstr:{obj:u(Z)}}}catch{return{octstr:{hex:Z}}}else{if(H=="05")return{null:""};if(H=="06"){var pe=V(Z),ge=U(pe);return ge==""?{oid:pe}:{oid:ge}}else{if(H=="0a")return Z.length>4?{enum:{hex:Z}}:{enum:parseInt(Z,16)};if(H=="30"||H=="31")return q[B[H]]=O(a),q;if(H=="14"){var Y=A(Z);return q[B[H]]={str:Y},q}else if(H=="1e"){var Y=G(Z);return q[B[H]]={str:Y},q}else if(":0c:12:13:16:17:18:1a:".indexOf(H)!=-1){var Y=W(Z);return q[B[H]]={str:Y},q}else if(H.match(/^8[0-9]$/)){var Y=W(Z);return Y==null|Y==""?{tag:{tag:H,explicit:!1,hex:Z}}:Y.match(/[\x00-\x1F\x7F-\x9F]/)!=null||Y.match(/[\u0000-\u001F\u0080\u009F]/)!=null?{tag:{tag:H,explicit:!1,hex:Z}}:{tag:{tag:H,explicit:!1,str:Y}}}else if(H.match(/^a[0-9]$/))try{if(!f(Z))throw new Error("not encap");return{tag:{tag:H,explicit:!0,obj:u(Z)}}}catch{return{tag:{tag:H,explicit:!0,hex:Z}}}else{var Q=new C.asn1.ASN1Object;Q.hV=Z;var re=Q.getLengthHexFromValue();return{asn1:{tlv:H+re+Z}}}}}},Xe.isContextTag=function(a,l){a=a.toLowerCase();var u,f;try{u=parseInt(a,16)}catch{return-1}if(l===void 0)return(u&192)==128;try{var x=l.match(/^\[[0-9]+\]$/);return x==null||(f=parseInt(l.substr(1,l.length-1),10),f>31)?!1:(u&192)==128&&(u&31)==f}catch{return!1}},Xe.isASN1HEX=function(a){var l=Xe;if(a.length%2==1)return!1;var u=l.getVblen(a,0),f=a.substr(0,2),x=l.getL(a,0),y=a.length-f.length-x.length;return y==u*2},Xe.checkStrictDER=function(a,l,u,f,x){var y=Xe;if(u===void 0){if(typeof a!="string")throw new Error("not hex string");if(a=a.toLowerCase(),!C.lang.String.isHex(a))throw new Error("not hex string");u=a.length,f=a.length/2,f<128?x=1:x=Math.ceil(f.toString(16))+1}var F=y.getL(a,l);if(F.length>x*2)throw new Error("L of TLV too long: idx="+l);var D=y.getVblen(a,l);if(D>f)throw new Error("value of L too long than hex: idx="+l);var V=y.getTLV(a,l),U=V.length-2-y.getL(a,l).length;if(U!==D*2)throw new Error("V string length and L's value not the same:"+U+"/"+D*2);if(l===0&&a.length!=V.length)throw new Error("total length and TLV length unmatch:"+a.length+"!="+V.length);var W=a.substr(l,2);if(W==="02"){var G=y.getVidx(a,l);if(a.substr(G,2)=="00"&&a.charCodeAt(G+2)<56)throw new Error("not least zeros for DER INTEGER")}if(parseInt(W,16)&32){for(var A=y.getVblen(a,l),B=0,O=y.getChildIdx(a,l),H=0;H<O.length;H++){var q=y.getTLV(a,O[H]);B+=q.length,y.checkStrictDER(a,O[H],u,f,x)}if(A*2!=B)throw new Error("sum of children's TLV length and L unmatch: "+A*2+"!="+B)}},Xe.oidname=function(a){var l=C.asn1;C.lang.String.isHex(a)&&(a=l.ASN1Util.oidHexToInt(a));var u=l.x509.OID.oid2name(a);return u===""&&(u=a),u},(typeof C>"u"||!C)&&(C={}),(typeof C.asn1>"u"||!C.asn1)&&(C.asn1={}),(typeof C.asn1.x509>"u"||!C.asn1.x509)&&(C.asn1.x509={}),C.asn1.x509.Certificate=function(a){C.asn1.x509.Certificate.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERBitString,x=u.DERSequence,y=u.x509,F=y.TBSCertificate,D=y.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(V){this.params=V},this.sign=function(){var V=this.params,U=V.sigalg;V.sigalg.name!=null&&(U=V.sigalg.name);var W=V.tbsobj.tohex(),G=new C.crypto.Signature({alg:U});G.init(V.cakey),G.updateHex(W),V.sighex=G.sign()},this.getPEM=function(){return hn(this.tohex(),"CERTIFICATE")},this.tohex=function(){var V=this.params;if((V.tbsobj==null||V.tbsobj==null)&&(V.tbsobj=new F(V)),V.sighex==null&&V.cakey!=null&&this.sign(),V.sighex==null)throw new Error("sighex or cakey parameter not defined");var U=[];U.push(V.tbsobj),U.push(new D({name:V.sigalg})),U.push(new f({hex:"00"+V.sighex}));var W=new x({array:U});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&(this.params=a)},Ue(C.asn1.x509.Certificate,C.asn1.ASN1Object),C.asn1.x509.TBSCertificate=function(a){C.asn1.x509.TBSCertificate.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.x509,x=u.DERTaggedObject,y=u.DERInteger,F=u.DERSequence,D=f.AlgorithmIdentifier,V=f.Time,U=f.X500Name,W=f.Extensions,G=f.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(A){this.params=A},this.tohex=function(){var A=[],B=this.params;if(B.version!=null||B.version!=1){var O=2;B.version!=null&&(O=B.version-1);var H=new x({obj:new y({int:O})});A.push(H)}A.push(new y(B.serial)),A.push(new D({name:B.sigalg})),A.push(new U(B.issuer)),A.push(new F({array:[new V(B.notbefore),new V(B.notafter)]})),A.push(new U(B.subject)),A.push(new G(Yt.getKey(B.sbjpubkey))),B.ext!==void 0&&B.ext.length>0&&A.push(new x({tag:"a3",obj:new W(B.ext)}));var q=new C.asn1.DERSequence({array:A});return q.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.TBSCertificate,C.asn1.ASN1Object),C.asn1.x509.Extensions=function(a){C.asn1.x509.Extensions.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERSequence,x=u.x509;this.aParam=[],this.setByParam=function(y){this.aParam=y},this.tohex=function(){for(var y=[],F=0;F<this.aParam.length;F++){var D=this.aParam[F],V=D.extname,U=null;if(D.extn!=null)U=new x.PrivateExtension(D);else if(V=="subjectKeyIdentifier")U=new x.SubjectKeyIdentifier(D);else if(V=="keyUsage")U=new x.KeyUsage(D);else if(V=="subjectAltName")U=new x.SubjectAltName(D);else if(V=="issuerAltName")U=new x.IssuerAltName(D);else if(V=="basicConstraints")U=new x.BasicConstraints(D);else if(V=="nameConstraints")U=new x.NameConstraints(D);else if(V=="cRLDistributionPoints")U=new x.CRLDistributionPoints(D);else if(V=="certificatePolicies")U=new x.CertificatePolicies(D);else if(V=="policyMappings")U=new x.PolicyMappings(D);else if(V=="policyConstraints")U=new x.PolicyConstraints(D);else if(V=="inhibitAnyPolicy")U=new x.InhibitAnyPolicy(D);else if(V=="authorityKeyIdentifier")U=new x.AuthorityKeyIdentifier(D);else if(V=="extKeyUsage")U=new x.ExtKeyUsage(D);else if(V=="authorityInfoAccess")U=new x.AuthorityInfoAccess(D);else if(V=="cRLNumber")U=new x.CRLNumber(D);else if(V=="cRLReason")U=new x.CRLReason(D);else if(V=="ocspNonce")U=new x.OCSPNonce(D);else if(V=="ocspNoCheck")U=new x.OCSPNoCheck(D);else if(V=="adobeTimeStamp")U=new x.AdobeTimeStamp(D);else if(V=="subjectDirectoryAttributes")U=new x.SubjectDirectoryAttributes(D);else throw new Error("extension not supported:"+JSON.stringify(D));U!=null&&y.push(U)}var W=new f({array:y});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.x509.Extensions,C.asn1.ASN1Object),C.asn1.x509.Extension=function(a){C.asn1.x509.Extension.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERObjectIdentifier,x=u.DEROctetString;u.DERBitString;var y=u.DERBoolean,F=u.DERSequence;this.tohex=function(){var D=new f({oid:this.oid}),V=new x({hex:this.getExtnValueHex()}),U=new Array;U.push(D),this.critical&&U.push(new y),U.push(V);var W=new F({array:U});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,a!==void 0&&a.critical!==void 0&&(this.critical=a.critical)},Ue(C.asn1.x509.Extension,C.asn1.ASN1Object),C.asn1.x509.KeyUsage=function(a){C.asn1.x509.KeyUsage.superclass.constructor.call(this,a);var l=Error,u={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var f=this.getBinValue();return this.asn1ExtnValue=new C.asn1.DERBitString({bin:f}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var f=this.params;if(typeof f!="object"||typeof f.names!="object"&&typeof f.bin!="string")throw new l("parameter not yet set");if(f.names!=null)return _c(f.names,u);if(f.bin!=null)return f.bin;throw new l("parameter not set properly")},this.oid="2.5.29.15",a!==void 0&&(this.params=a)},Ue(C.asn1.x509.KeyUsage,C.asn1.x509.Extension),C.asn1.x509.BasicConstraints=function(a){C.asn1.x509.BasicConstraints.superclass.constructor.call(this,a);var l=C.asn1,u=l.DERBoolean,f=l.DERInteger,x=l.DERSequence;this.getExtnValueHex=function(){var y=new Array;this.cA&&y.push(new u),this.pathLen>-1&&y.push(new f({int:this.pathLen}));var F=new x({array:y});return this.asn1ExtnValue=F,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,a!==void 0&&(a.cA!==void 0&&(this.cA=a.cA),a.pathLen!==void 0&&(this.pathLen=a.pathLen))},Ue(C.asn1.x509.BasicConstraints,C.asn1.x509.Extension),C.asn1.x509.CRLDistributionPoints=function(a){C.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,a);var l=C,u=l.asn1,f=u.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(x){for(var y=[],F=0;F<x.length;F++)if(x[F]instanceof C.asn1.ASN1Object)y.push(x[F]);else{var D=new f.DistributionPoint(x[F]);y.push(D)}this.asn1ExtnValue=new u.DERSequence({array:y})},this.setByOneURI=function(x){var y=new f.DistributionPoint({fulluri:x});this.setByDPArray([y])},this.oid="2.5.29.31",a!==void 0&&(a.array!==void 0?this.setByDPArray(a.array):a.uri!==void 0&&this.setByOneURI(a.uri))},Ue(C.asn1.x509.CRLDistributionPoints,C.asn1.x509.Extension),C.asn1.x509.DistributionPoint=function(a){C.asn1.x509.DistributionPoint.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.x509.DistributionPointName;this.tohex=function(){var x=new u.DERSequence;if(this.asn1DP!=null){var y=new u.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});x.appendASN1Object(y)}return this.hTLV=x.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&(a.dpobj!==void 0?this.asn1DP=a.dpobj:a.dpname!==void 0?this.asn1DP=new f(a.dpname):a.fulluri!==void 0&&(this.asn1DP=new f({full:[{uri:a.fulluri}]})))},Ue(C.asn1.x509.DistributionPoint,C.asn1.ASN1Object),C.asn1.x509.DistributionPointName=function(a){C.asn1.x509.DistributionPointName.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERTaggedObject;if(this.tohex=function(){if(this.type!="full")throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new f({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0)if(u.x509.GeneralNames.prototype.isPrototypeOf(a))this.type="full",this.tag="a0",this.asn1V=a;else if(a.full!==void 0)this.type="full",this.tag="a0",this.asn1V=new u.x509.GeneralNames(a.full);else throw new Error("This class supports GeneralNames only as argument")},Ue(C.asn1.x509.DistributionPointName,C.asn1.ASN1Object),C.asn1.x509.CertificatePolicies=function(a){C.asn1.x509.CertificatePolicies.superclass.constructor.call(this,a);var l=C,u=l.asn1,f=u.x509,x=u.DERSequence,y=f.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var F=[],D=0;D<this.params.array.length;D++)F.push(new y(this.params.array[D]));var V=new x({array:F});return this.asn1ExtnValue=V,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",a!==void 0&&(this.params=a)},Ue(C.asn1.x509.CertificatePolicies,C.asn1.x509.Extension),C.asn1.x509.PolicyInformation=function(a){C.asn1.x509.PolicyInformation.superclass.constructor.call(this,a);var l=C.asn1,u=l.DERSequence,f=l.DERObjectIdentifier,x=l.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(this.params.policyoid===void 0&&this.params.array===void 0)throw new Error("parameter oid and array missing");var y=[new f(this.params.policyoid)];if(this.params.array!==void 0){for(var F=[],D=0;D<this.params.array.length;D++)F.push(new x(this.params.array[D]));F.length>0&&y.push(new u({array:F}))}var V=new u({array:y});return V.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&(this.params=a)},Ue(C.asn1.x509.PolicyInformation,C.asn1.ASN1Object),C.asn1.x509.PolicyQualifierInfo=function(a){C.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,a);var l=C.asn1,u=l.DERSequence,f=l.DERIA5String,x=l.DERObjectIdentifier,y=l.x509.UserNotice;this.params=null,this.tohex=function(){if(this.params.cps!==void 0){var F=new u({array:[new x({oid:"1.3.6.1.5.5.7.2.1"}),new f({str:this.params.cps})]});return F.tohex()}if(this.params.unotice!=null){var F=new u({array:[new x({oid:"1.3.6.1.5.5.7.2.2"}),new y(this.params.unotice)]});return F.tohex()}},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&(this.params=a)},Ue(C.asn1.x509.PolicyQualifierInfo,C.asn1.ASN1Object),C.asn1.x509.UserNotice=function(a){C.asn1.x509.UserNotice.superclass.constructor.call(this,a);var l=C.asn1.DERSequence;C.asn1.DERInteger;var u=C.asn1.x509.DisplayText,f=C.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var x=[];this.params.noticeref!==void 0&&x.push(new f(this.params.noticeref)),this.params.exptext!==void 0&&x.push(new u(this.params.exptext));var y=new l({array:x});return y.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&(this.params=a)},Ue(C.asn1.x509.UserNotice,C.asn1.ASN1Object),C.asn1.x509.NoticeReference=function(a){C.asn1.x509.NoticeReference.superclass.constructor.call(this,a);var l=C.asn1.DERSequence,u=C.asn1.DERInteger,f=C.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var x=[];if(this.params.org!==void 0&&x.push(new f(this.params.org)),this.params.noticenum!==void 0){for(var y=[],F=this.params.noticenum,D=0;D<F.length;D++)y.push(new u(F[D]));x.push(new l({array:y}))}if(x.length==0)throw new Error("parameter is empty");var V=new l({array:x});return V.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&(this.params=a)},Ue(C.asn1.x509.NoticeReference,C.asn1.ASN1Object),C.asn1.x509.DisplayText=function(a){C.asn1.x509.DisplayText.superclass.constructor.call(this,a),this.hT="0c",a!==void 0&&(a.type==="ia5"?this.hT="16":a.type==="vis"?this.hT="1a":a.type==="bmp"&&(this.hT="1e"))},Ue(C.asn1.x509.DisplayText,C.asn1.DERAbstractString),C.asn1.x509.PolicyMappings=function(a){C.asn1.x509.PolicyMappings.superclass.constructor.call(this,a);var l=C,u=l.asn1;u.x509;var f=u.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){for(var x=this.params,y=[],F=0;F<x.array.length;F++){var D=x.array[F];y.push({seq:[{oid:D[0]},{oid:D[1]}]})}return this.asn1ExtnValue=f({seq:y}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.33",a!==void 0&&(this.params=a)},Ue(C.asn1.x509.PolicyMappings,C.asn1.x509.Extension),C.asn1.x509.PolicyConstraints=function(a){C.asn1.x509.PolicyConstraints.superclass.constructor.call(this,a);var l=C,u=l.asn1;u.x509;var f=u.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){var x=this.params,y=[];return x.reqexp!=null&&y.push({tag:{tagi:"80",obj:{int:x.reqexp}}}),x.inhibit!=null&&y.push({tag:{tagi:"81",obj:{int:x.inhibit}}}),this.asn1ExtnValue=f({seq:y}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.36",a!==void 0&&(this.params=a)},Ue(C.asn1.x509.PolicyConstraints,C.asn1.x509.Extension),C.asn1.x509.InhibitAnyPolicy=function(a){C.asn1.x509.InhibitAnyPolicy.superclass.constructor.call(this,a);var l=C,u=l.asn1;u.x509;var f=u.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=f({int:this.params.skip}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.54",a!==void 0&&(this.params=a)},Ue(C.asn1.x509.InhibitAnyPolicy,C.asn1.x509.Extension),C.asn1.x509.NameConstraints=function(a){C.asn1.x509.NameConstraints.superclass.constructor.call(this,a);var l=C,u=l.asn1,f=u.x509,x=u.ASN1Util.newObject,y=f.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var F=this.params,D=[];if(F.permit!=null&&F.permit.length!=null){for(var V=[],U=0;U<F.permit.length;U++)V.push(new y(F.permit[U]));D.push({tag:{tagi:"a0",obj:{seq:V}}})}if(F.exclude!=null&&F.exclude.length!=null){for(var W=[],U=0;U<F.exclude.length;U++)W.push(new y(F.exclude[U]));D.push({tag:{tagi:"a1",obj:{seq:W}}})}return this.asn1ExtnValue=x({seq:D}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",a!==void 0&&(this.params=a)},Ue(C.asn1.x509.NameConstraints,C.asn1.x509.Extension),C.asn1.x509.GeneralSubtree=function(a){C.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var l=C.asn1,u=l.x509,f=u.GeneralName,x=l.ASN1Util.newObject;this.params=null,this.setByParam=function(y){this.params=y},this.tohex=function(){var y=this.params,F=[new f(y)];y.min!=null&&F.push({tag:{tagi:"80",obj:{int:y.min}}}),y.max!=null&&F.push({tag:{tagi:"81",obj:{int:y.max}}});var D=x({seq:F});return D.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.GeneralSubtree,C.asn1.ASN1Object),C.asn1.x509.ExtKeyUsage=function(a){C.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,a);var l=C,u=l.asn1;this.setPurposeArray=function(f){this.asn1ExtnValue=new u.DERSequence;for(var x=0;x<f.length;x++){var y=new u.DERObjectIdentifier(f[x]);this.asn1ExtnValue.appendASN1Object(y)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",a!==void 0&&a.array!==void 0&&this.setPurposeArray(a.array)},Ue(C.asn1.x509.ExtKeyUsage,C.asn1.x509.Extension),C.asn1.x509.AuthorityKeyIdentifier=function(a){C.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,a);var l=C,u=l.asn1,f=u.DERTaggedObject,x=u.x509.GeneralNames;l.crypto.Util.isKey,this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var y=new Array;this.asn1KID&&y.push(new f({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&y.push(new f({explicit:!1,tag:"a1",obj:new x([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&y.push(new f({explicit:!1,tag:"82",obj:this.asn1CertSN}));var F=new u.DERSequence({array:y});return this.asn1ExtnValue=F,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(y){if(y.str!==void 0||y.hex!==void 0)this.asn1KID=new C.asn1.DEROctetString(y);else if(typeof y=="object"&&C.crypto.Util.isKey(y)||typeof y=="string"&&y.indexOf("BEGIN ")!=-1){var F=y;typeof y=="string"&&(F=Yt.getKey(y));var D=Yt.getKeyID(F);this.asn1KID=new C.asn1.DEROctetString({hex:D})}},this.setCertIssuerByParam=function(y){y.str!==void 0||y.ldapstr!==void 0||y.hex!==void 0||y.certsubject!==void 0||y.certissuer!==void 0?this.asn1CertIssuer=new C.asn1.x509.X500Name(y):typeof y=="string"&&y.indexOf("BEGIN ")!=-1&&y.indexOf("CERTIFICATE")!=-1&&(this.asn1CertIssuer=new C.asn1.x509.X500Name({certissuer:y}))},this.setCertSNByParam=function(y){if(y.str!==void 0||y.bigint!==void 0||y.hex!==void 0)this.asn1CertSN=new C.asn1.DERInteger(y);else if(typeof y=="string"&&y.indexOf("BEGIN ")!=-1&&y.indexOf("CERTIFICATE")){var F=new At;F.readCertPEM(y);var D=F.getSerialNumberHex();this.asn1CertSN=new C.asn1.DERInteger({hex:D})}},this.oid="2.5.29.35",a!==void 0&&(a.kid!==void 0&&this.setKIDByParam(a.kid),a.issuer!==void 0&&this.setCertIssuerByParam(a.issuer),a.sn!==void 0&&this.setCertSNByParam(a.sn),a.issuersn!==void 0&&typeof a.issuersn=="string"&&a.issuersn.indexOf("BEGIN ")!=-1&&a.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(a.issuersn),this.setCertIssuerByParam(a.issuersn)))},Ue(C.asn1.x509.AuthorityKeyIdentifier,C.asn1.x509.Extension),C.asn1.x509.SubjectKeyIdentifier=function(a){C.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,a);var l=C,u=l.asn1,f=u.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(x){if(x.str!==void 0||x.hex!==void 0)this.asn1KID=new f(x);else if(typeof x=="object"&&C.crypto.Util.isKey(x)||typeof x=="string"&&x.indexOf("BEGIN")!=-1){var y=x;typeof x=="string"&&(y=Yt.getKey(x));var F=Yt.getKeyID(y);this.asn1KID=new C.asn1.DEROctetString({hex:F})}},this.oid="2.5.29.14",a!==void 0&&a.kid!==void 0&&this.setKIDByParam(a.kid)},Ue(C.asn1.x509.SubjectKeyIdentifier,C.asn1.x509.Extension),C.asn1.x509.AuthorityInfoAccess=function(a){C.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,a),this.setAccessDescriptionArray=function(l){for(var u=new Array,f=C,x=f.asn1,y=x.DERSequence,F=x.DERObjectIdentifier,D=x.x509.GeneralName,V=0;V<l.length;V++){var U,W=l[V];if(W.ocsp!==void 0)U=new y({array:[new F({oid:"1.3.6.1.5.5.7.48.1"}),new D({uri:W.ocsp})]});else if(W.caissuer!==void 0)U=new y({array:[new F({oid:"1.3.6.1.5.5.7.48.2"}),new D({uri:W.caissuer})]});else throw new Error("unknown AccessMethod parameter: "+JSON.stringify(W));u.push(U)}this.asn1ExtnValue=new y({array:u})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",a!==void 0&&a.array!==void 0&&this.setAccessDescriptionArray(a.array)},Ue(C.asn1.x509.AuthorityInfoAccess,C.asn1.x509.Extension),C.asn1.x509.SubjectAltName=function(a){C.asn1.x509.SubjectAltName.superclass.constructor.call(this,a),this.setNameArray=function(l){this.asn1ExtnValue=new C.asn1.x509.GeneralNames(l)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",a!==void 0&&a.array!==void 0&&this.setNameArray(a.array)},Ue(C.asn1.x509.SubjectAltName,C.asn1.x509.Extension),C.asn1.x509.IssuerAltName=function(a){C.asn1.x509.IssuerAltName.superclass.constructor.call(this,a),this.setNameArray=function(l){this.asn1ExtnValue=new C.asn1.x509.GeneralNames(l)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",a!==void 0&&a.array!==void 0&&this.setNameArray(a.array)},Ue(C.asn1.x509.IssuerAltName,C.asn1.x509.Extension),C.asn1.x509.SubjectDirectoryAttributes=function(a){C.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,a);var l=C.asn1,u=l.DERSequence,f=l.ASN1Util.newObject,x=l.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var y=[],F=0;F<this.params.array.length;F++){var D=this.params.array[F];if(D.attr!=null&&D.array!=null){var V={seq:[{oid:D.attr},{set:D.array}]};y.push(f(V));continue}var U={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if(D.attr=="dateOfBirth")U.seq[0].oid=x(D.attr),U.seq[1].set[0]={gentime:D.str};else if(D.attr=="placeOfBirth")U.seq[0].oid=x(D.attr),U.seq[1].set[0]={utf8str:D.str};else if(D.attr=="gender")U.seq[0].oid=x(D.attr),U.seq[1].set[0]={prnstr:D.str};else if(D.attr=="countryOfCitizenship")U.seq[0].oid=x(D.attr),U.seq[1].set[0]={prnstr:D.str};else if(D.attr=="countryOfResidence")U.seq[0].oid=x(D.attr),U.seq[1].set[0]={prnstr:D.str};else throw new Error("unsupported attribute: "+D.attr);y.push(new f(U))}var W=new u({array:y});return this.asn1ExtnValue=W,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",a!==void 0&&(this.params=a)},Ue(C.asn1.x509.SubjectDirectoryAttributes,C.asn1.x509.Extension),C.asn1.x509.PrivateExtension=function(a){C.asn1.x509.PrivateExtension.superclass.constructor.call(this,a);var l=C,u=l.lang.String.isHex,f=l.asn1,x=f.x509.OID.name2oid,y=f.ASN1Util.newObject;this.params=null,this.setByParam=function(F){this.oid=x(F.extname),this.params=F},this.getExtnValueHex=function(){if(this.params.extname==null||this.params.extn==null)throw new Error("extname or extnhex not specified");var F=this.params.extn;if(typeof F=="string"&&u(F))return F;if(typeof F=="object")try{return y(F).tohex()}catch{}throw new Error("unsupported extn value")},a!=null&&this.setByParam(a)},Ue(C.asn1.x509.PrivateExtension,C.asn1.x509.Extension),C.asn1.x509.CRL=function(a){C.asn1.x509.CRL.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERSequence,x=u.DERBitString,y=u.x509,F=y.AlgorithmIdentifier,D=y.TBSCertList;this.params=void 0,this.setByParam=function(V){this.params=V},this.sign=function(){var V=new D(this.params).tohex(),U=new C.crypto.Signature({alg:this.params.sigalg});U.init(this.params.cakey),U.updateHex(V);var W=U.sign();this.params.sighex=W},this.getPEM=function(){return hn(this.tohex(),"X509 CRL")},this.tohex=function(){var V=this.params;if(V.tbsobj==null&&(V.tbsobj=new D(V)),V.sighex==null&&V.cakey!=null&&this.sign(),V.sighex==null)throw new Error("sighex or cakey parameter not defined");var U=[];U.push(V.tbsobj),U.push(new F({name:V.sigalg})),U.push(new x({hex:"00"+V.sighex}));var W=new f({array:U});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&(this.params=a)},Ue(C.asn1.x509.CRL,C.asn1.ASN1Object),C.asn1.x509.TBSCertList=function(a){C.asn1.x509.TBSCertList.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERInteger,x=u.DERSequence,y=u.DERTaggedObject;u.DERObjectIdentifier;var F=u.x509,D=F.AlgorithmIdentifier,V=F.Time,U=F.Extensions,W=F.X500Name;this.params=null,this.setByParam=function(G){this.params=G},this.getRevCertSequence=function(){for(var G=[],A=this.params.revcert,B=0;B<A.length;B++){var O=[new f(A[B].sn),new V(A[B].date)];A[B].ext!=null&&O.push(new U(A[B].ext)),G.push(new x({array:O}))}return new x({array:G})},this.tohex=function(){var G=[],A=this.params;if(A.version!=null){var B=A.version-1,O=new f({int:B});G.push(O)}if(G.push(new D({name:A.sigalg})),G.push(new W(A.issuer)),G.push(new V(A.thisupdate)),A.nextupdate!=null&&G.push(new V(A.nextupdate)),A.revcert!=null&&G.push(this.getRevCertSequence()),A.ext!=null){var H=new U(A.ext);G.push(new y({tag:"a0",explicit:!0,obj:H}))}var q=new x({array:G});return q.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.TBSCertList,C.asn1.ASN1Object),C.asn1.x509.CRLEntry=function(a){C.asn1.x509.CRLEntry.superclass.constructor.call(this);var l=C,u=l.asn1;this.setCertSerial=function(f){this.sn=new u.DERInteger(f)},this.setRevocationDate=function(f){this.time=new u.x509.Time(f)},this.tohex=function(){var f=new u.DERSequence({array:[this.sn,this.time]});return this.TLV=f.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&(a.time!==void 0&&this.setRevocationDate(a.time),a.sn!==void 0&&this.setCertSerial(a.sn))},Ue(C.asn1.x509.CRLEntry,C.asn1.ASN1Object),C.asn1.x509.CRLNumber=function(a){C.asn1.x509.CRLNumber.superclass.constructor.call(this,a),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new C.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",a!=null&&(this.params=a)},Ue(C.asn1.x509.CRLNumber,C.asn1.x509.Extension),C.asn1.x509.CRLReason=function(a){C.asn1.x509.CRLReason.superclass.constructor.call(this,a),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new C.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",a!=null&&(this.params=a)},Ue(C.asn1.x509.CRLReason,C.asn1.x509.Extension),C.asn1.x509.OCSPNonce=function(a){C.asn1.x509.OCSPNonce.superclass.constructor.call(this,a),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new C.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",a!=null&&(this.params=a)},Ue(C.asn1.x509.OCSPNonce,C.asn1.x509.Extension),C.asn1.x509.OCSPNoCheck=function(a){C.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,a),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new C.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",a!=null&&(this.params=a)},Ue(C.asn1.x509.OCSPNoCheck,C.asn1.x509.Extension),C.asn1.x509.AdobeTimeStamp=function(a){C.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,a);var l=C,u=l.asn1,f=u.DERInteger,x=u.DERBoolean,y=u.DERSequence,F=u.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var D=this.params,V=[new f(1)];return V.push(new F({uri:D.uri})),D.reqauth!=null&&V.push(new x(D.reqauth)),this.asn1ExtnValue=new y({array:V}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.AdobeTimeStamp,C.asn1.x509.Extension),C.asn1.x509.X500Name=function(a){C.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var l=C,u=l.asn1,f=u.x509,x=f.RDN;this.setByString=function(y,F){F!==void 0&&(this.sRule=F);var D=y.split("/");D.shift();for(var V=[],U=0;U<D.length;U++)if(D[U].match(/^[^=]+=.+$/))V.push(D[U]);else{var W=V.length-1;V[W]=V[W]+"/"+D[U]}for(var U=0;U<V.length;U++)this.asn1Array.push(new x({str:V[U],rule:this.sRule}))},this.setByLdapString=function(y,F){F!==void 0&&(this.sRule=F);var D=f.X500Name.ldapToCompat(y);this.setByString(D,F)},this.setByObject=function(y,F){F!==void 0&&(this.sRule=F);for(var D in y)if(y.hasOwnProperty(D)){var V=new x({str:D+"="+y[D],rule:this.sRule});this.asn1Array?this.asn1Array.push(V):this.asn1Array=[V]}},this.setByParam=function(y){if(y.rule!==void 0&&(this.sRule=y.rule),y.array!==void 0)this.paramArray=y.array;else if(y.str!==void 0)this.setByString(y.str);else if(y.ldapstr!==void 0)this.setByLdapString(y.ldapstr);else if(y.hex!==void 0)this.hTLV=y.hex;else if(y.certissuer!==void 0){var F=new At;F.readCertPEM(y.certissuer),this.hTLV=F.getIssuerHex()}else if(y.certsubject!==void 0){var F=new At;F.readCertPEM(y.certsubject),this.hTLV=F.getSubjectHex()}else typeof y=="object"&&y.certsubject===void 0&&y.certissuer===void 0&&this.setByObject(y)},this.tohex=function(){if(typeof this.hTLV=="string")return this.hTLV;if(this.asn1Array.length==0&&this.paramArray.length>0)for(var y=0;y<this.paramArray.length;y++){var F={array:this.paramArray[y]};this.sRule!="utf8"&&(F.rule=this.sRule);var D=new x(F);this.asn1Array.push(D)}var V=new u.DERSequence({array:this.asn1Array});return this.hTLV=V.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.X500Name,C.asn1.ASN1Object),C.asn1.x509.X500Name.compatToLDAP=function(a){if(a.substr(0,1)!=="/")throw"malformed input";a=a.substr(1);var l=a.split("/");return l.reverse(),l=l.map(function(u){return u.replace(/,/,"\\,")}),l.join(",")},C.asn1.x509.X500Name.onelineToLDAP=function(a){return C.asn1.x509.X500Name.compatToLDAP(a)},C.asn1.x509.X500Name.ldapToCompat=function(a){for(var l=a.split(","),u=!1,f=[],x=0;l.length>0;x++){var y=l.shift();if(u===!0){var F=f.pop(),D=(F+","+y).replace(/\\,/g,",");f.push(D),u=!1}else f.push(y);y.substr(-1,1)==="\\"&&(u=!0)}return f=f.map(function(V){return V.replace("/","\\/")}),f.reverse(),"/"+f.join("/")},C.asn1.x509.X500Name.ldapToOneline=function(a){return C.asn1.x509.X500Name.ldapToCompat(a)},C.asn1.x509.RDN=function(a){C.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var l=C.asn1.x509.AttributeTypeAndValue;this.setByParam=function(u){u.rule!==void 0&&(this.sRule=u.rule),u.str!==void 0&&this.addByMultiValuedString(u.str),u.array!==void 0&&(this.paramArray=u.array)},this.addByString=function(u){this.asn1Array.push(new C.asn1.x509.AttributeTypeAndValue({str:u,rule:this.sRule}))},this.addByMultiValuedString=function(u){for(var f=C.asn1.x509.RDN.parseString(u),x=0;x<f.length;x++)this.addByString(f[x])},this.tohex=function(){if(this.asn1Array.length==0&&this.paramArray.length>0)for(var u=0;u<this.paramArray.length;u++){var f=this.paramArray[u];f.rule!==void 0&&this.sRule!="utf8"&&(f.rule=this.sRule);var x=new l(f);this.asn1Array.push(x)}var y=new C.asn1.DERSet({array:this.asn1Array});return this.TLV=y.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.RDN,C.asn1.ASN1Object),C.asn1.x509.RDN.parseString=function(a){for(var l=a.split(/\+/),u=!1,f=[],x=0;l.length>0;x++){var y=l.shift();if(u===!0){var F=f.pop(),D=(F+"+"+y).replace(/\\\+/g,"+");f.push(D),u=!1}else f.push(y);y.substr(-1,1)==="\\"&&(u=!0)}for(var V=!1,U=[],x=0;f.length>0;x++){var y=f.shift();if(V===!0){var W=U.pop();if(y.match(/"$/)){var D=(W+"+"+y).replace(/^([^=]+)="(.*)"$/,"$1=$2");U.push(D),V=!1}else U.push(W+"+"+y)}else U.push(y);y.match(/^[^=]+="/)&&(V=!0)}return U},C.asn1.x509.AttributeTypeAndValue=function(a){C.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var l=C,u=l.asn1,f=u.DERSequence,x=u.DERUTF8String,y=u.DERPrintableString,F=u.DERTeletexString,D=u.DERIA5String,V=u.DERVisibleString,U=u.DERBMPString,W=l.lang.String.isMail,G=l.lang.String.isPrintable;this.setByParam=function(A){if(A.rule!==void 0&&(this.sRule=A.rule),A.ds!==void 0&&(this.dsType=A.ds),A.value===void 0&&A.str!==void 0){var B=A.str,O=B.match(/^([^=]+)=(.+)$/);if(O)this.sType=O[1],this.sValue=O[2];else throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr)}else this.sType=A.type,this.sValue=A.value},this.setByString=function(A,B){B!==void 0&&(this.sRule=B);var O=A.match(/^([^=]+)=(.+)$/);if(O)this.setByAttrTypeAndValueStr(O[1],O[2]);else throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr)},this._getDsType=function(){var A=this.sType,B=this.sValue,O=this.sRule;return O==="prn"?A=="CN"&&W(B)?"ia5":G(B)?"prn":"utf8":O==="utf8"?A=="CN"&&W(B)?"ia5":A=="C"?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(A,B,O){O!==void 0&&(this.sRule=O),this.sType=A,this.sValue=B},this.getValueObj=function(A,B){if(A=="utf8")return new x({str:B});if(A=="prn")return new y({str:B});if(A=="tel")return new F({str:B});if(A=="ia5")return new D({str:B});if(A=="vis")return new V({str:B});if(A=="bmp")return new U({str:B});throw new Error("unsupported directory string type: type="+A+" value="+B)},this.tohex=function(){this.dsType==null&&(this.dsType=this._getDsType());var A=C.asn1.x509.OID.atype2obj(this.sType),B=this.getValueObj(this.dsType,this.sValue),O=new f({array:[A,B]});return this.TLV=O.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.AttributeTypeAndValue,C.asn1.ASN1Object),C.asn1.x509.SubjectPublicKeyInfo=function(a){C.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERInteger,x=u.DERBitString,y=u.DERObjectIdentifier,F=u.DERSequence,D=u.ASN1Util.newObject,V=u.x509,U=V.AlgorithmIdentifier,W=l.crypto;W.ECDSA,W.DSA,this.getASN1Object=function(){if(this.asn1AlgId==null||this.asn1SubjPKey==null)throw"algId and/or subjPubKey not set";var G=new F({array:[this.asn1AlgId,this.asn1SubjPKey]});return G},this.tohex=function(){var G=this.getASN1Object();return this.hTLV=G.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(G){try{if(G instanceof Lt){var A=D({seq:[{int:{bigint:G.n}},{int:{int:G.e}}]}),B=A.tohex();this.asn1AlgId=new U({name:"rsaEncryption"}),this.asn1SubjPKey=new x({hex:"00"+B})}}catch{}try{if(G instanceof C.crypto.ECDSA){var O=new y({name:G.curveName});this.asn1AlgId=new U({name:"ecPublicKey",asn1params:O}),this.asn1SubjPKey=new x({hex:"00"+G.pubKeyHex})}}catch{}try{if(G instanceof C.crypto.DSA){var O=new D({seq:[{int:{bigint:G.p}},{int:{bigint:G.q}},{int:{bigint:G.g}}]});this.asn1AlgId=new U({name:"dsa",asn1params:O});var H=new f({bigint:G.y});this.asn1SubjPKey=new x({hex:"00"+H.tohex()})}}catch{}},a!==void 0&&this.setPubKey(a)},Ue(C.asn1.x509.SubjectPublicKeyInfo,C.asn1.ASN1Object),C.asn1.x509.Time=function(a){C.asn1.x509.Time.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERUTCTime,x=u.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(y){this.timeParams=y},this.setByParam=function(y){this.params=y},this.getType=function(y){return y.match(/^[0-9]{12}Z$/)?"utc":y.match(/^[0-9]{14}Z$/)?"gen":y.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":y.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var y=this.params,F=null;if(typeof y=="string"&&(y={str:y}),y!=null&&y.str&&(y.type==null||y.type==null)&&(y.type=this.getType(y.str)),y!=null&&y.str?(y.type=="utc"&&(F=new f(y.str)),y.type=="gen"&&(F=new x(y.str))):this.type=="gen"?F=new x:F=new f,F==null)throw new Error("wrong setting for Time");return this.TLV=F.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},C.asn1.x509.Time_bak=function(a){C.asn1.x509.Time_bak.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERUTCTime,x=u.DERGeneralizedTime;this.setTimeParams=function(y){this.timeParams=y},this.tohex=function(){var y=null;return this.timeParams!=null?this.type=="utc"?y=new f(this.timeParams):y=new x(this.timeParams):this.type=="utc"?y=new f:y=new x,this.TLV=y.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",a!==void 0&&(a.type!==void 0?this.type=a.type:a.str!==void 0&&(a.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),a.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=a)},Ue(C.asn1.x509.Time,C.asn1.ASN1Object),C.asn1.x509.AlgorithmIdentifier=function(a){C.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var l=C,u=l.asn1,f=u.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(this.nameAlg===null&&this.asn1Alg===null)throw new Error("algorithm not specified");if(this.nameAlg!==null){var y=null;for(var F in f)F===this.nameAlg&&(y=f[F]);if(y!==null)return this.hTLV=y,this.hTLV}this.nameAlg!==null&&this.asn1Alg===null&&(this.asn1Alg=u.x509.OID.name2obj(this.nameAlg));var D=[this.asn1Alg];this.asn1Params!==null&&D.push(this.asn1Params);var V=new u.DERSequence({array:D});return this.hTLV=V.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&(a.name!==void 0&&(this.nameAlg=a.name),a.asn1params!==void 0&&(this.asn1Params=a.asn1params),a.paramempty!==void 0&&(this.paramEmpty=a.paramempty)),this.asn1Params===null&&this.paramEmpty===!1&&this.nameAlg!==null){this.nameAlg.name!==void 0&&(this.nameAlg=this.nameAlg.name);var x=this.nameAlg.toLowerCase();x.substr(-7,7)!=="withdsa"&&x.substr(-9,9)!=="withecdsa"&&(this.asn1Params=new u.DERNull)}},Ue(C.asn1.x509.AlgorithmIdentifier,C.asn1.ASN1Object),C.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},C.asn1.x509.GeneralName=function(a){C.asn1.x509.GeneralName.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.x509,x=f.X500Name,y=f.OtherName,F=u.DERIA5String;u.DERPrintableString;var D=u.DEROctetString,V=u.DERTaggedObject,U=u.ASN1Object,W=Error;this.params=null,this.setByParam=function(G){this.params=G},this.tohex=function(){var G=this.params,A,O,B,O=!1;if(G.other!==void 0)A="a0",B=new y(G.other);else if(G.rfc822!==void 0)A="81",B=new F({str:G.rfc822});else if(G.dns!==void 0)A="82",B=new F({str:G.dns});else if(G.dn!==void 0)A="a4",O=!0,typeof G.dn=="string"?B=new x({str:G.dn}):G.dn instanceof C.asn1.x509.X500Name?B=G.dn:B=new x(G.dn);else if(G.ldapdn!==void 0)A="a4",O=!0,B=new x({ldapstr:G.ldapdn});else if(G.certissuer!==void 0||G.certsubj!==void 0){A="a4",O=!0;var H,q,Z=null;if(G.certsubj!==void 0?(H=!1,q=G.certsubj):(H=!0,q=G.certissuer),q.match(/^[0-9A-Fa-f]+$/),q.indexOf("-----BEGIN ")!=-1&&(Z=Ui(q)),Z==null)throw new Error("certsubj/certissuer not cert");var ce=new At;ce.hex=Z;var fe;H?fe=ce.getIssuerHex():fe=ce.getSubjectHex(),B=new U,B.hTLV=fe}else if(G.uri!==void 0)A="86",B=new F({str:G.uri});else if(G.ip!==void 0){A="87";var pe,ge=G.ip;try{if(ge.match(/^[0-9a-f]+$/)){var Y=ge.length;if(Y==8||Y==16||Y==32||Y==64)pe=ge;else throw"err"}else pe=od(ge)}catch(re){throw new W("malformed IP address: "+G.ip+":"+re.message)}B=new D({hex:pe})}else throw new W("improper params");var Q=new V({tag:A,explicit:O,obj:B});return Q.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.GeneralName,C.asn1.ASN1Object),C.asn1.x509.GeneralNames=function(a){C.asn1.x509.GeneralNames.superclass.constructor.call(this);var l=C,u=l.asn1;this.setByParamArray=function(f){for(var x=0;x<f.length;x++){var y=new u.x509.GeneralName(f[x]);this.asn1Array.push(y)}},this.tohex=function(){var f=new u.DERSequence({array:this.asn1Array});return f.tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,typeof a<"u"&&this.setByParamArray(a)},Ue(C.asn1.x509.GeneralNames,C.asn1.ASN1Object),C.asn1.x509.OtherName=function(a){C.asn1.x509.OtherName.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DERObjectIdentifier,x=u.DERSequence,y=u.ASN1Util.newObject;this.params=null,this.setByParam=function(F){this.params=F},this.tohex=function(){var F=this.params;if(F.oid==null||F.value==null)throw new Error("oid or value not specified");var D=new f({oid:F.oid}),V=y({tag:{tag:"a0",explicit:!0,obj:F.value}}),U=new x({array:[D,V]});return U.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.x509.OtherName,C.asn1.ASN1Object),C.asn1.x509.OID=new function(){var a=C.asn1.DERObjectIdentifier;this.name2oidList={"aes128-CBC":"2.16.840.1.101.3.4.1.2","aes256-CBC":"2.16.840.1.101.3.4.1.42",sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",hmacWithSHA1:"1.2.840.113549.2.7",hmacWithSHA224:"1.2.840.113549.2.8",hmacWithSHA256:"1.2.840.113549.2.9",hmacWithSHA384:"1.2.840.113549.2.10",hmacWithSHA512:"1.2.840.113549.2.11",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",policyMappings:"2.5.29.33",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",inhibitAnyPolicy:"2.5.29.54",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",smtpUTF8Mailbox:"1.3.6.1.5.5.7.8.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1",smimeMailboxLegacy:"2.23.140.1.5.1.1",smimeMailboxMulti:"2.23.140.1.5.1.2",smimeMailboxStrict:"2.23.140.1.5.1.3",smimeOrganizationLegacy:"2.23.140.1.5.2.1",smimeOrganizationMulti:"2.23.140.1.5.2.2",smimeOrganizationStrict:"2.23.140.1.5.2.3",smimeSponsorLegacy:"2.23.140.1.5.3.1",smimeSponsorMulti:"2.23.140.1.5.3.2",smimeSponsorStrict:"2.23.140.1.5.3.3",smimeIndividualLegacy:"2.23.140.1.5.4.1",smimeIndividualMulti:"2.23.140.1.5.4.2",smimeIndividualStrict:"2.23.140.1.5.4.3"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",GN:"2.5.4.42",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(l){if(typeof this.objCache[l]<"u")return this.objCache[l];if(typeof this.name2oidList[l]>"u")throw"Name of ObjectIdentifier not defined: "+l;var u=this.name2oidList[l],f=new a({oid:u});return this.objCache[l]=f,f},this.atype2obj=function(l){if(this.objCache[l]!==void 0)return this.objCache[l];var u;if(l.match(/^\d+\.\d+\.[0-9.]+$/))u=l;else if(this.atype2oidList[l]!==void 0)u=this.atype2oidList[l];else if(this.name2oidList[l]!==void 0)u=this.name2oidList[l];else throw new Error("AttributeType name undefined: "+l);var f=new a({oid:u});return this.objCache[l]=f,f},this.registerOIDs=function(l){if(this.checkOIDs(l))for(var u in l)this.name2oidList[u]=l[u]},this.checkOIDs=function(l){try{var u=Object.keys(l);return u.length==0?!1:(u.map(function(f,x,y){var F=this[f];if(!F.match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")},l),!0)}catch{return!1}}},C.asn1.x509.OID.oid2name=function(a){var l=C.asn1.x509.OID.name2oidList;for(var u in l)if(l[u]==a)return u;return""},C.asn1.x509.OID.oid2atype=function(a){var l=C.asn1.x509.OID.atype2oidList;for(var u in l)if(l[u]==a)return u;return a},C.asn1.x509.OID.name2oid=function(a){if(a.match(/^[0-9.]+$/))return a;var l=C.asn1.x509.OID.name2oidList;return l[a]===void 0?"":l[a]},C.asn1.x509.X509Util={},C.asn1.x509.X509Util.newCertPEM=function(a){var l=C.asn1.x509;l.TBSCertificate;var u=l.Certificate,f=new u(a);return f.getPEM()},(typeof C>"u"||!C)&&(C={}),(typeof C.asn1>"u"||!C.asn1)&&(C.asn1={}),(typeof C.asn1.cms>"u"||!C.asn1.cms)&&(C.asn1.cms={}),C.asn1.cms.Attribute=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence,y=f.DERSet,F=f.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(D){this.params=D},this.getValueArray=function(){throw new l("not yet implemented abstract")},this.tohex=function(){var D=new F({oid:this.typeOid}),V=new y({array:this.getValueArray()}),U=new x({array:[D,V]});return U.tohex()},this.getEncodedHex=function(){return this.tohex()}},Ue(C.asn1.cms.Attribute,C.asn1.ASN1Object),C.asn1.cms.ContentType=function(a){var l=C,u=l.asn1;u.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){var f=new u.DERObjectIdentifier(this.params.type);return[f]},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.ContentType,C.asn1.cms.Attribute),C.asn1.cms.MessageDigest=function(a){var l=C,u=l.asn1,f=u.DEROctetString,x=u.cms;x.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){var y=new f(this.params);return[y]},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.MessageDigest,C.asn1.cms.Attribute),C.asn1.cms.SigningTime=function(a){var l=C,u=l.asn1;u.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){var f=new u.x509.Time(this.params);return[f]},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.SigningTime,C.asn1.cms.Attribute),C.asn1.cms.SigningCertificate=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence,y=f.cms,F=y.ESSCertID;u.crypto,y.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(this.params==null||this.params==null||this.params.array==null)throw new l("parameter 'array' not specified");for(var D=this.params.array,V=[],U=0;U<D.length;U++){var W=D[U];a.hasis==!1&&typeof W=="string"&&(W.indexOf("-----BEGIN")!=-1||Xe.isASN1HEX(W))&&(W={cert:W}),W.hasis!=!1&&a.hasis==!1&&(W.hasis=!1),V.push(new F(W))}var G=new x({array:V}),A=new x({array:[G]});return[A]},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.SigningCertificate,C.asn1.cms.Attribute),C.asn1.cms.ESSCertID=function(a){C.asn1.cms.ESSCertID.superclass.constructor.call(this);var l=Error,u=C,f=u.asn1,x=f.DEROctetString,y=f.DERSequence,F=f.cms.IssuerSerial;this.params=null,this.getCertHash=function(D,V){if(D.hash!=null)return D.hash;if(typeof D=="string"&&D.indexOf("-----BEGIN")==-1&&!Xe.isASN1HEX(D))return D;var U;if(typeof D=="string")U=D;else if(D.cert!=null)U=D.cert;else throw new l("hash nor cert unspecified");var W;U.indexOf("-----BEGIN")!=-1?W=Ui(U):W=U,typeof D=="string"&&(D.indexOf("-----BEGIN")!=-1?W=Ui(D):Xe.isASN1HEX(D)&&(W=D));var G;if(D.alg!=null)G=D.alg;else if(V!=null)G=V;else throw new l("hash alg unspecified");return u.crypto.Util.hashHex(W,G)},this.tohex=function(){var D=this.params,V=this.getCertHash(D,"sha1"),U=[];U.push(new x({hex:V})),(typeof D=="string"&&D.indexOf("-----BEGIN")!=-1||D.cert!=null&&D.hasis!=!1||D.issuer!=null&&D.serial!=null)&&U.push(new F(D));var W=new y({array:U});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.ESSCertID,C.asn1.ASN1Object),C.asn1.cms.SigningCertificateV2=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence;f.x509;var y=f.cms,F=y.ESSCertIDv2;u.crypto,y.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(this.params==null||this.params==null||this.params.array==null)throw new l("parameter 'array' not specified");for(var D=this.params.array,V=[],U=0;U<D.length;U++){var W=D[U];(a.alg!=null||a.hasis==!1)&&typeof W=="string"&&(W.indexOf("-----BEGIN")!=-1||Xe.isASN1HEX(W))&&(W={cert:W}),W.alg==null&&a.alg!=null&&(W.alg=a.alg),W.hasis!=!1&&a.hasis==!1&&(W.hasis=!1),V.push(new F(W))}var G=new x({array:V}),A=new x({array:[G]});return[A]},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.SigningCertificateV2,C.asn1.cms.Attribute),C.asn1.cms.ESSCertIDv2=function(a){C.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.DEROctetString,x=u.DERSequence,y=u.cms.IssuerSerial,F=u.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var D=this.params,V=this.getCertHash(D,"sha256"),U=[];D.alg!=null&&D.alg!="sha256"&&U.push(new F({name:D.alg})),U.push(new f({hex:V})),(typeof D=="string"&&D.indexOf("-----BEGIN")!=-1||D.cert!=null&&D.hasis!=!1||D.issuer!=null&&D.serial!=null)&&U.push(new y(D));var W=new x({array:U});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.ESSCertIDv2,C.asn1.cms.ESSCertID),C.asn1.cms.IssuerSerial=function(a){var l=Error,u=C,f=u.asn1,x=f.DERInteger,y=f.DERSequence,F=f.cms,D=f.x509,V=D.GeneralNames,U=At;F.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(W){this.params=W},this.tohex=function(){var W=this.params,G,A;if(typeof W=="string"&&W.indexOf("-----BEGIN")!=-1||W.cert!=null){var B;W.cert!=null?B=W.cert:B=W;var O=new U;O.readCertPEM(B),G=O.getIssuer(),A={hex:O.getSerialNumberHex()}}else if(W.issuer!=null&&W.serial)G=W.issuer,A=W.serial;else throw new l("cert or issuer and serial parameter not specified");var H=new V([{dn:G}]),q=new x(A),Z=new y({array:[H,q]});return Z.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.IssuerSerial,C.asn1.ASN1Object),C.asn1.cms.SignerIdentifier=function(a){var l=C,u=l.asn1;u.DERInteger,u.DERSequence;var f=u.cms,x=f.IssuerAndSerialNumber,y=f.SubjectKeyIdentifier,F=u.x509;F.X500Name,f.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var D=this.params;if(D.type=="isssn"){var V=new x(D);return V.tohex()}else if(D.type=="skid"){var U=new y(D);return U.tohex()}else throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.SignerIdentifier,C.asn1.ASN1Object),C.asn1.cms.IssuerAndSerialNumber=function(a){var l=C,u=l.asn1,f=u.DERInteger,x=u.DERSequence,y=u.cms,F=u.x509,D=F.X500Name,V=At,U=Error;y.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var W=this.params,G,A;if(typeof W=="string"&&W.indexOf("-----BEGIN")!=-1||W.cert!=null){var B;W.cert!=null?B=W.cert:B=W;var O=new V;O.readCertPEM(B),G=O.getIssuer(),A={hex:O.getSerialNumberHex()}}else if(W.issuer!=null&&W.serial)G=W.issuer,A=W.serial;else throw new U("cert or issuer and serial parameter not specified");var H=new D(G),q=new f(A),Z=new x({array:[H,q]});return Z.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(W){this.params=W},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.IssuerAndSerialNumber,C.asn1.ASN1Object),C.asn1.cms.SubjectKeyIdentifier=function(a){var l=C,u=l.asn1;u.DERInteger,u.DERSequence;var f=u.ASN1Util.newObject,x=u.cms;x.IssuerAndSerialName,x.SubjectKeyIdentifier;var y=u.x509;y.X500Name;var F=At,D=Error;x.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var V=this.params;if(V.cert==null&&V.skid==null)throw new D("property cert nor skid undefined");var U;if(V.cert!=null){var W=new F(V.cert),G=W.getExtSubjectKeyIdentifier();U=G.kid.hex}else V.skid!=null&&(U=V.skid);var A=f({tag:{tage:"a0",obj:{octstr:{hex:U}}}});return A.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.SubjectKeyIdentifier,C.asn1.ASN1Object),C.asn1.cms.AttributeList=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSet,y=f.cms;y.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(F){this.params=F},this.tohex=function(){var F=this.params;if(this.hTLV!=null)return this.hTLV;var D=!0;F.sortflag!=null&&(D=F.sortflag);for(var V=F.array,U=[],W=0;W<V.length;W++){var G=V[W],A=G.attr;if(A=="contentType")U.push(new y.ContentType(G));else if(A=="messageDigest")U.push(new y.MessageDigest(G));else if(A=="signingTime")U.push(new y.SigningTime(G));else if(A=="signingCertificate")U.push(new y.SigningCertificate(G));else if(A=="signingCertificateV2")U.push(new y.SigningCertificateV2(G));else if(A=="signaturePolicyIdentifier")U.push(new C.asn1.cades.SignaturePolicyIdentifier(G));else if(A=="signatureTimeStamp"||A=="timeStampToken")U.push(new C.asn1.cades.SignatureTimeStamp(G));else throw new l("unknown attr: "+A)}var B=new x({array:U,sortflag:D});return this.hTLV=B.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.AttributeList,C.asn1.ASN1Object),C.asn1.cms.SignerInfo=function(a){var l=Error,u=C,f=u.asn1,x=f.DERInteger,y=f.DEROctetString,F=f.DERSequence,D=f.DERTaggedObject,V=f.cms,U=V.SignerIdentifier,W=V.AttributeList;V.ContentType,V.EncapsulatedContentInfo,V.MessageDigest,V.SignedData;var G=f.x509,A=G.AlgorithmIdentifier,B=u.crypto,O=Yt;V.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var H=this.params,q=H.sigalg,Z=new W(H.sattrs).tohex(),ce=O.getKey(H.signkey),fe=new B.Signature({alg:q});fe.init(ce),fe.updateHex(Z);var pe=fe.sign();H.sighex=pe},this.tohex=function(){var H=this.params,q=[];if(q.push(new x({int:H.version})),q.push(new U(H.id)),q.push(new A({name:H.hashalg})),H.sattrs!=null){var Z=new W(H.sattrs);try{q.push(new D({tag:"a0",explicit:!1,obj:Z}))}catch(fe){throw new l("si sattr error: "+fe)}}if(H.sigalgfield!=null?q.push(new A({name:H.sigalgfield})):q.push(new A({name:H.sigalg})),H.sighex==null&&H.signkey!=null&&this.sign(),q.push(new y({hex:H.sighex})),H.uattrs!=null){var Z=new W(H.uattrs);try{q.push(new D({tag:"a1",explicit:!1,obj:Z}))}catch(pe){throw new l("si uattr error: "+pe)}}var ce=new F({array:q});return ce.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.SignerInfo,C.asn1.ASN1Object),C.asn1.cms.EncapsulatedContentInfo=function(a){var l=C,u=l.asn1,f=u.DERTaggedObject,x=u.DERSequence,y=u.DERObjectIdentifier,F=u.DEROctetString,D=u.cms;D.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var V=this.params,U=[];if(U.push(new y(V.type)),V.content!=null&&(V.content.hex!=null||V.content.str!=null)&&V.isDetached!=!0){var W=new F(V.content),G=new f({tag:"a0",explicit:!0,obj:W});U.push(G)}var A=new x({array:U});return A.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(V){this.params=V},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.EncapsulatedContentInfo,C.asn1.ASN1Object),C.asn1.cms.ContentInfo=function(a){var l=C,u=l.asn1,f=u.DERTaggedObject,x=u.DERSequence,y=u.DERObjectIdentifier,F=u.x509;F.OID.name2obj,C.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var D=this.params,V=[];V.push(new y(D.type));var U=new f({tag:"a0",explicit:!0,obj:D.obj});V.push(U);var W=new x({array:V});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(D){this.params=D},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.ContentInfo,C.asn1.ASN1Object),C.asn1.cms.SignedData=function(a){var l=C,u=l.asn1;u.ASN1Object;var f=u.DERInteger,x=u.DERSet,y=u.DERSequence;u.DERTaggedObject;var F=u.cms,D=F.EncapsulatedContentInfo,V=F.SignerInfo,U=F.ContentInfo,W=F.CertificateSet,G=F.RevocationInfoChoices,A=u.x509,B=A.AlgorithmIdentifier;C.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var O=this.params;this._setDigestAlgs(O),this._setContentTypeByEContent(O),this._setMessageDigestByEContent(O),this._setSignerInfoVersion(O),this._setSignedDataVersion(O)},this._setDigestAlgs=function(O){for(var H={},q=O.sinfos,Z=0;Z<q.length;Z++){var ce=q[Z];H[ce.hashalg]=1}O.hashalgs=Object.keys(H).sort()},this._setContentTypeByEContent=function(O){for(var H=O.econtent.type,q=O.sinfos,Z=0;Z<q.length;Z++){var ce=q[Z],fe=this._getAttrParamByName(ce,"contentType");fe.type=H}},this._setMessageDigestByEContent=function(O){var H=O.econtent;O.econtent.type;var q=H.content.hex;q==null&&H.type=="data"&&H.content.str!=null&&(q=Ar(H.content.str));for(var Z=O.sinfos,ce=0;ce<Z.length;ce++){var fe=Z[ce],pe=fe.hashalg,ge=this._getAttrParamByName(fe,"messageDigest"),Y=C.crypto.Util.hashHex(q,pe);ge.hex=Y}},this._getAttrParamByName=function(O,H){for(var q=O.sattrs.array,Z=0;Z<q.length;Z++)if(q[Z].attr==H)return q[Z]},this._setSignerInfoVersion=function(O){for(var H=O.sinfos,q=0;q<H.length;q++){var Z=H[q],ce=1;Z.id.type=="skid"&&(ce=3),Z.version=ce}},this._setSignedDataVersion=function(O){var H=this._getSignedDataVersion(O);O.version=H},this._getSignedDataVersion=function(O){if(O.revinfos!=null)for(var H=O.revinfos,q=0;q<H.length;q++){var Z=H[q];if(Z.ocsp!=null)return 5}for(var ce=O.sinfos,q=0;q<ce.length;q++){var fe=O.sinfos[q];if(fe.version==3)return 3}return O.econtent.type!="data"?3:1},this.tohex=function(){var O=this.params;this.getEncodedHexPrepare!=null&&this.getEncodedHexPrepare(),O.fixed!=!0&&this.checkAndFixParam();var H=[];H.push(new f({int:O.version}));for(var q=[],Z=0;Z<O.hashalgs.length;Z++){var ce=O.hashalgs[Z];q.push(new B({name:ce}))}H.push(new x({array:q})),H.push(new D(O.econtent)),O.certs!=null&&H.push(new W(O.certs)),O.revinfos!=null&&H.push(new G(O.revinfos));for(var fe=[],Z=0;Z<O.sinfos.length;Z++){var pe=O.sinfos[Z];fe.push(new V(pe))}H.push(new x({array:fe}));var ge=new y({array:H});return ge.tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){var O=new U({type:"signed-data",obj:this});return O},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.SignedData,C.asn1.ASN1Object),C.asn1.cms.CertificateSet=function(a){C.asn1.cms.CertificateSet.superclass.constructor.call(this);var l=Error,u=C.asn1,f=u.DERTaggedObject,x=u.DERSet,y=u.ASN1Object;this.params=null,this.tohex=function(){var F=this.params,D=[],V;if(F instanceof Array)V=F;else if(F.array!=null)V=F.array;else throw new l("cert array not specified");for(var U=0;U<V.length;U++){var W=V[U],G=Ui(W),A=new y;A.hTLV=G,D.push(A)}var B={array:D};F.sortflag==!1&&(B.sortflag=!1);var O=new x(B),H=new f({tag:"a0",explicit:!1,obj:O});return H.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.CertificateSet,C.asn1.ASN1Object),C.asn1.cms.RevocationInfoChoices=function(a){C.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var l=this.params;if(!l instanceof Array)throw new Error("params is not array");for(var u=[],f=0;f<l.length;f++)u.push(new C.asn1.cms.RevocationInfoChoice(l[f]));var x=C.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:u}}});return x.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.RevocationInfoChoices,C.asn1.ASN1Object),C.asn1.cms.RevocationInfoChoice=function(a){C.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var l=this.params;if(l.crl!=null&&typeof l.crl=="string"){var u=l.crl;return l.crl.indexOf("-----BEGIN")!=-1&&(u=Ui(l.crl)),u}else if(l.ocsp!=null){var f=C.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new C.asn1.cms.OtherRevocationFormat(l)}});return f.tohex()}else throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.RevocationInfoChoice,C.asn1.ASN1Object),C.asn1.cms.OtherRevocationFormat=function(a){C.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var l=Error,u=C,f=u.asn1,x=f.ASN1Util.newObject,y=u.lang.String.isHex;this.params=null,this.tohex=function(){var F=this.params;if(F.ocsp==null)throw new l("property ocsp not specified");if(!y(F.ocsp)||!Xe.isASN1HEX(F.ocsp))throw new l("ocsp value not ASN.1 hex string");var D=x({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:F.ocsp}}]});return D.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cms.OtherRevocationFormat,C.asn1.ASN1Object),C.asn1.cms.CMSUtil=new function(){},C.asn1.cms.CMSUtil.newSignedData=function(a){return new C.asn1.cms.SignedData(a)},C.asn1.cms.CMSUtil.verifySignedData=function(a){var l=C,u=l.asn1,f=u.cms;f.SignerInfo,f.SignedData,f.SigningTime,f.SigningCertificate,f.SigningCertificateV2;var x=u.cades;x.SignaturePolicyIdentifier;var y=l.lang.String.isHex,F=Xe,D=F.getVbyList,V=F.getTLVbyList,U=F.getIdxbyList,W=F.getChildIdx,G=F.getTLV,A=F.oidname,B=l.crypto.Util.hashHex;a.cms===void 0&&y(a.cms);var O=a.cms,H=function(re,J){for(var oe,me=3;me<6;me++)if(oe=U(re,0,[1,0,me]),oe!==void 0){var ye=re.substr(oe,2);ye==="a0"&&(J.certsIdx=oe),ye==="a1"&&(J.revinfosIdx=oe),ye==="31"&&(J.signerinfosIdx=oe)}},q=function(re,J){var oe=J.signerinfosIdx;if(oe!==void 0){var me=W(re,oe);J.signerInfoIdxList=me;for(var ye=0;ye<me.length;ye++){var Be=me[ye],be={idx:Be};Z(re,be),J.signerInfos.push(be)}}},Z=function(re,J){var oe=J.idx;J.signerid_issuer1=V(re,oe,[1,0],"30"),J.signerid_serial1=D(re,oe,[1,1],"02"),J.hashalg=A(D(re,oe,[2,0],"06"));var me=U(re,oe,[3],"a0");J.idxSignedAttrs=me,ce(re,J,me);var ye=W(re,oe),Be=ye.length;if(Be<6)throw"malformed SignerInfo";J.sigalg=A(D(re,oe,[Be-2,0],"06")),J.sigval=D(re,oe,[Be-1],"04")},ce=function(re,J,oe){var me=W(re,oe);J.signedAttrIdxList=me;for(var ye=0;ye<me.length;ye++){var Be=me[ye],be=D(re,Be,[0],"06"),Te;be==="2a864886f70d010905"?(Te=gi(D(re,Be,[1,0])),J.saSigningTime=Te):be==="2a864886f70d010904"&&(Te=D(re,Be,[1,0],"04"),J.saMessageDigest=Te)}},fe=function(re,J){if(D(re,0,[0],"06")!=="2a864886f70d010702")return J;J.cmsType="signedData",J.econtent=D(re,0,[1,0,2,1,0]),H(re,J),J.signerInfos=[],q(re,J)},pe=function(re,J){for(var oe=J.parse.signerInfos,me=oe.length,ye=!0,Be=0;Be<me;Be++){var be=oe[Be];Y(re,J,be),be.isValid||(ye=!1)}J.isValid=ye},ge=function(re,J,oe,me){var ye=J.parse.certsIdx,Be;if(J.certs===void 0){Be=[],J.certkeys=[];for(var be=W(re,ye),Te=0;Te<be.length;Te++){var He=G(re,be[Te]),qe=new At;qe.readCertHex(He),Be[Te]=qe,J.certkeys[Te]=qe.getPublicKey()}J.certs=Be}else Be=J.certs;J.cccc=Be.length,J.cccci=be.length;for(var Te=0;Te<Be.length;Te++){var pn=qe.getIssuerHex(),Ni=qe.getSerialNumberHex();oe.signerid_issuer1===pn&&oe.signerid_serial1===Ni&&(oe.certkey_idx=Te)}},Y=function(re,J,oe,me){oe.verifyDetail={};var ye=oe.verifyDetail,Be=J.parse.econtent,be=oe.hashalg,Te=oe.saMessageDigest;ye.validMessageDigest=!1,B(Be,be)===Te&&(ye.validMessageDigest=!0),ge(re,J,oe),ye.validSignatureValue=!1;var He=oe.sigalg,qe="31"+G(re,oe.idxSignedAttrs).substr(2);oe.signedattrshex=qe;var pn=J.certs[oe.certkey_idx].getPublicKey(),Ni=new C.crypto.Signature({alg:He});Ni.init(pn),Ni.updateHex(qe);var Ti=Ni.verify(oe.sigval);ye.validSignatureValue_isValid=Ti,Ti===!0&&(ye.validSignatureValue=!0),oe.isValid=!1,ye.validMessageDigest&&ye.validSignatureValue&&(oe.isValid=!0)},Q={isValid:!1,parse:{}};return fe(O,Q.parse),pe(O,Q),Q},C.asn1.cms.CMSParser=function(){var a=Error,l=At,u=new l,f=Xe,x=f.getV,y=f.getTLV;f.getIdxbyList;var F=f.getTLVbyList,D=f.getTLVbyListEx,V=f.getVbyList,U=f.getVbyListEx,W=f.getChildIdx;this.getCMSSignedData=function(G){var A=F(G,0,[1,0]),B=this.getSignedData(A);return B},this.getSignedData=function(G){var A=W(G,0),B={},O=x(G,A[0]),H=parseInt(O,16);B.version=H;var q=y(G,A[1]);B.hashalgs=this.getHashAlgArray(q);var Z=y(G,A[2]);B.econtent=this.getEContent(Z);var ce=D(G,0,["[0]"]);ce!=null&&(B.certs=this.getCertificateSet(ce)),D(G,0,["[1]"]);var fe=D(G,0,[3]);return B.sinfos=this.getSignerInfos(fe),B},this.getHashAlgArray=function(G){for(var A=W(G,0),B=new l,O=[],H=0;H<A.length;H++){var q=y(G,A[H]),Z=B.getAlgorithmIdentifierName(q);O.push(Z)}return O},this.getEContent=function(G){var A={},B=V(G,0,[0]),O=V(G,0,[1,0]);return A.type=C.asn1.x509.OID.oid2name(Xe.hextooidstr(B)),A.content={hex:O},A},this.getSignerInfos=function(G){for(var A=[],B=W(G,0),O=0;O<B.length;O++){var H=y(G,B[O]),q=this.getSignerInfo(H);A.push(q)}return A},this.getSignerInfo=function(G){var A={},B=W(G,0),O=f.getInt(G,B[0],-1);O!=-1&&(A.version=O);var H=y(G,B[1]),q=this.getIssuerAndSerialNumber(H);A.id=q;var Z=y(G,B[2]),ce=u.getAlgorithmIdentifierName(Z);A.hashalg=ce;var fe=D(G,0,["[0]"]);if(fe!=null){var pe=this.getAttributeList(fe);A.sattrs=pe}var ge=D(G,0,[3]),Y=u.getAlgorithmIdentifierName(ge);A.sigalg=Y;var Q=U(G,0,[4]);A.sighex=Q;var re=D(G,0,["[1]"]);if(re!=null){var J=this.getAttributeList(re);A.uattrs=J}return A},this.getSignerIdentifier=function(G){if(G.substr(0,2)=="30")return this.getIssuerAndSerialNumber(G);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(G){var A={type:"isssn"},B=W(G,0),O=y(G,B[0]);A.issuer=u.getX500Name(O);var H=x(G,B[1]);return A.serial={hex:H},A},this.getAttributeList=function(G){for(var A=[],B=W(G,0),O=0;O<B.length;O++){var H=y(G,B[O]),q=this.getAttribute(H);A.push(q)}return{array:A}},this.getAttribute=function(G){var A={},B=W(G,0),O=f.getOID(G,B[0]),H=C.asn1.x509.OID.oid2name(O);A.attr=H;var q=y(G,B[1]),Z=W(q,0);if(Z.length==1)A.valhex=y(q,Z[0]);else{for(var ce=[],fe=0;fe<Z.length;fe++)ce.push(y(q,Z[fe]));A.valhex=ce}return H=="contentType"?this.setContentType(A):H=="messageDigest"?this.setMessageDigest(A):H=="signingTime"?this.setSigningTime(A):H=="signingCertificate"?this.setSigningCertificate(A):H=="signingCertificateV2"?this.setSigningCertificateV2(A):H=="signaturePolicyIdentifier"&&this.setSignaturePolicyIdentifier(A),A},this.setContentType=function(G){var A=f.getOIDName(G.valhex,0,null);A!=null&&(G.type=A,delete G.valhex)},this.setSigningTime=function(G){var A=x(G.valhex,0),B=gi(A);G.str=B,delete G.valhex},this.setMessageDigest=function(G){var A=x(G.valhex,0);G.hex=A,delete G.valhex},this.setSigningCertificate=function(G){var A=W(G.valhex,0);if(A.length>0){for(var B=y(G.valhex,A[0]),O=W(B,0),H=[],q=0;q<O.length;q++){var Z=y(B,O[q]),ce=this.getESSCertID(Z);H.push(ce)}G.array=H}if(A.length>1){var fe=y(G.valhex,A[1]);G.polhex=fe}delete G.valhex},this.setSignaturePolicyIdentifier=function(G){var A=W(G.valhex,0);if(A.length>0){var B=f.getOID(G.valhex,A[0]);G.oid=B}if(A.length>1){var O=new l,H=W(G.valhex,A[1]),q=y(G.valhex,H[0]),Z=O.getAlgorithmIdentifierName(q);G.alg=Z;var ce=x(G.valhex,H[1]);G.hash=ce}delete G.valhex},this.setSigningCertificateV2=function(G){var A=W(G.valhex,0);if(A.length>0){for(var B=y(G.valhex,A[0]),O=W(B,0),H=[],q=0;q<O.length;q++){var Z=y(B,O[q]),ce=this.getESSCertIDv2(Z);H.push(ce)}G.array=H}if(A.length>1){var fe=y(G.valhex,A[1]);G.polhex=fe}delete G.valhex},this.getESSCertID=function(G){var A={},B=W(G,0);if(B.length>0){var O=x(G,B[0]);A.hash=O}if(B.length>1){var H=y(G,B[1]),q=this.getIssuerSerial(H);q.serial!=null&&(A.serial=q.serial),q.issuer!=null&&(A.issuer=q.issuer)}return A},this.getESSCertIDv2=function(G){var A={},B=W(G,0);if(B.length<1||3<B.length)throw new a("wrong number of elements");var O=0;if(G.substr(B[0],2)=="30"){var H=y(G,B[0]);A.alg=u.getAlgorithmIdentifierName(H),O++}else A.alg="sha256";var q=x(G,B[O]);if(A.hash=q,B.length>O+1){var Z=y(G,B[O+1]),ce=this.getIssuerSerial(Z);A.issuer=ce.issuer,A.serial=ce.serial}return A},this.getIssuerSerial=function(G){var A={},B=W(G,0),O=y(G,B[0]),H=u.getGeneralNames(O),q=H[0].dn;A.issuer=q;var Z=x(G,B[1]);return A.serial={hex:Z},A},this.getCertificateSet=function(G){for(var A=W(G,0),B=[],O=0;O<A.length;O++){var H=y(G,A[O]);if(H.substr(0,2)=="30"){var q=hn(H,"CERTIFICATE");B.push(q)}}return{array:B,sortflag:!1}}},(typeof C>"u"||!C)&&(C={}),(typeof C.asn1>"u"||!C.asn1)&&(C.asn1={}),(typeof C.asn1.tsp>"u"||!C.asn1.tsp)&&(C.asn1.tsp={}),C.asn1.tsp.TimeStampToken=function(a){var l=C,u=l.asn1,f=u.tsp;f.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var x=new f.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=x.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.TimeStampToken,C.asn1.cms.SignedData),C.asn1.tsp.TSTInfo=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.DERInteger,y=u.DERBoolean,F=u.DERGeneralizedTime,D=u.DERObjectIdentifier,V=u.DERTaggedObject,U=u.tsp,W=U.MessageImprint,G=U.Accuracy;u.x509.X500Name;var A=u.x509.GeneralName;if(U.TSTInfo.superclass.constructor.call(this),this.dVersion=new x({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var B=[this.dVersion];if(this.dPolicy==null)throw new Error("policy shall be specified.");if(B.push(this.dPolicy),this.dMessageImprint==null)throw new Error("messageImprint shall be specified.");if(B.push(this.dMessageImprint),this.dSerial==null)throw new Error("serialNumber shall be specified.");if(B.push(this.dSerial),this.dGenTime==null)throw new Error("genTime shall be specified.");B.push(this.dGenTime),this.dAccuracy!=null&&B.push(this.dAccuracy),this.dOrdering!=null&&B.push(this.dOrdering),this.dNonce!=null&&B.push(this.dNonce),this.dTsa!=null&&B.push(this.dTsa);var O=new f({array:B});return this.hTLV=O.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0){if(typeof a.policy=="string"){if(!a.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new D({oid:a.policy})}a.messageImprint!==void 0&&(this.dMessageImprint=new W(a.messageImprint)),a.serial!==void 0&&(this.dSerial=new x(a.serial)),a.genTime!==void 0&&(this.dGenTime=new F(a.genTime)),a.accuracy!==void 0&&(this.dAccuracy=new G(a.accuracy)),a.ordering!==void 0&&a.ordering==!0&&(this.dOrdering=new y),a.nonce!==void 0&&(this.dNonce=new x(a.nonce)),a.tsa!==void 0&&(this.dTsa=new V({tag:"a0",explicit:!0,obj:new A({dn:a.tsa})}))}},Ue(C.asn1.tsp.TSTInfo,C.asn1.ASN1Object),C.asn1.tsp.Accuracy=function(a){var l=C,u=l.asn1,f=u.ASN1Util.newObject;u.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var x=this.params,y=[];return x.seconds!=null&&typeof x.seconds=="number"&&y.push({int:x.seconds}),x.millis!=null&&typeof x.millis=="number"&&y.push({tag:{tagi:"80",obj:{int:x.millis}}}),x.micros!=null&&typeof x.micros=="number"&&y.push({tag:{tagi:"81",obj:{int:x.micros}}}),f({seq:y}).tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.Accuracy,C.asn1.ASN1Object),C.asn1.tsp.MessageImprint=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.DEROctetString,y=u.x509,F=y.AlgorithmIdentifier;u.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var D=this.params,V=new F({name:D.alg}),U=new x({hex:D.hash}),W=new f({array:[V,U]});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.tsp.MessageImprint,C.asn1.ASN1Object),C.asn1.tsp.TimeStampReq=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.DERInteger,y=u.DERBoolean;u.ASN1Object;var F=u.DERObjectIdentifier,D=u.tsp,V=D.MessageImprint;D.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var U=this.params,W=[];W.push(new x({int:1})),U.messageImprint instanceof C.asn1.ASN1Object?W.push(U.messageImprint):W.push(new V(U.messageImprint)),U.policy!=null&&W.push(new F(U.policy)),U.nonce!=null&&W.push(new x(U.nonce)),U.certreq==!0&&W.push(new y);var G=new f({array:W});return G.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.TimeStampReq,C.asn1.ASN1Object),C.asn1.tsp.TimeStampResp=function(a){var l=C,u=l.asn1,f=u.DERSequence;u.ASN1Object;var x=u.tsp,y=x.PKIStatusInfo;x.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var F=this.params,D=[];if(F.econtent!=null||F.tst!=null)if(F.statusinfo!=null?D.push(new y(F.statusinfo)):D.push(new y("granted")),F.econtent!=null)D.push(new x.TimeStampToken(F).getContentInfo());else if(F.tst instanceof u.ASN1Object)D.push(F.tst);else throw new Error("improper member tst value");else if(F.statusinfo!=null)D.push(new y(F.statusinfo));else throw new Error("parameter for token nor statusinfo not specified");var V=new f({array:D});return V.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.TimeStampResp,C.asn1.ASN1Object),C.asn1.tsp.PKIStatusInfo=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence,y=f.tsp,F=y.PKIStatus,D=y.PKIFreeText,V=y.PKIFailureInfo;y.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var U=this.params,W=[];if(typeof U=="string")W.push(new F(U));else{if(U.status==null)throw new l("property 'status' unspecified");W.push(new F(U.status)),U.statusstr!=null&&W.push(new D(U.statusstr)),U.failinfo!=null&&W.push(new V(U.failinfo))}var G=new x({array:W});return G.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.PKIStatusInfo,C.asn1.ASN1Object),C.asn1.tsp.PKIStatus=function(a){var l=Error,u=C,f=u.asn1,x=f.DERInteger,y=f.tsp;y.PKIStatus.superclass.constructor.call(this);var F={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var D=this.params,V;if(typeof D=="string")try{V=F[D]}catch{throw new l("undefined name: "+D)}else if(typeof D=="number")V=D;else throw new l("unsupported params");return new x({int:V}).tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.PKIStatus,C.asn1.ASN1Object),C.asn1.tsp.PKIFreeText=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence,y=f.DERUTF8String,F=f.tsp;F.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var D=this.params;if(!D instanceof Array)throw new l("wrong params: not array");for(var V=[],U=0;U<D.length;U++)V.push(new y({str:D[U]}));var W=new x({array:V});return W.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.PKIFreeText,C.asn1.ASN1Object),C.asn1.tsp.PKIFailureInfo=function(a){var l=Error,u=C,f=u.asn1,x=f.DERBitString,y=f.tsp,F=y.PKIFailureInfo,D={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};F.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var V=this.params,U=0;if(typeof V=="number"&&0<=V&&V<=25){U|=1<<V;for(var W=U.toString(2),G="",A=W.length-1;A>=0;A--)G+=W[A];return G}else{if(typeof V=="string"&&D[V]!=null)return _c([V],D);if(typeof V=="object"&&V.length!=null)return _c(V,D);throw new l("wrong params")}},this.tohex=function(){this.params;var V=this.getBinValue();return new x({bin:V}).tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.tsp.PKIFailureInfo,C.asn1.ASN1Object),C.asn1.tsp.AbstractTSAAdapter=function(a){this.getTSTHex=function(l,u){throw"not implemented yet"}},C.asn1.tsp.SimpleTSAAdapter=function(a){var l=C,u=l.asn1,f=u.tsp,x=l.crypto.Util.hashHex;f.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(y,F){var D=x(y,F);this.params.econtent.content.messageImprint={alg:F,hash:D},this.params.econtent.content.serial={int:this.serial++};var V=Math.floor(Math.random()*1e9);this.params.econtent.content.nonce={int:V};var U=new f.TimeStampToken(this.params);return U.getContentInfoEncodedHex()},a!==void 0&&(this.params=a)},Ue(C.asn1.tsp.SimpleTSAAdapter,C.asn1.tsp.AbstractTSAAdapter),C.asn1.tsp.FixedTSAAdapter=function(a){var l=C,u=l.asn1,f=u.tsp,x=l.crypto.Util.hashHex;f.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(y,F){var D=x(y,F);this.params.econtent.content.messageImprint={alg:F,hash:D};var V=new f.TimeStampToken(this.params);return V.getContentInfoEncodedHex()},a!==void 0&&(this.params=a)},Ue(C.asn1.tsp.FixedTSAAdapter,C.asn1.tsp.AbstractTSAAdapter),C.asn1.tsp.TSPUtil=new function(){},C.asn1.tsp.TSPUtil.newTimeStampToken=function(a){return new C.asn1.tsp.TimeStampToken(a)},C.asn1.tsp.TSPUtil.parseTimeStampReq=function(a){var l=new C.asn1.tsp.TSPParser;return l.getTimeStampReq(a)},C.asn1.tsp.TSPUtil.parseMessageImprint=function(a){var l=new C.asn1.tsp.TSPParser;return l.getMessageImprint(a)},C.asn1.tsp.TSPParser=function(){var a=At,l=new a,u=Xe,f=u.getV,x=u.getTLV,y=u.getIdxbyList;u.getTLVbyListEx;var F=u.getChildIdx,D=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],V={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(U){var W=F(U,0);if(W.length==1)return this.getPKIStatusInfo(x(U,W[0]));if(W.length>1){var G=this.getPKIStatusInfo(x(U,W[0])),A=x(U,W[1]),B=this.getToken(A);return B.statusinfo=G,B}},this.getToken=function(U){var W=new C.asn1.cms.CMSParser,G=W.getCMSSignedData(U);return this.setTSTInfo(G),G},this.setTSTInfo=function(U){var W=U.econtent;if(W.type=="tstinfo"){var G=W.content.hex,A=this.getTSTInfo(G);W.content=A}},this.getTSTInfo=function(U){var W={},G=F(U,0),A=f(U,G[1]);W.policy=gc(A);var B=x(U,G[2]);W.messageImprint=this.getMessageImprint(B);var O=f(U,G[3]);W.serial={hex:O};var H=f(U,G[4]);W.genTime={str:gi(H)};var q=0;if(G.length>5&&U.substr(G[5],2)=="30"){var Z=x(U,G[5]);W.accuracy=this.getAccuracy(Z),q++}if(G.length>5+q&&U.substr(G[5+q],2)=="01"){var ce=f(U,G[5+q]);ce=="ff"&&(W.ordering=!0),q++}if(G.length>5+q&&U.substr(G[5+q],2)=="02"){var fe=f(U,G[5+q]);W.nonce={hex:fe},q++}if(G.length>5+q&&U.substr(G[5+q],2)=="a0"){var pe=x(U,G[5+q]);pe="30"+pe.substr(2),pGeneralNames=l.getGeneralNames(pe);var ge=pGeneralNames[0].dn;W.tsa=ge,q++}if(G.length>5+q&&U.substr(G[5+q],2)=="a1"){var Y=x(U,G[5+q]);Y="30"+Y.substr(2);var Q=l.getExtParamArray(Y);W.ext=Q,q++}return W},this.getAccuracy=function(U){for(var W={},G=F(U,0),A=0;A<G.length;A++){var B=U.substr(G[A],2),O=f(U,G[A]),H=parseInt(O,16);B=="02"?W.seconds=H:B=="80"?W.millis=H:B=="81"&&(W.micros=H)}return W},this.getMessageImprint=function(U){if(U.substr(0,2)!="30")throw new Error("head of messageImprint hex shall be x30");var W={};F(U,0);var G=y(U,0,[0,0]),A=f(U,G),B=u.hextooidstr(A),O=C.asn1.x509.OID.oid2name(B);if(O=="")throw new Error("hashAlg name undefined: "+B);var H=O,q=y(U,0,[1]);return W.alg=H,W.hash=f(U,q),W},this.getPKIStatusInfo=function(U){var W={},G=F(U,0),A=0;try{var B=f(U,G[0]),O=parseInt(B,16);W.status=D[O]}catch{}if(G.length>1&&U.substr(G[1],2)=="30"){var H=x(U,G[1]);W.statusstr=this.getPKIFreeText(H),A++}if(G.length>A&&U.substr(G[1+A],2)=="03"){var q=x(U,G[1+A]);W.failinfo=this.getPKIFailureInfo(q)}return W},this.getPKIFreeText=function(U){for(var W=[],G=F(U,0),A=0;A<G.length;A++)W.push(u.getString(U,G[A]));return W},this.getPKIFailureInfo=function(U){var W=u.getInt(U,0);return V[W]!=null?V[W]:W},this.getTimeStampReq=function(U){var W={};W.certreq=!1;var G=F(U,0);if(G.length<2)throw new Error("TimeStampReq must have at least 2 items");var A=x(U,G[1]);W.messageImprint=C.asn1.tsp.TSPUtil.parseMessageImprint(A);for(var B=2;B<G.length;B++){var O=G[B],H=U.substr(O,2);if(H=="06"){var q=f(U,O);W.policy=u.hextooidstr(q)}H=="02"&&(W.nonce=f(U,O)),H=="01"&&(W.certreq=!0)}return W}},(typeof C>"u"||!C)&&(C={}),(typeof C.asn1>"u"||!C.asn1)&&(C.asn1={}),(typeof C.asn1.cades>"u"||!C.asn1.cades)&&(C.asn1.cades={}),C.asn1.cades.SignaturePolicyIdentifier=function(a){var l=C,u=l.asn1,f=u.cades,x=f.SignaturePolicyId;f.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new x(this.params)]},this.setByParam=function(y){this.params=y},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.SignaturePolicyIdentifier,C.asn1.cms.Attribute),C.asn1.cades.SignaturePolicyId=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.DERObjectIdentifier,y=u.x509;y.AlgorithmIdentifier;var F=u.cades,D=F.SignaturePolicyId,V=F.OtherHashAlgAndValue;D.superclass.constructor.call(this),this.params=null,this.tohex=function(){var U=this.params,W=[];W.push(new x(U.oid)),W.push(new V(U));var G=new f({array:W});return G.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(U){this.params=U},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.SignaturePolicyId,C.asn1.ASN1Object),C.asn1.cades.OtherHashAlgAndValue=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence,y=f.DEROctetString,F=f.x509,D=F.AlgorithmIdentifier,V=f.cades,U=V.OtherHashAlgAndValue;U.superclass.constructor.call(this),this.params=null,this.tohex=function(){var W=this.params;if(W.alg==null)throw new l("property 'alg' not specified");if(W.hash==null&&W.cert==null)throw new l("property 'hash' nor 'cert' not specified");var G=null;if(W.hash!=null)G=W.hash;else if(W.cert!=null){if(typeof W.cert!="string")throw new l("cert not string");var A=W.cert;W.cert.indexOf("-----BEGIN")!=-1&&(A=Ui(W.cert)),G=C.crypto.Util.hashHex(A,W.alg)}var B=[];B.push(new D({name:W.alg})),B.push(new y({hex:G}));var O=new x({array:B});return O.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.OtherHashAlgAndValue,C.asn1.ASN1Object),C.asn1.cades.OtherHashValue=function(a){C.asn1.cades.OtherHashValue.superclass.constructor.call(this);var l=Error,u=C;u.lang.String.isHex;var f=u.asn1,x=f.DEROctetString;u.crypto.Util.hashHex,this.params=null,this.tohex=function(){var y=this.params;if(y.hash==null&&y.cert==null)throw new l("hash or cert not specified");var F=null;if(y.hash!=null)F=y.hash;else if(y.cert!=null){if(typeof y.cert!="string")throw new l("cert not string");var D=y.cert;y.cert.indexOf("-----BEGIN")!=-1&&(D=Ui(y.cert)),F=C.crypto.Util.hashHex(D,"sha1")}return new x({hex:F}).tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.OtherHashValue,C.asn1.ASN1Object),C.asn1.cades.SignatureTimeStamp=function(a){var l=Error,u=C,f=u.lang.String.isHex,x=u.asn1,y=x.ASN1Object;x.x509;var F=x.cades;F.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var D=this.params;if(D.tst!=null)if(f(D.tst)){var V=new y;return V.hTLV=D.tst,[V]}else{if(D.tst instanceof y)return[D.tst];throw new l("params.tst has wrong value")}else if(D.res!=null){var U=D.res;if(U instanceof y&&(U=U.tohex()),typeof U!="string"||!f(U))throw new l("params.res has wrong value");Xe.getTLVbyList(U,0,[1]);var V=new y;return V.hTLV=D.tst,[V]}},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.SignatureTimeStamp,C.asn1.cms.Attribute),C.asn1.cades.CompleteCertificateRefs=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence,y=f.cades,F=y.OtherCertID,D=u.lang.String.isHex;y.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var V=this.params,U=[],W=0;W<V.array.length;W++){var G=V.array[W];if(typeof G=="string")if(G.indexOf("-----BEGIN")!=-1)G={cert:G};else if(D(G))G={hash:G};else throw new l("unsupported value: "+G);V.alg!=null&&G.alg==null&&(G.alg=V.alg),V.hasis!=null&&G.hasis==null&&(G.hasis=V.hasis);var A=new F(G);U.push(A)}var B=new x({array:U});return[B]},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.CompleteCertificateRefs,C.asn1.cms.Attribute),C.asn1.cades.OtherCertID=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.cms,y=x.IssuerSerial,F=u.cades,D=F.OtherHashValue,V=F.OtherHashAlgAndValue;F.OtherCertID.superclass.constructor.call(this),this.params=a,this.tohex=function(){var U=this.params;typeof U=="string"&&(U.indexOf("-----BEGIN")!=-1?U={cert:U}:_isHex(U)&&(U={hash:U}));var W=[],G=null;if(U.alg!=null?G=new V(U):G=new D(U),W.push(G),U.cert!=null&&U.hasis==!0||U.issuer!=null&&U.serial!=null){var A=new y(U);W.push(A)}var B=new f({array:W});return B.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.OtherCertID,C.asn1.ASN1Object),C.asn1.cades.OtherHash=function(a){var l=C,u=l.asn1;u.cms;var f=u.cades,x=f.OtherHashAlgAndValue,y=f.OtherHashValue;l.crypto.Util.hashHex;var F=l.lang.String.isHex;f.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var D=this.params;typeof D=="string"&&(D.indexOf("-----BEGIN")!=-1?D={cert:D}:F(D)&&(D={hash:D}));var V=null;return D.alg!=null?V=new x(D):V=new y(D),V.tohex()},this.getEncodedHex=function(){return this.tohex()},a!=null&&this.setByParam(a)},Ue(C.asn1.cades.OtherHash,C.asn1.ASN1Object),C.asn1.cades.CAdESUtil=new function(){},C.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(a){var l=new C.asn1.cms.CMSParser,u=l.getCMSSignedData(a);return u},C.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(a,l,u){var f=Xe,x=f.getChildIdx,y=f.getTLV,F=f.getV,D=C,V=D.asn1,U=V.ASN1Object,W=V.cms,G=W.AttributeList,A=W.SignerInfo,B={},O=x(a,l);if(O.length!=6)throw"not supported items for SignerInfo (!=6)";var H=O.shift();B.version=y(a,H);var q=O.shift();B.si=y(a,q);var Z=O.shift();B.digalg=y(a,Z);var ce=O.shift();B.sattrs=y(a,ce);var fe=O.shift();B.sigalg=y(a,fe);var pe=O.shift();B.sig=y(a,pe),B.sigval=F(a,pe);var ge=null;return B.obj=new A,ge=new U,ge.hTLV=B.version,B.obj.dCMSVersion=ge,ge=new U,ge.hTLV=B.si,B.obj.dSignerIdentifier=ge,ge=new U,ge.hTLV=B.digalg,B.obj.dDigestAlgorithm=ge,ge=new U,ge.hTLV=B.sattrs,B.obj.dSignedAttrs=ge,ge=new U,ge.hTLV=B.sigalg,B.obj.dSigAlg=ge,ge=new U,ge.hTLV=B.sig,B.obj.dSig=ge,B.obj.dUnsignedAttrs=new G,B},(typeof C.asn1.csr>"u"||!C.asn1.csr)&&(C.asn1.csr={}),C.asn1.csr.CertificationRequest=function(a){var l=C,u=l.asn1,f=u.DERBitString,x=u.DERSequence,y=u.csr;u.x509;var F=y.CertificationRequestInfo;y.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(D){this.params=D},this.sign=function(){var D=new F(this.params).tohex(),V=new C.crypto.Signature({alg:this.params.sigalg});V.init(this.params.sbjprvkey),V.updateHex(D);var U=V.sign();this.params.sighex=U},this.getPEM=function(){return hn(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var D=this.params,V=new C.asn1.csr.CertificationRequestInfo(this.params),U=new C.asn1.x509.AlgorithmIdentifier({name:D.sigalg});if(D.sighex==null&&D.sbjprvkey!=null&&this.sign(),D.sighex==null)throw new Error("sighex or sbjprvkey parameter not defined");var W=new f({hex:"00"+D.sighex}),G=new x({array:[V,U,W]});return G.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.csr.CertificationRequest,C.asn1.ASN1Object),C.asn1.csr.CertificationRequestInfo=function(a){var l=C,u=l.asn1;u.DERBitString;var f=u.DERSequence,x=u.DERInteger,y=u.DERUTF8String,F=u.DERTaggedObject,D=u.ASN1Util.newObject,V=u.csr,U=u.x509,W=U.X500Name,G=U.Extensions,A=U.SubjectPublicKeyInfo;V.AttributeList,V.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(O){O!=null&&(this.params=O)},this.tohex=function(){var O=this.params,H=[];if(H.push(new x({int:0})),H.push(new W(O.subject)),H.push(new A(Yt.getKey(O.sbjpubkey))),O.attrs!=null){var q=B(O.attrs),Z=D({tag:{tage:"a0",obj:q}});H.push(Z)}else if(O.extreq!=null){var ce=new G(O.extreq),Z=D({tag:{tage:"a0",obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[ce]}]}}});H.push(Z)}else H.push(new F({tag:"a0",explicit:!1,obj:new y({str:""})}));var fe=new f({array:H});return fe.tohex()},this.getEncodedHex=function(){return this.tohex()};function B(O){for(var H=Error,q=C.asn1.x509.Extensions,Z=[],ce=0;ce<O.length;ce++){var fe=O[ce],pe=fe.attr;if(pe=="extensionRequest"){var ge=new q(fe.ext),Y={seq:[{oid:"1.2.840.113549.1.9.14"},{set:[ge]}]};Z.push(Y)}else if(pe=="unstructuredName"){var Y={seq:[{oid:"1.2.840.113549.1.9.2"},{set:fe.names}]};Z.push(Y)}else if(pe=="challengePassword"){var Y={seq:[{oid:"1.2.840.113549.1.9.7"},{set:[{utf8str:fe.password}]}]};Z.push(Y)}else throw new H("unknown CSR attribute")}return{set:Z}}a!=null&&this.setByParam(a)},Ue(C.asn1.csr.CertificationRequestInfo,C.asn1.ASN1Object),C.asn1.csr.AttributeList=function(a){},Ue(C.asn1.csr.AttributeList,C.asn1.ASN1Object),C.asn1.csr.CSRUtil=new function(){},C.asn1.csr.CSRUtil.newCSRPEM=function(a){var l=C.asn1.csr,u=new l.CertificationRequest(a),f=u.getPEM();return f},C.asn1.csr.CSRUtil.getParam=function(a,l){var u=Xe,f=u.getV,x=u.getIdxbyList,y=u.getTLVbyList,F=u.getTLVbyListEx,D=u.getVbyListEx,V=function(ce){var fe=x(ce,0,[0,3,0,0],"06");return f(ce,fe)!="2a864886f70d01090e"?null:y(ce,0,[0,3,0,1,0],"30")},U={};if(a.indexOf("-----BEGIN CERTIFICATE REQUEST")==-1)throw new Error("argument is not PEM file");var W=Ui(a,"CERTIFICATE REQUEST");l&&(U.tbs=y(W,0,[0]));try{var G=F(W,0,[0,1]);if(G=="3000")U.subject={};else{var H=new At;U.subject=H.getX500Name(G)}}catch{}var A=F(W,0,[0,2]),B=Yt.getKey(A,null,"pkcs8pub");U.sbjpubkey=Yt.getPEM(B,"PKCS8PUB");var O=V(W),H=new At;O!=null&&(U.extreq=H.getExtParamArray(O));try{var q=F(W,0,[1],"30"),H=new At;U.sigalg=H.getAlgorithmIdentifierName(q)}catch{}try{var Z=D(W,0,[2]);U.sighex=Z}catch{}return U},C.asn1.csr.CSRUtil.verifySignature=function(a){try{var l=null;if(typeof a=="string"&&a.indexOf("-----BEGIN CERTIFICATE REQUEST")!=-1?l=C.asn1.csr.CSRUtil.getParam(a,!0):typeof a=="object"&&a.sbjpubkey!=null&&a.sigalg!=null&&a.sighex!=null&&a.tbs!=null&&(l=a),l==null)return!1;var u=new C.crypto.Signature({alg:l.sigalg});return u.init(l.sbjpubkey),u.updateHex(l.tbs),u.verify(l.sighex)}catch(f){return alert(f),!1}},(typeof C>"u"||!C)&&(C={}),(typeof C.asn1>"u"||!C.asn1)&&(C.asn1={}),(typeof C.asn1.ocsp>"u"||!C.asn1.ocsp)&&(C.asn1.ocsp={}),C.asn1.ocsp.DEFAULT_HASH="sha1",C.asn1.ocsp.OCSPResponse=function(a){C.asn1.ocsp.OCSPResponse.superclass.constructor.call(this),C.asn1.DEREnumerated;var l=C.asn1.ASN1Util.newObject,u=C.asn1.ocsp.ResponseBytes,f=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var x=this.params.resstatus;return typeof x=="number"?x:typeof x!="string"?-1:f.indexOf(x)},this.setByParam=function(x){this.params=x},this.tohex=function(){var x=this.params,y=this._getStatusCode();if(y==-1)throw new Error("responseStatus not supported: "+x.resstatus);if(y!=0)return l({seq:[{enum:{int:y}}]}).tohex();var F=new u(x);return l({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:F}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.OCSPResponse,C.asn1.ASN1Object),C.asn1.ocsp.ResponseBytes=function(a){C.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var l=C.asn1,u=l.DERSequence,f=l.DERObjectIdentifier,x=l.DEROctetString,y=l.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(F){this.params=F},this.tohex=function(){var F=this.params;if(F.restype!="ocspBasic")throw new Error("not supported responseType: "+F.restype);var D=new y(F),V=[];V.push(new f({name:"ocspBasic"})),V.push(new x({hex:D.tohex()}));var U=new u({array:V});return U.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.ResponseBytes,C.asn1.ASN1Object),C.asn1.ocsp.BasicOCSPResponse=function(a){C.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var l=Error,u=C.asn1,f=u.ASN1Object,x=u.DERSequence;u.DERGeneralizedTime;var y=u.DERTaggedObject,F=u.DERBitString;u.x509.Extensions;var D=u.x509.AlgorithmIdentifier,V=u.ocsp;V.ResponderID,_SingleResponseList=V.SingleResponseList,_ResponseData=V.ResponseData,this.params=null,this.setByParam=function(U){this.params=U},this.sign=function(){var U=this.params,W=U.tbsresp.tohex(),G=new C.crypto.Signature({alg:U.sigalg});G.init(U.reskey),G.updateHex(W),U.sighex=G.sign()},this.tohex=function(){var U=this.params;U.tbsresp==null&&(U.tbsresp=new _ResponseData(U)),U.sighex==null&&U.reskey!=null&&this.sign();var W=[];if(W.push(U.tbsresp),W.push(new D({name:U.sigalg})),W.push(new F({hex:"00"+U.sighex})),U.certs!=null&&U.certs.length!=null){for(var G=[],A=0;A<U.certs.length;A++){var B=U.certs[A],O=null;if(Xe.isASN1HEX(B))O=B;else if(B.match(/-----BEGIN/))O=Ui(B);else throw new l("certs["+A+"] not hex or PEM");G.push(new f({tlv:O}))}var H=new x({array:G});W.push(new y({tag:"a0",explicit:!0,obj:H}))}var q=new x({array:W});return q.tohex()},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.BasicOCSPResponse,C.asn1.ASN1Object),C.asn1.ocsp.ResponseData=function(a){C.asn1.ocsp.ResponseData.superclass.constructor.call(this);var l=C.asn1,u=l.DERSequence,f=l.DERGeneralizedTime,x=l.DERTaggedObject,y=l.x509.Extensions,F=l.ocsp,D=F.ResponderID;_SingleResponseList=F.SingleResponseList,this.params=null,this.tohex=function(){var V=this.params;V.respid!=null,V.prodat!=null,V.array!=null;var U=[];if(U.push(new D(V.respid)),U.push(new f(V.prodat)),U.push(new _SingleResponseList(V.array)),V.ext!=null){var W=new y(V.ext);U.push(new x({tag:"a1",explicit:!0,obj:W}))}var G=new u({array:U});return G.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(V){this.params=V},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.ResponseData,C.asn1.ASN1Object),C.asn1.ocsp.ResponderID=function(a){C.asn1.ocsp.ResponderID.superclass.constructor.call(this);var l=C,u=l.asn1,f=u.ASN1Util.newObject,x=u.x509.X500Name,y=l.lang.String.isHex,F=Error;this.params=null,this.tohex=function(){var D=this.params;if(D.key!=null){var V=null;if(typeof D.key=="string"){if(y(D.key)&&(V=D.key),D.key.match(/-----BEGIN CERTIFICATE/)){var U=new At(D.key),W=U.getExtSubjectKeyIdentifier();W!=null&&(V=W.kid.hex)}}else if(D.key instanceof At){var W=D.key.getExtSubjectKeyIdentifier();W!=null&&(V=W.kid.hex)}if(V==null)throw new F("wrong key member value");var G=f({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:V}}}});return G.tohex()}else if(D.name!=null){var A=null;if(typeof D.name=="string"&&D.name.match(/-----BEGIN CERTIFICATE/)){var U=new At(D.name);A=U.getSubject()}else D.name instanceof At?A=D.name.getSubject():typeof D.name=="object"&&(D.name.array!=null||D.name.str!=null)&&(A=D.name);if(A==null)throw new F("wrong name member value");var G=f({tag:{tag:"a1",explicit:!0,obj:new x(A)}});return G.tohex()}throw new F("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(D){this.params=D},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.ResponderID,C.asn1.ASN1Object),C.asn1.ocsp.SingleResponseList=function(a){C.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var l=C.asn1,u=l.DERSequence,f=l.ocsp.SingleResponse;this.params=null,this.tohex=function(){var x=this.params;if(typeof x!="object"||x.length==null)throw new Error("params not specified properly");for(var y=[],F=0;F<x.length;F++)y.push(new f(x[F]));var D=new u({array:y});return D.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(x){this.params=x},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.SingleResponseList,C.asn1.ASN1Object),C.asn1.ocsp.SingleResponse=function(a){var l=Error,u=C,f=u.asn1,x=f.DERSequence,y=f.DERGeneralizedTime,F=f.DERTaggedObject,D=f.ocsp,V=D.CertID,U=D.CertStatus,W=f.x509,G=W.Extensions;D.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var A=this.params,B=[];if(A.certid==null)throw new l("certid unspecified");if(A.status==null)throw new l("status unspecified");if(A.thisupdate==null)throw new l("thisupdate unspecified");if(B.push(new V(A.certid)),B.push(new U(A.status)),B.push(new y(A.thisupdate)),A.nextupdate!=null){var O=new y(A.nextupdate);B.push(new F({tag:"a0",explicit:!0,obj:O}))}if(A.ext!=null){var H=new G(A.ext);B.push(new F({tag:"a1",explicit:!0,obj:H}))}var q=new x({array:B});return q.tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(A){this.params=A},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.SingleResponse,C.asn1.ASN1Object),C.asn1.ocsp.CertID=function(a){var l=C,u=l.asn1,f=u.DEROctetString,x=u.DERInteger,y=u.DERSequence,F=u.x509,D=F.AlgorithmIdentifier,V=u.ocsp;V.DEFAULT_HASH;var U=l.crypto,W=U.Util.hashHex,G=At,A=Xe,B=A.getVbyList;V.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(O,H,q,Z){Z==null&&(Z=this.DEFAULT_HASH),this.params={alg:Z,issname:O,isskey:H,sbjsn:q}},this.setByCert=function(O,H,q){q==null&&(q=this.DEFAULT_HASH),this.params={alg:q,issuerCert:O,subjectCert:H}},this.getParamByCerts=function(O,H,q){q==null&&(q=this.DEFAULT_HASH);var Z=new G(O),ce=new G(H),fe=W(Z.getSubjectHex(),q),pe=Z.getPublicKeyHex(),ge=W(B(pe,0,[1],"03",!0),q),Y=ce.getSerialNumberHex(),Q={alg:q,issname:fe,isskey:ge,sbjsn:Y};return Q},this.tohex=function(){if(typeof this.params!="object")throw new Error("params not set");var O=this.params,H,q,Z,ce;if(O.alg==null?ce=this.DEFAULT_HASH:ce=O.alg,O.issuerCert!=null&&O.subjectCert!=null){var fe=this.getParamByCerts(O.issuerCert,O.subjectCert,ce);H=fe.issname,q=fe.isskey,Z=fe.sbjsn}else if(O.issname!=null&&O.isskey!=null&&O.sbjsn!=null)H=O.issname,q=O.isskey,Z=O.sbjsn;else throw new Error("required param members not defined");var pe=new D({name:ce}),ge=new f({hex:H}),Y=new f({hex:q}),Q=new x({hex:Z}),re=new y({array:[pe,ge,Y,Q]});return this.hTLV=re.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.CertID,C.asn1.ASN1Object),C.asn1.ocsp.CertStatus=function(a){C.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var l=this.params;if(l.status=="good")return"8000";if(l.status=="unknown")return"8200";if(l.status=="revoked"){var u=[{gentime:{str:l.time}}];l.reason!=null&&u.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:l.reason}}}});var f={tag:"a1",explicit:!1,obj:{seq:u}};return C.asn1.ASN1Util.newObject({tag:f}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(l){this.params=l},a!==void 0&&this.setByParam(a)},Ue(C.asn1.ocsp.CertStatus,C.asn1.ASN1Object),C.asn1.ocsp.Request=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.ocsp;if(x.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var F=[];if(this.dReqCert===null)throw"reqCert not set";F.push(this.dReqCert);var D=new f({array:F});return this.hTLV=D.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},typeof a<"u"){var y=new x.CertID(a);this.dReqCert=y}},Ue(C.asn1.ocsp.Request,C.asn1.ASN1Object),C.asn1.ocsp.TBSRequest=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.ocsp;x.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(y){for(var F=[],D=0;D<y.length;D++){var V=new x.Request(y[0]);F.push(V)}this.dRequestList=F},this.tohex=function(){var y=[];if(this.version!==0)throw"not supported version: "+this.version;if(this.dRequestorName!==null)throw"requestorName not supported";var F=new f({array:this.dRequestList});if(y.push(F),this.dRequestExt!==null)throw"requestExtensions not supported";var D=new f({array:y});return this.hTLV=D.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&a.reqList!==void 0&&this.setRequestListByParam(a.reqList)},Ue(C.asn1.ocsp.TBSRequest,C.asn1.ASN1Object),C.asn1.ocsp.OCSPRequest=function(a){var l=C,u=l.asn1,f=u.DERSequence,x=u.ocsp;if(x.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var F=[];if(this.dTbsRequest!==null)F.push(this.dTbsRequest);else throw"tbsRequest not set";if(this.dOptionalSignature!==null)throw"optionalSignature not supported";var D=new f({array:F});return this.hTLV=D.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},a!==void 0&&a.reqList!==void 0){var y=new x.TBSRequest(a);this.dTbsRequest=y}},Ue(C.asn1.ocsp.OCSPRequest,C.asn1.ASN1Object),C.asn1.ocsp.OCSPUtil={},C.asn1.ocsp.OCSPUtil.getRequestHex=function(a,l,u){var f=C,x=f.asn1,y=x.ocsp;u===void 0&&(u=y.DEFAULT_HASH);var F={alg:u,issuerCert:a,subjectCert:l},D=new y.OCSPRequest({reqList:[F]});return D.tohex()},C.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(a){var l=Xe,u=l.getVbyList,f=l.getVbyListEx,x=l.getIdxbyList;l.getIdxbyListEx;var y=l.getV,F={};try{var D=f(a,0,[0],"0a");F.responseStatus=parseInt(D,16)}catch{}if(F.responseStatus!==0)return F;try{var V=x(a,0,[1,0,1,0,0,2,0,1]);a.substr(V,2)==="80"?F.certStatus="good":a.substr(V,2)==="a1"?(F.certStatus="revoked",F.revocationTime=gi(u(a,V,[0]))):a.substr(V,2)==="82"&&(F.certStatus="unknown")}catch{}try{var U=x(a,0,[1,0,1,0,0,2,0,2]);F.thisUpdate=gi(y(a,U))}catch{}try{var W=x(a,0,[1,0,1,0,0,2,0,3]);a.substr(W,2)==="a0"&&(F.nextUpdate=gi(u(a,W,[0])))}catch{}return F},C.asn1.ocsp.OCSPParser=function(){var a=Error,l=At,u=new l,f=Xe,x=f.getV,y=f.getTLV,F=f.getIdxbyList,D=f.getVbyList,V=f.getTLVbyList,U=f.getVbyListEx,W=f.getTLVbyListEx,G=f.getChildIdx;this.getOCSPRequest=function(A){var B=G(A,0);if(B.length!=1&&B.length!=2)throw new a("wrong number elements: "+B.length);var O=this.getTBSRequest(y(A,B[0]));return O},this.getTBSRequest=function(A){var B={},O=W(A,0,[0],"30");B.array=this.getRequestList(O);var H=W(A,0,["[2]",0],"30");return H!=null&&(B.ext=u.getExtParamArray(H)),B},this.getRequestList=function(A){for(var B=[],O=G(A,0),H=0;H<O.length;H++){var A=y(A,O[H]);B.push(this.getRequest(A))}return B},this.getRequest=function(A){var B=G(A,0);if(B.length!=1&&B.length!=2)throw new a("wrong number elements: "+B.length);var O=this.getCertID(y(A,B[0]));if(B.length==2){var H=F(A,0,[1,0]);O.ext=u.getExtParamArray(y(A,H))}return O},this.getCertID=function(A){var B=G(A,0);if(B.length!=4)throw new a("wrong number elements: "+B.length);var O=new l,H={};return H.alg=O.getAlgorithmIdentifierName(y(A,B[0])),H.issname=x(A,B[1]),H.isskey=x(A,B[2]),H.sbjsn=x(A,B[3]),H},this.getOCSPResponse=function(A){var B=G(A,0),O,H=x(A,B[0]),q=parseInt(H);if(B.length==1)return{resstatus:q};var Z=V(A,0,[1,0]);return O=this.getResponseBytes(Z),O.resstatus=q,O},this.getResponseBytes=function(A){var B=G(A,0),O,H=V(A,0,[1,0]);O=this.getBasicOCSPResponse(H);var q=x(A,B[0]);return O.restype=C.asn1.x509.OID.oid2name(gc(q)),O},this.getBasicOCSPResponse=function(A){var B=G(A,0),O;O=this.getResponseData(y(A,B[0]));var H=new At;O.alg=H.getAlgorithmIdentifierName(y(A,B[1]));var q=x(A,B[2]);O.sighex=q.substr(2);var Z=U(A,0,["[0]"]);if(Z!=null){for(var ce=G(Z,0),fe=[],pe=0;pe<ce.length;pe++){var ge=y(Z,ce[pe]);fe.push(ge)}O.certs=fe}return O},this.getResponseData=function(A){var B=G(A,0),O=B.length,H={},q=0;A.substr(B[0],2)=="a0"&&q++,H.respid=this.getResponderID(y(A,B[q++]));var Z=x(A,B[q++]);if(H.prodat=gi(Z),H.array=this.getSingleResponseList(y(A,B[q++])),A.substr(B[O-1],2)=="a1"){var ce=V(A,B[O-1],[0]),fe=new At;H.ext=fe.getExtParamArray(ce)}return H},this.getResponderID=function(A){var B={};if(A.substr(0,2)=="a2"){var O=D(A,0,[0]);B.key=O}if(A.substr(0,2)=="a1"){var H=V(A,0,[0]),q=new At;B.name=q.getX500Name(H)}return B},this.getSingleResponseList=function(A){for(var B=G(A,0),O=[],H=0;H<B.length;H++){var q=this.getSingleResponse(y(A,B[H]));O.push(q)}return O},this.getSingleResponse=function(A){var B=G(A,0),O={},H=this.getCertID(y(A,B[0]));O.certid=H;var q=this.getCertStatus(y(A,B[1]));if(O.status=q,A.substr(B[2],2)=="18"){var Z=x(A,B[2]);O.thisupdate=gi(Z)}for(var ce=3;ce<B.length;ce++){if(A.substr(B[ce],2)=="a0"){var fe=D(A,B[ce],[0],"18");O.nextupdate=gi(fe)}if(A.substr(B[ce],2)=="a1"){var pe=new At,ge=V(A,0,[ce,0]);O.ext=pe.getExtParamArray(ge)}}return O},this.getCertStatus=function(A){var B={};if(A=="8000")return{status:"good"};if(A=="8200")return{status:"unknown"};if(A.substr(0,2)=="a1"){B.status="revoked";var O=D(A,0,[0]),H=gi(O);B.time=H}return B}};var C;(typeof C>"u"||!C)&&(C={}),(typeof C.lang>"u"||!C.lang)&&(C.lang={}),C.lang.String=function(){};function Kh(a){for(var l=new Array,u=0;u<a.length;u++)l[u]=a.charCodeAt(u);return l}function Xh(a){for(var l="",u=0;u<a.length;u++)l=l+String.fromCharCode(a[u]);return l}function lc(a){for(var l="",u=0;u<a.length;u++){var f=a[u].toString(16);f.length==1&&(f="0"+f),l=l+f}return l}function An(a){return lc(Kh(a))}function E_(a){return h(An(a))}function C_(a){return pa(h(An(a)))}function T_(a){return Xh(p(ao(a)))}function pa(a){return a=a.replace(/\=/g,""),a=a.replace(/\+/g,"-"),a=a.replace(/\//g,"_"),a}function ao(a){return a.length%4==2?a=a+"==":a.length%4==3&&(a=a+"="),a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),a}function Yi(a){return a.length%2==1&&(a="0"+a),pa(h(a))}function Pi(a){return d(ao(a))}var oo,lr;typeof Buffer=="function"?(oo=function(a){return pa(Buffer.from(a,"utf8").toString("base64"))},lr=function(a){return Buffer.from(ao(a),"base64").toString("utf8")}):(oo=function(a){return Yi(hc(mc(a)))},lr=function(a){return decodeURIComponent(pc(Pi(a)))});function R_(a){return h(hc(mc(a)))}function M_(a){return decodeURIComponent(pc(d(a)))}function dc(a){return hc(mc(a)).toLowerCase()}function gi(a){try{return decodeURIComponent(pc(a))}catch{return null}}function P_(a){return gi(A_(a))}function A_(a){for(var l=a.match(/.{1,2}/g),u=[],f=0;f<l.length;f++){var x=parseInt(l[f],16);161<=x&&x<=191?(u.push("c2"),u.push(l[f])):192<=x&&x<=255?(u.push("c3"),u.push((x-64).toString(16))):u.push(l[f])}return u.join("")}function Dn(a){for(var l="",u=0;u<a.length-1;u+=2)l+=String.fromCharCode(parseInt(a.substr(u,2),16));return l}function Ar(a){for(var l="",u=0;u<a.length;u++)l+=("0"+a.charCodeAt(u).toString(16)).slice(-2);return l}function nd(a){return h(a)}function D_(a){return uc(nd(a),64)}function uc(a,l){return a=a.replace(new RegExp("(.{"+l+"})","g"),`$1\r
`),a=a.replace(/\s+$/,""),a}function $h(a){var l=a.replace(/[^0-9A-Za-z\/+=]*/g,""),u=d(l);return u}function I_(a,l){return"-----BEGIN "+l+`-----\r
`+uc(a,64)+`\r
-----END `+l+`-----\r
`}function hn(a,l){return"-----BEGIN "+l+`-----\r
`+uc(nd(a),64)+`\r
-----END `+l+`-----\r
`}function Ui(a,l){if(a.indexOf("-----BEGIN ")==-1)throw new Error("can't find PEM header");return l!==void 0?(a=a.replace(new RegExp("^[^]*-----BEGIN "+l+"-----"),""),a=a.replace(new RegExp("-----END "+l+"-----[^]*$"),"")):(a=a.replace(/^[^]*-----BEGIN [^-]+-----/,""),a=a.replace(/-----END [^-]+-----[^]*$/,"")),$h(a)}function F_(a){return a.indexOf("-----BEGIN ")==-1||a.indexOf("-----END ")==-1?null:(a=a.replace(/^[\s\S]*?-----BEGIN [^-]+-----/m,""),a=a.replace(/-----END [\s\S]+$/m,""),a=a.replace(/\s+/g,""),a.match(/^[0-9a-zA-Z+/=]+$/)?a:null)}function N_(a){if(a.length%2!=0)throw"input is not even length";if(a.match(/^[0-9A-Fa-f]+$/)==null)throw"input is not hexadecimal";for(var l=new ArrayBuffer(a.length/2),u=new DataView(l),f=0;f<a.length/2;f++)u.setUint8(f,parseInt(a.substr(f*2,2),16));return l}function L_(a){for(var l="",u=new DataView(a),f=0;f<a.byteLength;f++)l+=("00"+u.getUint8(f).toString(16)).slice(-2);return l}function rd(a){var l,u,f,x,y,F,D,V,U,W;if(a=Yh(a),W=a.match(/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/),W)return l=parseInt(W[1]),u=parseInt(W[2])-1,f=parseInt(W[3]),x=parseInt(W[4]),y=parseInt(W[5]),F=parseInt(W[6]),D=0,V=W[7],V!==""&&(U=(V.substr(1)+"00").substr(0,3),D=parseInt(U)),Date.UTC(l,u,f,x,y,F,D);throw new Error("unsupported zulu format: "+a)}function O_(a){var l=new Date(a),u=("0000"+l.getUTCFullYear()).slice(-4),f=("00"+(l.getUTCMonth()+1)).slice(-2),x=("00"+l.getUTCDate()).slice(-2),y=("00"+l.getUTCHours()).slice(-2),F=("00"+l.getUTCMinutes()).slice(-2),D=("00"+l.getUTCSeconds()).slice(-2),V=("000"+l.getUTCMilliseconds()).slice(-3);return V=V.replace(/0+$/,""),V=V!=""?"."+V:V,u+f+x+y+F+D+V+"Z"}function Zh(a){return Math.round(rd(a)/1e3)}function k_(a){return new Date(rd(a))}function U_(a,l,u){var f,x=a.getUTCFullYear();if(l){if(x<1950||2049<x)throw"not proper year for UTCTime: "+x;f=(""+x).slice(-2)}else f=("000"+x).slice(-4);if(f+=("0"+(a.getUTCMonth()+1)).slice(-2),f+=("0"+a.getUTCDate()).slice(-2),f+=("0"+a.getUTCHours()).slice(-2),f+=("0"+a.getUTCMinutes()).slice(-2),f+=("0"+a.getUTCSeconds()).slice(-2),u){var y=a.getUTCMilliseconds();y!==0&&(y=("00"+y).slice(-3),y=y.replace(/0+$/g,""),f+="."+y)}return f+="Z",f}function Yh(a){return a.match(/^[0-9]{12}Z$/)||a.match(/^[0-9]{12}[.][0-9]*Z$/)?a.match(/^[0-4]/)?"20"+a:"19"+a:a}function hc(a){return a.replace(/%/g,"")}function pc(a){return a.replace(/(..)/g,"%$1")}function sd(a){var l="malformed IPv6 address";if(!a.match(/^[0-9A-Fa-f:]+$/))throw l;a=a.toLowerCase();var u=a.split(":").length-1;if(u<2)throw l;var f=":".repeat(7-u+2);a=a.replace("::",f);var x=a.split(":");if(x.length!=8)throw l;for(var y=0;y<8;y++)x[y]=("0000"+x[y]).slice(-4);return x.join("")}function ad(a){if(!a.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+a);a=a.toLowerCase();var l=a.match(/.{1,4}/g);l=l.map(function(x){return x.replace(/^0+/,"")}),l=l.map(function(x){return x==""?"0":x}),a=":"+l.join(":")+":";var u=a.match(/:(0:){2,}/g);if(u==null)return a.slice(1,-1);var f=u.sort().slice(-1)[0];return a=a.replace(f.substr(0,f.length-1),":"),a.substr(0,2)!="::"&&(a=a.substr(1)),a.substr(-2,2)!="::"&&(a=a.substr(0,a.length-1)),a}function fc(a){var l=new Error("malformed hex value");if(!a.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw l;if(a.length==8){var u;try{return u=parseInt(a.substr(0,2),16)+"."+parseInt(a.substr(2,2),16)+"."+parseInt(a.substr(4,2),16)+"."+parseInt(a.substr(6,2),16),u}catch{throw l}}else if(a.length==16)try{return fc(a.substr(0,8))+"/"+Jh(a.substr(8))}catch{throw l}else{if(a.length==32)return ad(a);if(a.length==64){try{return ad(a.substr(0,32))+"/"+Jh(a.substr(32))}catch{throw l}return}else return a}}function Jh(a){var l=new Error("malformed mask"),u;try{u=new g(a,16).toString(2)}catch{throw l}if(!u.match(/^1*0*$/))throw l;return u.replace(/0+$/,"").length}function od(a){var l=new Error("malformed IP address");if(a=a.toLowerCase(a),!a.match(/^[0-9a-f.:/]+$/))throw l;if(a.match(/^[0-9.]+$/)){var u=a.split(".");if(u.length!==4)throw l;var f="";try{for(var x=0;x<4;x++){var y=parseInt(u[x]);f+=("0"+y.toString(16)).slice(-2)}return f}catch{throw l}}else if(a.match(/^[0-9.]+\/[0-9]+$/)){var F=a.split("/");return od(F[0])+Qh(parseInt(F[1]),32)}else{if(a.match(/^[0-9a-f:]+$/)&&a.indexOf(":")!==-1)return sd(a);if(a.match(/^[0-9a-f:]+\/[0-9]+$/)&&a.indexOf(":")!==-1){var F=a.split("/");return sd(F[0])+Qh(parseInt(F[1]),128)}else throw l}}function Qh(a,l){if(l==32&&a==0)return"00000000";if(l==128&&a==0)return"00000000000000000000000000000000";var u=Array(a+1).join("1")+Array(l-a+1).join("0");return new g(u,2).toString(16)}function cd(a){function l(x){var y=parseInt(x.substr(0,2),16),F=parseInt(x.substr(2),16);if(y==0&F<128)return String.fromCharCode(F);if(y<8){var D=192|(y&7)<<3|(F&192)>>6,V=128|F&63;return gi(D.toString(16)+V.toString(16))}var D=224|(y&240)>>4,V=128|(y&15)<<2|(F&192)>>6,U=128|F&63;return gi(D.toString(16)+V.toString(16)+U.toString(16))}var u=a.match(/.{4}/g),f=u.map(l);return f.join("")}function mc(a){for(var l=encodeURIComponent(a),u="",f=0;f<l.length;f++)l[f]=="%"?(u=u+l.substr(f,3),f=f+2):u=u+"%"+An(l[f]);return u}function B_(a){return a=a.replace(/\r\n/mg,`
`),a}function H_(a){return a=a.replace(/\r\n/mg,`
`),a=a.replace(/\n/mg,`\r
`),a}C.lang.String.isInteger=function(a){return a.match(/^[0-9]+$/)?!0:!!a.match(/^-[0-9]+$/)},C.lang.String.isHex=function(a){return ep(a)};function ep(a){return!!(a.length%2==0&&(a.match(/^[0-9a-f]+$/)||a.match(/^[0-9A-F]+$/)))}C.lang.String.isBase64=function(a){return a=a.replace(/\s+/g,""),!!(a.match(/^[0-9A-Za-z+\/]+={0,3}$/)&&a.length%4==0)},C.lang.String.isBase64URL=function(a){return a.match(/[+/=]/)?!1:(a=ao(a),C.lang.String.isBase64(a))};function ld(a){return!!a.match(/^[0-9A-Za-z-_.]+$/)}C.lang.String.isIntegerArray=function(a){return a=a.replace(/\s+/g,""),!!a.match(/^\[[0-9,]+\]$/)},C.lang.String.isPrintable=function(a){return a.match(/^[0-9A-Za-z '()+,-./:=?]*$/)!==null},C.lang.String.isIA5=function(a){return a.match(/^[\x20-\x21\x23-\x7f]*$/)!==null},C.lang.String.isMail=function(a){return a.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)!==null};function dd(a){return a.length%2==1?"0"+a:a.substr(0,1)>"7"?"00"+a:a}function j_(a){a=a.replace(/^\s*\[\s*/,""),a=a.replace(/\s*\]\s*$/,""),a=a.replace(/\s*/g,"");try{var l=a.split(/,/).map(function(u,f,x){var y=parseInt(u);if(y<0||255<y)throw"integer not in range 0-255";var F=("00"+y.toString(16)).slice(-2);return F}).join("");return l}catch(u){throw"malformed integer array string: "+u}}var V_=function(a,l){var u=a.length;a.length>l.length&&(u=l.length);for(var f=0;f<u;f++)if(a.charCodeAt(f)!=l.charCodeAt(f))return f;return a.length!=l.length?u:-1};function tp(a){var l=function(D){var V=D.toString(16);return V.length==1&&(V="0"+V),V},u=function(D){var V="",U=parseInt(D,10),W=U.toString(2),G=7-W.length%7;G==7&&(G=0);for(var A="",B=0;B<G;B++)A+="0";W=A+W;for(var B=0;B<W.length-1;B+=7){var O=W.substr(B,7);B!=W.length-7&&(O="1"+O),V+=l(parseInt(O,2))}return V};try{if(!a.match(/^[0-9.]+$/))return null;var f="",x=a.split("."),y=parseInt(x[0],10)*40+parseInt(x[1],10);f+=l(y),x.splice(0,2);for(var F=0;F<x.length;F++)f+=u(x[F]);return f}catch{return null}}function gc(a){if(!ep(a))return null;try{var l=[],u=a.substr(0,2),f=parseInt(u,16);l[0]=new String(Math.floor(f/40)),l[1]=new String(f%40);for(var x=a.substr(2),y=[],F=0;F<x.length/2;F++)y.push(parseInt(x.substr(F*2,2),16));for(var D=[],V="",F=0;F<y.length;F++)y[F]&128?V=V+vc((y[F]&127).toString(2),7):(V=V+vc((y[F]&127).toString(2),7),D.push(new String(parseInt(V,2))),V="");var U=l.join(".");return D.length>0&&(U=U+"."+D.join(".")),U}catch{return null}}function ip(a){var l=new g(String(a),10);return co(l)}function co(a){var l=a.toString(16);if(l.substr(0,1)!="-")return l.length%2==1?l="0"+l:l.match(/^[0-7]/)||(l="00"+l),l;var u=l.substr(1),f=u.length;f%2==1?f+=1:l.match(/^[0-7]/)||(f+=2);for(var x="",y=0;y<f;y++)x+="f";var F=new g(x,16),D=F.xor(a).add(g.ONE);return l=D.toString(16).replace(/^-/,""),l}var vc=function(a,l,u){return u==null&&(u="0"),a.length>=l?a:new Array(l-a.length+1).join(u)+a};function np(a){if(a.length%2!=0||(a=a.toLowerCase(),a.match(/^[0-9a-f]+$/)==null))return-1;try{var l=a.substr(0,2);if(l=="00")return parseInt(a.substr(2),16);var u=parseInt(l,16);if(u>7)return-1;var f=a.substr(2),x=parseInt(f,16).toString(2);x=="0"&&(x="00000000"),x=x.slice(0,0-u);var y=parseInt(x,2);return y==NaN?-1:y}catch{return-1}}function rp(a){if(typeof a!="number"||a<0)return null;var l=Number(a).toString(2),u=8-l.length%8;u==8&&(u=0),l=l+vc("",u,"0");var f=parseInt(l,2).toString(16);f.length%2==1&&(f="0"+f);var x="0"+u;return x+f}function sp(a){if(typeof a!="string"||a.length%2!=0||!a.match(/^[0-9a-f]+$/))return null;try{var l=parseInt(a.substr(0,2),16);if(l<0||7<l)return null;for(var u=a.substr(2),f="",x=0;x<u.length;x+=2){var y=u.substr(x,2),F=parseInt(y,16).toString(2);F=("0000000"+F).slice(-8),f+=F}return f.substr(0,f.length-l)}catch{return null}}function z_(a){if(typeof a!="string"||a.match(/^[01]+$/)==null)return null;try{var l=parseInt(a,2);return rp(l)}catch{return null}}function _c(a,l){for(var u=0,f=0;f<a.length;f++)u|=1<<l[a[f]];for(var x=u.toString(2),y="",f=x.length-1;f>=0;f--)y+=x[f];return y}function yi(a,f,u){if(typeof a=="object"){for(var f=String(f).split("."),x=0;x<f.length&&a;x++){var y=f[x];y.match(/^[0-9]+$/)&&(y=parseInt(y)),a=a[y]}return a||a===!1?a:u}}function Ue(a,l){var u=function(){};u.prototype=l.prototype,a.prototype=new u,a.prototype.constructor=a,a.superclass=l.prototype,l.prototype.constructor==Object.prototype.constructor&&(l.prototype.constructor=l)}(typeof C>"u"||!C)&&(C={}),(typeof C.crypto>"u"||!C.crypto)&&(C.crypto={}),C.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:s.algo.MD5,sha1:s.algo.SHA1,sha224:s.algo.SHA224,sha256:s.algo.SHA256,sha384:s.algo.SHA384,sha512:s.algo.SHA512,ripemd160:s.algo.RIPEMD160},this.getDigestInfoHex=function(a,l){if(typeof this.DIGESTINFOHEAD[l]>"u")throw"alg not supported in Util.DIGESTINFOHEAD: "+l;return this.DIGESTINFOHEAD[l]+a},this.getPaddedDigestInfoHex=function(a,l,u){var f=this.getDigestInfoHex(a,l),x=u/4;if(f.length+22>x)throw"key is too short for SigAlg: keylen="+u+","+l;for(var y="0001",F="00"+f,D="",V=x-y.length-F.length,U=0;U<V;U+=2)D+="ff";var W=y+D+F;return W},this.hashString=function(a,l){var u=new C.crypto.MessageDigest({alg:l});return u.digestString(a)},this.hashHex=function(a,l){var u=new C.crypto.MessageDigest({alg:l});return u.digestHex(a)},this.sha1=function(a){return this.hashString(a,"sha1")},this.sha256=function(a){return this.hashString(a,"sha256")},this.sha256Hex=function(a){return this.hashHex(a,"sha256")},this.sha512=function(a){return this.hashString(a,"sha512")},this.sha512Hex=function(a){return this.hashHex(a,"sha512")},this.isKey=function(a){return a instanceof Lt||a instanceof C.crypto.DSA||a instanceof C.crypto.ECDSA}},C.crypto.Util.md5=function(a){var l=new C.crypto.MessageDigest({alg:"md5",prov:"cryptojs"});return l.digestString(a)},C.crypto.Util.ripemd160=function(a){var l=new C.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"});return l.digestString(a)},C.crypto.Util.SECURERANDOMGEN=new ha,C.crypto.Util.getRandomHexOfNbytes=function(a){var l=new Array(a);return C.crypto.Util.SECURERANDOMGEN.nextBytes(l),lc(l)},C.crypto.Util.getRandomBigIntegerOfNbytes=function(a){return new g(C.crypto.Util.getRandomHexOfNbytes(a),16)},C.crypto.Util.getRandomHexOfNbits=function(a){var l=a%8,u=(a-l)/8,f=new Array(u+1);return C.crypto.Util.SECURERANDOMGEN.nextBytes(f),f[0]=(255<<l&255^255)&f[0],lc(f)},C.crypto.Util.getRandomBigIntegerOfNbits=function(a){return new g(C.crypto.Util.getRandomHexOfNbits(a),16)},C.crypto.Util.getRandomBigIntegerZeroToMax=function(a){for(var l=a.bitLength();;){var u=C.crypto.Util.getRandomBigIntegerOfNbits(l);if(a.compareTo(u)!=-1)return u}},C.crypto.Util.getRandomBigIntegerMinToMax=function(a,l){var u=a.compareTo(l);if(u==1)throw"biMin is greater than biMax";if(u==0)return a;var f=l.subtract(a),x=C.crypto.Util.getRandomBigIntegerZeroToMax(f);return x.add(a)},C.crypto.MessageDigest=function(a){this.setAlgAndProvider=function(l,u){if(l=C.crypto.MessageDigest.getCanonicalAlgName(l),l!==null&&u===void 0&&(u=C.crypto.Util.DEFAULTPROVIDER[l]),":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(l)!=-1&&u=="cryptojs"){try{this.md=C.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[l].create()}catch(f){throw"setAlgAndProvider hash alg set fail alg="+l+"/"+f}this.updateString=function(f){this.md.update(f)},this.updateHex=function(f){var x=s.enc.Hex.parse(f);this.md.update(x)},this.digest=function(){var f=this.md.finalize();return f.toString(s.enc.Hex)},this.digestString=function(f){return this.updateString(f),this.digest()},this.digestHex=function(f){return this.updateHex(f),this.digest()}}if(":sha256:".indexOf(l)!=-1&&u=="sjcl"){try{this.md=new sjcl.hash.sha256}catch(f){throw"setAlgAndProvider hash alg set fail alg="+l+"/"+f}this.updateString=function(f){this.md.update(f)},this.updateHex=function(f){var x=sjcl.codec.hex.toBits(f);this.md.update(x)},this.digest=function(){var f=this.md.finalize();return sjcl.codec.hex.fromBits(f)},this.digestString=function(f){return this.updateString(f),this.digest()},this.digestHex=function(f){return this.updateHex(f),this.digest()}}},this.updateString=function(l){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(l){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(l){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(l){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},a!==void 0&&a.alg!==void 0&&(this.algName=a.alg,a.prov===void 0&&(this.provName=C.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},C.crypto.MessageDigest.getCanonicalAlgName=function(a){return typeof a=="string"&&(a=a.toLowerCase(),a=a.replace(/-/,"")),a},C.crypto.MessageDigest.getHashLength=function(a){var l=C.crypto.MessageDigest,u=l.getCanonicalAlgName(a);if(l.HASHLENGTH[u]===void 0)throw"not supported algorithm: "+a;return l.HASHLENGTH[u]},C.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},C.crypto.Mac=function(a){this.setAlgAndProvider=function(l,u){if(l=l.toLowerCase(),l==null&&(l="hmacsha1"),l=l.toLowerCase(),l.substr(0,4)!="hmac")throw"setAlgAndProvider unsupported HMAC alg: "+l;u===void 0&&(u=C.crypto.Util.DEFAULTPROVIDER[l]),this.algProv=l+"/"+u;var f=l.substr(4);if(":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(f)!=-1&&u=="cryptojs"){try{var x=C.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[f];this.mac=s.algo.HMAC.create(x,this.pass)}catch(y){throw"setAlgAndProvider hash alg set fail hashAlg="+f+"/"+y}this.updateString=function(y){this.mac.update(y)},this.updateHex=function(y){var F=s.enc.Hex.parse(y);this.mac.update(F)},this.doFinal=function(){var y=this.mac.finalize();return y.toString(s.enc.Hex)},this.doFinalString=function(y){return this.updateString(y),this.doFinal()},this.doFinalHex=function(y){return this.updateHex(y),this.doFinal()}}},this.updateString=function(l){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(l){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(l){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(l){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(l){if(typeof l=="string"){var u=l;(l.length%2==1||!l.match(/^[0-9A-Fa-f]+$/))&&(u=Ar(l)),this.pass=s.enc.Hex.parse(u);return}if(typeof l!="object")throw"KJUR.crypto.Mac unsupported password type: "+l;var u=null;if(l.hex!==void 0){if(l.hex.length%2!=0||!l.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+l.hex;u=l.hex}if(l.utf8!==void 0&&(u=dc(l.utf8)),l.rstr!==void 0&&(u=Ar(l.rstr)),l.b64!==void 0&&(u=d(l.b64)),l.b64u!==void 0&&(u=Pi(l.b64u)),u==null)throw"KJUR.crypto.Mac unsupported password type: "+l;this.pass=s.enc.Hex.parse(u)},a!==void 0&&(a.pass!==void 0&&this.setPassword(a.pass),a.alg!==void 0&&(this.algName=a.alg,a.prov===void 0&&(this.provName=C.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},C.crypto.Signature=function(a){var l=null;if(this._setAlgNames=function(){var u=this.algName.match(/^(.+)with(.+)$/);u&&(this.mdAlgName=u[1].toLowerCase(),this.pubkeyAlgName=u[2].toLowerCase(),this.pubkeyAlgName=="rsaandmgf1"&&this.mdAlgName=="sha"&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(u,f){for(var x="",y=f/4-u.length,F=0;F<y;F++)x=x+"0";return x+u},this.setAlgAndProvider=function(u,f){if(this._setAlgNames(),f!="cryptojs/jsrsa")throw new Error("provider not supported: "+f);if(":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)!=-1){try{this.md=new C.crypto.MessageDigest({alg:this.mdAlgName})}catch(x){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+x)}this.init=function(x,y){var F=null;try{y===void 0?F=Yt.getKey(x):F=Yt.getKey(x,y)}catch(D){throw"init failed:"+D}if(F.isPrivate===!0)this.prvKey=F,this.state="SIGN";else if(F.isPublic===!0)this.pubKey=F,this.state="VERIFY";else throw"init failed.:"+F},this.updateString=function(x){this.md.updateString(x)},this.updateHex=function(x){this.md.updateHex(x)},this.sign=function(){if(this.sHashHex=this.md.digest(),this.prvKey===void 0&&this.ecprvhex!==void 0&&this.eccurvename!==void 0&&C.crypto.ECDSA!==void 0&&(this.prvKey=new C.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof Lt&&this.pubkeyAlgName==="rsaandmgf1")this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof Lt&&this.pubkeyAlgName==="rsa")this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof C.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else if(this.prvKey instanceof C.crypto.DSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;return this.hSign},this.signString=function(x){return this.updateString(x),this.sign()},this.signHex=function(x){return this.updateHex(x),this.sign()},this.verify=function(x){if(this.sHashHex=this.md.digest(),this.pubKey===void 0&&this.ecpubhex!==void 0&&this.eccurvename!==void 0&&C.crypto.ECDSA!==void 0&&(this.pubKey=new C.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof Lt&&this.pubkeyAlgName==="rsaandmgf1")return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,x,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof Lt&&this.pubkeyAlgName==="rsa")return this.pubKey.verifyWithMessageHash(this.sHashHex,x);if(C.crypto.ECDSA!==void 0&&this.pubKey instanceof C.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,x);if(C.crypto.DSA!==void 0&&this.pubKey instanceof C.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,x);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(u,f){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(u){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(u){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(u){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(u){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(u){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=a,a!==void 0&&(a.alg!==void 0&&(this.algName=a.alg,a.prov===void 0?this.provName=C.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=a.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),a.psssaltlen!==void 0&&(this.pssSaltLen=a.psssaltlen),a.prvkeypem!==void 0)){if(a.prvkeypas!==void 0)throw"both prvkeypem and prvkeypas parameters not supported";try{var l=Yt.getKey(a.prvkeypem);this.init(l)}catch(u){throw"fatal error to load pem private key: "+u}}},C.crypto.Cipher=function(a){},C.crypto.Cipher.encrypt=function(a,l,u,f){if(yi(f,"enclag")!=null&&(u=f.encalg),typeof u=="string"&&u.substr(-4)=="-CBC"){var x=l,y=a;yi(f,"key")!=null&&(x=f.key),yi(f,"enc")!=null&&(hEnc=f.enc);var F=s.enc.Hex.parse(x),D=s.enc.Hex.parse(y),V=s.enc.Hex.parse(f.iv),U;if(u=="des-EDE3-CBC")U=s.TripleDES.encrypt(D,F,{iv:V});else if(u=="aes128-CBC"||u=="aes256-CBC")U=s.AES.encrypt(D,F,{iv:V});else throw new Error("unsupported algorithm: "+u);return U+""}else throw new Error("Cipher.encrypt: unsupported key or algorithm")},C.crypto.Cipher.decrypt=function(a,l,u,f){if(yi(f,"enclag")!=null&&(u=f.encalg),typeof u=="string"&&u.substr(-4)=="-CBC"){var x=l,y=a;yi(f,"key")!=null&&(x=f.key),yi(f,"enc")!=null&&(y=f.enc);var F=s.enc.Hex.parse(x),D=s.enc.Hex.parse(y),V=s.enc.Hex.parse(f.iv),U;if(u=="des-EDE3-CBC")U=s.TripleDES.decrypt({ciphertext:D},F,{iv:V});else if(u=="aes128-CBC"||u=="aes256-CBC")U=s.AES.decrypt({ciphertext:D},F,{iv:V});else throw new Error("unsupported algorithm: "+u);return s.enc.Hex.stringify(U)}else throw new Error("Cipher.decrypt: unsupported key or algorithm")},C.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},(typeof C>"u"||!C)&&(C={}),(typeof C.crypto>"u"||!C.crypto)&&(C.crypto={}),C.crypto.ECDSA=function(a){var l="secp256r1",u=Error,f=g,x=oi,y=C.crypto.ECDSA,F=C.crypto.ECParameterDB,D=y.getName,V=Xe,U=V.getVbyListEx,W=V.isASN1HEX,G=new ha;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(A){return new f(A.bitLength(),G).mod(A.subtract(f.ONE)).add(f.ONE)},this.setNamedCurve=function(A){this.ecparams=F.getByName(A),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=A},this.setPrivateKeyHex=function(A){this.isPrivate=!0,this.prvKeyHex=A},this.setPublicKeyHex=function(A){this.isPublic=!0,this.pubKeyHex=A},this.getPublicKeyXYHex=function(){var A=this.pubKeyHex;if(A.substr(0,2)!=="04")throw"this method supports uncompressed format(04) only";var B=this.ecparams.keycharlen;if(A.length!==2+B*2)throw"malformed public key hex length";var O={};return O.x=A.substr(2,B),O.y=A.substr(2+B),O},this.getShortNISTPCurveName=function(){var A=this.curveName;return A==="secp256r1"||A==="NIST P-256"||A==="P-256"||A==="prime256v1"?"P-256":A==="secp384r1"||A==="NIST P-384"||A==="P-384"?"P-384":A==="secp521r1"||A==="NIST P-521"||A==="P-521"?"P-521":null},this.generateKeyPairHex=function(){var A=this.ecparams.n,B=this.getBigRandom(A),O=this.ecparams.keycharlen,H=("0000000000"+B.toString(16)).slice(-O);this.setPrivateKeyHex(H);var q=this.generatePublicKeyHex();return{ecprvhex:H,ecpubhex:q}},this.generatePublicKeyHex=function(){var A=new f(this.prvKeyHex,16),B=this.ecparams.G.multiply(A),O=B.getX().toBigInteger(),H=B.getY().toBigInteger(),q=this.ecparams.keycharlen,Z=("0000000000"+O.toString(16)).slice(-q),ce=("0000000000"+H.toString(16)).slice(-q),fe="04"+Z+ce;return this.setPublicKeyHex(fe),fe},this.signWithMessageHash=function(A){return this.signHex(A,this.prvKeyHex)},this.signHex=function(A,B){var O=new f(B,16),H=this.ecparams.n,q=new f(A.substring(0,this.ecparams.keycharlen),16);do var Z=this.getBigRandom(H),ce=this.ecparams.G,fe=ce.multiply(Z),pe=fe.getX().toBigInteger().mod(H);while(pe.compareTo(f.ZERO)<=0);var ge=Z.modInverse(H).multiply(q.add(O.multiply(pe))).mod(H);return y.biRSSigToASN1Sig(pe,ge)},this.sign=function(A,B){var O=B,H=this.ecparams.n,q=f.fromByteArrayUnsigned(A);do var Z=this.getBigRandom(H),ce=this.ecparams.G,fe=ce.multiply(Z),pe=fe.getX().toBigInteger().mod(H);while(pe.compareTo(g.ZERO)<=0);var ge=Z.modInverse(H).multiply(q.add(O.multiply(pe))).mod(H);return this.serializeSig(pe,ge)},this.verifyWithMessageHash=function(A,B){return this.verifyHex(A,B,this.pubKeyHex)},this.verifyHex=function(A,B,O){try{var H,q,Z=y.parseSigHex(B);H=Z.r,q=Z.s;var ce=x.decodeFromHex(this.ecparams.curve,O),fe=new f(A.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(fe,H,q,ce)}catch{return!1}},this.verify=function(A,B,O){var H,q;if(Bitcoin.Util.isArray(B)){var Z=this.parseSig(B);H=Z.r,q=Z.s}else if(typeof B=="object"&&B.r&&B.s)H=B.r,q=B.s;else throw"Invalid value for signature";var ce;if(O instanceof oi)ce=O;else if(Bitcoin.Util.isArray(O))ce=x.decodeFrom(this.ecparams.curve,O);else throw"Invalid format for pubkey value, must be byte array or ECPointFp";var fe=f.fromByteArrayUnsigned(A);return this.verifyRaw(fe,H,q,ce)},this.verifyRaw=function(A,B,O,H){var q=this.ecparams.n,Z=this.ecparams.G;if(B.compareTo(f.ONE)<0||B.compareTo(q)>=0||O.compareTo(f.ONE)<0||O.compareTo(q)>=0)return!1;var ce=O.modInverse(q),fe=A.multiply(ce).mod(q),pe=B.multiply(ce).mod(q),ge=Z.multiply(fe).add(H.multiply(pe)),Y=ge.getX().toBigInteger().mod(q);return Y.equals(B)},this.serializeSig=function(A,B){var O=A.toByteArraySigned(),H=B.toByteArraySigned(),q=[];return q.push(2),q.push(O.length),q=q.concat(O),q.push(2),q.push(H.length),q=q.concat(H),q.unshift(q.length),q.unshift(48),q},this.parseSig=function(A){var B;if(A[0]!=48)throw new Error("Signature not a valid DERSequence");if(B=2,A[B]!=2)throw new Error("First element in signature must be a DERInteger");var O=A.slice(B+2,B+2+A[B+1]);if(B+=2+A[B+1],A[B]!=2)throw new Error("Second element in signature must be a DERInteger");var H=A.slice(B+2,B+2+A[B+1]);B+=2+A[B+1];var q=f.fromByteArrayUnsigned(O),Z=f.fromByteArrayUnsigned(H);return{r:q,s:Z}},this.parseSigCompact=function(A){if(A.length!==65)throw"Signature has the wrong length";var B=A[0]-27;if(B<0||B>7)throw"Invalid signature type";var O=this.ecparams.n,H=f.fromByteArrayUnsigned(A.slice(1,33)).mod(O),q=f.fromByteArrayUnsigned(A.slice(33,65)).mod(O);return{r:H,s:q,i:B}},this.readPKCS5PrvKeyHex=function(A){if(W(A)===!1)throw new Error("not ASN.1 hex string");var B,O,H;try{B=U(A,0,["[0]",0],"06"),O=U(A,0,[1],"04");try{H=U(A,0,["[1]",0],"03")}catch{}}catch{throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=D(B),this.curveName===void 0)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(H),this.setPrivateKeyHex(O),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(A){if(W(A)===!1)throw new u("not ASN.1 hex string");var B,O,H,q;try{B=U(A,0,[1,0],"06"),O=U(A,0,[1,1],"06"),H=U(A,0,[2,0,1],"04");try{q=U(A,0,[2,0,"[1]",0],"03")}catch{}}catch{throw new u("malformed PKCS#8 plain ECC private key")}if(this.curveName=D(O),this.curveName===void 0)throw new u("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(q),this.setPrivateKeyHex(H),this.isPublic=!1},this.readPKCS8PubKeyHex=function(A){if(W(A)===!1)throw new u("not ASN.1 hex string");var B,O,H;try{B=U(A,0,[0,0],"06"),O=U(A,0,[0,1],"06"),H=U(A,0,[1],"03")}catch{throw new u("malformed PKCS#8 ECC public key")}if(this.curveName=D(O),this.curveName===null)throw new u("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(H)},this.readCertPubKeyHex=function(A,B){if(W(A)===!1)throw new u("not ASN.1 hex string");var O,H;try{O=U(A,0,[0,5,0,1],"06"),H=U(A,0,[0,5,1],"03")}catch{throw new u("malformed X.509 certificate ECC public key")}if(this.curveName=D(O),this.curveName===null)throw new u("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(H)},a!==void 0&&a.curve!==void 0&&(this.curveName=a.curve),this.curveName===void 0&&(this.curveName=l),this.setNamedCurve(this.curveName),a!==void 0&&(a.prv!==void 0&&this.setPrivateKeyHex(a.prv),a.pub!==void 0&&this.setPublicKeyHex(a.pub))},C.crypto.ECDSA.parseSigHex=function(a){var l=C.crypto.ECDSA.parseSigHexInHexRS(a),u=new g(l.r,16),f=new g(l.s,16);return{r:u,s:f}},C.crypto.ECDSA.parseSigHexInHexRS=function(a){var l=Xe,u=l.getChildIdx,f=l.getV;if(l.checkStrictDER(a,0),a.substr(0,2)!="30")throw new Error("signature is not a ASN.1 sequence");var x=u(a,0);if(x.length!=2)throw new Error("signature shall have two elements");var y=x[0],F=x[1];if(a.substr(y,2)!="02")throw new Error("1st item not ASN.1 integer");if(a.substr(F,2)!="02")throw new Error("2nd item not ASN.1 integer");var D=f(a,y),V=f(a,F);return{r:D,s:V}},C.crypto.ECDSA.asn1SigToConcatSig=function(a){var l=C.crypto.ECDSA.parseSigHexInHexRS(a),u=l.r,f=l.s;if(u.length>=130&&u.length<=134){if(u.length%2!=0)throw Error("unknown ECDSA sig r length error");if(f.length%2!=0)throw Error("unknown ECDSA sig s length error");u.substr(0,2)=="00"&&(u=u.substr(2)),f.substr(0,2)=="00"&&(f=f.substr(2));var x=Math.max(u.length,f.length);return u=("000000"+u).slice(-x),f=("000000"+f).slice(-x),u+f}if(u.substr(0,2)=="00"&&u.length%32==2&&(u=u.substr(2)),f.substr(0,2)=="00"&&f.length%32==2&&(f=f.substr(2)),u.length%32==30&&(u="00"+u),f.length%32==30&&(f="00"+f),u.length%32!=0)throw Error("unknown ECDSA sig r length error");if(f.length%32!=0)throw Error("unknown ECDSA sig s length error");return u+f},C.crypto.ECDSA.concatSigToASN1Sig=function(a){if(a.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var l=a.substr(0,a.length/2),u=a.substr(a.length/2);return C.crypto.ECDSA.hexRSSigToASN1Sig(l,u)},C.crypto.ECDSA.hexRSSigToASN1Sig=function(a,l){var u=new g(a,16),f=new g(l,16);return C.crypto.ECDSA.biRSSigToASN1Sig(u,f)},C.crypto.ECDSA.biRSSigToASN1Sig=function(a,l){var u=C.asn1,f=new u.DERInteger({bigint:a}),x=new u.DERInteger({bigint:l}),y=new u.DERSequence({array:[f,x]});return y.tohex()},C.crypto.ECDSA.getName=function(a){return a==="2b8104001f"?"secp192k1":a==="2a8648ce3d030107"?"secp256r1":a==="2b8104000a"?"secp256k1":a==="2b81040021"?"secp224r1":a==="2b81040022"?"secp384r1":a==="2b81040023"?"secp521r1":"|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(a)!==-1?"secp256r1":"|secp256k1|".indexOf(a)!==-1?"secp256k1":"|secp224r1|NIST P-224|P-224|".indexOf(a)!==-1?"secp224r1":"|secp384r1|NIST P-384|P-384|".indexOf(a)!==-1?"secp384r1":"|secp521r1|NIST P-521|P-521|".indexOf(a)!==-1?"secp521r1":null},(typeof C>"u"||!C)&&(C={}),(typeof C.crypto>"u"||!C.crypto)&&(C.crypto={}),C.crypto.ECParameterDB=new function(){var a={},l={};function u(f){return new g(f,16)}this.getByName=function(f){var x=f;if(typeof l[x]<"u"&&(x=l[f]),typeof a[x]<"u")return a[x];throw"unregistered EC curve name: "+x},this.regist=function(f,x,y,F,D,V,U,W,G,A,B,O){a[f]={};var H=u(y),q=u(F),Z=u(D),ce=u(V),fe=u(U),pe=new Gr(H,q,Z),ge=pe.decodePointHex("04"+W+G);a[f].name=f,a[f].keylen=x,a[f].keycharlen=Math.ceil(x/8)*2,a[f].curve=pe,a[f].G=ge,a[f].n=ce,a[f].h=fe,a[f].oid=B,a[f].info=O;for(var Y=0;Y<A.length;Y++)l[A[Y]]=f}},C.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),C.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),C.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),C.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),C.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),C.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),C.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),C.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),C.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),C.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),(typeof C>"u"||!C)&&(C={}),(typeof C.crypto>"u"||!C.crypto)&&(C.crypto={}),C.crypto.DSA=function(){var a=Xe;a.getVbyList;var l=a.getVbyListEx,u=a.isASN1HEX,f=g;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(x,y,F,D,V){this.isPrivate=!0,this.p=x,this.q=y,this.g=F,this.y=D,this.x=V},this.setPrivateHex=function(x,y,F,D,V){var U,W,G,A,B;U=new g(x,16),W=new g(y,16),G=new g(F,16),typeof D=="string"&&D.length>1?A=new g(D,16):A=null,B=new g(V,16),this.setPrivate(U,W,G,A,B)},this.setPublic=function(x,y,F,D){this.isPublic=!0,this.p=x,this.q=y,this.g=F,this.y=D,this.x=null},this.setPublicHex=function(x,y,F,D){var V,U,W,G;V=new g(x,16),U=new g(y,16),W=new g(F,16),G=new g(D,16),this.setPublic(V,U,W,G)},this.signWithMessageHash=function(x){var y=this.p,F=this.q,D=this.g;this.y;var V=this.x,U=C.crypto.Util.getRandomBigIntegerMinToMax(g.ONE.add(g.ONE),F.subtract(g.ONE)),W=x.substr(0,F.bitLength()/4),G=new g(W,16),A=D.modPow(U,y).mod(F),B=U.modInverse(F).multiply(G.add(V.multiply(A))).mod(F),O=C.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:A}},{int:{bigint:B}}]});return O},this.verifyWithMessageHash=function(x,y){var F=this.p,D=this.q,V=this.g,U=this.y,W=this.parseASN1Signature(y),G=W[0],A=W[1],B=x.substr(0,D.bitLength()/4),O=new g(B,16);if(g.ZERO.compareTo(G)>0||G.compareTo(D)>0||g.ZERO.compareTo(A)>=0||A.compareTo(D)>0)throw"invalid DSA signature";var H=A.modInverse(D),q=O.multiply(H).mod(D),Z=G.multiply(H).mod(D),ce=V.modPow(q,F).multiply(U.modPow(Z,F)).mod(F).mod(D);return ce.compareTo(G)==0},this.parseASN1Signature=function(x){try{var y=new f(l(x,0,[0],"02"),16),F=new f(l(x,0,[1],"02"),16);return[y,F]}catch{throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(x){var y,F,D,V,U;if(u(x)===!1)throw new Error("not ASN.1 hex string");try{y=l(x,0,[1],"02"),F=l(x,0,[2],"02"),D=l(x,0,[3],"02"),V=l(x,0,[4],"02"),U=l(x,0,[5],"02")}catch{throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(y,F,D,V,U)},this.readPKCS8PrvKeyHex=function(x){var y,F,D,V;if(u(x)===!1)throw new Error("not ASN.1 hex string");try{y=l(x,0,[1,1,0],"02"),F=l(x,0,[1,1,1],"02"),D=l(x,0,[1,1,2],"02"),V=l(x,0,[2,0],"02")}catch{throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(y,F,D,null,V)},this.readPKCS8PubKeyHex=function(x){var y,F,D,V;if(u(x)===!1)throw new Error("not ASN.1 hex string");try{y=l(x,0,[0,1,0],"02"),F=l(x,0,[0,1,1],"02"),D=l(x,0,[0,1,2],"02"),V=l(x,0,[1,0],"02")}catch{throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(y,F,D,V)},this.readCertPubKeyHex=function(x,y){var F,D,V,U;if(u(x)===!1)throw new Error("not ASN.1 hex string");try{F=l(x,0,[0,5,0,1,0],"02"),D=l(x,0,[0,5,0,1,1],"02"),V=l(x,0,[0,5,0,1,2],"02"),U=l(x,0,[0,5,1,0],"02")}catch{throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(F,D,V,U)}};var Yt=function(){var a=function(O,H,q){return f(s.AES,O,H,q)},l=function(O,H,q){return f(s.TripleDES,O,H,q)},u=function(O,H,q){return f(s.DES,O,H,q)},f=function(O,H,q,Z){var ce=s.enc.Hex.parse(H),fe=s.enc.Hex.parse(q),pe=s.enc.Hex.parse(Z),ge={};ge.key=fe,ge.iv=pe,ge.ciphertext=ce;var Y=O.decrypt(ge,fe,{iv:pe});return s.enc.Hex.stringify(Y)},x=function(O,H,q){return D(s.AES,O,H,q)},y=function(O,H,q){return D(s.TripleDES,O,H,q)},F=function(O,H,q){return D(s.DES,O,H,q)},D=function(O,H,q,Z){var ce=s.enc.Hex.parse(H),fe=s.enc.Hex.parse(q),pe=s.enc.Hex.parse(Z),ge=O.encrypt(ce,fe,{iv:pe}),Y=s.enc.Hex.parse(ge.toString()),Q=s.enc.Base64.stringify(Y);return Q},V={"AES-256-CBC":{proc:a,eproc:x,keylen:32,ivlen:16},"AES-192-CBC":{proc:a,eproc:x,keylen:24,ivlen:16},"AES-128-CBC":{proc:a,eproc:x,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:l,eproc:y,keylen:24,ivlen:8},"DES-CBC":{proc:u,eproc:F,keylen:8,ivlen:8}},U=function(O){var H=s.lib.WordArray.random(O),q=s.enc.Hex.stringify(H);return q},W=function(O){var H={},q=O.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));q&&(H.cipher=q[1],H.ivsalt=q[2]);var Z=O.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));Z&&(H.type=Z[1]);var ce=-1,fe=0;O.indexOf(`\r
\r
`)!=-1&&(ce=O.indexOf(`\r
\r
`),fe=2),O.indexOf(`

`)!=-1&&(ce=O.indexOf(`

`),fe=1);var pe=O.indexOf("-----END");if(ce!=-1&&pe!=-1){var ge=O.substring(ce+fe*2,pe-fe);ge=ge.replace(/\s+/g,""),H.data=ge}return H},G=function(O,H,q){for(var Z=q.substring(0,16),ce=s.enc.Hex.parse(Z),fe=s.enc.Utf8.parse(H),pe=V[O].keylen+V[O].ivlen,ge="",Y=null;;){var Q=s.algo.MD5.create();if(Y!=null&&Q.update(Y),Q.update(fe),Q.update(ce),Y=Q.finalize(),ge=ge+s.enc.Hex.stringify(Y),ge.length>=pe*2)break}var re={};return re.keyhex=ge.substr(0,V[O].keylen*2),re.ivhex=ge.substr(V[O].keylen*2,V[O].ivlen*2),re},A=function(O,H,q,Z){var ce=s.enc.Base64.parse(O),fe=s.enc.Hex.stringify(ce),pe=V[H].proc,ge=pe(fe,q,Z);return ge},B=function(O,H,q,Z){var ce=V[H].eproc,fe=ce(O,q,Z);return fe};return{version:"1.0.0",parsePKCS5PEM:function(O){return W(O)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(O,H,q){return G(O,H,q)},decryptKeyB64:function(O,H,q,Z){return A(O,H,q,Z)},getDecryptedKeyHex:function(O,H){var q=W(O),Z=q.cipher,ce=q.ivsalt,fe=q.data,pe=G(Z,H,ce),ge=pe.keyhex,Y=A(fe,Z,ge,ce);return Y},getEncryptedPKCS5PEMFromPrvKeyHex:function(O,H,q,Z,ce){var J="";if((typeof Z>"u"||Z==null)&&(Z="AES-256-CBC"),typeof V[Z]>"u")throw new Error("KEYUTIL unsupported algorithm: "+Z);if(typeof ce>"u"||ce==null){var fe=V[Z].ivlen,pe=U(fe);ce=pe.toUpperCase()}var ge=G(Z,q,ce),Y=ge.keyhex,Q=B(H,Z,Y,ce),re=Q.replace(/(.{64})/g,`$1\r
`),J="-----BEGIN "+O+` PRIVATE KEY-----\r
`;return J+=`Proc-Type: 4,ENCRYPTED\r
`,J+="DEK-Info: "+Z+","+ce+`\r
`,J+=`\r
`,J+=re,J+=`\r
-----END `+O+` PRIVATE KEY-----\r
`,J},getEncryptedPKCS8PEM:function(O,H,q){var Z=this.getEncryptedPKCS8Hex(O,H,q);return hn(Z,"ENCRYPTED PRIVATE KEY")},getEncryptedPKCS8Hex:function(O,H,q){var Z;q==null||q==null?Z={}:Z=JSON.parse(JSON.stringify(q)),Z.plain=O,this.initPBES2Param(Z),this.encryptPBES2Param(Z,H);var ce=this.generatePBES2ASN1Param(Z);return C.asn1.ASN1Util.newObject(ce).tohex()},initPBES2Param:function(O){if(yi(O,"encalg")==null&&(O.encalg="aes256-CBC"),yi(O,"iter")==null&&(O.iter=2048),yi(O,"prf")==null&&(O.prf="hmacWithSHA256"),yi(O,"salt")==null&&(O.salt=s.enc.Hex.stringify(s.lib.WordArray.random(8))),yi(O,"enciv")==null){var H;O.encalg=="des-EDE3-CBC"&&(H=8),O.encalg=="aes128-CBC"&&(H=16),O.encalg=="aes256-CBC"&&(H=16),O.enciv=s.enc.Hex.stringify(s.lib.WordArray.random(H))}},encryptPBES2Param:function(O,H){var q=Yt.getDKFromPBES2Param(O,H);try{var Z=C.crypto.Cipher.encrypt(O.plain,q,O.encalg,{iv:O.enciv})}catch{throw new Error("encrypt error: "+O.plain+" "+q+" "+O.encalg+" "+O.enciv)}O.enc=Z},generatePBES2ASN1Param:function(O){var H={seq:[{seq:[{oid:"pkcs5PBES2"},{seq:[{seq:[{oid:"pkcs5PBKDF2"},{seq:[{octstr:{hex:O.salt}},{int:{hex:ip(O.iter)}}]}]},{seq:[{oid:O.encalg},{octstr:{hex:O.enciv}}]}]}]},{octstr:{hex:O.enc}}]};return O.prf!="hmacWithSHA1"&&H.seq[0].seq[1].seq[0].seq[1].seq.push({seq:[{oid:O.prf},{null:""}]}),H},parseHexOfEncryptedPKCS8:function(O){var H=Xe,q=H.getChildIdx,Z=H.getV,ce={},fe=q(O,0);if(fe.length!=2)throw new Error("malformed format: SEQUENCE(0).items != 2: "+fe.length);ce.ciphertext=Z(O,fe[1]);var pe=q(O,fe[0]);if(pe.length!=2)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+pe.length);if(Z(O,pe[0])!="2a864886f70d01050d")throw new Error("this only supports pkcs5PBES2");var ge=q(O,pe[1]);if(pe.length!=2)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+ge.length);var Y=q(O,ge[1]);if(Y.length!=2)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+Y.length);if(Z(O,Y[0])!="2a864886f70d0307")throw"this only supports TripleDES";ce.encryptionSchemeAlg="TripleDES",ce.encryptionSchemeIV=Z(O,Y[1]);var Q=q(O,ge[0]);if(Q.length!=2)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+Q.length);if(Z(O,Q[0])!="2a864886f70d01050c")throw new Error("this only supports pkcs5PBKDF2");var re=q(O,Q[1]);if(re.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+re.length);ce.pbkdf2Salt=Z(O,re[0]);var J=Z(O,re[1]);try{ce.pbkdf2Iter=parseInt(J,16)}catch{throw new Error("malformed format pbkdf2Iter: "+J)}return ce},getPBKDF2KeyHexFromParam:function(O,H){var q=s.enc.Hex.parse(O.pbkdf2Salt),Z=O.pbkdf2Iter,ce=s.PBKDF2(H,q,{keySize:192/32,iterations:Z}),fe=s.enc.Hex.stringify(ce);return fe},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(O,H){var q=Ui(O,"ENCRYPTED PRIVATE KEY"),Z=this.parseHexOfEncryptedPKCS8(q),ce=Yt.getPBKDF2KeyHexFromParam(Z,H),fe={};fe.ciphertext=s.enc.Hex.parse(Z.ciphertext);var pe=s.enc.Hex.parse(ce),ge=s.enc.Hex.parse(Z.encryptionSchemeIV),Y=s.TripleDES.decrypt(fe,pe,{iv:ge}),Q=s.enc.Hex.stringify(Y);return Q},parsePBES2:function(O){var H=Xe.parse(O);if(yi(H,"seq.0.seq.0.oid")!="pkcs5PBES2"||yi(H,"seq.0.seq.1.seq.0.seq.0.oid")!="pkcs5PBKDF2")throw new Error("not pkcs5PBES2 and pkcs5PBKDF2 used");var q=yi(H,"seq.0.seq.1.seq.0.seq.1.seq");if(q==null)throw new Error("PBKDF2 parameter not found");var Z=yi(q,"0.octstr.hex"),ce=yi(q,"1.int.hex"),fe=yi(q,"2.seq.0.oid","hmacWithSHA1"),pe=-1;try{pe=parseInt(ce,16)}catch{throw new Error("iter not proper value")}var ge=yi(H,"seq.0.seq.1.seq.1.seq.0.oid"),Y=yi(H,"seq.0.seq.1.seq.1.seq.1.octstr.hex"),Q=yi(H,"seq.1.octstr.hex");if(ge==null||Y==null||Q==null)throw new Error("encalg, enciv or enc is undefined");var re={salt:Z,iter:pe,prf:fe,encalg:ge,enciv:Y,enc:Q};return re},getDKFromPBES2Param:function(O,H){var q={hmacWithSHA1:s.algo.SHA1,hmacWithSHA224:s.algo.SHA224,hmacWithSHA256:s.algo.SHA256,hmacWithSHA384:s.algo.SHA384,hmacWithSHA512:s.algo.SHA512},Z={"des-EDE3-CBC":192/32,"aes128-CBC":128/32,"aes256-CBC":256/32},ce=q[O.prf];if(ce==null)throw new Error("unsupported prf");var fe=Z[O.encalg];if(fe==null)throw new Error("unsupported encalg");var pe=s.enc.Hex.parse(O.salt),ge=O.iter;try{var Y=s.PBKDF2(H,pe,{keySize:fe,iterations:ge,hasher:ce});return s.enc.Hex.stringify(Y)}catch(Q){throw new Error("PBKDF2 error: "+Q+" "+JSON.stringify(O)+" "+H)}},getPlainHexFromEncryptedPKCS8PEM:function(O,H){if(O.indexOf("BEGIN ENCRYPTED PRIVATE KEY")==-1)throw new Error("not Encrypted PKCS#8 PEM string");var q=Ui(O),Z;try{Z=Yt.parsePBES2(q)}catch(fe){throw new Error("malformed PBES2 format: "+fe.message)}var ce=Yt.getDKFromPBES2Param(Z,H);return C.crypto.Cipher.decrypt(Z.enc,ce,Z.encalg,{iv:Z.enciv})},getKeyFromEncryptedPKCS8PEM:function(O,H){var q=this.getPlainHexFromEncryptedPKCS8PEM(O,H),Z=this.getKeyFromPlainPrivatePKCS8Hex(q);return Z},parsePlainPrivatePKCS8Hex:function(O){var H=Xe,q=H.getChildIdx,Z=H.getV,ce={};if(ce.algparam=null,O.substr(0,2)!="30")throw new Error("malformed plain PKCS8 private key(code:001)");var fe=q(O,0);if(fe.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if(O.substr(fe[1],2)!="30")throw new Error("malformed PKCS8 private key(code:003)");var pe=q(O,fe[1]);if(pe.length!=2)throw new Error("malformed PKCS8 private key(code:004)");if(O.substr(pe[0],2)!="06")throw new Error("malformed PKCS8 private key(code:005)");if(ce.algoid=Z(O,pe[0]),O.substr(pe[1],2)=="06"&&(ce.algparam=Z(O,pe[1])),O.substr(fe[2],2)!="04")throw new Error("malformed PKCS8 private key(code:006)");return ce.keyidx=H.getVidx(O,fe[2]),ce},getKeyFromPlainPrivatePKCS8PEM:function(O){var H=Ui(O,"PRIVATE KEY"),q=this.getKeyFromPlainPrivatePKCS8Hex(H);return q},getKeyFromPlainPrivatePKCS8Hex:function(O){var H=this.parsePlainPrivatePKCS8Hex(O),q;if(H.algoid=="2a864886f70d010101")q=new Lt;else if(H.algoid=="2a8648ce380401")q=new C.crypto.DSA;else if(H.algoid=="2a8648ce3d0201")q=new C.crypto.ECDSA;else throw new Error("unsupported private key algorithm");return q.readPKCS8PrvKeyHex(O),q},_getKeyFromPublicPKCS8Hex:function(O){var H,q=Xe.getVbyList(O,0,[0,0],"06");if(q==="2a864886f70d010101")H=new Lt;else if(q==="2a8648ce380401")H=new C.crypto.DSA;else if(q==="2a8648ce3d0201")H=new C.crypto.ECDSA;else throw new Error("unsupported PKCS#8 public key hex");return H.readPKCS8PubKeyHex(O),H},parsePublicRawRSAKeyHex:function(O){var H=Xe,q=H.getChildIdx,Z=H.getV,ce={};if(O.substr(0,2)!="30")throw new Error("malformed RSA key(code:001)");var fe=q(O,0);if(fe.length!=2)throw new Error("malformed RSA key(code:002)");if(O.substr(fe[0],2)!="02")throw new Error("malformed RSA key(code:003)");if(ce.n=Z(O,fe[0]),O.substr(fe[1],2)!="02")throw new Error("malformed RSA key(code:004)");return ce.e=Z(O,fe[1]),ce},parsePublicPKCS8Hex:function(O){var H=Xe,q=H.getChildIdx,Z=H.getV,ce={};ce.algparam=null;var fe=q(O,0);if(fe.length!=2)throw new Error("outer DERSequence shall have 2 elements: "+fe.length);var pe=fe[0];if(O.substr(pe,2)!="30")throw new Error("malformed PKCS8 public key(code:001)");var ge=q(O,pe);if(ge.length!=2)throw new Error("malformed PKCS8 public key(code:002)");if(O.substr(ge[0],2)!="06")throw new Error("malformed PKCS8 public key(code:003)");if(ce.algoid=Z(O,ge[0]),O.substr(ge[1],2)=="06"?ce.algparam=Z(O,ge[1]):O.substr(ge[1],2)=="30"&&(ce.algparam={},ce.algparam.p=H.getVbyList(O,ge[1],[0],"02"),ce.algparam.q=H.getVbyList(O,ge[1],[1],"02"),ce.algparam.g=H.getVbyList(O,ge[1],[2],"02")),O.substr(fe[1],2)!="03")throw new Error("malformed PKCS8 public key(code:004)");return ce.key=Z(O,fe[1]).substr(2),ce}}}();Yt.getKey=function(a,l,u){var f=Xe,x=f.getChildIdx;f.getV;var y=f.getVbyList,F=C.crypto,D=F.ECDSA,V=F.DSA,U=Lt,W=Ui,G=Yt;if(typeof U<"u"&&a instanceof U||typeof D<"u"&&a instanceof D||typeof V<"u"&&a instanceof V)return a;if(a.curve!==void 0&&a.xy!==void 0&&a.d===void 0)return new D({pub:a.xy,curve:a.curve});if(a.curve!==void 0&&a.d!==void 0)return new D({prv:a.d,curve:a.curve});if(a.kty===void 0&&a.n!==void 0&&a.e!==void 0&&a.d===void 0){var A=new U;return A.setPublic(a.n,a.e),A}if(a.kty===void 0&&a.n!==void 0&&a.e!==void 0&&a.d!==void 0&&a.p!==void 0&&a.q!==void 0&&a.dp!==void 0&&a.dq!==void 0&&a.co!==void 0&&a.qi===void 0){var A=new U;return A.setPrivateEx(a.n,a.e,a.d,a.p,a.q,a.dp,a.dq,a.co),A}if(a.kty===void 0&&a.n!==void 0&&a.e!==void 0&&a.d!==void 0&&a.p===void 0){var A=new U;return A.setPrivate(a.n,a.e,a.d),A}if(a.p!==void 0&&a.q!==void 0&&a.g!==void 0&&a.y!==void 0&&a.x===void 0){var A=new V;return A.setPublic(a.p,a.q,a.g,a.y),A}if(a.p!==void 0&&a.q!==void 0&&a.g!==void 0&&a.y!==void 0&&a.x!==void 0){var A=new V;return A.setPrivate(a.p,a.q,a.g,a.y,a.x),A}if(a.kty==="RSA"&&a.n!==void 0&&a.e!==void 0&&a.d===void 0){var A=new U;return A.setPublic(Pi(a.n),Pi(a.e)),A}if(a.kty==="RSA"&&a.n!==void 0&&a.e!==void 0&&a.d!==void 0&&a.p!==void 0&&a.q!==void 0&&a.dp!==void 0&&a.dq!==void 0&&a.qi!==void 0){var A=new U;return A.setPrivateEx(Pi(a.n),Pi(a.e),Pi(a.d),Pi(a.p),Pi(a.q),Pi(a.dp),Pi(a.dq),Pi(a.qi)),A}if(a.kty==="RSA"&&a.n!==void 0&&a.e!==void 0&&a.d!==void 0){var A=new U;return A.setPrivate(Pi(a.n),Pi(a.e),Pi(a.d)),A}if(a.kty==="EC"&&a.crv!==void 0&&a.x!==void 0&&a.y!==void 0&&a.d===void 0){var B=new D({curve:a.crv}),O=B.ecparams.keycharlen,H=("0000000000"+Pi(a.x)).slice(-O),q=("0000000000"+Pi(a.y)).slice(-O),Z="04"+H+q;return B.setPublicKeyHex(Z),B}if(a.kty==="EC"&&a.crv!==void 0&&a.x!==void 0&&a.y!==void 0&&a.d!==void 0){var B=new D({curve:a.crv}),O=B.ecparams.keycharlen,H=("0000000000"+Pi(a.x)).slice(-O),q=("0000000000"+Pi(a.y)).slice(-O),Z="04"+H+q,ce=("0000000000"+Pi(a.d)).slice(-O);return B.setPublicKeyHex(Z),B.setPrivateKeyHex(ce),B}if(u==="pkcs5prv"){var fe=a,f=Xe,pe,A;if(pe=x(fe,0),pe.length===9)A=new U,A.readPKCS5PrvKeyHex(fe);else if(pe.length===6)A=new V,A.readPKCS5PrvKeyHex(fe);else if(pe.length>2&&fe.substr(pe[1],2)==="04")A=new D,A.readPKCS5PrvKeyHex(fe);else throw new Error("unsupported PKCS#1/5 hexadecimal key");return A}if(u==="pkcs8prv"){var A=G.getKeyFromPlainPrivatePKCS8Hex(a);return A}if(u==="pkcs8pub")return G._getKeyFromPublicPKCS8Hex(a);if(u==="x509pub")return At.getPublicKeyFromCertHex(a);if(a.indexOf("-END CERTIFICATE-",0)!=-1||a.indexOf("-END X509 CERTIFICATE-",0)!=-1||a.indexOf("-END TRUSTED CERTIFICATE-",0)!=-1)return At.getPublicKeyFromCertPEM(a);if(a.indexOf("-END PUBLIC KEY-")!=-1){var ge=Ui(a,"PUBLIC KEY");return G._getKeyFromPublicPKCS8Hex(ge)}if(a.indexOf("-END RSA PRIVATE KEY-")!=-1&&a.indexOf("4,ENCRYPTED")==-1){var Y=W(a,"RSA PRIVATE KEY");return G.getKey(Y,null,"pkcs5prv")}if(a.indexOf("-END DSA PRIVATE KEY-")!=-1&&a.indexOf("4,ENCRYPTED")==-1){var Q=W(a,"DSA PRIVATE KEY"),re=y(Q,0,[1],"02"),J=y(Q,0,[2],"02"),oe=y(Q,0,[3],"02"),me=y(Q,0,[4],"02"),ye=y(Q,0,[5],"02"),A=new V;return A.setPrivate(new g(re,16),new g(J,16),new g(oe,16),new g(me,16),new g(ye,16)),A}if(a.indexOf("-END EC PRIVATE KEY-")!=-1&&a.indexOf("4,ENCRYPTED")==-1){var Y=W(a,"EC PRIVATE KEY");return G.getKey(Y,null,"pkcs5prv")}if(a.indexOf("-END PRIVATE KEY-")!=-1)return G.getKeyFromPlainPrivatePKCS8PEM(a);if(a.indexOf("-END RSA PRIVATE KEY-")!=-1&&a.indexOf("4,ENCRYPTED")!=-1){var Be=G.getDecryptedKeyHex(a,l),be=new Lt;return be.readPKCS5PrvKeyHex(Be),be}if(a.indexOf("-END EC PRIVATE KEY-")!=-1&&a.indexOf("4,ENCRYPTED")!=-1){var Q=G.getDecryptedKeyHex(a,l),A=y(Q,0,[1],"04"),Te=y(Q,0,[2,0],"06"),He=y(Q,0,[3,0],"03").substr(2),qe="";if(C.crypto.OID.oidhex2name[Te]!==void 0)qe=C.crypto.OID.oidhex2name[Te];else throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+Te);var B=new D({curve:qe});return B.setPublicKeyHex(He),B.setPrivateKeyHex(A),B.isPublic=!1,B}if(a.indexOf("-END DSA PRIVATE KEY-")!=-1&&a.indexOf("4,ENCRYPTED")!=-1){var Q=G.getDecryptedKeyHex(a,l),re=y(Q,0,[1],"02"),J=y(Q,0,[2],"02"),oe=y(Q,0,[3],"02"),me=y(Q,0,[4],"02"),ye=y(Q,0,[5],"02"),A=new V;return A.setPrivate(new g(re,16),new g(J,16),new g(oe,16),new g(me,16),new g(ye,16)),A}if(a.indexOf("-END ENCRYPTED PRIVATE KEY-")!=-1)return G.getKeyFromEncryptedPKCS8PEM(a,l);throw new Error("not supported argument")},Yt.generateKeypair=function(a,l){if(a=="RSA"){var u=l,f=new Lt;f.generate(u,"10001"),f.isPrivate=!0,f.isPublic=!0;var x=new Lt,y=f.n.toString(16),F=f.e.toString(16);x.setPublic(y,F),x.isPrivate=!1,x.isPublic=!0;var D={};return D.prvKeyObj=f,D.pubKeyObj=x,D}else if(a=="EC"){var V=l,U=new C.crypto.ECDSA({curve:V}),W=U.generateKeyPairHex(),f=new C.crypto.ECDSA({curve:V});f.setPublicKeyHex(W.ecpubhex),f.setPrivateKeyHex(W.ecprvhex),f.isPrivate=!0,f.isPublic=!1;var x=new C.crypto.ECDSA({curve:V});x.setPublicKeyHex(W.ecpubhex),x.isPrivate=!1,x.isPublic=!0;var D={};return D.prvKeyObj=f,D.pubKeyObj=x,D}else throw new Error("unknown algorithm: "+a)},Yt.getPEM=function(a,l,u,f,x,y){var F=C,D=F.asn1,V=D.DERObjectIdentifier,U=D.DERInteger,W=D.ASN1Util.newObject,G=D.x509,A=G.SubjectPublicKeyInfo,B=F.crypto,O=B.DSA,H=B.ECDSA,q=Lt;function Z(Te){var He=W({seq:[{int:0},{int:{bigint:Te.n}},{int:Te.e},{int:{bigint:Te.d}},{int:{bigint:Te.p}},{int:{bigint:Te.q}},{int:{bigint:Te.dmp1}},{int:{bigint:Te.dmq1}},{int:{bigint:Te.coeff}}]});return He}function ce(Te){var He=W({seq:[{int:1},{octstr:{hex:Te.prvKeyHex}},{tag:["a0",!0,{oid:{name:Te.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+Te.pubKeyHex}}]}]});return He}function fe(Te){var He=W({seq:[{int:0},{int:{bigint:Te.p}},{int:{bigint:Te.q}},{int:{bigint:Te.g}},{int:{bigint:Te.y}},{int:{bigint:Te.x}}]});return He}if((q!==void 0&&a instanceof q||O!==void 0&&a instanceof O||H!==void 0&&a instanceof H)&&a.isPublic==!0&&(l===void 0||l=="PKCS8PUB")){var pe=new A(a),ge=pe.tohex();return hn(ge,"PUBLIC KEY")}if(l=="PKCS1PRV"&&q!==void 0&&a instanceof q&&(u===void 0||u==null)&&a.isPrivate==!0){var pe=Z(a),ge=pe.tohex();return hn(ge,"RSA PRIVATE KEY")}if(l=="PKCS1PRV"&&H!==void 0&&a instanceof H&&(u===void 0||u==null)&&a.isPrivate==!0){var Y=new V({name:a.curveName}),Q=Y.tohex(),re=ce(a),J=re.tohex(),oe="";return oe+=hn(Q,"EC PARAMETERS"),oe+=hn(J,"EC PRIVATE KEY"),oe}if(l=="PKCS1PRV"&&O!==void 0&&a instanceof O&&(u===void 0||u==null)&&a.isPrivate==!0){var pe=fe(a),ge=pe.tohex();return hn(ge,"DSA PRIVATE KEY")}if(l=="PKCS5PRV"&&q!==void 0&&a instanceof q&&u!==void 0&&u!=null&&a.isPrivate==!0){var pe=Z(a),ge=pe.tohex();return f===void 0&&(f="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",ge,u,f,y)}if(l=="PKCS5PRV"&&H!==void 0&&a instanceof H&&u!==void 0&&u!=null&&a.isPrivate==!0){var pe=ce(a),ge=pe.tohex();return f===void 0&&(f="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",ge,u,f,y)}if(l=="PKCS5PRV"&&O!==void 0&&a instanceof O&&u!==void 0&&u!=null&&a.isPrivate==!0){var pe=fe(a),ge=pe.tohex();return f===void 0&&(f="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",ge,u,f,y)}var me=function(Te,He){if(typeof He=="string")return Yt.getEncryptedPKCS8PEM(Te,He);if(typeof He=="object"&&yi(He,"passcode")!=null){var qe=JSON.parse(JSON.stringify(He)),pn=qe.passcode;return delete qe.passcode,Yt.getEncryptedPKCS8PEM(Te,pn,qe)}};if(l=="PKCS8PRV"&&q!=null&&a instanceof q&&a.isPrivate==!0){var ye=Z(a),Be=ye.tohex(),pe=W({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:Be}}]}),ge=pe.tohex();return u===void 0||u==null?hn(ge,"PRIVATE KEY"):me(ge,u)}if(l=="PKCS8PRV"&&H!==void 0&&a instanceof H&&a.isPrivate==!0){var be={seq:[{int:1},{octstr:{hex:a.prvKeyHex}}]};typeof a.pubKeyHex=="string"&&be.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+a.pubKeyHex}}]});var ye=new W(be),Be=ye.tohex(),pe=W({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:a.curveName}}]},{octstr:{hex:Be}}]}),ge=pe.tohex();return u===void 0||u==null?hn(ge,"PRIVATE KEY"):me(ge,u)}if(l=="PKCS8PRV"&&O!==void 0&&a instanceof O&&a.isPrivate==!0){var ye=new U({bigint:a.x}),Be=ye.tohex(),pe=W({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:a.p}},{int:{bigint:a.q}},{int:{bigint:a.g}}]}]},{octstr:{hex:Be}}]}),ge=pe.tohex();return u===void 0||u==null?hn(ge,"PRIVATE KEY"):me(ge,u)}throw new Error("unsupported object nor format")},Yt.getKeyFromCSRPEM=function(a){var l=Ui(a,"CERTIFICATE REQUEST"),u=Yt.getKeyFromCSRHex(l);return u},Yt.getKeyFromCSRHex=function(a){var l=Yt.parseCSRHex(a),u=Yt.getKey(l.p8pubkeyhex,null,"pkcs8pub");return u},Yt.parseCSRHex=function(a){var l=Xe,u=l.getChildIdx,f=l.getTLV,x={},y=a;if(y.substr(0,2)!="30")throw new Error("malformed CSR(code:001)");var F=u(y,0);if(F.length<1)throw new Error("malformed CSR(code:002)");if(y.substr(F[0],2)!="30")throw new Error("malformed CSR(code:003)");var D=u(y,F[0]);if(D.length<3)throw new Error("malformed CSR(code:004)");return x.p8pubkeyhex=f(y,D[2]),x},Yt.getKeyID=function(a){var l=Yt,u=Xe;typeof a=="string"&&a.indexOf("BEGIN ")!=-1&&(a=l.getKey(a));var f=Ui(l.getPEM(a)),x=u.getIdxbyList(f,0,[1]),y=u.getV(f,x).substring(2);return C.crypto.Util.hashHex(y,"sha1")},Yt.getJWK=function(a,l,u,f,x){var y,F={},D,V=C.crypto.Util.hashHex;if(typeof a=="string")y=Yt.getKey(a),a.indexOf("CERTIFICATE")!=-1&&(D=Ui(a));else if(typeof a=="object")a instanceof At?(y=a.getPublicKey(),D=a.hex):y=a;else throw new Error("unsupported keyinfo type");if(y instanceof Lt&&y.isPrivate)F.kty="RSA",F.n=Yi(y.n.toString(16)),F.e=Yi(y.e.toString(16)),F.d=Yi(y.d.toString(16)),F.p=Yi(y.p.toString(16)),F.q=Yi(y.q.toString(16)),F.dp=Yi(y.dmp1.toString(16)),F.dq=Yi(y.dmq1.toString(16)),F.qi=Yi(y.coeff.toString(16));else if(y instanceof Lt&&y.isPublic)F.kty="RSA",F.n=Yi(y.n.toString(16)),F.e=Yi(y.e.toString(16));else if(y instanceof C.crypto.ECDSA&&y.isPrivate){var U=y.getShortNISTPCurveName();if(U!=="P-256"&&U!=="P-384"&&U!=="P-521")throw new Error("unsupported curve name for JWT: "+U);var W=y.getPublicKeyXYHex();F.kty="EC",F.crv=U,F.x=Yi(W.x),F.y=Yi(W.y),F.d=Yi(y.prvKeyHex)}else if(y instanceof C.crypto.ECDSA&&y.isPublic){var U=y.getShortNISTPCurveName();if(U!=="P-256"&&U!=="P-384"&&U!=="P-521")throw new Error("unsupported curve name for JWT: "+U);var W=y.getPublicKeyXYHex();F.kty="EC",F.crv=U,F.x=Yi(W.x),F.y=Yi(W.y)}if(F.kty==null)throw new Error("unsupported keyinfo");return!y.isPrivate&&l!=!0&&(F.kid=C.jws.JWS.getJWKthumbprint(F)),D!=null&&u!=!0&&(F.x5c=[h(D)]),D!=null&&f!=!0&&(F.x5t=pa(h(V(D,"sha1")))),D!=null&&x!=!0&&(F["x5t#S256"]=pa(h(V(D,"sha256")))),F},Yt.getJWKFromKey=function(a){return Yt.getJWK(a,!0,!0,!0,!0)},Lt.getPosArrayOfChildrenFromHex=function(a){return Xe.getChildIdx(a,0)},Lt.getHexValueArrayOfChildrenFromHex=function(a){var l=Xe,u=l.getV,A=Lt.getPosArrayOfChildrenFromHex(a),f=u(a,A[0]),x=u(a,A[1]),y=u(a,A[2]),F=u(a,A[3]),D=u(a,A[4]),V=u(a,A[5]),U=u(a,A[6]),W=u(a,A[7]),G=u(a,A[8]),A=new Array;return A.push(f,x,y,F,D,V,U,W,G),A},Lt.prototype.readPrivateKeyFromPEMString=function(a){var l=Ui(a),u=Lt.getHexValueArrayOfChildrenFromHex(l);this.setPrivateEx(u[1],u[2],u[3],u[4],u[5],u[6],u[7],u[8])},Lt.prototype.readPKCS5PrvKeyHex=function(a){var l=Lt.getHexValueArrayOfChildrenFromHex(a);this.setPrivateEx(l[1],l[2],l[3],l[4],l[5],l[6],l[7],l[8])},Lt.prototype.readPKCS8PrvKeyHex=function(a){var l,u,f,x,y,F,D,V,U=Xe,W=U.getVbyListEx;if(U.isASN1HEX(a)===!1)throw new Error("not ASN.1 hex string");try{l=W(a,0,[2,0,1],"02"),u=W(a,0,[2,0,2],"02"),f=W(a,0,[2,0,3],"02"),x=W(a,0,[2,0,4],"02"),y=W(a,0,[2,0,5],"02"),F=W(a,0,[2,0,6],"02"),D=W(a,0,[2,0,7],"02"),V=W(a,0,[2,0,8],"02")}catch{throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(l,u,f,x,y,F,D,V)},Lt.prototype.readPKCS5PubKeyHex=function(a){var l=Xe,u=l.getV;if(l.isASN1HEX(a)===!1)throw new Error("keyHex is not ASN.1 hex string");var f=l.getChildIdx(a,0);if(f.length!==2||a.substr(f[0],2)!=="02"||a.substr(f[1],2)!=="02")throw new Error("wrong hex for PKCS#5 public key");var x=u(a,f[0]),y=u(a,f[1]);this.setPublic(x,y)},Lt.prototype.readPKCS8PubKeyHex=function(a){var l=Xe;if(l.isASN1HEX(a)===!1)throw new Error("not ASN.1 hex string");if(l.getTLVbyListEx(a,0,[0,0])!=="06092a864886f70d010101")throw new Error("not PKCS8 RSA public key");var u=l.getTLVbyListEx(a,0,[1,0]);this.readPKCS5PubKeyHex(u)},Lt.prototype.readCertPubKeyHex=function(a,l){var u,f;u=new At,u.readCertHex(a),f=u.getPublicKeyHex(),this.readPKCS8PubKeyHex(f)};function ap(a,l){for(var u="",f=l/4-a.length,x=0;x<f;x++)u=u+"0";return u+a}Lt.prototype.sign=function(a,l){var u=function(x){return C.crypto.Util.hashString(x,l)},f=u(a);return this.signWithMessageHash(f,l)},Lt.prototype.signWithMessageHash=function(a,l){var u=C.crypto.Util.getPaddedDigestInfoHex(a,l,this.n.bitLength()),f=Pn(u,16),x=this.doPrivate(f),y=x.toString(16);return ap(y,this.n.bitLength())};function op(a,l,u){for(var f="",x=0;f.length<l;)f+=Dn(u(Ar(a+String.fromCharCode.apply(String,[(x&4278190080)>>24,(x&16711680)>>16,(x&65280)>>8,x&255])))),x+=1;return f}Lt.prototype.signPSS=function(a,l,u){var f=function(y){return C.crypto.Util.hashHex(y,l)},x=f(Ar(a));return u===void 0&&(u=-1),this.signWithMessageHashPSS(x,l,u)},Lt.prototype.signWithMessageHashPSS=function(a,l,u){var f=Dn(a),x=f.length,y=this.n.bitLength()-1,F=Math.ceil(y/8),D,V=function(q){return C.crypto.Util.hashHex(q,l)};if(u===-1||u===void 0)u=x;else if(u===-2)u=F-x-2;else if(u<-2)throw new Error("invalid salt length");if(F<x+u+2)throw new Error("data too long");var U="";u>0&&(U=new Array(u),new ha().nextBytes(U),U=String.fromCharCode.apply(String,U));var W=Dn(V(Ar("\0\0\0\0\0\0\0\0"+f+U))),G=[];for(D=0;D<F-u-x-2;D+=1)G[D]=0;var A=String.fromCharCode.apply(String,G)+""+U,B=op(W,A.length,V),O=[];for(D=0;D<A.length;D+=1)O[D]=A.charCodeAt(D)^B.charCodeAt(D);var H=65280>>8*F-y&255;for(O[0]&=~H,D=0;D<x;D++)O.push(W.charCodeAt(D));return O.push(188),ap(this.doPrivate(new g(O)).toString(16),this.n.bitLength())};function cp(a){for(var l in C.crypto.Util.DIGESTINFOHEAD){var u=C.crypto.Util.DIGESTINFOHEAD[l],f=u.length;if(a.substring(0,f)==u){var x=[l,a.substring(f)];return x}}return[]}Lt.prototype.verify=function(a,l){if(l=l.toLowerCase(),l.match(/^[0-9a-f]+$/)==null)return!1;var u=Pn(l,16),f=this.n.bitLength();if(u.bitLength()>f)return!1;var x=this.doPublic(u),y=x.toString(16);if(y.length+3!=f/4)return!1;var F=y.replace(/^1f+00/,""),D=cp(F);if(D.length==0)return!1;var V=D[0],U=D[1],W=function(A){return C.crypto.Util.hashString(A,V)},G=W(a);return U==G},Lt.prototype.verifyWithMessageHash=function(a,l){if(l.length!=Math.ceil(this.n.bitLength()/4))return!1;var u=Pn(l,16);if(u.bitLength()>this.n.bitLength())return 0;var f=this.doPublic(u),x=f.toString(16).replace(/^1f+00/,""),y=cp(x);if(y.length==0)return!1;y[0];var F=y[1];return F==a},Lt.prototype.verifyPSS=function(a,l,u,f){var x=function(F){return C.crypto.Util.hashHex(F,u)},y=x(Ar(a));return f===void 0&&(f=-1),this.verifyWithMessageHashPSS(y,l,u,f)},Lt.prototype.verifyWithMessageHashPSS=function(a,l,u,f){if(l.length!=Math.ceil(this.n.bitLength()/4))return!1;var x=new g(l,16),y=function(ce){return C.crypto.Util.hashHex(ce,u)},F=Dn(a),D=F.length,V=this.n.bitLength()-1,U=Math.ceil(V/8),W;if(f===-1||f===void 0)f=D;else if(f===-2)f=U-D-2;else if(f<-2)throw new Error("invalid salt length");if(U<D+f+2)throw new Error("data too long");var G=this.doPublic(x).toByteArray();for(W=0;W<G.length;W+=1)G[W]&=255;for(;G.length<U;)G.unshift(0);if(G[U-1]!==188)throw new Error("encoded message does not end in 0xbc");G=String.fromCharCode.apply(String,G);var A=G.substr(0,U-D-1),B=G.substr(A.length,D),O=65280>>8*U-V&255;if((A.charCodeAt(0)&O)!==0)throw new Error("bits beyond keysize not zero");var H=op(B,A.length,y),q=[];for(W=0;W<A.length;W+=1)q[W]=A.charCodeAt(W)^H.charCodeAt(W);q[0]&=~O;var Z=U-D-f-2;for(W=0;W<Z;W+=1)if(q[W]!==0)throw new Error("leftmost octets not zero");if(q[Z]!==1)throw new Error("0x01 marker not found");return B===Dn(y(Ar("\0\0\0\0\0\0\0\0"+F+String.fromCharCode.apply(String,q.slice(-f)))))},Lt.SALT_LEN_HLEN=-1,Lt.SALT_LEN_MAX=-2,Lt.SALT_LEN_RECOVER=-2;function At(a){var l=Xe,u=l.getChildIdx,f=l.getV;l.dump;var x=l.parse,y=l.getTLV,F=l.getVbyList,D=l.getVbyListEx,V=l.getTLVbyList,U=l.getTLVbyListEx,W=l.getIdxbyList,G=l.getIdxbyListEx,A=l.getVidx,B=l.getInt,O=l.oidname,H=l.hextooidstr,q=Ui,Z,ce=Error;try{Z=C.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch{}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(this.hex===null||this.version!==0)return this.version;var Y=V(this.hex,0,[0,0]);if(Y.substr(0,2)=="a0"){var Q=V(Y,0,[0]),re=B(Q,0);if(re<0||2<re)throw new Error("malformed version field");return this.version=re+1,this.version}else return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return D(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var Y=U(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(Y)},this.getAlgorithmIdentifierName=function(Y){for(var Q in Z)if(Y===Z[Q])return Q;return O(D(Y,0,[0],"06"))},this.getIssuer=function(Y,Q){return this.getX500Name(this.getIssuerHex(),Y,Q)},this.getIssuerHex=function(){return V(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){var Y=this.getIssuer();return Y.str},this.getSubject=function(Y,Q){return this.getX500Name(this.getSubjectHex(),Y,Q)},this.getSubjectHex=function(){return V(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){var Y=this.getSubject();return Y.str},this.getNotBefore=function(){var Y=F(this.hex,0,[0,4+this.foffset,0]);return Y=Y.replace(/(..)/g,"%$1"),Y=decodeURIComponent(Y),Y},this.getNotAfter=function(){var Y=F(this.hex,0,[0,4+this.foffset,1]);return Y=Y.replace(/(..)/g,"%$1"),Y=decodeURIComponent(Y),Y},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return V(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var Y=this.getSPKI();return Y==null?null:F(Y,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return W(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var Y=this.getPublicKeyIdx();return W(this.hex,Y,[1,0],"30")},this.getPublicKey=function(){return Yt.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var Y=V(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(Y)},this.getSignatureValueHex=function(){return F(this.hex,0,[2],"03",!0)},this.verifySignature=function(Y){var Q=this.getSignatureAlgorithmField(),re=this.getSignatureValueHex(),J=V(this.hex,0,[0],"30"),oe=new C.crypto.Signature({alg:Q});return oe.init(Y),oe.updateHex(J),oe.verify(re)},this.parseExt=function(Y){var Q,re,J;if(Y===void 0){if(J=this.hex,this.version!==3)return-1;Q=W(J,0,[0,7,0],"30"),re=u(J,Q)}else{J=Ui(Y);var oe=W(J,0,[0,3,0,0],"06");if(f(J,oe)!="2a864886f70d01090e"){this.aExtInfo=new Array;return}Q=W(J,0,[0,3,0,1,0],"30"),re=u(J,Q),this.hex=J}this.aExtInfo=new Array;for(var me=0;me<re.length;me++){var ye={};ye.critical=!1;var Be=u(J,re[me]),be=0;Be.length===3&&(ye.critical=!0,be=1),ye.oid=l.hextooidstr(F(J,re[me],[0],"06"));var Te=W(J,re[me],[1+be]);ye.vidx=A(J,Te),this.aExtInfo.push(ye)}},this.getExtInfo=function(Y){var Q=this.aExtInfo,re=Y;if(Y.match(/^[0-9.]+$/)||(re=C.asn1.x509.OID.name2oid(Y)),re!==""){for(var J=0;J<Q.length;J++)if(Q[J].oid===re)return Q[J]}},this.getCriticalExtV=function(Y,Q,re){if(Q!=null)return[Q,re];var J=this.getExtInfo(Y);return J==null?[null,null]:[y(this.hex,J.vidx),J.critical]},this.getExtBasicConstraints=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("basicConstraints");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"basicConstraints"};if(Q&&(J.critical=!0),Y==="3000")return J;if(Y==="30030101ff")return J.cA=!0,J;if(Y.substr(0,12)==="30060101ff02"){var oe=f(Y,10),me=parseInt(oe,16);return J.cA=!0,J.pathLen=me,J}throw new Error("hExtV parse error: "+Y)},this.getExtNameConstraints=function(Y,Q){var re=this.getCriticalExtV("nameConstraints",Y,Q);if(Y=re[0],Q=re[1],Y!=null){var J={extname:"nameConstraints"};Q&&(J.critical=!0);for(var oe=u(Y,0),me=0;me<oe.length;me++){for(var ye=[],Be=u(Y,oe[me]),be=0;be<Be.length;be++){var Te=y(Y,Be[be]),He=this.getGeneralSubtree(Te);ye.push(He)}var qe=Y.substr(oe[me],2);qe=="a0"?J.permit=ye:qe=="a1"&&(J.exclude=ye)}return J}},this.getGeneralSubtree=function(Y){var Q=u(Y,0),re=Q.length;if(re<1||2<re)throw new Error("wrong num elements");for(var J=this.getGeneralName(y(Y,Q[0])),oe=1;oe<re;oe++){var me=Y.substr(Q[oe],2),ye=f(Y,Q[oe]),Be=parseInt(ye,16);me=="80"&&(J.min=Be),me=="81"&&(J.max=Be)}return J},this.getExtKeyUsage=function(Y,Q){var re=this.getCriticalExtV("keyUsage",Y,Q);if(Y=re[0],Q=re[1],Y!=null){var J={extname:"keyUsage"};return Q&&(J.critical=!0),J.names=this.getExtKeyUsageString(Y).split(","),J}},this.getExtKeyUsageBin=function(Y){if(Y===void 0){var Q=this.getExtInfo("keyUsage");if(Q===void 0)return"";Y=y(this.hex,Q.vidx)}if(Y.length!=8&&Y.length!=10)throw new Error("malformed key usage value: "+Y);var re="000000000000000"+parseInt(Y.substr(6),16).toString(2);return Y.length==8&&(re=re.slice(-8)),Y.length==10&&(re=re.slice(-16)),re=re.replace(/0+$/,""),re==""&&(re="0"),re},this.getExtKeyUsageString=function(Y){for(var Q=this.getExtKeyUsageBin(Y),re=new Array,J=0;J<Q.length;J++)Q.substr(J,1)=="1"&&re.push(At.KEYUSAGE_NAME[J]);return re.join(",")},this.getExtSubjectKeyIdentifier=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("subjectKeyIdentifier");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"subjectKeyIdentifier"};Q&&(J.critical=!0);var oe=f(Y,0);return J.kid={hex:oe},J},this.getExtAuthorityKeyIdentifier=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("authorityKeyIdentifier");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"authorityKeyIdentifier"};Q&&(J.critical=!0);for(var oe=u(Y,0),me=0;me<oe.length;me++){var ye=Y.substr(oe[me],2);if(ye==="80"&&(J.kid={hex:f(Y,oe[me])}),ye==="a1"){var Be=y(Y,oe[me]),be=this.getGeneralNames(Be);J.issuer=be[0].dn}ye==="82"&&(J.sn={hex:f(Y,oe[me])})}return J},this.getExtExtKeyUsage=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("extKeyUsage");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"extKeyUsage",array:[]};Q&&(J.critical=!0);for(var oe=u(Y,0),me=0;me<oe.length;me++)J.array.push(O(f(Y,oe[me])));return J},this.getExtExtKeyUsageName=function(){var Y=this.getExtInfo("extKeyUsage");if(Y===void 0)return Y;var Q=new Array,re=y(this.hex,Y.vidx);if(re==="")return Q;for(var J=u(re,0),oe=0;oe<J.length;oe++)Q.push(O(f(re,J[oe])));return Q},this.getExtSubjectAltName=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("subjectAltName");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"subjectAltName",array:[]};return Q&&(J.critical=!0),J.array=this.getGeneralNames(Y),J},this.getExtIssuerAltName=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("issuerAltName");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"issuerAltName",array:[]};return Q&&(J.critical=!0),J.array=this.getGeneralNames(Y),J},this.getGeneralNames=function(Y){for(var Q=u(Y,0),re=[],J=0;J<Q.length;J++){var oe=this.getGeneralName(y(Y,Q[J]));oe!==void 0&&re.push(oe)}return re},this.getGeneralName=function(Y){var Q=Y.substr(0,2),re=f(Y,0),J=Dn(re);if(Q=="81")return{rfc822:J};if(Q=="82")return{dns:J};if(Q=="86")return{uri:J};if(Q=="87")return{ip:fc(re)};if(Q=="a4")return{dn:this.getX500Name(re)};if(Q=="a0")return{other:this.getOtherName(Y)}},this.getExtSubjectAltName2=function(){var Y,Q,re,J=this.getExtInfo("subjectAltName");if(J===void 0)return J;for(var oe=new Array,me=y(this.hex,J.vidx),ye=u(me,0),Be=0;Be<ye.length;Be++)re=me.substr(ye[Be],2),Y=f(me,ye[Be]),re==="81"&&(Q=gi(Y),oe.push(["MAIL",Q])),re==="82"&&(Q=gi(Y),oe.push(["DNS",Q])),re==="84"&&(Q=At.hex2dn(Y,0),oe.push(["DN",Q])),re==="86"&&(Q=gi(Y),oe.push(["URI",Q])),re==="87"&&(Q=fc(Y),oe.push(["IP",Q]));return oe},this.getExtCRLDistributionPoints=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("cRLDistributionPoints");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"cRLDistributionPoints",array:[]};Q&&(J.critical=!0);for(var oe=u(Y,0),me=0;me<oe.length;me++){var ye=y(Y,oe[me]);J.array.push(this.getDistributionPoint(ye))}return J},this.getDistributionPoint=function(Y){for(var Q={},re=u(Y,0),J=0;J<re.length;J++){var oe=Y.substr(re[J],2),me=y(Y,re[J]);oe=="a0"&&(Q.dpname=this.getDistributionPointName(me))}return Q},this.getDistributionPointName=function(Y){for(var Q={},re=u(Y,0),J=0;J<re.length;J++){var oe=Y.substr(re[J],2),me=y(Y,re[J]);oe=="a0"&&(Q.full=this.getGeneralNames(me))}return Q},this.getExtCRLDistributionPointsURI=function(){var Y=this.getExtCRLDistributionPoints();if(Y==null)return Y;for(var Q=Y.array,re=[],J=0;J<Q.length;J++)try{Q[J].dpname.full[0].uri!=null&&re.push(Q[J].dpname.full[0].uri)}catch{}return re},this.getExtAIAInfo=function(){var Y=this.getExtInfo("authorityInfoAccess");if(Y===void 0)return Y;for(var Q={ocsp:[],caissuer:[]},re=u(this.hex,Y.vidx),J=0;J<re.length;J++){var oe=F(this.hex,re[J],[0],"06"),me=F(this.hex,re[J],[1],"86");oe==="2b06010505073001"&&Q.ocsp.push(gi(me)),oe==="2b06010505073002"&&Q.caissuer.push(gi(me))}return Q},this.getExtAuthorityInfoAccess=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("authorityInfoAccess");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"authorityInfoAccess",array:[]};Q&&(J.critical=!0);for(var oe=u(Y,0),me=0;me<oe.length;me++){var ye=D(Y,oe[me],[0],"06"),Be=F(Y,oe[me],[1],"86"),be=gi(Be);if(ye=="2b06010505073001")J.array.push({ocsp:be});else if(ye=="2b06010505073002")J.array.push({caissuer:be});else throw new Error("unknown method: "+ye)}return J},this.getExtCertificatePolicies=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("certificatePolicies");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"certificatePolicies",array:[]};Q&&(J.critical=!0);for(var oe=u(Y,0),me=0;me<oe.length;me++){var ye=y(Y,oe[me]),Be=this.getPolicyInformation(ye);J.array.push(Be)}return J},this.getPolicyInformation=function(Y){var Q={},re=F(Y,0,[0],"06");Q.policyoid=O(re);var J=G(Y,0,[1],"30");if(J!=-1){Q.array=[];for(var oe=u(Y,J),me=0;me<oe.length;me++){var ye=y(Y,oe[me]),Be=this.getPolicyQualifierInfo(ye);Q.array.push(Be)}}return Q},this.getOtherName=function(Y){var Q={},re=u(Y,0),J=F(Y,re[0],[],"06"),oe=F(Y,re[1],[]);return Q.oid=O(J),Q.value=x(oe),Q},this.getPolicyQualifierInfo=function(Y){var Q={},re=F(Y,0,[0],"06");if(re==="2b06010505070201"){var J=D(Y,0,[1],"16");Q.cps=Dn(J)}else if(re==="2b06010505070202"){var oe=V(Y,0,[1],"30");Q.unotice=this.getUserNotice(oe)}return Q},this.getUserNotice=function(Y){var Q=null;try{Q=l.parse(Y);var re=this._asn1ToUnotice(Q);return re}catch{return}},this._asn1ToUnotice=function(Y){try{for(var Q={},re=yi(Y,"seq"),J=0;J<re.length;J++){var oe=this._asn1ToNoticeRef(re[J]);oe!=null&&(Q.noticeref=oe);var me=this.asn1ToDisplayText(re[J]);me!=null&&(Q.exptext=me)}return Object.keys(Q).length>0?Q:void 0}catch{return}},this._asn1ToNoticeRef=function(Y){try{for(var Q={},re=yi(Y,"seq"),J=0;J<re.length;J++){var oe=this._asn1ToNoticeNum(re[J]);oe!=null&&(Q.noticenum=oe);var me=this.asn1ToDisplayText(re[J]);me!=null&&(Q.org=me)}return Object.keys(Q).length>0?Q:void 0}catch{return}},this._asn1ToNoticeNum=function(Y){try{for(var Q=yi(Y,"seq"),re=[],J=0;J<Q.length;J++){var oe=Q[J];re.push(parseInt(yi(oe,"int.hex"),16))}return re}catch{return}},this.getDisplayText=function(Y){var Q={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"},re={};return re.type=Q[Y.substr(0,2)],re.str=Dn(f(Y,0)),re},this.asn1ToDisplayText=function(Y){if(Y.utf8str!=null)return{type:"utf8",str:Y.utf8str.str};if(Y.ia5str!=null)return{type:"ia5",str:Y.ia5str.str};if(Y.visstr!=null)return{type:"vis",str:Y.visstr.str};if(Y.bmpstr!=null)return{type:"bmp",str:Y.bmpstr.str};if(Y.prnstr!=null)return{type:"prn",str:Y.prnstr.str}},this.getExtPolicyMappings=function(Y,Q){var re=this.getCriticalExtV("policyMappings",Y,Q);if(Y=re[0],Q=re[1],Y!=null){var J={extname:"policyMappings"};Q&&(J.critical=!0);try{for(var oe=x(Y),me=oe.seq,ye=[],Be=0;Be<me.length;Be++){var be=me[Be].seq;ye.push([be[0].oid,be[1].oid])}J.array=ye}catch{throw new ce("malformed policyMappings")}return J}},this.getExtPolicyConstraints=function(Y,Q){var re=this.getCriticalExtV("policyConstraints",Y,Q);if(Y=re[0],Q=re[1],Y!=null){var J={extname:"policyConstraints"};Q&&(J.critical=!0);var oe=x(Y);try{for(var me=oe.seq,ye=0;ye<me.length;ye++){var Be=me[ye].tag;Be.explicit==!1&&(Be.tag=="80"&&(J.reqexp=parseInt(Be.hex,16)),Be.tag=="81"&&(J.inhibit=parseInt(Be.hex,16)))}}catch{return new ce("malformed policyConstraints value")}return J}},this.getExtInhibitAnyPolicy=function(Y,Q){var re=this.getCriticalExtV("inhibitAnyPolicy",Y,Q);if(Y=re[0],Q=re[1],Y!=null){var J={extname:"inhibitAnyPolicy"};Q&&(J.critical=!0);var oe=B(Y,0);return oe==-1?new ce("wrong value"):(J.skip=oe,J)}},this.getExtCRLNumber=function(Y,Q){var re={extname:"cRLNumber"};if(Q&&(re.critical=!0),Y.substr(0,2)=="02")return re.num={hex:f(Y,0)},re;throw new ce("hExtV parse error: "+Y)},this.getExtCRLReason=function(Y,Q){var re={extname:"cRLReason"};if(Q&&(re.critical=!0),Y.substr(0,2)=="0a")return re.code=parseInt(f(Y,0),16),re;throw new Error("hExtV parse error: "+Y)},this.getExtOcspNonce=function(Y,Q){var re={extname:"ocspNonce"};Q&&(re.critical=!0);var J=f(Y,0);return re.hex=J,re},this.getExtOcspNoCheck=function(Y,Q){var re={extname:"ocspNoCheck"};return Q&&(re.critical=!0),re},this.getExtAdobeTimeStamp=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("adobeTimeStamp");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"adobeTimeStamp"};Q&&(J.critical=!0);var oe=u(Y,0);if(oe.length>1){var me=y(Y,oe[1]),ye=this.getGeneralName(me);ye.uri!=null&&(J.uri=ye.uri)}if(oe.length>2){var Be=y(Y,oe[2]);Be=="0101ff"&&(J.reqauth=!0),Be=="010100"&&(J.reqauth=!1)}return J},this.getExtSubjectDirectoryAttributes=function(Y,Q){if(Y===void 0&&Q===void 0){var re=this.getExtInfo("subjectDirectoryAttributes");if(re===void 0)return;Y=y(this.hex,re.vidx),Q=re.critical}var J={extname:"subjectDirectoryAttributes"};Q&&(J.critical=!0);try{for(var oe=x(Y),me=[],ye=0;ye<oe.seq.length;ye++){var Be=oe.seq[ye],be=yi(Be,"seq.0.oid"),Te=yi(Be,"seq.1.set");if(be==null||Te==null)throw"error";me.push({attr:be,array:Te})}return J.array=me,J}catch{throw new Error("malformed subjectDirectoryAttributes extension value")}};var fe=function(Y){var Q={};try{var re=Y.seq[0].oid,J=C.asn1.x509.OID.name2oid(re);Q.type=C.asn1.x509.OID.oid2atype(J);var oe=Y.seq[1];if(oe.utf8str!=null)Q.ds="utf8",Q.value=oe.utf8str.str;else if(oe.numstr!=null)Q.ds="num",Q.value=oe.numstr.str;else if(oe.telstr!=null)Q.ds="tel",Q.value=oe.telstr.str;else if(oe.prnstr!=null)Q.ds="prn",Q.value=oe.prnstr.str;else if(oe.ia5str!=null)Q.ds="ia5",Q.value=oe.ia5str.str;else if(oe.visstr!=null)Q.ds="vis",Q.value=oe.visstr.str;else if(oe.bmpstr!=null)Q.ds="bmp",Q.value=oe.bmpstr.str;else throw"error";return Q}catch{throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},pe=function(Y){try{return Y.set.map(function(Q){return fe(Q)})}catch(Q){throw new Error("improper ASN.1 parsed RDN: "+Q)}},ge=function(Y){try{return Y.seq.map(function(Q){return pe(Q)})}catch(Q){throw new Error("improper ASN.1 parsed X500Name: "+Q)}};this.getX500NameRule=function(Y){for(var Q=null,re=[],J=0;J<Y.length;J++)for(var oe=Y[J],me=0;me<oe.length;me++)re.push(oe[me]);for(var J=0;J<re.length;J++){var ye=re[J],Be=ye.ds,be=ye.value,Te=ye.type;if(Be!="prn"&&Be!="utf8"&&Be!="ia5")return"mixed";if(Be=="ia5"){if(Te!="CN")return"mixed";if(C.lang.String.isMail(be))continue;return"mixed"}if(Te=="C"){if(Be=="prn")continue;return"mixed"}if(Q==null)Q=Be;else if(Q!==Be)return"mixed"}return Q??"prn"},this.getAttrTypeAndValue=function(Y){var Q=x(Y);return fe(Q)},this.getRDN=function(Y){var Q=x(Y);return pe(Q)},this.getX500NameArray=function(Y){var Q=x(Y);return ge(Q)},this.getX500Name=function(Y,Q,re){var J=this.getX500NameArray(Y),oe=this.dnarraytostr(J),me={str:oe};return me.array=J,re==!0&&(me.hex=Y),Q==!0&&(me.canon=this.c14nRDNArray(J)),me},this.readCertPEM=function(Y){this.readCertHex(q(Y))},this.readCertHex=function(Y){this.hex=Y,this.getVersion();try{W(this.hex,0,[0,7],"a3"),this.parseExt()}catch{}},this.getParam=function(Y){var Q={};return Y==null&&(Y={}),Q.version=this.getVersion(),Q.serial={hex:this.getSerialNumberHex()},Q.sigalg=this.getSignatureAlgorithmField(),Q.issuer=this.getIssuer(Y.dncanon,Y.dnhex),Q.notbefore=this.getNotBefore(),Q.notafter=this.getNotAfter(),Q.subject=this.getSubject(Y.dncanon,Y.dnhex),Q.sbjpubkey=hn(this.getPublicKeyHex(),"PUBLIC KEY"),this.aExtInfo!=null&&this.aExtInfo.length>0&&(Q.ext=this.getExtParamArray()),Q.sighex=this.getSignatureValueHex(),Y.tbshex==!0&&(Q.tbshex=V(this.hex,0,[0])),Y.nodnarray==!0&&(delete Q.issuer.array,delete Q.subject.array),Q},this.getExtParamArray=function(Y){if(Y==null){var Q=G(this.hex,0,[0,"[3]"]);Q!=-1&&(Y=U(this.hex,0,[0,"[3]",0],"30"))}for(var re=[],J=u(Y,0),oe=0;oe<J.length;oe++){var me=y(Y,J[oe]),ye=this.getExtParam(me);ye!=null&&re.push(ye)}return re},this.getExtParam=function(Y){var Q=u(Y,0),re=Q.length;if(re!=2&&re!=3)throw new Error("wrong number elements in Extension: "+re+" "+Y);var J=H(F(Y,0,[0],"06")),oe=!1;re==3&&V(Y,0,[1])=="0101ff"&&(oe=!0);var me=V(Y,0,[re-1,0]),ye=void 0;if(J=="2.5.29.14"?ye=this.getExtSubjectKeyIdentifier(me,oe):J=="2.5.29.15"?ye=this.getExtKeyUsage(me,oe):J=="2.5.29.17"?ye=this.getExtSubjectAltName(me,oe):J=="2.5.29.18"?ye=this.getExtIssuerAltName(me,oe):J=="2.5.29.19"?ye=this.getExtBasicConstraints(me,oe):J=="2.5.29.30"?ye=this.getExtNameConstraints(me,oe):J=="2.5.29.31"?ye=this.getExtCRLDistributionPoints(me,oe):J=="2.5.29.32"?ye=this.getExtCertificatePolicies(me,oe):J=="2.5.29.33"?ye=this.getExtPolicyMappings(me,oe):J=="2.5.29.35"?ye=this.getExtAuthorityKeyIdentifier(me,oe):J=="2.5.29.36"?ye=this.getExtPolicyConstraints(me,oe):J=="2.5.29.37"?ye=this.getExtExtKeyUsage(me,oe):J=="2.5.29.54"?ye=this.getExtInhibitAnyPolicy(me,oe):J=="1.3.6.1.5.5.7.1.1"?ye=this.getExtAuthorityInfoAccess(me,oe):J=="2.5.29.20"?ye=this.getExtCRLNumber(me,oe):J=="2.5.29.21"?ye=this.getExtCRLReason(me,oe):J=="2.5.29.9"?ye=this.getExtSubjectDirectoryAttributes(me,oe):J=="1.3.6.1.5.5.7.48.1.2"?ye=this.getExtOcspNonce(me,oe):J=="1.3.6.1.5.5.7.48.1.5"?ye=this.getExtOcspNoCheck(me,oe):J=="1.2.840.113583.1.1.9.1"?ye=this.getExtAdobeTimeStamp(me,oe):At.EXT_PARSER[J]!=null&&(ye=At.EXT_PARSER[J](J,oe,me)),ye!=null)return ye;var Be={extname:J,extn:me};try{Be.extn=x(me)}catch{}return oe&&(Be.critical=!0),Be},this.findExt=function(Y,Q){for(var re=0;re<Y.length;re++)if(Y[re].extname==Q)return Y[re];return null},this.updateExtCDPFullURI=function(Y,Q){var re=this.findExt(Y,"cRLDistributionPoints");if(re!=null&&re.array!=null){for(var J=re.array,oe=0;oe<J.length;oe++)if(J[oe].dpname!=null&&J[oe].dpname.full!=null)for(var me=J[oe].dpname.full,ye=0;ye<me.length;ye++){var Be=me[oe];Be.uri!=null&&(Be.uri=Q)}}},this.updateExtAIAOCSP=function(Y,Q){var re=this.findExt(Y,"authorityInfoAccess");if(re!=null&&re.array!=null)for(var J=re.array,oe=0;oe<J.length;oe++)J[oe].ocsp!=null&&(J[oe].ocsp=Q)},this.updateExtAIACAIssuer=function(Y,Q){var re=this.findExt(Y,"authorityInfoAccess");if(re!=null&&re.array!=null)for(var J=re.array,oe=0;oe<J.length;oe++)J[oe].caissuer!=null&&(J[oe].caissuer=Q)},this.dnarraytostr=function(Y){function Q(J){return J.map(function(oe){return re(oe).replace(/\+/,"\\+")}).join("+")}function re(J){return J.type+"="+J.value}return"/"+Y.map(function(J){return Q(J).replace(/\//,"\\/")}).join("/")},this.setCanonicalizedDN=function(Y){var Q;if(Y.str!=null&&Y.array==null){var re=new C.asn1.x509.X500Name({str:Y.str}),J=re.tohex();Q=this.getX500NameArray(J)}else Q=Y.array;Y.canon==null&&(Y.canon=this.c14nRDNArray(Q))},this.c14nRDNArray=function(Y){for(var Q=[],re=0;re<Y.length;re++){for(var J=Y[re],oe=[],me=0;me<J.length;me++){var ye=J[me],Be=ye.value;Be=Be.replace(/^\s*/,""),Be=Be.replace(/\s*$/,""),Be=Be.replace(/\s+/g," "),Be=Be.toLowerCase(),oe.push(ye.type.toLowerCase()+"="+Be)}Q.push(oe.join("+"))}return"/"+Q.join("/")},this.getInfo=function(){var Y=function(bn){for(var ei="",bi="    ",Li=`
`,Oi=bn.array,In=0;In<Oi.length;In++){var Bi=Oi[In];if(Bi.dn!=null&&(ei+=bi+"dn: "+Bi.dn.str+Li),Bi.ip!=null&&(ei+=bi+"ip: "+Bi.ip+Li),Bi.rfc822!=null&&(ei+=bi+"rfc822: "+Bi.rfc822+Li),Bi.dns!=null&&(ei+=bi+"dns: "+Bi.dns+Li),Bi.uri!=null&&(ei+=bi+"uri: "+Bi.uri+Li),Bi.other!=null){var uo=Bi.other.oid,Fs=JSON.stringify(Bi.other.value).replace(/\"/g,"");ei+=bi+"other: "+uo+"="+Fs+Li}}return ei=ei.replace(/\n$/,""),ei},Q=function(bn){for(var ei="",bi=bn.array,Li=0;Li<bi.length;Li++){var Oi=bi[Li];if(ei+="    policy oid: "+Oi.policyoid+`
`,Oi.array!==void 0)for(var In=0;In<Oi.array.length;In++){var Bi=Oi.array[In];Bi.cps!==void 0&&(ei+="    cps: "+Bi.cps+`
`)}}return ei},re=function(bn){for(var ei="",bi=bn.array,Li=0;Li<bi.length;Li++){var Oi=bi[Li];try{Oi.dpname.full[0].uri!==void 0&&(ei+="    "+Oi.dpname.full[0].uri+`
`)}catch{}try{Oi.dname.full[0].dn.hex!==void 0&&(ei+="    "+At.hex2dn(Oi.dpname.full[0].dn.hex)+`
`)}catch{}}return ei},J=function(bn){for(var ei="",bi=bn.array,Li=0;Li<bi.length;Li++){var Oi=bi[Li];Oi.caissuer!==void 0&&(ei+="    caissuer: "+Oi.caissuer+`
`),Oi.ocsp!==void 0&&(ei+="    ocsp: "+Oi.ocsp+`
`)}return ei},oe,me,ye;if(oe=`Basic Fields
`,oe+="  serial number: "+this.getSerialNumberHex()+`
`,oe+="  signature algorithm: "+this.getSignatureAlgorithmField()+`
`,oe+="  issuer: "+this.getIssuerString()+`
`,oe+="  notBefore: "+this.getNotBefore()+`
`,oe+="  notAfter: "+this.getNotAfter()+`
`,oe+="  subject: "+this.getSubjectString()+`
`,oe+=`  subject public key info: 
`,me=this.getPublicKey(),oe+="    key algorithm: "+me.type+`
`,me.type==="RSA"&&(oe+="    n="+dd(me.n.toString(16)).substr(0,16)+`...
`,oe+="    e="+dd(me.e.toString(16))+`
`),ye=this.aExtInfo,ye!=null){oe+=`X509v3 Extensions:
`;for(var Be=0;Be<ye.length;Be++){var be=ye[Be],Te=C.asn1.x509.OID.oid2name(be.oid);Te===""&&(Te=be.oid);var He="";if(be.critical===!0&&(He="CRITICAL"),oe+="  "+Te+" "+He+`:
`,Te==="basicConstraints"){var qe=this.getExtBasicConstraints();qe.cA===void 0?oe+=`    {}
`:(oe+="    cA=true",qe.pathLen!==void 0&&(oe+=", pathLen="+qe.pathLen),oe+=`
`)}else if(Te=="policyMappings"){var pn=this.getExtPolicyMappings().array,Ni=pn.map(function(bn){var ei=bn;return ei[0]+":"+ei[1]}).join(", ");oe+="    "+Ni+`
`}else if(Te=="policyConstraints"){var Ti=this.getExtPolicyConstraints();oe+="    ",Ti.reqexp!=null&&(oe+=" reqexp="+Ti.reqexp),Ti.inhibit!=null&&(oe+=" inhibit="+Ti.inhibit),oe+=`
`}else if(Te=="inhibitAnyPolicy"){var Ti=this.getExtInhibitAnyPolicy();oe+="    skip="+Ti.skip+`
`}else if(Te=="keyUsage")oe+="    "+this.getExtKeyUsageString()+`
`;else if(Te=="subjectKeyIdentifier")oe+="    "+this.getExtSubjectKeyIdentifier().kid.hex+`
`;else if(Te=="authorityKeyIdentifier"){var Vi=this.getExtAuthorityKeyIdentifier();Vi.kid!==void 0&&(oe+="    kid="+Vi.kid.hex+`
`)}else if(Te=="extKeyUsage"){var tn=this.getExtExtKeyUsage().array;oe+="    "+tn.join(", ")+`
`}else if(Te=="subjectAltName"){var an=Y(this.getExtSubjectAltName());oe+=an+`
`}else if(Te=="cRLDistributionPoints"){var nn=this.getExtCRLDistributionPoints();oe+=re(nn)}else if(Te=="authorityInfoAccess"){var lo=this.getExtAuthorityInfoAccess();oe+=J(lo)}else Te=="certificatePolicies"&&(oe+=Q(this.getExtCertificatePolicies()))}}return oe+="signature algorithm: "+this.getSignatureAlgorithmName()+`
`,oe+="signature: "+this.getSignatureValueHex().substr(0,16)+`...
`,oe},typeof a=="string"&&(a.indexOf("-----BEGIN")!=-1?this.readCertPEM(a):C.lang.String.isHex(a)&&this.readCertHex(a))}At.EXT_PARSER={},At.registExtParser=function(a,l){At.EXT_PARSER[a]=l},At.hex2dn=function(a,l){l===void 0&&(l=0);var u=new At;Xe.getTLV(a,l);var f=u.getX500Name(a);return f.str},At.hex2rdn=function(a,l){if(l===void 0&&(l=0),a.substr(l,2)!=="31")throw new Error("malformed RDN");for(var u=new Array,f=Xe.getChildIdx(a,l),x=0;x<f.length;x++)u.push(At.hex2attrTypeValue(a,f[x]));return u=u.map(function(y){return y.replace("+","\\+")}),u.join("+")},At.hex2attrTypeValue=function(a,l){var u=Xe,f=u.getV;if(l===void 0&&(l=0),a.substr(l,2)!=="30")throw new Error("malformed attribute type and value");var x=u.getChildIdx(a,l);x.length!==2||a.substr(x[0],2);var y=f(a,x[0]),F=C.asn1.ASN1Util.oidHexToInt(y),D=C.asn1.x509.OID.oid2atype(F),V=f(a,x[1]),U=Dn(V);return D+"="+U},At.getPublicKeyFromCertHex=function(a){var l=new At;return l.readCertHex(a),l.getPublicKey()},At.getPublicKeyFromCertPEM=function(a){var l=new At;return l.readCertPEM(a),l.getPublicKey()},At.getPublicKeyInfoPropOfCertPEM=function(a){var l=Xe,u=l.getVbyList,f={},x,y;return f.algparam=null,x=new At,x.readCertPEM(a),y=x.getPublicKeyHex(),f.keyhex=u(y,0,[1],"03").substr(2),f.algoid=u(y,0,[0,0],"06"),f.algoid==="2a8648ce3d0201"&&(f.algparam=u(y,0,[0,1],"06")),f},At.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"];var G_=function(a){var l=C,u=l.lang.String.isHex,f=Xe,x=f.getV,y=f.getTLV,F=f.getVbyList,D=f.getTLVbyList,V=f.getTLVbyListEx,U=f.getIdxbyList,W=f.getIdxbyListEx,G=f.getChildIdx,A=new At;this.hex=null,this.posSigAlg=null,this.posRevCert=null,this.parsed=null,this._setPos=function(){var B=U(this.hex,0,[0,0]),O=this.hex.substr(B,2);if(O=="02")this.posSigAlg=1;else if(O=="30")this.posSigAlg=0;else throw new Error("malformed 1st item of TBSCertList: "+O);var H=U(this.hex,0,[0,this.posSigAlg+3]),q=this.hex.substr(H,2);if(q=="17"||q=="18"){var Z,ce;Z=U(this.hex,0,[0,this.posSigAlg+4]),this.posRevCert=null,Z!=-1&&(ce=this.hex.substr(Z,2),ce=="30"&&(this.posRevCert=this.posSigAlg+4))}else if(q=="30")this.posRevCert=this.posSigAlg+3;else if(q=="a0")this.posRevCert=null;else throw new Error("malformed nextUpdate or revCert tag: "+q)},this.getVersion=function(){return this.posSigAlg==0?null:parseInt(F(this.hex,0,[0,0],"02"),16)+1},this.getSignatureAlgorithmField=function(){var B=D(this.hex,0,[0,this.posSigAlg],"30");return A.getAlgorithmIdentifierName(B)},this.getIssuer=function(){return A.getX500Name(this.getIssuerHex())},this.getIssuerHex=function(){return D(this.hex,0,[0,this.posSigAlg+1],"30")},this.getThisUpdate=function(){var B=F(this.hex,0,[0,this.posSigAlg+2]);return result=Dn(B)},this.getNextUpdate=function(){var B=U(this.hex,0,[0,this.posSigAlg+3]),O=this.hex.substr(B,2);return O!="17"&&O!="18"?null:Dn(x(this.hex,B))},this.getRevCertArray=function(){if(this.posRevCert==null)return null;for(var B=[],O=U(this.hex,0,[0,this.posRevCert]),H=G(this.hex,O),q=0;q<H.length;q++){var Z=y(this.hex,H[q]);B.push(this.getRevCert(Z))}return B},this.getRevCert=function(B){var O={},H=G(B,0);return O.sn={hex:F(B,0,[0],"02")},O.date=Dn(F(B,0,[1])),H.length==3&&(O.ext=A.getExtParamArray(D(B,0,[2]))),O},this.findRevCert=function(B){var O=new At(B),H=O.getSerialNumberHex();return this.findRevCertBySN(H)},this.findRevCertBySN=function(B){if(this.parsed==null&&this.getParam(),this.parsed.revcert==null)return null;for(var O=this.parsed.revcert,H=0;H<O.length;H++)if(B==O[H].sn.hex)return O[H];return null},this.getSignatureValueHex=function(){return F(this.hex,0,[2],"03",!0)},this.verifySignature=function(B){var O=this.getSignatureAlgorithmField(),H=this.getSignatureValueHex(),q=D(this.hex,0,[0],"30"),Z=new C.crypto.Signature({alg:O});return Z.init(B),Z.updateHex(q),Z.verify(H)},this.getParam=function(B){var O={},H=this.getVersion();H!=null&&(O.version=H),O.sigalg=this.getSignatureAlgorithmField(),O.issuer=this.getIssuer(),O.thisupdate=this.getThisUpdate();var q=this.getNextUpdate();q!=null&&(O.nextupdate=q);var Z=this.getRevCertArray();Z!=null&&(O.revcert=Z);var ce=W(this.hex,0,[0,"[0]"]);if(ce!=-1){var fe=V(this.hex,0,[0,"[0]",0]);O.ext=A.getExtParamArray(fe)}return O.sighex=this.getSignatureValueHex(),this.parsed=O,typeof B=="object"&&(B.tbshex==!0&&(O.tbshex=D(this.hex,0,[0])),B.nodnarray==!0&&delete O.issuer.array),O},typeof a=="string"&&(u(a)?this.hex=a:a.match(/-----BEGIN X509 CRL/)&&(this.hex=Ui(a)),this._setPos())};(typeof C>"u"||!C)&&(C={}),(typeof C.jws>"u"||!C.jws)&&(C.jws={}),C.jws.JWS=function(){var a=C,l=a.jws.JWS,u=l.isSafeJSONString;this.parseJWS=function(f,x){if(!(this.parsedJWS!==void 0&&(x||this.parsedJWS.sigvalH!==void 0))){var y=f.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(y==null)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var F=y[1],D=y[2],V=y[3],U=F+"."+D;if(this.parsedJWS={},this.parsedJWS.headB64U=F,this.parsedJWS.payloadB64U=D,this.parsedJWS.sigvalB64U=V,this.parsedJWS.si=U,!x){var W=Pi(V),G=Pn(W,16);this.parsedJWS.sigvalH=W,this.parsedJWS.sigvalBI=G}var A=lr(F),B=lr(D);if(this.parsedJWS.headS=A,this.parsedJWS.payloadS=B,!u(A,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+A}}},C.jws.JWS.sign=function(a,l,u,f,x){var y=C,F=y.jws,D=F.JWS,V=D.readSafeJSONString,U=D.isSafeJSONString,W=y.crypto;W.ECDSA;var G=W.Mac,A=W.Signature,B=JSON,O,H,q;if(typeof l!="string"&&typeof l!="object")throw"spHeader must be JSON string or object: "+l;if(typeof l=="object"&&(H=l,O=B.stringify(H)),typeof l=="string"){if(O=l,!U(O))throw"JWS Head is not safe JSON string: "+O;H=V(O)}if(q=u,typeof u=="object"&&(q=B.stringify(u)),(a==""||a==null)&&H.alg!==void 0&&(a=H.alg),a!=""&&a!=null&&H.alg===void 0&&(H.alg=a,O=B.stringify(H)),a!==H.alg)throw"alg and sHeader.alg doesn't match: "+a+"!="+H.alg;var Z=null;if(D.jwsalg2sigalg[a]===void 0)throw"unsupported alg name: "+a;Z=D.jwsalg2sigalg[a];var ce=oo(O),fe=oo(q),pe=ce+"."+fe,ge="";if(Z.substr(0,4)=="Hmac"){if(f===void 0)throw"mac key shall be specified for HS* alg";var Y=new G({alg:Z,prov:"cryptojs",pass:f});Y.updateString(pe),ge=Y.doFinal()}else if(Z.indexOf("withECDSA")!=-1){var Q=new A({alg:Z});Q.init(f,x),Q.updateString(pe);var re=Q.sign();ge=C.crypto.ECDSA.asn1SigToConcatSig(re)}else if(Z!="none"){var Q=new A({alg:Z});Q.init(f,x),Q.updateString(pe),ge=Q.sign()}var J=Yi(ge);return pe+"."+J},C.jws.JWS.verify=function(a,l,u){var f=C,x=f.jws,y=x.JWS,F=y.readSafeJSONString,D=f.crypto,V=D.ECDSA,U=D.Mac,W=D.Signature,G;if(typeof Lt!==void 0&&(G=Lt),!ld(a))return!1;var A=a.split(".");if(A.length!==3)return!1;var B=A[0],O=A[1],H=B+"."+O,q=Pi(A[2]),Z=F(lr(A[0])),ce=null,fe=null;if(Z.alg===void 0)throw"algorithm not specified in header";if(ce=Z.alg,fe=ce.substr(0,2),u!=null&&Object.prototype.toString.call(u)==="[object Array]"&&u.length>0){var pe=":"+u.join(":")+":";if(pe.indexOf(":"+ce+":")==-1)throw"algorithm '"+ce+"' not accepted in the list"}if(ce!="none"&&l===null)throw"key shall be specified to verify.";if(typeof l=="string"&&l.indexOf("-----BEGIN ")!=-1&&(l=Yt.getKey(l)),(fe=="RS"||fe=="PS")&&!(l instanceof G))throw"key shall be a RSAKey obj for RS* and PS* algs";if(fe=="ES"&&!(l instanceof V))throw"key shall be a ECDSA obj for ES* algs";var ge=null;if(y.jwsalg2sigalg[Z.alg]===void 0)throw"unsupported alg name: "+ce;if(ge=y.jwsalg2sigalg[ce],ge=="none")throw"not supported";if(ge.substr(0,4)=="Hmac"){var Y=null;if(l===void 0)throw"hexadecimal key shall be specified for HMAC";var Q=new U({alg:ge,pass:l});return Q.updateString(H),Y=Q.doFinal(),q==Y}else if(ge.indexOf("withECDSA")!=-1){var re=null;try{re=V.concatSigToASN1Sig(q)}catch{return!1}var J=new W({alg:ge});return J.init(l),J.updateString(H),J.verify(re)}else{var J=new W({alg:ge});return J.init(l),J.updateString(H),J.verify(q)}},C.jws.JWS.parse=function(a){var l=a.split("."),u={},f,x,y;if(l.length!=2&&l.length!=3)throw"malformed sJWS: wrong number of '.' splitted elements";return f=l[0],x=l[1],l.length==3&&(y=l[2]),u.headerObj=C.jws.JWS.readSafeJSONString(lr(f)),u.payloadObj=C.jws.JWS.readSafeJSONString(lr(x)),u.headerPP=JSON.stringify(u.headerObj,null,"  "),u.payloadObj==null?u.payloadPP=lr(x):u.payloadPP=JSON.stringify(u.payloadObj,null,"  "),y!==void 0&&(u.sigHex=Pi(y)),u},C.jws.JWS.verifyJWT=function(a,l,u){var f=C,x=f.jws,y=x.JWS,F=y.readSafeJSONString,D=y.inArray,V=y.includedArray;if(!ld(a))return!1;var U=a.split(".");if(U.length!=3)return!1;var W=U[0],G=U[1];Pi(U[2]);var A=F(lr(W)),B=F(lr(G));if(A.alg===void 0)return!1;if(u.alg===void 0)throw"acceptField.alg shall be specified";if(!D(A.alg,u.alg)||B.iss!==void 0&&typeof u.iss=="object"&&!D(B.iss,u.iss)||B.sub!==void 0&&typeof u.sub=="object"&&!D(B.sub,u.sub))return!1;if(B.aud!==void 0&&typeof u.aud=="object"){if(typeof B.aud=="string"){if(!D(B.aud,u.aud))return!1}else if(typeof B.aud=="object"&&!V(B.aud,u.aud))return!1}var O=x.IntDate.getNow();return u.verifyAt!==void 0&&typeof u.verifyAt=="number"&&(O=u.verifyAt),(u.gracePeriod===void 0||typeof u.gracePeriod!="number")&&(u.gracePeriod=0),!(B.exp!==void 0&&typeof B.exp=="number"&&B.exp+u.gracePeriod<O||B.nbf!==void 0&&typeof B.nbf=="number"&&O<B.nbf-u.gracePeriod||B.iat!==void 0&&typeof B.iat=="number"&&O<B.iat-u.gracePeriod||B.jti!==void 0&&u.jti!==void 0&&B.jti!==u.jti||!y.verify(a,l,u.alg))},C.jws.JWS.includedArray=function(a,l){var u=C.jws.JWS.inArray;if(a===null||typeof a!="object"||typeof a.length!="number")return!1;for(var f=0;f<a.length;f++)if(!u(a[f],l))return!1;return!0},C.jws.JWS.inArray=function(a,l){if(l===null||typeof l!="object"||typeof l.length!="number")return!1;for(var u=0;u<l.length;u++)if(l[u]==a)return!0;return!1},C.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},C.jws.JWS.isSafeJSONString=function(a,l,u){var f=null;try{return f=Wh(a),typeof f!="object"||f.constructor===Array?0:(l&&(l[u]=f),1)}catch{return 0}},C.jws.JWS.readSafeJSONString=function(a){var l=null;try{return l=Wh(a),typeof l!="object"||l.constructor===Array?null:l}catch{return null}},C.jws.JWS.getEncodedSignatureValueFromJWS=function(a){var l=a.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(l==null)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return l[1]},C.jws.JWS.getJWKthumbprint=function(a){if(a.kty!=="RSA"&&a.kty!=="EC"&&a.kty!=="oct")throw"unsupported algorithm for JWK Thumprint";var l="{";if(a.kty==="RSA"){if(typeof a.n!="string"||typeof a.e!="string")throw"wrong n and e value for RSA key";l+='"e":"'+a.e+'",',l+='"kty":"'+a.kty+'",',l+='"n":"'+a.n+'"}'}else if(a.kty==="EC"){if(typeof a.crv!="string"||typeof a.x!="string"||typeof a.y!="string")throw"wrong crv, x and y value for EC key";l+='"crv":"'+a.crv+'",',l+='"kty":"'+a.kty+'",',l+='"x":"'+a.x+'",',l+='"y":"'+a.y+'"}'}else if(a.kty==="oct"){if(typeof a.k!="string")throw"wrong k value for oct(symmetric) key";l+='"kty":"'+a.kty+'",',l+='"k":"'+a.k+'"}'}var u=Ar(l),f=C.crypto.Util.hashHex(u,"sha256"),x=Yi(f);return x},C.jws.IntDate={},C.jws.IntDate.get=function(a){var l=C.jws.IntDate,u=l.getNow,f=l.getZulu;if(a=="now")return u();if(a=="now + 1hour")return u()+60*60;if(a=="now + 1day")return u()+60*60*24;if(a=="now + 1month")return u()+60*60*24*30;if(a=="now + 1year")return u()+60*60*24*365;if(a.match(/Z$/))return f(a);if(a.match(/^[0-9]+$/))return parseInt(a);throw"unsupported format: "+a},C.jws.IntDate.getZulu=function(a){return Zh(a)},C.jws.IntDate.getNow=function(){var a=~~(new Date/1e3);return a},C.jws.IntDate.intDate2UTCString=function(a){var l=new Date(a*1e3);return l.toUTCString()},C.jws.IntDate.intDate2Zulu=function(a){var l=new Date(a*1e3),u=("0000"+l.getUTCFullYear()).slice(-4),f=("00"+(l.getUTCMonth()+1)).slice(-2),x=("00"+l.getUTCDate()).slice(-2),y=("00"+l.getUTCHours()).slice(-2),F=("00"+l.getUTCMinutes()).slice(-2),D=("00"+l.getUTCSeconds()).slice(-2);return u+f+x+y+F+D+"Z"},(typeof C>"u"||!C)&&(C={}),(typeof C.jws>"u"||!C.jws)&&(C.jws={}),C.jws.JWSJS=function(){var a=C,l=a.jws,u=l.JWS,f=u.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(x){this.init();var y=x.split(".");if(y.length!=3)throw"malformed input JWS";this.aHeader.push(y[0]),this.sPayload=y[1],this.aSignature.push(y[2])},this.addSignature=function(x,y,F,D){if(this.sPayload===void 0||this.sPayload===null)throw"there's no JSON-JS signature to add.";var V=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var U=C.jws.JWS.sign(x,y,this.sPayload,F,D),W=U.split("."),G=W[0],A=W[2];this.aHeader.push(W[0]),this.aSignature.push(W[2])}catch(B){throw this.aHeader.length>V&&this.aHeader.pop(),this.aSignature.length>V&&this.aSignature.pop(),"addSignature failed: "+B}},this.verifyAll=function(x){if(this.aHeader.length!==x.length||this.aSignature.length!==x.length)return!1;for(var y=0;y<x.length;y++){var F=x[y];if(F.length!==2)return!1;var D=this.verifyNth(y,F[0],F[1]);if(D===!1)return!1}return!0},this.verifyNth=function(x,y,F){if(this.aHeader.length<=x||this.aSignature.length<=x)return!1;var D=this.aHeader[x],V=this.aSignature[x],U=D+"."+this.sPayload+"."+V,W=!1;try{W=u.verify(U,y,F)}catch{return!1}return W},this.readJWSJS=function(x){if(typeof x=="string"){var y=f(x);if(y==null)throw"argument is not safe JSON object string";this.aHeader=y.headers,this.sPayload=y.payload,this.aSignature=y.signatures}else try{if(x.headers.length>0)this.aHeader=x.headers;else throw"malformed header";if(typeof x.payload=="string")this.sPayload=x.payload;else throw"malformed signatures";if(x.signatures.length>0)this.aSignature=x.signatures;else throw"malformed signatures"}catch(F){throw"malformed JWS-JS JSON object: "+F}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return this.aHeader.length==0?1:0}},t.SecureRandom=ha,t.rng_seed_time=or,t.BigInteger=g,t.RSAKey=Lt,t.ECDSA=C.crypto.ECDSA,t.DSA=C.crypto.DSA,t.Signature=C.crypto.Signature,t.MessageDigest=C.crypto.MessageDigest,t.Mac=C.crypto.Mac,t.KEYUTIL=Yt,t.ASN1HEX=Xe,t.X509=At,t.X509CRL=G_,t.CryptoJS=s,t.b64tohex=d,t.b64toBA=p,t.ECFieldElementFp=Zi,t.ECPointFp=oi,t.ECCurveFp=Gr,t.stoBA=Kh,t.BAtos=Xh,t.BAtohex=lc,t.stohex=An,t.stob64=E_,t.stob64u=C_,t.b64utos=T_,t.b64tob64u=pa,t.b64utob64=ao,t.hex2b64=h,t.hextob64u=Yi,t.b64utohex=Pi,t.utf8tob64u=oo,t.b64utoutf8=lr,t.utf8tob64=R_,t.b64toutf8=M_,t.utf8tohex=dc,t.hextoutf8=gi,t.hextorstr=Dn,t.rstrtohex=Ar,t.hextob64=nd,t.hextob64nl=D_,t.b64nltohex=$h,t.hextopem=hn,t.pemtohex=Ui,t.hextoArrayBuffer=N_,t.ArrayBuffertohex=L_,t.zulutomsec=rd,t.msectozulu=O_,t.zulutosec=Zh,t.zulutodate=k_,t.datetozulu=U_,t.uricmptohex=hc,t.hextouricmp=pc,t.ipv6tohex=sd,t.hextoipv6=ad,t.hextoip=fc,t.iptohex=od,t.ucs2hextoutf8=cd,t.encodeURIComponentAll=mc,t.newline_toUnix=B_,t.newline_toDos=H_,t.hextoposhex=dd,t.intarystrtohex=j_,t.strdiffidx=V_,t.oidtohex=tp,t.hextooid=gc,t.strpad=vc,t.bitstrtoint=np,t.inttobitstr=rp,t.bitstrtobinstr=sp,t.binstrtobitstr=z_,t.isBase64URLDot=ld,t.namearraytobinstr=_c,t.extendClass=Ue,t.foldnl=uc,t.b64topem=I_,t.pemtob64=F_,t.timeogen=Yh,t.aryval=yi,t.inttohex=ip,t.twoscompl=co,t.KJUR=C,t.crypto=C.crypto,t.asn1=C.asn1,t.jws=C.jws,t.lang=C.lang,t.VERSION=n,t.VERSION_FULL=r}}),vh=Fe({"../../node_modules/isomorphic-ws/browser.js"(t,e){ne();var i=null;typeof WebSocket<"u"?i=WebSocket:typeof MozWebSocket<"u"?i=MozWebSocket:typeof global<"u"?i=global.WebSocket||global.MozWebSocket:typeof window<"u"?i=window.WebSocket||window.MozWebSocket:typeof self<"u"&&(i=self.WebSocket||self.MozWebSocket),e.exports=i}}),cm=Fe({"../../node_modules/deepmerge/dist/cjs.js"(t,e){ne();var i=function(m){return n(m)&&!r(m)};function n(b){return!!b&&typeof b=="object"}function r(b){var m=Object.prototype.toString.call(b);return m==="[object RegExp]"||m==="[object Date]"||c(b)}var s=typeof Symbol=="function"&&Symbol.for,o=s?Symbol.for("react.element"):60103;function c(b){return b.$$typeof===o}function h(b){return Array.isArray(b)?[]:{}}function d(b,m){return m.clone!==!1&&m.isMergeableObject(b)?R(h(b),b,m):b}function p(b,m,w){return b.concat(m).map(function(T){return d(T,w)})}function v(b,m){if(!m.customMerge)return R;var w=m.customMerge(b);return typeof w=="function"?w:R}function g(b){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(b).filter(function(m){return Object.propertyIsEnumerable.call(b,m)}):[]}function _(b){return Object.keys(b).concat(g(b))}function S(b,m){try{return m in b}catch{return!1}}function E(b,m){return S(b,m)&&!(Object.hasOwnProperty.call(b,m)&&Object.propertyIsEnumerable.call(b,m))}function M(b,m,w){var T={};return w.isMergeableObject(b)&&_(b).forEach(function(P){T[P]=d(b[P],w)}),_(m).forEach(function(P){E(b,P)||(S(b,P)&&w.isMergeableObject(m[P])?T[P]=v(P,w)(b[P],m[P],w):T[P]=d(m[P],w))}),T}function R(b,m,w){w=w||{},w.arrayMerge=w.arrayMerge||p,w.isMergeableObject=w.isMergeableObject||i,w.cloneUnlessOtherwiseSpecified=d;var T=Array.isArray(m),P=Array.isArray(b),L=T===P;return L?T?w.arrayMerge(b,m,w):M(b,m,w):d(m,w)}R.all=function(m,w){if(!Array.isArray(m))throw new Error("first argument should be an array");return m.reduce(function(T,P){return R(T,P,w)},{})};var N=R;e.exports=N}}),o0=Fe({"../../node_modules/lodash/_listCacheClear.js"(t,e){ne();function i(){this.__data__=[],this.size=0}e.exports=i}}),lm=Fe({"../../node_modules/lodash/eq.js"(t,e){ne();function i(n,r){return n===r||n!==n&&r!==r}e.exports=i}}),Cl=Fe({"../../node_modules/lodash/_assocIndexOf.js"(t,e){ne();var i=lm();function n(r,s){for(var o=r.length;o--;)if(i(r[o][0],s))return o;return-1}e.exports=n}}),c0=Fe({"../../node_modules/lodash/_listCacheDelete.js"(t,e){ne();var i=Cl(),n=Array.prototype,r=n.splice;function s(o){var c=this.__data__,h=i(c,o);if(h<0)return!1;var d=c.length-1;return h==d?c.pop():r.call(c,h,1),--this.size,!0}e.exports=s}}),l0=Fe({"../../node_modules/lodash/_listCacheGet.js"(t,e){ne();var i=Cl();function n(r){var s=this.__data__,o=i(s,r);return o<0?void 0:s[o][1]}e.exports=n}}),d0=Fe({"../../node_modules/lodash/_listCacheHas.js"(t,e){ne();var i=Cl();function n(r){return i(this.__data__,r)>-1}e.exports=n}}),u0=Fe({"../../node_modules/lodash/_listCacheSet.js"(t,e){ne();var i=Cl();function n(r,s){var o=this.__data__,c=i(o,r);return c<0?(++this.size,o.push([r,s])):o[c][1]=s,this}e.exports=n}}),Tl=Fe({"../../node_modules/lodash/_ListCache.js"(t,e){ne();var i=o0(),n=c0(),r=l0(),s=d0(),o=u0();function c(h){var d=-1,p=h==null?0:h.length;for(this.clear();++d<p;){var v=h[d];this.set(v[0],v[1])}}c.prototype.clear=i,c.prototype.delete=n,c.prototype.get=r,c.prototype.has=s,c.prototype.set=o,e.exports=c}}),h0=Fe({"../../node_modules/lodash/_stackClear.js"(t,e){ne();var i=Tl();function n(){this.__data__=new i,this.size=0}e.exports=n}}),p0=Fe({"../../node_modules/lodash/_stackDelete.js"(t,e){ne();function i(n){var r=this.__data__,s=r.delete(n);return this.size=r.size,s}e.exports=i}}),f0=Fe({"../../node_modules/lodash/_stackGet.js"(t,e){ne();function i(n){return this.__data__.get(n)}e.exports=i}}),m0=Fe({"../../node_modules/lodash/_stackHas.js"(t,e){ne();function i(n){return this.__data__.has(n)}e.exports=i}}),dm=Fe({"../../node_modules/lodash/_freeGlobal.js"(t,e){ne();var i=typeof global=="object"&&global&&global.Object===Object&&global;e.exports=i}}),os=Fe({"../../node_modules/lodash/_root.js"(t,e){ne();var i=dm(),n=typeof self=="object"&&self&&self.Object===Object&&self,r=i||n||Function("return this")();e.exports=r}}),_h=Fe({"../../node_modules/lodash/_Symbol.js"(t,e){ne();var i=os(),n=i.Symbol;e.exports=n}}),g0=Fe({"../../node_modules/lodash/_getRawTag.js"(t,e){ne();var i=_h(),n=Object.prototype,r=n.hasOwnProperty,s=n.toString,o=i?i.toStringTag:void 0;function c(h){var d=r.call(h,o),p=h[o];try{h[o]=void 0;var v=!0}catch{}var g=s.call(h);return v&&(d?h[o]=p:delete h[o]),g}e.exports=c}}),v0=Fe({"../../node_modules/lodash/_objectToString.js"(t,e){ne();var i=Object.prototype,n=i.toString;function r(s){return n.call(s)}e.exports=r}}),Rl=Fe({"../../node_modules/lodash/_baseGetTag.js"(t,e){ne();var i=_h(),n=g0(),r=v0(),s="[object Null]",o="[object Undefined]",c=i?i.toStringTag:void 0;function h(d){return d==null?d===void 0?o:s:c&&c in Object(d)?n(d):r(d)}e.exports=h}}),um=Fe({"../../node_modules/lodash/isObject.js"(t,e){ne();function i(n){var r=typeof n;return n!=null&&(r=="object"||r=="function")}e.exports=i}}),hm=Fe({"../../node_modules/lodash/isFunction.js"(t,e){ne();var i=Rl(),n=um(),r="[object AsyncFunction]",s="[object Function]",o="[object GeneratorFunction]",c="[object Proxy]";function h(d){if(!n(d))return!1;var p=i(d);return p==s||p==o||p==r||p==c}e.exports=h}}),_0=Fe({"../../node_modules/lodash/_coreJsData.js"(t,e){ne();var i=os(),n=i["__core-js_shared__"];e.exports=n}}),b0=Fe({"../../node_modules/lodash/_isMasked.js"(t,e){ne();var i=_0(),n=function(){var s=/[^.]+$/.exec(i&&i.keys&&i.keys.IE_PROTO||"");return s?"Symbol(src)_1."+s:""}();function r(s){return!!n&&n in s}e.exports=r}}),pm=Fe({"../../node_modules/lodash/_toSource.js"(t,e){ne();var i=Function.prototype,n=i.toString;function r(s){if(s!=null){try{return n.call(s)}catch{}try{return s+""}catch{}}return""}e.exports=r}}),y0=Fe({"../../node_modules/lodash/_baseIsNative.js"(t,e){ne();var i=hm(),n=b0(),r=um(),s=pm(),o=/[\\^$.*+?()[\]{}|]/g,c=/^\[object .+?Constructor\]$/,h=Function.prototype,d=Object.prototype,p=h.toString,v=d.hasOwnProperty,g=RegExp("^"+p.call(v).replace(o,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function _(S){if(!r(S)||n(S))return!1;var E=i(S)?g:c;return E.test(s(S))}e.exports=_}}),S0=Fe({"../../node_modules/lodash/_getValue.js"(t,e){ne();function i(n,r){return n==null?void 0:n[r]}e.exports=i}}),eo=Fe({"../../node_modules/lodash/_getNative.js"(t,e){ne();var i=y0(),n=S0();function r(s,o){var c=n(s,o);return i(c)?c:void 0}e.exports=r}}),bh=Fe({"../../node_modules/lodash/_Map.js"(t,e){ne();var i=eo(),n=os(),r=i(n,"Map");e.exports=r}}),Ml=Fe({"../../node_modules/lodash/_nativeCreate.js"(t,e){ne();var i=eo(),n=i(Object,"create");e.exports=n}}),w0=Fe({"../../node_modules/lodash/_hashClear.js"(t,e){ne();var i=Ml();function n(){this.__data__=i?i(null):{},this.size=0}e.exports=n}}),x0=Fe({"../../node_modules/lodash/_hashDelete.js"(t,e){ne();function i(n){var r=this.has(n)&&delete this.__data__[n];return this.size-=r?1:0,r}e.exports=i}}),E0=Fe({"../../node_modules/lodash/_hashGet.js"(t,e){ne();var i=Ml(),n="__lodash_hash_undefined__",r=Object.prototype,s=r.hasOwnProperty;function o(c){var h=this.__data__;if(i){var d=h[c];return d===n?void 0:d}return s.call(h,c)?h[c]:void 0}e.exports=o}}),C0=Fe({"../../node_modules/lodash/_hashHas.js"(t,e){ne();var i=Ml(),n=Object.prototype,r=n.hasOwnProperty;function s(o){var c=this.__data__;return i?c[o]!==void 0:r.call(c,o)}e.exports=s}}),T0=Fe({"../../node_modules/lodash/_hashSet.js"(t,e){ne();var i=Ml(),n="__lodash_hash_undefined__";function r(s,o){var c=this.__data__;return this.size+=this.has(s)?0:1,c[s]=i&&o===void 0?n:o,this}e.exports=r}}),R0=Fe({"../../node_modules/lodash/_Hash.js"(t,e){ne();var i=w0(),n=x0(),r=E0(),s=C0(),o=T0();function c(h){var d=-1,p=h==null?0:h.length;for(this.clear();++d<p;){var v=h[d];this.set(v[0],v[1])}}c.prototype.clear=i,c.prototype.delete=n,c.prototype.get=r,c.prototype.has=s,c.prototype.set=o,e.exports=c}}),M0=Fe({"../../node_modules/lodash/_mapCacheClear.js"(t,e){ne();var i=R0(),n=Tl(),r=bh();function s(){this.size=0,this.__data__={hash:new i,map:new(r||n),string:new i}}e.exports=s}}),P0=Fe({"../../node_modules/lodash/_isKeyable.js"(t,e){ne();function i(n){var r=typeof n;return r=="string"||r=="number"||r=="symbol"||r=="boolean"?n!=="__proto__":n===null}e.exports=i}}),Pl=Fe({"../../node_modules/lodash/_getMapData.js"(t,e){ne();var i=P0();function n(r,s){var o=r.__data__;return i(s)?o[typeof s=="string"?"string":"hash"]:o.map}e.exports=n}}),A0=Fe({"../../node_modules/lodash/_mapCacheDelete.js"(t,e){ne();var i=Pl();function n(r){var s=i(this,r).delete(r);return this.size-=s?1:0,s}e.exports=n}}),D0=Fe({"../../node_modules/lodash/_mapCacheGet.js"(t,e){ne();var i=Pl();function n(r){return i(this,r).get(r)}e.exports=n}}),I0=Fe({"../../node_modules/lodash/_mapCacheHas.js"(t,e){ne();var i=Pl();function n(r){return i(this,r).has(r)}e.exports=n}}),F0=Fe({"../../node_modules/lodash/_mapCacheSet.js"(t,e){ne();var i=Pl();function n(r,s){var o=i(this,r),c=o.size;return o.set(r,s),this.size+=o.size==c?0:1,this}e.exports=n}}),fm=Fe({"../../node_modules/lodash/_MapCache.js"(t,e){ne();var i=M0(),n=A0(),r=D0(),s=I0(),o=F0();function c(h){var d=-1,p=h==null?0:h.length;for(this.clear();++d<p;){var v=h[d];this.set(v[0],v[1])}}c.prototype.clear=i,c.prototype.delete=n,c.prototype.get=r,c.prototype.has=s,c.prototype.set=o,e.exports=c}}),N0=Fe({"../../node_modules/lodash/_stackSet.js"(t,e){ne();var i=Tl(),n=bh(),r=fm(),s=200;function o(c,h){var d=this.__data__;if(d instanceof i){var p=d.__data__;if(!n||p.length<s-1)return p.push([c,h]),this.size=++d.size,this;d=this.__data__=new r(p)}return d.set(c,h),this.size=d.size,this}e.exports=o}}),L0=Fe({"../../node_modules/lodash/_Stack.js"(t,e){ne();var i=Tl(),n=h0(),r=p0(),s=f0(),o=m0(),c=N0();function h(d){var p=this.__data__=new i(d);this.size=p.size}h.prototype.clear=n,h.prototype.delete=r,h.prototype.get=s,h.prototype.has=o,h.prototype.set=c,e.exports=h}}),O0=Fe({"../../node_modules/lodash/_setCacheAdd.js"(t,e){ne();var i="__lodash_hash_undefined__";function n(r){return this.__data__.set(r,i),this}e.exports=n}}),k0=Fe({"../../node_modules/lodash/_setCacheHas.js"(t,e){ne();function i(n){return this.__data__.has(n)}e.exports=i}}),U0=Fe({"../../node_modules/lodash/_SetCache.js"(t,e){ne();var i=fm(),n=O0(),r=k0();function s(o){var c=-1,h=o==null?0:o.length;for(this.__data__=new i;++c<h;)this.add(o[c])}s.prototype.add=s.prototype.push=n,s.prototype.has=r,e.exports=s}}),B0=Fe({"../../node_modules/lodash/_arraySome.js"(t,e){ne();function i(n,r){for(var s=-1,o=n==null?0:n.length;++s<o;)if(r(n[s],s,n))return!0;return!1}e.exports=i}}),H0=Fe({"../../node_modules/lodash/_cacheHas.js"(t,e){ne();function i(n,r){return n.has(r)}e.exports=i}}),mm=Fe({"../../node_modules/lodash/_equalArrays.js"(t,e){ne();var i=U0(),n=B0(),r=H0(),s=1,o=2;function c(h,d,p,v,g,_){var S=p&s,E=h.length,M=d.length;if(E!=M&&!(S&&M>E))return!1;var R=_.get(h),N=_.get(d);if(R&&N)return R==d&&N==h;var b=-1,m=!0,w=p&o?new i:void 0;for(_.set(h,d),_.set(d,h);++b<E;){var T=h[b],P=d[b];if(v)var L=S?v(P,T,b,d,h,_):v(T,P,b,h,d,_);if(L!==void 0){if(L)continue;m=!1;break}if(w){if(!n(d,function(k,I){if(!r(w,I)&&(T===k||g(T,k,p,v,_)))return w.push(I)})){m=!1;break}}else if(!(T===P||g(T,P,p,v,_))){m=!1;break}}return _.delete(h),_.delete(d),m}e.exports=c}}),j0=Fe({"../../node_modules/lodash/_Uint8Array.js"(t,e){ne();var i=os(),n=i.Uint8Array;e.exports=n}}),V0=Fe({"../../node_modules/lodash/_mapToArray.js"(t,e){ne();function i(n){var r=-1,s=Array(n.size);return n.forEach(function(o,c){s[++r]=[c,o]}),s}e.exports=i}}),z0=Fe({"../../node_modules/lodash/_setToArray.js"(t,e){ne();function i(n){var r=-1,s=Array(n.size);return n.forEach(function(o){s[++r]=o}),s}e.exports=i}}),G0=Fe({"../../node_modules/lodash/_equalByTag.js"(t,e){ne();var i=_h(),n=j0(),r=lm(),s=mm(),o=V0(),c=z0(),h=1,d=2,p="[object Boolean]",v="[object Date]",g="[object Error]",_="[object Map]",S="[object Number]",E="[object RegExp]",M="[object Set]",R="[object String]",N="[object Symbol]",b="[object ArrayBuffer]",m="[object DataView]",w=i?i.prototype:void 0,T=w?w.valueOf:void 0;function P(L,k,I,z,K,$,te){switch(I){case m:if(L.byteLength!=k.byteLength||L.byteOffset!=k.byteOffset)return!1;L=L.buffer,k=k.buffer;case b:return!(L.byteLength!=k.byteLength||!$(new n(L),new n(k)));case p:case v:case S:return r(+L,+k);case g:return L.name==k.name&&L.message==k.message;case E:case R:return L==k+"";case _:var ee=o;case M:var de=z&h;if(ee||(ee=c),L.size!=k.size&&!de)return!1;var X=te.get(L);if(X)return X==k;z|=d,te.set(L,k);var le=s(ee(L),ee(k),z,K,$,te);return te.delete(L),le;case N:if(T)return T.call(L)==T.call(k)}return!1}e.exports=P}}),q0=Fe({"../../node_modules/lodash/_arrayPush.js"(t,e){ne();function i(n,r){for(var s=-1,o=r.length,c=n.length;++s<o;)n[c+s]=r[s];return n}e.exports=i}}),yh=Fe({"../../node_modules/lodash/isArray.js"(t,e){ne();var i=Array.isArray;e.exports=i}}),W0=Fe({"../../node_modules/lodash/_baseGetAllKeys.js"(t,e){ne();var i=q0(),n=yh();function r(s,o,c){var h=o(s);return n(s)?h:i(h,c(s))}e.exports=r}}),K0=Fe({"../../node_modules/lodash/_arrayFilter.js"(t,e){ne();function i(n,r){for(var s=-1,o=n==null?0:n.length,c=0,h=[];++s<o;){var d=n[s];r(d,s,n)&&(h[c++]=d)}return h}e.exports=i}}),X0=Fe({"../../node_modules/lodash/stubArray.js"(t,e){ne();function i(){return[]}e.exports=i}}),$0=Fe({"../../node_modules/lodash/_getSymbols.js"(t,e){ne();var i=K0(),n=X0(),r=Object.prototype,s=r.propertyIsEnumerable,o=Object.getOwnPropertySymbols,c=o?function(h){return h==null?[]:(h=Object(h),i(o(h),function(d){return s.call(h,d)}))}:n;e.exports=c}}),Z0=Fe({"../../node_modules/lodash/_baseTimes.js"(t,e){ne();function i(n,r){for(var s=-1,o=Array(n);++s<n;)o[s]=r(s);return o}e.exports=i}}),Al=Fe({"../../node_modules/lodash/isObjectLike.js"(t,e){ne();function i(n){return n!=null&&typeof n=="object"}e.exports=i}}),Y0=Fe({"../../node_modules/lodash/_baseIsArguments.js"(t,e){ne();var i=Rl(),n=Al(),r="[object Arguments]";function s(o){return n(o)&&i(o)==r}e.exports=s}}),J0=Fe({"../../node_modules/lodash/isArguments.js"(t,e){ne();var i=Y0(),n=Al(),r=Object.prototype,s=r.hasOwnProperty,o=r.propertyIsEnumerable,c=i(function(){return arguments}())?i:function(h){return n(h)&&s.call(h,"callee")&&!o.call(h,"callee")};e.exports=c}}),Q0=Fe({"../../node_modules/lodash/stubFalse.js"(t,e){ne();function i(){return!1}e.exports=i}}),gm=Fe({"../../node_modules/lodash/isBuffer.js"(t,e){ne();var i=os(),n=Q0(),r=typeof t=="object"&&t&&!t.nodeType&&t,s=r&&typeof e=="object"&&e&&!e.nodeType&&e,o=s&&s.exports===r,c=o?i.Buffer:void 0,h=c?c.isBuffer:void 0,d=h||n;e.exports=d}}),eb=Fe({"../../node_modules/lodash/_isIndex.js"(t,e){ne();var i=9007199254740991,n=/^(?:0|[1-9]\d*)$/;function r(s,o){var c=typeof s;return o=o??i,!!o&&(c=="number"||c!="symbol"&&n.test(s))&&s>-1&&s%1==0&&s<o}e.exports=r}}),vm=Fe({"../../node_modules/lodash/isLength.js"(t,e){ne();var i=9007199254740991;function n(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=i}e.exports=n}}),tb=Fe({"../../node_modules/lodash/_baseIsTypedArray.js"(t,e){ne();var i=Rl(),n=vm(),r=Al(),s="[object Arguments]",o="[object Array]",c="[object Boolean]",h="[object Date]",d="[object Error]",p="[object Function]",v="[object Map]",g="[object Number]",_="[object Object]",S="[object RegExp]",E="[object Set]",M="[object String]",R="[object WeakMap]",N="[object ArrayBuffer]",b="[object DataView]",m="[object Float32Array]",w="[object Float64Array]",T="[object Int8Array]",P="[object Int16Array]",L="[object Int32Array]",k="[object Uint8Array]",I="[object Uint8ClampedArray]",z="[object Uint16Array]",K="[object Uint32Array]",$={};$[m]=$[w]=$[T]=$[P]=$[L]=$[k]=$[I]=$[z]=$[K]=!0,$[s]=$[o]=$[N]=$[c]=$[b]=$[h]=$[d]=$[p]=$[v]=$[g]=$[_]=$[S]=$[E]=$[M]=$[R]=!1;function te(ee){return r(ee)&&n(ee.length)&&!!$[i(ee)]}e.exports=te}}),ib=Fe({"../../node_modules/lodash/_baseUnary.js"(t,e){ne();function i(n){return function(r){return n(r)}}e.exports=i}}),nb=Fe({"../../node_modules/lodash/_nodeUtil.js"(t,e){ne();var i=dm(),n=typeof t=="object"&&t&&!t.nodeType&&t,r=n&&typeof e=="object"&&e&&!e.nodeType&&e,s=r&&r.exports===n,o=s&&i.process,c=function(){try{var h=r&&r.require&&r.require("util").types;return h||o&&o.binding&&o.binding("util")}catch{}}();e.exports=c}}),_m=Fe({"../../node_modules/lodash/isTypedArray.js"(t,e){ne();var i=tb(),n=ib(),r=nb(),s=r&&r.isTypedArray,o=s?n(s):i;e.exports=o}}),rb=Fe({"../../node_modules/lodash/_arrayLikeKeys.js"(t,e){ne();var i=Z0(),n=J0(),r=yh(),s=gm(),o=eb(),c=_m(),h=Object.prototype,d=h.hasOwnProperty;function p(v,g){var _=r(v),S=!_&&n(v),E=!_&&!S&&s(v),M=!_&&!S&&!E&&c(v),R=_||S||E||M,N=R?i(v.length,String):[],b=N.length;for(var m in v)(g||d.call(v,m))&&!(R&&(m=="length"||E&&(m=="offset"||m=="parent")||M&&(m=="buffer"||m=="byteLength"||m=="byteOffset")||o(m,b)))&&N.push(m);return N}e.exports=p}}),sb=Fe({"../../node_modules/lodash/_isPrototype.js"(t,e){ne();var i=Object.prototype;function n(r){var s=r&&r.constructor,o=typeof s=="function"&&s.prototype||i;return r===o}e.exports=n}}),ab=Fe({"../../node_modules/lodash/_overArg.js"(t,e){ne();function i(n,r){return function(s){return n(r(s))}}e.exports=i}}),ob=Fe({"../../node_modules/lodash/_nativeKeys.js"(t,e){ne();var i=ab(),n=i(Object.keys,Object);e.exports=n}}),cb=Fe({"../../node_modules/lodash/_baseKeys.js"(t,e){ne();var i=sb(),n=ob(),r=Object.prototype,s=r.hasOwnProperty;function o(c){if(!i(c))return n(c);var h=[];for(var d in Object(c))s.call(c,d)&&d!="constructor"&&h.push(d);return h}e.exports=o}}),lb=Fe({"../../node_modules/lodash/isArrayLike.js"(t,e){ne();var i=hm(),n=vm();function r(s){return s!=null&&n(s.length)&&!i(s)}e.exports=r}}),db=Fe({"../../node_modules/lodash/keys.js"(t,e){ne();var i=rb(),n=cb(),r=lb();function s(o){return r(o)?i(o):n(o)}e.exports=s}}),ub=Fe({"../../node_modules/lodash/_getAllKeys.js"(t,e){ne();var i=W0(),n=$0(),r=db();function s(o){return i(o,r,n)}e.exports=s}}),hb=Fe({"../../node_modules/lodash/_equalObjects.js"(t,e){ne();var i=ub(),n=1,r=Object.prototype,s=r.hasOwnProperty;function o(c,h,d,p,v,g){var _=d&n,S=i(c),E=S.length,M=i(h),R=M.length;if(E!=R&&!_)return!1;for(var N=E;N--;){var b=S[N];if(!(_?b in h:s.call(h,b)))return!1}var m=g.get(c),w=g.get(h);if(m&&w)return m==h&&w==c;var T=!0;g.set(c,h),g.set(h,c);for(var P=_;++N<E;){b=S[N];var L=c[b],k=h[b];if(p)var I=_?p(k,L,b,h,c,g):p(L,k,b,c,h,g);if(!(I===void 0?L===k||v(L,k,d,p,g):I)){T=!1;break}P||(P=b=="constructor")}if(T&&!P){var z=c.constructor,K=h.constructor;z!=K&&"constructor"in c&&"constructor"in h&&!(typeof z=="function"&&z instanceof z&&typeof K=="function"&&K instanceof K)&&(T=!1)}return g.delete(c),g.delete(h),T}e.exports=o}}),pb=Fe({"../../node_modules/lodash/_DataView.js"(t,e){ne();var i=eo(),n=os(),r=i(n,"DataView");e.exports=r}}),fb=Fe({"../../node_modules/lodash/_Promise.js"(t,e){ne();var i=eo(),n=os(),r=i(n,"Promise");e.exports=r}}),mb=Fe({"../../node_modules/lodash/_Set.js"(t,e){ne();var i=eo(),n=os(),r=i(n,"Set");e.exports=r}}),gb=Fe({"../../node_modules/lodash/_WeakMap.js"(t,e){ne();var i=eo(),n=os(),r=i(n,"WeakMap");e.exports=r}}),vb=Fe({"../../node_modules/lodash/_getTag.js"(t,e){ne();var i=pb(),n=bh(),r=fb(),s=mb(),o=gb(),c=Rl(),h=pm(),d="[object Map]",p="[object Object]",v="[object Promise]",g="[object Set]",_="[object WeakMap]",S="[object DataView]",E=h(i),M=h(n),R=h(r),N=h(s),b=h(o),m=c;(i&&m(new i(new ArrayBuffer(1)))!=S||n&&m(new n)!=d||r&&m(r.resolve())!=v||s&&m(new s)!=g||o&&m(new o)!=_)&&(m=function(w){var T=c(w),P=T==p?w.constructor:void 0,L=P?h(P):"";if(L)switch(L){case E:return S;case M:return d;case R:return v;case N:return g;case b:return _}return T}),e.exports=m}}),_b=Fe({"../../node_modules/lodash/_baseIsEqualDeep.js"(t,e){ne();var i=L0(),n=mm(),r=G0(),s=hb(),o=vb(),c=yh(),h=gm(),d=_m(),p=1,v="[object Arguments]",g="[object Array]",_="[object Object]",S=Object.prototype,E=S.hasOwnProperty;function M(R,N,b,m,w,T){var P=c(R),L=c(N),k=P?g:o(R),I=L?g:o(N);k=k==v?_:k,I=I==v?_:I;var z=k==_,K=I==_,$=k==I;if($&&h(R)){if(!h(N))return!1;P=!0,z=!1}if($&&!z)return T||(T=new i),P||d(R)?n(R,N,b,m,w,T):r(R,N,k,b,m,w,T);if(!(b&p)){var te=z&&E.call(R,"__wrapped__"),ee=K&&E.call(N,"__wrapped__");if(te||ee){var de=te?R.value():R,X=ee?N.value():N;return T||(T=new i),w(de,X,b,m,T)}}return $?(T||(T=new i),s(R,N,b,m,w,T)):!1}e.exports=M}}),bb=Fe({"../../node_modules/lodash/_baseIsEqual.js"(t,e){ne();var i=_b(),n=Al();function r(s,o,c,h,d){return s===o?!0:s==null||o==null||!n(s)&&!n(o)?s!==s&&o!==o:i(s,o,c,h,r,d)}e.exports=r}}),bm=Fe({"../../node_modules/lodash/isEqual.js"(t,e){ne();var i=bb();function n(r,s){return i(r,s)}e.exports=n}}),yb=Fe({"../../node_modules/ms/index.js"(t,e){ne();var i=1e3,n=i*60,r=n*60,s=r*24,o=s*7,c=s*365.25;e.exports=function(g,_){_=_||{};var S=typeof g;if(S==="string"&&g.length>0)return h(g);if(S==="number"&&isFinite(g))return _.long?p(g):d(g);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(g))};function h(g){if(g=String(g),!(g.length>100)){var _=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(g);if(_){var S=parseFloat(_[1]),E=(_[2]||"ms").toLowerCase();switch(E){case"years":case"year":case"yrs":case"yr":case"y":return S*c;case"weeks":case"week":case"w":return S*o;case"days":case"day":case"d":return S*s;case"hours":case"hour":case"hrs":case"hr":case"h":return S*r;case"minutes":case"minute":case"mins":case"min":case"m":return S*n;case"seconds":case"second":case"secs":case"sec":case"s":return S*i;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return S;default:return}}}}function d(g){var _=Math.abs(g);return _>=s?Math.round(g/s)+"d":_>=r?Math.round(g/r)+"h":_>=n?Math.round(g/n)+"m":_>=i?Math.round(g/i)+"s":g+"ms"}function p(g){var _=Math.abs(g);return _>=s?v(g,_,s,"day"):_>=r?v(g,_,r,"hour"):_>=n?v(g,_,n,"minute"):_>=i?v(g,_,i,"second"):g+" ms"}function v(g,_,S,E){var M=_>=S*1.5;return Math.round(g/S)+" "+E+(M?"s":"")}}}),Sb=Fe({"../../node_modules/debug/src/common.js"(t,e){ne();function i(n){s.debug=s,s.default=s,s.coerce=v,s.disable=d,s.enable=c,s.enabled=p,s.humanize=yb(),s.destroy=g,Object.keys(n).forEach(_=>{s[_]=n[_]}),s.names=[],s.skips=[],s.formatters={};function r(_){let S=0;for(let E=0;E<_.length;E++)S=(S<<5)-S+_.charCodeAt(E),S|=0;return s.colors[Math.abs(S)%s.colors.length]}s.selectColor=r;function s(_){let S,E=null,M,R;function N(...b){if(!N.enabled)return;const m=N,w=Number(new Date),T=w-(S||w);m.diff=T,m.prev=S,m.curr=w,S=w,b[0]=s.coerce(b[0]),typeof b[0]!="string"&&b.unshift("%O");let P=0;b[0]=b[0].replace(/%([a-zA-Z%])/g,(k,I)=>{if(k==="%%")return"%";P++;const z=s.formatters[I];if(typeof z=="function"){const K=b[P];k=z.call(m,K),b.splice(P,1),P--}return k}),s.formatArgs.call(m,b),(m.log||s.log).apply(m,b)}return N.namespace=_,N.useColors=s.useColors(),N.color=s.selectColor(_),N.extend=o,N.destroy=s.destroy,Object.defineProperty(N,"enabled",{enumerable:!0,configurable:!1,get:()=>E!==null?E:(M!==s.namespaces&&(M=s.namespaces,R=s.enabled(_)),R),set:b=>{E=b}}),typeof s.init=="function"&&s.init(N),N}function o(_,S){const E=s(this.namespace+(typeof S>"u"?":":S)+_);return E.log=this.log,E}function c(_){s.save(_),s.namespaces=_,s.names=[],s.skips=[];const S=(typeof _=="string"?_:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const E of S)E[0]==="-"?s.skips.push(E.slice(1)):s.names.push(E)}function h(_,S){let E=0,M=0,R=-1,N=0;for(;E<_.length;)if(M<S.length&&(S[M]===_[E]||S[M]==="*"))S[M]==="*"?(R=M,N=E,M++):(E++,M++);else if(R!==-1)M=R+1,N++,E=N;else return!1;for(;M<S.length&&S[M]==="*";)M++;return M===S.length}function d(){const _=[...s.names,...s.skips.map(S=>"-"+S)].join(",");return s.enable(""),_}function p(_){for(const S of s.skips)if(h(_,S))return!1;for(const S of s.names)if(h(_,S))return!0;return!1}function v(_){return _ instanceof Error?_.stack||_.message:_}function g(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}e.exports=i}}),Dl=Fe({"../../node_modules/debug/src/browser.js"(t,e){ne(),t.formatArgs=n,t.save=r,t.load=s,t.useColors=i,t.storage=o(),t.destroy=(()=>{let h=!1;return()=>{h||(h=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function i(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let h;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(h=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(h[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function n(h){if(h[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+h[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const d="color: "+this.color;h.splice(1,0,d,"color: inherit");let p=0,v=0;h[0].replace(/%[a-zA-Z%]/g,g=>{g!=="%%"&&(p++,g==="%c"&&(v=p))}),h.splice(v,0,d)}t.log=console.debug||console.log||(()=>{});function r(h){try{h?t.storage.setItem("debug",h):t.storage.removeItem("debug")}catch{}}function s(){let h;try{h=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch{}return!h&&typeof Oa<"u"&&"env"in Oa&&(h=Oa.env.DEBUG),h}function o(){try{return localStorage}catch{}}e.exports=Sb()(t);var{formatters:c}=e.exports;c.j=function(h){try{return JSON.stringify(h)}catch(d){return"[UnexpectedJSONParseError]: "+d.message}}}}),Xi=Fe({"../../node_modules/mediasoup-client/lib/Logger.js"(t){ne();var e=t&&t.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;var i=e(Dl()),n="mediasoup-client",r=class{constructor(s){s?(this._debug=(0,i.default)(`${n}:${s}`),this._warn=(0,i.default)(`${n}:WARN:${s}`),this._error=(0,i.default)(`${n}:ERROR:${s}`)):(this._debug=(0,i.default)(n),this._warn=(0,i.default)(`${n}:WARN`),this._error=(0,i.default)(`${n}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};t.Logger=r}}),wb=Fe({"../../node_modules/npm-events-package/events.js"(t,e){ne();var i=typeof Reflect=="object"?Reflect:null,n=i&&typeof i.apply=="function"?i.apply:function(P,L,k){return Function.prototype.apply.call(P,L,k)},r;i&&typeof i.ownKeys=="function"?r=i.ownKeys:Object.getOwnPropertySymbols?r=function(P){return Object.getOwnPropertyNames(P).concat(Object.getOwnPropertySymbols(P))}:r=function(P){return Object.getOwnPropertyNames(P)};function s(T){console&&console.warn&&console.warn(T)}var o=Number.isNaN||function(P){return P!==P};function c(){c.init.call(this)}e.exports=c,e.exports.once=b,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var h=10;function d(T){if(typeof T!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof T)}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return h},set:function(T){if(typeof T!="number"||T<0||o(T))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+T+".");h=T}}),c.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(P){if(typeof P!="number"||P<0||o(P))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+P+".");return this._maxListeners=P,this};function p(T){return T._maxListeners===void 0?c.defaultMaxListeners:T._maxListeners}c.prototype.getMaxListeners=function(){return p(this)},c.prototype.emit=function(P){for(var L=[],k=1;k<arguments.length;k++)L.push(arguments[k]);var I=P==="error",z=this._events;if(z!==void 0)I=I&&z.error===void 0;else if(!I)return!1;if(I){var K;if(L.length>0&&(K=L[0]),K instanceof Error)throw K;var $=new Error("Unhandled error."+(K?" ("+K.message+")":""));throw $.context=K,$}var te=z[P];if(te===void 0)return!1;if(typeof te=="function")n(te,this,L);else for(var ee=te.length,de=M(te,ee),k=0;k<ee;++k)n(de[k],this,L);return!0};function v(T,P,L,k){var I,z,K;if(d(L),z=T._events,z===void 0?(z=T._events=Object.create(null),T._eventsCount=0):(z.newListener!==void 0&&(T.emit("newListener",P,L.listener?L.listener:L),z=T._events),K=z[P]),K===void 0)K=z[P]=L,++T._eventsCount;else if(typeof K=="function"?K=z[P]=k?[L,K]:[K,L]:k?K.unshift(L):K.push(L),I=p(T),I>0&&K.length>I&&!K.warned){K.warned=!0;var $=new Error("Possible EventEmitter memory leak detected. "+K.length+" "+String(P)+" listeners added. Use emitter.setMaxListeners() to increase limit");$.name="MaxListenersExceededWarning",$.emitter=T,$.type=P,$.count=K.length,s($)}return T}c.prototype.addListener=function(P,L){return v(this,P,L,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(P,L){return v(this,P,L,!0)};function g(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _(T,P,L){var k={fired:!1,wrapFn:void 0,target:T,type:P,listener:L},I=g.bind(k);return I.listener=L,k.wrapFn=I,I}c.prototype.once=function(P,L){return d(L),this.on(P,_(this,P,L)),this},c.prototype.prependOnceListener=function(P,L){return d(L),this.prependListener(P,_(this,P,L)),this},c.prototype.removeListener=function(P,L){var k,I,z,K,$;if(d(L),I=this._events,I===void 0)return this;if(k=I[P],k===void 0)return this;if(k===L||k.listener===L)--this._eventsCount===0?this._events=Object.create(null):(delete I[P],I.removeListener&&this.emit("removeListener",P,k.listener||L));else if(typeof k!="function"){for(z=-1,K=k.length-1;K>=0;K--)if(k[K]===L||k[K].listener===L){$=k[K].listener,z=K;break}if(z<0)return this;z===0?k.shift():R(k,z),k.length===1&&(I[P]=k[0]),I.removeListener!==void 0&&this.emit("removeListener",P,$||L)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(P){var L,k,I;if(k=this._events,k===void 0)return this;if(k.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):k[P]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete k[P]),this;if(arguments.length===0){var z=Object.keys(k),K;for(I=0;I<z.length;++I)K=z[I],K!=="removeListener"&&this.removeAllListeners(K);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(L=k[P],typeof L=="function")this.removeListener(P,L);else if(L!==void 0)for(I=L.length-1;I>=0;I--)this.removeListener(P,L[I]);return this};function S(T,P,L){var k=T._events;if(k===void 0)return[];var I=k[P];return I===void 0?[]:typeof I=="function"?L?[I.listener||I]:[I]:L?N(I):M(I,I.length)}c.prototype.listeners=function(P){return S(this,P,!0)},c.prototype.rawListeners=function(P){return S(this,P,!1)},c.listenerCount=function(T,P){return typeof T.listenerCount=="function"?T.listenerCount(P):E.call(T,P)},c.prototype.listenerCount=E;function E(T){var P=this._events;if(P!==void 0){var L=P[T];if(typeof L=="function")return 1;if(L!==void 0)return L.length}return 0}c.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]};function M(T,P){for(var L=new Array(P),k=0;k<P;++k)L[k]=T[k];return L}function R(T,P){for(;P+1<T.length;P++)T[P]=T[P+1];T.pop()}function N(T){for(var P=new Array(T.length),L=0;L<P.length;++L)P[L]=T[L].listener||T[L];return P}function b(T,P){return new Promise(function(L,k){function I(K){T.removeListener(P,z),k(K)}function z(){typeof T.removeListener=="function"&&T.removeListener("error",I),L([].slice.call(arguments))}w(T,P,z,{once:!0}),P!=="error"&&m(T,I,{once:!0})})}function m(T,P,L){typeof T.on=="function"&&w(T,"error",P,L)}function w(T,P,L,k){if(typeof T.on=="function")k.once?T.once(P,L):T.on(P,L);else if(typeof T.addEventListener=="function")T.addEventListener(P,function I(z){k.once&&T.removeEventListener(P,I),L(z)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof T)}}}),oa=Fe({"../../node_modules/mediasoup-client/lib/enhancedEvents.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.EnhancedEventEmitter=void 0;var e=wb(),i=Xi(),n=new i.Logger("EnhancedEventEmitter"),r=class extends e.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(s,...o){return super.emit(s,...o)}safeEmit(s,...o){try{return super.emit(s,...o)}catch(c){n.error("safeEmit() | event listener threw an error [eventName:%s]:%o",s,c);try{super.emit("listenererror",s,c)}catch{}return!!super.listenerCount(s)}}on(s,o){return super.on(s,o),this}off(s,o){return super.off(s,o),this}addListener(s,o){return super.on(s,o),this}prependListener(s,o){return super.prependListener(s,o),this}once(s,o){return super.once(s,o),this}prependOnceListener(s,o){return super.prependOnceListener(s,o),this}removeListener(s,o){return super.off(s,o),this}removeAllListeners(s){return super.removeAllListeners(s),this}listenerCount(s){return super.listenerCount(s)}listeners(s){return super.listeners(s)}rawListeners(s){return super.rawListeners(s)}};t.EnhancedEventEmitter=r}}),Mn=Fe({"../../node_modules/mediasoup-client/lib/errors.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidStateError=t.UnsupportedError=void 0;var e=class ym extends Error{constructor(r){super(r),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,ym):this.stack=new Error(r).stack}};t.UnsupportedError=e;var i=class Sm extends Error{constructor(r){super(r),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Sm):this.stack=new Error(r).stack}};t.InvalidStateError=i}}),dn=Fe({"../../node_modules/mediasoup-client/lib/utils.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.clone=e,t.generateRandomNumber=i,t.deepFreeze=n;function e(r){if(r!==void 0)return Number.isNaN(r)?NaN:typeof structuredClone=="function"?structuredClone(r):JSON.parse(JSON.stringify(r))}function i(){return Math.round(Math.random()*1e7)}function n(r){const s=Reflect.ownKeys(r);for(const o of s){const c=r[o];(c&&typeof c=="object"||typeof c=="function")&&n(c)}return Object.freeze(r)}}}),xb=Fe({"../../node_modules/h264-profile-level-id/lib/Logger.js"(t){ne();var e=t&&t.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;var i=e(Dl()),n="h264-profile-level-id",r=class{constructor(s){s?(this._debug=(0,i.default)(`${n}:${s}`),this._warn=(0,i.default)(`${n}:WARN:${s}`),this._error=(0,i.default)(`${n}:ERROR:${s}`)):(this._debug=(0,i.default)(n),this._warn=(0,i.default)(`${n}:WARN`),this._error=(0,i.default)(`${n}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};t.Logger=r}}),Eb=Fe({"../../node_modules/h264-profile-level-id/lib/index.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.ProfileLevelId=t.Level=t.Profile=void 0,t.parseProfileLevelId=v,t.profileLevelIdToString=g,t.profileToString=_,t.levelToString=S,t.parseSdpProfileLevelId=E,t.isSameProfile=M,t.isSameProfileAndLevel=R,t.generateProfileLevelIdStringForAnswer=N,t.supportedLevel=b;var e=xb(),i=new e.Logger,n;(function(L){L[L.ConstrainedBaseline=1]="ConstrainedBaseline",L[L.Baseline=2]="Baseline",L[L.Main=3]="Main",L[L.ConstrainedHigh=4]="ConstrainedHigh",L[L.High=5]="High",L[L.PredictiveHigh444=6]="PredictiveHigh444"})(n||(t.Profile=n={}));var r;(function(L){L[L.L1_b=0]="L1_b",L[L.L1=10]="L1",L[L.L1_1=11]="L1_1",L[L.L1_2=12]="L1_2",L[L.L1_3=13]="L1_3",L[L.L2=20]="L2",L[L.L2_1=21]="L2_1",L[L.L2_2=22]="L2_2",L[L.L3=30]="L3",L[L.L3_1=31]="L3_1",L[L.L3_2=32]="L3_2",L[L.L4=40]="L4",L[L.L4_1=41]="L4_1",L[L.L4_2=42]="L4_2",L[L.L5=50]="L5",L[L.L5_1=51]="L5_1",L[L.L5_2=52]="L5_2"})(r||(t.Level=r={}));var s=class{constructor(L,k){this.profile=L,this.level=k}};t.ProfileLevelId=s;var o=new s(n.ConstrainedBaseline,r.L3_1),c=class{constructor(L){this.mask=~m("x",L),this.masked_value=m("1",L)}isMatch(L){return this.masked_value===(L&this.mask)}},h=class{constructor(L,k,I){this.profile_idc=L,this.profile_iop=k,this.profile=I}},d=[new h(66,new c("x1xx0000"),n.ConstrainedBaseline),new h(77,new c("1xxx0000"),n.ConstrainedBaseline),new h(88,new c("11xx0000"),n.ConstrainedBaseline),new h(66,new c("x0xx0000"),n.Baseline),new h(88,new c("10xx0000"),n.Baseline),new h(77,new c("0x0x0000"),n.Main),new h(100,new c("00000000"),n.High),new h(100,new c("00001100"),n.ConstrainedHigh),new h(244,new c("00000000"),n.PredictiveHigh444)],p=[{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:r.L1},{max_macroblocks_per_second:1485,max_macroblock_frame_size:99,level:r.L1_b},{max_macroblocks_per_second:3e3,max_macroblock_frame_size:396,level:r.L1_1},{max_macroblocks_per_second:6e3,max_macroblock_frame_size:396,level:r.L1_2},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:r.L1_3},{max_macroblocks_per_second:11880,max_macroblock_frame_size:396,level:r.L2},{max_macroblocks_per_second:19800,max_macroblock_frame_size:792,level:r.L2_1},{max_macroblocks_per_second:20250,max_macroblock_frame_size:1620,level:r.L2_2},{max_macroblocks_per_second:40500,max_macroblock_frame_size:1620,level:r.L3},{max_macroblocks_per_second:108e3,max_macroblock_frame_size:3600,level:r.L3_1},{max_macroblocks_per_second:216e3,max_macroblock_frame_size:5120,level:r.L3_2},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:r.L4},{max_macroblocks_per_second:245760,max_macroblock_frame_size:8192,level:r.L4_1},{max_macroblocks_per_second:522240,max_macroblock_frame_size:8704,level:r.L4_2},{max_macroblocks_per_second:589824,max_macroblock_frame_size:22080,level:r.L5},{max_macroblocks_per_second:983040,max_macroblock_frame_size:36864,level:r.L5_1},{max_macroblocks_per_second:2073600,max_macroblock_frame_size:36864,level:r.L5_2}];function v(L){if(typeof L!="string"||L.length!==6)return;const I=parseInt(L,16);if(I===0)return;const z=I&255,K=I>>8&255,$=I>>16&255;let te;switch(z){case r.L1_1:{te=(K&16)!==0?r.L1_b:r.L1_1;break}case r.L1:case r.L1_2:case r.L1_3:case r.L2:case r.L2_1:case r.L2_2:case r.L3:case r.L3_1:case r.L3_2:case r.L4:case r.L4_1:case r.L4_2:case r.L5:case r.L5_1:case r.L5_2:{te=z;break}default:{i.warn(`parseProfileLevelId() | unrecognized level_idc [str:${L}, level_idc:${z}]`);return}}for(const ee of d)if($===ee.profile_idc&&ee.profile_iop.isMatch(K))return i.debug(`parseProfileLevelId() | result [str:${L}, profile:${ee.profile}, level:${te}]`),new s(ee.profile,te);i.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${L}, profile_idc:${$}, profile_iop:${K}]`)}function g(L){if(L.level==r.L1_b)switch(L.profile){case n.ConstrainedBaseline:return"42f00b";case n.Baseline:return"42100b";case n.Main:return"4d100b";default:{i.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${L.profile}`);return}}let k;switch(L.profile){case n.ConstrainedBaseline:{k="42e0";break}case n.Baseline:{k="4200";break}case n.Main:{k="4d00";break}case n.ConstrainedHigh:{k="640c";break}case n.High:{k="6400";break}case n.PredictiveHigh444:{k="f400";break}default:{i.warn(`profileLevelIdToString() | unrecognized profile ${L.profile}`);return}}let I=L.level.toString(16);return I.length===1&&(I=`0${I}`),`${k}${I}`}function _(L){switch(L){case n.ConstrainedBaseline:return"ConstrainedBaseline";case n.Baseline:return"Baseline";case n.Main:return"Main";case n.ConstrainedHigh:return"ConstrainedHigh";case n.High:return"High";case n.PredictiveHigh444:return"PredictiveHigh444";default:{i.warn(`profileToString() | unrecognized profile ${L}`);return}}}function S(L){switch(L){case r.L1_b:return"1b";case r.L1:return"1";case r.L1_1:return"1.1";case r.L1_2:return"1.2";case r.L1_3:return"1.3";case r.L2:return"2";case r.L2_1:return"2.1";case r.L2_2:return"2.2";case r.L3:return"3";case r.L3_1:return"3.1";case r.L3_2:return"3.2";case r.L4:return"4";case r.L4_1:return"4.1";case r.L4_2:return"4.2";case r.L5:return"5";case r.L5_1:return"5.1";case r.L5_2:return"5.2";default:{i.warn(`levelToString() | unrecognized level ${L}`);return}}}function E(L={}){const k=L["profile-level-id"];return k?v(k):o}function M(L={},k={}){const I=E(L),z=E(k);return!!(I&&z&&I.profile===z.profile)}function R(L={},k={}){const I=E(L),z=E(k);return!!(I&&z&&I.profile===z.profile&&I.level==z.level)}function N(L={},k={}){if(!L["profile-level-id"]&&!k["profile-level-id"]){i.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const I=E(L),z=E(k);if(!I)throw new TypeError("invalid local_profile_level_id");if(!z)throw new TypeError("invalid remote_profile_level_id");if(I.profile!==z.profile)throw new TypeError("H264 Profile mismatch");const K=P(L)&&P(k),$=I.level,te=z.level,ee=T($,te),de=K?$:ee;return i.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${I.profile}, level:${de}]`),g(new s(I.profile,de))}function b(L,k){for(let z=p.length-1;z>=0;--z){const K=p[z];if(K.max_macroblock_frame_size*256<=L&&K.max_macroblocks_per_second<=k*K.max_macroblock_frame_size)return i.debug(`supportedLevel() | result [max_frame_pixel_count:${L}, max_fps:${k}, level:${K.level}]`),K.level}i.warn(`supportedLevel() | no level supported [max_frame_pixel_count:${L}, max_fps:${k}]`)}function m(L,k){return+(k[0]===L)<<7|+(k[1]===L)<<6|+(k[2]===L)<<5|+(k[3]===L)<<4|+(k[4]===L)<<3|+(k[5]===L)<<2|+(k[6]===L)<<1|+(k[7]===L)<<0}function w(L,k){return L===r.L1_b?k!==r.L1&&k!==r.L1_b:k===r.L1_b?L!==r.L1:L<k}function T(L,k){return w(L,k)?L:k}function P(L={}){const k=L["level-asymmetry-allowed"];return k===!0||k===1||k==="1"}}}),jn=Fe({"../../node_modules/mediasoup-client/lib/ortc.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(X,le,_e,Se){Se===void 0&&(Se=_e);var De=Object.getOwnPropertyDescriptor(le,_e);(!De||("get"in De?!le.__esModule:De.writable||De.configurable))&&(De={enumerable:!0,get:function(){return le[_e]}}),Object.defineProperty(X,Se,De)}:function(X,le,_e,Se){Se===void 0&&(Se=_e),X[Se]=le[_e]}),i=t&&t.__setModuleDefault||(Object.create?function(X,le){Object.defineProperty(X,"default",{enumerable:!0,value:le})}:function(X,le){X.default=le}),n=t&&t.__importStar||function(X){if(X&&X.__esModule)return X;var le={};if(X!=null)for(var _e in X)_e!=="default"&&Object.prototype.hasOwnProperty.call(X,_e)&&e(le,X,_e);return i(le,X),le};Object.defineProperty(t,"__esModule",{value:!0}),t.validateRtpCapabilities=d,t.validateRtpParameters=p,t.validateSctpStreamParameters=v,t.validateSctpCapabilities=g,t.getExtendedRtpCapabilities=_,t.getRecvRtpCapabilities=S,t.getSendingRtpParameters=E,t.getSendingRemoteRtpParameters=M,t.reduceCodecs=R,t.generateProbatorRtpParameters=N,t.canSend=b,t.canReceive=m;var r=n(Eb()),s=n(dn()),o="probator",c=1234,h=127;function d(X){if(typeof X!="object")throw new TypeError("caps is not an object");if(X.codecs&&!Array.isArray(X.codecs))throw new TypeError("caps.codecs is not an array");X.codecs||(X.codecs=[]);for(const le of X.codecs)w(le);if(X.headerExtensions&&!Array.isArray(X.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");X.headerExtensions||(X.headerExtensions=[]);for(const le of X.headerExtensions)P(le)}function p(X){if(typeof X!="object")throw new TypeError("params is not an object");if(X.mid&&typeof X.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(X.codecs))throw new TypeError("missing params.codecs");for(const le of X.codecs)L(le);if(X.headerExtensions&&!Array.isArray(X.headerExtensions))throw new TypeError("params.headerExtensions is not an array");X.headerExtensions||(X.headerExtensions=[]);for(const le of X.headerExtensions)k(le);if(X.encodings&&!Array.isArray(X.encodings))throw new TypeError("params.encodings is not an array");X.encodings||(X.encodings=[]);for(const le of X.encodings)I(le);if(X.rtcp&&typeof X.rtcp!="object")throw new TypeError("params.rtcp is not an object");X.rtcp||(X.rtcp={}),z(X.rtcp)}function v(X){if(typeof X!="object")throw new TypeError("params is not an object");if(typeof X.streamId!="number")throw new TypeError("missing params.streamId");let le=!1;if(typeof X.ordered=="boolean"?le=!0:X.ordered=!0,X.maxPacketLifeTime&&typeof X.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(X.maxRetransmits&&typeof X.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(X.maxPacketLifeTime&&X.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(le&&X.ordered&&(X.maxPacketLifeTime||X.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!le&&(X.maxPacketLifeTime||X.maxRetransmits)&&(X.ordered=!1),X.label&&typeof X.label!="string")throw new TypeError("invalid params.label");if(X.protocol&&typeof X.protocol!="string")throw new TypeError("invalid params.protocol")}function g(X){if(typeof X!="object")throw new TypeError("caps is not an object");if(!X.numStreams||typeof X.numStreams!="object")throw new TypeError("missing caps.numStreams");K(X.numStreams)}function _(X,le){var _e,Se;const De={codecs:[],headerExtensions:[]};for(const We of(_e=le.codecs)!=null?_e:[]){if($(We))continue;const Ve=((Se=X.codecs)!=null?Se:[]).find(ze=>te(ze,We,{strict:!0,modify:!0}));if(!Ve)continue;const Me={mimeType:Ve.mimeType,kind:Ve.kind,clockRate:Ve.clockRate,channels:Ve.channels,localPayloadType:Ve.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:We.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:Ve.parameters,remoteParameters:We.parameters,rtcpFeedback:de(Ve,We)};De.codecs.push(Me)}for(const We of De.codecs){const Ve=X.codecs.find(ze=>$(ze)&&ze.parameters.apt===We.localPayloadType),Me=le.codecs.find(ze=>$(ze)&&ze.parameters.apt===We.remotePayloadType);Ve&&Me&&(We.localRtxPayloadType=Ve.preferredPayloadType,We.remoteRtxPayloadType=Me.preferredPayloadType)}for(const We of le.headerExtensions){const Ve=X.headerExtensions.find(ze=>ee(ze,We));if(!Ve)continue;const Me={kind:We.kind,uri:We.uri,sendId:Ve.preferredId,recvId:We.preferredId,encrypt:Ve.preferredEncrypt,direction:"sendrecv"};switch(We.direction){case"sendrecv":{Me.direction="sendrecv";break}case"recvonly":{Me.direction="sendonly";break}case"sendonly":{Me.direction="recvonly";break}case"inactive":{Me.direction="inactive";break}}De.headerExtensions.push(Me)}return De}function S(X){const le={codecs:[],headerExtensions:[]};for(const _e of X.codecs){const Se={mimeType:_e.mimeType,kind:_e.kind,preferredPayloadType:_e.remotePayloadType,clockRate:_e.clockRate,channels:_e.channels,parameters:_e.localParameters,rtcpFeedback:_e.rtcpFeedback};if(le.codecs.push(Se),!_e.remoteRtxPayloadType)continue;const De={mimeType:`${_e.kind}/rtx`,kind:_e.kind,preferredPayloadType:_e.remoteRtxPayloadType,clockRate:_e.clockRate,parameters:{apt:_e.remotePayloadType},rtcpFeedback:[]};le.codecs.push(De)}for(const _e of X.headerExtensions){if(_e.direction!=="sendrecv"&&_e.direction!=="recvonly")continue;const Se={kind:_e.kind,uri:_e.uri,preferredId:_e.recvId,preferredEncrypt:_e.encrypt,direction:_e.direction};le.headerExtensions.push(Se)}return le}function E(X,le){const _e={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const Se of le.codecs){if(Se.kind!==X)continue;const De={mimeType:Se.mimeType,payloadType:Se.localPayloadType,clockRate:Se.clockRate,channels:Se.channels,parameters:Se.localParameters,rtcpFeedback:Se.rtcpFeedback};if(_e.codecs.push(De),Se.localRtxPayloadType){const We={mimeType:`${Se.kind}/rtx`,payloadType:Se.localRtxPayloadType,clockRate:Se.clockRate,parameters:{apt:Se.localPayloadType},rtcpFeedback:[]};_e.codecs.push(We)}}for(const Se of le.headerExtensions){if(Se.kind&&Se.kind!==X||Se.direction!=="sendrecv"&&Se.direction!=="sendonly")continue;const De={uri:Se.uri,id:Se.sendId,encrypt:Se.encrypt,parameters:{}};_e.headerExtensions.push(De)}return _e}function M(X,le){var _e,Se,De;const We={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const Ve of le.codecs){if(Ve.kind!==X)continue;const Me={mimeType:Ve.mimeType,payloadType:Ve.localPayloadType,clockRate:Ve.clockRate,channels:Ve.channels,parameters:Ve.remoteParameters,rtcpFeedback:Ve.rtcpFeedback};if(We.codecs.push(Me),Ve.localRtxPayloadType){const ze={mimeType:`${Ve.kind}/rtx`,payloadType:Ve.localRtxPayloadType,clockRate:Ve.clockRate,parameters:{apt:Ve.localPayloadType},rtcpFeedback:[]};We.codecs.push(ze)}}for(const Ve of le.headerExtensions){if(Ve.kind&&Ve.kind!==X||Ve.direction!=="sendrecv"&&Ve.direction!=="sendonly")continue;const Me={uri:Ve.uri,id:Ve.sendId,encrypt:Ve.encrypt,parameters:{}};We.headerExtensions.push(Me)}if(We.headerExtensions.some(Ve=>Ve.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const Ve of We.codecs)Ve.rtcpFeedback=((_e=Ve.rtcpFeedback)!=null?_e:[]).filter(Me=>Me.type!=="goog-remb");else if(We.headerExtensions.some(Ve=>Ve.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const Ve of We.codecs)Ve.rtcpFeedback=((Se=Ve.rtcpFeedback)!=null?Se:[]).filter(Me=>Me.type!=="transport-cc");else for(const Ve of We.codecs)Ve.rtcpFeedback=((De=Ve.rtcpFeedback)!=null?De:[]).filter(Me=>Me.type!=="transport-cc"&&Me.type!=="goog-remb");return We}function R(X,le){const _e=[];if(!le)_e.push(X[0]),$(X[1])&&_e.push(X[1]);else{for(let Se=0;Se<X.length;++Se)if(te(X[Se],le,{strict:!0})){_e.push(X[Se]),$(X[Se+1])&&_e.push(X[Se+1]);break}if(_e.length===0)throw new TypeError("no matching codec found")}return _e}function N(X){X=s.clone(X),p(X);const le={mid:o,codecs:[],headerExtensions:[],encodings:[{ssrc:c}],rtcp:{cname:"probator"}};return le.codecs.push(X.codecs[0]),le.codecs[0].payloadType=h,le.headerExtensions=X.headerExtensions,le}function b(X,le){return le.codecs.some(_e=>_e.kind===X)}function m(X,le){if(p(X),X.codecs.length===0)return!1;const _e=X.codecs[0];return le.codecs.some(Se=>Se.remotePayloadType===_e.payloadType)}function w(X){const le=new RegExp("^(audio|video)/(.+)","i");if(typeof X!="object")throw new TypeError("codec is not an object");if(!X.mimeType||typeof X.mimeType!="string")throw new TypeError("missing codec.mimeType");const _e=le.exec(X.mimeType);if(!_e)throw new TypeError("invalid codec.mimeType");if(X.kind=_e[1].toLowerCase(),X.preferredPayloadType&&typeof X.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof X.clockRate!="number")throw new TypeError("missing codec.clockRate");X.kind==="audio"?typeof X.channels!="number"&&(X.channels=1):delete X.channels,(!X.parameters||typeof X.parameters!="object")&&(X.parameters={});for(const Se of Object.keys(X.parameters)){let De=X.parameters[Se];if(De===void 0&&(X.parameters[Se]="",De=""),typeof De!="string"&&typeof De!="number")throw new TypeError(`invalid codec parameter [key:${Se}s, value:${De}]`);if(Se==="apt"&&typeof De!="number")throw new TypeError("invalid codec apt parameter")}(!X.rtcpFeedback||!Array.isArray(X.rtcpFeedback))&&(X.rtcpFeedback=[]);for(const Se of X.rtcpFeedback)T(Se)}function T(X){if(typeof X!="object")throw new TypeError("fb is not an object");if(!X.type||typeof X.type!="string")throw new TypeError("missing fb.type");(!X.parameter||typeof X.parameter!="string")&&(X.parameter="")}function P(X){if(typeof X!="object")throw new TypeError("ext is not an object");if(X.kind!=="audio"&&X.kind!=="video")throw new TypeError("invalid ext.kind");if(!X.uri||typeof X.uri!="string")throw new TypeError("missing ext.uri");if(typeof X.preferredId!="number")throw new TypeError("missing ext.preferredId");if(X.preferredEncrypt&&typeof X.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(X.preferredEncrypt||(X.preferredEncrypt=!1),X.direction&&typeof X.direction!="string")throw new TypeError("invalid ext.direction");X.direction||(X.direction="sendrecv")}function L(X){const le=new RegExp("^(audio|video)/(.+)","i");if(typeof X!="object")throw new TypeError("codec is not an object");if(!X.mimeType||typeof X.mimeType!="string")throw new TypeError("missing codec.mimeType");const _e=le.exec(X.mimeType);if(!_e)throw new TypeError("invalid codec.mimeType");if(typeof X.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof X.clockRate!="number")throw new TypeError("missing codec.clockRate");_e[1].toLowerCase()==="audio"?typeof X.channels!="number"&&(X.channels=1):delete X.channels,(!X.parameters||typeof X.parameters!="object")&&(X.parameters={});for(const De of Object.keys(X.parameters)){let We=X.parameters[De];if(We===void 0&&(X.parameters[De]="",We=""),typeof We!="string"&&typeof We!="number")throw new TypeError(`invalid codec parameter [key:${De}s, value:${We}]`);if(De==="apt"&&typeof We!="number")throw new TypeError("invalid codec apt parameter")}(!X.rtcpFeedback||!Array.isArray(X.rtcpFeedback))&&(X.rtcpFeedback=[]);for(const De of X.rtcpFeedback)T(De)}function k(X){if(typeof X!="object")throw new TypeError("ext is not an object");if(!X.uri||typeof X.uri!="string")throw new TypeError("missing ext.uri");if(typeof X.id!="number")throw new TypeError("missing ext.id");if(X.encrypt&&typeof X.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");X.encrypt||(X.encrypt=!1),(!X.parameters||typeof X.parameters!="object")&&(X.parameters={});for(const le of Object.keys(X.parameters)){let _e=X.parameters[le];if(_e===void 0&&(X.parameters[le]="",_e=""),typeof _e!="string"&&typeof _e!="number")throw new TypeError("invalid header extension parameter")}}function I(X){if(typeof X!="object")throw new TypeError("encoding is not an object");if(X.ssrc&&typeof X.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(X.rid&&typeof X.rid!="string")throw new TypeError("invalid encoding.rid");if(X.rtx&&typeof X.rtx!="object")throw new TypeError("invalid encoding.rtx");if(X.rtx&&typeof X.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!X.dtx||typeof X.dtx!="boolean")&&(X.dtx=!1),X.scalabilityMode&&typeof X.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}function z(X){if(typeof X!="object")throw new TypeError("rtcp is not an object");if(X.cname&&typeof X.cname!="string")throw new TypeError("invalid rtcp.cname");(!X.reducedSize||typeof X.reducedSize!="boolean")&&(X.reducedSize=!0)}function K(X){if(typeof X!="object")throw new TypeError("numStreams is not an object");if(typeof X.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof X.MIS!="number")throw new TypeError("missing numStreams.MIS")}function $(X){return X?/.+\/rtx$/i.test(X.mimeType):!1}function te(X,le,{strict:_e=!1,modify:Se=!1}={}){const De=X.mimeType.toLowerCase(),We=le.mimeType.toLowerCase();if(De!==We||X.clockRate!==le.clockRate||X.channels!==le.channels)return!1;switch(De){case"video/h264":{if(_e){const Ve=X.parameters["packetization-mode"]||0,Me=le.parameters["packetization-mode"]||0;if(Ve!==Me||!r.isSameProfile(X.parameters,le.parameters))return!1;let ze;try{ze=r.generateProfileLevelIdStringForAnswer(X.parameters,le.parameters)}catch{return!1}Se&&(ze?(X.parameters["profile-level-id"]=ze,le.parameters["profile-level-id"]=ze):(delete X.parameters["profile-level-id"],delete le.parameters["profile-level-id"]))}break}case"video/vp9":{if(_e){const Ve=X.parameters["profile-id"]||0,Me=le.parameters["profile-id"]||0;if(Ve!==Me)return!1}break}}return!0}function ee(X,le){return!(X.kind&&le.kind&&X.kind!==le.kind||X.uri!==le.uri)}function de(X,le){var _e,Se;const De=[];for(const We of(_e=X.rtcpFeedback)!=null?_e:[]){const Ve=((Se=le.rtcpFeedback)!=null?Se:[]).find(Me=>Me.type===We.type&&(Me.parameter===We.parameter||!Me.parameter&&!We.parameter));Ve&&De.push(Ve)}return De}}}),Cb=Fe({"../../node_modules/awaitqueue/lib/Logger.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.Logger=void 0;var e=Dl(),i="awaitqueue",n=class{constructor(r){La(this,"_debug"),La(this,"_warn"),La(this,"_error"),r?(this._debug=e(`${i}:${r}`),this._warn=e(`${i}:WARN:${r}`),this._error=e(`${i}:ERROR:${r}`)):(this._debug=e(i),this._warn=e(`${i}:WARN`),this._error=e(`${i}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};t.Logger=n}}),wm=Fe({"../../node_modules/awaitqueue/lib/errors.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.AwaitQueueRemovedTaskError=t.AwaitQueueStoppedError=void 0;var e=class xm extends Error{constructor(r){super(r??"queue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,xm)}};t.AwaitQueueStoppedError=e;var i=class Em extends Error{constructor(r){super(r??"queue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,Em)}};t.AwaitQueueRemovedTaskError=i}}),Tb=Fe({"../../node_modules/awaitqueue/lib/AwaitQueue.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.AwaitQueue=void 0;var e=Cb(),i=wm(),n=new e.Logger("AwaitQueue"),r=class{constructor(){La(this,"pendingTasks",new Map),La(this,"nextTaskId",0),La(this,"stopping",!1),n.debug("constructor()")}get size(){return this.pendingTasks.size}push(s,o){return j(this,null,function*(){if(o=o??s.name,n.debug(`push() [name:${o}]`),typeof s!="function")throw new TypeError("given task is not a function");if(o)try{Object.defineProperty(s,"name",{value:o})}catch{}return new Promise((c,h)=>{const d={id:this.nextTaskId++,task:s,name:o,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:p=>{if(d.completed)return;d.completed=!0,this.pendingTasks.delete(d.id),n.debug(`resolving task [name:${d.name}]`),c(p);const[v]=this.pendingTasks.values();v&&!v.executedAt&&this.execute(v)},reject:p=>{if(!d.completed&&(d.completed=!0,this.pendingTasks.delete(d.id),n.debug(`rejecting task [name:${d.name}]: %s`,String(p)),h(p),!this.stopping)){const[v]=this.pendingTasks.values();v&&!v.executedAt&&this.execute(v)}}};this.pendingTasks.set(d.id,d),this.pendingTasks.size===1&&this.execute(d)})})}stop(){n.debug("stop()"),this.stopping=!0;for(const s of this.pendingTasks.values())n.debug(`stop() | stopping task [name:${s.name}]`),s.reject(new i.AwaitQueueStoppedError);this.stopping=!1}remove(s){n.debug(`remove() [taskIdx:${s}]`);const o=Array.from(this.pendingTasks.values())[s];if(!o){n.debug(`stop() | no task with given idx [taskIdx:${s}]`);return}o.reject(new i.AwaitQueueRemovedTaskError)}dump(){const s=Date.now();let o=0;return Array.from(this.pendingTasks.values()).map(c=>({idx:o++,task:c.task,name:c.name,enqueuedTime:c.executedAt?c.executedAt-c.enqueuedAt:s-c.enqueuedAt,executionTime:c.executedAt?s-c.executedAt:0}))}execute(s){return j(this,null,function*(){if(n.debug(`execute() [name:${s.name}]`),s.executedAt)throw new Error("task already being executed");s.executedAt=Date.now();try{const o=yield s.task();s.resolve(o)}catch(o){s.reject(o)}})}};t.AwaitQueue=r}}),Rb=Fe({"../../node_modules/awaitqueue/lib/index.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.AwaitQueueRemovedTaskError=t.AwaitQueueStoppedError=t.AwaitQueue=void 0;var e=Tb();Object.defineProperty(t,"AwaitQueue",{enumerable:!0,get:function(){return e.AwaitQueue}});var i=wm();Object.defineProperty(t,"AwaitQueueStoppedError",{enumerable:!0,get:function(){return i.AwaitQueueStoppedError}}),Object.defineProperty(t,"AwaitQueueRemovedTaskError",{enumerable:!0,get:function(){return i.AwaitQueueRemovedTaskError}})}}),Mb=Fe({"../../node_modules/queue-microtask/index.js"(t,e){ne();var i;e.exports=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:global):n=>(i||(i=Promise.resolve())).then(n).catch(r=>setTimeout(()=>{throw r},0))}}),Cm=Fe({"../../node_modules/mediasoup-client/lib/Producer.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.Producer=void 0;var e=Xi(),i=oa(),n=Mn(),r=new e.Logger("Producer"),s=class extends i.EnhancedEventEmitter{constructor({id:o,localId:c,rtpSender:h,track:d,rtpParameters:p,stopTracks:v,disableTrackOnPause:g,zeroRtpOnPause:_,appData:S}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,r.debug("constructor()"),this._id=o,this._localId=c,this._rtpSender=h,this._track=d,this._kind=d.kind,this._rtpParameters=p,this._paused=g?!d.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=v,this._disableTrackOnPause=g,this._zeroRtpOnPause=_,this._appData=S??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(o){this._appData=o}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}getStats(){return j(this,null,function*(){if(this._closed)throw new n.InvalidStateError("closed");return new Promise((o,c)=>{this.safeEmit("@getstats",o,c)})})}pause(){if(r.debug("pause()"),this._closed){r.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((o,c)=>{this.safeEmit("@pause",o,c)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(r.debug("resume()"),this._closed){r.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((o,c)=>{this.safeEmit("@resume",o,c)}).catch(()=>{}),this._observer.safeEmit("resume")}replaceTrack(o){return j(this,arguments,function*({track:c}){if(r.debug("replaceTrack() [track:%o]",c),this._closed){if(c&&this._stopTracks)try{c.stop()}catch{}throw new n.InvalidStateError("closed")}else if(c&&c.readyState==="ended")throw new n.InvalidStateError("track ended");if(c===this._track){r.debug("replaceTrack() | same track, ignored");return}yield new Promise((h,d)=>{this.safeEmit("@replacetrack",c,h,d)}),this.destroyTrack(),this._track=c,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()})}setMaxSpatialLayer(o){return j(this,null,function*(){if(this._closed)throw new n.InvalidStateError("closed");if(this._kind!=="video")throw new n.UnsupportedError("not a video Producer");if(typeof o!="number")throw new TypeError("invalid spatialLayer");o!==this._maxSpatialLayer&&(yield new Promise((c,h)=>{this.safeEmit("@setmaxspatiallayer",o,c,h)}).catch(()=>{}),this._maxSpatialLayer=o)})}setRtpEncodingParameters(o){return j(this,null,function*(){if(this._closed)throw new n.InvalidStateError("closed");if(typeof o!="object")throw new TypeError("invalid params");yield new Promise((c,h)=>{this.safeEmit("@setrtpencodingparameters",o,c,h)})})}onTrackEnded(){r.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}};t.Producer=s}}),Tm=Fe({"../../node_modules/mediasoup-client/lib/Consumer.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.Consumer=void 0;var e=Xi(),i=oa(),n=Mn(),r=new e.Logger("Consumer"),s=class extends i.EnhancedEventEmitter{constructor({id:o,localId:c,producerId:h,rtpReceiver:d,track:p,rtpParameters:v,appData:g}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,r.debug("constructor()"),this._id=o,this._localId=c,this._producerId=h,this._rtpReceiver=d,this._track=p,this._rtpParameters=v,this._paused=!p.enabled,this._appData=g??{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(o){this._appData=o}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}getStats(){return j(this,null,function*(){if(this._closed)throw new n.InvalidStateError("closed");return new Promise((o,c)=>{this.safeEmit("@getstats",o,c)})})}pause(){if(r.debug("pause()"),this._closed){r.error("pause() | Consumer closed");return}if(this._paused){r.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(r.debug("resume()"),this._closed){r.error("resume() | Consumer closed");return}if(!this._paused){r.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){r.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}};t.Consumer=s}}),Rm=Fe({"../../node_modules/mediasoup-client/lib/DataProducer.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.DataProducer=void 0;var e=Xi(),i=oa(),n=Mn(),r=new e.Logger("DataProducer"),s=class extends i.EnhancedEventEmitter{constructor({id:o,dataChannel:c,sctpStreamParameters:h,appData:d}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,r.debug("constructor()"),this._id=o,this._dataChannel=c,this._sctpStreamParameters=h,this._appData=d??{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(o){this._dataChannel.bufferedAmountLowThreshold=o}get appData(){return this._appData}set appData(o){this._appData=o}get observer(){return this._observer}close(){this._closed||(r.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(r.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(o){if(r.debug("send()"),this._closed)throw new n.InvalidStateError("closed");this._dataChannel.send(o)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(r.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",o=>{if(this._closed)return;let{error:c}=o;c||(c=new Error("unknown DataChannel error")),c.errorDetail==="sctp-failure"?r.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",c.sctpCauseCode,c.message):r.error('DataChannel "error" event: %o',c),this.safeEmit("error",c)}),this._dataChannel.addEventListener("close",()=>{this._closed||(r.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||r.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}};t.DataProducer=s}}),Mm=Fe({"../../node_modules/mediasoup-client/lib/DataConsumer.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.DataConsumer=void 0;var e=Xi(),i=oa(),n=new e.Logger("DataConsumer"),r=class extends i.EnhancedEventEmitter{constructor({id:s,dataProducerId:o,dataChannel:c,sctpStreamParameters:h,appData:d}){super(),this._closed=!1,this._observer=new i.EnhancedEventEmitter,n.debug("constructor()"),this._id=s,this._dataProducerId=o,this._dataChannel=c,this._sctpStreamParameters=h,this._appData=d??{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(s){this._dataChannel.binaryType=s}get appData(){return this._appData}set appData(s){this._appData=s}get observer(){return this._observer}close(){this._closed||(n.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(n.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(n.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",s=>{if(this._closed)return;let{error:o}=s;o||(o=new Error("unknown DataChannel error")),o.errorDetail==="sctp-failure"?n.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",o.sctpCauseCode,o.message):n.error('DataChannel "error" event: %o',o),this.safeEmit("error",o)}),this._dataChannel.addEventListener("close",()=>{this._closed||(n.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",s=>{this._closed||this.safeEmit("message",s.data)})}};t.DataConsumer=r}}),Pm=Fe({"../../node_modules/mediasoup-client/lib/Transport.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(b,m,w,T){T===void 0&&(T=w);var P=Object.getOwnPropertyDescriptor(m,w);(!P||("get"in P?!m.__esModule:P.writable||P.configurable))&&(P={enumerable:!0,get:function(){return m[w]}}),Object.defineProperty(b,T,P)}:function(b,m,w,T){T===void 0&&(T=w),b[T]=m[w]}),i=t&&t.__setModuleDefault||(Object.create?function(b,m){Object.defineProperty(b,"default",{enumerable:!0,value:m})}:function(b,m){b.default=m}),n=t&&t.__importStar||function(b){if(b&&b.__esModule)return b;var m={};if(b!=null)for(var w in b)w!=="default"&&Object.prototype.hasOwnProperty.call(b,w)&&e(m,b,w);return i(m,b),m},r=t&&t.__importDefault||function(b){return b&&b.__esModule?b:{default:b}};Object.defineProperty(t,"__esModule",{value:!0}),t.Transport=void 0;var s=Rb(),o=r(Mb()),c=Xi(),h=oa(),d=Mn(),p=n(dn()),v=n(jn()),g=Cm(),_=Tm(),S=Rm(),E=Mm(),M=new c.Logger("Transport"),R=class{constructor(b){this.consumerOptions=b,this.promise=new Promise((m,w)=>{this.resolve=m,this.reject=w})}},N=class extends h.EnhancedEventEmitter{constructor({direction:b,id:m,iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L,iceServers:k,iceTransportPolicy:I,additionalSettings:z,proprietaryConstraints:K,appData:$,handlerFactory:te,extendedRtpCapabilities:ee,canProduceByKind:de}){var X;super(),this._closed=!1,this._iceGatheringState="new",this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new s.AwaitQueue,this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new h.EnhancedEventEmitter,M.debug("constructor() [id:%s, direction:%s]",m,b),this._id=m,this._direction=b,this._extendedRtpCapabilities=ee,this._canProduceByKind=de,this._maxSctpMessageSize=L?L.maxMessageSize:null;const le=(X=p.clone(z))!=null?X:{};delete le.iceServers,delete le.iceTransportPolicy,delete le.bundlePolicy,delete le.rtcpMuxPolicy,delete le.sdpSemantics,this._handler=te(),this._handler.run({direction:b,iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L,iceServers:k,iceTransportPolicy:I,additionalSettings:le,proprietaryConstraints:K,extendedRtpCapabilities:ee}),this._appData=$??{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(b){this._appData=b}get observer(){return this._observer}close(){if(!this._closed){M.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const b of this._producers.values())b.transportClosed();this._producers.clear();for(const b of this._consumers.values())b.transportClosed();this._consumers.clear();for(const b of this._dataProducers.values())b.transportClosed();this._dataProducers.clear();for(const b of this._dataConsumers.values())b.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}getStats(){return j(this,null,function*(){if(this._closed)throw new d.InvalidStateError("closed");return this._handler.getTransportStats()})}restartIce(b){return j(this,arguments,function*({iceParameters:m}){if(M.debug("restartIce()"),this._closed)throw new d.InvalidStateError("closed");if(!m)throw new TypeError("missing iceParameters");return this._awaitQueue.push(()=>j(this,null,function*(){return yield this._handler.restartIce(m)}),"transport.restartIce()")})}updateIceServers(){return j(this,arguments,function*({iceServers:b}={}){if(M.debug("updateIceServers()"),this._closed)throw new d.InvalidStateError("closed");if(!Array.isArray(b))throw new TypeError("missing iceServers");return this._awaitQueue.push(()=>j(this,null,function*(){return this._handler.updateIceServers(b)}),"transport.updateIceServers()")})}produce(){return j(this,arguments,function*({track:b,encodings:m,codecOptions:w,codec:T,stopTracks:P=!0,disableTrackOnPause:L=!0,zeroRtpOnPause:k=!1,onRtpSender:I,appData:z={}}={}){if(M.debug("produce() [track:%o]",b),this._closed)throw new d.InvalidStateError("closed");if(b){if(this._direction!=="send")throw new d.UnsupportedError("not a sending Transport");if(this._canProduceByKind[b.kind]){if(b.readyState==="ended")throw new d.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(z&&typeof z!="object")throw new TypeError("if given, appData must be an object")}else throw new d.UnsupportedError(`cannot produce ${b.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(()=>j(this,null,function*(){let K;if(m&&!Array.isArray(m))throw TypeError("encodings must be an array");m&&m.length===0?K=void 0:m&&(K=m.map(de=>{const X={active:!0};return de.active===!1&&(X.active=!1),typeof de.dtx=="boolean"&&(X.dtx=de.dtx),typeof de.scalabilityMode=="string"&&(X.scalabilityMode=de.scalabilityMode),typeof de.scaleResolutionDownBy=="number"&&(X.scaleResolutionDownBy=de.scaleResolutionDownBy),typeof de.maxBitrate=="number"&&(X.maxBitrate=de.maxBitrate),typeof de.maxFramerate=="number"&&(X.maxFramerate=de.maxFramerate),typeof de.adaptivePtime=="boolean"&&(X.adaptivePtime=de.adaptivePtime),typeof de.priority=="string"&&(X.priority=de.priority),typeof de.networkPriority=="string"&&(X.networkPriority=de.networkPriority),X}));const{localId:$,rtpParameters:te,rtpSender:ee}=yield this._handler.send({track:b,encodings:K,codecOptions:w,codec:T,onRtpSender:I});try{v.validateRtpParameters(te);const{id:de}=yield new Promise((le,_e)=>{this.safeEmit("produce",{kind:b.kind,rtpParameters:te,appData:z},le,_e)}),X=new g.Producer({id:de,localId:$,rtpSender:ee,track:b,rtpParameters:te,stopTracks:P,disableTrackOnPause:L,zeroRtpOnPause:k,appData:z});return this._producers.set(X.id,X),this.handleProducer(X),this._observer.safeEmit("newproducer",X),X}catch(de){throw this._handler.stopSending($).catch(()=>{}),de}}),"transport.produce()").catch(K=>{if(P)try{b.stop()}catch{}throw K})})}consume(b){return j(this,arguments,function*({id:m,producerId:w,kind:T,rtpParameters:P,streamId:L,onRtpReceiver:k,appData:I={}}){if(M.debug("consume()"),this._closed)throw new d.InvalidStateError("closed");if(this._direction!=="recv")throw new d.UnsupportedError("not a receiving Transport");if(typeof m!="string")throw new TypeError("missing id");if(typeof w!="string")throw new TypeError("missing producerId");if(T!=="audio"&&T!=="video")throw new TypeError(`invalid kind '${T}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(I&&typeof I!="object")throw new TypeError("if given, appData must be an object");const z=p.clone(P);if(!v.canReceive(z,this._extendedRtpCapabilities))throw new d.UnsupportedError("cannot consume this Producer");const $=new R({id:m,producerId:w,kind:T,rtpParameters:z,streamId:L,onRtpReceiver:k,appData:I});return this._pendingConsumerTasks.push($),(0,o.default)(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),$.promise})}produceData(){return j(this,arguments,function*({ordered:b=!0,maxPacketLifeTime:m,maxRetransmits:w,label:T="",protocol:P="",appData:L={}}={}){if(M.debug("produceData()"),this._closed)throw new d.InvalidStateError("closed");if(this._direction!=="send")throw new d.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(L&&typeof L!="object")throw new TypeError("if given, appData must be an object")}else throw new d.UnsupportedError("SCTP not enabled by remote Transport");return(m||w)&&(b=!1),this._awaitQueue.push(()=>j(this,null,function*(){const{dataChannel:k,sctpStreamParameters:I}=yield this._handler.sendDataChannel({ordered:b,maxPacketLifeTime:m,maxRetransmits:w,label:T,protocol:P});v.validateSctpStreamParameters(I);const{id:z}=yield new Promise(($,te)=>{this.safeEmit("producedata",{sctpStreamParameters:I,label:T,protocol:P,appData:L},$,te)}),K=new S.DataProducer({id:z,dataChannel:k,sctpStreamParameters:I,appData:L});return this._dataProducers.set(K.id,K),this.handleDataProducer(K),this._observer.safeEmit("newdataproducer",K),K}),"transport.produceData()")})}consumeData(b){return j(this,arguments,function*({id:m,dataProducerId:w,sctpStreamParameters:T,label:P="",protocol:L="",appData:k={}}){if(M.debug("consumeData()"),this._closed)throw new d.InvalidStateError("closed");if(this._direction!=="recv")throw new d.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof m!="string")throw new TypeError("missing id");if(typeof w!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(k&&typeof k!="object")throw new TypeError("if given, appData must be an object")}else throw new d.UnsupportedError("SCTP not enabled by remote Transport");const I=p.clone(T);return v.validateSctpStreamParameters(I),this._awaitQueue.push(()=>j(this,null,function*(){const{dataChannel:z}=yield this._handler.receiveDataChannel({sctpStreamParameters:I,label:P,protocol:L}),K=new E.DataConsumer({id:m,dataProducerId:w,dataChannel:z,sctpStreamParameters:I,appData:k});return this._dataConsumers.set(K.id,K),this.handleDataConsumer(K),this._observer.safeEmit("newdataconsumer",K),K}),"transport.consumeData()")})}createPendingConsumers(){return j(this,null,function*(){this._consumerCreationInProgress=!0,this._awaitQueue.push(()=>j(this,null,function*(){if(this._pendingConsumerTasks.length===0){M.debug("createPendingConsumers() | there is no Consumer to be created");return}const b=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let m;const w=[];for(const T of b){const{id:P,kind:L,rtpParameters:k,streamId:I,onRtpReceiver:z}=T.consumerOptions;w.push({trackId:P,kind:L,rtpParameters:k,streamId:I,onRtpReceiver:z})}try{const T=yield this._handler.receive(w);for(let P=0;P<T.length;++P){const L=b[P],k=T[P],{id:I,producerId:z,kind:K,rtpParameters:$,appData:te}=L.consumerOptions,{localId:ee,rtpReceiver:de,track:X}=k,le=new _.Consumer({id:I,localId:ee,producerId:z,rtpReceiver:de,track:X,rtpParameters:$,appData:te});this._consumers.set(le.id,le),this.handleConsumer(le),!this._probatorConsumerCreated&&!m&&K==="video"&&(m=le),this._observer.safeEmit("newconsumer",le),L.resolve(le)}}catch(T){for(const P of b)P.reject(T)}if(m)try{const T=v.generateProbatorRtpParameters(m.rtpParameters);yield this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:T}]),M.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(T){M.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",T)}}),"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(()=>j(this,null,function*(){if(this._pendingPauseConsumers.size===0){M.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const b=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const m=b.map(w=>w.localId);yield this._handler.pauseReceiving(m)}catch(m){M.error("pausePendingConsumers() | failed to pause Consumers:",m)}}),"transport.pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(()=>j(this,null,function*(){if(this._pendingResumeConsumers.size===0){M.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const b=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const m=b.map(w=>w.localId);yield this._handler.resumeReceiving(m)}catch(m){M.error("resumePendingConsumers() | failed to resume Consumers:",m)}}),"transport.resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(()=>j(this,null,function*(){if(this._pendingCloseConsumers.size===0){M.debug("closePendingConsumers() | there is no Consumer to be closed");return}const b=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{yield this._handler.stopReceiving(b.map(m=>m.localId))}catch(m){M.error("closePendingConsumers() | failed to close Consumers:",m)}}),"transport.closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const b=this._handler;b.on("@connect",({dtlsParameters:m},w,T)=>{if(this._closed){T(new d.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:m},w,T)}),b.on("@icegatheringstatechange",m=>{m!==this._iceGatheringState&&(M.debug("ICE gathering state changed to %s",m),this._iceGatheringState=m,this._closed||this.safeEmit("icegatheringstatechange",m))}),b.on("@connectionstatechange",m=>{m!==this._connectionState&&(M.debug("connection state changed to %s",m),this._connectionState=m,this._closed||this.safeEmit("connectionstatechange",m))})}handleProducer(b){b.on("@close",()=>{this._producers.delete(b.id),!this._closed&&this._awaitQueue.push(()=>j(this,null,function*(){return yield this._handler.stopSending(b.localId)}),"producer @close event").catch(m=>M.warn("producer.close() failed:%o",m))}),b.on("@pause",(m,w)=>{this._awaitQueue.push(()=>j(this,null,function*(){return yield this._handler.pauseSending(b.localId)}),"producer @pause event").then(m).catch(w)}),b.on("@resume",(m,w)=>{this._awaitQueue.push(()=>j(this,null,function*(){return yield this._handler.resumeSending(b.localId)}),"producer @resume event").then(m).catch(w)}),b.on("@replacetrack",(m,w,T)=>{this._awaitQueue.push(()=>j(this,null,function*(){return yield this._handler.replaceTrack(b.localId,m)}),"producer @replacetrack event").then(w).catch(T)}),b.on("@setmaxspatiallayer",(m,w,T)=>{this._awaitQueue.push(()=>j(this,null,function*(){return yield this._handler.setMaxSpatialLayer(b.localId,m)}),"producer @setmaxspatiallayer event").then(w).catch(T)}),b.on("@setrtpencodingparameters",(m,w,T)=>{this._awaitQueue.push(()=>j(this,null,function*(){return yield this._handler.setRtpEncodingParameters(b.localId,m)}),"producer @setrtpencodingparameters event").then(w).catch(T)}),b.on("@getstats",(m,w)=>{if(this._closed)return w(new d.InvalidStateError("closed"));this._handler.getSenderStats(b.localId).then(m).catch(w)})}handleConsumer(b){b.on("@close",()=>{this._consumers.delete(b.id),this._pendingPauseConsumers.delete(b.id),this._pendingResumeConsumers.delete(b.id),!this._closed&&(this._pendingCloseConsumers.set(b.id,b),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),b.on("@pause",()=>{this._pendingResumeConsumers.has(b.id)&&this._pendingResumeConsumers.delete(b.id),this._pendingPauseConsumers.set(b.id,b),(0,o.default)(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),b.on("@resume",()=>{this._pendingPauseConsumers.has(b.id)&&this._pendingPauseConsumers.delete(b.id),this._pendingResumeConsumers.set(b.id,b),(0,o.default)(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),b.on("@getstats",(m,w)=>{if(this._closed)return w(new d.InvalidStateError("closed"));this._handler.getReceiverStats(b.localId).then(m).catch(w)})}handleDataProducer(b){b.on("@close",()=>{this._dataProducers.delete(b.id)})}handleDataConsumer(b){b.on("@close",()=>{this._dataConsumers.delete(b.id)})}};t.Transport=N}}),Tr=Fe({"../../node_modules/mediasoup-client/lib/handlers/sdp/commonUtils.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(d,p,v,g){g===void 0&&(g=v);var _=Object.getOwnPropertyDescriptor(p,v);(!_||("get"in _?!p.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return p[v]}}),Object.defineProperty(d,g,_)}:function(d,p,v,g){g===void 0&&(g=v),d[g]=p[v]}),i=t&&t.__setModuleDefault||(Object.create?function(d,p){Object.defineProperty(d,"default",{enumerable:!0,value:p})}:function(d,p){d.default=p}),n=t&&t.__importStar||function(d){if(d&&d.__esModule)return d;var p={};if(d!=null)for(var v in d)v!=="default"&&Object.prototype.hasOwnProperty.call(d,v)&&e(p,d,v);return i(p,d),p};Object.defineProperty(t,"__esModule",{value:!0}),t.extractRtpCapabilities=s,t.extractDtlsParameters=o,t.getCname=c,t.applyCodecParameters=h;var r=n(ln());function s({sdpObject:d}){const p=new Map,v=[];let g=!1,_=!1;for(const E of d.media){const M=E.type;switch(M){case"audio":{if(g)continue;g=!0;break}case"video":{if(_)continue;_=!0;break}default:continue}for(const R of E.rtp){const N={kind:M,mimeType:`${M}/${R.codec}`,preferredPayloadType:R.payload,clockRate:R.rate,channels:R.encoding,parameters:{},rtcpFeedback:[]};p.set(N.preferredPayloadType,N)}for(const R of E.fmtp||[]){const N=r.parseParams(R.config),b=p.get(R.payload);b&&(N!=null&&N.hasOwnProperty("profile-level-id")&&(N["profile-level-id"]=String(N["profile-level-id"])),b.parameters=N)}for(const R of E.rtcpFb||[]){const N={type:R.type,parameter:R.subtype};if(N.parameter||delete N.parameter,R.payload!=="*"){const b=p.get(R.payload);if(!b)continue;b.rtcpFeedback.push(N)}else for(const b of p.values())b.kind===M&&!/.+\/rtx$/i.test(b.mimeType)&&b.rtcpFeedback.push(N)}for(const R of E.ext||[]){if(R["encrypt-uri"])continue;const N={kind:M,uri:R.uri,preferredId:R.value};v.push(N)}}return{codecs:Array.from(p.values()),headerExtensions:v}}function o({sdpObject:d}){let p=d.setup,v=d.fingerprint;if(!p||!v){const S=(d.media||[]).find(E=>E.port!==0);S&&(p??(p=S.setup),v??(v=S.fingerprint))}if(p){if(!v)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let g;switch(p){case"active":{g="client";break}case"passive":{g="server";break}case"actpass":{g="auto";break}}return{role:g,fingerprints:[{algorithm:v.type,value:v.hash}]}}function c({offerMediaObject:d}){const p=(d.ssrcs||[]).find(v=>v.attribute==="cname");return p?p.value:""}function h({offerRtpParameters:d,answerMediaObject:p}){for(const v of d.codecs){const g=v.mimeType.toLowerCase();if(g!=="audio/opus"||!(p.rtp||[]).find(M=>M.payload===v.payloadType))continue;p.fmtp=p.fmtp||[];let S=p.fmtp.find(M=>M.payload===v.payloadType);S||(S={payload:v.payloadType,config:""},p.fmtp.push(S));const E=r.parseParams(S.config);switch(g){case"audio/opus":{const M=v.parameters["sprop-stereo"];M!==void 0&&(E.stereo=M?1:0);break}}S.config="";for(const M of Object.keys(E))S.config&&(S.config+=";"),S.config+=`${M}=${E[M]}`}}}}),ca=Fe({"../../node_modules/mediasoup-client/lib/handlers/sdp/unifiedPlanUtils.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.getRtpEncodings=e,t.addLegacySimulcast=i;function e({offerMediaObject:n}){const r=new Set;for(const c of n.ssrcs||[]){const h=c.id;r.add(h)}if(r.size===0)throw new Error("no a=ssrc lines found");const s=new Map;for(const c of n.ssrcGroups||[]){if(c.semantics!=="FID")continue;let[h,d]=c.ssrcs.split(/\s+/);h=Number(h),d=Number(d),r.has(h)&&(r.delete(h),r.delete(d),s.set(h,d))}for(const c of r)s.set(c,null);const o=[];for(const[c,h]of s){const d={ssrc:c};h&&(d.rtx={ssrc:h}),o.push(d)}return o}function i({offerMediaObject:n,numStreams:r}){if(r<=1)throw new TypeError("numStreams must be greater than 1");const s=(n.ssrcs||[]).find(S=>S.attribute==="msid");if(!s)throw new Error("a=ssrc line with msid information not found");const[o,c]=s.value.split(" "),h=Number(s.id);let d;(n.ssrcGroups||[]).some(S=>{if(S.semantics!=="FID")return!1;const E=S.ssrcs.split(/\s+/);return Number(E[0])===h?(d=Number(E[1]),!0):!1});const p=n.ssrcs.find(S=>S.attribute==="cname");if(!p)throw new Error("a=ssrc line with cname information not found");const v=p.value,g=[],_=[];for(let S=0;S<r;++S)g.push(h+S),d&&_.push(d+S);n.ssrcGroups=[],n.ssrcs=[],n.ssrcGroups.push({semantics:"SIM",ssrcs:g.join(" ")});for(const S of g)n.ssrcs.push({id:S,attribute:"cname",value:v}),n.ssrcs.push({id:S,attribute:"msid",value:`${o} ${c}`});for(let S=0;S<_.length;++S){const E=g[S],M=_[S];n.ssrcs.push({id:M,attribute:"cname",value:v}),n.ssrcs.push({id:M,attribute:"msid",value:`${o} ${c}`}),n.ssrcGroups.push({semantics:"FID",ssrcs:`${E} ${M}`})}}}}),Il=Fe({"../../node_modules/mediasoup-client/lib/handlers/ortc/utils.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.addNackSuppportForOpus=e;function e(i){var n,r;for(const s of(n=i.codecs)!=null?n:[])(s.mimeType.toLowerCase()==="audio/opus"||s.mimeType.toLowerCase()==="audio/multiopus")&&!((r=s.rtcpFeedback)!=null&&r.some(o=>o.type==="nack"&&!o.parameter))&&(s.rtcpFeedback||(s.rtcpFeedback=[]),s.rtcpFeedback.push({type:"nack"}))}}}),Zn=Fe({"../../node_modules/mediasoup-client/lib/handlers/HandlerInterface.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.HandlerInterface=void 0;var e=oa(),i=class extends e.EnhancedEventEmitter{constructor(){super()}};t.HandlerInterface=i}}),Pb=Fe({"../../node_modules/mediasoup-client/lib/handlers/sdp/MediaSection.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(p,v,g,_){_===void 0&&(_=g);var S=Object.getOwnPropertyDescriptor(v,g);(!S||("get"in S?!v.__esModule:S.writable||S.configurable))&&(S={enumerable:!0,get:function(){return v[g]}}),Object.defineProperty(p,_,S)}:function(p,v,g,_){_===void 0&&(_=g),p[_]=v[g]}),i=t&&t.__setModuleDefault||(Object.create?function(p,v){Object.defineProperty(p,"default",{enumerable:!0,value:v})}:function(p,v){p.default=v}),n=t&&t.__importStar||function(p){if(p&&p.__esModule)return p;var v={};if(p!=null)for(var g in p)g!=="default"&&Object.prototype.hasOwnProperty.call(p,g)&&e(v,p,g);return i(v,p),v};Object.defineProperty(t,"__esModule",{value:!0}),t.OfferMediaSection=t.AnswerMediaSection=t.MediaSection=void 0;var r=n(ln()),s=n(dn()),o=class{constructor({iceParameters:p,iceCandidates:v,dtlsParameters:g,planB:_=!1}){var S;if(this._mediaObject={},this._planB=_,p&&this.setIceParameters(p),v){this._mediaObject.candidates=[];for(const E of v){const M={};M.component=1,M.foundation=E.foundation,M.ip=(S=E.address)!=null?S:E.ip,M.port=E.port,M.priority=E.priority,M.transport=E.protocol,M.type=E.type,E.tcpType&&(M.tcptype=E.tcpType),this._mediaObject.candidates.push(M)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}g&&this.setDtlsRole(g.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(p){this._mediaObject.iceUfrag=p.usernameFragment,this._mediaObject.icePwd=p.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}};t.MediaSection=o;var c=class extends o{constructor({iceParameters:p,iceCandidates:v,dtlsParameters:g,sctpParameters:_,plainRtpParameters:S,planB:E=!1,offerMediaObject:M,offerRtpParameters:R,answerRtpParameters:N,codecOptions:b,extmapAllowMixed:m=!1}){var w,T,P,L,k;switch(super({iceParameters:p,iceCandidates:v,dtlsParameters:g,planB:E}),this._mediaObject.mid=String(M.mid),this._mediaObject.type=M.type,this._mediaObject.protocol=M.protocol,S?(this._mediaObject.connection={ip:S.ip,version:S.ipVersion},this._mediaObject.port=S.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),M.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const I of N.codecs){const z={payload:I.payloadType,codec:d(I),rate:I.clockRate};I.channels>1&&(z.encoding=I.channels),this._mediaObject.rtp.push(z);const K=(w=s.clone(I.parameters))!=null?w:{};let $=(T=s.clone(I.rtcpFeedback))!=null?T:[];if(b){const{opusStereo:ee,opusFec:de,opusDtx:X,opusMaxPlaybackRate:le,opusMaxAverageBitrate:_e,opusPtime:Se,opusNack:De,videoGoogleStartBitrate:We,videoGoogleMaxBitrate:Ve,videoGoogleMinBitrate:Me}=b,ze=R.codecs.find(ht=>ht.payloadType===I.payloadType);switch(I.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{ee!==void 0&&(ze.parameters["sprop-stereo"]=ee?1:0,K.stereo=ee?1:0),de!==void 0&&(ze.parameters.useinbandfec=de?1:0,K.useinbandfec=de?1:0),X!==void 0&&(ze.parameters.usedtx=X?1:0,K.usedtx=X?1:0),le!==void 0&&(K.maxplaybackrate=le),_e!==void 0&&(K.maxaveragebitrate=_e),Se!==void 0&&(ze.parameters.ptime=Se,K.ptime=Se),De||(ze.rtcpFeedback=ze.rtcpFeedback.filter(ht=>ht.type!=="nack"||ht.parameter),$=$.filter(ht=>ht.type!=="nack"||ht.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{We!==void 0&&(K["x-google-start-bitrate"]=We),Ve!==void 0&&(K["x-google-max-bitrate"]=Ve),Me!==void 0&&(K["x-google-min-bitrate"]=Me);break}}}const te={payload:I.payloadType,config:""};for(const ee of Object.keys(K))te.config&&(te.config+=";"),te.config+=`${ee}=${K[ee]}`;te.config&&this._mediaObject.fmtp.push(te);for(const ee of $)this._mediaObject.rtcpFb.push({payload:I.payloadType,type:ee.type,subtype:ee.parameter})}this._mediaObject.payloads=N.codecs.map(I=>I.payloadType).join(" "),this._mediaObject.ext=[];for(const I of N.headerExtensions)((P=M.ext)!=null?P:[]).some(K=>K.uri===I.uri)&&this._mediaObject.ext.push({uri:I.uri,value:I.id});if(m&&M.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),M.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:M.simulcast.list1},this._mediaObject.rids=[];for(const I of(L=M.rids)!=null?L:[])I.direction==="send"&&this._mediaObject.rids.push({id:I.id,direction:"recv"})}else if(M.simulcast_03){this._mediaObject.simulcast_03={value:M.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const I of(k=M.rids)!=null?k:[])I.direction==="send"&&this._mediaObject.rids.push({id:I.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof M.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=_.port,this._mediaObject.maxMessageSize=_.maxMessageSize):M.sctpmap&&(this._mediaObject.payloads=_.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:_.port,maxMessageSize:_.maxMessageSize});break}}}setDtlsRole(p){switch(p){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(p){var v,g;if(!((v=this._mediaObject.simulcast)!=null&&v.list1))return;const _={};for(const M of p)M.rid&&(_[M.rid]=M);const S=this._mediaObject.simulcast.list1,E=r.parseSimulcastStreamList(S);for(const M of E)for(const R of M)R.paused=!((g=_[R.scid])!=null&&g.active);this._mediaObject.simulcast.list1=E.map(M=>M.map(R=>`${R.paused?"~":""}${R.scid}`).join(",")).join(";")}};t.AnswerMediaSection=c;var h=class extends o{constructor({iceParameters:p,iceCandidates:v,dtlsParameters:g,sctpParameters:_,plainRtpParameters:S,planB:E=!1,mid:M,kind:R,offerRtpParameters:N,streamId:b,trackId:m,oldDataChannelSpec:w=!1}){var T;switch(super({iceParameters:p,iceCandidates:v,dtlsParameters:g,planB:E}),this._mediaObject.mid=String(M),this._mediaObject.type=R,S?(this._mediaObject.connection={ip:S.ip,version:S.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=S.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},_?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),R){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${b??"-"} ${m}`);for(const I of N.codecs){const z={payload:I.payloadType,codec:d(I),rate:I.clockRate};I.channels>1&&(z.encoding=I.channels),this._mediaObject.rtp.push(z);const K={payload:I.payloadType,config:""};for(const $ of Object.keys(I.parameters))K.config&&(K.config+=";"),K.config+=`${$}=${I.parameters[$]}`;K.config&&this._mediaObject.fmtp.push(K);for(const $ of I.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:I.payloadType,type:$.type,subtype:$.parameter})}this._mediaObject.payloads=N.codecs.map(I=>I.payloadType).join(" "),this._mediaObject.ext=[];for(const I of N.headerExtensions)this._mediaObject.ext.push({uri:I.uri,value:I.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const P=N.encodings[0],L=P.ssrc,k=(T=P.rtx)==null?void 0:T.ssrc;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],N.rtcp.cname&&this._mediaObject.ssrcs.push({id:L,attribute:"cname",value:N.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:L,attribute:"msid",value:`${b??"-"} ${m}`}),k&&(N.rtcp.cname&&this._mediaObject.ssrcs.push({id:k,attribute:"cname",value:N.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:k,attribute:"msid",value:`${b??"-"} ${m}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${L} ${k}`}));break}case"application":{w?(this._mediaObject.payloads=_.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:_.port,maxMessageSize:_.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=_.port,this._mediaObject.maxMessageSize=_.maxMessageSize);break}}}setDtlsRole(p){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:p,streamId:v,trackId:g}){var _;const S=p.encodings[0],E=S.ssrc,M=(_=S.rtx)==null?void 0:_.ssrc,R=this._mediaObject.payloads.split(" ");for(const N of p.codecs){if(R.includes(String(N.payloadType)))continue;const b={payload:N.payloadType,codec:d(N),rate:N.clockRate};N.channels>1&&(b.encoding=N.channels),this._mediaObject.rtp.push(b);const m={payload:N.payloadType,config:""};for(const w of Object.keys(N.parameters))m.config&&(m.config+=";"),m.config+=`${w}=${N.parameters[w]}`;m.config&&this._mediaObject.fmtp.push(m);for(const w of N.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:N.payloadType,type:w.type,subtype:w.parameter})}this._mediaObject.payloads+=` ${p.codecs.filter(N=>!this._mediaObject.payloads.includes(N.payloadType)).map(N=>N.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),p.rtcp.cname&&this._mediaObject.ssrcs.push({id:E,attribute:"cname",value:p.rtcp.cname}),this._mediaObject.ssrcs.push({id:E,attribute:"msid",value:`${v??"-"} ${g}`}),M&&(p.rtcp.cname&&this._mediaObject.ssrcs.push({id:M,attribute:"cname",value:p.rtcp.cname}),this._mediaObject.ssrcs.push({id:M,attribute:"msid",value:`${v??"-"} ${g}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${E} ${M}`}))}planBStopReceiving({offerRtpParameters:p}){var v;const g=p.encodings[0],_=g.ssrc,S=(v=g.rtx)==null?void 0:v.ssrc;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(E=>E.id!==_&&E.id!==S),S&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(E=>E.ssrcs!==`${_} ${S}`))}};t.OfferMediaSection=h;function d(p){const g=new RegExp("^(audio|video)/(.+)","i").exec(p.mimeType);if(!g)throw new TypeError("invalid codec.mimeType");return g[2]}}}),Rr=Fe({"../../node_modules/mediasoup-client/lib/handlers/sdp/RemoteSdp.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(d,p,v,g){g===void 0&&(g=v);var _=Object.getOwnPropertyDescriptor(p,v);(!_||("get"in _?!p.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return p[v]}}),Object.defineProperty(d,g,_)}:function(d,p,v,g){g===void 0&&(g=v),d[g]=p[v]}),i=t&&t.__setModuleDefault||(Object.create?function(d,p){Object.defineProperty(d,"default",{enumerable:!0,value:p})}:function(d,p){d.default=p}),n=t&&t.__importStar||function(d){if(d&&d.__esModule)return d;var p={};if(d!=null)for(var v in d)v!=="default"&&Object.prototype.hasOwnProperty.call(d,v)&&e(p,d,v);return i(p,d),p};Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteSdp=void 0;var r=n(ln()),s=Xi(),o=Pb(),c=new s.Logger("RemoteSdp"),h=class{constructor({iceParameters:d,iceCandidates:p,dtlsParameters:v,sctpParameters:g,plainRtpParameters:_,planB:S=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=d,this._iceCandidates=p,this._dtlsParameters=v,this._sctpParameters=g,this._plainRtpParameters=_,this._planB=S,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},d!=null&&d.iceLite&&(this._sdpObject.icelite="ice-lite"),v){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const E=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:v.fingerprints[E-1].algorithm,hash:v.fingerprints[E-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}_&&(this._sdpObject.origin.address=_.ip,this._sdpObject.origin.ipVer=_.ipVersion)}updateIceParameters(d){c.debug("updateIceParameters() [iceParameters:%o]",d),this._iceParameters=d,this._sdpObject.icelite=d.iceLite?"ice-lite":void 0;for(const p of this._mediaSections)p.setIceParameters(d)}updateDtlsRole(d){c.debug("updateDtlsRole() [role:%s]",d),this._dtlsParameters.role=d;for(const p of this._mediaSections)p.setDtlsRole(d)}getNextMediaSectionIdx(){for(let d=0;d<this._mediaSections.length;++d){const p=this._mediaSections[d];if(p.closed)return{idx:d,reuseMid:p.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:d,reuseMid:p,offerRtpParameters:v,answerRtpParameters:g,codecOptions:_,extmapAllowMixed:S=!1}){const E=new o.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:d,offerRtpParameters:v,answerRtpParameters:g,codecOptions:_,extmapAllowMixed:S});p?this._replaceMediaSection(E,p):this._midToIndex.has(E.mid)?this._replaceMediaSection(E):this._addMediaSection(E)}receive({mid:d,kind:p,offerRtpParameters:v,streamId:g,trackId:_}){const S=this._midToIndex.get(d);let E;if(S!==void 0&&(E=this._mediaSections[S]),E)E.planBReceive({offerRtpParameters:v,streamId:g,trackId:_}),this._replaceMediaSection(E);else{E=new o.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:d,kind:p,offerRtpParameters:v,streamId:g,trackId:_});const M=this._mediaSections.find(R=>R.closed);M?this._replaceMediaSection(E,M.mid):this._addMediaSection(E)}}pauseMediaSection(d){this._findMediaSection(d).pause()}resumeSendingMediaSection(d){this._findMediaSection(d).resume()}resumeReceivingMediaSection(d){this._findMediaSection(d).resume()}disableMediaSection(d){this._findMediaSection(d).disable()}closeMediaSection(d){const p=this._findMediaSection(d);return d===this._firstMid?(c.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",d),this.disableMediaSection(d),!1):(p.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(d,p){const v=this._findMediaSection(d);v.muxSimulcastStreams(p),this._replaceMediaSection(v)}planBStopReceiving({mid:d,offerRtpParameters:p}){const v=this._findMediaSection(d);v.planBStopReceiving({offerRtpParameters:p}),this._replaceMediaSection(v)}sendSctpAssociation({offerMediaObject:d}){const p=new o.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:d});this._addMediaSection(p)}receiveSctpAssociation({oldDataChannelSpec:d=!1}={}){const p=new o.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:d});this._addMediaSection(p)}getSdp(){return this._sdpObject.origin.sessionVersion++,r.write(this._sdpObject)}_addMediaSection(d){this._firstMid||(this._firstMid=d.mid),this._mediaSections.push(d),this._midToIndex.set(d.mid,this._mediaSections.length-1),this._sdpObject.media.push(d.getObject()),this._regenerateBundleMids()}_replaceMediaSection(d,p){if(typeof p=="string"){const v=this._midToIndex.get(p);if(v===void 0)throw new Error(`no media section found for reuseMid '${p}'`);const g=this._mediaSections[v];this._mediaSections[v]=d,this._midToIndex.delete(g.mid),this._midToIndex.set(d.mid,v),this._sdpObject.media[v]=d.getObject(),this._regenerateBundleMids()}else{const v=this._midToIndex.get(d.mid);if(v===void 0)throw new Error(`no media section found with mid '${d.mid}'`);this._mediaSections[v]=d,this._sdpObject.media[v]=d.getObject()}}_findMediaSection(d){const p=this._midToIndex.get(d);if(p===void 0)throw new Error(`no media section found with mid '${d}'`);return this._mediaSections[p]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(d=>!d.closed).map(d=>d.mid).join(" "))}};t.RemoteSdp=h}}),Ps=Fe({"../../node_modules/mediasoup-client/lib/scalabilityModes.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.parse=i;var e=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function i(n){const r=e.exec(n??"");return r?{spatialLayers:Number(r[1]),temporalLayers:Number(r[2])}:{spatialLayers:1,temporalLayers:1}}}}),Ab=Fe({"../../node_modules/mediasoup-client/lib/handlers/Chrome111.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(b,m,w,T){T===void 0&&(T=w);var P=Object.getOwnPropertyDescriptor(m,w);(!P||("get"in P?!m.__esModule:P.writable||P.configurable))&&(P={enumerable:!0,get:function(){return m[w]}}),Object.defineProperty(b,T,P)}:function(b,m,w,T){T===void 0&&(T=w),b[T]=m[w]}),i=t&&t.__setModuleDefault||(Object.create?function(b,m){Object.defineProperty(b,"default",{enumerable:!0,value:m})}:function(b,m){b.default=m}),n=t&&t.__importStar||function(b){if(b&&b.__esModule)return b;var m={};if(b!=null)for(var w in b)w!=="default"&&Object.prototype.hasOwnProperty.call(b,w)&&e(m,b,w);return i(m,b),m};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome111=void 0;var r=n(ln()),s=Xi(),o=n(dn()),c=n(jn()),h=n(Tr()),d=n(ca()),p=n(Il()),v=Mn(),g=Zn(),_=Rr(),S=Ps(),E=new s.Logger("Chrome111"),M="Chrome111",R={OS:1024,MIS:1024},N=class Am extends g.HandlerInterface{static createFactory(){return()=>new Am}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return M}close(){if(E.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}getNativeRtpCapabilities(){return j(this,null,function*(){E.debug("getNativeRtpCapabilities()");const m=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{m.addTransceiver("audio"),m.addTransceiver("video");const w=yield m.createOffer();try{m.close()}catch{}const T=r.parse(w.sdp),P=h.extractRtpCapabilities({sdpObject:T});return p.addNackSuppportForOpus(P),P}catch(w){try{m.close()}catch{}throw w}})}getNativeSctpCapabilities(){return j(this,null,function*(){return E.debug("getNativeSctpCapabilities()"),{numStreams:R}})}run({direction:m,iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L,iceServers:k,iceTransportPolicy:I,additionalSettings:z,proprietaryConstraints:K,extendedRtpCapabilities:$}){this.assertNotClosed(),E.debug("run()"),this._direction=m,this._remoteSdp=new _.RemoteSdp({iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",$),video:c.getSendingRtpParameters("video",$)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",$),video:c.getSendingRemoteRtpParameters("video",$)},P.role&&P.role!=="auto"&&(this._forcedLocalDtlsRole=P.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:k??[],iceTransportPolicy:I??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},z),K),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(E.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}updateIceServers(m){return j(this,null,function*(){this.assertNotClosed(),E.debug("updateIceServers()");const w=this._pc.getConfiguration();w.iceServers=m,this._pc.setConfiguration(w)})}restartIce(m){return j(this,null,function*(){if(this.assertNotClosed(),E.debug("restartIce()"),this._remoteSdp.updateIceParameters(m),!!this._transportReady)if(this._direction==="send"){const w=yield this._pc.createOffer({iceRestart:!0});E.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)}else{const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)}})}getTransportStats(){return j(this,null,function*(){return this.assertNotClosed(),this._pc.getStats()})}send(m){return j(this,arguments,function*({track:w,encodings:T,codecOptions:P,codec:L,onRtpSender:k}){var I;if(this.assertNotClosed(),this.assertSendDirection(),E.debug("send() [kind:%s, track.id:%s]",w.kind,w.id),T&&T.length>1){let Se=1;for(const De of T){const We=De.scalabilityMode?(0,S.parse)(De.scalabilityMode).temporalLayers:3;We>Se&&(Se=We)}T.forEach((De,We)=>{De.rid=`r${We}`,De.scalabilityMode=`L1T${Se}`})}const z=o.clone(this._sendingRtpParametersByKind[w.kind]);z.codecs=c.reduceCodecs(z.codecs,L);const K=o.clone(this._sendingRemoteRtpParametersByKind[w.kind]);K.codecs=c.reduceCodecs(K.codecs,L);const $=this._remoteSdp.getNextMediaSectionIdx(),te=this._pc.addTransceiver(w,{direction:"sendonly",streams:[this._sendStream],sendEncodings:T});k&&k(te.sender);const ee=yield this._pc.createOffer();let de=r.parse(ee.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:(I=this._forcedLocalDtlsRole)!=null?I:"client",localSdpObject:de})),E.debug("send() | calling pc.setLocalDescription() [offer:%o]",ee),yield this._pc.setLocalDescription(ee);const X=te.mid;z.mid=X,de=r.parse(this._pc.localDescription.sdp);const le=de.media[$.idx];if(z.rtcp.cname=h.getCname({offerMediaObject:le}),!T)z.encodings=d.getRtpEncodings({offerMediaObject:le});else if(T.length===1){const Se=d.getRtpEncodings({offerMediaObject:le});Object.assign(Se[0],T[0]),z.encodings=Se}else z.encodings=T;this._remoteSdp.send({offerMediaObject:le,reuseMid:$.reuseMid,offerRtpParameters:z,answerRtpParameters:K,codecOptions:P,extmapAllowMixed:!0});const _e={type:"answer",sdp:this._remoteSdp.getSdp()};return E.debug("send() | calling pc.setRemoteDescription() [answer:%o]",_e),yield this._pc.setRemoteDescription(_e),this._mapMidTransceiver.set(X,te),{localId:X,rtpParameters:z,rtpSender:te.sender}})}stopSending(m){return j(this,null,function*(){if(this.assertSendDirection(),E.debug("stopSending() [localId:%s]",m),this._closed)return;const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");if(w.sender.replaceTrack(null),this._pc.removeTrack(w.sender),this._remoteSdp.closeMediaSection(w.mid))try{w.stop()}catch{}const P=yield this._pc.createOffer();E.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L),this._mapMidTransceiver.delete(m)})}pauseSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("pauseSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="inactive",this._remoteSdp.pauseMediaSection(m);const T=yield this._pc.createOffer();E.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}resumeSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("resumeSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(this._remoteSdp.resumeSendingMediaSection(m),!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="sendonly";const T=yield this._pc.createOffer();E.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}replaceTrack(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),w?E.debug("replaceTrack() [localId:%s, track.id:%s]",m,w.id):E.debug("replaceTrack() [localId:%s, no track]",m);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");yield T.sender.replaceTrack(w)})}setMaxSpatialLayer(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{z<=w?I.active=!0:I.active=!1}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}setRtpEncodingParameters(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setRtpEncodingParameters() [localId:%s, params:%o]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{P.encodings[z]=ae(ae({},I),w)}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}getSenderStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.sender.getStats()})}sendDataChannel(m){return j(this,arguments,function*({ordered:w,maxPacketLifeTime:T,maxRetransmits:P,label:L,protocol:k}){var I;this.assertNotClosed(),this.assertSendDirection();const z={negotiated:!0,id:this._nextSendSctpStreamId,ordered:w,maxPacketLifeTime:T,maxRetransmits:P,protocol:k};E.debug("sendDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(L,z);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%R.MIS,!this._hasDataChannelMediaSection){const te=yield this._pc.createOffer(),ee=r.parse(te.sdp),de=ee.media.find(le=>le.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(I=this._forcedLocalDtlsRole)!=null?I:"client",localSdpObject:ee})),E.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",te),yield this._pc.setLocalDescription(te),this._remoteSdp.sendSctpAssociation({offerMediaObject:de});const X={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",X),yield this._pc.setRemoteDescription(X),this._hasDataChannelMediaSection=!0}const $={streamId:z.id,ordered:z.ordered,maxPacketLifeTime:z.maxPacketLifeTime,maxRetransmits:z.maxRetransmits};return{dataChannel:K,sctpStreamParameters:$}})}receive(m){return j(this,null,function*(){var w,T;this.assertNotClosed(),this.assertRecvDirection();const P=[],L=new Map;for(const K of m){const{trackId:$,kind:te,rtpParameters:ee,streamId:de}=K;E.debug("receive() [trackId:%s, kind:%s]",$,te);const X=(w=ee.mid)!=null?w:String(this._mapMidTransceiver.size);L.set($,X),this._remoteSdp.receive({mid:X,kind:te,offerRtpParameters:ee,streamId:de??ee.rtcp.cname,trackId:$})}const k={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",k),yield this._pc.setRemoteDescription(k);for(const K of m){const{trackId:$,onRtpReceiver:te}=K;if(te){const ee=L.get($),de=this._pc.getTransceivers().find(X=>X.mid===ee);if(!de)throw new Error("transceiver not found");te(de.receiver)}}let I=yield this._pc.createAnswer();const z=r.parse(I.sdp);for(const K of m){const{trackId:$,rtpParameters:te}=K,ee=L.get($),de=z.media.find(X=>String(X.mid)===ee);h.applyCodecParameters({offerRtpParameters:te,answerMediaObject:de})}I={type:"answer",sdp:r.write(z)},this._transportReady||(yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:z})),E.debug("receive() | calling pc.setLocalDescription() [answer:%o]",I),yield this._pc.setLocalDescription(I);for(const K of m){const{trackId:$}=K,te=L.get($),ee=this._pc.getTransceivers().find(de=>de.mid===te);if(ee)this._mapMidTransceiver.set(te,ee),P.push({localId:te,track:ee.receiver.track,rtpReceiver:ee.receiver});else throw new Error("new RTCRtpTransceiver not found")}return P})}stopReceiving(m){return j(this,null,function*(){if(this.assertRecvDirection(),this._closed)return;for(const P of m){E.debug("stopReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(L.mid)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T);for(const P of m)this._mapMidTransceiver.delete(P)})}pauseReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("pauseReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="inactive",this._remoteSdp.pauseMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}resumeReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("resumeReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}getReceiverStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.receiver.getStats()})}receiveDataChannel(m){return j(this,arguments,function*({sctpStreamParameters:w,label:T,protocol:P}){var L;this.assertNotClosed(),this.assertRecvDirection();const{streamId:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K}=w,$={negotiated:!0,id:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K,protocol:P};E.debug("receiveDataChannel() [options:%o]",$);const te=this._pc.createDataChannel(T,$);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const ee={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",ee),yield this._pc.setRemoteDescription(ee);const de=yield this._pc.createAnswer();if(!this._transportReady){const X=r.parse(de.sdp);yield this.setupTransport({localDtlsRole:(L=this._forcedLocalDtlsRole)!=null?L:"client",localSdpObject:X})}E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",de),yield this._pc.setLocalDescription(de),this._hasDataChannelMediaSection=!0}return{dataChannel:te}})}setupTransport(m){return j(this,arguments,function*({localDtlsRole:w,localSdpObject:T}){T||(T=r.parse(this._pc.localDescription.sdp));const P=h.extractDtlsParameters({sdpObject:T});P.role=w,this._remoteSdp.updateDtlsRole(w==="client"?"server":"client"),yield new Promise((L,k)=>{this.safeEmit("@connect",{dtlsParameters:P},L,k)}),this._transportReady=!0})}assertNotClosed(){if(this._closed)throw new v.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Chrome111=N}}),Db=Fe({"../../node_modules/mediasoup-client/lib/handlers/Chrome74.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(b,m,w,T){T===void 0&&(T=w);var P=Object.getOwnPropertyDescriptor(m,w);(!P||("get"in P?!m.__esModule:P.writable||P.configurable))&&(P={enumerable:!0,get:function(){return m[w]}}),Object.defineProperty(b,T,P)}:function(b,m,w,T){T===void 0&&(T=w),b[T]=m[w]}),i=t&&t.__setModuleDefault||(Object.create?function(b,m){Object.defineProperty(b,"default",{enumerable:!0,value:m})}:function(b,m){b.default=m}),n=t&&t.__importStar||function(b){if(b&&b.__esModule)return b;var m={};if(b!=null)for(var w in b)w!=="default"&&Object.prototype.hasOwnProperty.call(b,w)&&e(m,b,w);return i(m,b),m};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome74=void 0;var r=n(ln()),s=Xi(),o=n(dn()),c=n(jn()),h=n(Tr()),d=n(ca()),p=n(Il()),v=Mn(),g=Zn(),_=Rr(),S=Ps(),E=new s.Logger("Chrome74"),M="Chrome74",R={OS:1024,MIS:1024},N=class Dm extends g.HandlerInterface{static createFactory(){return()=>new Dm}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return M}close(){if(E.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}getNativeRtpCapabilities(){return j(this,null,function*(){E.debug("getNativeRtpCapabilities()");const m=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{m.addTransceiver("audio"),m.addTransceiver("video");const w=yield m.createOffer();try{m.close()}catch{}const T=r.parse(w.sdp),P=h.extractRtpCapabilities({sdpObject:T});return p.addNackSuppportForOpus(P),P}catch(w){try{m.close()}catch{}throw w}})}getNativeSctpCapabilities(){return j(this,null,function*(){return E.debug("getNativeSctpCapabilities()"),{numStreams:R}})}run({direction:m,iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L,iceServers:k,iceTransportPolicy:I,additionalSettings:z,proprietaryConstraints:K,extendedRtpCapabilities:$}){E.debug("run()"),this._direction=m,this._remoteSdp=new _.RemoteSdp({iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",$),video:c.getSendingRtpParameters("video",$)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",$),video:c.getSendingRemoteRtpParameters("video",$)},P.role&&P.role!=="auto"&&(this._forcedLocalDtlsRole=P.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:k??[],iceTransportPolicy:I??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},z),K),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(E.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}updateIceServers(m){return j(this,null,function*(){this.assertNotClosed(),E.debug("updateIceServers()");const w=this._pc.getConfiguration();w.iceServers=m,this._pc.setConfiguration(w)})}restartIce(m){return j(this,null,function*(){if(this.assertNotClosed(),E.debug("restartIce()"),this._remoteSdp.updateIceParameters(m),!!this._transportReady)if(this._direction==="send"){const w=yield this._pc.createOffer({iceRestart:!0});E.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)}else{const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)}})}getTransportStats(){return j(this,null,function*(){return this.assertNotClosed(),this._pc.getStats()})}send(m){return j(this,arguments,function*({track:w,encodings:T,codecOptions:P,codec:L}){var k;this.assertNotClosed(),this.assertSendDirection(),E.debug("send() [kind:%s, track.id:%s]",w.kind,w.id),T&&T.length>1&&T.forEach((De,We)=>{De.rid=`r${We}`});const I=o.clone(this._sendingRtpParametersByKind[w.kind]);I.codecs=c.reduceCodecs(I.codecs,L);const z=o.clone(this._sendingRemoteRtpParametersByKind[w.kind]);z.codecs=c.reduceCodecs(z.codecs,L);const K=this._remoteSdp.getNextMediaSectionIdx(),$=this._pc.addTransceiver(w,{direction:"sendonly",streams:[this._sendStream],sendEncodings:T});let te=yield this._pc.createOffer(),ee=r.parse(te.sdp),de;this._transportReady||(yield this.setupTransport({localDtlsRole:(k=this._forcedLocalDtlsRole)!=null?k:"client",localSdpObject:ee}));let X=!1;const le=(0,S.parse)((T??[{}])[0].scalabilityMode);T&&T.length===1&&le.spatialLayers>1&&I.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(E.debug("send() | enabling legacy simulcast for VP9 SVC"),X=!0,ee=r.parse(te.sdp),de=ee.media[K.idx],d.addLegacySimulcast({offerMediaObject:de,numStreams:le.spatialLayers}),te={type:"offer",sdp:r.write(ee)}),E.debug("send() | calling pc.setLocalDescription() [offer:%o]",te),yield this._pc.setLocalDescription(te);const _e=$.mid;if(I.mid=_e,ee=r.parse(this._pc.localDescription.sdp),de=ee.media[K.idx],I.rtcp.cname=h.getCname({offerMediaObject:de}),!T)I.encodings=d.getRtpEncodings({offerMediaObject:de});else if(T.length===1){let De=d.getRtpEncodings({offerMediaObject:de});Object.assign(De[0],T[0]),X&&(De=[De[0]]),I.encodings=De}else I.encodings=T;if(I.encodings.length>1&&(I.codecs[0].mimeType.toLowerCase()==="video/vp8"||I.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const De of I.encodings)De.scalabilityMode?De.scalabilityMode=`L1T${le.temporalLayers}`:De.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:de,reuseMid:K.reuseMid,offerRtpParameters:I,answerRtpParameters:z,codecOptions:P,extmapAllowMixed:!0});const Se={type:"answer",sdp:this._remoteSdp.getSdp()};return E.debug("send() | calling pc.setRemoteDescription() [answer:%o]",Se),yield this._pc.setRemoteDescription(Se),this._mapMidTransceiver.set(_e,$),{localId:_e,rtpParameters:I,rtpSender:$.sender}})}stopSending(m){return j(this,null,function*(){if(this.assertSendDirection(),E.debug("stopSending() [localId:%s]",m),this._closed)return;const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");if(w.sender.replaceTrack(null),this._pc.removeTrack(w.sender),this._remoteSdp.closeMediaSection(w.mid))try{w.stop()}catch{}const P=yield this._pc.createOffer();E.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L),this._mapMidTransceiver.delete(m)})}pauseSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("pauseSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="inactive",this._remoteSdp.pauseMediaSection(m);const T=yield this._pc.createOffer();E.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}resumeSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("resumeSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(this._remoteSdp.resumeSendingMediaSection(m),!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="sendonly";const T=yield this._pc.createOffer();E.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}replaceTrack(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),w?E.debug("replaceTrack() [localId:%s, track.id:%s]",m,w.id):E.debug("replaceTrack() [localId:%s, no track]",m);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");yield T.sender.replaceTrack(w)})}setMaxSpatialLayer(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{z<=w?I.active=!0:I.active=!1}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}setRtpEncodingParameters(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setRtpEncodingParameters() [localId:%s, params:%o]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{P.encodings[z]=ae(ae({},I),w)}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}getSenderStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.sender.getStats()})}sendDataChannel(m){return j(this,arguments,function*({ordered:w,maxPacketLifeTime:T,maxRetransmits:P,label:L,protocol:k}){var I;this.assertNotClosed(),this.assertSendDirection();const z={negotiated:!0,id:this._nextSendSctpStreamId,ordered:w,maxPacketLifeTime:T,maxRetransmits:P,protocol:k};E.debug("sendDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(L,z);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%R.MIS,!this._hasDataChannelMediaSection){const te=yield this._pc.createOffer(),ee=r.parse(te.sdp),de=ee.media.find(le=>le.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(I=this._forcedLocalDtlsRole)!=null?I:"client",localSdpObject:ee})),E.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",te),yield this._pc.setLocalDescription(te),this._remoteSdp.sendSctpAssociation({offerMediaObject:de});const X={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",X),yield this._pc.setRemoteDescription(X),this._hasDataChannelMediaSection=!0}const $={streamId:z.id,ordered:z.ordered,maxPacketLifeTime:z.maxPacketLifeTime,maxRetransmits:z.maxRetransmits};return{dataChannel:K,sctpStreamParameters:$}})}receive(m){return j(this,null,function*(){var w,T;this.assertNotClosed(),this.assertRecvDirection();const P=[],L=new Map;for(const K of m){const{trackId:$,kind:te,rtpParameters:ee,streamId:de}=K;E.debug("receive() [trackId:%s, kind:%s]",$,te);const X=(w=ee.mid)!=null?w:String(this._mapMidTransceiver.size);L.set($,X),this._remoteSdp.receive({mid:X,kind:te,offerRtpParameters:ee,streamId:de??ee.rtcp.cname,trackId:$})}const k={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",k),yield this._pc.setRemoteDescription(k);let I=yield this._pc.createAnswer();const z=r.parse(I.sdp);for(const K of m){const{trackId:$,rtpParameters:te}=K,ee=L.get($),de=z.media.find(X=>String(X.mid)===ee);h.applyCodecParameters({offerRtpParameters:te,answerMediaObject:de})}I={type:"answer",sdp:r.write(z)},this._transportReady||(yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:z})),E.debug("receive() | calling pc.setLocalDescription() [answer:%o]",I),yield this._pc.setLocalDescription(I);for(const K of m){const{trackId:$}=K,te=L.get($),ee=this._pc.getTransceivers().find(de=>de.mid===te);if(ee)this._mapMidTransceiver.set(te,ee),P.push({localId:te,track:ee.receiver.track,rtpReceiver:ee.receiver});else throw new Error("new RTCRtpTransceiver not found")}return P})}stopReceiving(m){return j(this,null,function*(){if(this.assertRecvDirection(),this._closed)return;for(const P of m){E.debug("stopReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(L.mid)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T);for(const P of m)this._mapMidTransceiver.delete(P)})}pauseReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("pauseReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="inactive",this._remoteSdp.pauseMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}resumeReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("resumeReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}getReceiverStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.receiver.getStats()})}receiveDataChannel(m){return j(this,arguments,function*({sctpStreamParameters:w,label:T,protocol:P}){var L;this.assertNotClosed(),this.assertRecvDirection();const{streamId:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K}=w,$={negotiated:!0,id:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K,protocol:P};E.debug("receiveDataChannel() [options:%o]",$);const te=this._pc.createDataChannel(T,$);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const ee={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",ee),yield this._pc.setRemoteDescription(ee);const de=yield this._pc.createAnswer();if(!this._transportReady){const X=r.parse(de.sdp);yield this.setupTransport({localDtlsRole:(L=this._forcedLocalDtlsRole)!=null?L:"client",localSdpObject:X})}E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",de),yield this._pc.setLocalDescription(de),this._hasDataChannelMediaSection=!0}return{dataChannel:te}})}setupTransport(m){return j(this,arguments,function*({localDtlsRole:w,localSdpObject:T}){T||(T=r.parse(this._pc.localDescription.sdp));const P=h.extractDtlsParameters({sdpObject:T});P.role=w,this._remoteSdp.updateDtlsRole(w==="client"?"server":"client"),yield new Promise((L,k)=>{this.safeEmit("@connect",{dtlsParameters:P},L,k)}),this._transportReady=!0})}assertNotClosed(){if(this._closed)throw new v.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Chrome74=N}}),Ib=Fe({"../../node_modules/mediasoup-client/lib/handlers/Chrome70.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(R,N,b,m){m===void 0&&(m=b);var w=Object.getOwnPropertyDescriptor(N,b);(!w||("get"in w?!N.__esModule:w.writable||w.configurable))&&(w={enumerable:!0,get:function(){return N[b]}}),Object.defineProperty(R,m,w)}:function(R,N,b,m){m===void 0&&(m=b),R[m]=N[b]}),i=t&&t.__setModuleDefault||(Object.create?function(R,N){Object.defineProperty(R,"default",{enumerable:!0,value:N})}:function(R,N){R.default=N}),n=t&&t.__importStar||function(R){if(R&&R.__esModule)return R;var N={};if(R!=null)for(var b in R)b!=="default"&&Object.prototype.hasOwnProperty.call(R,b)&&e(N,R,b);return i(N,R),N};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome70=void 0;var r=n(ln()),s=Xi(),o=n(dn()),c=n(jn()),h=n(Tr()),d=n(ca()),p=Zn(),v=Rr(),g=Ps(),_=new s.Logger("Chrome70"),S="Chrome70",E={OS:1024,MIS:1024},M=class Im extends p.HandlerInterface{static createFactory(){return()=>new Im}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return S}close(){if(_.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}getNativeRtpCapabilities(){return j(this,null,function*(){_.debug("getNativeRtpCapabilities()");const N=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{N.addTransceiver("audio"),N.addTransceiver("video");const b=yield N.createOffer();try{N.close()}catch{}const m=r.parse(b.sdp);return h.extractRtpCapabilities({sdpObject:m})}catch(b){try{N.close()}catch{}throw b}})}getNativeSctpCapabilities(){return j(this,null,function*(){return _.debug("getNativeSctpCapabilities()"),{numStreams:E}})}run({direction:N,iceParameters:b,iceCandidates:m,dtlsParameters:w,sctpParameters:T,iceServers:P,iceTransportPolicy:L,additionalSettings:k,proprietaryConstraints:I,extendedRtpCapabilities:z}){_.debug("run()"),this._direction=N,this._remoteSdp=new v.RemoteSdp({iceParameters:b,iceCandidates:m,dtlsParameters:w,sctpParameters:T}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",z),video:c.getSendingRtpParameters("video",z)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",z),video:c.getSendingRemoteRtpParameters("video",z)},w.role&&w.role!=="auto"&&(this._forcedLocalDtlsRole=w.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:P??[],iceTransportPolicy:L??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},k),I),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(_.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(N){return j(this,null,function*(){_.debug("updateIceServers()");const b=this._pc.getConfiguration();b.iceServers=N,this._pc.setConfiguration(b)})}restartIce(N){return j(this,null,function*(){if(_.debug("restartIce()"),this._remoteSdp.updateIceParameters(N),!!this._transportReady)if(this._direction==="send"){const b=yield this._pc.createOffer({iceRestart:!0});_.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",b),yield this._pc.setLocalDescription(b);const m={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",m),yield this._pc.setRemoteDescription(m)}else{const b={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",b),yield this._pc.setRemoteDescription(b);const m=yield this._pc.createAnswer();_.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",m),yield this._pc.setLocalDescription(m)}})}getTransportStats(){return j(this,null,function*(){return this._pc.getStats()})}send(N){return j(this,arguments,function*({track:b,encodings:m,codecOptions:w,codec:T}){var P,L;this.assertSendDirection(),_.debug("send() [kind:%s, track.id:%s]",b.kind,b.id);const k=o.clone(this._sendingRtpParametersByKind[b.kind]);k.codecs=c.reduceCodecs(k.codecs,T);const I=o.clone(this._sendingRemoteRtpParametersByKind[b.kind]);I.codecs=c.reduceCodecs(I.codecs,T);const z=this._remoteSdp.getNextMediaSectionIdx(),K=this._pc.addTransceiver(b,{direction:"sendonly",streams:[this._sendStream]});let $=yield this._pc.createOffer(),te=r.parse($.sdp),ee;this._transportReady||(yield this.setupTransport({localDtlsRole:(P=this._forcedLocalDtlsRole)!=null?P:"client",localSdpObject:te})),m&&m.length>1&&(_.debug("send() | enabling legacy simulcast"),te=r.parse($.sdp),ee=te.media[z.idx],d.addLegacySimulcast({offerMediaObject:ee,numStreams:m.length}),$={type:"offer",sdp:r.write(te)});let de=!1;const X=(0,g.parse)((m??[{}])[0].scalabilityMode);if(m&&m.length===1&&X.spatialLayers>1&&k.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(_.debug("send() | enabling legacy simulcast for VP9 SVC"),de=!0,te=r.parse($.sdp),ee=te.media[z.idx],d.addLegacySimulcast({offerMediaObject:ee,numStreams:X.spatialLayers}),$={type:"offer",sdp:r.write(te)}),_.debug("send() | calling pc.setLocalDescription() [offer:%o]",$),yield this._pc.setLocalDescription($),m){_.debug("send() | applying given encodings");const Se=K.sender.getParameters();for(let De=0;De<((L=Se.encodings)!=null?L:[]).length;++De){const We=Se.encodings[De],Ve=m[De];if(!Ve)break;Se.encodings[De]=Object.assign(We,Ve)}yield K.sender.setParameters(Se)}const le=K.mid;if(k.mid=le,te=r.parse(this._pc.localDescription.sdp),ee=te.media[z.idx],k.rtcp.cname=h.getCname({offerMediaObject:ee}),k.encodings=d.getRtpEncodings({offerMediaObject:ee}),m)for(let Se=0;Se<k.encodings.length;++Se)m[Se]&&Object.assign(k.encodings[Se],m[Se]);if(de&&(k.encodings=[k.encodings[0]]),k.encodings.length>1&&(k.codecs[0].mimeType.toLowerCase()==="video/vp8"||k.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const Se of k.encodings)Se.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:ee,reuseMid:z.reuseMid,offerRtpParameters:k,answerRtpParameters:I,codecOptions:w});const _e={type:"answer",sdp:this._remoteSdp.getSdp()};return _.debug("send() | calling pc.setRemoteDescription() [answer:%o]",_e),yield this._pc.setRemoteDescription(_e),this._mapMidTransceiver.set(le,K),{localId:le,rtpParameters:k,rtpSender:K.sender}})}stopSending(N){return j(this,null,function*(){this.assertSendDirection(),_.debug("stopSending() [localId:%s]",N);const b=this._mapMidTransceiver.get(N);if(!b)throw new Error("associated RTCRtpTransceiver not found");if(b.sender.replaceTrack(null),this._pc.removeTrack(b.sender),this._remoteSdp.closeMediaSection(b.mid))try{b.stop()}catch{}const w=yield this._pc.createOffer();_.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T),this._mapMidTransceiver.delete(N)})}pauseSending(N){return j(this,null,function*(){})}resumeSending(N){return j(this,null,function*(){})}replaceTrack(N,b){return j(this,null,function*(){this.assertSendDirection(),b?_.debug("replaceTrack() [localId:%s, track.id:%s]",N,b.id):_.debug("replaceTrack() [localId:%s, no track]",N);const m=this._mapMidTransceiver.get(N);if(!m)throw new Error("associated RTCRtpTransceiver not found");yield m.sender.replaceTrack(b)})}setMaxSpatialLayer(N,b){return j(this,null,function*(){this.assertSendDirection(),_.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",N,b);const m=this._mapMidTransceiver.get(N);if(!m)throw new Error("associated RTCRtpTransceiver not found");const w=m.sender.getParameters();w.encodings.forEach((L,k)=>{k<=b?L.active=!0:L.active=!1}),yield m.sender.setParameters(w),this._remoteSdp.muxMediaSectionSimulcast(N,w.encodings);const T=yield this._pc.createOffer();_.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}setRtpEncodingParameters(N,b){return j(this,null,function*(){this.assertSendDirection(),_.debug("setRtpEncodingParameters() [localId:%s, params:%o]",N,b);const m=this._mapMidTransceiver.get(N);if(!m)throw new Error("associated RTCRtpTransceiver not found");const w=m.sender.getParameters();w.encodings.forEach((L,k)=>{w.encodings[k]=ae(ae({},L),b)}),yield m.sender.setParameters(w),this._remoteSdp.muxMediaSectionSimulcast(N,w.encodings);const T=yield this._pc.createOffer();_.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}getSenderStats(N){return j(this,null,function*(){this.assertSendDirection();const b=this._mapMidTransceiver.get(N);if(!b)throw new Error("associated RTCRtpTransceiver not found");return b.sender.getStats()})}sendDataChannel(N){return j(this,arguments,function*({ordered:b,maxPacketLifeTime:m,maxRetransmits:w,label:T,protocol:P}){var L;this.assertSendDirection();const k={negotiated:!0,id:this._nextSendSctpStreamId,ordered:b,maxPacketLifeTime:m,maxRetransmitTime:m,maxRetransmits:w,protocol:P};_.debug("sendDataChannel() [options:%o]",k);const I=this._pc.createDataChannel(T,k);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%E.MIS,!this._hasDataChannelMediaSection){const K=yield this._pc.createOffer(),$=r.parse(K.sdp),te=$.media.find(de=>de.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(L=this._forcedLocalDtlsRole)!=null?L:"client",localSdpObject:$})),_.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",K),yield this._pc.setLocalDescription(K),this._remoteSdp.sendSctpAssociation({offerMediaObject:te});const ee={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",ee),yield this._pc.setRemoteDescription(ee),this._hasDataChannelMediaSection=!0}const z={streamId:k.id,ordered:k.ordered,maxPacketLifeTime:k.maxPacketLifeTime,maxRetransmits:k.maxRetransmits};return{dataChannel:I,sctpStreamParameters:z}})}receive(N){return j(this,null,function*(){var b,m;this.assertRecvDirection();const w=[],T=new Map;for(const I of N){const{trackId:z,kind:K,rtpParameters:$,streamId:te}=I;_.debug("receive() [trackId:%s, kind:%s]",z,K);const ee=(b=$.mid)!=null?b:String(this._mapMidTransceiver.size);T.set(z,ee),this._remoteSdp.receive({mid:ee,kind:K,offerRtpParameters:$,streamId:te??$.rtcp.cname,trackId:z})}const P={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",P),yield this._pc.setRemoteDescription(P);let L=yield this._pc.createAnswer();const k=r.parse(L.sdp);for(const I of N){const{trackId:z,rtpParameters:K}=I,$=T.get(z),te=k.media.find(ee=>String(ee.mid)===$);h.applyCodecParameters({offerRtpParameters:K,answerMediaObject:te})}L={type:"answer",sdp:r.write(k)},this._transportReady||(yield this.setupTransport({localDtlsRole:(m=this._forcedLocalDtlsRole)!=null?m:"client",localSdpObject:k})),_.debug("receive() | calling pc.setLocalDescription() [answer:%o]",L),yield this._pc.setLocalDescription(L);for(const I of N){const{trackId:z}=I,K=T.get(z),$=this._pc.getTransceivers().find(te=>te.mid===K);if(!$)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(K,$),w.push({localId:K,track:$.receiver.track,rtpReceiver:$.receiver})}return w})}stopReceiving(N){return j(this,null,function*(){this.assertRecvDirection();for(const w of N){_.debug("stopReceiving() [localId:%s]",w);const T=this._mapMidTransceiver.get(w);if(!T)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(T.mid)}const b={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",b),yield this._pc.setRemoteDescription(b);const m=yield this._pc.createAnswer();_.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",m),yield this._pc.setLocalDescription(m);for(const w of N)this._mapMidTransceiver.delete(w)})}pauseReceiving(N){return j(this,null,function*(){})}resumeReceiving(N){return j(this,null,function*(){})}getReceiverStats(N){return j(this,null,function*(){this.assertRecvDirection();const b=this._mapMidTransceiver.get(N);if(!b)throw new Error("associated RTCRtpTransceiver not found");return b.receiver.getStats()})}receiveDataChannel(N){return j(this,arguments,function*({sctpStreamParameters:b,label:m,protocol:w}){var T;this.assertRecvDirection();const{streamId:P,ordered:L,maxPacketLifeTime:k,maxRetransmits:I}=b,z={negotiated:!0,id:P,ordered:L,maxPacketLifeTime:k,maxRetransmitTime:k,maxRetransmits:I,protocol:w};_.debug("receiveDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(m,z);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const $={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",$),yield this._pc.setRemoteDescription($);const te=yield this._pc.createAnswer();if(!this._transportReady){const ee=r.parse(te.sdp);yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:ee})}_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",te),yield this._pc.setLocalDescription(te),this._hasDataChannelMediaSection=!0}return{dataChannel:K}})}setupTransport(N){return j(this,arguments,function*({localDtlsRole:b,localSdpObject:m}){m||(m=r.parse(this._pc.localDescription.sdp));const w=h.extractDtlsParameters({sdpObject:m});w.role=b,this._remoteSdp.updateDtlsRole(b==="client"?"server":"client"),yield new Promise((T,P)=>{this.safeEmit("@connect",{dtlsParameters:w},T,P)}),this._transportReady=!0})}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Chrome70=M}}),Fl=Fe({"../../node_modules/mediasoup-client/lib/handlers/sdp/planBUtils.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0}),t.getRtpEncodings=e,t.addLegacySimulcast=i;function e({offerMediaObject:n,track:r}){const s=new Set;for(const h of n.ssrcs||[]){if(h.attribute!=="msid")continue;if(h.value.split(" ")[1]===r.id){const p=h.id;s.add(p)}}if(s.size===0)throw new Error(`a=ssrc line with msid information not found [track.id:${r.id}]`);const o=new Map;for(const h of n.ssrcGroups||[]){if(h.semantics!=="FID")continue;let[d,p]=h.ssrcs.split(/\s+/);d=Number(d),p=Number(p),s.has(d)&&(s.delete(d),s.delete(p),o.set(d,p))}for(const h of s)o.set(h,null);const c=[];for(const[h,d]of o){const p={ssrc:h};d&&(p.rtx={ssrc:d}),c.push(p)}return c}function i({offerMediaObject:n,track:r,numStreams:s}){if(s<=1)throw new TypeError("numStreams must be greater than 1");let o,c,h;if(!(n.ssrcs||[]).find(S=>S.attribute!=="msid"?!1:S.value.split(" ")[1]===r.id?(o=S.id,h=S.value.split(" ")[0],!0):!1))throw new Error(`a=ssrc line with msid information not found [track.id:${r.id}]`);(n.ssrcGroups||[]).some(S=>{if(S.semantics!=="FID")return!1;const E=S.ssrcs.split(/\s+/);return Number(E[0])===o?(c=Number(E[1]),!0):!1});const p=n.ssrcs.find(S=>S.attribute==="cname"&&S.id===o);if(!p)throw new Error(`a=ssrc line with cname information not found [track.id:${r.id}]`);const v=p.value,g=[],_=[];for(let S=0;S<s;++S)g.push(o+S),c&&_.push(c+S);n.ssrcGroups=n.ssrcGroups||[],n.ssrcs=n.ssrcs||[],n.ssrcGroups.push({semantics:"SIM",ssrcs:g.join(" ")});for(const S of g)n.ssrcs.push({id:S,attribute:"cname",value:v}),n.ssrcs.push({id:S,attribute:"msid",value:`${h} ${r.id}`});for(let S=0;S<_.length;++S){const E=g[S],M=_[S];n.ssrcs.push({id:M,attribute:"cname",value:v}),n.ssrcs.push({id:M,attribute:"msid",value:`${h} ${r.id}`}),n.ssrcGroups.push({semantics:"FID",ssrcs:`${E} ${M}`})}}}}),Fb=Fe({"../../node_modules/mediasoup-client/lib/handlers/Chrome67.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(M,R,N,b){b===void 0&&(b=N);var m=Object.getOwnPropertyDescriptor(R,N);(!m||("get"in m?!R.__esModule:m.writable||m.configurable))&&(m={enumerable:!0,get:function(){return R[N]}}),Object.defineProperty(M,b,m)}:function(M,R,N,b){b===void 0&&(b=N),M[b]=R[N]}),i=t&&t.__setModuleDefault||(Object.create?function(M,R){Object.defineProperty(M,"default",{enumerable:!0,value:R})}:function(M,R){M.default=R}),n=t&&t.__importStar||function(M){if(M&&M.__esModule)return M;var R={};if(M!=null)for(var N in M)N!=="default"&&Object.prototype.hasOwnProperty.call(M,N)&&e(R,M,N);return i(R,M),R};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome67=void 0;var r=n(ln()),s=Xi(),o=n(dn()),c=n(jn()),h=n(Tr()),d=n(Fl()),p=Zn(),v=Rr(),g=new s.Logger("Chrome67"),_="Chrome67",S={OS:1024,MIS:1024},E=class Fm extends p.HandlerInterface{static createFactory(){return()=>new Fm}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return _}close(){if(g.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}getNativeRtpCapabilities(){return j(this,null,function*(){g.debug("getNativeRtpCapabilities()");const R=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const N=yield R.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{R.close()}catch{}const b=r.parse(N.sdp);return h.extractRtpCapabilities({sdpObject:b})}catch(N){try{R.close()}catch{}throw N}})}getNativeSctpCapabilities(){return j(this,null,function*(){return g.debug("getNativeSctpCapabilities()"),{numStreams:S}})}run({direction:R,iceParameters:N,iceCandidates:b,dtlsParameters:m,sctpParameters:w,iceServers:T,iceTransportPolicy:P,additionalSettings:L,proprietaryConstraints:k,extendedRtpCapabilities:I}){g.debug("run()"),this._direction=R,this._remoteSdp=new v.RemoteSdp({iceParameters:N,iceCandidates:b,dtlsParameters:m,sctpParameters:w,planB:!0}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",I),video:c.getSendingRtpParameters("video",I)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",I),video:c.getSendingRemoteRtpParameters("video",I)},m.role&&m.role!=="auto"&&(this._forcedLocalDtlsRole=m.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:T??[],iceTransportPolicy:P??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},L),k),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(g.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(R){return j(this,null,function*(){g.debug("updateIceServers()");const N=this._pc.getConfiguration();N.iceServers=R,this._pc.setConfiguration(N)})}restartIce(R){return j(this,null,function*(){if(g.debug("restartIce()"),this._remoteSdp.updateIceParameters(R),!!this._transportReady)if(this._direction==="send"){const N=yield this._pc.createOffer({iceRestart:!0});g.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",N),yield this._pc.setLocalDescription(N);const b={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",b),yield this._pc.setRemoteDescription(b)}else{const N={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",N),yield this._pc.setRemoteDescription(N);const b=yield this._pc.createAnswer();g.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",b),yield this._pc.setLocalDescription(b)}})}getTransportStats(){return j(this,null,function*(){return this._pc.getStats()})}send(R){return j(this,arguments,function*({track:N,encodings:b,codecOptions:m,codec:w}){var T;this.assertSendDirection(),g.debug("send() [kind:%s, track.id:%s]",N.kind,N.id),w&&g.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(N),this._pc.addTrack(N,this._sendStream);let P=yield this._pc.createOffer(),L=r.parse(P.sdp),k;const I=o.clone(this._sendingRtpParametersByKind[N.kind]);I.codecs=c.reduceCodecs(I.codecs);const z=o.clone(this._sendingRemoteRtpParametersByKind[N.kind]);if(z.codecs=c.reduceCodecs(z.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:L})),N.kind==="video"&&b&&b.length>1&&(g.debug("send() | enabling simulcast"),L=r.parse(P.sdp),k=L.media.find(ee=>ee.type==="video"),d.addLegacySimulcast({offerMediaObject:k,track:N,numStreams:b.length}),P={type:"offer",sdp:r.write(L)}),g.debug("send() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P),L=r.parse(this._pc.localDescription.sdp),k=L.media.find(ee=>ee.type===N.kind),I.rtcp.cname=h.getCname({offerMediaObject:k}),I.encodings=d.getRtpEncodings({offerMediaObject:k,track:N}),b)for(let ee=0;ee<I.encodings.length;++ee)b[ee]&&Object.assign(I.encodings[ee],b[ee]);if(I.encodings.length>1&&I.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const ee of I.encodings)ee.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:k,offerRtpParameters:I,answerRtpParameters:z,codecOptions:m});const K={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("send() | calling pc.setRemoteDescription() [answer:%o]",K),yield this._pc.setRemoteDescription(K);const $=String(this._nextSendLocalId);this._nextSendLocalId++;const te=this._pc.getSenders().find(ee=>ee.track===N);return this._mapSendLocalIdRtpSender.set($,te),{localId:$,rtpParameters:I,rtpSender:te}})}stopSending(R){return j(this,null,function*(){this.assertSendDirection(),g.debug("stopSending() [localId:%s]",R);const N=this._mapSendLocalIdRtpSender.get(R);if(!N)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(N),N.track&&this._sendStream.removeTrack(N.track),this._mapSendLocalIdRtpSender.delete(R);const b=yield this._pc.createOffer();g.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",b);try{yield this._pc.setLocalDescription(b)}catch(w){if(this._sendStream.getTracks().length===0){g.warn("stopSending() | ignoring expected error due no sending tracks: %s",w.toString());return}throw w}if(this._pc.signalingState==="stable")return;const m={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",m),yield this._pc.setRemoteDescription(m)})}pauseSending(R){return j(this,null,function*(){})}resumeSending(R){return j(this,null,function*(){})}replaceTrack(R,N){return j(this,null,function*(){this.assertSendDirection(),N?g.debug("replaceTrack() [localId:%s, track.id:%s]",R,N.id):g.debug("replaceTrack() [localId:%s, no track]",R);const b=this._mapSendLocalIdRtpSender.get(R);if(!b)throw new Error("associated RTCRtpSender not found");const m=b.track;yield b.replaceTrack(N),m&&this._sendStream.removeTrack(m),N&&this._sendStream.addTrack(N)})}setMaxSpatialLayer(R,N){return j(this,null,function*(){this.assertSendDirection(),g.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",R,N);const b=this._mapSendLocalIdRtpSender.get(R);if(!b)throw new Error("associated RTCRtpSender not found");const m=b.getParameters();m.encodings.forEach((w,T)=>{T<=N?w.active=!0:w.active=!1}),yield b.setParameters(m)})}setRtpEncodingParameters(R,N){return j(this,null,function*(){this.assertSendDirection(),g.debug("setRtpEncodingParameters() [localId:%s, params:%o]",R,N);const b=this._mapSendLocalIdRtpSender.get(R);if(!b)throw new Error("associated RTCRtpSender not found");const m=b.getParameters();m.encodings.forEach((w,T)=>{m.encodings[T]=ae(ae({},w),N)}),yield b.setParameters(m)})}getSenderStats(R){return j(this,null,function*(){this.assertSendDirection();const N=this._mapSendLocalIdRtpSender.get(R);if(!N)throw new Error("associated RTCRtpSender not found");return N.getStats()})}sendDataChannel(R){return j(this,arguments,function*({ordered:N,maxPacketLifeTime:b,maxRetransmits:m,label:w,protocol:T}){var P;this.assertSendDirection();const L={negotiated:!0,id:this._nextSendSctpStreamId,ordered:N,maxPacketLifeTime:b,maxRetransmitTime:b,maxRetransmits:m,protocol:T};g.debug("sendDataChannel() [options:%o]",L);const k=this._pc.createDataChannel(w,L);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%S.MIS,!this._hasDataChannelMediaSection){const z=yield this._pc.createOffer(),K=r.parse(z.sdp),$=K.media.find(ee=>ee.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(P=this._forcedLocalDtlsRole)!=null?P:"client",localSdpObject:K})),g.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",z),yield this._pc.setLocalDescription(z),this._remoteSdp.sendSctpAssociation({offerMediaObject:$});const te={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",te),yield this._pc.setRemoteDescription(te),this._hasDataChannelMediaSection=!0}const I={streamId:L.id,ordered:L.ordered,maxPacketLifeTime:L.maxPacketLifeTime,maxRetransmits:L.maxRetransmits};return{dataChannel:k,sctpStreamParameters:I}})}receive(R){return j(this,null,function*(){var N;this.assertRecvDirection();const b=[];for(const P of R){const{trackId:L,kind:k,rtpParameters:I,streamId:z}=P;g.debug("receive() [trackId:%s, kind:%s]",L,k);const K=k;this._remoteSdp.receive({mid:K,kind:k,offerRtpParameters:I,streamId:z??I.rtcp.cname,trackId:L})}const m={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);let w=yield this._pc.createAnswer();const T=r.parse(w.sdp);for(const P of R){const{kind:L,rtpParameters:k}=P,I=L,z=T.media.find(K=>String(K.mid)===I);h.applyCodecParameters({offerRtpParameters:k,answerMediaObject:z})}w={type:"answer",sdp:r.write(T)},this._transportReady||(yield this.setupTransport({localDtlsRole:(N=this._forcedLocalDtlsRole)!=null?N:"client",localSdpObject:T})),g.debug("receive() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w);for(const P of R){const{kind:L,trackId:k,rtpParameters:I}=P,z=k,K=L,$=this._pc.getReceivers().find(te=>te.track&&te.track.id===z);if(!$)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(z,{mid:K,rtpParameters:I,rtpReceiver:$}),b.push({localId:z,track:$.track,rtpReceiver:$})}return b})}stopReceiving(R){return j(this,null,function*(){var N;this.assertRecvDirection();for(const w of R){g.debug("stopReceiving() [localId:%s]",w);const{mid:T,rtpParameters:P}=(N=this._mapRecvLocalIdInfo.get(w))!=null?N:{};this._mapRecvLocalIdInfo.delete(w),this._remoteSdp.planBStopReceiving({mid:T,offerRtpParameters:P})}const b={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",b),yield this._pc.setRemoteDescription(b);const m=yield this._pc.createAnswer();g.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",m),yield this._pc.setLocalDescription(m)})}pauseReceiving(R){return j(this,null,function*(){})}resumeReceiving(R){return j(this,null,function*(){})}getReceiverStats(R){return j(this,null,function*(){var N;this.assertRecvDirection();const{rtpReceiver:b}=(N=this._mapRecvLocalIdInfo.get(R))!=null?N:{};if(!b)throw new Error("associated RTCRtpReceiver not found");return b.getStats()})}receiveDataChannel(R){return j(this,arguments,function*({sctpStreamParameters:N,label:b,protocol:m}){var w;this.assertRecvDirection();const{streamId:T,ordered:P,maxPacketLifeTime:L,maxRetransmits:k}=N,I={negotiated:!0,id:T,ordered:P,maxPacketLifeTime:L,maxRetransmitTime:L,maxRetransmits:k,protocol:m};g.debug("receiveDataChannel() [options:%o]",I);const z=this._pc.createDataChannel(b,I);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const K={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",K),yield this._pc.setRemoteDescription(K);const $=yield this._pc.createAnswer();if(!this._transportReady){const te=r.parse($.sdp);yield this.setupTransport({localDtlsRole:(w=this._forcedLocalDtlsRole)!=null?w:"client",localSdpObject:te})}g.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",$),yield this._pc.setLocalDescription($),this._hasDataChannelMediaSection=!0}return{dataChannel:z}})}setupTransport(R){return j(this,arguments,function*({localDtlsRole:N,localSdpObject:b}){b||(b=r.parse(this._pc.localDescription.sdp));const m=h.extractDtlsParameters({sdpObject:b});m.role=N,this._remoteSdp.updateDtlsRole(N==="client"?"server":"client"),yield new Promise((w,T)=>{this.safeEmit("@connect",{dtlsParameters:m},w,T)}),this._transportReady=!0})}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Chrome67=E}}),Nb=Fe({"../../node_modules/mediasoup-client/lib/handlers/Chrome55.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(R,N,b,m){m===void 0&&(m=b);var w=Object.getOwnPropertyDescriptor(N,b);(!w||("get"in w?!N.__esModule:w.writable||w.configurable))&&(w={enumerable:!0,get:function(){return N[b]}}),Object.defineProperty(R,m,w)}:function(R,N,b,m){m===void 0&&(m=b),R[m]=N[b]}),i=t&&t.__setModuleDefault||(Object.create?function(R,N){Object.defineProperty(R,"default",{enumerable:!0,value:N})}:function(R,N){R.default=N}),n=t&&t.__importStar||function(R){if(R&&R.__esModule)return R;var N={};if(R!=null)for(var b in R)b!=="default"&&Object.prototype.hasOwnProperty.call(R,b)&&e(N,R,b);return i(N,R),N};Object.defineProperty(t,"__esModule",{value:!0}),t.Chrome55=void 0;var r=n(ln()),s=Xi(),o=Mn(),c=n(dn()),h=n(jn()),d=n(Tr()),p=n(Fl()),v=Zn(),g=Rr(),_=new s.Logger("Chrome55"),S="Chrome55",E={OS:1024,MIS:1024},M=class Nm extends v.HandlerInterface{static createFactory(){return()=>new Nm}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return S}close(){if(_.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}getNativeRtpCapabilities(){return j(this,null,function*(){_.debug("getNativeRtpCapabilities()");const N=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const b=yield N.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{N.close()}catch{}const m=r.parse(b.sdp);return d.extractRtpCapabilities({sdpObject:m})}catch(b){try{N.close()}catch{}throw b}})}getNativeSctpCapabilities(){return j(this,null,function*(){return _.debug("getNativeSctpCapabilities()"),{numStreams:E}})}run({direction:N,iceParameters:b,iceCandidates:m,dtlsParameters:w,sctpParameters:T,iceServers:P,iceTransportPolicy:L,additionalSettings:k,proprietaryConstraints:I,extendedRtpCapabilities:z}){_.debug("run()"),this._direction=N,this._remoteSdp=new g.RemoteSdp({iceParameters:b,iceCandidates:m,dtlsParameters:w,sctpParameters:T,planB:!0}),this._sendingRtpParametersByKind={audio:h.getSendingRtpParameters("audio",z),video:h.getSendingRtpParameters("video",z)},this._sendingRemoteRtpParametersByKind={audio:h.getSendingRemoteRtpParameters("audio",z),video:h.getSendingRemoteRtpParameters("video",z)},w.role&&w.role!=="auto"&&(this._forcedLocalDtlsRole=w.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:P??[],iceTransportPolicy:L??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},k),I),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(_.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(N){return j(this,null,function*(){_.debug("updateIceServers()");const b=this._pc.getConfiguration();b.iceServers=N,this._pc.setConfiguration(b)})}restartIce(N){return j(this,null,function*(){if(_.debug("restartIce()"),this._remoteSdp.updateIceParameters(N),!!this._transportReady)if(this._direction==="send"){const b=yield this._pc.createOffer({iceRestart:!0});_.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",b),yield this._pc.setLocalDescription(b);const m={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",m),yield this._pc.setRemoteDescription(m)}else{const b={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",b),yield this._pc.setRemoteDescription(b);const m=yield this._pc.createAnswer();_.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",m),yield this._pc.setLocalDescription(m)}})}getTransportStats(){return j(this,null,function*(){return this._pc.getStats()})}send(N){return j(this,arguments,function*({track:b,encodings:m,codecOptions:w,codec:T}){var P;this.assertSendDirection(),_.debug("send() [kind:%s, track.id:%s]",b.kind,b.id),T&&_.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(b),this._pc.addStream(this._sendStream);let L=yield this._pc.createOffer(),k=r.parse(L.sdp),I;const z=c.clone(this._sendingRtpParametersByKind[b.kind]);z.codecs=h.reduceCodecs(z.codecs);const K=c.clone(this._sendingRemoteRtpParametersByKind[b.kind]);if(K.codecs=h.reduceCodecs(K.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:(P=this._forcedLocalDtlsRole)!=null?P:"client",localSdpObject:k})),b.kind==="video"&&m&&m.length>1&&(_.debug("send() | enabling simulcast"),k=r.parse(L.sdp),I=k.media.find(ee=>ee.type==="video"),p.addLegacySimulcast({offerMediaObject:I,track:b,numStreams:m.length}),L={type:"offer",sdp:r.write(k)}),_.debug("send() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L),k=r.parse(this._pc.localDescription.sdp),I=k.media.find(ee=>ee.type===b.kind),z.rtcp.cname=d.getCname({offerMediaObject:I}),z.encodings=p.getRtpEncodings({offerMediaObject:I,track:b}),m)for(let ee=0;ee<z.encodings.length;++ee)m[ee]&&Object.assign(z.encodings[ee],m[ee]);if(z.encodings.length>1&&z.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const ee of z.encodings)ee.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:I,offerRtpParameters:z,answerRtpParameters:K,codecOptions:w});const $={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("send() | calling pc.setRemoteDescription() [answer:%o]",$),yield this._pc.setRemoteDescription($);const te=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(te,b),{localId:te,rtpParameters:z}})}stopSending(N){return j(this,null,function*(){this.assertSendDirection(),_.debug("stopSending() [localId:%s]",N);const b=this._mapSendLocalIdTrack.get(N);if(!b)throw new Error("track not found");this._mapSendLocalIdTrack.delete(N),this._sendStream.removeTrack(b),this._pc.addStream(this._sendStream);const m=yield this._pc.createOffer();_.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",m);try{yield this._pc.setLocalDescription(m)}catch(T){if(this._sendStream.getTracks().length===0){_.warn("stopSending() | ignoring expected error due no sending tracks: %s",T.toString());return}throw T}if(this._pc.signalingState==="stable")return;const w={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",w),yield this._pc.setRemoteDescription(w)})}pauseSending(N){return j(this,null,function*(){})}resumeSending(N){return j(this,null,function*(){})}replaceTrack(N,b){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}setMaxSpatialLayer(N,b){return j(this,null,function*(){throw new o.UnsupportedError(" not implemented")})}setRtpEncodingParameters(N,b){return j(this,null,function*(){throw new o.UnsupportedError("not supported")})}getSenderStats(N){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}sendDataChannel(N){return j(this,arguments,function*({ordered:b,maxPacketLifeTime:m,maxRetransmits:w,label:T,protocol:P}){var L;this.assertSendDirection();const k={negotiated:!0,id:this._nextSendSctpStreamId,ordered:b,maxPacketLifeTime:m,maxRetransmitTime:m,maxRetransmits:w,protocol:P};_.debug("sendDataChannel() [options:%o]",k);const I=this._pc.createDataChannel(T,k);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%E.MIS,!this._hasDataChannelMediaSection){const K=yield this._pc.createOffer(),$=r.parse(K.sdp),te=$.media.find(de=>de.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(L=this._forcedLocalDtlsRole)!=null?L:"client",localSdpObject:$})),_.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",K),yield this._pc.setLocalDescription(K),this._remoteSdp.sendSctpAssociation({offerMediaObject:te});const ee={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",ee),yield this._pc.setRemoteDescription(ee),this._hasDataChannelMediaSection=!0}const z={streamId:k.id,ordered:k.ordered,maxPacketLifeTime:k.maxPacketLifeTime,maxRetransmits:k.maxRetransmits};return{dataChannel:I,sctpStreamParameters:z}})}receive(N){return j(this,null,function*(){var b,m;this.assertRecvDirection();const w=[];for(const k of N){const{trackId:I,kind:z,rtpParameters:K,streamId:$}=k;_.debug("receive() [trackId:%s, kind:%s]",I,z);const te=z;this._remoteSdp.receive({mid:te,kind:z,offerRtpParameters:K,streamId:$??K.rtcp.cname,trackId:I})}const T={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",T),yield this._pc.setRemoteDescription(T);let P=yield this._pc.createAnswer();const L=r.parse(P.sdp);for(const k of N){const{kind:I,rtpParameters:z}=k,K=I,$=L.media.find(te=>String(te.mid)===K);d.applyCodecParameters({offerRtpParameters:z,answerMediaObject:$})}P={type:"answer",sdp:r.write(L)},this._transportReady||(yield this.setupTransport({localDtlsRole:(b=this._forcedLocalDtlsRole)!=null?b:"client",localSdpObject:L})),_.debug("receive() | calling pc.setLocalDescription() [answer:%o]",P),yield this._pc.setLocalDescription(P);for(const k of N){const{kind:I,trackId:z,rtpParameters:K}=k,$=I,te=z,ee=(m=k.streamId)!=null?m:K.rtcp.cname,X=this._pc.getRemoteStreams().find(le=>le.id===ee).getTrackById(te);if(!X)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(te,{mid:$,rtpParameters:K}),w.push({localId:te,track:X})}return w})}stopReceiving(N){return j(this,null,function*(){var b;this.assertRecvDirection();for(const T of N){_.debug("stopReceiving() [localId:%s]",T);const{mid:P,rtpParameters:L}=(b=this._mapRecvLocalIdInfo.get(T))!=null?b:{};this._mapRecvLocalIdInfo.delete(T),this._remoteSdp.planBStopReceiving({mid:P,offerRtpParameters:L})}const m={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();_.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)})}pauseReceiving(N){return j(this,null,function*(){})}resumeReceiving(N){return j(this,null,function*(){})}getReceiverStats(N){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}receiveDataChannel(N){return j(this,arguments,function*({sctpStreamParameters:b,label:m,protocol:w}){var T;this.assertRecvDirection();const{streamId:P,ordered:L,maxPacketLifeTime:k,maxRetransmits:I}=b,z={negotiated:!0,id:P,ordered:L,maxPacketLifeTime:k,maxRetransmitTime:k,maxRetransmits:I,protocol:w};_.debug("receiveDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(m,z);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const $={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",$),yield this._pc.setRemoteDescription($);const te=yield this._pc.createAnswer();if(!this._transportReady){const ee=r.parse(te.sdp);yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:ee})}_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",te),yield this._pc.setLocalDescription(te),this._hasDataChannelMediaSection=!0}return{dataChannel:K}})}setupTransport(N){return j(this,arguments,function*({localDtlsRole:b,localSdpObject:m}){m||(m=r.parse(this._pc.localDescription.sdp));const w=d.extractDtlsParameters({sdpObject:m});w.role=b,this._remoteSdp.updateDtlsRole(b==="client"?"server":"client"),yield new Promise((T,P)=>{this.safeEmit("@connect",{dtlsParameters:w},T,P)}),this._transportReady=!0})}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Chrome55=M}}),Lb=Fe({"../../node_modules/mediasoup-client/lib/handlers/Firefox120.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(N,b,m,w){w===void 0&&(w=m);var T=Object.getOwnPropertyDescriptor(b,m);(!T||("get"in T?!b.__esModule:T.writable||T.configurable))&&(T={enumerable:!0,get:function(){return b[m]}}),Object.defineProperty(N,w,T)}:function(N,b,m,w){w===void 0&&(w=m),N[w]=b[m]}),i=t&&t.__setModuleDefault||(Object.create?function(N,b){Object.defineProperty(N,"default",{enumerable:!0,value:b})}:function(N,b){N.default=b}),n=t&&t.__importStar||function(N){if(N&&N.__esModule)return N;var b={};if(N!=null)for(var m in N)m!=="default"&&Object.prototype.hasOwnProperty.call(N,m)&&e(b,N,m);return i(b,N),b};Object.defineProperty(t,"__esModule",{value:!0}),t.Firefox120=void 0;var r=n(ln()),s=Xi(),o=Mn(),c=n(dn()),h=n(jn()),d=n(Tr()),p=n(ca()),v=Zn(),g=Rr(),_=Ps(),S=new s.Logger("Firefox120"),E="Firefox120",M={OS:16,MIS:2048},R=class Lm extends v.HandlerInterface{static createFactory(){return()=>new Lm}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return E}close(){if(S.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}getNativeRtpCapabilities(){return j(this,null,function*(){S.debug("getNativeRtpCapabilities()");const b=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),m=document.createElement("canvas");m.getContext("2d");const T=m.captureStream().getVideoTracks()[0];try{b.addTransceiver("audio",{direction:"sendrecv"}),b.addTransceiver(T,{direction:"sendrecv",sendEncodings:[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}]});const P=yield b.createOffer();try{m.remove()}catch{}try{T.stop()}catch{}try{b.close()}catch{}const L=r.parse(P.sdp);return d.extractRtpCapabilities({sdpObject:L})}catch(P){try{m.remove()}catch{}try{T.stop()}catch{}try{b.close()}catch{}throw P}})}getNativeSctpCapabilities(){return j(this,null,function*(){return S.debug("getNativeSctpCapabilities()"),{numStreams:M}})}run({direction:b,iceParameters:m,iceCandidates:w,dtlsParameters:T,sctpParameters:P,iceServers:L,iceTransportPolicy:k,additionalSettings:I,proprietaryConstraints:z,extendedRtpCapabilities:K}){this.assertNotClosed(),S.debug("run()"),this._direction=b,this._remoteSdp=new g.RemoteSdp({iceParameters:m,iceCandidates:w,dtlsParameters:T,sctpParameters:P}),this._sendingRtpParametersByKind={audio:h.getSendingRtpParameters("audio",K),video:h.getSendingRtpParameters("video",K)},this._sendingRemoteRtpParametersByKind={audio:h.getSendingRemoteRtpParameters("audio",K),video:h.getSendingRemoteRtpParameters("video",K)},this._pc=new RTCPeerConnection(ae({iceServers:L??[],iceTransportPolicy:k??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},I),z),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(S.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(b){return j(this,null,function*(){throw this.assertNotClosed(),new o.UnsupportedError("not supported")})}restartIce(b){return j(this,null,function*(){if(this.assertNotClosed(),S.debug("restartIce()"),this._remoteSdp.updateIceParameters(b),!!this._transportReady)if(this._direction==="send"){const m=yield this._pc.createOffer({iceRestart:!0});S.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",m),yield this._pc.setLocalDescription(m);const w={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",w),yield this._pc.setRemoteDescription(w)}else{const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)}})}getTransportStats(){return j(this,null,function*(){return this.assertNotClosed(),this._pc.getStats()})}send(b){return j(this,arguments,function*({track:m,encodings:w,codecOptions:T,codec:P,onRtpSender:L}){this.assertNotClosed(),this.assertSendDirection(),S.debug("send() [kind:%s, track.id:%s]",m.kind,m.id),w&&w.length>1&&w.forEach((le,_e)=>{le.rid=`r${_e}`});const k=c.clone(this._sendingRtpParametersByKind[m.kind]);k.codecs=h.reduceCodecs(k.codecs,P);const I=c.clone(this._sendingRemoteRtpParametersByKind[m.kind]);I.codecs=h.reduceCodecs(I.codecs,P);const z=this._pc.addTransceiver(m,{direction:"sendonly",streams:[this._sendStream],sendEncodings:w});L&&L(z.sender);const K=yield this._pc.createOffer();let $=r.parse(K.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:$}));const te=(0,_.parse)((w??[{}])[0].scalabilityMode);S.debug("send() | calling pc.setLocalDescription() [offer:%o]",K),yield this._pc.setLocalDescription(K);const ee=z.mid;k.mid=ee,$=r.parse(this._pc.localDescription.sdp);const de=$.media[$.media.length-1];if(k.rtcp.cname=d.getCname({offerMediaObject:de}),!w)k.encodings=p.getRtpEncodings({offerMediaObject:de});else if(w.length===1){const le=p.getRtpEncodings({offerMediaObject:de});Object.assign(le[0],w[0]),k.encodings=le}else k.encodings=w;if(k.encodings.length>1&&(k.codecs[0].mimeType.toLowerCase()==="video/vp8"||k.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const le of k.encodings)le.scalabilityMode?le.scalabilityMode=`L1T${te.temporalLayers}`:le.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:de,offerRtpParameters:k,answerRtpParameters:I,codecOptions:T,extmapAllowMixed:!0});const X={type:"answer",sdp:this._remoteSdp.getSdp()};return S.debug("send() | calling pc.setRemoteDescription() [answer:%o]",X),yield this._pc.setRemoteDescription(X),this._mapMidTransceiver.set(ee,z),{localId:ee,rtpParameters:k,rtpSender:z.sender}})}stopSending(b){return j(this,null,function*(){if(this.assertSendDirection(),S.debug("stopSending() [localId:%s]",b),this._closed)return;const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated transceiver not found");m.sender.replaceTrack(null),this._pc.removeTrack(m.sender),this._remoteSdp.disableMediaSection(m.mid);const w=yield this._pc.createOffer();S.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T),this._mapMidTransceiver.delete(b)})}pauseSending(b){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("pauseSending() [localId:%s]",b);const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");m.direction="inactive",this._remoteSdp.pauseMediaSection(b);const w=yield this._pc.createOffer();S.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)})}resumeSending(b){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("resumeSending() [localId:%s]",b);const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");m.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(b);const w=yield this._pc.createOffer();S.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)})}replaceTrack(b,m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),m?S.debug("replaceTrack() [localId:%s, track.id:%s]",b,m.id):S.debug("replaceTrack() [localId:%s, no track]",b);const w=this._mapMidTransceiver.get(b);if(!w)throw new Error("associated RTCRtpTransceiver not found");yield w.sender.replaceTrack(m)})}setMaxSpatialLayer(b,m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",b,m);const w=this._mapMidTransceiver.get(b);if(!w)throw new Error("associated transceiver not found");const T=w.sender.getParameters();T.encodings.forEach((k,I)=>{I<=m?k.active=!0:k.active=!1}),yield w.sender.setParameters(T),this._remoteSdp.muxMediaSectionSimulcast(b,T.encodings);const P=yield this._pc.createOffer();S.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L)})}setRtpEncodingParameters(b,m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("setRtpEncodingParameters() [localId:%s, params:%o]",b,m);const w=this._mapMidTransceiver.get(b);if(!w)throw new Error("associated RTCRtpTransceiver not found");const T=w.sender.getParameters();T.encodings.forEach((k,I)=>{T.encodings[I]=ae(ae({},k),m)}),yield w.sender.setParameters(T),this._remoteSdp.muxMediaSectionSimulcast(b,T.encodings);const P=yield this._pc.createOffer();S.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L)})}getSenderStats(b){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection();const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");return m.sender.getStats()})}sendDataChannel(b){return j(this,arguments,function*({ordered:m,maxPacketLifeTime:w,maxRetransmits:T,label:P,protocol:L}){this.assertNotClosed(),this.assertSendDirection();const k={negotiated:!0,id:this._nextSendSctpStreamId,ordered:m,maxPacketLifeTime:w,maxRetransmits:T,protocol:L};S.debug("sendDataChannel() [options:%o]",k);const I=this._pc.createDataChannel(P,k);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%M.MIS,!this._hasDataChannelMediaSection){const K=yield this._pc.createOffer(),$=r.parse(K.sdp),te=$.media.find(de=>de.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:$})),S.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",K),yield this._pc.setLocalDescription(K),this._remoteSdp.sendSctpAssociation({offerMediaObject:te});const ee={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",ee),yield this._pc.setRemoteDescription(ee),this._hasDataChannelMediaSection=!0}const z={streamId:k.id,ordered:k.ordered,maxPacketLifeTime:k.maxPacketLifeTime,maxRetransmits:k.maxRetransmits};return{dataChannel:I,sctpStreamParameters:z}})}receive(b){return j(this,null,function*(){var m;this.assertNotClosed(),this.assertRecvDirection();const w=[],T=new Map;for(const I of b){const{trackId:z,kind:K,rtpParameters:$,streamId:te}=I;S.debug("receive() [trackId:%s, kind:%s]",z,K);const ee=(m=$.mid)!=null?m:String(this._mapMidTransceiver.size);T.set(z,ee),this._remoteSdp.receive({mid:ee,kind:K,offerRtpParameters:$,streamId:te??$.rtcp.cname,trackId:z})}const P={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",P),yield this._pc.setRemoteDescription(P);for(const I of b){const{trackId:z,onRtpReceiver:K}=I;if(K){const $=T.get(z),te=this._pc.getTransceivers().find(ee=>ee.mid===$);if(!te)throw new Error("transceiver not found");K(te.receiver)}}let L=yield this._pc.createAnswer();const k=r.parse(L.sdp);for(const I of b){const{trackId:z,rtpParameters:K}=I,$=T.get(z),te=k.media.find(ee=>String(ee.mid)===$);d.applyCodecParameters({offerRtpParameters:K,answerMediaObject:te}),L={type:"answer",sdp:r.write(k)}}this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:k})),S.debug("receive() | calling pc.setLocalDescription() [answer:%o]",L),yield this._pc.setLocalDescription(L);for(const I of b){const{trackId:z}=I,K=T.get(z),$=this._pc.getTransceivers().find(te=>te.mid===K);if(!$)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(K,$),w.push({localId:K,track:$.receiver.track,rtpReceiver:$.receiver})}return w})}stopReceiving(b){return j(this,null,function*(){if(this.assertRecvDirection(),this._closed)return;for(const T of b){S.debug("stopReceiving() [localId:%s]",T);const P=this._mapMidTransceiver.get(T);if(!P)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(P.mid)}const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w);for(const T of b)this._mapMidTransceiver.delete(T)})}pauseReceiving(b){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const T of b){S.debug("pauseReceiving() [localId:%s]",T);const P=this._mapMidTransceiver.get(T);if(!P)throw new Error("associated RTCRtpTransceiver not found");P.direction="inactive",this._remoteSdp.pauseMediaSection(T)}const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)})}resumeReceiving(b){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const T of b){S.debug("resumeReceiving() [localId:%s]",T);const P=this._mapMidTransceiver.get(T);if(!P)throw new Error("associated RTCRtpTransceiver not found");P.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(T)}const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)})}getReceiverStats(b){return j(this,null,function*(){this.assertRecvDirection();const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");return m.receiver.getStats()})}receiveDataChannel(b){return j(this,arguments,function*({sctpStreamParameters:m,label:w,protocol:T}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:P,ordered:L,maxPacketLifeTime:k,maxRetransmits:I}=m,z={negotiated:!0,id:P,ordered:L,maxPacketLifeTime:k,maxRetransmits:I,protocol:T};S.debug("receiveDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(w,z);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const $={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",$),yield this._pc.setRemoteDescription($);const te=yield this._pc.createAnswer();if(!this._transportReady){const ee=r.parse(te.sdp);yield this.setupTransport({localDtlsRole:"client",localSdpObject:ee})}S.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",te),yield this._pc.setLocalDescription(te),this._hasDataChannelMediaSection=!0}return{dataChannel:K}})}setupTransport(b){return j(this,arguments,function*({localDtlsRole:m,localSdpObject:w}){w||(w=r.parse(this._pc.localDescription.sdp));const T=d.extractDtlsParameters({sdpObject:w});T.role=m,this._remoteSdp.updateDtlsRole(m==="client"?"server":"client"),yield new Promise((P,L)=>{this.safeEmit("@connect",{dtlsParameters:T},P,L)}),this._transportReady=!0})}assertNotClosed(){if(this._closed)throw new o.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Firefox120=R}}),Ob=Fe({"../../node_modules/mediasoup-client/lib/handlers/Firefox60.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(N,b,m,w){w===void 0&&(w=m);var T=Object.getOwnPropertyDescriptor(b,m);(!T||("get"in T?!b.__esModule:T.writable||T.configurable))&&(T={enumerable:!0,get:function(){return b[m]}}),Object.defineProperty(N,w,T)}:function(N,b,m,w){w===void 0&&(w=m),N[w]=b[m]}),i=t&&t.__setModuleDefault||(Object.create?function(N,b){Object.defineProperty(N,"default",{enumerable:!0,value:b})}:function(N,b){N.default=b}),n=t&&t.__importStar||function(N){if(N&&N.__esModule)return N;var b={};if(N!=null)for(var m in N)m!=="default"&&Object.prototype.hasOwnProperty.call(N,m)&&e(b,N,m);return i(b,N),b};Object.defineProperty(t,"__esModule",{value:!0}),t.Firefox60=void 0;var r=n(ln()),s=Xi(),o=Mn(),c=n(dn()),h=n(jn()),d=n(Tr()),p=n(ca()),v=Zn(),g=Rr(),_=Ps(),S=new s.Logger("Firefox60"),E="Firefox60",M={OS:16,MIS:2048},R=class Om extends v.HandlerInterface{static createFactory(){return()=>new Om}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return E}close(){if(S.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}getNativeRtpCapabilities(){return j(this,null,function*(){S.debug("getNativeRtpCapabilities()");const b=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),m=document.createElement("canvas");m.getContext("2d");const T=m.captureStream().getVideoTracks()[0];try{b.addTransceiver("audio",{direction:"sendrecv"});const P=b.addTransceiver(T,{direction:"sendrecv"}),L=P.sender.getParameters(),k=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];L.encodings=k,yield P.sender.setParameters(L);const I=yield b.createOffer();try{m.remove()}catch{}try{T.stop()}catch{}try{b.close()}catch{}const z=r.parse(I.sdp);return d.extractRtpCapabilities({sdpObject:z})}catch(P){try{m.remove()}catch{}try{T.stop()}catch{}try{b.close()}catch{}throw P}})}getNativeSctpCapabilities(){return j(this,null,function*(){return S.debug("getNativeSctpCapabilities()"),{numStreams:M}})}run({direction:b,iceParameters:m,iceCandidates:w,dtlsParameters:T,sctpParameters:P,iceServers:L,iceTransportPolicy:k,additionalSettings:I,proprietaryConstraints:z,extendedRtpCapabilities:K}){this.assertNotClosed(),S.debug("run()"),this._direction=b,this._remoteSdp=new g.RemoteSdp({iceParameters:m,iceCandidates:w,dtlsParameters:T,sctpParameters:P}),this._sendingRtpParametersByKind={audio:h.getSendingRtpParameters("audio",K),video:h.getSendingRtpParameters("video",K)},this._sendingRemoteRtpParametersByKind={audio:h.getSendingRemoteRtpParameters("audio",K),video:h.getSendingRemoteRtpParameters("video",K)},this._pc=new RTCPeerConnection(ae({iceServers:L??[],iceTransportPolicy:k??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},I),z),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(S.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(b){return j(this,null,function*(){throw this.assertNotClosed(),new o.UnsupportedError("not supported")})}restartIce(b){return j(this,null,function*(){if(this.assertNotClosed(),S.debug("restartIce()"),this._remoteSdp.updateIceParameters(b),!!this._transportReady)if(this._direction==="send"){const m=yield this._pc.createOffer({iceRestart:!0});S.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",m),yield this._pc.setLocalDescription(m);const w={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",w),yield this._pc.setRemoteDescription(w)}else{const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)}})}getTransportStats(){return j(this,null,function*(){return this.assertNotClosed(),this._pc.getStats()})}send(b){return j(this,arguments,function*({track:m,encodings:w,codecOptions:T,codec:P}){this.assertNotClosed(),this.assertSendDirection(),S.debug("send() [kind:%s, track.id:%s]",m.kind,m.id),w&&(w=c.clone(w),w.forEach((X,le)=>{X.rid=`r${le}`}),w.reverse());const L=c.clone(this._sendingRtpParametersByKind[m.kind]);L.codecs=h.reduceCodecs(L.codecs,P);const k=c.clone(this._sendingRemoteRtpParametersByKind[m.kind]);k.codecs=h.reduceCodecs(k.codecs,P);const I=this._pc.addTransceiver(m,{direction:"sendonly",streams:[this._sendStream]});if(w){const X=I.sender.getParameters();X.encodings=w,yield I.sender.setParameters(X)}const z=yield this._pc.createOffer();let K=r.parse(z.sdp);this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:K}));const $=(0,_.parse)((w??[{}])[0].scalabilityMode);S.debug("send() | calling pc.setLocalDescription() [offer:%o]",z),yield this._pc.setLocalDescription(z);const te=I.mid;L.mid=te,K=r.parse(this._pc.localDescription.sdp);const ee=K.media[K.media.length-1];if(L.rtcp.cname=d.getCname({offerMediaObject:ee}),!w)L.encodings=p.getRtpEncodings({offerMediaObject:ee});else if(w.length===1){const X=p.getRtpEncodings({offerMediaObject:ee});Object.assign(X[0],w[0]),L.encodings=X}else L.encodings=w.reverse();if(L.encodings.length>1&&(L.codecs[0].mimeType.toLowerCase()==="video/vp8"||L.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const X of L.encodings)X.scalabilityMode?X.scalabilityMode=`L1T${$.temporalLayers}`:X.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:ee,offerRtpParameters:L,answerRtpParameters:k,codecOptions:T,extmapAllowMixed:!0});const de={type:"answer",sdp:this._remoteSdp.getSdp()};return S.debug("send() | calling pc.setRemoteDescription() [answer:%o]",de),yield this._pc.setRemoteDescription(de),this._mapMidTransceiver.set(te,I),{localId:te,rtpParameters:L,rtpSender:I.sender}})}stopSending(b){return j(this,null,function*(){if(this.assertSendDirection(),S.debug("stopSending() [localId:%s]",b),this._closed)return;const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated transceiver not found");m.sender.replaceTrack(null),this._pc.removeTrack(m.sender),this._remoteSdp.disableMediaSection(m.mid);const w=yield this._pc.createOffer();S.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T),this._mapMidTransceiver.delete(b)})}pauseSending(b){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("pauseSending() [localId:%s]",b);const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");m.direction="inactive",this._remoteSdp.pauseMediaSection(b);const w=yield this._pc.createOffer();S.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)})}resumeSending(b){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("resumeSending() [localId:%s]",b);const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");m.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(b);const w=yield this._pc.createOffer();S.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)})}replaceTrack(b,m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),m?S.debug("replaceTrack() [localId:%s, track.id:%s]",b,m.id):S.debug("replaceTrack() [localId:%s, no track]",b);const w=this._mapMidTransceiver.get(b);if(!w)throw new Error("associated RTCRtpTransceiver not found");yield w.sender.replaceTrack(m)})}setMaxSpatialLayer(b,m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",b,m);const w=this._mapMidTransceiver.get(b);if(!w)throw new Error("associated transceiver not found");const T=w.sender.getParameters();m=T.encodings.length-1-m,T.encodings.forEach((k,I)=>{I>=m?k.active=!0:k.active=!1}),yield w.sender.setParameters(T),this._remoteSdp.muxMediaSectionSimulcast(b,T.encodings);const P=yield this._pc.createOffer();S.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L)})}setRtpEncodingParameters(b,m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),S.debug("setRtpEncodingParameters() [localId:%s, params:%o]",b,m);const w=this._mapMidTransceiver.get(b);if(!w)throw new Error("associated RTCRtpTransceiver not found");const T=w.sender.getParameters();T.encodings.forEach((k,I)=>{T.encodings[I]=ae(ae({},k),m)}),yield w.sender.setParameters(T),this._remoteSdp.muxMediaSectionSimulcast(b,T.encodings);const P=yield this._pc.createOffer();S.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L)})}getSenderStats(b){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection();const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");return m.sender.getStats()})}sendDataChannel(b){return j(this,arguments,function*({ordered:m,maxPacketLifeTime:w,maxRetransmits:T,label:P,protocol:L}){this.assertNotClosed(),this.assertSendDirection();const k={negotiated:!0,id:this._nextSendSctpStreamId,ordered:m,maxPacketLifeTime:w,maxRetransmits:T,protocol:L};S.debug("sendDataChannel() [options:%o]",k);const I=this._pc.createDataChannel(P,k);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%M.MIS,!this._hasDataChannelMediaSection){const K=yield this._pc.createOffer(),$=r.parse(K.sdp),te=$.media.find(de=>de.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:$})),S.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",K),yield this._pc.setLocalDescription(K),this._remoteSdp.sendSctpAssociation({offerMediaObject:te});const ee={type:"answer",sdp:this._remoteSdp.getSdp()};S.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",ee),yield this._pc.setRemoteDescription(ee),this._hasDataChannelMediaSection=!0}const z={streamId:k.id,ordered:k.ordered,maxPacketLifeTime:k.maxPacketLifeTime,maxRetransmits:k.maxRetransmits};return{dataChannel:I,sctpStreamParameters:z}})}receive(b){return j(this,null,function*(){var m;this.assertNotClosed(),this.assertRecvDirection();const w=[],T=new Map;for(const I of b){const{trackId:z,kind:K,rtpParameters:$,streamId:te}=I;S.debug("receive() [trackId:%s, kind:%s]",z,K);const ee=(m=$.mid)!=null?m:String(this._mapMidTransceiver.size);T.set(z,ee),this._remoteSdp.receive({mid:ee,kind:K,offerRtpParameters:$,streamId:te??$.rtcp.cname,trackId:z})}const P={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",P),yield this._pc.setRemoteDescription(P);let L=yield this._pc.createAnswer();const k=r.parse(L.sdp);for(const I of b){const{trackId:z,rtpParameters:K}=I,$=T.get(z),te=k.media.find(ee=>String(ee.mid)===$);d.applyCodecParameters({offerRtpParameters:K,answerMediaObject:te}),L={type:"answer",sdp:r.write(k)}}this._transportReady||(yield this.setupTransport({localDtlsRole:"client",localSdpObject:k})),S.debug("receive() | calling pc.setLocalDescription() [answer:%o]",L),yield this._pc.setLocalDescription(L);for(const I of b){const{trackId:z}=I,K=T.get(z),$=this._pc.getTransceivers().find(te=>te.mid===K);if(!$)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(K,$),w.push({localId:K,track:$.receiver.track,rtpReceiver:$.receiver})}return w})}stopReceiving(b){return j(this,null,function*(){if(this.assertRecvDirection(),this._closed)return;for(const T of b){S.debug("stopReceiving() [localId:%s]",T);const P=this._mapMidTransceiver.get(T);if(!P)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(P.mid)}const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w);for(const T of b)this._mapMidTransceiver.delete(T)})}pauseReceiving(b){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const T of b){S.debug("pauseReceiving() [localId:%s]",T);const P=this._mapMidTransceiver.get(T);if(!P)throw new Error("associated RTCRtpTransceiver not found");P.direction="inactive",this._remoteSdp.pauseMediaSection(T)}const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)})}resumeReceiving(b){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const T of b){S.debug("resumeReceiving() [localId:%s]",T);const P=this._mapMidTransceiver.get(T);if(!P)throw new Error("associated RTCRtpTransceiver not found");P.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(T)}const m={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();S.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)})}getReceiverStats(b){return j(this,null,function*(){this.assertRecvDirection();const m=this._mapMidTransceiver.get(b);if(!m)throw new Error("associated RTCRtpTransceiver not found");return m.receiver.getStats()})}receiveDataChannel(b){return j(this,arguments,function*({sctpStreamParameters:m,label:w,protocol:T}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:P,ordered:L,maxPacketLifeTime:k,maxRetransmits:I}=m,z={negotiated:!0,id:P,ordered:L,maxPacketLifeTime:k,maxRetransmits:I,protocol:T};S.debug("receiveDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(w,z);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const $={type:"offer",sdp:this._remoteSdp.getSdp()};S.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",$),yield this._pc.setRemoteDescription($);const te=yield this._pc.createAnswer();if(!this._transportReady){const ee=r.parse(te.sdp);yield this.setupTransport({localDtlsRole:"client",localSdpObject:ee})}S.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",te),yield this._pc.setLocalDescription(te),this._hasDataChannelMediaSection=!0}return{dataChannel:K}})}setupTransport(b){return j(this,arguments,function*({localDtlsRole:m,localSdpObject:w}){w||(w=r.parse(this._pc.localDescription.sdp));const T=d.extractDtlsParameters({sdpObject:w});T.role=m,this._remoteSdp.updateDtlsRole(m==="client"?"server":"client"),yield new Promise((P,L)=>{this.safeEmit("@connect",{dtlsParameters:T},P,L)}),this._transportReady=!0})}assertNotClosed(){if(this._closed)throw new o.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Firefox60=R}}),kb=Fe({"../../node_modules/mediasoup-client/lib/handlers/Safari12.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(b,m,w,T){T===void 0&&(T=w);var P=Object.getOwnPropertyDescriptor(m,w);(!P||("get"in P?!m.__esModule:P.writable||P.configurable))&&(P={enumerable:!0,get:function(){return m[w]}}),Object.defineProperty(b,T,P)}:function(b,m,w,T){T===void 0&&(T=w),b[T]=m[w]}),i=t&&t.__setModuleDefault||(Object.create?function(b,m){Object.defineProperty(b,"default",{enumerable:!0,value:m})}:function(b,m){b.default=m}),n=t&&t.__importStar||function(b){if(b&&b.__esModule)return b;var m={};if(b!=null)for(var w in b)w!=="default"&&Object.prototype.hasOwnProperty.call(b,w)&&e(m,b,w);return i(m,b),m};Object.defineProperty(t,"__esModule",{value:!0}),t.Safari12=void 0;var r=n(ln()),s=Xi(),o=n(dn()),c=n(jn()),h=n(Tr()),d=n(ca()),p=n(Il()),v=Mn(),g=Zn(),_=Rr(),S=Ps(),E=new s.Logger("Safari12"),M="Safari12",R={OS:1024,MIS:1024},N=class km extends g.HandlerInterface{static createFactory(){return()=>new km}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return M}close(){if(E.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}getNativeRtpCapabilities(){return j(this,null,function*(){E.debug("getNativeRtpCapabilities()");const m=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{m.addTransceiver("audio"),m.addTransceiver("video");const w=yield m.createOffer();try{m.close()}catch{}const T=r.parse(w.sdp),P=h.extractRtpCapabilities({sdpObject:T});return p.addNackSuppportForOpus(P),P}catch(w){try{m.close()}catch{}throw w}})}getNativeSctpCapabilities(){return j(this,null,function*(){return E.debug("getNativeSctpCapabilities()"),{numStreams:R}})}run({direction:m,iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L,iceServers:k,iceTransportPolicy:I,additionalSettings:z,proprietaryConstraints:K,extendedRtpCapabilities:$}){this.assertNotClosed(),E.debug("run()"),this._direction=m,this._remoteSdp=new _.RemoteSdp({iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",$),video:c.getSendingRtpParameters("video",$)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",$),video:c.getSendingRemoteRtpParameters("video",$)},P.role&&P.role!=="auto"&&(this._forcedLocalDtlsRole=P.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:k??[],iceTransportPolicy:I??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},z),K),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(E.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(m){return j(this,null,function*(){this.assertNotClosed(),E.debug("updateIceServers()");const w=this._pc.getConfiguration();w.iceServers=m,this._pc.setConfiguration(w)})}restartIce(m){return j(this,null,function*(){if(this.assertNotClosed(),E.debug("restartIce()"),this._remoteSdp.updateIceParameters(m),!!this._transportReady)if(this._direction==="send"){const w=yield this._pc.createOffer({iceRestart:!0});E.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)}else{const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)}})}getTransportStats(){return j(this,null,function*(){return this.assertNotClosed(),this._pc.getStats()})}send(m){return j(this,arguments,function*({track:w,encodings:T,codecOptions:P,codec:L,onRtpSender:k}){var I;this.assertNotClosed(),this.assertSendDirection(),E.debug("send() [kind:%s, track.id:%s]",w.kind,w.id);const z=o.clone(this._sendingRtpParametersByKind[w.kind]);z.codecs=c.reduceCodecs(z.codecs,L);const K=o.clone(this._sendingRemoteRtpParametersByKind[w.kind]);K.codecs=c.reduceCodecs(K.codecs,L);const $=this._remoteSdp.getNextMediaSectionIdx(),te=this._pc.addTransceiver(w,{direction:"sendonly",streams:[this._sendStream]});k&&k(te.sender);let ee=yield this._pc.createOffer(),de=r.parse(ee.sdp),X;this._transportReady||(yield this.setupTransport({localDtlsRole:(I=this._forcedLocalDtlsRole)!=null?I:"client",localSdpObject:de}));const le=(0,S.parse)((T??[{}])[0].scalabilityMode);T&&T.length>1&&(E.debug("send() | enabling legacy simulcast"),de=r.parse(ee.sdp),X=de.media[$.idx],d.addLegacySimulcast({offerMediaObject:X,numStreams:T.length}),ee={type:"offer",sdp:r.write(de)}),E.debug("send() | calling pc.setLocalDescription() [offer:%o]",ee),yield this._pc.setLocalDescription(ee);const _e=te.mid;if(z.mid=_e,de=r.parse(this._pc.localDescription.sdp),X=de.media[$.idx],z.rtcp.cname=h.getCname({offerMediaObject:X}),z.encodings=d.getRtpEncodings({offerMediaObject:X}),T)for(let De=0;De<z.encodings.length;++De)T[De]&&Object.assign(z.encodings[De],T[De]);if(z.encodings.length>1&&(z.codecs[0].mimeType.toLowerCase()==="video/vp8"||z.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const De of z.encodings)De.scalabilityMode?De.scalabilityMode=`L1T${le.temporalLayers}`:De.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:X,reuseMid:$.reuseMid,offerRtpParameters:z,answerRtpParameters:K,codecOptions:P});const Se={type:"answer",sdp:this._remoteSdp.getSdp()};return E.debug("send() | calling pc.setRemoteDescription() [answer:%o]",Se),yield this._pc.setRemoteDescription(Se),this._mapMidTransceiver.set(_e,te),{localId:_e,rtpParameters:z,rtpSender:te.sender}})}stopSending(m){return j(this,null,function*(){if(this.assertSendDirection(),this._closed)return;E.debug("stopSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");if(w.sender.replaceTrack(null),this._pc.removeTrack(w.sender),this._remoteSdp.closeMediaSection(w.mid))try{w.stop()}catch{}const P=yield this._pc.createOffer();E.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L),this._mapMidTransceiver.delete(m)})}pauseSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("pauseSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="inactive",this._remoteSdp.pauseMediaSection(m);const T=yield this._pc.createOffer();E.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}resumeSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("resumeSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(m);const T=yield this._pc.createOffer();E.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}replaceTrack(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),w?E.debug("replaceTrack() [localId:%s, track.id:%s]",m,w.id):E.debug("replaceTrack() [localId:%s, no track]",m);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");yield T.sender.replaceTrack(w)})}setMaxSpatialLayer(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{z<=w?I.active=!0:I.active=!1}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}setRtpEncodingParameters(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setRtpEncodingParameters() [localId:%s, params:%o]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{P.encodings[z]=ae(ae({},I),w)}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}getSenderStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.sender.getStats()})}sendDataChannel(m){return j(this,arguments,function*({ordered:w,maxPacketLifeTime:T,maxRetransmits:P,label:L,protocol:k}){var I;this.assertNotClosed(),this.assertSendDirection();const z={negotiated:!0,id:this._nextSendSctpStreamId,ordered:w,maxPacketLifeTime:T,maxRetransmits:P,protocol:k};E.debug("sendDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(L,z);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%R.MIS,!this._hasDataChannelMediaSection){const te=yield this._pc.createOffer(),ee=r.parse(te.sdp),de=ee.media.find(le=>le.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(I=this._forcedLocalDtlsRole)!=null?I:"client",localSdpObject:ee})),E.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",te),yield this._pc.setLocalDescription(te),this._remoteSdp.sendSctpAssociation({offerMediaObject:de});const X={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",X),yield this._pc.setRemoteDescription(X),this._hasDataChannelMediaSection=!0}const $={streamId:z.id,ordered:z.ordered,maxPacketLifeTime:z.maxPacketLifeTime,maxRetransmits:z.maxRetransmits};return{dataChannel:K,sctpStreamParameters:$}})}receive(m){return j(this,null,function*(){var w,T;this.assertNotClosed(),this.assertRecvDirection();const P=[],L=new Map;for(const K of m){const{trackId:$,kind:te,rtpParameters:ee,streamId:de}=K;E.debug("receive() [trackId:%s, kind:%s]",$,te);const X=(w=ee.mid)!=null?w:String(this._mapMidTransceiver.size);L.set($,X),this._remoteSdp.receive({mid:X,kind:te,offerRtpParameters:ee,streamId:de??ee.rtcp.cname,trackId:$})}const k={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",k),yield this._pc.setRemoteDescription(k);for(const K of m){const{trackId:$,onRtpReceiver:te}=K;if(te){const ee=L.get($),de=this._pc.getTransceivers().find(X=>X.mid===ee);if(!de)throw new Error("transceiver not found");te(de.receiver)}}let I=yield this._pc.createAnswer();const z=r.parse(I.sdp);for(const K of m){const{trackId:$,rtpParameters:te}=K,ee=L.get($),de=z.media.find(X=>String(X.mid)===ee);h.applyCodecParameters({offerRtpParameters:te,answerMediaObject:de})}I={type:"answer",sdp:r.write(z)},this._transportReady||(yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:z})),E.debug("receive() | calling pc.setLocalDescription() [answer:%o]",I),yield this._pc.setLocalDescription(I);for(const K of m){const{trackId:$}=K,te=L.get($),ee=this._pc.getTransceivers().find(de=>de.mid===te);if(!ee)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(te,ee),P.push({localId:te,track:ee.receiver.track,rtpReceiver:ee.receiver})}return P})}stopReceiving(m){return j(this,null,function*(){if(this.assertRecvDirection(),this._closed)return;for(const P of m){E.debug("stopReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(L.mid)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T);for(const P of m)this._mapMidTransceiver.delete(P)})}pauseReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("pauseReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="inactive",this._remoteSdp.pauseMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}resumeReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("resumeReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}getReceiverStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.receiver.getStats()})}receiveDataChannel(m){return j(this,arguments,function*({sctpStreamParameters:w,label:T,protocol:P}){var L;this.assertNotClosed(),this.assertRecvDirection();const{streamId:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K}=w,$={negotiated:!0,id:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K,protocol:P};E.debug("receiveDataChannel() [options:%o]",$);const te=this._pc.createDataChannel(T,$);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const ee={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",ee),yield this._pc.setRemoteDescription(ee);const de=yield this._pc.createAnswer();if(!this._transportReady){const X=r.parse(de.sdp);yield this.setupTransport({localDtlsRole:(L=this._forcedLocalDtlsRole)!=null?L:"client",localSdpObject:X})}E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",de),yield this._pc.setLocalDescription(de),this._hasDataChannelMediaSection=!0}return{dataChannel:te}})}setupTransport(m){return j(this,arguments,function*({localDtlsRole:w,localSdpObject:T}){T||(T=r.parse(this._pc.localDescription.sdp));const P=h.extractDtlsParameters({sdpObject:T});P.role=w,this._remoteSdp.updateDtlsRole(w==="client"?"server":"client"),yield new Promise((L,k)=>{this.safeEmit("@connect",{dtlsParameters:P},L,k)}),this._transportReady=!0})}assertNotClosed(){if(this._closed)throw new v.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Safari12=N}}),Ub=Fe({"../../node_modules/mediasoup-client/lib/handlers/Safari11.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(M,R,N,b){b===void 0&&(b=N);var m=Object.getOwnPropertyDescriptor(R,N);(!m||("get"in m?!R.__esModule:m.writable||m.configurable))&&(m={enumerable:!0,get:function(){return R[N]}}),Object.defineProperty(M,b,m)}:function(M,R,N,b){b===void 0&&(b=N),M[b]=R[N]}),i=t&&t.__setModuleDefault||(Object.create?function(M,R){Object.defineProperty(M,"default",{enumerable:!0,value:R})}:function(M,R){M.default=R}),n=t&&t.__importStar||function(M){if(M&&M.__esModule)return M;var R={};if(M!=null)for(var N in M)N!=="default"&&Object.prototype.hasOwnProperty.call(M,N)&&e(R,M,N);return i(R,M),R};Object.defineProperty(t,"__esModule",{value:!0}),t.Safari11=void 0;var r=n(ln()),s=Xi(),o=n(dn()),c=n(jn()),h=n(Tr()),d=n(Fl()),p=Zn(),v=Rr(),g=new s.Logger("Safari11"),_="Safari11",S={OS:1024,MIS:1024},E=class Um extends p.HandlerInterface{static createFactory(){return()=>new Um}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return _}close(){if(g.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}getNativeRtpCapabilities(){return j(this,null,function*(){g.debug("getNativeRtpCapabilities()");const R=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const N=yield R.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{R.close()}catch{}const b=r.parse(N.sdp);return h.extractRtpCapabilities({sdpObject:b})}catch(N){try{R.close()}catch{}throw N}})}getNativeSctpCapabilities(){return j(this,null,function*(){return g.debug("getNativeSctpCapabilities()"),{numStreams:S}})}run({direction:R,iceParameters:N,iceCandidates:b,dtlsParameters:m,sctpParameters:w,iceServers:T,iceTransportPolicy:P,additionalSettings:L,proprietaryConstraints:k,extendedRtpCapabilities:I}){g.debug("run()"),this._direction=R,this._remoteSdp=new v.RemoteSdp({iceParameters:N,iceCandidates:b,dtlsParameters:m,sctpParameters:w,planB:!0}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",I),video:c.getSendingRtpParameters("video",I)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",I),video:c.getSendingRemoteRtpParameters("video",I)},m.role&&m.role!=="auto"&&(this._forcedLocalDtlsRole=m.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:T??[],iceTransportPolicy:P??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"},L),k),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(g.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(R){return j(this,null,function*(){g.debug("updateIceServers()");const N=this._pc.getConfiguration();N.iceServers=R,this._pc.setConfiguration(N)})}restartIce(R){return j(this,null,function*(){if(g.debug("restartIce()"),this._remoteSdp.updateIceParameters(R),!!this._transportReady)if(this._direction==="send"){const N=yield this._pc.createOffer({iceRestart:!0});g.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",N),yield this._pc.setLocalDescription(N);const b={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",b),yield this._pc.setRemoteDescription(b)}else{const N={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",N),yield this._pc.setRemoteDescription(N);const b=yield this._pc.createAnswer();g.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",b),yield this._pc.setLocalDescription(b)}})}getTransportStats(){return j(this,null,function*(){return this._pc.getStats()})}send(R){return j(this,arguments,function*({track:N,encodings:b,codecOptions:m,codec:w}){var T;this.assertSendDirection(),g.debug("send() [kind:%s, track.id:%s]",N.kind,N.id),w&&g.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(N),this._pc.addTrack(N,this._sendStream);let P=yield this._pc.createOffer(),L=r.parse(P.sdp),k;const I=o.clone(this._sendingRtpParametersByKind[N.kind]);I.codecs=c.reduceCodecs(I.codecs);const z=o.clone(this._sendingRemoteRtpParametersByKind[N.kind]);if(z.codecs=c.reduceCodecs(z.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:L})),N.kind==="video"&&b&&b.length>1&&(g.debug("send() | enabling simulcast"),L=r.parse(P.sdp),k=L.media.find(ee=>ee.type==="video"),d.addLegacySimulcast({offerMediaObject:k,track:N,numStreams:b.length}),P={type:"offer",sdp:r.write(L)}),g.debug("send() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P),L=r.parse(this._pc.localDescription.sdp),k=L.media.find(ee=>ee.type===N.kind),I.rtcp.cname=h.getCname({offerMediaObject:k}),I.encodings=d.getRtpEncodings({offerMediaObject:k,track:N}),b)for(let ee=0;ee<I.encodings.length;++ee)b[ee]&&Object.assign(I.encodings[ee],b[ee]);if(I.encodings.length>1&&I.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const ee of I.encodings)ee.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:k,offerRtpParameters:I,answerRtpParameters:z,codecOptions:m});const K={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("send() | calling pc.setRemoteDescription() [answer:%o]",K),yield this._pc.setRemoteDescription(K);const $=String(this._nextSendLocalId);this._nextSendLocalId++;const te=this._pc.getSenders().find(ee=>ee.track===N);return this._mapSendLocalIdRtpSender.set($,te),{localId:$,rtpParameters:I,rtpSender:te}})}stopSending(R){return j(this,null,function*(){this.assertSendDirection();const N=this._mapSendLocalIdRtpSender.get(R);if(!N)throw new Error("associated RTCRtpSender not found");N.track&&this._sendStream.removeTrack(N.track),this._mapSendLocalIdRtpSender.delete(R);const b=yield this._pc.createOffer();g.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",b);try{yield this._pc.setLocalDescription(b)}catch(w){if(this._sendStream.getTracks().length===0){g.warn("stopSending() | ignoring expected error due no sending tracks: %s",w.toString());return}throw w}if(this._pc.signalingState==="stable")return;const m={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",m),yield this._pc.setRemoteDescription(m)})}pauseSending(R){return j(this,null,function*(){})}resumeSending(R){return j(this,null,function*(){})}replaceTrack(R,N){return j(this,null,function*(){this.assertSendDirection(),N?g.debug("replaceTrack() [localId:%s, track.id:%s]",R,N.id):g.debug("replaceTrack() [localId:%s, no track]",R);const b=this._mapSendLocalIdRtpSender.get(R);if(!b)throw new Error("associated RTCRtpSender not found");const m=b.track;yield b.replaceTrack(N),m&&this._sendStream.removeTrack(m),N&&this._sendStream.addTrack(N)})}setMaxSpatialLayer(R,N){return j(this,null,function*(){this.assertSendDirection(),g.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",R,N);const b=this._mapSendLocalIdRtpSender.get(R);if(!b)throw new Error("associated RTCRtpSender not found");const m=b.getParameters();m.encodings.forEach((w,T)=>{T<=N?w.active=!0:w.active=!1}),yield b.setParameters(m)})}setRtpEncodingParameters(R,N){return j(this,null,function*(){this.assertSendDirection(),g.debug("setRtpEncodingParameters() [localId:%s, params:%o]",R,N);const b=this._mapSendLocalIdRtpSender.get(R);if(!b)throw new Error("associated RTCRtpSender not found");const m=b.getParameters();m.encodings.forEach((w,T)=>{m.encodings[T]=ae(ae({},w),N)}),yield b.setParameters(m)})}getSenderStats(R){return j(this,null,function*(){this.assertSendDirection();const N=this._mapSendLocalIdRtpSender.get(R);if(!N)throw new Error("associated RTCRtpSender not found");return N.getStats()})}sendDataChannel(R){return j(this,arguments,function*({ordered:N,maxPacketLifeTime:b,maxRetransmits:m,label:w,protocol:T}){var P;this.assertSendDirection();const L={negotiated:!0,id:this._nextSendSctpStreamId,ordered:N,maxPacketLifeTime:b,maxRetransmits:m,protocol:T};g.debug("sendDataChannel() [options:%o]",L);const k=this._pc.createDataChannel(w,L);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%S.MIS,!this._hasDataChannelMediaSection){const z=yield this._pc.createOffer(),K=r.parse(z.sdp),$=K.media.find(ee=>ee.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(P=this._forcedLocalDtlsRole)!=null?P:"client",localSdpObject:K})),g.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",z),yield this._pc.setLocalDescription(z),this._remoteSdp.sendSctpAssociation({offerMediaObject:$});const te={type:"answer",sdp:this._remoteSdp.getSdp()};g.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",te),yield this._pc.setRemoteDescription(te),this._hasDataChannelMediaSection=!0}const I={streamId:L.id,ordered:L.ordered,maxPacketLifeTime:L.maxPacketLifeTime,maxRetransmits:L.maxRetransmits};return{dataChannel:k,sctpStreamParameters:I}})}receive(R){return j(this,null,function*(){var N;this.assertRecvDirection();const b=[];for(const P of R){const{trackId:L,kind:k,rtpParameters:I,streamId:z}=P;g.debug("receive() [trackId:%s, kind:%s]",L,k);const K=k;this._remoteSdp.receive({mid:K,kind:k,offerRtpParameters:I,streamId:z??I.rtcp.cname,trackId:L})}const m={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);let w=yield this._pc.createAnswer();const T=r.parse(w.sdp);for(const P of R){const{kind:L,rtpParameters:k}=P,I=L,z=T.media.find(K=>String(K.mid)===I);h.applyCodecParameters({offerRtpParameters:k,answerMediaObject:z})}w={type:"answer",sdp:r.write(T)},this._transportReady||(yield this.setupTransport({localDtlsRole:(N=this._forcedLocalDtlsRole)!=null?N:"client",localSdpObject:T})),g.debug("receive() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w);for(const P of R){const{kind:L,trackId:k,rtpParameters:I}=P,z=L,K=k,$=this._pc.getReceivers().find(te=>te.track&&te.track.id===K);if(!$)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(K,{mid:z,rtpParameters:I,rtpReceiver:$}),b.push({localId:K,track:$.track,rtpReceiver:$})}return b})}stopReceiving(R){return j(this,null,function*(){var N;this.assertRecvDirection();for(const w of R){g.debug("stopReceiving() [localId:%s]",w);const{mid:T,rtpParameters:P}=(N=this._mapRecvLocalIdInfo.get(w))!=null?N:{};this._mapRecvLocalIdInfo.delete(w),this._remoteSdp.planBStopReceiving({mid:T,offerRtpParameters:P})}const b={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",b),yield this._pc.setRemoteDescription(b);const m=yield this._pc.createAnswer();g.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",m),yield this._pc.setLocalDescription(m)})}getReceiverStats(R){return j(this,null,function*(){var N;this.assertRecvDirection();const{rtpReceiver:b}=(N=this._mapRecvLocalIdInfo.get(R))!=null?N:{};if(!b)throw new Error("associated RTCRtpReceiver not found");return b.getStats()})}pauseReceiving(R){return j(this,null,function*(){})}resumeReceiving(R){return j(this,null,function*(){})}receiveDataChannel(R){return j(this,arguments,function*({sctpStreamParameters:N,label:b,protocol:m}){var w;this.assertRecvDirection();const{streamId:T,ordered:P,maxPacketLifeTime:L,maxRetransmits:k}=N,I={negotiated:!0,id:T,ordered:P,maxPacketLifeTime:L,maxRetransmits:k,protocol:m};g.debug("receiveDataChannel() [options:%o]",I);const z=this._pc.createDataChannel(b,I);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const K={type:"offer",sdp:this._remoteSdp.getSdp()};g.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",K),yield this._pc.setRemoteDescription(K);const $=yield this._pc.createAnswer();if(!this._transportReady){const te=r.parse($.sdp);yield this.setupTransport({localDtlsRole:(w=this._forcedLocalDtlsRole)!=null?w:"client",localSdpObject:te})}g.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",$),yield this._pc.setLocalDescription($),this._hasDataChannelMediaSection=!0}return{dataChannel:z}})}setupTransport(R){return j(this,arguments,function*({localDtlsRole:N,localSdpObject:b}){b||(b=r.parse(this._pc.localDescription.sdp));const m=h.extractDtlsParameters({sdpObject:b});m.role=N,this._remoteSdp.updateDtlsRole(N==="client"?"server":"client"),yield new Promise((w,T)=>{this.safeEmit("@connect",{dtlsParameters:m},w,T)}),this._transportReady=!0})}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.Safari11=E}}),Bb=Fe({"../../node_modules/mediasoup-client/lib/handlers/ortc/edgeUtils.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(c,h,d,p){p===void 0&&(p=d);var v=Object.getOwnPropertyDescriptor(h,d);(!v||("get"in v?!h.__esModule:v.writable||v.configurable))&&(v={enumerable:!0,get:function(){return h[d]}}),Object.defineProperty(c,p,v)}:function(c,h,d,p){p===void 0&&(p=d),c[p]=h[d]}),i=t&&t.__setModuleDefault||(Object.create?function(c,h){Object.defineProperty(c,"default",{enumerable:!0,value:h})}:function(c,h){c.default=h}),n=t&&t.__importStar||function(c){if(c&&c.__esModule)return c;var h={};if(c!=null)for(var d in c)d!=="default"&&Object.prototype.hasOwnProperty.call(c,d)&&e(h,c,d);return i(h,c),h};Object.defineProperty(t,"__esModule",{value:!0}),t.getCapabilities=s,t.mangleRtpParameters=o;var r=n(dn());function s(){var c,h,d;const p=RTCRtpReceiver.getCapabilities(),v=r.clone(p);for(const g of(c=v.codecs)!=null?c:[]){if(g.channels=g.numChannels,delete g.numChannels,g.mimeType=(h=g.mimeType)!=null?h:`${g.kind}/${g.name}`,g.parameters){const _=g.parameters;_.apt&&(_.apt=Number(_.apt)),_["packetization-mode"]&&(_["packetization-mode"]=Number(_["packetization-mode"]))}for(const _ of(d=g.rtcpFeedback)!=null?d:[])_.parameter||(_.parameter="")}return v}function o(c){const h=r.clone(c);h.mid&&(h.muxId=h.mid,delete h.mid);for(const d of h.codecs)d.channels&&(d.numChannels=d.channels,delete d.channels),d.mimeType&&!d.name&&(d.name=d.mimeType.split("/")[1]),delete d.mimeType;return h}}}),Hb=Fe({"../../node_modules/mediasoup-client/lib/handlers/Edge11.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(_,S,E,M){M===void 0&&(M=E);var R=Object.getOwnPropertyDescriptor(S,E);(!R||("get"in R?!S.__esModule:R.writable||R.configurable))&&(R={enumerable:!0,get:function(){return S[E]}}),Object.defineProperty(_,M,R)}:function(_,S,E,M){M===void 0&&(M=E),_[M]=S[E]}),i=t&&t.__setModuleDefault||(Object.create?function(_,S){Object.defineProperty(_,"default",{enumerable:!0,value:S})}:function(_,S){_.default=S}),n=t&&t.__importStar||function(_){if(_&&_.__esModule)return _;var S={};if(_!=null)for(var E in _)E!=="default"&&Object.prototype.hasOwnProperty.call(_,E)&&e(S,_,E);return i(S,_),S};Object.defineProperty(t,"__esModule",{value:!0}),t.Edge11=void 0;var r=Xi(),s=Mn(),o=n(dn()),c=n(jn()),h=n(Bb()),d=Zn(),p=new r.Logger("Edge11"),v="Edge11",g=class Bm extends d.HandlerInterface{static createFactory(){return()=>new Bm}constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}get name(){return v}close(){p.debug("close()");try{this._iceGatherer.close()}catch{}try{this._iceTransport.stop()}catch{}try{this._dtlsTransport.stop()}catch{}for(const S of this._rtpSenders.values())try{S.stop()}catch{}for(const S of this._rtpReceivers.values())try{S.stop()}catch{}this.emit("@close")}getNativeRtpCapabilities(){return j(this,null,function*(){return p.debug("getNativeRtpCapabilities()"),h.getCapabilities()})}getNativeSctpCapabilities(){return j(this,null,function*(){return p.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}})}run({direction:S,iceParameters:E,iceCandidates:M,dtlsParameters:R,sctpParameters:N,iceServers:b,iceTransportPolicy:m,additionalSettings:w,proprietaryConstraints:T,extendedRtpCapabilities:P}){p.debug("run()"),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",P),video:c.getSendingRtpParameters("video",P)},this._remoteIceParameters=E,this._remoteIceCandidates=M,this._remoteDtlsParameters=R,this._cname=`CNAME-${o.generateRandomNumber()}`,this.setIceGatherer({iceServers:b,iceTransportPolicy:m}),this.setIceTransport(),this.setDtlsTransport()}updateIceServers(S){return j(this,null,function*(){throw new s.UnsupportedError("not supported")})}restartIce(S){return j(this,null,function*(){if(p.debug("restartIce()"),this._remoteIceParameters=S,!!this._transportReady){p.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,S,"controlling");for(const E of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(E);this._iceTransport.addRemoteCandidate({})}})}getTransportStats(){return j(this,null,function*(){return this._iceTransport.getStats()})}send(S){return j(this,arguments,function*({track:E,encodings:M,codecOptions:R,codec:N}){p.debug("send() [kind:%s, track.id:%s]",E.kind,E.id),this._transportReady||(yield this.setupTransport({localDtlsRole:"server"})),p.debug("send() | calling new RTCRtpSender()");const b=new RTCRtpSender(E,this._dtlsTransport),m=o.clone(this._sendingRtpParametersByKind[E.kind]);m.codecs=c.reduceCodecs(m.codecs,N);const w=m.codecs.some(L=>/.+\/rtx$/i.test(L.mimeType));M||(M=[{}]);for(const L of M)L.ssrc=o.generateRandomNumber(),w&&(L.rtx={ssrc:o.generateRandomNumber()});m.encodings=M,m.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const T=h.mangleRtpParameters(m);p.debug("send() | calling rtpSender.send() [params:%o]",T),yield b.send(T);const P=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(P,b),{localId:P,rtpParameters:m,rtpSender:b}})}stopSending(S){return j(this,null,function*(){p.debug("stopSending() [localId:%s]",S);const E=this._rtpSenders.get(S);if(!E)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(S);try{p.debug("stopSending() | calling rtpSender.stop()"),E.stop()}catch(M){throw p.warn("stopSending() | rtpSender.stop() failed:%o",M),M}})}pauseSending(S){return j(this,null,function*(){})}resumeSending(S){return j(this,null,function*(){})}replaceTrack(S,E){return j(this,null,function*(){E?p.debug("replaceTrack() [localId:%s, track.id:%s]",S,E.id):p.debug("replaceTrack() [localId:%s, no track]",S);const M=this._rtpSenders.get(S);if(!M)throw new Error("RTCRtpSender not found");M.setTrack(E)})}setMaxSpatialLayer(S,E){return j(this,null,function*(){p.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",S,E);const M=this._rtpSenders.get(S);if(!M)throw new Error("RTCRtpSender not found");const R=M.getParameters();R.encodings.forEach((N,b)=>{b<=E?N.active=!0:N.active=!1}),yield M.setParameters(R)})}setRtpEncodingParameters(S,E){return j(this,null,function*(){p.debug("setRtpEncodingParameters() [localId:%s, params:%o]",S,E);const M=this._rtpSenders.get(S);if(!M)throw new Error("RTCRtpSender not found");const R=M.getParameters();R.encodings.forEach((N,b)=>{R.encodings[b]=ae(ae({},N),E)}),yield M.setParameters(R)})}getSenderStats(S){return j(this,null,function*(){const E=this._rtpSenders.get(S);if(!E)throw new Error("RTCRtpSender not found");return E.getStats()})}sendDataChannel(S){return j(this,null,function*(){throw new s.UnsupportedError("not implemented")})}receive(S){return j(this,null,function*(){const E=[];for(const M of S){const{trackId:R,kind:N}=M;p.debug("receive() [trackId:%s, kind:%s]",R,N)}this._transportReady||(yield this.setupTransport({localDtlsRole:"server"}));for(const M of S){const{trackId:R,kind:N,rtpParameters:b}=M;p.debug("receive() | calling new RTCRtpReceiver()");const m=new RTCRtpReceiver(this._dtlsTransport,N);m.addEventListener("error",P=>{p.error('rtpReceiver "error" event [event:%o]',P)});const w=h.mangleRtpParameters(b);p.debug("receive() | calling rtpReceiver.receive() [params:%o]",w),yield m.receive(w);const T=R;this._rtpReceivers.set(T,m),E.push({localId:T,track:m.track,rtpReceiver:m})}return E})}stopReceiving(S){return j(this,null,function*(){for(const E of S){p.debug("stopReceiving() [localId:%s]",E);const M=this._rtpReceivers.get(E);if(!M)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(E);try{p.debug("stopReceiving() | calling rtpReceiver.stop()"),M.stop()}catch(R){p.warn("stopReceiving() | rtpReceiver.stop() failed:%o",R)}}})}pauseReceiving(S){return j(this,null,function*(){})}resumeReceiving(S){return j(this,null,function*(){})}getReceiverStats(S){return j(this,null,function*(){const E=this._rtpReceivers.get(S);if(!E)throw new Error("RTCRtpReceiver not found");return E.getStats()})}receiveDataChannel(S){return j(this,null,function*(){throw new s.UnsupportedError("not implemented")})}setIceGatherer({iceServers:S,iceTransportPolicy:E}){const M=new RTCIceGatherer({iceServers:S??[],gatherPolicy:E??"all"});M.addEventListener("error",R=>{p.error('iceGatherer "error" event [event:%o]',R)});try{M.gather()}catch(R){p.debug("setIceGatherer() | iceGatherer.gather() failed: %s",R.toString())}this._iceGatherer=M}setIceTransport(){const S=new RTCIceTransport(this._iceGatherer);S.addEventListener("statechange",()=>{switch(S.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),S.addEventListener("icestatechange",()=>{switch(S.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),S.addEventListener("candidatepairchange",E=>{p.debug('iceTransport "candidatepairchange" event [pair:%o]',E.pair)}),this._iceTransport=S}setDtlsTransport(){const S=new RTCDtlsTransport(this._iceTransport);S.addEventListener("statechange",()=>{p.debug('dtlsTransport "statechange" event [state:%s]',S.state)}),S.addEventListener("dtlsstatechange",()=>{p.debug('dtlsTransport "dtlsstatechange" event [state:%s]',S.state),S.state==="closed"&&this.emit("@connectionstatechange","closed")}),S.addEventListener("error",E=>{p.error('dtlsTransport "error" event [event:%o]',E)}),this._dtlsTransport=S}setupTransport(S){return j(this,arguments,function*({localDtlsRole:E}){p.debug("setupTransport()");const M=this._dtlsTransport.getLocalParameters();M.role=E,yield new Promise((R,N)=>{this.safeEmit("@connect",{dtlsParameters:M},R,N)}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const R of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(R);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(R=>R.algorithm==="sha-256"||R.algorithm==="sha-384"||R.algorithm==="sha-512"),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0})}};t.Edge11=g}}),jb=Fe({"../../node_modules/mediasoup-client/lib/handlers/ReactNativeUnifiedPlan.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(b,m,w,T){T===void 0&&(T=w);var P=Object.getOwnPropertyDescriptor(m,w);(!P||("get"in P?!m.__esModule:P.writable||P.configurable))&&(P={enumerable:!0,get:function(){return m[w]}}),Object.defineProperty(b,T,P)}:function(b,m,w,T){T===void 0&&(T=w),b[T]=m[w]}),i=t&&t.__setModuleDefault||(Object.create?function(b,m){Object.defineProperty(b,"default",{enumerable:!0,value:m})}:function(b,m){b.default=m}),n=t&&t.__importStar||function(b){if(b&&b.__esModule)return b;var m={};if(b!=null)for(var w in b)w!=="default"&&Object.prototype.hasOwnProperty.call(b,w)&&e(m,b,w);return i(m,b),m};Object.defineProperty(t,"__esModule",{value:!0}),t.ReactNativeUnifiedPlan=void 0;var r=n(ln()),s=Xi(),o=n(dn()),c=n(jn()),h=n(Tr()),d=n(ca()),p=n(Il()),v=Mn(),g=Zn(),_=Rr(),S=Ps(),E=new s.Logger("ReactNativeUnifiedPlan"),M="ReactNativeUnifiedPlan",R={OS:1024,MIS:1024},N=class Hm extends g.HandlerInterface{static createFactory(){return()=>new Hm}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return M}close(){if(E.debug("close()"),!this._closed){if(this._closed=!0,this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}}getNativeRtpCapabilities(){return j(this,null,function*(){E.debug("getNativeRtpCapabilities()");const m=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{m.addTransceiver("audio"),m.addTransceiver("video");const w=yield m.createOffer();try{m.close()}catch{}const T=r.parse(w.sdp),P=h.extractRtpCapabilities({sdpObject:T});return p.addNackSuppportForOpus(P),P}catch(w){try{m.close()}catch{}throw w}})}getNativeSctpCapabilities(){return j(this,null,function*(){return E.debug("getNativeSctpCapabilities()"),{numStreams:R}})}run({direction:m,iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L,iceServers:k,iceTransportPolicy:I,additionalSettings:z,proprietaryConstraints:K,extendedRtpCapabilities:$}){this.assertNotClosed(),E.debug("run()"),this._direction=m,this._remoteSdp=new _.RemoteSdp({iceParameters:w,iceCandidates:T,dtlsParameters:P,sctpParameters:L}),this._sendingRtpParametersByKind={audio:c.getSendingRtpParameters("audio",$),video:c.getSendingRtpParameters("video",$)},this._sendingRemoteRtpParametersByKind={audio:c.getSendingRemoteRtpParameters("audio",$),video:c.getSendingRemoteRtpParameters("video",$)},P.role&&P.role!=="auto"&&(this._forcedLocalDtlsRole=P.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:k??[],iceTransportPolicy:I??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"},z),K),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(E.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(m){return j(this,null,function*(){this.assertNotClosed(),E.debug("updateIceServers()");const w=this._pc.getConfiguration();w.iceServers=m,this._pc.setConfiguration(w)})}restartIce(m){return j(this,null,function*(){if(this.assertNotClosed(),E.debug("restartIce()"),this._remoteSdp.updateIceParameters(m),!!this._transportReady)if(this._direction==="send"){const w=yield this._pc.createOffer({iceRestart:!0});E.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",w),yield this._pc.setLocalDescription(w);const T={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",T),yield this._pc.setRemoteDescription(T)}else{const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)}})}getTransportStats(){return j(this,null,function*(){return this.assertNotClosed(),this._pc.getStats()})}send(m){return j(this,arguments,function*({track:w,encodings:T,codecOptions:P,codec:L,onRtpSender:k}){var I,z;this.assertNotClosed(),this.assertSendDirection(),E.debug("send() [kind:%s, track.id:%s]",w.kind,w.id),T&&T.length>1&&T.forEach((Ve,Me)=>{Ve.rid=`r${Me}`});const K=o.clone(this._sendingRtpParametersByKind[w.kind]);K.codecs=c.reduceCodecs(K.codecs,L);const $=o.clone(this._sendingRemoteRtpParametersByKind[w.kind]);$.codecs=c.reduceCodecs($.codecs,L);const te=this._remoteSdp.getNextMediaSectionIdx(),ee=this._pc.addTransceiver(w,{direction:"sendonly",streams:[this._sendStream],sendEncodings:T});k&&k(ee.sender);let de=yield this._pc.createOffer(),X=r.parse(de.sdp),le;this._transportReady||(yield this.setupTransport({localDtlsRole:(I=this._forcedLocalDtlsRole)!=null?I:"client",localSdpObject:X}));let _e=!1;const Se=(0,S.parse)((T??[{}])[0].scalabilityMode);T&&T.length===1&&Se.spatialLayers>1&&K.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(E.debug("send() | enabling legacy simulcast for VP9 SVC"),_e=!0,X=r.parse(de.sdp),le=X.media[te.idx],d.addLegacySimulcast({offerMediaObject:le,numStreams:Se.spatialLayers}),de={type:"offer",sdp:r.write(X)}),E.debug("send() | calling pc.setLocalDescription() [offer:%o]",de),yield this._pc.setLocalDescription(de);let De=(z=ee.mid)!=null?z:void 0;if(De||E.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),K.mid=De,X=r.parse(this._pc.localDescription.sdp),le=X.media[te.idx],K.rtcp.cname=h.getCname({offerMediaObject:le}),!T)K.encodings=d.getRtpEncodings({offerMediaObject:le});else if(T.length===1){let Ve=d.getRtpEncodings({offerMediaObject:le});Object.assign(Ve[0],T[0]),_e&&(Ve=[Ve[0]]),K.encodings=Ve}else K.encodings=T;if(K.encodings.length>1&&(K.codecs[0].mimeType.toLowerCase()==="video/vp8"||K.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const Ve of K.encodings)Ve.scalabilityMode?Ve.scalabilityMode=`L1T${Se.temporalLayers}`:Ve.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:le,reuseMid:te.reuseMid,offerRtpParameters:K,answerRtpParameters:$,codecOptions:P,extmapAllowMixed:!0});const We={type:"answer",sdp:this._remoteSdp.getSdp()};return E.debug("send() | calling pc.setRemoteDescription() [answer:%o]",We),yield this._pc.setRemoteDescription(We),De||(De=ee.mid,K.mid=De),this._mapMidTransceiver.set(De,ee),{localId:De,rtpParameters:K,rtpSender:ee.sender}})}stopSending(m){return j(this,null,function*(){if(this.assertSendDirection(),this._closed)return;E.debug("stopSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");if(w.sender.replaceTrack(null),this._pc.removeTrack(w.sender),this._remoteSdp.closeMediaSection(w.mid))try{w.stop()}catch{}const P=yield this._pc.createOffer();E.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",P),yield this._pc.setLocalDescription(P);const L={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",L),yield this._pc.setRemoteDescription(L),this._mapMidTransceiver.delete(m)})}pauseSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("pauseSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="inactive",this._remoteSdp.pauseMediaSection(m);const T=yield this._pc.createOffer();E.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}resumeSending(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("resumeSending() [localId:%s]",m);const w=this._mapMidTransceiver.get(m);if(this._remoteSdp.resumeSendingMediaSection(m),!w)throw new Error("associated RTCRtpTransceiver not found");w.direction="sendonly";const T=yield this._pc.createOffer();E.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",T),yield this._pc.setLocalDescription(T);const P={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",P),yield this._pc.setRemoteDescription(P)})}replaceTrack(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),w?E.debug("replaceTrack() [localId:%s, track.id:%s]",m,w.id):E.debug("replaceTrack() [localId:%s, no track]",m);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");yield T.sender.replaceTrack(w)})}setMaxSpatialLayer(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{z<=w?I.active=!0:I.active=!1}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}setRtpEncodingParameters(m,w){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection(),E.debug("setRtpEncodingParameters() [localId:%s, params:%o]",m,w);const T=this._mapMidTransceiver.get(m);if(!T)throw new Error("associated RTCRtpTransceiver not found");const P=T.sender.getParameters();P.encodings.forEach((I,z)=>{P.encodings[z]=ae(ae({},I),w)}),yield T.sender.setParameters(P),this._remoteSdp.muxMediaSectionSimulcast(m,P.encodings);const L=yield this._pc.createOffer();E.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L);const k={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",k),yield this._pc.setRemoteDescription(k)})}getSenderStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertSendDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.sender.getStats()})}sendDataChannel(m){return j(this,arguments,function*({ordered:w,maxPacketLifeTime:T,maxRetransmits:P,label:L,protocol:k}){var I;this.assertNotClosed(),this.assertSendDirection();const z={negotiated:!0,id:this._nextSendSctpStreamId,ordered:w,maxPacketLifeTime:T,maxRetransmits:P,protocol:k};E.debug("sendDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(L,z);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%R.MIS,!this._hasDataChannelMediaSection){const te=yield this._pc.createOffer(),ee=r.parse(te.sdp),de=ee.media.find(le=>le.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(I=this._forcedLocalDtlsRole)!=null?I:"client",localSdpObject:ee})),E.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",te),yield this._pc.setLocalDescription(te),this._remoteSdp.sendSctpAssociation({offerMediaObject:de});const X={type:"answer",sdp:this._remoteSdp.getSdp()};E.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",X),yield this._pc.setRemoteDescription(X),this._hasDataChannelMediaSection=!0}const $={streamId:z.id,ordered:z.ordered,maxPacketLifeTime:z.maxPacketLifeTime,maxRetransmits:z.maxRetransmits};return{dataChannel:K,sctpStreamParameters:$}})}receive(m){return j(this,null,function*(){var w,T;this.assertNotClosed(),this.assertRecvDirection();const P=[],L=new Map;for(const K of m){const{trackId:$,kind:te,rtpParameters:ee,streamId:de}=K;E.debug("receive() [trackId:%s, kind:%s]",$,te);const X=(w=ee.mid)!=null?w:String(this._mapMidTransceiver.size);L.set($,X),this._remoteSdp.receive({mid:X,kind:te,offerRtpParameters:ee,streamId:de??ee.rtcp.cname,trackId:$})}const k={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",k),yield this._pc.setRemoteDescription(k);for(const K of m){const{trackId:$,onRtpReceiver:te}=K;if(te){const ee=L.get($),de=this._pc.getTransceivers().find(X=>X.mid===ee);if(!de)throw new Error("transceiver not found");te(de.receiver)}}let I=yield this._pc.createAnswer();const z=r.parse(I.sdp);for(const K of m){const{trackId:$,rtpParameters:te}=K,ee=L.get($),de=z.media.find(X=>String(X.mid)===ee);h.applyCodecParameters({offerRtpParameters:te,answerMediaObject:de})}I={type:"answer",sdp:r.write(z)},this._transportReady||(yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:z})),E.debug("receive() | calling pc.setLocalDescription() [answer:%o]",I),yield this._pc.setLocalDescription(I);for(const K of m){const{trackId:$}=K,te=L.get($),ee=this._pc.getTransceivers().find(de=>de.mid===te);if(ee)this._mapMidTransceiver.set(te,ee),P.push({localId:te,track:ee.receiver.track,rtpReceiver:ee.receiver});else throw new Error("new RTCRtpTransceiver not found")}return P})}stopReceiving(m){return j(this,null,function*(){if(this.assertRecvDirection(),this._closed)return;for(const P of m){E.debug("stopReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(L.mid)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T);for(const P of m)this._mapMidTransceiver.delete(P)})}pauseReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("pauseReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="inactive",this._remoteSdp.pauseMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}resumeReceiving(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();for(const P of m){E.debug("resumeReceiving() [localId:%s]",P);const L=this._mapMidTransceiver.get(P);if(!L)throw new Error("associated RTCRtpTransceiver not found");L.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(P)}const w={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",w),yield this._pc.setRemoteDescription(w);const T=yield this._pc.createAnswer();E.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",T),yield this._pc.setLocalDescription(T)})}getReceiverStats(m){return j(this,null,function*(){this.assertNotClosed(),this.assertRecvDirection();const w=this._mapMidTransceiver.get(m);if(!w)throw new Error("associated RTCRtpTransceiver not found");return w.receiver.getStats()})}receiveDataChannel(m){return j(this,arguments,function*({sctpStreamParameters:w,label:T,protocol:P}){var L;this.assertNotClosed(),this.assertRecvDirection();const{streamId:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K}=w,$={negotiated:!0,id:k,ordered:I,maxPacketLifeTime:z,maxRetransmits:K,protocol:P};E.debug("receiveDataChannel() [options:%o]",$);const te=this._pc.createDataChannel(T,$);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const ee={type:"offer",sdp:this._remoteSdp.getSdp()};E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",ee),yield this._pc.setRemoteDescription(ee);const de=yield this._pc.createAnswer();if(!this._transportReady){const X=r.parse(de.sdp);yield this.setupTransport({localDtlsRole:(L=this._forcedLocalDtlsRole)!=null?L:"client",localSdpObject:X})}E.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",de),yield this._pc.setLocalDescription(de),this._hasDataChannelMediaSection=!0}return{dataChannel:te}})}setupTransport(m){return j(this,arguments,function*({localDtlsRole:w,localSdpObject:T}){T||(T=r.parse(this._pc.localDescription.sdp));const P=h.extractDtlsParameters({sdpObject:T});P.role=w,this._remoteSdp.updateDtlsRole(w==="client"?"server":"client"),yield new Promise((L,k)=>{this.safeEmit("@connect",{dtlsParameters:P},L,k)}),this._transportReady=!0})}assertNotClosed(){if(this._closed)throw new v.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.ReactNativeUnifiedPlan=N}}),Vb=Fe({"../../node_modules/mediasoup-client/lib/handlers/ReactNative.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(R,N,b,m){m===void 0&&(m=b);var w=Object.getOwnPropertyDescriptor(N,b);(!w||("get"in w?!N.__esModule:w.writable||w.configurable))&&(w={enumerable:!0,get:function(){return N[b]}}),Object.defineProperty(R,m,w)}:function(R,N,b,m){m===void 0&&(m=b),R[m]=N[b]}),i=t&&t.__setModuleDefault||(Object.create?function(R,N){Object.defineProperty(R,"default",{enumerable:!0,value:N})}:function(R,N){R.default=N}),n=t&&t.__importStar||function(R){if(R&&R.__esModule)return R;var N={};if(R!=null)for(var b in R)b!=="default"&&Object.prototype.hasOwnProperty.call(R,b)&&e(N,R,b);return i(N,R),N};Object.defineProperty(t,"__esModule",{value:!0}),t.ReactNative=void 0;var r=n(ln()),s=Xi(),o=Mn(),c=n(dn()),h=n(jn()),d=n(Tr()),p=n(Fl()),v=Zn(),g=Rr(),_=new s.Logger("ReactNative"),S="ReactNative",E={OS:1024,MIS:1024},M=class jm extends v.HandlerInterface{static createFactory(){return()=>new jm}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return S}close(){if(_.debug("close()"),this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}getNativeRtpCapabilities(){return j(this,null,function*(){_.debug("getNativeRtpCapabilities()");const N=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const b=yield N.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{N.close()}catch{}const m=r.parse(b.sdp);return d.extractRtpCapabilities({sdpObject:m})}catch(b){try{N.close()}catch{}throw b}})}getNativeSctpCapabilities(){return j(this,null,function*(){return _.debug("getNativeSctpCapabilities()"),{numStreams:E}})}run({direction:N,iceParameters:b,iceCandidates:m,dtlsParameters:w,sctpParameters:T,iceServers:P,iceTransportPolicy:L,additionalSettings:k,proprietaryConstraints:I,extendedRtpCapabilities:z}){_.debug("run()"),this._direction=N,this._remoteSdp=new g.RemoteSdp({iceParameters:b,iceCandidates:m,dtlsParameters:w,sctpParameters:T,planB:!0}),this._sendingRtpParametersByKind={audio:h.getSendingRtpParameters("audio",z),video:h.getSendingRtpParameters("video",z)},this._sendingRemoteRtpParametersByKind={audio:h.getSendingRemoteRtpParameters("audio",z),video:h.getSendingRemoteRtpParameters("video",z)},w.role&&w.role!=="auto"&&(this._forcedLocalDtlsRole=w.role==="server"?"client":"server"),this._pc=new RTCPeerConnection(ae({iceServers:P??[],iceTransportPolicy:L??"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"},k),I),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(_.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}updateIceServers(N){return j(this,null,function*(){_.debug("updateIceServers()");const b=this._pc.getConfiguration();b.iceServers=N,this._pc.setConfiguration(b)})}restartIce(N){return j(this,null,function*(){if(_.debug("restartIce()"),this._remoteSdp.updateIceParameters(N),!!this._transportReady)if(this._direction==="send"){const b=yield this._pc.createOffer({iceRestart:!0});_.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",b),yield this._pc.setLocalDescription(b);const m={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",m),yield this._pc.setRemoteDescription(m)}else{const b={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",b),yield this._pc.setRemoteDescription(b);const m=yield this._pc.createAnswer();_.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",m),yield this._pc.setLocalDescription(m)}})}getTransportStats(){return j(this,null,function*(){return this._pc.getStats()})}send(N){return j(this,arguments,function*({track:b,encodings:m,codecOptions:w,codec:T}){var P;this.assertSendDirection(),_.debug("send() [kind:%s, track.id:%s]",b.kind,b.id),T&&_.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(b),this._pc.addStream(this._sendStream);let L=yield this._pc.createOffer(),k=r.parse(L.sdp),I;const z=c.clone(this._sendingRtpParametersByKind[b.kind]);z.codecs=h.reduceCodecs(z.codecs);const K=c.clone(this._sendingRemoteRtpParametersByKind[b.kind]);if(K.codecs=h.reduceCodecs(K.codecs),this._transportReady||(yield this.setupTransport({localDtlsRole:(P=this._forcedLocalDtlsRole)!=null?P:"client",localSdpObject:k})),b.kind==="video"&&m&&m.length>1&&(_.debug("send() | enabling simulcast"),k=r.parse(L.sdp),I=k.media.find(ee=>ee.type==="video"),p.addLegacySimulcast({offerMediaObject:I,track:b,numStreams:m.length}),L={type:"offer",sdp:r.write(k)}),_.debug("send() | calling pc.setLocalDescription() [offer:%o]",L),yield this._pc.setLocalDescription(L),k=r.parse(this._pc.localDescription.sdp),I=k.media.find(ee=>ee.type===b.kind),z.rtcp.cname=d.getCname({offerMediaObject:I}),z.encodings=p.getRtpEncodings({offerMediaObject:I,track:b}),m)for(let ee=0;ee<z.encodings.length;++ee)m[ee]&&Object.assign(z.encodings[ee],m[ee]);if(z.encodings.length>1&&(z.codecs[0].mimeType.toLowerCase()==="video/vp8"||z.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const ee of z.encodings)ee.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:I,offerRtpParameters:z,answerRtpParameters:K,codecOptions:w});const $={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("send() | calling pc.setRemoteDescription() [answer:%o]",$),yield this._pc.setRemoteDescription($);const te=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(te,b),{localId:te,rtpParameters:z}})}stopSending(N){return j(this,null,function*(){this.assertSendDirection(),_.debug("stopSending() [localId:%s]",N);const b=this._mapSendLocalIdTrack.get(N);if(!b)throw new Error("track not found");this._mapSendLocalIdTrack.delete(N),this._sendStream.removeTrack(b),this._pc.addStream(this._sendStream);const m=yield this._pc.createOffer();_.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",m);try{yield this._pc.setLocalDescription(m)}catch(T){if(this._sendStream.getTracks().length===0){_.warn("stopSending() | ignoring expected error due no sending tracks: %s",T.toString());return}throw T}if(this._pc.signalingState==="stable")return;const w={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",w),yield this._pc.setRemoteDescription(w)})}pauseSending(N){return j(this,null,function*(){})}resumeSending(N){return j(this,null,function*(){})}replaceTrack(N,b){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}setMaxSpatialLayer(N,b){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}setRtpEncodingParameters(N,b){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}getSenderStats(N){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}sendDataChannel(N){return j(this,arguments,function*({ordered:b,maxPacketLifeTime:m,maxRetransmits:w,label:T,protocol:P}){var L;this.assertSendDirection();const k={negotiated:!0,id:this._nextSendSctpStreamId,ordered:b,maxPacketLifeTime:m,maxRetransmitTime:m,maxRetransmits:w,protocol:P};_.debug("sendDataChannel() [options:%o]",k);const I=this._pc.createDataChannel(T,k);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%E.MIS,!this._hasDataChannelMediaSection){const K=yield this._pc.createOffer(),$=r.parse(K.sdp),te=$.media.find(de=>de.type==="application");this._transportReady||(yield this.setupTransport({localDtlsRole:(L=this._forcedLocalDtlsRole)!=null?L:"client",localSdpObject:$})),_.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",K),yield this._pc.setLocalDescription(K),this._remoteSdp.sendSctpAssociation({offerMediaObject:te});const ee={type:"answer",sdp:this._remoteSdp.getSdp()};_.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",ee),yield this._pc.setRemoteDescription(ee),this._hasDataChannelMediaSection=!0}const z={streamId:k.id,ordered:k.ordered,maxPacketLifeTime:k.maxPacketLifeTime,maxRetransmits:k.maxRetransmits};return{dataChannel:I,sctpStreamParameters:z}})}receive(N){return j(this,null,function*(){var b,m;this.assertRecvDirection();const w=[],T=new Map;for(const I of N){const{trackId:z,kind:K,rtpParameters:$}=I;_.debug("receive() [trackId:%s, kind:%s]",z,K);const te=K;let ee=(b=I.streamId)!=null?b:$.rtcp.cname;_.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),ee+=`-hack-${c.generateRandomNumber()}`,T.set(z,ee),this._remoteSdp.receive({mid:te,kind:K,offerRtpParameters:$,streamId:ee,trackId:z})}const P={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",P),yield this._pc.setRemoteDescription(P);let L=yield this._pc.createAnswer();const k=r.parse(L.sdp);for(const I of N){const{kind:z,rtpParameters:K}=I,$=z,te=k.media.find(ee=>String(ee.mid)===$);d.applyCodecParameters({offerRtpParameters:K,answerMediaObject:te})}L={type:"answer",sdp:r.write(k)},this._transportReady||(yield this.setupTransport({localDtlsRole:(m=this._forcedLocalDtlsRole)!=null?m:"client",localSdpObject:k})),_.debug("receive() | calling pc.setLocalDescription() [answer:%o]",L),yield this._pc.setLocalDescription(L);for(const I of N){const{kind:z,trackId:K,rtpParameters:$}=I,te=K,ee=z,de=T.get(K),le=this._pc.getRemoteStreams().find(_e=>_e.id===de).getTrackById(te);if(!le)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(te,{mid:ee,rtpParameters:$}),w.push({localId:te,track:le})}return w})}stopReceiving(N){return j(this,null,function*(){var b;this.assertRecvDirection();for(const T of N){_.debug("stopReceiving() [localId:%s]",T);const{mid:P,rtpParameters:L}=(b=this._mapRecvLocalIdInfo.get(T))!=null?b:{};this._mapRecvLocalIdInfo.delete(T),this._remoteSdp.planBStopReceiving({mid:P,offerRtpParameters:L})}const m={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",m),yield this._pc.setRemoteDescription(m);const w=yield this._pc.createAnswer();_.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",w),yield this._pc.setLocalDescription(w)})}pauseReceiving(N){return j(this,null,function*(){})}resumeReceiving(N){return j(this,null,function*(){})}getReceiverStats(N){return j(this,null,function*(){throw new o.UnsupportedError("not implemented")})}receiveDataChannel(N){return j(this,arguments,function*({sctpStreamParameters:b,label:m,protocol:w}){var T;this.assertRecvDirection();const{streamId:P,ordered:L,maxPacketLifeTime:k,maxRetransmits:I}=b,z={negotiated:!0,id:P,ordered:L,maxPacketLifeTime:k,maxRetransmitTime:k,maxRetransmits:I,protocol:w};_.debug("receiveDataChannel() [options:%o]",z);const K=this._pc.createDataChannel(m,z);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const $={type:"offer",sdp:this._remoteSdp.getSdp()};_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",$),yield this._pc.setRemoteDescription($);const te=yield this._pc.createAnswer();if(!this._transportReady){const ee=r.parse(te.sdp);yield this.setupTransport({localDtlsRole:(T=this._forcedLocalDtlsRole)!=null?T:"client",localSdpObject:ee})}_.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",te),yield this._pc.setLocalDescription(te),this._hasDataChannelMediaSection=!0}return{dataChannel:K}})}setupTransport(N){return j(this,arguments,function*({localDtlsRole:b,localSdpObject:m}){m||(m=r.parse(this._pc.localDescription.sdp));const w=d.extractDtlsParameters({sdpObject:m});w.role=b,this._remoteSdp.updateDtlsRole(b==="client"?"server":"client"),yield new Promise((T,P)=>{this.safeEmit("@connect",{dtlsParameters:w},T,P)}),this._transportReady=!0})}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}};t.ReactNative=M}}),Vm=Fe({"../../node_modules/mediasoup-client/lib/Device.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(I,z,K,$){$===void 0&&($=K);var te=Object.getOwnPropertyDescriptor(z,K);(!te||("get"in te?!z.__esModule:te.writable||te.configurable))&&(te={enumerable:!0,get:function(){return z[K]}}),Object.defineProperty(I,$,te)}:function(I,z,K,$){$===void 0&&($=K),I[$]=z[K]}),i=t&&t.__setModuleDefault||(Object.create?function(I,z){Object.defineProperty(I,"default",{enumerable:!0,value:z})}:function(I,z){I.default=z}),n=t&&t.__importStar||function(I){if(I&&I.__esModule)return I;var z={};if(I!=null)for(var K in I)K!=="default"&&Object.prototype.hasOwnProperty.call(I,K)&&e(z,I,K);return i(z,I),z};Object.defineProperty(t,"__esModule",{value:!0}),t.Device=void 0,t.detectDevice=L;var r=om(),s=Xi(),o=oa(),c=Mn(),h=n(dn()),d=n(jn()),p=Pm(),v=Ab(),g=Db(),_=Ib(),S=Fb(),E=Nb(),M=Lb(),R=Ob(),N=kb(),b=Ub(),m=Hb(),w=jb(),T=Vb(),P=new s.Logger("Device");function L(I){var z,K,$,te,ee,de;if(!I&&typeof navigator=="object"&&navigator.product==="ReactNative"){if(P.debug("detectDevice() | React-Native detected"),typeof RTCPeerConnection>"u"){P.warn("detectDevice() | unsupported react-native-webrtc without RTCPeerConnection, forgot to call registerGlobals()?");return}return typeof RTCRtpTransceiver<"u"?(P.debug("detectDevice() | ReactNative UnifiedPlan handler chosen"),"ReactNativeUnifiedPlan"):(P.debug("detectDevice() | ReactNative PlanB handler chosen"),"ReactNative")}else if(I||typeof navigator=="object"&&typeof navigator.userAgent=="string"){I??(I=navigator.userAgent);const X=new r.UAParser(I);P.debug("detectDevice() | browser detected [userAgent:%s, parsed:%o]",I,X.getResult());const le=X.getBrowser(),_e=(z=le.name)==null?void 0:z.toLowerCase(),Se=parseInt((K=le.major)!=null?K:"0"),We=($=X.getEngine().name)==null?void 0:$.toLowerCase(),Ve=X.getOS(),Me=(te=Ve.name)==null?void 0:te.toLowerCase(),ze=parseFloat((ee=Ve.version)!=null?ee:"0"),nt=(de=X.getDevice().model)==null?void 0:de.toLowerCase(),rt=Me==="ios"||nt==="ipad",jt=_e&&["chrome","chromium","mobile chrome","chrome webview","chrome headless"].includes(_e),Ct=_e&&["firefox","mobile firefox","mobile focus"].includes(_e),li=_e&&["safari","mobile safari"].includes(_e),di=_e&&["edge"].includes(_e);if((jt||di)&&!rt&&Se>=111)return"Chrome111";if(jt&&!rt&&Se>=74||di&&!rt&&Se>=88)return"Chrome74";if(jt&&!rt&&Se>=70)return"Chrome70";if(jt&&!rt&&Se>=67)return"Chrome67";if(jt&&!rt&&Se>=55)return"Chrome55";if(Ct&&!rt&&Se>=120)return"Firefox120";if(Ct&&!rt&&Se>=60)return"Firefox60";if(Ct&&rt&&ze>=14.3)return"Safari12";if(li&&Se>=12&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(li&&Se>=11)return"Safari11";if(di&&!rt&&Se>=11&&Se<=18)return"Edge11";if(We==="webkit"&&rt&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(We==="blink"){const zt=I.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(zt){const he=Number(zt[1]);return he>=111?"Chrome111":he>=74?"Chrome74":he>=70?"Chrome70":he>=67?"Chrome67":"Chrome55"}else return"Chrome111"}else{P.warn("detectDevice() | browser not supported [name:%s, version:%s]",_e,Se);return}}else{P.warn("detectDevice() | unknown device");return}}var k=class{constructor({handlerName:I,handlerFactory:z}={}){if(this._loaded=!1,this._observer=new o.EnhancedEventEmitter,P.debug("constructor()"),I&&z)throw new TypeError("just one of handlerName or handlerInterface can be given");if(z)this._handlerFactory=z;else{if(I)P.debug("constructor() | handler given: %s",I);else if(I=L(),I)P.debug("constructor() | detected handler: %s",I);else throw new c.UnsupportedError("device not supported");switch(I){case"Chrome111":{this._handlerFactory=v.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=g.Chrome74.createFactory();break}case"Chrome70":{this._handlerFactory=_.Chrome70.createFactory();break}case"Chrome67":{this._handlerFactory=S.Chrome67.createFactory();break}case"Chrome55":{this._handlerFactory=E.Chrome55.createFactory();break}case"Firefox120":{this._handlerFactory=M.Firefox120.createFactory();break}case"Firefox60":{this._handlerFactory=R.Firefox60.createFactory();break}case"Safari12":{this._handlerFactory=N.Safari12.createFactory();break}case"Safari11":{this._handlerFactory=b.Safari11.createFactory();break}case"Edge11":{this._handlerFactory=m.Edge11.createFactory();break}case"ReactNativeUnifiedPlan":{this._handlerFactory=w.ReactNativeUnifiedPlan.createFactory();break}case"ReactNative":{this._handlerFactory=T.ReactNative.createFactory();break}default:throw new TypeError(`unknown handlerName "${I}"`)}}const K=this._handlerFactory();this._handlerName=K.name,K.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new c.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}load(I){return j(this,arguments,function*({routerRtpCapabilities:z}){P.debug("load() [routerRtpCapabilities:%o]",z);let K;try{if(this._loaded)throw new c.InvalidStateError("already loaded");const $=h.clone(z);d.validateRtpCapabilities($),K=this._handlerFactory();const te=yield K.getNativeRtpCapabilities();P.debug("load() | got native RTP capabilities:%o",te);const ee=h.clone(te);d.validateRtpCapabilities(ee),this._extendedRtpCapabilities=d.getExtendedRtpCapabilities(ee,$),P.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=d.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=d.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=d.getRecvRtpCapabilities(this._extendedRtpCapabilities),d.validateRtpCapabilities(this._recvRtpCapabilities),P.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=yield K.getNativeSctpCapabilities(),P.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),d.validateSctpCapabilities(this._sctpCapabilities),P.debug("load() succeeded"),this._loaded=!0,K.close()}catch($){throw K&&K.close(),$}})}canProduce(I){if(this._loaded){if(I!=="audio"&&I!=="video")throw new TypeError(`invalid kind "${I}"`)}else throw new c.InvalidStateError("not loaded");return this._canProduceByKind[I]}createSendTransport({id:I,iceParameters:z,iceCandidates:K,dtlsParameters:$,sctpParameters:te,iceServers:ee,iceTransportPolicy:de,additionalSettings:X,proprietaryConstraints:le,appData:_e}){return P.debug("createSendTransport()"),this.createTransport({direction:"send",id:I,iceParameters:z,iceCandidates:K,dtlsParameters:$,sctpParameters:te,iceServers:ee,iceTransportPolicy:de,additionalSettings:X,proprietaryConstraints:le,appData:_e})}createRecvTransport({id:I,iceParameters:z,iceCandidates:K,dtlsParameters:$,sctpParameters:te,iceServers:ee,iceTransportPolicy:de,additionalSettings:X,proprietaryConstraints:le,appData:_e}){return P.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:I,iceParameters:z,iceCandidates:K,dtlsParameters:$,sctpParameters:te,iceServers:ee,iceTransportPolicy:de,additionalSettings:X,proprietaryConstraints:le,appData:_e})}createTransport({direction:I,id:z,iceParameters:K,iceCandidates:$,dtlsParameters:te,sctpParameters:ee,iceServers:de,iceTransportPolicy:X,additionalSettings:le,proprietaryConstraints:_e,appData:Se}){if(this._loaded){if(typeof z!="string")throw new TypeError("missing id");if(typeof K!="object")throw new TypeError("missing iceParameters");if(Array.isArray($)){if(typeof te!="object")throw new TypeError("missing dtlsParameters");if(ee&&typeof ee!="object")throw new TypeError("wrong sctpParameters");if(Se&&typeof Se!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new c.InvalidStateError("not loaded");const De=new p.Transport({direction:I,id:z,iceParameters:K,iceCandidates:$,dtlsParameters:te,sctpParameters:ee,iceServers:de,iceTransportPolicy:X,additionalSettings:le,proprietaryConstraints:_e,appData:Se,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",De),De}};t.Device=k}}),zb=Fe({"../../node_modules/mediasoup-client/lib/RtpParameters.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0})}}),Gb=Fe({"../../node_modules/mediasoup-client/lib/SctpParameters.js"(t){ne(),Object.defineProperty(t,"__esModule",{value:!0})}}),qb=Fe({"../../node_modules/mediasoup-client/lib/types.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(n,r,s,o){o===void 0&&(o=s);var c=Object.getOwnPropertyDescriptor(r,s);(!c||("get"in c?!r.__esModule:c.writable||c.configurable))&&(c={enumerable:!0,get:function(){return r[s]}}),Object.defineProperty(n,o,c)}:function(n,r,s,o){o===void 0&&(o=s),n[o]=r[s]}),i=t&&t.__exportStar||function(n,r){for(var s in n)s!=="default"&&!Object.prototype.hasOwnProperty.call(r,s)&&e(r,n,s)};Object.defineProperty(t,"__esModule",{value:!0}),i(Vm(),t),i(Pm(),t),i(Cm(),t),i(Tm(),t),i(Rm(),t),i(Mm(),t),i(zb(),t),i(Gb(),t),i(Zn(),t),i(Mn(),t)}}),Wb=Fe({"../../node_modules/mediasoup-client/lib/index.js"(t){ne();var e=t&&t.__createBinding||(Object.create?function(d,p,v,g){g===void 0&&(g=v);var _=Object.getOwnPropertyDescriptor(p,v);(!_||("get"in _?!p.__esModule:_.writable||_.configurable))&&(_={enumerable:!0,get:function(){return p[v]}}),Object.defineProperty(d,g,_)}:function(d,p,v,g){g===void 0&&(g=v),d[g]=p[v]}),i=t&&t.__setModuleDefault||(Object.create?function(d,p){Object.defineProperty(d,"default",{enumerable:!0,value:p})}:function(d,p){d.default=p}),n=t&&t.__importStar||function(d){if(d&&d.__esModule)return d;var p={};if(d!=null)for(var v in d)v!=="default"&&Object.prototype.hasOwnProperty.call(d,v)&&e(p,d,v);return i(p,d),p},r=t&&t.__importDefault||function(d){return d&&d.__esModule?d:{default:d}};Object.defineProperty(t,"__esModule",{value:!0}),t.debug=t.parseScalabilityMode=t.detectDevice=t.Device=t.version=t.types=void 0;var s=r(Dl());t.debug=s.default;var o=Vm();Object.defineProperty(t,"Device",{enumerable:!0,get:function(){return o.Device}}),Object.defineProperty(t,"detectDevice",{enumerable:!0,get:function(){return o.detectDevice}});var c=n(qb());t.types=c,t.version="3.7.17";var h=Ps();Object.defineProperty(t,"parseScalabilityMode",{enumerable:!0,get:function(){return h.parse}})}});ne();ne();ne();ne();ne();ne();ne();var up=["disable","error","warn","info","debug"],Xo=class Eo{constructor(e){this.debug=(...i)=>(this._log("debug",...i),Date.now()),this.info=(...i)=>(this._log("info",...i),Date.now()),this.warn=(...i)=>{this._log("warn",...i)},this.error=(...i)=>{this._log("error",...i)},this.elapsed=(i,...n)=>{const r=Date.now()-i;this._log("info",`elapsed ms:${r}`,...n)},this.prefix=e}_log(e,...i){const n=up.indexOf(e);if(up.indexOf(Eo.level)>=n){const s=new Date(Date.now()+324e5).toISOString()+"+JST";i=[this.prefix,...i].map(h=>{if(h instanceof Error)return h.toJSON?h.toJSON():{name:h.name,message:h.message,stack:h.stack};if(typeof h=="object")try{return JSON.parse(JSON.stringify(h))}catch{return"json error"}return h});let c=[s,e,...i];switch(Eo.format==="string"&&(c=[s+" "+e+" "+JSON.stringify(i)]),e){case"debug":console.debug(...c);break;case"info":console.info(...c);break;case"warn":console.warn(...c);break;case"error":console.error(...c);break}Eo.onLog({id:Eo.id,timestamp:s,level:e,message:i})}}createBlock(e){return{warn:(...i)=>{this.warn(ae({},e),...i)},debug:(...i)=>{this.debug(ae({},e),...i)},info:(...i)=>{this.info(ae({},e),...i)},error:(...i)=>{this.error(ae({},e),...i)}}}};Xo.level="error";Xo.format="object";Xo.onLog=()=>{};Xo.id=Math.random().toString().slice(2,7);var ft=Xo,Kb=new ft("packages/common/src/error.ts"),Xn=class extends Error{constructor(t,e=!0){if(super(t.info.detail),this.id=Math.random().toString().slice(2,10),Object.assign(this,t),this.name=this.info.name,e){const i=["SkyWayError",`name:${this.info.name}, detail:${this.info.detail}, solution:${this.info.solution}`];this.path&&i.push(this.path),this.error&&i.push(this.error),this.payload&&i.push(this.payload),i.push(this.id),Kb.warn(...i)}}toJSON(){return{id:this.id,info:this.info,path:this.path,payload:this.payload,error:this.error,stack:this.stack}}};ne();var Xb=new ft("packages/common/src/event.ts"),gt=class{constructor(t=()=>{}){this._onSetListener=t,this._stack=[],this._eventIndex=0,this.emit=e=>{for(const i of this._stack)try{i.execute(e)}catch(n){Xb.error("task throws error",n)}},this.removeAllListeners=()=>{this._stack=[]},this.pipe=e=>this.add(i=>e.emit(i)),this.add=e=>{const i=this._eventIndex;this._stack.push({execute:e,id:i}),this._eventIndex++;const n=()=>{this._stack=this._stack.filter(s=>s.id!==i&&s)},r=s=>{s.push(n)};return this._onSetListener(),{removeListener:n,disposer:r}},this.once=e=>{const i=this.add(n=>{i.removeListener(),e(n)});return i},this.asPromise=e=>new Promise((i,n)=>{const r=e&&setTimeout(()=>{n(new hp("Event asPromise timeout : "+e))},e);this.once(s=>{r&&clearTimeout(r),i(s)})}),this.watch=(e,i)=>new Promise((n,r)=>{const s=i&&setTimeout(()=>{r(new hp("Event watch timeout : "+i))},i),{removeListener:o}=this.add(c=>{e(c)&&(s&&clearTimeout(s),o(),n(c))})})}get length(){return this._stack.length}},jr=class{constructor(){this.events=[]}make(){const t=new gt;return this.events.push(t),t}dispose(){this.events.forEach(t=>t.removeAllListeners()),this.events=[]}},Yn=class{constructor(){this._disposer=[]}push(t){this._disposer.push(t)}dispose(){this._disposer.forEach(t=>t()),this._disposer=[]}},hp=class extends Error{toJSON(){return{name:this.name,message:this.message,stack:this.stack}}};ne();ne();ne();ne();ne();function zm(t,e){return function(){return t.apply(e,arguments)}}var{toString:$b}=Object.prototype,{getPrototypeOf:Sh}=Object,{iterator:Nl,toStringTag:Gm}=Symbol,Ll=(t=>e=>{const i=$b.call(e);return t[i]||(t[i]=i.slice(8,-1).toLowerCase())})(Object.create(null)),Mr=t=>(t=t.toLowerCase(),e=>Ll(e)===t),Ol=t=>e=>typeof e===t,{isArray:to}=Array,Mo=Ol("undefined");function Zb(t){return t!==null&&!Mo(t)&&t.constructor!==null&&!Mo(t.constructor)&&kn(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}var qm=Mr("ArrayBuffer");function Yb(t){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(t):e=t&&t.buffer&&qm(t.buffer),e}var Jb=Ol("string"),kn=Ol("function"),Wm=Ol("number"),kl=t=>t!==null&&typeof t=="object",Qb=t=>t===!0||t===!1,Xc=t=>{if(Ll(t)!=="object")return!1;const e=Sh(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Gm in t)&&!(Nl in t)},ey=Mr("Date"),ty=Mr("File"),iy=Mr("Blob"),ny=Mr("FileList"),ry=t=>kl(t)&&kn(t.pipe),sy=t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||kn(t.append)&&((e=Ll(t))==="formdata"||e==="object"&&kn(t.toString)&&t.toString()==="[object FormData]"))},ay=Mr("URLSearchParams"),[oy,cy,ly,dy]=["ReadableStream","Request","Response","Headers"].map(Mr),uy=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function $o(t,e,{allOwnKeys:i=!1}={}){if(t===null||typeof t>"u")return;let n,r;if(typeof t!="object"&&(t=[t]),to(t))for(n=0,r=t.length;n<r;n++)e.call(null,t[n],n,t);else{const s=i?Object.getOwnPropertyNames(t):Object.keys(t),o=s.length;let c;for(n=0;n<o;n++)c=s[n],e.call(null,t[c],c,t)}}function Km(t,e){e=e.toLowerCase();const i=Object.keys(t);let n=i.length,r;for(;n-- >0;)if(r=i[n],e===r.toLowerCase())return r;return null}var $s=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Xm=t=>!Mo(t)&&t!==$s;function ou(){const{caseless:t}=Xm(this)&&this||{},e={},i=(n,r)=>{const s=t&&Km(e,r)||r;Xc(e[s])&&Xc(n)?e[s]=ou(e[s],n):Xc(n)?e[s]=ou({},n):to(n)?e[s]=n.slice():e[s]=n};for(let n=0,r=arguments.length;n<r;n++)arguments[n]&&$o(arguments[n],i);return e}var hy=(t,e,i,{allOwnKeys:n}={})=>($o(e,(r,s)=>{i&&kn(r)?t[s]=zm(r,i):t[s]=r},{allOwnKeys:n}),t),py=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),fy=(t,e,i,n)=>{t.prototype=Object.create(e.prototype,n),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),i&&Object.assign(t.prototype,i)},my=(t,e,i,n)=>{let r,s,o;const c={};if(e=e||{},t==null)return e;do{for(r=Object.getOwnPropertyNames(t),s=r.length;s-- >0;)o=r[s],(!n||n(o,t,e))&&!c[o]&&(e[o]=t[o],c[o]=!0);t=i!==!1&&Sh(t)}while(t&&(!i||i(t,e))&&t!==Object.prototype);return e},gy=(t,e,i)=>{t=String(t),(i===void 0||i>t.length)&&(i=t.length),i-=e.length;const n=t.indexOf(e,i);return n!==-1&&n===i},vy=t=>{if(!t)return null;if(to(t))return t;let e=t.length;if(!Wm(e))return null;const i=new Array(e);for(;e-- >0;)i[e]=t[e];return i},_y=(t=>e=>t&&e instanceof t)(typeof Uint8Array<"u"&&Sh(Uint8Array)),by=(t,e)=>{const n=(t&&t[Nl]).call(t);let r;for(;(r=n.next())&&!r.done;){const s=r.value;e.call(t,s[0],s[1])}},yy=(t,e)=>{let i;const n=[];for(;(i=t.exec(e))!==null;)n.push(i);return n},Sy=Mr("HTMLFormElement"),wy=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(i,n,r){return n.toUpperCase()+r}),pp=(({hasOwnProperty:t})=>(e,i)=>t.call(e,i))(Object.prototype),xy=Mr("RegExp"),$m=(t,e)=>{const i=Object.getOwnPropertyDescriptors(t),n={};$o(i,(r,s)=>{let o;(o=e(r,s,t))!==!1&&(n[s]=o||r)}),Object.defineProperties(t,n)},Ey=t=>{$m(t,(e,i)=>{if(kn(t)&&["arguments","caller","callee"].indexOf(i)!==-1)return!1;const n=t[i];if(kn(n)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")})}})},Cy=(t,e)=>{const i={},n=r=>{r.forEach(s=>{i[s]=!0})};return to(t)?n(t):n(String(t).split(e)),i},Ty=()=>{},Ry=(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e;function My(t){return!!(t&&kn(t.append)&&t[Gm]==="FormData"&&t[Nl])}var Py=t=>{const e=new Array(10),i=(n,r)=>{if(kl(n)){if(e.indexOf(n)>=0)return;if(!("toJSON"in n)){e[r]=n;const s=to(n)?[]:{};return $o(n,(o,c)=>{const h=i(o,r+1);!Mo(h)&&(s[c]=h)}),e[r]=void 0,s}}return n};return i(t,0)},Ay=Mr("AsyncFunction"),Dy=t=>t&&(kl(t)||kn(t))&&kn(t.then)&&kn(t.catch),Zm=((t,e)=>t?setImmediate:e?((i,n)=>($s.addEventListener("message",({source:r,data:s})=>{r===$s&&s===i&&n.length&&n.shift()()},!1),r=>{n.push(r),$s.postMessage(i,"*")}))(`axios@${Math.random()}`,[]):i=>setTimeout(i))(typeof setImmediate=="function",kn($s.postMessage)),Iy=typeof queueMicrotask<"u"?queueMicrotask.bind($s):typeof Oa<"u"&&Oa.nextTick||Zm,Fy=t=>t!=null&&kn(t[Nl]),ke={isArray:to,isArrayBuffer:qm,isBuffer:Zb,isFormData:sy,isArrayBufferView:Yb,isString:Jb,isNumber:Wm,isBoolean:Qb,isObject:kl,isPlainObject:Xc,isReadableStream:oy,isRequest:cy,isResponse:ly,isHeaders:dy,isUndefined:Mo,isDate:ey,isFile:ty,isBlob:iy,isRegExp:xy,isFunction:kn,isStream:ry,isURLSearchParams:ay,isTypedArray:_y,isFileList:ny,forEach:$o,merge:ou,extend:hy,trim:uy,stripBOM:py,inherits:fy,toFlatObject:my,kindOf:Ll,kindOfTest:Mr,endsWith:gy,toArray:vy,forEachEntry:by,matchAll:yy,isHTMLForm:Sy,hasOwnProperty:pp,hasOwnProp:pp,reduceDescriptors:$m,freezeMethods:Ey,toObjectSet:Cy,toCamelCase:wy,noop:Ty,toFiniteNumber:Ry,findKey:Km,global:$s,isContextDefined:Xm,isSpecCompliantForm:My,toJSONObject:Py,isAsyncFn:Ay,isThenable:Dy,setImmediate:Zm,asap:Iy,isIterable:Fy};ne();ne();ne();ne();ne();function Va(t,e,i,n,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),n&&(this.request=n),r&&(this.response=r,this.status=r.status?r.status:null)}ke.inherits(Va,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:ke.toJSONObject(this.config),code:this.code,status:this.status}}});var Ym=Va.prototype,Jm={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Jm[t]={value:t}});Object.defineProperties(Va,Jm);Object.defineProperty(Ym,"isAxiosError",{value:!0});Va.from=(t,e,i,n,r,s)=>{const o=Object.create(Ym);return ke.toFlatObject(t,o,function(h){return h!==Error.prototype},c=>c!=="isAxiosError"),Va.call(o,t.message,e,i,n,r),o.cause=t,o.name=t.name,s&&Object.assign(o,s),o};var Jt=Va;ne();var Ny=null;function cu(t){return ke.isPlainObject(t)||ke.isArray(t)}function Qm(t){return ke.endsWith(t,"[]")?t.slice(0,-2):t}function fp(t,e,i){return t?t.concat(e).map(function(r,s){return r=Qm(r),!i&&s?"["+r+"]":r}).join(i?".":""):e}function Ly(t){return ke.isArray(t)&&!t.some(cu)}var Oy=ke.toFlatObject(ke,{},null,function(e){return/^is[A-Z]/.test(e)});function ky(t,e,i){if(!ke.isObject(t))throw new TypeError("target must be an object");e=e||new FormData,i=ke.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,function(E,M){return!ke.isUndefined(M[E])});const n=i.metaTokens,r=i.visitor||p,s=i.dots,o=i.indexes,h=(i.Blob||typeof Blob<"u"&&Blob)&&ke.isSpecCompliantForm(e);if(!ke.isFunction(r))throw new TypeError("visitor must be a function");function d(S){if(S===null)return"";if(ke.isDate(S))return S.toISOString();if(!h&&ke.isBlob(S))throw new Jt("Blob is not supported. Use a Buffer instead.");return ke.isArrayBuffer(S)||ke.isTypedArray(S)?h&&typeof Blob=="function"?new Blob([S]):Buffer.from(S):S}function p(S,E,M){let R=S;if(S&&!M&&typeof S=="object"){if(ke.endsWith(E,"{}"))E=n?E:E.slice(0,-2),S=JSON.stringify(S);else if(ke.isArray(S)&&Ly(S)||(ke.isFileList(S)||ke.endsWith(E,"[]"))&&(R=ke.toArray(S)))return E=Qm(E),R.forEach(function(b,m){!(ke.isUndefined(b)||b===null)&&e.append(o===!0?fp([E],m,s):o===null?E:E+"[]",d(b))}),!1}return cu(S)?!0:(e.append(fp(M,E,s),d(S)),!1)}const v=[],g=Object.assign(Oy,{defaultVisitor:p,convertValue:d,isVisitable:cu});function _(S,E){if(!ke.isUndefined(S)){if(v.indexOf(S)!==-1)throw Error("Circular reference detected in "+E.join("."));v.push(S),ke.forEach(S,function(R,N){(!(ke.isUndefined(R)||R===null)&&r.call(e,R,ke.isString(N)?N.trim():N,E,g))===!0&&_(R,E?E.concat(N):[N])}),v.pop()}}if(!ke.isObject(t))throw new TypeError("data must be an object");return _(t),e}var Ul=ky;function mp(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function eg(t,e){this._pairs=[],t&&Ul(t,this,e)}var tg=eg.prototype;tg.append=function(e,i){this._pairs.push([e,i])};tg.toString=function(e){const i=e?function(n){return e.call(this,n,mp)}:mp;return this._pairs.map(function(r){return i(r[0])+"="+i(r[1])},"").join("&")};var ig=eg;function Uy(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function ng(t,e,i){if(!e)return t;const n=i&&i.encode||Uy;ke.isFunction(i)&&(i={serialize:i});const r=i&&i.serialize;let s;if(r?s=r(e,i):s=ke.isURLSearchParams(e)?e.toString():new ig(e,i).toString(n),s){const o=t.indexOf("#");o!==-1&&(t=t.slice(0,o)),t+=(t.indexOf("?")===-1?"?":"&")+s}return t}ne();var By=class{constructor(){this.handlers=[]}use(t,e,i){return this.handlers.push({fulfilled:t,rejected:e,synchronous:i?i.synchronous:!1,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){ke.forEach(this.handlers,function(i){i!==null&&t(i)})}},gp=By;ne();ne();ne();ne();var rg={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};ne();ne();ne();ne();var Hy=typeof URLSearchParams<"u"?URLSearchParams:ig;ne();var jy=typeof FormData<"u"?FormData:null;ne();var Vy=typeof Blob<"u"?Blob:null,zy={isBrowser:!0,classes:{URLSearchParams:Hy,FormData:jy,Blob:Vy},protocols:["http","https","file","blob","url","data"]},sg={};rm(sg,{hasBrowserEnv:()=>wh,hasStandardBrowserEnv:()=>Gy,hasStandardBrowserWebWorkerEnv:()=>qy,navigator:()=>lu,origin:()=>Wy});ne();var wh=typeof window<"u"&&typeof document<"u",lu=typeof navigator=="object"&&navigator||void 0,Gy=wh&&(!lu||["ReactNative","NativeScript","NS"].indexOf(lu.product)<0),qy=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",Wy=wh&&window.location.href||"http://localhost",vn=ae(ae({},sg),zy);function Ky(t,e){return Ul(t,new vn.classes.URLSearchParams,Object.assign({visitor:function(i,n,r,s){return vn.isNode&&ke.isBuffer(i)?(this.append(n,i.toString("base64")),!1):s.defaultVisitor.apply(this,arguments)}},e))}ne();function Xy(t){return ke.matchAll(/\w+|\[(\w*)]/g,t).map(e=>e[0]==="[]"?"":e[1]||e[0])}function $y(t){const e={},i=Object.keys(t);let n;const r=i.length;let s;for(n=0;n<r;n++)s=i[n],e[s]=t[s];return e}function Zy(t){function e(i,n,r,s){let o=i[s++];if(o==="__proto__")return!0;const c=Number.isFinite(+o),h=s>=i.length;return o=!o&&ke.isArray(r)?r.length:o,h?(ke.hasOwnProp(r,o)?r[o]=[r[o],n]:r[o]=n,!c):((!r[o]||!ke.isObject(r[o]))&&(r[o]=[]),e(i,n,r[o],s)&&ke.isArray(r[o])&&(r[o]=$y(r[o])),!c)}if(ke.isFormData(t)&&ke.isFunction(t.entries)){const i={};return ke.forEachEntry(t,(n,r)=>{e(Xy(n),r,i,0)}),i}return null}var ag=Zy;function Yy(t,e,i){if(ke.isString(t))try{return(e||JSON.parse)(t),ke.trim(t)}catch(n){if(n.name!=="SyntaxError")throw n}return(i||JSON.stringify)(t)}var xh={transitional:rg,adapter:["xhr","http","fetch"],transformRequest:[function(e,i){const n=i.getContentType()||"",r=n.indexOf("application/json")>-1,s=ke.isObject(e);if(s&&ke.isHTMLForm(e)&&(e=new FormData(e)),ke.isFormData(e))return r?JSON.stringify(ag(e)):e;if(ke.isArrayBuffer(e)||ke.isBuffer(e)||ke.isStream(e)||ke.isFile(e)||ke.isBlob(e)||ke.isReadableStream(e))return e;if(ke.isArrayBufferView(e))return e.buffer;if(ke.isURLSearchParams(e))return i.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let c;if(s){if(n.indexOf("application/x-www-form-urlencoded")>-1)return Ky(e,this.formSerializer).toString();if((c=ke.isFileList(e))||n.indexOf("multipart/form-data")>-1){const h=this.env&&this.env.FormData;return Ul(c?{"files[]":e}:e,h&&new h,this.formSerializer)}}return s||r?(i.setContentType("application/json",!1),Yy(e)):e}],transformResponse:[function(e){const i=this.transitional||xh.transitional,n=i&&i.forcedJSONParsing,r=this.responseType==="json";if(ke.isResponse(e)||ke.isReadableStream(e))return e;if(e&&ke.isString(e)&&(n&&!this.responseType||r)){const o=!(i&&i.silentJSONParsing)&&r;try{return JSON.parse(e)}catch(c){if(o)throw c.name==="SyntaxError"?Jt.from(c,Jt.ERR_BAD_RESPONSE,this,null,this.response):c}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:vn.classes.FormData,Blob:vn.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};ke.forEach(["delete","get","head","post","put","patch"],t=>{xh.headers[t]={}});var Eh=xh;ne();ne();var Jy=ke.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Qy=t=>{const e={};let i,n,r;return t&&t.split(`
`).forEach(function(o){r=o.indexOf(":"),i=o.substring(0,r).trim().toLowerCase(),n=o.substring(r+1).trim(),!(!i||e[i]&&Jy[i])&&(i==="set-cookie"?e[i]?e[i].push(n):e[i]=[n]:e[i]=e[i]?e[i]+", "+n:n)}),e},vp=Symbol("internals");function ho(t){return t&&String(t).trim().toLowerCase()}function $c(t){return t===!1||t==null?t:ke.isArray(t)?t.map($c):String(t)}function eS(t){const e=Object.create(null),i=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=i.exec(t);)e[n[1]]=n[2];return e}var tS=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function hd(t,e,i,n,r){if(ke.isFunction(n))return n.call(this,e,i);if(r&&(e=i),!!ke.isString(e)){if(ke.isString(n))return e.indexOf(n)!==-1;if(ke.isRegExp(n))return n.test(e)}}function iS(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,i,n)=>i.toUpperCase()+n)}function nS(t,e){const i=ke.toCamelCase(" "+e);["get","set","has"].forEach(n=>{Object.defineProperty(t,n+i,{value:function(r,s,o){return this[n].call(this,e,r,s,o)},configurable:!0})})}var Bl=class{constructor(t){t&&this.set(t)}set(t,e,i){const n=this;function r(o,c,h){const d=ho(c);if(!d)throw new Error("header name must be a non-empty string");const p=ke.findKey(n,d);(!p||n[p]===void 0||h===!0||h===void 0&&n[p]!==!1)&&(n[p||c]=$c(o))}const s=(o,c)=>ke.forEach(o,(h,d)=>r(h,d,c));if(ke.isPlainObject(t)||t instanceof this.constructor)s(t,e);else if(ke.isString(t)&&(t=t.trim())&&!tS(t))s(Qy(t),e);else if(ke.isObject(t)&&ke.isIterable(t)){let o={},c,h;for(const d of t){if(!ke.isArray(d))throw TypeError("Object iterator must return a key-value pair");o[h=d[0]]=(c=o[h])?ke.isArray(c)?[...c,d[1]]:[c,d[1]]:d[1]}s(o,e)}else t!=null&&r(e,t,i);return this}get(t,e){if(t=ho(t),t){const i=ke.findKey(this,t);if(i){const n=this[i];if(!e)return n;if(e===!0)return eS(n);if(ke.isFunction(e))return e.call(this,n,i);if(ke.isRegExp(e))return e.exec(n);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,e){if(t=ho(t),t){const i=ke.findKey(this,t);return!!(i&&this[i]!==void 0&&(!e||hd(this,this[i],i,e)))}return!1}delete(t,e){const i=this;let n=!1;function r(s){if(s=ho(s),s){const o=ke.findKey(i,s);o&&(!e||hd(i,i[o],o,e))&&(delete i[o],n=!0)}}return ke.isArray(t)?t.forEach(r):r(t),n}clear(t){const e=Object.keys(this);let i=e.length,n=!1;for(;i--;){const r=e[i];(!t||hd(this,this[r],r,t,!0))&&(delete this[r],n=!0)}return n}normalize(t){const e=this,i={};return ke.forEach(this,(n,r)=>{const s=ke.findKey(i,r);if(s){e[s]=$c(n),delete e[r];return}const o=t?iS(r):String(r).trim();o!==r&&delete e[r],e[o]=$c(n),i[o]=!0}),this}concat(...t){return this.constructor.concat(this,...t)}toJSON(t){const e=Object.create(null);return ke.forEach(this,(i,n)=>{i!=null&&i!==!1&&(e[n]=t&&ke.isArray(i)?i.join(", "):i)}),e}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([t,e])=>t+": "+e).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t,...e){const i=new this(t);return e.forEach(n=>i.set(n)),i}static accessor(t){const i=(this[vp]=this[vp]={accessors:{}}).accessors,n=this.prototype;function r(s){const o=ho(s);i[o]||(nS(n,s),i[o]=!0)}return ke.isArray(t)?t.forEach(r):r(t),this}};Bl.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);ke.reduceDescriptors(Bl.prototype,({value:t},e)=>{let i=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(n){this[i]=n}}});ke.freezeMethods(Bl);var wr=Bl;function pd(t,e){const i=this||Eh,n=e||i,r=wr.from(n.headers);let s=n.data;return ke.forEach(t,function(c){s=c.call(i,s,r.normalize(),e?e.status:void 0)}),r.normalize(),s}ne();function og(t){return!!(t&&t.__CANCEL__)}ne();function cg(t,e,i){Jt.call(this,t??"canceled",Jt.ERR_CANCELED,e,i),this.name="CanceledError"}ke.inherits(cg,Jt,{__CANCEL__:!0});var Zo=cg;ne();ne();ne();function lg(t,e,i){const n=i.config.validateStatus;!i.status||!n||n(i.status)?t(i):e(new Jt("Request failed with status code "+i.status,[Jt.ERR_BAD_REQUEST,Jt.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i))}ne();function rS(t){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}ne();ne();function sS(t,e){t=t||10;const i=new Array(t),n=new Array(t);let r=0,s=0,o;return e=e!==void 0?e:1e3,function(h){const d=Date.now(),p=n[s];o||(o=d),i[r]=h,n[r]=d;let v=s,g=0;for(;v!==r;)g+=i[v++],v=v%t;if(r=(r+1)%t,r===s&&(s=(s+1)%t),d-o<e)return;const _=p&&d-p;return _?Math.round(g*1e3/_):void 0}}var aS=sS;ne();function oS(t,e){let i=0,n=1e3/e,r,s;const o=(d,p=Date.now())=>{i=p,r=null,s&&(clearTimeout(s),s=null),t.apply(null,d)};return[(...d)=>{const p=Date.now(),v=p-i;v>=n?o(d,p):(r=d,s||(s=setTimeout(()=>{s=null,o(r)},n-v)))},()=>r&&o(r)]}var cS=oS,ll=(t,e,i=3)=>{let n=0;const r=aS(50,250);return cS(s=>{const o=s.loaded,c=s.lengthComputable?s.total:void 0,h=o-n,d=r(h),p=o<=c;n=o;const v={loaded:o,total:c,progress:c?o/c:void 0,bytes:h,rate:d||void 0,estimated:d&&c&&p?(c-o)/d:void 0,event:s,lengthComputable:c!=null,[e?"download":"upload"]:!0};t(v)},i)},_p=(t,e)=>{const i=t!=null;return[n=>e[0]({lengthComputable:i,total:t,loaded:n}),e[1]]},bp=t=>(...e)=>ke.asap(()=>t(...e));ne();ne();var lS=vn.hasStandardBrowserEnv?((t,e)=>i=>(i=new URL(i,vn.origin),t.protocol===i.protocol&&t.host===i.host&&(e||t.port===i.port)))(new URL(vn.origin),vn.navigator&&/(msie|trident)/i.test(vn.navigator.userAgent)):()=>!0;ne();var dS=vn.hasStandardBrowserEnv?{write(t,e,i,n,r,s){const o=[t+"="+encodeURIComponent(e)];ke.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),ke.isString(n)&&o.push("path="+n),ke.isString(r)&&o.push("domain="+r),s===!0&&o.push("secure"),document.cookie=o.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};ne();ne();function uS(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}ne();function hS(t,e){return e?t.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):t}function dg(t,e,i){let n=!uS(e);return t&&(n||i==!1)?hS(t,e):e}ne();var yp=t=>t instanceof wr?ae({},t):t;function ta(t,e){e=e||{};const i={};function n(d,p,v,g){return ke.isPlainObject(d)&&ke.isPlainObject(p)?ke.merge.call({caseless:g},d,p):ke.isPlainObject(p)?ke.merge({},p):ke.isArray(p)?p.slice():p}function r(d,p,v,g){if(ke.isUndefined(p)){if(!ke.isUndefined(d))return n(void 0,d,v,g)}else return n(d,p,v,g)}function s(d,p){if(!ke.isUndefined(p))return n(void 0,p)}function o(d,p){if(ke.isUndefined(p)){if(!ke.isUndefined(d))return n(void 0,d)}else return n(void 0,p)}function c(d,p,v){if(v in e)return n(d,p);if(v in t)return n(void 0,d)}const h={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:c,headers:(d,p,v)=>r(yp(d),yp(p),v,!0)};return ke.forEach(Object.keys(Object.assign({},t,e)),function(p){const v=h[p]||r,g=v(t[p],e[p],p);ke.isUndefined(g)&&v!==c||(i[p]=g)}),i}var ug=t=>{const e=ta({},t);let{data:i,withXSRFToken:n,xsrfHeaderName:r,xsrfCookieName:s,headers:o,auth:c}=e;e.headers=o=wr.from(o),e.url=ng(dg(e.baseURL,e.url,e.allowAbsoluteUrls),t.params,t.paramsSerializer),c&&o.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):"")));let h;if(ke.isFormData(i)){if(vn.hasStandardBrowserEnv||vn.hasStandardBrowserWebWorkerEnv)o.setContentType(void 0);else if((h=o.getContentType())!==!1){const[d,...p]=h?h.split(";").map(v=>v.trim()).filter(Boolean):[];o.setContentType([d||"multipart/form-data",...p].join("; "))}}if(vn.hasStandardBrowserEnv&&(n&&ke.isFunction(n)&&(n=n(e)),n||n!==!1&&lS(e.url))){const d=r&&s&&dS.read(s);d&&o.set(r,d)}return e},pS=typeof XMLHttpRequest<"u",fS=pS&&function(t){return new Promise(function(i,n){const r=ug(t);let s=r.data;const o=wr.from(r.headers).normalize();let{responseType:c,onUploadProgress:h,onDownloadProgress:d}=r,p,v,g,_,S;function E(){_&&_(),S&&S(),r.cancelToken&&r.cancelToken.unsubscribe(p),r.signal&&r.signal.removeEventListener("abort",p)}let M=new XMLHttpRequest;M.open(r.method.toUpperCase(),r.url,!0),M.timeout=r.timeout;function R(){if(!M)return;const b=wr.from("getAllResponseHeaders"in M&&M.getAllResponseHeaders()),w={data:!c||c==="text"||c==="json"?M.responseText:M.response,status:M.status,statusText:M.statusText,headers:b,config:t,request:M};lg(function(P){i(P),E()},function(P){n(P),E()},w),M=null}"onloadend"in M?M.onloadend=R:M.onreadystatechange=function(){!M||M.readyState!==4||M.status===0&&!(M.responseURL&&M.responseURL.indexOf("file:")===0)||setTimeout(R)},M.onabort=function(){M&&(n(new Jt("Request aborted",Jt.ECONNABORTED,t,M)),M=null)},M.onerror=function(){n(new Jt("Network Error",Jt.ERR_NETWORK,t,M)),M=null},M.ontimeout=function(){let m=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const w=r.transitional||rg;r.timeoutErrorMessage&&(m=r.timeoutErrorMessage),n(new Jt(m,w.clarifyTimeoutError?Jt.ETIMEDOUT:Jt.ECONNABORTED,t,M)),M=null},s===void 0&&o.setContentType(null),"setRequestHeader"in M&&ke.forEach(o.toJSON(),function(m,w){M.setRequestHeader(w,m)}),ke.isUndefined(r.withCredentials)||(M.withCredentials=!!r.withCredentials),c&&c!=="json"&&(M.responseType=r.responseType),d&&([g,S]=ll(d,!0),M.addEventListener("progress",g)),h&&M.upload&&([v,_]=ll(h),M.upload.addEventListener("progress",v),M.upload.addEventListener("loadend",_)),(r.cancelToken||r.signal)&&(p=b=>{M&&(n(!b||b.type?new Zo(null,t,M):b),M.abort(),M=null)},r.cancelToken&&r.cancelToken.subscribe(p),r.signal&&(r.signal.aborted?p():r.signal.addEventListener("abort",p)));const N=rS(r.url);if(N&&vn.protocols.indexOf(N)===-1){n(new Jt("Unsupported protocol "+N+":",Jt.ERR_BAD_REQUEST,t));return}M.send(s||null)})};ne();ne();var mS=(t,e)=>{const{length:i}=t=t?t.filter(Boolean):[];if(e||i){let n=new AbortController,r;const s=function(d){if(!r){r=!0,c();const p=d instanceof Error?d:this.reason;n.abort(p instanceof Jt?p:new Zo(p instanceof Error?p.message:p))}};let o=e&&setTimeout(()=>{o=null,s(new Jt(`timeout ${e} of ms exceeded`,Jt.ETIMEDOUT))},e);const c=()=>{t&&(o&&clearTimeout(o),o=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(s):d.removeEventListener("abort",s)}),t=null)};t.forEach(d=>d.addEventListener("abort",s));const{signal:h}=n;return h.unsubscribe=()=>ke.asap(c),h}},gS=mS;ne();var vS=function*(t,e){let i=t.byteLength;if(i<e){yield t;return}let n=0,r;for(;n<i;)r=n+e,yield t.slice(n,r),n=r},_S=function(t,e){return sm(this,null,function*(){try{for(var i=i0(bS(t)),n,r,s;n=!(r=yield new ja(i.next())).done;n=!1){const o=r.value;yield*am(vS(o,e))}}catch(o){s=[o]}finally{try{n&&(r=i.return)&&(yield new ja(r.call(i)))}finally{if(s)throw s[0]}}})},bS=function(t){return sm(this,null,function*(){if(t[Symbol.asyncIterator]){yield*am(t);return}const e=t.getReader();try{for(;;){const{done:i,value:n}=yield new ja(e.read());if(i)break;yield n}}finally{yield new ja(e.cancel())}})},Sp=(t,e,i,n)=>{const r=_S(t,e);let s=0,o,c=h=>{o||(o=!0,n&&n(h))};return new ReadableStream({pull(h){return j(this,null,function*(){try{const{done:d,value:p}=yield r.next();if(d){c(),h.close();return}let v=p.byteLength;if(i){let g=s+=v;i(g)}h.enqueue(new Uint8Array(p))}catch(d){throw c(d),d}})},cancel(h){return c(h),r.return()}},{highWaterMark:2})},Hl=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",hg=Hl&&typeof ReadableStream=="function",yS=Hl&&(typeof TextEncoder=="function"?(t=>e=>t.encode(e))(new TextEncoder):t=>j(null,null,function*(){return new Uint8Array(yield new Response(t).arrayBuffer())})),pg=(t,...e)=>{try{return!!t(...e)}catch{return!1}},SS=hg&&pg(()=>{let t=!1;const e=new Request(vn.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),wp=64*1024,du=hg&&pg(()=>ke.isReadableStream(new Response("").body)),dl={stream:du&&(t=>t.body)};Hl&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!dl[e]&&(dl[e]=ke.isFunction(t[e])?i=>i[e]():(i,n)=>{throw new Jt(`Response type '${e}' is not supported`,Jt.ERR_NOT_SUPPORT,n)})})})(new Response);var wS=t=>j(null,null,function*(){if(t==null)return 0;if(ke.isBlob(t))return t.size;if(ke.isSpecCompliantForm(t))return(yield new Request(vn.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(ke.isArrayBufferView(t)||ke.isArrayBuffer(t))return t.byteLength;if(ke.isURLSearchParams(t)&&(t=t+""),ke.isString(t))return(yield yS(t)).byteLength}),xS=(t,e)=>j(null,null,function*(){const i=ke.toFiniteNumber(t.getContentLength());return i??wS(e)}),ES=Hl&&(t=>j(null,null,function*(){let{url:e,method:i,data:n,signal:r,cancelToken:s,timeout:o,onDownloadProgress:c,onUploadProgress:h,responseType:d,headers:p,withCredentials:v="same-origin",fetchOptions:g}=ug(t);d=d?(d+"").toLowerCase():"text";let _=gS([r,s&&s.toAbortSignal()],o),S;const E=_&&_.unsubscribe&&(()=>{_.unsubscribe()});let M;try{if(h&&SS&&i!=="get"&&i!=="head"&&(M=yield xS(p,n))!==0){let w=new Request(e,{method:"POST",body:n,duplex:"half"}),T;if(ke.isFormData(n)&&(T=w.headers.get("content-type"))&&p.setContentType(T),w.body){const[P,L]=_p(M,ll(bp(h)));n=Sp(w.body,wp,P,L)}}ke.isString(v)||(v=v?"include":"omit");const R="credentials"in Request.prototype;S=new Request(e,we(ae({},g),{signal:_,method:i.toUpperCase(),headers:p.normalize().toJSON(),body:n,duplex:"half",credentials:R?v:void 0}));let N=yield fetch(S);const b=du&&(d==="stream"||d==="response");if(du&&(c||b&&E)){const w={};["status","statusText","headers"].forEach(k=>{w[k]=N[k]});const T=ke.toFiniteNumber(N.headers.get("content-length")),[P,L]=c&&_p(T,ll(bp(c),!0))||[];N=new Response(Sp(N.body,wp,P,()=>{L&&L(),E&&E()}),w)}d=d||"text";let m=yield dl[ke.findKey(dl,d)||"text"](N,t);return!b&&E&&E(),yield new Promise((w,T)=>{lg(w,T,{data:m,headers:wr.from(N.headers),status:N.status,statusText:N.statusText,config:t,request:S})})}catch(R){throw E&&E(),R&&R.name==="TypeError"&&/Load failed|fetch/i.test(R.message)?Object.assign(new Jt("Network Error",Jt.ERR_NETWORK,t,S),{cause:R.cause||R}):Jt.from(R,R&&R.code,t,S)}})),uu={http:Ny,xhr:fS,fetch:ES};ke.forEach(uu,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});var xp=t=>`- ${t}`,CS=t=>ke.isFunction(t)||t===null||t===!1,fg={getAdapter:t=>{t=ke.isArray(t)?t:[t];const{length:e}=t;let i,n;const r={};for(let s=0;s<e;s++){i=t[s];let o;if(n=i,!CS(i)&&(n=uu[(o=String(i)).toLowerCase()],n===void 0))throw new Jt(`Unknown adapter '${o}'`);if(n)break;r[o||"#"+s]=n}if(!n){const s=Object.entries(r).map(([c,h])=>`adapter ${c} `+(h===!1?"is not supported by the environment":"is not available in the build"));let o=e?s.length>1?`since :
`+s.map(xp).join(`
`):" "+xp(s[0]):"as no adapter specified";throw new Jt("There is no suitable adapter to dispatch the request "+o,"ERR_NOT_SUPPORT")}return n},adapters:uu};function fd(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Zo(null,t)}function Ep(t){return fd(t),t.headers=wr.from(t.headers),t.data=pd.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),fg.getAdapter(t.adapter||Eh.adapter)(t).then(function(n){return fd(t),n.data=pd.call(t,t.transformResponse,n),n.headers=wr.from(n.headers),n},function(n){return og(n)||(fd(t),n&&n.response&&(n.response.data=pd.call(t,t.transformResponse,n.response),n.response.headers=wr.from(n.response.headers))),Promise.reject(n)})}ne();ne();var mg="1.9.0",jl={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{jl[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});var Cp={};jl.transitional=function(e,i,n){function r(s,o){return"[Axios v"+mg+"] Transitional option '"+s+"'"+o+(n?". "+n:"")}return(s,o,c)=>{if(e===!1)throw new Jt(r(o," has been removed"+(i?" in "+i:"")),Jt.ERR_DEPRECATED);return i&&!Cp[o]&&(Cp[o]=!0,console.warn(r(o," has been deprecated since v"+i+" and will be removed in the near future"))),e?e(s,o,c):!0}};jl.spelling=function(e){return(i,n)=>(console.warn(`${n} is likely a misspelling of ${e}`),!0)};function TS(t,e,i){if(typeof t!="object")throw new Jt("options must be an object",Jt.ERR_BAD_OPTION_VALUE);const n=Object.keys(t);let r=n.length;for(;r-- >0;){const s=n[r],o=e[s];if(o){const c=t[s],h=c===void 0||o(c,s,t);if(h!==!0)throw new Jt("option "+s+" must be "+h,Jt.ERR_BAD_OPTION_VALUE);continue}if(i!==!0)throw new Jt("Unknown option "+s,Jt.ERR_BAD_OPTION)}}var Zc={assertOptions:TS,validators:jl},Fr=Zc.validators,ul=class{constructor(t){this.defaults=t||{},this.interceptors={request:new gp,response:new gp}}request(t,e){return j(this,null,function*(){try{return yield this._request(t,e)}catch(i){if(i instanceof Error){let n={};Error.captureStackTrace?Error.captureStackTrace(n):n=new Error;const r=n.stack?n.stack.replace(/^.+\n/,""):"";try{i.stack?r&&!String(i.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+r):i.stack=r}catch{}}throw i}})}_request(t,e){typeof t=="string"?(e=e||{},e.url=t):e=t||{},e=ta(this.defaults,e);const{transitional:i,paramsSerializer:n,headers:r}=e;i!==void 0&&Zc.assertOptions(i,{silentJSONParsing:Fr.transitional(Fr.boolean),forcedJSONParsing:Fr.transitional(Fr.boolean),clarifyTimeoutError:Fr.transitional(Fr.boolean)},!1),n!=null&&(ke.isFunction(n)?e.paramsSerializer={serialize:n}:Zc.assertOptions(n,{encode:Fr.function,serialize:Fr.function},!0)),e.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?e.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:e.allowAbsoluteUrls=!0),Zc.assertOptions(e,{baseUrl:Fr.spelling("baseURL"),withXsrfToken:Fr.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let s=r&&ke.merge(r.common,r[e.method]);r&&ke.forEach(["delete","get","head","post","put","patch","common"],_=>{delete r[_]}),e.headers=wr.concat(s,r);const o=[];let c=!0;this.interceptors.request.forEach(function(S){typeof S.runWhen=="function"&&S.runWhen(e)===!1||(c=c&&S.synchronous,o.unshift(S.fulfilled,S.rejected))});const h=[];this.interceptors.response.forEach(function(S){h.push(S.fulfilled,S.rejected)});let d,p=0,v;if(!c){const _=[Ep.bind(this),void 0];for(_.unshift.apply(_,o),_.push.apply(_,h),v=_.length,d=Promise.resolve(e);p<v;)d=d.then(_[p++],_[p++]);return d}v=o.length;let g=e;for(p=0;p<v;){const _=o[p++],S=o[p++];try{g=_(g)}catch(E){S.call(this,E);break}}try{d=Ep.call(this,g)}catch(_){return Promise.reject(_)}for(p=0,v=h.length;p<v;)d=d.then(h[p++],h[p++]);return d}getUri(t){t=ta(this.defaults,t);const e=dg(t.baseURL,t.url,t.allowAbsoluteUrls);return ng(e,t.params,t.paramsSerializer)}};ke.forEach(["delete","get","head","options"],function(e){ul.prototype[e]=function(i,n){return this.request(ta(n||{},{method:e,url:i,data:(n||{}).data}))}});ke.forEach(["post","put","patch"],function(e){function i(n){return function(s,o,c){return this.request(ta(c||{},{method:e,headers:n?{"Content-Type":"multipart/form-data"}:{},url:s,data:o}))}}ul.prototype[e]=i(),ul.prototype[e+"Form"]=i(!0)});var Yc=ul;ne();var RS=class gg{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let i;this.promise=new Promise(function(s){i=s});const n=this;this.promise.then(r=>{if(!n._listeners)return;let s=n._listeners.length;for(;s-- >0;)n._listeners[s](r);n._listeners=null}),this.promise.then=r=>{let s;const o=new Promise(c=>{n.subscribe(c),s=c}).then(r);return o.cancel=function(){n.unsubscribe(s)},o},e(function(s,o,c){n.reason||(n.reason=new Zo(s,o,c),i(n.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const i=this._listeners.indexOf(e);i!==-1&&this._listeners.splice(i,1)}toAbortSignal(){const e=new AbortController,i=n=>{e.abort(n)};return this.subscribe(i),e.signal.unsubscribe=()=>this.unsubscribe(i),e.signal}static source(){let e;return{token:new gg(function(r){e=r}),cancel:e}}},MS=RS;ne();function PS(t){return function(i){return t.apply(null,i)}}ne();function AS(t){return ke.isObject(t)&&t.isAxiosError===!0}ne();var hu={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(hu).forEach(([t,e])=>{hu[e]=t});var DS=hu;function vg(t){const e=new Yc(t),i=zm(Yc.prototype.request,e);return ke.extend(i,Yc.prototype,e,{allOwnKeys:!0}),ke.extend(i,e,null,{allOwnKeys:!0}),i.create=function(r){return vg(ta(t,r))},i}var Ki=vg(Eh);Ki.Axios=Yc;Ki.CanceledError=Zo;Ki.CancelToken=MS;Ki.isCancel=og;Ki.VERSION=mg;Ki.toFormData=Ul;Ki.AxiosError=Jt;Ki.Cancel=Ki.CanceledError;Ki.all=function(e){return Promise.all(e)};Ki.spread=PS;Ki.isAxiosError=AS;Ki.mergeConfig=ta;Ki.AxiosHeaders=wr;Ki.formToJSON=t=>ag(ke.isHTMLForm(t)?new FormData(t):t);Ki.getAdapter=fg.getAdapter;Ki.HttpStatusCode=DS;Ki.default=Ki;var Pa=Ki,{Axios:QA,AxiosError:e2,CanceledError:t2,isCancel:i2,CancelToken:n2,VERSION:r2,all:s2,Cancel:a2,isAxiosError:o2,spread:c2,toFormData:l2,AxiosHeaders:d2,HttpStatusCode:u2,formToJSON:h2,getAdapter:p2,mergeConfig:f2}=Pa,ur=new ft("packages/common/src/http.ts"),Ch=class{constructor(t){this.api=Pa.create({baseURL:t})}get(t,e){return j(this,null,function*(){const i=yield this.api.get(t,e).catch(n=>n);if(Pa.isAxiosError(i)){const n=we(ae({},i.response),{message:i.message});if(e!=null&&e.retry){if(yield e.retry(n))return ur.warn("retry get",{url:t}),this.get(t,e);throw ur.warn("retry get failed",{url:t}),n}throw ur.warn("response error",{error:n}),n}else return i.data})}post(t,e,i){return j(this,null,function*(){var n,r,s;const o=yield this.api.post(t,e,i).catch(c=>c);if(Pa.isAxiosError(o)){const c={data:(n=o.response)==null?void 0:n.data,status:(r=o.response)==null?void 0:r.status,statusText:(s=o.response)==null?void 0:s.statusText,message:o.message};if(ur.warn("error received",c),i!=null&&i.retry){const h=yield i.retry(c);if(h)return ur.warn("retry post",t,{data:e,error:c,needRetry:h}),this.post(t,e,i);throw c}throw c}else return o.data})}put(t,e,i){return j(this,null,function*(){const n=yield this.api.put(t,e,i).catch(r=>r);if(Pa.isAxiosError(n)){const r=we(ae({},n.response),{message:n.message});if(i!=null&&i.retry){if(yield i.retry(r))return ur.warn("retry put",{url:t,data:e}),this.put(t,e,i);throw ur.warn("retry put failed",{url:t,data:e}),r}throw ur.warn("response error",{error:r}),r}else return n.data})}delete(t,e){return j(this,null,function*(){const i=yield this.api.delete(t,e).catch(n=>n);if(Pa.isAxiosError(i)){const n=we(ae({},i.response),{message:i.message});if(e!=null&&e.retry){if(yield e.retry(n))return ur.warn("retry delete",{url:t}),this.delete(t,e);throw ur.warn("retry delete failed",{url:t}),n}throw ur.warn("response error",{error:n}),n}else return i.data})}};ne();var IS=new ft("packages/common/src/promise.ts"),As=class{constructor(){this.id=Math.random().toString().slice(2),this.queue=[],this.running=!1,this.push=t=>new Promise((e,i)=>{this.queue.push({promise:t,done:e,failed:i}),this.running||this.run().catch(n=>{IS.error("push",n)})})}run(){return j(this,null,function*(){const t=this.queue.shift();if(t){this.running=!0;try{const e=yield t.promise();t.done(e)}catch(e){t.failed(e)}yield this.run()}else this.running=!1})}};ne();var br=class{constructor(t={}){this.count=0,this.times=8,this.interval=100,this.jitter=0,Object.assign(this,t)}wait(){return j(this,null,function*(){if(this.exceeded)return!1;const t=this.timeout;return this.count++,yield new Promise(e=>setTimeout(e,t)),!0})}get timeout(){return ns(this.count,2)*this.interval+ns(this.count,2)*this.jitter*Math.random()}get exceeded(){return this.count>=this.times}reset(){this.count=0}},FS=t=>JSON.parse(JSON.stringify(t));ne();var Je={internal:{name:"internal",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},missingProperty:{name:"missingProperty",detail:"",solution:""},notFound:{name:"notFound",detail:"",solution:""},invalidParameter:{name:"invalidParameter",detail:"",solution:""},invalidArgumentValue:{name:"invalidArgumentValue",detail:"",solution:""},invalidContentType:{name:"invalidContentType",detail:"contentType",solution:"ContentType"},localPersonNotJoinedChannel:{name:"localPersonNotJoinedChannel",detail:"PersonChannel The person who tried to operate is not in the channel, so the operation is not possible",solution:"ChannelPerson Please check as you may be operating a person which is not in the channel"},alreadyLocalPersonExist:{name:"alreadyLocalPersonExist",detail:"ChannelLocalPersonChannelLocalPersonJoin",solution:"LocalPersonChannel"},alreadySameNameMemberExist:{name:"alreadySameNameMemberExist",detail:"ChannelNameMember",solution:"Name"},alreadyPublishedStream:{name:"alreadyPublishedStream",detail:"PublishStreamPublish You cannot re-publish a stream that has already been published",solution:"StreamPublishPublicationUnpublishStreamPublish Unpublish the publication that published that stream, or create another new stream and publish it"},alreadySubscribedPublication:{name:"alreadySubscribedPublication",detail:"SubscribePublicationSubscribe",solution:""},invalidTrackKind:{name:"invalidTrackKind",detail:"StreamMediaStreamTrack",solution:"StreamMediaStreamTrack"},cantMoveSameIdChannel:{name:"cantMoveSameIdChannel",detail:"moveChannelidChannel",solution:"Channel"},alreadyChannelClosed:{name:"alreadyChannelClosed",detail:"ChannelClose",solution:""},disabledDataStream:{name:"disabledDataStream",detail:"PublicationDisableDataStream",solution:"PublicationEnable"},publicationNotExist:{name:"publicationNotExist",detail:"channelPublication",solution:"publicationId"},subscriptionNotExist:{name:"subscriptionNotExist",detail:"channelSubscription",solution:"subscriptionId"},unknownMemberType:{name:"unknownMemberType",detail:"MemberSubtype",solution:"MemberSubtype(SfuBot)SkyWayContext"},streamNotExistInSubscription:{name:"streamNotExistInSubscription",detail:"SubscriptionStreamRemoteMemberSubscriptionStream",solution:"Subscription"},streamNotExistInPublication:{name:"streamNotExistInPublication",detail:"PublicationStreamRemoteMemberPublicationStream",solution:"Publication"},dataStreamNotSupportEncoding:{name:"dataStreamNotSupportEncoding",detail:"dataStreamEncode",solution:""},correspondingEncodeNotExistForId:{name:"correspondingEncodeNotExistForId",detail:"IDEncode",solution:"EncodingID"},updateIceParamsFailed:{name:"updateIceParamsFailed",detail:"iceParams",solution:""},invalidElement:{name:"invalidElement",detail:"HTML Element",solution:"Element"},connectRtcApiFailed:{name:"connectRtcApiFailed",detail:"RtcAPI",solution:"Token"},rtcApiFatalError:{name:"rtcApiFatalError",detail:"RtcAPI",solution:""},invalidExpireTokenValue:{name:"invalidExpireTokenValue",detail:"tokenExpire",solution:""},invalidRemindExpireTokenValue:{name:"invalidRemindExpireTokenValue",detail:"tokenExpire",solution:""},invalidTokenAppId:{name:"invalidTokenAppId",detail:"tokenappId",solution:"appIdToken"},mediaDevicesNotFound:{name:"mediaDevicesNotFound",detail:"navigator.mediaDevices",solution:"https,localhost,127.0.0.1"},canNotUseReplaceStream:{name:"canNotUseReplaceStream",detail:"remotePublicationreplaceStream",solution:"PublicationLocal"},canNotEnableRemotePublication:{name:"canNotEnableRemotePublication",detail:"remotePublicationenable",solution:"PublicationLocal"}};ne();ne();ne();var NS=Hn(n0());Hn(ln());var LS=Hn(om()),OS=new ft("packages/core/src/util.ts");function za(t){const e=[];return t.forEach(i=>{e.push(i)}),e}function Gt(t){return j(this,arguments,function*({operationName:e,channel:i}){const n={operationName:e,appId:i.appId,channelId:i.id};if(i.localPerson){const r=i.localPerson,s=yield Promise.all(r.publications.map(c=>j(null,null,function*(){var h,d,p;const v={id:c.id,contentType:c.contentType,state:c.state,stats:{},connectionStats:{}};if(c.stream)for(const{memberId:g,stats:_}of yield c.stream._getStatsAll()){const S=_.find(E=>E.type.includes("local-candidate"));v.stats[g]={transportType:(h=S==null?void 0:S.protocol)!=null?h:"none",relayProtocol:(d=S==null?void 0:S.relayProtocol)!=null?d:"none",callType:(p=c.subscriptions.find(E=>E.subscriber.id===g))==null?void 0:p.subscriber.subtype,outbound:_.find(E=>E.type.includes("outbound-rtp")),localCandidate:S}}if(c.stream)for(const{memberId:g,connectionState:_}of c.stream._getConnectionStateAll())v.connectionStats[g]=_;return v})));n.publishing=s;const o=yield Promise.all(r.subscriptions.map(c=>j(null,null,function*(){const h={id:c.id,contentType:c.contentType,stats:{}};if(h.callType=c.publication.publisher.subtype,c.stream){const d=yield c.stream.getStats();h.stats=d.find(v=>v.type.includes("inbound-rtp"));const p=d.find(v=>v.type.includes("local-candidate"));h.transportType=p==null?void 0:p.protocol,h.relayProtocol=p==null?void 0:p.relayProtocol}return c.stream&&(h.connectionState=c.stream.getConnectionState()),h})));n.subscribing=o}return n})}function qi({member:t,detail:e,channel:i,operationName:n,payload:r}){const s={operationName:n,payload:r,detail:e};return t&&(s.appId=t.channel.appId,s.channelId=t.channel.id,s.memberId=t.id),i&&(s.appId=i.appId,s.channelId=i.id),s}function je({operationName:t,context:e,info:i,error:n,path:r,payload:s,channel:o}){const c={operationName:t,payload:s};return o&&(c.appId=o.appId,c.channelId=o.id,o.localPerson&&(c.memberId=o.localPerson.id)),e&&(c.info=e.info,c.plugins=e.plugins.map(h=>h.subtype)),new Xn({error:n,info:i,payload:c,path:r})}var Tp=t=>j(null,[t],function*({stream:e,remoteMember:i,end:n,interval:r,timeout:s}){return new Promise((o,c)=>j(null,null,function*(){r??(r=100),s??(s=1e4);for(let h=0;;h+=r){if(h>=s){c(je({operationName:"Peer.waitForStats",info:we(ae({},Je.timeout),{detail:"waitForStats timeout"}),path:OS.prefix}));break}const d=yield e._getStats(i);if(n(d)){o(d);break}yield new Promise(p=>setTimeout(p,r))}}))}),kS=(t,e)=>{var i,n;return _g((n=(i=t.find(r=>r.payload===e))==null?void 0:i.config)!=null?n:"")},_g=t=>t.split(";").reduce((i,n)=>{const[r,s]=n.split("=");return r&&(i[r]=Number(s),r==="profile-level-id"&&(i[r]=s)),i},{}),bg=({isNotBrowser:t}={})=>{if(t)return t;const e=NS.default.getParser(window.navigator.userAgent),i=e.getOSName(),n=e.getOSVersion(),r=e.getBrowserName(),s=e.getBrowserVersion();return{browserName:r,browserVersion:s,osName:i,osVersion:n}};function Rp(){var t,e,i,n,r,s,o,c;if(typeof navigator=="object"&&navigator.product==="ReactNative")return typeof RTCPeerConnection>"u"?void 0:typeof RTCRtpTransceiver<"u"?"ReactNativeUnifiedPlan":"ReactNative";if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){const h=navigator.userAgent,d=new LS.UAParser(h),p=d.getBrowser(),v=(e=(t=p.name)==null?void 0:t.toLowerCase())!=null?e:"",g=parseInt((i=p.major)!=null?i:"0"),S=(r=(n=d.getEngine().name)==null?void 0:n.toLowerCase())!=null?r:"",E=d.getOS(),M=(o=(s=E.name)==null?void 0:s.toLowerCase())!=null?o:"",R=parseFloat((c=E.version)!=null?c:"0"),N=M==="ios",b=["chrome","chromium","mobile chrome","chrome webview","chrome headless"].includes(v),m=["firefox","mobile firefox","mobile focus"].includes(v),w=["safari","mobile safari"].includes(v),T=["edge"].includes(v);if((b||T)&&!N&&g>=111)return"Chrome111";if(b&&!N&&g>=74||T&&!N&&g>=88)return"Chrome74";if(b&&!N&&g>=70)return"Chrome70";if(b&&!N&&g>=67)return"Chrome67";if(b&&!N&&g>=55)return"Chrome55";if(m&&!N&&g>=60)return"Firefox60";if(m&&N&&R>=14.3)return"Safari12";if(w&&g>=12&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(w&&g>=11)return"Safari11";if(T&&!N&&g>=11&&g<=18)return"Edge11";if(S==="webkit"&&N&&R>=14.3&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(S==="blink"){const P=h.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(P){const L=Number(P[1]);return L>=111?"Chrome111":L>=74?"Chrome74":L>=70?"Chrome70":L>=67?"Chrome67":"Chrome55"}else return"Chrome111"}else return}else return}var md=new ft("packages/core/src/member/index.ts"),Vl=class{constructor(t){this._state="joined",this._events=new jr,this.onLeft=this._events.make(),this.onMetadataUpdated=this._events.make(),this.channel=t.channel,this.id=t.id,this.name=t.name,this._metadata=t.metadata,this.context=t.context}get metadata(){return this._metadata}get state(){return this._state}get publications(){return this.channel.publications.filter(t=>t.publisher.id===this.id)}get subscriptions(){return this.channel.subscriptions.filter(t=>t.subscriber.id===this.id)}toJSON(){return{id:this.id,name:this.name,type:this.type,subtype:this.subtype,metadata:this.metadata}}_left(){this._state="left",this.onLeft.emit(),this._events.dispose()}_metadataUpdated(t){this._metadata=t,this.onMetadataUpdated.emit(t)}updateMetadata(t){return j(this,null,function*(){yield this.channel._updateMemberMetadata(this.id,t)})}leave(){return j(this,null,function*(){const t=md.info("[start] leave",yield Gt({operationName:"localPerson.leave",channel:this.channel}));if(this.state==="left")throw je({operationName:"localPerson.leave",info:Je.localPersonNotJoinedChannel,path:md.prefix,context:this.context,channel:this.channel});yield this.channel.leave(this),md.elapsed(t,"[end] leave")})}};ne();ne();var bc=new ft("packages/core/src/plugin/internal/unknown/connection.ts"),US=class{constructor(t,e){this.localPerson=t,this.remoteMember=e,this.type="unknown",this.onDisconnect=new gt,this.onClose=new gt,this.closed=!1}close(){this.closed=!0,this.onClose.emit()}startPublishing(t){return j(this,null,function*(){bc.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{publication:t})})}stopPublishing(t){return j(this,null,function*(){bc.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{publication:t})})}startSubscribing(t){return j(this,null,function*(){bc.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{subscription:t})})}stopSubscribing(t){return j(this,null,function*(){bc.debug(`this is unknown type connection. should install ${this.remoteMember.subtype} plugin`,{subscription:t})})}},yg=class extends Vl{constructor(t){super(t),this.type="bot",this.side="remote",this._connections={},this.plugin=t.plugin,this.subtype=t.subtype}_getConnection(t){return this._connections[t]}_getOrCreateConnection(t){var e;return(e=this._getConnection(t.id))!=null?e:this._createConnection(t,this)}_createConnection(t,e){return new US(t,e)}_dispose(){}};ne();ne();ne();ne();ne();ne();var Sg=new ft("packages/core/src/media/stream/base.ts");function wg(t,e){var i;if(((i=t??{})==null?void 0:i.srcObject)===void 0)throw je({operationName:"attachElement",info:Je.invalidElement,payload:{element:t},path:Sg.prefix});if(t.srcObject){const n=t.srcObject,r=n.getTracks().find(o=>o.readyState==="ended");r&&n.removeTrack(r);const s=n.getTracks().find(o=>o.kind===e.kind);s&&n.removeTrack(s),n.addTrack(e)}else t.srcObject=new MediaStream([e])}function xg(t,e){var i;if(((i=t??{})==null?void 0:i.srcObject)===void 0)throw je({operationName:"attachElement",info:Je.invalidElement,payload:{element:t},path:Sg.prefix});const n=t.srcObject;n.getTracks().length>0&&n.removeTrack(e),n.getTracks().length===0&&(t.srcObject=null)}ne();ne();ne();ne();var yc,BS=new Uint8Array(16);function HS(){if(!yc&&(yc=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!yc))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return yc(BS)}ne();ne();ne();var jS=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function VS(t){return typeof t=="string"&&jS.test(t)}var zS=VS,cn=[];for(let t=0;t<256;++t)cn.push((t+256).toString(16).slice(1));function GS(t,e=0){return cn[t[e+0]]+cn[t[e+1]]+cn[t[e+2]]+cn[t[e+3]]+"-"+cn[t[e+4]]+cn[t[e+5]]+"-"+cn[t[e+6]]+cn[t[e+7]]+"-"+cn[t[e+8]]+cn[t[e+9]]+"-"+cn[t[e+10]]+cn[t[e+11]]+cn[t[e+12]]+cn[t[e+13]]+cn[t[e+14]]+cn[t[e+15]]}ne();ne();var qS=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Mp={randomUUID:qS};function WS(t,e,i){if(Mp.randomUUID&&!e&&!t)return Mp.randomUUID();t=t||{};const n=t.random||(t.rng||HS)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){i=i||0;for(let r=0;r<16;++r)e[i+r]=n[r];return e}return GS(n)}var Vr=WS;ne();var KS=Hn(a0());ne();function pu(t){this.message=t}pu.prototype=new Error,pu.prototype.name="InvalidCharacterError";var Pp=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(t){var e=String(t).replace(/=+$/,"");if(e.length%4==1)throw new pu("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,n,r=0,s=0,o="";n=e.charAt(s++);~n&&(i=r%4?64*i+n:n,r++%4)?o+=String.fromCharCode(255&i>>(-2*r&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return o};function XS(t){var e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(i){return decodeURIComponent(Pp(i).replace(/(.)/g,function(n,r){var s=r.charCodeAt(0).toString(16).toUpperCase();return s.length<2&&(s="0"+s),"%"+s}))}(e)}catch{return Pp(e)}}function hl(t){this.message=t}function $S(t,e){if(typeof t!="string")throw new hl("Invalid token specified");var i=(e=e||{}).header===!0?0:1;try{return JSON.parse(XS(t.split(".")[i]))}catch(n){throw new hl("Invalid token specified: "+n.message)}}hl.prototype=new Error,hl.prototype.name="InvalidTokenError";var ZS=$S;ne();ne();var at={};rm(at,{BRAND:()=>ww,DIRTY:()=>Da,EMPTY_PATH:()=>ew,INVALID:()=>Dt,NEVER:()=>sx,OK:()=>Rn,ParseStatus:()=>Bn,Schema:()=>Kt,ZodAny:()=>Wa,ZodArray:()=>na,ZodBigInt:()=>Do,ZodBoolean:()=>Io,ZodBranded:()=>Th,ZodCatch:()=>Vo,ZodDate:()=>Fo,ZodDefault:()=>jo,ZodDiscriminatedUnion:()=>Dg,ZodEffects:()=>Cr,ZodEnum:()=>Yo,ZodError:()=>xr,ZodFirstPartyTypeKind:()=>Ft,ZodFunction:()=>Lg,ZodIntersection:()=>ko,ZodIssueCode:()=>$e,ZodLazy:()=>Uo,ZodLiteral:()=>Bo,ZodMap:()=>vl,ZodNaN:()=>bl,ZodNativeEnum:()=>Ho,ZodNever:()=>rs,ZodNull:()=>Lo,ZodNullable:()=>Cs,ZodNumber:()=>Ao,ZodObject:()=>sr,ZodOptional:()=>kr,ZodParsedType:()=>pt,ZodPipeline:()=>Rh,ZodPromise:()=>Ka,ZodReadonly:()=>zo,ZodRecord:()=>Ng,ZodSchema:()=>Kt,ZodSet:()=>_l,ZodString:()=>qa,ZodSymbol:()=>ml,ZodTransformer:()=>Cr,ZodTuple:()=>Es,ZodType:()=>Kt,ZodUndefined:()=>No,ZodUnion:()=>Oo,ZodUnknown:()=>Qs,ZodVoid:()=>gl,addIssueToContext:()=>lt,any:()=>Dw,array:()=>Lw,bigint:()=>Tw,boolean:()=>jg,coerce:()=>rx,custom:()=>Ug,date:()=>Rw,datetimeRegex:()=>Pg,defaultErrorMap:()=>Ga,discriminatedUnion:()=>Bw,effect:()=>Ip,enum:()=>Xw,function:()=>qw,getErrorMap:()=>pl,getParsedType:()=>Jr,instanceof:()=>Ew,intersection:()=>Hw,isAborted:()=>mu,isAsync:()=>Po,isDirty:()=>gu,isValid:()=>ia,late:()=>xw,lazy:()=>Ww,literal:()=>Kw,makeIssue:()=>fl,map:()=>zw,nan:()=>Cw,nativeEnum:()=>$w,never:()=>Fw,null:()=>Aw,nullable:()=>Jw,number:()=>Hg,object:()=>Ow,objectUtil:()=>fu,oboolean:()=>nx,onumber:()=>ix,optional:()=>Yw,ostring:()=>tx,pipeline:()=>ex,preprocess:()=>Qw,promise:()=>Zw,quotelessJson:()=>YS,record:()=>Vw,set:()=>Gw,setErrorMap:()=>QS,strictObject:()=>kw,string:()=>Bg,symbol:()=>Mw,transformer:()=>Ip,tuple:()=>jw,undefined:()=>Pw,union:()=>Uw,unknown:()=>Iw,util:()=>ni,void:()=>Nw});ne();ne();ne();ne();ne();var ni;(function(t){t.assertEqual=r=>{};function e(r){}t.assertIs=e;function i(r){throw new Error}t.assertNever=i,t.arrayToEnum=r=>{const s={};for(const o of r)s[o]=o;return s},t.getValidEnumValues=r=>{const s=t.objectKeys(r).filter(c=>typeof r[r[c]]!="number"),o={};for(const c of s)o[c]=r[c];return t.objectValues(o)},t.objectValues=r=>t.objectKeys(r).map(function(s){return r[s]}),t.objectKeys=typeof Object.keys=="function"?r=>Object.keys(r):r=>{const s=[];for(const o in r)Object.prototype.hasOwnProperty.call(r,o)&&s.push(o);return s},t.find=(r,s)=>{for(const o of r)if(s(o))return o},t.isInteger=typeof Number.isInteger=="function"?r=>Number.isInteger(r):r=>typeof r=="number"&&Number.isFinite(r)&&Math.floor(r)===r;function n(r,s=" | "){return r.map(o=>typeof o=="string"?`'${o}'`:o).join(s)}t.joinValues=n,t.jsonStringifyReplacer=(r,s)=>typeof s=="bigint"?s.toString():s})(ni||(ni={}));var fu;(function(t){t.mergeShapes=(e,i)=>ae(ae({},e),i)})(fu||(fu={}));var pt=ni.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Jr=t=>{switch(typeof t){case"undefined":return pt.undefined;case"string":return pt.string;case"number":return Number.isNaN(t)?pt.nan:pt.number;case"boolean":return pt.boolean;case"function":return pt.function;case"bigint":return pt.bigint;case"symbol":return pt.symbol;case"object":return Array.isArray(t)?pt.array:t===null?pt.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?pt.promise:typeof Map<"u"&&t instanceof Map?pt.map:typeof Set<"u"&&t instanceof Set?pt.set:typeof Date<"u"&&t instanceof Date?pt.date:pt.object;default:return pt.unknown}},$e=ni.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),YS=t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:"),xr=class Eg extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const i=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,i):this.__proto__=i,this.name="ZodError",this.issues=e}format(e){const i=e||function(s){return s.message},n={_errors:[]},r=s=>{for(const o of s.issues)if(o.code==="invalid_union")o.unionErrors.map(r);else if(o.code==="invalid_return_type")r(o.returnTypeError);else if(o.code==="invalid_arguments")r(o.argumentsError);else if(o.path.length===0)n._errors.push(i(o));else{let c=n,h=0;for(;h<o.path.length;){const d=o.path[h];h===o.path.length-1?(c[d]=c[d]||{_errors:[]},c[d]._errors.push(i(o))):c[d]=c[d]||{_errors:[]},c=c[d],h++}}};return r(this),n}static assert(e){if(!(e instanceof Eg))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,ni.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=i=>i.message){const i={},n=[];for(const r of this.issues)r.path.length>0?(i[r.path[0]]=i[r.path[0]]||[],i[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:i}}get formErrors(){return this.flatten()}};xr.create=t=>new xr(t);var JS=(t,e)=>{let i;switch(t.code){case $e.invalid_type:t.received===pt.undefined?i="Required":i=`Expected ${t.expected}, received ${t.received}`;break;case $e.invalid_literal:i=`Invalid literal value, expected ${JSON.stringify(t.expected,ni.jsonStringifyReplacer)}`;break;case $e.unrecognized_keys:i=`Unrecognized key(s) in object: ${ni.joinValues(t.keys,", ")}`;break;case $e.invalid_union:i="Invalid input";break;case $e.invalid_union_discriminator:i=`Invalid discriminator value. Expected ${ni.joinValues(t.options)}`;break;case $e.invalid_enum_value:i=`Invalid enum value. Expected ${ni.joinValues(t.options)}, received '${t.received}'`;break;case $e.invalid_arguments:i="Invalid function arguments";break;case $e.invalid_return_type:i="Invalid function return type";break;case $e.invalid_date:i="Invalid date";break;case $e.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(i=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(i=`${i} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?i=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?i=`Invalid input: must end with "${t.validation.endsWith}"`:ni.assertNever(t.validation):t.validation!=="regex"?i=`Invalid ${t.validation}`:i="Invalid";break;case $e.too_small:t.type==="array"?i=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?i=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?i=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?i=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:i="Invalid input";break;case $e.too_big:t.type==="array"?i=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?i=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?i=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?i=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?i=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:i="Invalid input";break;case $e.custom:i="Invalid input";break;case $e.invalid_intersection_types:i="Intersection results could not be merged";break;case $e.not_multiple_of:i=`Number must be a multiple of ${t.multipleOf}`;break;case $e.not_finite:i="Number must be finite";break;default:i=e.defaultError,ni.assertNever(t)}return{message:i}},Ga=JS,Cg=Ga;function QS(t){Cg=t}function pl(){return Cg}ne();var fl=t=>{const{data:e,path:i,errorMaps:n,issueData:r}=t,s=[...i,...r.path||[]],o=we(ae({},r),{path:s});if(r.message!==void 0)return we(ae({},r),{path:s,message:r.message});let c="";const h=n.filter(d=>!!d).slice().reverse();for(const d of h)c=d(o,{data:e,defaultError:c}).message;return we(ae({},r),{path:s,message:c})},ew=[];function lt(t,e){const i=pl(),n=fl({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,i,i===Ga?void 0:Ga].filter(r=>!!r)});t.common.issues.push(n)}var Bn=class Tg{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,i){const n=[];for(const r of i){if(r.status==="aborted")return Dt;r.status==="dirty"&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static mergeObjectAsync(e,i){return j(this,null,function*(){const n=[];for(const r of i){const s=yield r.key,o=yield r.value;n.push({key:s,value:o})}return Tg.mergeObjectSync(e,n)})}static mergeObjectSync(e,i){const n={};for(const r of i){const{key:s,value:o}=r;if(s.status==="aborted"||o.status==="aborted")return Dt;s.status==="dirty"&&e.dirty(),o.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof o.value<"u"||r.alwaysSet)&&(n[s.value]=o.value)}return{status:e.value,value:n}}},Dt=Object.freeze({status:"aborted"}),Da=t=>({status:"dirty",value:t}),Rn=t=>({status:"valid",value:t}),mu=t=>t.status==="aborted",gu=t=>t.status==="dirty",ia=t=>t.status==="valid",Po=t=>typeof Promise<"u"&&t instanceof Promise;ne();ne();ne();var Et;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(Et||(Et={}));var Hr=class{constructor(t,e,i,n){this._cachedPath=[],this.parent=t,this.data=e,this._path=i,this._key=n}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},Ap=(t,e)=>{if(ia(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const i=new xr(t.common.issues);return this._error=i,this._error}}};function Vt(t){if(!t)return{};const{errorMap:e,invalid_type_error:i,required_error:n,description:r}=t;if(e&&(i||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:r}:{errorMap:(o,c)=>{var h,d;const{message:p}=t;return o.code==="invalid_enum_value"?{message:p??c.defaultError}:typeof c.data>"u"?{message:(h=p??n)!=null?h:c.defaultError}:o.code!=="invalid_type"?{message:c.defaultError}:{message:(d=p??i)!=null?d:c.defaultError}},description:r}}var Kt=class{get description(){return this._def.description}_getType(t){return Jr(t.data)}_getOrReturnCtx(t,e){return e||{common:t.parent.common,data:t.data,parsedType:Jr(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}_processInputParams(t){return{status:new Bn,ctx:{common:t.parent.common,data:t.data,parsedType:Jr(t.data),schemaErrorMap:this._def.errorMap,path:t.path,parent:t.parent}}}_parseSync(t){const e=this._parse(t);if(Po(e))throw new Error("Synchronous parse encountered promise.");return e}_parseAsync(t){const e=this._parse(t);return Promise.resolve(e)}parse(t,e){const i=this.safeParse(t,e);if(i.success)return i.data;throw i.error}safeParse(t,e){var i;const n={common:{issues:[],async:(i=e==null?void 0:e.async)!=null?i:!1,contextualErrorMap:e==null?void 0:e.errorMap},path:(e==null?void 0:e.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Jr(t)},r=this._parseSync({data:t,path:n.path,parent:n});return Ap(n,r)}"~validate"(t){var e,i;const n={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Jr(t)};if(!this["~standard"].async)try{const r=this._parseSync({data:t,path:[],parent:n});return ia(r)?{value:r.value}:{issues:n.common.issues}}catch(r){(i=(e=r==null?void 0:r.message)==null?void 0:e.toLowerCase())!=null&&i.includes("encountered")&&(this["~standard"].async=!0),n.common={issues:[],async:!0}}return this._parseAsync({data:t,path:[],parent:n}).then(r=>ia(r)?{value:r.value}:{issues:n.common.issues})}parseAsync(t,e){return j(this,null,function*(){const i=yield this.safeParseAsync(t,e);if(i.success)return i.data;throw i.error})}safeParseAsync(t,e){return j(this,null,function*(){const i={common:{issues:[],contextualErrorMap:e==null?void 0:e.errorMap,async:!0},path:(e==null?void 0:e.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:t,parsedType:Jr(t)},n=this._parse({data:t,path:i.path,parent:i}),r=yield Po(n)?n:Promise.resolve(n);return Ap(i,r)})}refine(t,e){const i=n=>typeof e=="string"||typeof e>"u"?{message:e}:typeof e=="function"?e(n):e;return this._refinement((n,r)=>{const s=t(n),o=()=>r.addIssue(ae({code:$e.custom},i(n)));return typeof Promise<"u"&&s instanceof Promise?s.then(c=>c?!0:(o(),!1)):s?!0:(o(),!1)})}refinement(t,e){return this._refinement((i,n)=>t(i)?!0:(n.addIssue(typeof e=="function"?e(i,n):e),!1))}_refinement(t){return new Cr({schema:this,typeName:Ft.ZodEffects,effect:{type:"refinement",refinement:t}})}superRefine(t){return this._refinement(t)}constructor(t){this.spa=this.safeParseAsync,this._def=t,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return kr.create(this,this._def)}nullable(){return Cs.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return na.create(this)}promise(){return Ka.create(this,this._def)}or(t){return Oo.create([this,t],this._def)}and(t){return ko.create(this,t,this._def)}transform(t){return new Cr(we(ae({},Vt(this._def)),{schema:this,typeName:Ft.ZodEffects,effect:{type:"transform",transform:t}}))}default(t){const e=typeof t=="function"?t:()=>t;return new jo(we(ae({},Vt(this._def)),{innerType:this,defaultValue:e,typeName:Ft.ZodDefault}))}brand(){return new Th(ae({typeName:Ft.ZodBranded,type:this},Vt(this._def)))}catch(t){const e=typeof t=="function"?t:()=>t;return new Vo(we(ae({},Vt(this._def)),{innerType:this,catchValue:e,typeName:Ft.ZodCatch}))}describe(t){const e=this.constructor;return new e(we(ae({},this._def),{description:t}))}pipe(t){return Rh.create(this,t)}readonly(){return zo.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},tw=/^c[^\s-]{8,}$/i,iw=/^[0-9a-z]+$/,nw=/^[0-9A-HJKMNP-TV-Z]{26}$/i,rw=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,sw=/^[a-z0-9_-]{21}$/i,aw=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,ow=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,cw=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,lw="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",gd,dw=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,uw=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,hw=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,pw=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,fw=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,mw=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Rg="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",gw=new RegExp(`^${Rg}$`);function Mg(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const i=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${i}`}function vw(t){return new RegExp(`^${Mg(t)}$`)}function Pg(t){let e=`${Rg}T${Mg(t)}`;const i=[];return i.push(t.local?"Z?":"Z"),t.offset&&i.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${i.join("|")})`,new RegExp(`^${e}$`)}function _w(t,e){return!!((e==="v4"||!e)&&dw.test(t)||(e==="v6"||!e)&&hw.test(t))}function bw(t,e){if(!aw.test(t))return!1;try{const[i]=t.split("."),n=i.replace(/-/g,"+").replace(/_/g,"/").padEnd(i.length+(4-i.length%4)%4,"="),r=JSON.parse(atob(n));return!(typeof r!="object"||r===null||"typ"in r&&(r==null?void 0:r.typ)!=="JWT"||!r.alg||e&&r.alg!==e)}catch{return!1}}function yw(t,e){return!!((e==="v4"||!e)&&uw.test(t)||(e==="v6"||!e)&&pw.test(t))}var qa=class Co extends Kt{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==pt.string){const s=this._getOrReturnCtx(e);return lt(s,{code:$e.invalid_type,expected:pt.string,received:s.parsedType}),Dt}const n=new Bn;let r;for(const s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="max")e.data.length>s.value&&(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),n.dirty());else if(s.kind==="length"){const o=e.data.length>s.value,c=e.data.length<s.value;(o||c)&&(r=this._getOrReturnCtx(e,r),o?lt(r,{code:$e.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):c&&lt(r,{code:$e.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),n.dirty())}else if(s.kind==="email")cw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"email",code:$e.invalid_string,message:s.message}),n.dirty());else if(s.kind==="emoji")gd||(gd=new RegExp(lw,"u")),gd.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"emoji",code:$e.invalid_string,message:s.message}),n.dirty());else if(s.kind==="uuid")rw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"uuid",code:$e.invalid_string,message:s.message}),n.dirty());else if(s.kind==="nanoid")sw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"nanoid",code:$e.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid")tw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"cuid",code:$e.invalid_string,message:s.message}),n.dirty());else if(s.kind==="cuid2")iw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"cuid2",code:$e.invalid_string,message:s.message}),n.dirty());else if(s.kind==="ulid")nw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"ulid",code:$e.invalid_string,message:s.message}),n.dirty());else if(s.kind==="url")try{new URL(e.data)}catch{r=this._getOrReturnCtx(e,r),lt(r,{validation:"url",code:$e.invalid_string,message:s.message}),n.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"regex",code:$e.invalid_string,message:s.message}),n.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),n.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.invalid_string,validation:{startsWith:s.value},message:s.message}),n.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.invalid_string,validation:{endsWith:s.value},message:s.message}),n.dirty()):s.kind==="datetime"?Pg(s).test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.invalid_string,validation:"datetime",message:s.message}),n.dirty()):s.kind==="date"?gw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.invalid_string,validation:"date",message:s.message}),n.dirty()):s.kind==="time"?vw(s).test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.invalid_string,validation:"time",message:s.message}),n.dirty()):s.kind==="duration"?ow.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"duration",code:$e.invalid_string,message:s.message}),n.dirty()):s.kind==="ip"?_w(e.data,s.version)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"ip",code:$e.invalid_string,message:s.message}),n.dirty()):s.kind==="jwt"?bw(e.data,s.alg)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"jwt",code:$e.invalid_string,message:s.message}),n.dirty()):s.kind==="cidr"?yw(e.data,s.version)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"cidr",code:$e.invalid_string,message:s.message}),n.dirty()):s.kind==="base64"?fw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"base64",code:$e.invalid_string,message:s.message}),n.dirty()):s.kind==="base64url"?mw.test(e.data)||(r=this._getOrReturnCtx(e,r),lt(r,{validation:"base64url",code:$e.invalid_string,message:s.message}),n.dirty()):ni.assertNever(s);return{status:n.value,value:e.data}}_regex(e,i,n){return this.refinement(r=>e.test(r),ae({validation:i,code:$e.invalid_string},Et.errToObj(n)))}_addCheck(e){return new Co(we(ae({},this._def),{checks:[...this._def.checks,e]}))}email(e){return this._addCheck(ae({kind:"email"},Et.errToObj(e)))}url(e){return this._addCheck(ae({kind:"url"},Et.errToObj(e)))}emoji(e){return this._addCheck(ae({kind:"emoji"},Et.errToObj(e)))}uuid(e){return this._addCheck(ae({kind:"uuid"},Et.errToObj(e)))}nanoid(e){return this._addCheck(ae({kind:"nanoid"},Et.errToObj(e)))}cuid(e){return this._addCheck(ae({kind:"cuid"},Et.errToObj(e)))}cuid2(e){return this._addCheck(ae({kind:"cuid2"},Et.errToObj(e)))}ulid(e){return this._addCheck(ae({kind:"ulid"},Et.errToObj(e)))}base64(e){return this._addCheck(ae({kind:"base64"},Et.errToObj(e)))}base64url(e){return this._addCheck(ae({kind:"base64url"},Et.errToObj(e)))}jwt(e){return this._addCheck(ae({kind:"jwt"},Et.errToObj(e)))}ip(e){return this._addCheck(ae({kind:"ip"},Et.errToObj(e)))}cidr(e){return this._addCheck(ae({kind:"cidr"},Et.errToObj(e)))}datetime(e){var i,n;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck(ae({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(i=e==null?void 0:e.offset)!=null?i:!1,local:(n=e==null?void 0:e.local)!=null?n:!1},Et.errToObj(e==null?void 0:e.message)))}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck(ae({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision},Et.errToObj(e==null?void 0:e.message)))}duration(e){return this._addCheck(ae({kind:"duration"},Et.errToObj(e)))}regex(e,i){return this._addCheck(ae({kind:"regex",regex:e},Et.errToObj(i)))}includes(e,i){return this._addCheck(ae({kind:"includes",value:e,position:i==null?void 0:i.position},Et.errToObj(i==null?void 0:i.message)))}startsWith(e,i){return this._addCheck(ae({kind:"startsWith",value:e},Et.errToObj(i)))}endsWith(e,i){return this._addCheck(ae({kind:"endsWith",value:e},Et.errToObj(i)))}min(e,i){return this._addCheck(ae({kind:"min",value:e},Et.errToObj(i)))}max(e,i){return this._addCheck(ae({kind:"max",value:e},Et.errToObj(i)))}length(e,i){return this._addCheck(ae({kind:"length",value:e},Et.errToObj(i)))}nonempty(e){return this.min(1,Et.errToObj(e))}trim(){return new Co(we(ae({},this._def),{checks:[...this._def.checks,{kind:"trim"}]}))}toLowerCase(){return new Co(we(ae({},this._def),{checks:[...this._def.checks,{kind:"toLowerCase"}]}))}toUpperCase(){return new Co(we(ae({},this._def),{checks:[...this._def.checks,{kind:"toUpperCase"}]}))}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const i of this._def.checks)i.kind==="min"&&(e===null||i.value>e)&&(e=i.value);return e}get maxLength(){let e=null;for(const i of this._def.checks)i.kind==="max"&&(e===null||i.value<e)&&(e=i.value);return e}};qa.create=t=>{var e;return new qa(ae({checks:[],typeName:Ft.ZodString,coerce:(e=t==null?void 0:t.coerce)!=null?e:!1},Vt(t)))};function Sw(t,e){const i=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,r=i>n?i:n,s=Number.parseInt(t.toFixed(r).replace(".","")),o=Number.parseInt(e.toFixed(r).replace(".",""));return s%o/ns(10,r)}var Ao=class vu extends Kt{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==pt.number){const s=this._getOrReturnCtx(e);return lt(s,{code:$e.invalid_type,expected:pt.number,received:s.parsedType}),Dt}let n;const r=new Bn;for(const s of this._def.checks)s.kind==="int"?ni.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.invalid_type,expected:"integer",received:"float",message:s.message}),r.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),r.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),r.dirty()):s.kind==="multipleOf"?Sw(e.data,s.value)!==0&&(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.not_multiple_of,multipleOf:s.value,message:s.message}),r.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.not_finite,message:s.message}),r.dirty()):ni.assertNever(s);return{status:r.value,value:e.data}}gte(e,i){return this.setLimit("min",e,!0,Et.toString(i))}gt(e,i){return this.setLimit("min",e,!1,Et.toString(i))}lte(e,i){return this.setLimit("max",e,!0,Et.toString(i))}lt(e,i){return this.setLimit("max",e,!1,Et.toString(i))}setLimit(e,i,n,r){return new vu(we(ae({},this._def),{checks:[...this._def.checks,{kind:e,value:i,inclusive:n,message:Et.toString(r)}]}))}_addCheck(e){return new vu(we(ae({},this._def),{checks:[...this._def.checks,e]}))}int(e){return this._addCheck({kind:"int",message:Et.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:Et.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:Et.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:Et.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:Et.toString(e)})}multipleOf(e,i){return this._addCheck({kind:"multipleOf",value:e,message:Et.toString(i)})}finite(e){return this._addCheck({kind:"finite",message:Et.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:Et.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:Et.toString(e)})}get minValue(){let e=null;for(const i of this._def.checks)i.kind==="min"&&(e===null||i.value>e)&&(e=i.value);return e}get maxValue(){let e=null;for(const i of this._def.checks)i.kind==="max"&&(e===null||i.value<e)&&(e=i.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&ni.isInteger(e.value))}get isFinite(){let e=null,i=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(i===null||n.value>i)&&(i=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(i)&&Number.isFinite(e)}};Ao.create=t=>new Ao(ae({checks:[],typeName:Ft.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1},Vt(t)));var Do=class _u extends Kt{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==pt.bigint)return this._getInvalidInput(e);let n;const r=new Bn;for(const s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),r.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),r.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),lt(n,{code:$e.not_multiple_of,multipleOf:s.value,message:s.message}),r.dirty()):ni.assertNever(s);return{status:r.value,value:e.data}}_getInvalidInput(e){const i=this._getOrReturnCtx(e);return lt(i,{code:$e.invalid_type,expected:pt.bigint,received:i.parsedType}),Dt}gte(e,i){return this.setLimit("min",e,!0,Et.toString(i))}gt(e,i){return this.setLimit("min",e,!1,Et.toString(i))}lte(e,i){return this.setLimit("max",e,!0,Et.toString(i))}lt(e,i){return this.setLimit("max",e,!1,Et.toString(i))}setLimit(e,i,n,r){return new _u(we(ae({},this._def),{checks:[...this._def.checks,{kind:e,value:i,inclusive:n,message:Et.toString(r)}]}))}_addCheck(e){return new _u(we(ae({},this._def),{checks:[...this._def.checks,e]}))}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:Et.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:Et.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:Et.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:Et.toString(e)})}multipleOf(e,i){return this._addCheck({kind:"multipleOf",value:e,message:Et.toString(i)})}get minValue(){let e=null;for(const i of this._def.checks)i.kind==="min"&&(e===null||i.value>e)&&(e=i.value);return e}get maxValue(){let e=null;for(const i of this._def.checks)i.kind==="max"&&(e===null||i.value<e)&&(e=i.value);return e}};Do.create=t=>{var e;return new Do(ae({checks:[],typeName:Ft.ZodBigInt,coerce:(e=t==null?void 0:t.coerce)!=null?e:!1},Vt(t)))};var Io=class extends Kt{_parse(t){if(this._def.coerce&&(t.data=!!t.data),this._getType(t)!==pt.boolean){const i=this._getOrReturnCtx(t);return lt(i,{code:$e.invalid_type,expected:pt.boolean,received:i.parsedType}),Dt}return Rn(t.data)}};Io.create=t=>new Io(ae({typeName:Ft.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1},Vt(t)));var Fo=class Ag extends Kt{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==pt.date){const s=this._getOrReturnCtx(e);return lt(s,{code:$e.invalid_type,expected:pt.date,received:s.parsedType}),Dt}if(Number.isNaN(e.data.getTime())){const s=this._getOrReturnCtx(e);return lt(s,{code:$e.invalid_date}),Dt}const n=new Bn;let r;for(const s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),n.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(r=this._getOrReturnCtx(e,r),lt(r,{code:$e.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),n.dirty()):ni.assertNever(s);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Ag(we(ae({},this._def),{checks:[...this._def.checks,e]}))}min(e,i){return this._addCheck({kind:"min",value:e.getTime(),message:Et.toString(i)})}max(e,i){return this._addCheck({kind:"max",value:e.getTime(),message:Et.toString(i)})}get minDate(){let e=null;for(const i of this._def.checks)i.kind==="min"&&(e===null||i.value>e)&&(e=i.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const i of this._def.checks)i.kind==="max"&&(e===null||i.value<e)&&(e=i.value);return e!=null?new Date(e):null}};Fo.create=t=>new Fo(ae({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:Ft.ZodDate},Vt(t)));var ml=class extends Kt{_parse(t){if(this._getType(t)!==pt.symbol){const i=this._getOrReturnCtx(t);return lt(i,{code:$e.invalid_type,expected:pt.symbol,received:i.parsedType}),Dt}return Rn(t.data)}};ml.create=t=>new ml(ae({typeName:Ft.ZodSymbol},Vt(t)));var No=class extends Kt{_parse(t){if(this._getType(t)!==pt.undefined){const i=this._getOrReturnCtx(t);return lt(i,{code:$e.invalid_type,expected:pt.undefined,received:i.parsedType}),Dt}return Rn(t.data)}};No.create=t=>new No(ae({typeName:Ft.ZodUndefined},Vt(t)));var Lo=class extends Kt{_parse(t){if(this._getType(t)!==pt.null){const i=this._getOrReturnCtx(t);return lt(i,{code:$e.invalid_type,expected:pt.null,received:i.parsedType}),Dt}return Rn(t.data)}};Lo.create=t=>new Lo(ae({typeName:Ft.ZodNull},Vt(t)));var Wa=class extends Kt{constructor(){super(...arguments),this._any=!0}_parse(t){return Rn(t.data)}};Wa.create=t=>new Wa(ae({typeName:Ft.ZodAny},Vt(t)));var Qs=class extends Kt{constructor(){super(...arguments),this._unknown=!0}_parse(t){return Rn(t.data)}};Qs.create=t=>new Qs(ae({typeName:Ft.ZodUnknown},Vt(t)));var rs=class extends Kt{_parse(t){const e=this._getOrReturnCtx(t);return lt(e,{code:$e.invalid_type,expected:pt.never,received:e.parsedType}),Dt}};rs.create=t=>new rs(ae({typeName:Ft.ZodNever},Vt(t)));var gl=class extends Kt{_parse(t){if(this._getType(t)!==pt.undefined){const i=this._getOrReturnCtx(t);return lt(i,{code:$e.invalid_type,expected:pt.void,received:i.parsedType}),Dt}return Rn(t.data)}};gl.create=t=>new gl(ae({typeName:Ft.ZodVoid},Vt(t)));var na=class Jc extends Kt{_parse(e){const{ctx:i,status:n}=this._processInputParams(e),r=this._def;if(i.parsedType!==pt.array)return lt(i,{code:$e.invalid_type,expected:pt.array,received:i.parsedType}),Dt;if(r.exactLength!==null){const o=i.data.length>r.exactLength.value,c=i.data.length<r.exactLength.value;(o||c)&&(lt(i,{code:o?$e.too_big:$e.too_small,minimum:c?r.exactLength.value:void 0,maximum:o?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(r.minLength!==null&&i.data.length<r.minLength.value&&(lt(i,{code:$e.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),r.maxLength!==null&&i.data.length>r.maxLength.value&&(lt(i,{code:$e.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),i.common.async)return Promise.all([...i.data].map((o,c)=>r.type._parseAsync(new Hr(i,o,i.path,c)))).then(o=>Bn.mergeArray(n,o));const s=[...i.data].map((o,c)=>r.type._parseSync(new Hr(i,o,i.path,c)));return Bn.mergeArray(n,s)}get element(){return this._def.type}min(e,i){return new Jc(we(ae({},this._def),{minLength:{value:e,message:Et.toString(i)}}))}max(e,i){return new Jc(we(ae({},this._def),{maxLength:{value:e,message:Et.toString(i)}}))}length(e,i){return new Jc(we(ae({},this._def),{exactLength:{value:e,message:Et.toString(i)}}))}nonempty(e){return this.min(1,e)}};na.create=(t,e)=>new na(ae({type:t,minLength:null,maxLength:null,exactLength:null,typeName:Ft.ZodArray},Vt(e)));function Aa(t){if(t instanceof sr){const e={};for(const i in t.shape){const n=t.shape[i];e[i]=kr.create(Aa(n))}return new sr(we(ae({},t._def),{shape:()=>e}))}else return t instanceof na?new na(we(ae({},t._def),{type:Aa(t.element)})):t instanceof kr?kr.create(Aa(t.unwrap())):t instanceof Cs?Cs.create(Aa(t.unwrap())):t instanceof Es?Es.create(t.items.map(e=>Aa(e))):t}var sr=class vr extends Kt{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),i=ni.objectKeys(e);return this._cached={shape:e,keys:i},this._cached}_parse(e){if(this._getType(e)!==pt.object){const d=this._getOrReturnCtx(e);return lt(d,{code:$e.invalid_type,expected:pt.object,received:d.parsedType}),Dt}const{status:n,ctx:r}=this._processInputParams(e),{shape:s,keys:o}=this._getCached(),c=[];if(!(this._def.catchall instanceof rs&&this._def.unknownKeys==="strip"))for(const d in r.data)o.includes(d)||c.push(d);const h=[];for(const d of o){const p=s[d],v=r.data[d];h.push({key:{status:"valid",value:d},value:p._parse(new Hr(r,v,r.path,d)),alwaysSet:d in r.data})}if(this._def.catchall instanceof rs){const d=this._def.unknownKeys;if(d==="passthrough")for(const p of c)h.push({key:{status:"valid",value:p},value:{status:"valid",value:r.data[p]}});else if(d==="strict")c.length>0&&(lt(r,{code:$e.unrecognized_keys,keys:c}),n.dirty());else if(d!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const d=this._def.catchall;for(const p of c){const v=r.data[p];h.push({key:{status:"valid",value:p},value:d._parse(new Hr(r,v,r.path,p)),alwaysSet:p in r.data})}}return r.common.async?Promise.resolve().then(()=>j(this,null,function*(){const d=[];for(const p of h){const v=yield p.key,g=yield p.value;d.push({key:v,value:g,alwaysSet:p.alwaysSet})}return d})).then(d=>Bn.mergeObjectSync(n,d)):Bn.mergeObjectSync(n,h)}get shape(){return this._def.shape()}strict(e){return Et.errToObj,new vr(ae(we(ae({},this._def),{unknownKeys:"strict"}),e!==void 0?{errorMap:(i,n)=>{var r,s,o,c;const h=(o=(s=(r=this._def).errorMap)==null?void 0:s.call(r,i,n).message)!=null?o:n.defaultError;return i.code==="unrecognized_keys"?{message:(c=Et.errToObj(e).message)!=null?c:h}:{message:h}}}:{}))}strip(){return new vr(we(ae({},this._def),{unknownKeys:"strip"}))}passthrough(){return new vr(we(ae({},this._def),{unknownKeys:"passthrough"}))}extend(e){return new vr(we(ae({},this._def),{shape:()=>ae(ae({},this._def.shape()),e)}))}merge(e){return new vr({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>ae(ae({},this._def.shape()),e._def.shape()),typeName:Ft.ZodObject})}setKey(e,i){return this.augment({[e]:i})}catchall(e){return new vr(we(ae({},this._def),{catchall:e}))}pick(e){const i={};for(const n of ni.objectKeys(e))e[n]&&this.shape[n]&&(i[n]=this.shape[n]);return new vr(we(ae({},this._def),{shape:()=>i}))}omit(e){const i={};for(const n of ni.objectKeys(this.shape))e[n]||(i[n]=this.shape[n]);return new vr(we(ae({},this._def),{shape:()=>i}))}deepPartial(){return Aa(this)}partial(e){const i={};for(const n of ni.objectKeys(this.shape)){const r=this.shape[n];e&&!e[n]?i[n]=r:i[n]=r.optional()}return new vr(we(ae({},this._def),{shape:()=>i}))}required(e){const i={};for(const n of ni.objectKeys(this.shape))if(e&&!e[n])i[n]=this.shape[n];else{let s=this.shape[n];for(;s instanceof kr;)s=s._def.innerType;i[n]=s}return new vr(we(ae({},this._def),{shape:()=>i}))}keyof(){return Og(ni.objectKeys(this.shape))}};sr.create=(t,e)=>new sr(ae({shape:()=>t,unknownKeys:"strip",catchall:rs.create(),typeName:Ft.ZodObject},Vt(e)));sr.strictCreate=(t,e)=>new sr(ae({shape:()=>t,unknownKeys:"strict",catchall:rs.create(),typeName:Ft.ZodObject},Vt(e)));sr.lazycreate=(t,e)=>new sr(ae({shape:t,unknownKeys:"strip",catchall:rs.create(),typeName:Ft.ZodObject},Vt(e)));var Oo=class extends Kt{_parse(t){const{ctx:e}=this._processInputParams(t),i=this._def.options;function n(r){for(const o of r)if(o.result.status==="valid")return o.result;for(const o of r)if(o.result.status==="dirty")return e.common.issues.push(...o.ctx.common.issues),o.result;const s=r.map(o=>new xr(o.ctx.common.issues));return lt(e,{code:$e.invalid_union,unionErrors:s}),Dt}if(e.common.async)return Promise.all(i.map(r=>j(this,null,function*(){const s=we(ae({},e),{common:we(ae({},e.common),{issues:[]}),parent:null});return{result:yield r._parseAsync({data:e.data,path:e.path,parent:s}),ctx:s}}))).then(n);{let r;const s=[];for(const c of i){const h=we(ae({},e),{common:we(ae({},e.common),{issues:[]}),parent:null}),d=c._parseSync({data:e.data,path:e.path,parent:h});if(d.status==="valid")return d;d.status==="dirty"&&!r&&(r={result:d,ctx:h}),h.common.issues.length&&s.push(h.common.issues)}if(r)return e.common.issues.push(...r.ctx.common.issues),r.result;const o=s.map(c=>new xr(c));return lt(e,{code:$e.invalid_union,unionErrors:o}),Dt}}get options(){return this._def.options}};Oo.create=(t,e)=>new Oo(ae({options:t,typeName:Ft.ZodUnion},Vt(e)));var Zr=t=>t instanceof Uo?Zr(t.schema):t instanceof Cr?Zr(t.innerType()):t instanceof Bo?[t.value]:t instanceof Yo?t.options:t instanceof Ho?ni.objectValues(t.enum):t instanceof jo?Zr(t._def.innerType):t instanceof No?[void 0]:t instanceof Lo?[null]:t instanceof kr?[void 0,...Zr(t.unwrap())]:t instanceof Cs?[null,...Zr(t.unwrap())]:t instanceof Th||t instanceof zo?Zr(t.unwrap()):t instanceof Vo?Zr(t._def.innerType):[],Dg=class Ig extends Kt{_parse(e){const{ctx:i}=this._processInputParams(e);if(i.parsedType!==pt.object)return lt(i,{code:$e.invalid_type,expected:pt.object,received:i.parsedType}),Dt;const n=this.discriminator,r=i.data[n],s=this.optionsMap.get(r);return s?i.common.async?s._parseAsync({data:i.data,path:i.path,parent:i}):s._parseSync({data:i.data,path:i.path,parent:i}):(lt(i,{code:$e.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),Dt)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,i,n){const r=new Map;for(const s of i){const o=Zr(s.shape[e]);if(!o.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const c of o){if(r.has(c))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(c)}`);r.set(c,s)}}return new Ig(ae({typeName:Ft.ZodDiscriminatedUnion,discriminator:e,options:i,optionsMap:r},Vt(n)))}};function bu(t,e){const i=Jr(t),n=Jr(e);if(t===e)return{valid:!0,data:t};if(i===pt.object&&n===pt.object){const r=ni.objectKeys(e),s=ni.objectKeys(t).filter(c=>r.indexOf(c)!==-1),o=ae(ae({},t),e);for(const c of s){const h=bu(t[c],e[c]);if(!h.valid)return{valid:!1};o[c]=h.data}return{valid:!0,data:o}}else if(i===pt.array&&n===pt.array){if(t.length!==e.length)return{valid:!1};const r=[];for(let s=0;s<t.length;s++){const o=t[s],c=e[s],h=bu(o,c);if(!h.valid)return{valid:!1};r.push(h.data)}return{valid:!0,data:r}}else return i===pt.date&&n===pt.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}var ko=class extends Kt{_parse(t){const{status:e,ctx:i}=this._processInputParams(t),n=(r,s)=>{if(mu(r)||mu(s))return Dt;const o=bu(r.value,s.value);return o.valid?((gu(r)||gu(s))&&e.dirty(),{status:e.value,value:o.data}):(lt(i,{code:$e.invalid_intersection_types}),Dt)};return i.common.async?Promise.all([this._def.left._parseAsync({data:i.data,path:i.path,parent:i}),this._def.right._parseAsync({data:i.data,path:i.path,parent:i})]).then(([r,s])=>n(r,s)):n(this._def.left._parseSync({data:i.data,path:i.path,parent:i}),this._def.right._parseSync({data:i.data,path:i.path,parent:i}))}};ko.create=(t,e,i)=>new ko(ae({left:t,right:e,typeName:Ft.ZodIntersection},Vt(i)));var Es=class Fg extends Kt{_parse(e){const{status:i,ctx:n}=this._processInputParams(e);if(n.parsedType!==pt.array)return lt(n,{code:$e.invalid_type,expected:pt.array,received:n.parsedType}),Dt;if(n.data.length<this._def.items.length)return lt(n,{code:$e.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Dt;!this._def.rest&&n.data.length>this._def.items.length&&(lt(n,{code:$e.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),i.dirty());const s=[...n.data].map((o,c)=>{const h=this._def.items[c]||this._def.rest;return h?h._parse(new Hr(n,o,n.path,c)):null}).filter(o=>!!o);return n.common.async?Promise.all(s).then(o=>Bn.mergeArray(i,o)):Bn.mergeArray(i,s)}get items(){return this._def.items}rest(e){return new Fg(we(ae({},this._def),{rest:e}))}};Es.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Es(ae({items:t,typeName:Ft.ZodTuple,rest:null},Vt(e)))};var Ng=class yu extends Kt{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:i,ctx:n}=this._processInputParams(e);if(n.parsedType!==pt.object)return lt(n,{code:$e.invalid_type,expected:pt.object,received:n.parsedType}),Dt;const r=[],s=this._def.keyType,o=this._def.valueType;for(const c in n.data)r.push({key:s._parse(new Hr(n,c,n.path,c)),value:o._parse(new Hr(n,n.data[c],n.path,c)),alwaysSet:c in n.data});return n.common.async?Bn.mergeObjectAsync(i,r):Bn.mergeObjectSync(i,r)}get element(){return this._def.valueType}static create(e,i,n){return i instanceof Kt?new yu(ae({keyType:e,valueType:i,typeName:Ft.ZodRecord},Vt(n))):new yu(ae({keyType:qa.create(),valueType:e,typeName:Ft.ZodRecord},Vt(i)))}},vl=class extends Kt{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(t){const{status:e,ctx:i}=this._processInputParams(t);if(i.parsedType!==pt.map)return lt(i,{code:$e.invalid_type,expected:pt.map,received:i.parsedType}),Dt;const n=this._def.keyType,r=this._def.valueType,s=[...i.data.entries()].map(([o,c],h)=>({key:n._parse(new Hr(i,o,i.path,[h,"key"])),value:r._parse(new Hr(i,c,i.path,[h,"value"]))}));if(i.common.async){const o=new Map;return Promise.resolve().then(()=>j(this,null,function*(){for(const c of s){const h=yield c.key,d=yield c.value;if(h.status==="aborted"||d.status==="aborted")return Dt;(h.status==="dirty"||d.status==="dirty")&&e.dirty(),o.set(h.value,d.value)}return{status:e.value,value:o}}))}else{const o=new Map;for(const c of s){const h=c.key,d=c.value;if(h.status==="aborted"||d.status==="aborted")return Dt;(h.status==="dirty"||d.status==="dirty")&&e.dirty(),o.set(h.value,d.value)}return{status:e.value,value:o}}}};vl.create=(t,e,i)=>new vl(ae({valueType:e,keyType:t,typeName:Ft.ZodMap},Vt(i)));var _l=class Su extends Kt{_parse(e){const{status:i,ctx:n}=this._processInputParams(e);if(n.parsedType!==pt.set)return lt(n,{code:$e.invalid_type,expected:pt.set,received:n.parsedType}),Dt;const r=this._def;r.minSize!==null&&n.data.size<r.minSize.value&&(lt(n,{code:$e.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),i.dirty()),r.maxSize!==null&&n.data.size>r.maxSize.value&&(lt(n,{code:$e.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),i.dirty());const s=this._def.valueType;function o(h){const d=new Set;for(const p of h){if(p.status==="aborted")return Dt;p.status==="dirty"&&i.dirty(),d.add(p.value)}return{status:i.value,value:d}}const c=[...n.data.values()].map((h,d)=>s._parse(new Hr(n,h,n.path,d)));return n.common.async?Promise.all(c).then(h=>o(h)):o(c)}min(e,i){return new Su(we(ae({},this._def),{minSize:{value:e,message:Et.toString(i)}}))}max(e,i){return new Su(we(ae({},this._def),{maxSize:{value:e,message:Et.toString(i)}}))}size(e,i){return this.min(e,i).max(e,i)}nonempty(e){return this.min(1,e)}};_l.create=(t,e)=>new _l(ae({valueType:t,minSize:null,maxSize:null,typeName:Ft.ZodSet},Vt(e)));var Lg=class Qc extends Kt{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:i}=this._processInputParams(e);if(i.parsedType!==pt.function)return lt(i,{code:$e.invalid_type,expected:pt.function,received:i.parsedType}),Dt;function n(c,h){return fl({data:c,path:i.path,errorMaps:[i.common.contextualErrorMap,i.schemaErrorMap,pl(),Ga].filter(d=>!!d),issueData:{code:$e.invalid_arguments,argumentsError:h}})}function r(c,h){return fl({data:c,path:i.path,errorMaps:[i.common.contextualErrorMap,i.schemaErrorMap,pl(),Ga].filter(d=>!!d),issueData:{code:$e.invalid_return_type,returnTypeError:h}})}const s={errorMap:i.common.contextualErrorMap},o=i.data;if(this._def.returns instanceof Ka){const c=this;return Rn(function(...h){return j(this,null,function*(){const d=new xr([]),p=yield c._def.args.parseAsync(h,s).catch(_=>{throw d.addIssue(n(h,_)),d}),v=yield Reflect.apply(o,this,p);return yield c._def.returns._def.type.parseAsync(v,s).catch(_=>{throw d.addIssue(r(v,_)),d})})})}else{const c=this;return Rn(function(...h){const d=c._def.args.safeParse(h,s);if(!d.success)throw new xr([n(h,d.error)]);const p=Reflect.apply(o,this,d.data),v=c._def.returns.safeParse(p,s);if(!v.success)throw new xr([r(p,v.error)]);return v.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Qc(we(ae({},this._def),{args:Es.create(e).rest(Qs.create())}))}returns(e){return new Qc(we(ae({},this._def),{returns:e}))}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,i,n){return new Qc(ae({args:e||Es.create([]).rest(Qs.create()),returns:i||Qs.create(),typeName:Ft.ZodFunction},Vt(n)))}},Uo=class extends Kt{get schema(){return this._def.getter()}_parse(t){const{ctx:e}=this._processInputParams(t);return this._def.getter()._parse({data:e.data,path:e.path,parent:e})}};Uo.create=(t,e)=>new Uo(ae({getter:t,typeName:Ft.ZodLazy},Vt(e)));var Bo=class extends Kt{_parse(t){if(t.data!==this._def.value){const e=this._getOrReturnCtx(t);return lt(e,{received:e.data,code:$e.invalid_literal,expected:this._def.value}),Dt}return{status:"valid",value:t.data}}get value(){return this._def.value}};Bo.create=(t,e)=>new Bo(ae({value:t,typeName:Ft.ZodLiteral},Vt(e)));function Og(t,e){return new Yo(ae({values:t,typeName:Ft.ZodEnum},Vt(e)))}var Yo=class wu extends Kt{_parse(e){if(typeof e.data!="string"){const i=this._getOrReturnCtx(e),n=this._def.values;return lt(i,{expected:ni.joinValues(n),received:i.parsedType,code:$e.invalid_type}),Dt}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const i=this._getOrReturnCtx(e),n=this._def.values;return lt(i,{received:i.data,code:$e.invalid_enum_value,options:n}),Dt}return Rn(e.data)}get options(){return this._def.values}get enum(){const e={};for(const i of this._def.values)e[i]=i;return e}get Values(){const e={};for(const i of this._def.values)e[i]=i;return e}get Enum(){const e={};for(const i of this._def.values)e[i]=i;return e}extract(e,i=this._def){return wu.create(e,ae(ae({},this._def),i))}exclude(e,i=this._def){return wu.create(this.options.filter(n=>!e.includes(n)),ae(ae({},this._def),i))}};Yo.create=Og;var Ho=class extends Kt{_parse(t){const e=ni.getValidEnumValues(this._def.values),i=this._getOrReturnCtx(t);if(i.parsedType!==pt.string&&i.parsedType!==pt.number){const n=ni.objectValues(e);return lt(i,{expected:ni.joinValues(n),received:i.parsedType,code:$e.invalid_type}),Dt}if(this._cache||(this._cache=new Set(ni.getValidEnumValues(this._def.values))),!this._cache.has(t.data)){const n=ni.objectValues(e);return lt(i,{received:i.data,code:$e.invalid_enum_value,options:n}),Dt}return Rn(t.data)}get enum(){return this._def.values}};Ho.create=(t,e)=>new Ho(ae({values:t,typeName:Ft.ZodNativeEnum},Vt(e)));var Ka=class extends Kt{unwrap(){return this._def.type}_parse(t){const{ctx:e}=this._processInputParams(t);if(e.parsedType!==pt.promise&&e.common.async===!1)return lt(e,{code:$e.invalid_type,expected:pt.promise,received:e.parsedType}),Dt;const i=e.parsedType===pt.promise?e.data:Promise.resolve(e.data);return Rn(i.then(n=>this._def.type.parseAsync(n,{path:e.path,errorMap:e.common.contextualErrorMap})))}};Ka.create=(t,e)=>new Ka(ae({type:t,typeName:Ft.ZodPromise},Vt(e)));var Cr=class extends Kt{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Ft.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(t){const{status:e,ctx:i}=this._processInputParams(t),n=this._def.effect||null,r={addIssue:s=>{lt(i,s),s.fatal?e.abort():e.dirty()},get path(){return i.path}};if(r.addIssue=r.addIssue.bind(r),n.type==="preprocess"){const s=n.transform(i.data,r);if(i.common.async)return Promise.resolve(s).then(o=>j(this,null,function*(){if(e.value==="aborted")return Dt;const c=yield this._def.schema._parseAsync({data:o,path:i.path,parent:i});return c.status==="aborted"?Dt:c.status==="dirty"||e.value==="dirty"?Da(c.value):c}));{if(e.value==="aborted")return Dt;const o=this._def.schema._parseSync({data:s,path:i.path,parent:i});return o.status==="aborted"?Dt:o.status==="dirty"||e.value==="dirty"?Da(o.value):o}}if(n.type==="refinement"){const s=o=>{const c=n.refinement(o,r);if(i.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(i.common.async===!1){const o=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});return o.status==="aborted"?Dt:(o.status==="dirty"&&e.dirty(),s(o.value),{status:e.value,value:o.value})}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(o=>o.status==="aborted"?Dt:(o.status==="dirty"&&e.dirty(),s(o.value).then(()=>({status:e.value,value:o.value}))))}if(n.type==="transform")if(i.common.async===!1){const s=this._def.schema._parseSync({data:i.data,path:i.path,parent:i});if(!ia(s))return Dt;const o=n.transform(s.value,r);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:e.value,value:o}}else return this._def.schema._parseAsync({data:i.data,path:i.path,parent:i}).then(s=>ia(s)?Promise.resolve(n.transform(s.value,r)).then(o=>({status:e.value,value:o})):Dt);ni.assertNever(n)}};Cr.create=(t,e,i)=>new Cr(ae({schema:t,typeName:Ft.ZodEffects,effect:e},Vt(i)));Cr.createWithPreprocess=(t,e,i)=>new Cr(ae({schema:e,effect:{type:"preprocess",transform:t},typeName:Ft.ZodEffects},Vt(i)));var kr=class extends Kt{_parse(t){return this._getType(t)===pt.undefined?Rn(void 0):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}};kr.create=(t,e)=>new kr(ae({innerType:t,typeName:Ft.ZodOptional},Vt(e)));var Cs=class extends Kt{_parse(t){return this._getType(t)===pt.null?Rn(null):this._def.innerType._parse(t)}unwrap(){return this._def.innerType}};Cs.create=(t,e)=>new Cs(ae({innerType:t,typeName:Ft.ZodNullable},Vt(e)));var jo=class extends Kt{_parse(t){const{ctx:e}=this._processInputParams(t);let i=e.data;return e.parsedType===pt.undefined&&(i=this._def.defaultValue()),this._def.innerType._parse({data:i,path:e.path,parent:e})}removeDefault(){return this._def.innerType}};jo.create=(t,e)=>new jo(ae({innerType:t,typeName:Ft.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default},Vt(e)));var Vo=class extends Kt{_parse(t){const{ctx:e}=this._processInputParams(t),i=we(ae({},e),{common:we(ae({},e.common),{issues:[]})}),n=this._def.innerType._parse({data:i.data,path:i.path,parent:ae({},i)});return Po(n)?n.then(r=>({status:"valid",value:r.status==="valid"?r.value:this._def.catchValue({get error(){return new xr(i.common.issues)},input:i.data})})):{status:"valid",value:n.status==="valid"?n.value:this._def.catchValue({get error(){return new xr(i.common.issues)},input:i.data})}}removeCatch(){return this._def.innerType}};Vo.create=(t,e)=>new Vo(ae({innerType:t,typeName:Ft.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch},Vt(e)));var bl=class extends Kt{_parse(t){if(this._getType(t)!==pt.nan){const i=this._getOrReturnCtx(t);return lt(i,{code:$e.invalid_type,expected:pt.nan,received:i.parsedType}),Dt}return{status:"valid",value:t.data}}};bl.create=t=>new bl(ae({typeName:Ft.ZodNaN},Vt(t)));var ww=Symbol("zod_brand"),Th=class extends Kt{_parse(t){const{ctx:e}=this._processInputParams(t),i=e.data;return this._def.type._parse({data:i,path:e.path,parent:e})}unwrap(){return this._def.type}},Rh=class kg extends Kt{_parse(e){const{status:i,ctx:n}=this._processInputParams(e);if(n.common.async)return j(this,null,function*(){const s=yield this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?Dt:s.status==="dirty"?(i.dirty(),Da(s.value)):this._def.out._parseAsync({data:s.value,path:n.path,parent:n})});{const r=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return r.status==="aborted"?Dt:r.status==="dirty"?(i.dirty(),{status:"dirty",value:r.value}):this._def.out._parseSync({data:r.value,path:n.path,parent:n})}}static create(e,i){return new kg({in:e,out:i,typeName:Ft.ZodPipeline})}},zo=class extends Kt{_parse(t){const e=this._def.innerType._parse(t),i=n=>(ia(n)&&(n.value=Object.freeze(n.value)),n);return Po(e)?e.then(n=>i(n)):i(e)}unwrap(){return this._def.innerType}};zo.create=(t,e)=>new zo(ae({innerType:t,typeName:Ft.ZodReadonly},Vt(e)));function Dp(t,e){const i=typeof t=="function"?t(e):typeof t=="string"?{message:t}:t;return typeof i=="string"?{message:i}:i}function Ug(t,e={},i){return t?Wa.create().superRefine((n,r)=>{var s,o;const c=t(n);if(c instanceof Promise)return c.then(h=>{var d,p;if(!h){const v=Dp(e,n),g=(p=(d=v.fatal)!=null?d:i)!=null?p:!0;r.addIssue(we(ae({code:"custom"},v),{fatal:g}))}});if(!c){const h=Dp(e,n),d=(o=(s=h.fatal)!=null?s:i)!=null?o:!0;r.addIssue(we(ae({code:"custom"},h),{fatal:d}))}}):Wa.create()}var xw={object:sr.lazycreate},Ft;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(Ft||(Ft={}));var Ew=(t,e={message:`Input not instance of ${t.name}`})=>Ug(i=>i instanceof t,e),Bg=qa.create,Hg=Ao.create,Cw=bl.create,Tw=Do.create,jg=Io.create,Rw=Fo.create,Mw=ml.create,Pw=No.create,Aw=Lo.create,Dw=Wa.create,Iw=Qs.create,Fw=rs.create,Nw=gl.create,Lw=na.create,Ow=sr.create,kw=sr.strictCreate,Uw=Oo.create,Bw=Dg.create,Hw=ko.create,jw=Es.create,Vw=Ng.create,zw=vl.create,Gw=_l.create,qw=Lg.create,Ww=Uo.create,Kw=Bo.create,Xw=Yo.create,$w=Ho.create,Zw=Ka.create,Ip=Cr.create,Yw=kr.create,Jw=Cs.create,Qw=Cr.createWithPreprocess,ex=Rh.create,tx=()=>Bg().optional(),ix=()=>Hg().optional(),nx=()=>jg().optional(),rx={string:t=>qa.create(we(ae({},t),{coerce:!0})),number:t=>Ao.create(we(ae({},t),{coerce:!0})),boolean:t=>Io.create(we(ae({},t),{coerce:!0})),bigint:t=>Do.create(we(ae({},t),{coerce:!0})),date:t=>Fo.create(we(ae({},t),{coerce:!0}))},sx=Dt,po=new ft("packages/token/src/encoder.ts"),Xa=class Vg{constructor(e){let i;try{i=Dx.parse(e)}catch(n){throw n instanceof at.ZodError?new Xn({path:po.prefix,info:fo.invalidParameter,error:new Error("Received invalid token. Please check your SkyWayAuthToken.")}):new Xn({path:po.prefix,info:fo.invalidParameter,error:new Error("Received invalid token. Please check your SkyWayAuthToken.")})}Object.assign(this,i)}static Decode(e){try{const i=ZS(e),n=new Vg(i);return n.tokenString=e,n}catch(i){throw new Xn({path:po.prefix,info:fo.invalidParameter,error:i})}}encode(e){const i={jti:this.jti,iat:this.iat,exp:this.exp,scope:this.scope,version:this.version};return this.tokenString=KS.default.KJUR.jws.JWS.sign("HS256",JSON.stringify({alg:"HS256",typ:"JWT"}),JSON.stringify(i),e),this.tokenString}toJSON(){return{jti:this.jti,iat:this.iat,exp:this.exp,scope:this.scope,encoded:this.tokenString,version:this.version}}getAppId(){switch(this.version){case void 0:case 1:case 2:return this.scope.app.id;case 3:return this.scope.appId;default:throw new Xn({path:po.prefix,info:fo.invalidParameter,error:new Error(`invalid token version: version ${this.version} is not supported.`)})}}getAnalyticsEnabled(){var e,i,n;switch(this.version){case void 0:case 1:case 2:return(e=this.scope.app.analytics)!=null?e:!1;case 3:return(n=(i=this.scope.analytics)==null?void 0:i.enabled)!=null?n:!0;default:throw new Xn({path:po.prefix,info:fo.invalidParameter,error:new Error(`invalid token version: version ${this.version} is not supported.`)})}}};ne();var ax=["create","write","delete"],ox=at.object({actions:at.array(at.enum(ax).refine(t=>typeof t=="string"))}).passthrough(),cx=["create","write","delete"],lx=at.object({actions:at.array(at.enum(cx).refine(t=>typeof t=="string")),forwardings:at.array(ox)}).passthrough();ne();var dx=["write","create","delete","updateMetadata","enable","disable"],ux=at.object({actions:at.array(at.enum(dx).refine(t=>typeof t=="string"))}).passthrough(),hx=["write","create","delete"],px=at.object({actions:at.array(at.enum(hx).refine(t=>typeof t=="string"))}).passthrough(),fx=["write","create","delete","updateMetadata","signal"],mx=at.object({id:at.string().optional(),name:at.string().optional()}).refine(t=>t.id!==void 0||t.name!==void 0,{message:"Either id or name is required."}),gx=at.intersection(mx,at.object({actions:at.array(at.enum(fx).refine(t=>typeof t=="string")),publication:ux.optional(),subscription:px.optional()}).passthrough()),vx=["write","read","create","delete","updateMetadata"],_x=at.object({id:at.string().optional(),name:at.string().optional()}).refine(t=>t.id!==void 0||t.name!==void 0,{message:"Either id or name is required."}),bx=at.intersection(_x,at.object({actions:at.array(at.enum(vx).refine(t=>typeof t=="string")),members:at.array(gx),sfuBots:at.array(lx).optional()}).passthrough()),yx=["listChannels","read","write"],Sx=at.object({id:at.string(),analytics:at.boolean().optional(),actions:at.array(at.enum(yx).refine(t=>typeof t=="string")).optional(),channels:at.array(bx).optional(),turn:at.boolean().optional()}).passthrough();ne();var wx=["publish","subscribe","updateMetadata"],xx=at.object({id:at.string().optional(),name:at.string().optional()}).refine(t=>t.id!==void 0||t.name!==void 0,{message:"Either id or name is required."}),Ex=at.intersection(xx,at.object({methods:at.array(at.enum(wx).refine(t=>typeof t=="string"))}).passthrough()),Cx=["create","close","updateMetadata"],Tx=at.object({id:at.string().optional(),name:at.string().optional()}).refine(t=>t.id!==void 0||t.name!==void 0,{message:"Either id or name is required."}),Rx=at.intersection(Tx,at.object({methods:at.array(at.enum(Cx).refine(t=>typeof t=="string")),member:Ex.optional(),sfu:at.object({enabled:at.boolean().optional(),maxSubscribersLimit:at.number().optional()}).optional()}).passthrough()),Mx=at.object({appId:at.string(),analytics:at.object({enabled:at.boolean().optional()}).optional(),turn:at.object({enabled:at.boolean().optional()}).optional(),rooms:at.array(Rx)}).passthrough();ne();var zg=at.object({jti:at.string().uuid(),iat:at.number().nonnegative(),exp:at.number().nonnegative()}),Px=at.intersection(zg,at.object({scope:at.object({app:Sx}),version:at.union([at.literal(1),at.literal(2),at.literal(void 0)]).optional()})),Ax=at.intersection(zg,at.object({scope:Mx,version:at.literal(3)})),Dx=at.union([Px,Ax]);ne();var fo={invalidParameter:{name:"invalidParameter",detail:"failed to decode token",solution:"Use the correct token according to the specification"}};ne();var Fp=()=>Math.floor(Date.now()/1e3),io=Vr,Gg=class{constructor(t){this.contentType=t,this.side="local",this.onConnectionStateChanged=new gt,this._onConnectionStateChanged=new gt,this.id=io(),this._label="",this.published=!1,this._getTransportCallbacks={},this._getStatsCallbacks={},this._connectionState={},this._onConnectionStateChanged.pipe(this.onConnectionStateChanged)}_setLabel(t){this._label=t}_unpublished(){this.published=!1,this._getTransportCallbacks={},this._getStatsCallbacks={}}_getTransport(t){var e,i;const n=typeof t=="string"?t:t.id;return(i=(e=this._getTransportCallbacks)[n])==null?void 0:i.call(e)}_setConnectionState(t,e){this._connectionState[t.id]!==e&&(this._connectionState[t.id]=e,this._onConnectionStateChanged.emit({remoteMember:t,state:e}))}getStats(t){return this._getStats(t)}_getStats(t){var e,i,n;const r=typeof t=="string"?t:t.id;return(n=(i=(e=this._getStatsCallbacks)[r])==null?void 0:i.call(e))!=null?n:[]}_getStatsAll(){return Promise.all(Object.entries(this._getStatsCallbacks).map(t=>j(this,[t],function*([e,i]){return{memberId:e,stats:yield i().catch(()=>[])}})))}getRTCPeerConnection(t){return this._getRTCPeerConnection(t)}_getRTCPeerConnection(t){var e;return(e=this._getTransport(t))==null?void 0:e.rtcPeerConnection}getConnectionState(t){return this._getConnectionState(t)}_getConnectionState(t){var e;const i=typeof t=="string"?t:t.id;return(e=this._connectionState[i])!=null?e:"new"}_getConnectionStateAll(){return Object.keys(this._getTransportCallbacks).map(t=>({memberId:t,connectionState:this._getConnectionState(t)}))}toJSON(){return{label:this._label,contentType:this.contentType,id:this.id,side:this.side}}},Ix=new ft("packages/core/src/media/stream/local/media.ts"),Mh=class extends Gg{constructor(t,e,i={}){super(e),this.onTrackUpdated=new gt,this.onDestroyed=new gt,this._disposer=new Yn,this._trackConstraints={},this._replacingTrack=!1,this._onReplacingTrackDone=new gt,this._onEnableChanged=new gt,this._track=t,this._listenTrackEvent(),this._options=i,this._trackConstraints=ae({},i)}get trackConstraints(){return this._trackConstraints}toJSON(){const t=super.toJSON();return we(ae({},t),{trackConstraints:this.trackConstraints,isEnabled:this.isEnabled,_options:this._options})}get track(){return this._track}attach(t){this._element=t,wg(t,this._track)}detach(){this._element&&(xg(this._element,this._track),this._element=void 0)}_disable(t){this._options.stopTrackWhenDisabled?(this._trackConstraints=ae(ae({},this.trackConstraints),this.track.getConstraints()),this.track.stop()):this._oldTrack=this.track;const e=t==="video"?Wg:Fx;e.enabled=!1,this._onEnableChanged.emit(e),this._updateTrack(e)}_updateTrack(t){this._track=t,this._element&&this.attach(this._element),this.onTrackUpdated.emit(t),this._listenTrackEvent()}_listenTrackEvent(){const t=()=>{Ix.info("onDestroyed",this.toJSON()),this.onDestroyed.emit()};this._track.addEventListener("ended",t),this._disposer.push(()=>this._track.removeEventListener("ended",t))}release(){this._disposer.dispose(),this._track.stop()}},qg=new RTCPeerConnection,Fx=qg.addTransceiver("audio").receiver.track,Wg=qg.addTransceiver("video").receiver.track,vd=new ft("packages/core/src/media/stream/local/audio.ts"),_d=class extends Mh{constructor(t,e={}){if(super(t,"audio",e),this.contentType="audio",this._isEnabled=!0,this._promiseQueue=new As,t.kind!=="audio")throw je({operationName:"LocalAudioStream.constructor",path:vd.prefix,info:Je.invalidTrackKind,payload:{track:t}})}setEnabled(t){return j(this,null,function*(){yield this._promiseQueue.push(()=>j(this,null,function*(){if(this._isEnabled===!0&&t===!1)this._isEnabled=t,this._disable("audio"),vd.debug("stopped");else if(this._isEnabled===!1&&t===!0){if(this._isEnabled=t,this._options.stopTrackWhenDisabled){const e=this._options.isDisplayMedia===!0?yield this.enableDisplay():yield this.enableMic();this._updateTrack(e),this._onEnableChanged.emit(e)}else this._oldTrack&&(this._updateTrack(this._oldTrack),this._onEnableChanged.emit(this._oldTrack));vd.debug("resumed")}}))})}get isEnabled(){return this._isEnabled}enableMic(){return j(this,null,function*(){const[t]=(yield navigator.mediaDevices.getUserMedia({audio:this.trackConstraints})).getAudioTracks();return t})}enableDisplay(){return j(this,null,function*(){const[t]=(yield navigator.mediaDevices.getDisplayMedia({audio:this.trackConstraints})).getAudioTracks();return t})}};ne();var Nx=new ft("packages/core/src/media/stream/local/customVideo.ts"),Lx=class extends Mh{constructor(t={}){super(Wg,"video",t),this.contentType="video",this._isEnabled=!0,this._promiseQueue=new As,this._stream=null}setStream(t){return j(this,null,function*(){if(this._stream)throw new Error("ProcessedStream is already exists");this._stream=t,this._updateTrack(t.track)})}setEnabled(t){return j(this,null,function*(){yield this._promiseQueue.push(()=>j(this,null,function*(){var e;yield(e=this._stream)==null?void 0:e.setEnabled(t)}))})}updateTrack(t){return j(this,null,function*(){this._updateTrack(t),this._onEnableChanged.emit(t)})}get isEnabled(){return this._isEnabled}release(){var t;(t=this._stream)==null||t.dispose().catch(()=>{Nx.error("release failed")})}};ne();var Sc=new ft("packages/core/src/media/stream/local/video.ts"),bd=class extends Mh{constructor(t,e={}){if(super(t,"video",e),this.contentType="video",this._isEnabled=!0,this._promiseQueue=new As,t.kind!=="video")throw je({operationName:"LocalVideoStream.constructor",path:Sc.prefix,info:Je.invalidTrackKind,payload:{track:t}});Sc.debug("LocalVideoStream spawned",this.toJSON())}setEnabled(t){return j(this,null,function*(){yield this._promiseQueue.push(()=>j(this,null,function*(){if(this._isEnabled===!0&&t===!1)this._isEnabled=t,this._disable("video"),Sc.debug("stopped",this.toJSON());else if(this._isEnabled===!1&&t===!0){if(this._isEnabled=t,this._options.stopTrackWhenDisabled){const e=this._options.isDisplayMedia===!0?yield this.enableDisplay():yield this.enableCamera();this._updateTrack(e),this._onEnableChanged.emit(e)}else this._oldTrack&&(this._updateTrack(this._oldTrack),this._onEnableChanged.emit(this._oldTrack));Sc.debug("resumed",this.toJSON())}}))})}get isEnabled(){return this._isEnabled}enableCamera(){return j(this,null,function*(){const[t]=(yield navigator.mediaDevices.getUserMedia({video:this.trackConstraints})).getVideoTracks();return t})}enableDisplay(){return j(this,null,function*(){const[t]=(yield navigator.mediaDevices.getDisplayMedia({video:this.trackConstraints})).getVideoTracks();return t})}},Ox=new ft("packages/core/src/media/stream/local/data.ts"),Ph=class extends Gg{constructor(t={}){super("data"),this.options=t,this.contentType="data",this._onWriteData=new gt,this._isEnabled=!0,this._setLabel("LocalDataStream")}get isEnabled(){return this._isEnabled}setIsEnabled(t){this._isEnabled=t}write(t){if(!this._isEnabled)throw je({operationName:"LocalDataStream.write",path:Ox.prefix,info:Je.disabledDataStream});!ArrayBuffer.isView(t)&&typeof t!="string"&&(t=xu+JSON.stringify(t)),this._onWriteData.emit(t)}},xu="skyway_object:";ne();function kx(t,{publisherId:e,stream:i,origin:n,metadata:r,codecCapabilities:s,encodings:o,contentType:c,id:h,isEnabled:d}){const p=t._getPublication(h);if(p)return p;c=c.toLowerCase();const v=n?t._getPublication(n):void 0;return v&&o.length===0&&(o=v.encodings),new Kg({id:h,channel:t,publisher:t._getMember(e),contentType:c,metadata:r,origin:v,stream:i,codecCapabilities:s??[],encodings:o,isEnabled:d})}var ki=new ft("packages/core/src/publication/index.ts"),Kg=class{constructor(t){this._codecCapabilities=[],this._encodings=[],this._state="enabled",this._events=new jr,this.onCanceled=this._events.make(),this.onSubscribed=this._events.make(),this.onUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onEnabled=this._events.make(),this.onDisabled=this._events.make(),this.onStateChanged=this._events.make(),this.onConnectionStateChanged=new gt,this._onEncodingsChanged=this._events.make(),this._onReplaceStream=this._events.make(),this._onEnabled=this._events.make(),this.streamEventDisposer=new Yn,this.cancel=()=>new Promise((r,s)=>{let o=!1;this._channel._unpublish(this.id).catch(c=>{o=!0,s(c)}),this._setStream(void 0),this.onCanceled.asPromise(this._context.config.rtcApi.timeout).then(()=>r()).catch(c=>{o||s(c)})}),this.updateMetadata=r=>new Promise((s,o)=>j(this,null,function*(){const c=ki.info("[start] updateMetadata",yield Gt({operationName:"Publication.updateMetadata",channel:this._channel}),this);let h=!1;this._channel._updatePublicationMetadata(this.id,r).catch(d=>{h=!0,o(d)}),this.onMetadataUpdated.watch(d=>d.metadata===r,this._context.config.rtcApi.timeout).then(()=>j(this,null,function*(){s(),ki.elapsed(c,"[end] updateMetadata",yield Gt({operationName:"Publication.updateMetadata",channel:this._channel}),this)})).catch(d=>{if(!h)throw je({operationName:"PublicationImpl.updateMetadata",info:we(ae({},Je.timeout),{detail:"publication onMetadataUpdated"}),path:ki.prefix,context:this._context,channel:this._channel,error:d})})})),this.disable=()=>new Promise((r,s)=>j(this,null,function*(){const o=ki.info("[start] disable",yield Gt({operationName:"Publication.disable",channel:this._channel}),this);yield this._disableStream();let c=!1;this._channel._disablePublication(this.id).catch(h=>{c=!0,s(h)}),this.onDisabled.asPromise(this._context.config.rtcApi.timeout).then(()=>j(this,null,function*(){r(),ki.elapsed(o,"[end] disable",yield Gt({operationName:"Publication.disable",channel:this._channel}),this)})).catch(h=>{c||s(h)})})),this.enable=()=>new Promise((r,s)=>j(this,null,function*(){if(this.stream==null){s(je({operationName:"Publication.enable",context:this._context,info:Je.canNotEnableRemotePublication,path:ki.prefix}));return}const o=ki.info("[start] enable",yield Gt({operationName:"Publication.enable",channel:this._channel}),this);let c=!1;this._channel._enablePublication(this.id).catch(h=>{c=!0,s(h)}),this._onEnabled.asPromise(this._context.config.rtcApi.timeout).then(()=>j(this,null,function*(){yield this._enableStream(),this.onEnabled.emit(),this.onStateChanged.emit(),ki.elapsed(o,"[end] enable",yield Gt({operationName:"Publication.enable",channel:this._channel}),this),r()})).catch(h=>{c||s(h)})}));var e,i,n;this.id=t.id,this._channel=t.channel,this._context=this._channel._context,this.publisher=t.publisher,this.contentType=t.contentType,this._metadata=t.metadata,this.origin=t.origin,this.setCodecCapabilities((e=t.codecCapabilities)!=null?e:[]),this.setEncodings(Eu((i=t.encodings)!=null?i:[])),this._state=t.isEnabled?"enabled":"disabled",t.stream&&this._setStream(t.stream),this._analytics=(n=this._channel.localPerson)==null?void 0:n._analytics,ki.debug("publication spawned",this.toJSON())}get codecCapabilities(){return this._codecCapabilities}setCodecCapabilities(t){this._codecCapabilities=t}get encodings(){return this._encodings}setEncodings(t){this._encodings=t}get stream(){return this._stream}_setStream(t){this._stream=t,t?t._onConnectionStateChanged.add(e=>{ki.debug("onConnectionStateChanged",this.id,e),this.onConnectionStateChanged.emit(e)}).disposer(this.streamEventDisposer):this.streamEventDisposer.dispose()}get metadata(){return this._metadata}get state(){return this._state}get deviceName(){if(!(this.stream instanceof Ph))return this.stream.track.label}get subscriptions(){return this._channel.subscriptions.filter(t=>t.publication.id===this.id)}_updateMetadata(t){this._metadata=t,this.onMetadataUpdated.emit({metadata:t})}_disable(){return j(this,null,function*(){yield this._disableStream(),this.onDisabled.emit(),this.onStateChanged.emit()})}_enable(){this.stream?this._onEnabled.emit():(this._state="enabled",this.onEnabled.emit(),this.onStateChanged.emit())}_unpublished(){this._state="canceled",this.stream&&this.stream._unpublished(),this.onCanceled.emit(),this.onStateChanged.emit(),this._dispose()}_subscribed(t){this.onSubscribed.emit({subscription:t}),this.onSubscriptionListChanged.emit()}_unsubscribed(t){this.onUnsubscribed.emit({subscription:t}),this.onSubscriptionListChanged.emit()}updateEncodings(t){ki.info("updateEncodings",{encodings:t},this),this.setEncodings(Eu(Xg(t))),this._onEncodingsChanged.emit(t),this._analytics&&!this._analytics.isClosed()&&this._analytics.client.sendPublicationUpdateEncodingsReport({publicationId:this.id,encodings:this.encodings,updatedAt:Date.now()})}_disableStream(){return j(this,null,function*(){this.state!=="disabled"&&(this._state="disabled",this.stream&&(this.stream.contentType==="data"?this.stream.setIsEnabled(!1):yield this.stream.setEnabled(!1).catch(t=>{ki.warn(qi({channel:this._channel,operationName:"Publication._disableStream",payload:t,detail:"setEnabled failed"}))}),Gt({operationName:"Publication._disableStream",channel:this._channel}).then(t=>ki.info("publication _disableStream",t,{publication:this})).catch(()=>{})))})}_enableStream(){return j(this,null,function*(){this.state!=="enabled"&&(this._state="enabled",this.stream&&(Gt({operationName:"Publication._enableStream",channel:this._channel}).then(t=>ki.info("publication _enableStream",t,{publication:this})).catch(()=>{}),this.stream.contentType==="data"?this.stream.setIsEnabled(!0):yield this.stream.setEnabled(!0).catch(t=>{ki.warn(qi({channel:this._channel,operationName:"Publication._disableStream",payload:t,detail:"setEnabled failed"}))})))})}replaceStream(t,e={}){var i;if(ki.info("replaceStream",{stream:t,options:e},this),!this.stream)throw je({operationName:"PublicationImpl.replaceStream",context:this._context,info:Je.canNotUseReplaceStream,path:ki.prefix});if(t.contentType!==this.contentType)throw je({operationName:"PublicationImpl.replaceStream",context:this._context,info:Je.invalidContentType,path:ki.prefix});((i=e.releaseOldStream)==null||i)&&this.stream.release(),Gt({operationName:"PublicationImpl.replaceStream",channel:this._channel}).then(r=>ki.debug(r,{old:this.stream,new:t})).catch(r=>r),t.setEnabled(this.stream.isEnabled).catch(r=>{ki.error("replaceStream stream.setEnabled",r,this.toJSON())});const n=this._stream;this._setStream(t),this._onReplaceStream.emit({newStream:t,oldStream:n}),this._analytics&&!this._analytics.isClosed()&&this._analytics.client.sendMediaDeviceReport({publicationId:this.id,mediaDeviceName:this.deviceName,mediaDeviceTrigger:"replaceStream",updatedAt:Date.now()})}getStats(t){if(!this.stream)throw je({operationName:"PublicationImpl.getStats",context:this._context,info:Je.streamNotExistInSubscription,path:ki.prefix});return this.stream._getStats(t)}getRTCPeerConnection(t){if(!this.stream)throw je({operationName:"PublicationImpl.getRTCPeerConnection",context:this._context,info:Je.streamNotExistInSubscription,path:ki.prefix});return this.stream._getRTCPeerConnection(t)}getConnectionState(t){if(!this.stream)throw je({operationName:"PublicationImpl.getConnectionState",context:this._context,info:Je.streamNotExistInSubscription,path:ki.prefix});return this.stream._getConnectionState(t)}toJSON(){var t;return{id:this.id,channelId:this._channel.id,publisherId:this.publisher.id,origin:(t=this.origin)==null?void 0:t.id,contentType:this.contentType,metadata:this.metadata,codecCapabilities:this.codecCapabilities,encodings:this.encodings,state:this.state,stream:this.stream}}_dispose(){this._events.dispose()}},Eu=t=>t.map((e,i)=>{var n;return we(ae({},e),{id:(n=e.id)!=null?n:i.toString()})}),Xg=t=>{const[e]=t;return e.maxBitrate?t.sort((i,n)=>i.maxBitrate-n.maxBitrate):e.scaleResolutionDownBy?t.sort((i,n)=>n.scaleResolutionDownBy-i.scaleResolutionDownBy):e.maxFramerate?t.sort((i,n)=>i.maxFramerate-n.maxFramerate):t};ne();function Ux(t){return t==null?!1:t.side==="remote"}ne();ne();var Np=new ft("packages/core/src/dataPlane/agent/publishing.ts"),Bx=class{constructor(t){this._localPerson=t,this.context=this._localPerson.context}startPublishing(t){return j(this,null,function*(){if(this.context.config.internal.disableDPlane){yield new Promise(r=>setTimeout(r,500));return}const e=t.publication,i=t.subscriber;e.stream||(yield this._localPerson.onStreamPublished.watch(r=>r.publication.id===e.id,this.context.config.rtcApi.timeout).catch(r=>{throw je({operationName:"PublishingAgent.startPublishing",context:this.context,channel:this._localPerson.channel,info:we(ae({},Je.timeout),{detail:"PublishingAgent onStreamPublished"}),path:Np.prefix,payload:{publication:e},error:r})}));const n=i._getOrCreateConnection(this._localPerson);n.startPublishing&&(yield n.startPublishing(e,t.id))})}stopPublishing(t,e){return j(this,null,function*(){const i=e._getConnection(this._localPerson.id);i!=null&&i.stopPublishing&&i.stopPublishing(t).catch(n=>{Np.error("stopPublishing failed",n)})})}};ne();var Hx=class{constructor(t){this._localPerson=t,this._disposers={},this._context=this._localPerson.context}startSubscribing(t){return j(this,null,function*(){if(this._context.config.internal.disableDPlane){yield new Promise(n=>setTimeout(n,500));return}const i=t.publication.publisher._getOrCreateConnection(this._localPerson);if(i.startSubscribing){yield i.startSubscribing(t);const{removeListener:n}=t._onChangeEncoding.add(()=>j(this,null,function*(){var r;yield(r=i.changePreferredEncoding)==null?void 0:r.call(i,t)}));this._disposers[t.id]=n}})}stopSubscribing(t){return j(this,null,function*(){var e,i;const r=t.publication.publisher._getConnection(this._localPerson.id);r!=null&&r.stopSubscribing&&(yield r.stopSubscribing(t),(i=(e=this._disposers)[t.id])==null||i.call(e))})}};ne();var Lp=class{constructor(t){this._impl=t,this._events=new jr,this.onLeft=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberStateChanged=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onFatalError=this._events.make(),this.apply(t)}get keepaliveIntervalSec(){return this._impl.keepaliveIntervalSec}get keepaliveIntervalGapSec(){return this._impl.keepaliveIntervalGapSec}get disableSignaling(){return this._impl.disableSignaling}get disableAnalytics(){return this._impl.disableAnalytics}get type(){return this._impl.type}get subtype(){return this._impl.subtype}get side(){return this._impl.side}get id(){return this._impl.id}get name(){return this._impl.name}get channel(){return this._impl.channel}get metadata(){return this._impl.metadata}get state(){return this._impl.state}get publications(){return this._impl.publications}get subscriptions(){return this._impl.subscriptions}apply(t){this._impl=t,t.onLeft.pipe(this.onLeft),t.onMetadataUpdated.pipe(this.onMetadataUpdated),t.onStreamPublished.pipe(this.onStreamPublished),t.onStreamUnpublished.pipe(this.onStreamUnpublished),t.onPublicationListChanged.pipe(this.onPublicationListChanged),t.onPublicationSubscribed.pipe(this.onPublicationSubscribed),t.onPublicationUnsubscribed.pipe(this.onPublicationUnsubscribed),t.onSubscriptionListChanged.pipe(this.onSubscriptionListChanged),t.onFatalError.pipe(this.onFatalError)}subscribe(t,e){return this._impl.subscribe(t,e)}unsubscribe(t){return this._impl.unsubscribe(t)}publish(t,e={}){return this._impl.publish(t,e)}unpublish(t){return this._impl.unpublish(t)}updateMetadata(t){return this._impl.updateMetadata(t)}leave(){return j(this,null,function*(){yield this._impl.leave()})}dispose(){this._impl.dispose()}};ne();ne();var jx=24*60*60;ne();ne();ne();ne();var fa=class{constructor(t,e){this.id=Vr(),this.type=t,this.payload=e}toJSON(){return{id:this.id,type:this.type,payload:this.payload}}};ne();function Vx(t){return!(typeof t!="object"||t===null||Array.isArray(t))}function zx(t){if(!t||typeof t!="object"||!t.statsRequest||typeof t.statsRequest!="object"||!t.statsRequest.intervalSec||typeof t.statsRequest.intervalSec!="number"||!t.statsRequest.types||!Array.isArray(t.statsRequest.types))return!1;for(const e of t.statsRequest.types){if(!e.type||typeof e.type!="string"||!e.properties||!Vx(e.properties))return!1;for(const i of Object.keys(e.properties))if(!("normalization"in e.properties[i])||typeof e.properties[i].normalization!="boolean"||!e.properties[i].outputKey||typeof e.properties[i].outputKey!="string")return!1}return!0}var Gx=["invalidPayload","unexpected"];function Op(t){return!(!t||typeof t!="object"||typeof t.eventId!="string"||typeof t.ok!="boolean"||typeof t.reason<"u"&&(typeof t.reason!="string"||!Gx.includes(t.reason)))}ne();var yd=Hn(vh());ne();var ys=class{constructor(){this._listeners=new Map,this._listenerIndex=0,this.emit=t=>{this._listeners.forEach(e=>e(t))},this.removeAllListeners=()=>{this._listeners.clear()},this.addListener=t=>{const e=this._listenerIndex;return this._listeners.set(e,t),this._listenerIndex++,{removeListener:()=>{this._listeners.delete(e)}}},this.addOneTimeListener=t=>{const e=this.addListener(i=>{e.removeListener(),t(i)});return e},this.asPromise=t=>new Promise((e,i)=>{let n=()=>{};const r=t&&setTimeout(()=>{i("Event asPromise timeout"),n()},t);n=this.addOneTimeListener(o=>{r&&clearTimeout(r),e(o)}).removeListener})}},qx=["Open","Acknowledge"],Wx=t=>(ns(2,t)+Math.random())*1e3,Kx=class{constructor({channelId:t,channelName:e,memberId:i,memberName:n,sessionEndpoint:r,token:s,logger:o,sdkVersion:c}){this._isOpen=!1,this._isClosed=!1,this._reconnectCount=0,this.connectionState="connecting",this.onConnectionStateChanged=new ys,this.onOpened=new ys,this.onTokenExpired=new ys,this.onEventReceived=new ys,this.onConnectionFailed=new ys,this._resendClientEvents=[],this._sessionEndpoint=r,this._channelId=t,this._channelName=e,this._memberId=i,this._memberName=n,this._token=s,this._logger=o,this._sdkVersion=c,this._connect()}_setConnectionState(t){this.connectionState!==t&&(this._logger.debug(`connectionState changed : ${t}`),this.connectionState=t,this.onConnectionStateChanged.emit(t))}_connect(){let t;try{const e=`SkyWayAuthToken!${this._token}`,i={channelId:this._channelId,channelName:this._channelName,memberId:this._memberId,memberName:this._memberName,sdkPlatform:"js",sdkVersion:this._sdkVersion},n=Object.entries(i).filter(([s,o])=>o!==void 0).map(s=>s.join("=")).join("&"),r=`${this._sessionEndpoint}?${n}`;t=new yd.default(r,e),this._logger.debug(`Connecting to analytics-logging-server: ${this._sessionEndpoint}`),t.onerror=s=>{this._logger.error("WebSocket error occurred",s.error),t.close(4202)}}catch(e){const i=e instanceof Error?e:new Error;this._logger.error("Failed to create WebSocket instance",i),this.reconnect();return}t.onopen=()=>{this._logger.debug("Connected to analytics-logging-server")},t.onclose=e=>{const i="Close event fired: "+JSON.stringify({code:e.code,reason:e.reason,type:e.type});if(4100<=e.code&&e.code<=4199?this._logger.error(i,new Error):this._logger.debug(i),e.code!==1e3&&!(4e3<=e.code&&e.code<=4199)){e.code===4200?this.onTokenExpired.emit():this.reconnect();return}this._logger.debug("Closed the connection to analytics-logging-server"),this.onConnectionFailed.emit({code:e.code,reason:e.reason}),this.close()},t.onmessage=e=>{this._messageHandler(e.data)},this._ws=t}updateAuthToken(t){this._token=t}reconnect(){if(this._ws!==void 0&&this._ws.close(4e3),this._ws=void 0,this._isOpen=!1,this._reconnectCount>=5)this.onConnectionFailed.emit({}),this.close(),this._logger.error("Failed to reconnect for five times",new Error);else{this._setConnectionState("reconnecting");const t=Wx(this._reconnectCount);this._reconnectTimer=setTimeout(()=>{this._connect(),this._reconnectCount++,this._logger.debug(`Try to reconnect: count = ${this._reconnectCount}`)},t)}}close(){this._isClosed=!0,this.destroy()}destroy(){this._setConnectionState("closed"),this.onConnectionStateChanged.removeAllListeners(),this.onOpened.removeAllListeners(),this.onEventReceived.removeAllListeners(),this.onConnectionFailed.removeAllListeners(),this._reconnectTimer&&clearTimeout(this._reconnectTimer),this._ws!==void 0&&this._ws.close(1e3)}send(t){return j(this,null,function*(){if(this._ws===void 0||!this._isOpen||this._ws.readyState!==yd.default.OPEN){this._logger.debug("Try to reconnect because connection is lost"),this.resendAfterReconnect(t);return}const e=JSON.stringify(t.toJSON());this._ws.send(e,i=>{if(i){this._logger.debug(`Try to reconnect because failed to send: ${i.message}`),this.resendAfterReconnect(t);return}})})}resendAfterReconnect(t){this._resendClientEvents.some(i=>i.id===t.id)||this._resendClientEvents.push(t),this.connectionState!=="reconnecting"&&this.reconnect()}pushResendClientEventsQueue(t){this._resendClientEvents.push(t)}isClosed(){return this._isClosed}_messageHandler(t){if(typeof t!="string"){this._logger.error("Received invalid message: not string",new Error);return}let e;try{e=JSON.parse(t)}catch(i){const n=i instanceof Error?i:new Error;this._logger.error("Received invalid message: parse error",n);return}if(!Xx(e)){this._logger.error(`Received invalid message: ${JSON.stringify(e)}`,new Error);return}if(e.type==="Open"){if(!zx(e.payload)){this._logger.error(`Received invalid message: ${JSON.stringify(e.payload)}`,new Error);return}if(this._logger.debug("Received a open event"),this._isOpen=!0,this._setConnectionState("connected"),this._reconnectCount!==0&&(this._reconnectCount=0,this._logger.debug("Succeeded to reconnect")),this._resendClientEvents.length>0){for(const i of this._resendClientEvents){if(this._ws===void 0||!this._isOpen||this._ws.readyState!==yd.default.OPEN){this._logger.error(`Failed to resend event because connection lost after reconnect: ${i}`,new Error);continue}const n=JSON.stringify(i.toJSON());this._ws.send(n,r=>{if(r){this._logger.error(`Failed to resend event: ${i}`,r);return}this._logger.debug(`Succeed to resend ClientEvent: ${i}`)})}this._logger.debug("Process of resending ClientEvents is completed"),this._resendClientEvents=[]}this.onOpened.emit(e.payload)}else this._logger.debug(`Received the event: ${e.type}, payload: ${JSON.stringify(e.payload)}`),this.onEventReceived.emit(e)}};function Xx(t){return!(!t||typeof t!="object"||typeof t.type!="string"||!qx.includes(t.type)||typeof t.id!="string"||t.payload&&typeof t.payload!="object")}ne();var $x=class{constructor(t={}){this.count=0,this.times=8,this.interval=100,this.jitter=0,Object.assign(this,t)}wait(){return j(this,null,function*(){if(this.exceeded)return!1;const t=this.timeout;return this.count++,yield new Promise(e=>setTimeout(e,t)),!0})}get timeout(){return ns(this.count,2)*this.interval+ns(this.count,2)*this.jitter*Math.random()}get exceeded(){return this.count>=this.times}reset(){this.count=0}stop(){this.count=this.times}},kp="analytics-logging.skyway.ntt.com",Zx="v1",Yx=5,Jx=class{constructor({token:t,channelId:e,channelName:i,memberId:n,memberName:r,sdkVersion:s},o){this.onConnectionStateChanged=new ys,this.onConnectionFailed=new ys,this.onAnalyticsNotEnabledError=new ys,this._isClosed=!1,this._responseCallbacks=new Map,this._acknowledgeCallbacks=new Map,this._mediaDeviceVersion=new Map,this._encodingsVersion=new Map,this._preferredEncodingVersion=new Map,this._previousSubscriptionStats=new Map,this._statsRequest={intervalSec:5,types:[]},this._token=t,this._newToken=void 0,this._channelId=e,this._channelName=i,this._memberId=n,this._memberName=r,this._sdkVersion=s;const c={analyticsLoggingServerDomain:kp,secure:!0,logger:{debug:(h,...d)=>{console.debug(h,...d)},warn:(h,...d)=>{console.warn(h,...d)},error:h=>{console.error(h)}}};this._options=Object.assign({},c,o??{}),this._logger=this._options.logger,this._logger.debug(`Created instance with the options: ${this._options}`)}get connectionState(){var t,e;return(e=(t=this._socket)==null?void 0:t.connectionState)!=null?e:"closed"}connect(){return j(this,null,function*(){const t=this._options.secure?"wss":"ws",e=this._options.analyticsLoggingServerDomain||kp;this._socket=new Kx({sessionEndpoint:`${t}://${e}/${Zx}/client/ws`,channelId:this._channelId,channelName:this._channelName,memberId:this._memberId,memberName:this._memberName,token:this._token,logger:this._logger,sdkVersion:this._sdkVersion}),this._socket.onEventReceived.addListener(n=>{try{this._eventReceivedHandler(n)}catch(r){this._logger.error("in _eventReceivedHandler",r)}}),this._socket.onConnectionFailed.addListener(n=>{n.code===4e3&&this.onAnalyticsNotEnabledError.emit(n),this.onConnectionFailed.emit(),this._cleanupAnalyticsClientMaps()}),this._socket.onConnectionStateChanged.addListener(n=>{var r;n==="closed"&&!this.isClosed()&&((r=this._socket)!=null&&r.isClosed())&&(this._isClosed=!0,this.dispose()),this.onConnectionStateChanged.emit(n)}),this._socket.onTokenExpired.addListener(()=>{this._reconnectWithNewSkyWayAuthToken()});const i=yield this._socket.onOpened.asPromise();if(i!==void 0){this._statsRequest=i.statsRequest;return}else{this._logger.error("First time connection payload is undefined",new Error),this.onConnectionFailed.emit();return}})}dispose(){this._disconnect(),this._cleanupAnalyticsClientMaps()}setNewSkyWayAuthToken(t){this._socket!==void 0&&(this._newToken=t,this._logger.debug("setNewSkyWayAuthToken is success"))}cleanupOnUnpublished(t){this._mediaDeviceVersion.delete(t),this._encodingsVersion.delete(t)}cleanupOnUnsubscribed(t){this._preferredEncodingVersion.delete(t),this._previousSubscriptionStats.delete(t)}_disconnect(){var t;(t=this._socket)==null||t.destroy(),this._socket=void 0,this._responseCallbacks.clear(),this._acknowledgeCallbacks.clear()}sendMediaDeviceReport(t){return j(this,null,function*(){let e=this._mediaDeviceVersion.get(t.publicationId);e===void 0?e=0:e++,this._mediaDeviceVersion.set(t.publicationId,e);const i={publicationId:t.publicationId,mediaDeviceName:t.mediaDeviceName,mediaDeviceVersion:e,mediaDeviceTrigger:t.mediaDeviceTrigger,updatedAt:t.updatedAt},n=new fa("MediaDeviceReport",i);yield this._sendClientEvent(n).catch(r=>{this._logger.warn("_sendClientEvent in sendMediaDeviceReport is failed",r)})})}sendBindingRtcPeerConnectionToSubscription(t){return j(this,null,function*(){const e=new fa("BindingRtcPeerConnectionToSubscription",t);yield this._sendClientEvent(e).catch(i=>{this._logger.warn("_sendClientEvent in sendBindingRtcPeerConnectionToSubscription is failed",i)})})}filterStatsReport(t){const e=Array.from(t.values()).find(s=>s.type==="transport"&&s.dtlsState==="connected"),i=[];if(e){const s=Array.from(t.values()).find(o=>o.type==="candidate-pair"&&o.nominated&&o.id===(e==null?void 0:e.selectedCandidatePairId));s&&i.push(s.id,s.localCandidateId,s.remoteCandidateId,s.transportId)}else{const s=Array.from(t.values()).find(o=>o.type==="candidate-pair"&&o.nominated&&o.selected);s&&i.push(s.id,s.localCandidateId,s.remoteCandidateId,s.transportId)}const n=new Map,r=["candidate-pair","local-candidate","remote-candidate","transport"];for(const[s,o]of t.entries())r.includes(o.type)?i.includes(o.id)&&n.set(s,o):n.set(s,o);return n}bundleStatsReportByStatsType(t){const e={};for(const i of t.values())e[i.type]=i;return e}sendSubscriptionStatsReport(t,e){return j(this,null,function*(){var i;const n=this._previousSubscriptionStats.get(e.subscriptionId);if(this._previousSubscriptionStats.set(e.subscriptionId,{stats:t,createdAt:e.createdAt}),n===void 0)return;const r=this.filterStatsReport(n.stats),s=this.bundleStatsReportByStatsType(r),o=n.createdAt,c=(e.createdAt-o)/1e3;if(c<=0)throw new Error("duration must be greater than 0. also sendSubscriptionStatsReport was duplicated.");const h=this.filterStatsReport(t),d=this.bundleStatsReportByStatsType(h),p={};for(const{type:_,properties:S}of this._statsRequest.types)for(const[E,{normalization:M,outputKey:R,contentType:N}]of Object.entries(S)){if(!N.includes(e.contentType))continue;const b=d[_];if(!(b===void 0||b[E]===void 0))if(M){const m=(i=s[_])==null?void 0:i[E];if(m===void 0){this._logger.warn(`${_} in previous statsReport is undefined`);continue}const w=(Number(b[E])-Number(m))/c;p[_]=we(ae({},p[_]),{[R]:String(w)})}else p[_]=we(ae({},p[_]),{[R]:String(b[E])})}const v={subscriptionId:e.subscriptionId,stats:p,role:e.role,createdAt:e.createdAt},g=new fa("SubscriptionStatsReport",v);yield this._sendClientEvent(g).catch(_=>{this._logger.warn("_sendClientEvent in sendSubscriptionStatsReport is failed",_)})})}sendRtcPeerConnectionEventReport(t){return j(this,null,function*(){const e=new fa("RtcPeerConnectionEventReport",t);yield this._sendClientEvent(e).catch(i=>{this._logger.warn("_sendClientEvent in sendRtcPeerConnectionEventReport is failed",i)})})}sendPublicationUpdateEncodingsReport(t){return j(this,null,function*(){let e=this._encodingsVersion.get(t.publicationId);e===void 0?e=0:e++,this._encodingsVersion.set(t.publicationId,e);const i={publicationId:t.publicationId,encodings:t.encodings,encodingsVersion:e,updatedAt:t.updatedAt},n=new fa("PublicationUpdateEncodingsReport",i);yield this._sendClientEvent(n).catch(r=>{this._logger.warn("_sendClientEvent in sendPublicationUpdateEncodingsReport is failed",r)})})}sendSubscriptionUpdatePreferredEncodingReport(t){return j(this,null,function*(){let e=this._preferredEncodingVersion.get(t.subscriptionId);e===void 0?e=0:e++,this._preferredEncodingVersion.set(t.subscriptionId,e);const i={subscriptionId:t.subscriptionId,preferredEncodingIndex:t.preferredEncodingIndex,preferredEncodingVersion:e,updatedAt:t.updatedAt},n=new fa("SubscriptionUpdatePreferredEncodingReport",i);yield this._sendClientEvent(n).catch(r=>{this._logger.warn("_sendClientEvent in sendSubscriptionUpdatePreferredEncodingReport is failed",r)})})}_sendClientEvent(t){return j(this,null,function*(){return new Promise((e,i)=>j(this,null,function*(){if(this._socket===void 0||this._socket.connectionState==="closed"){i(new Error("websocket is not connected"));return}if(this._socket.connectionState==="connecting"){this._socket.pushResendClientEventsQueue(t),this._setAcknowledgeCallback(t.id,r=>j(this,null,function*(){r.ok?(this._acknowledgeCallbacks.delete(t.id),e()):(this._acknowledgeCallbacks.delete(t.id),i(r))})),this._logger.debug(`pushResendClientEventsQueue and setAcknowledgeCallback. clientEvent.id: ${t.id}`),i(new Error("websocket is connecting now"));return}const n=new $x({times:6,interval:500,jitter:100});for(;!n.exceeded;){const r=setTimeout(()=>j(this,null,function*(){if(this._socket===void 0){this._acknowledgeCallbacks.delete(t.id),i(new Error("Socket closed when trying to resend"));return}else this._socket.resendAfterReconnect(t);i(new Error("Timeout to send data"))}),Yx*1e3);this._logger.debug(`send clientEvent, ${JSON.stringify(t)}`),this._socket.send(t).catch(o=>{this._acknowledgeCallbacks.delete(t.id),clearTimeout(r),i(o)});const s=yield this._waitForAcknowledge(t.id).catch(o=>o);if(clearTimeout(r),Op(s))if(s.reason==="unexpected")yield n.wait();else{i(s);return}else{e();return}}i(new Error("unexpected has occurred at server"))}))})}_waitForAcknowledge(t){return j(this,null,function*(){return new Promise((e,i)=>{this._setAcknowledgeCallback(t,n=>j(this,null,function*(){n.ok?(this._acknowledgeCallbacks.delete(t),e()):(this._acknowledgeCallbacks.delete(t),i(n))}))})})}_reconnectWithNewSkyWayAuthToken(){return j(this,null,function*(){this._disconnect(),this._newToken!==void 0?(this._token=this._newToken,this._newToken=void 0,yield this.connect()):this._logger.warn("new token is not set. so not reconnect.")})}_eventReceivedHandler(t){switch(t.type){case"Acknowledge":this._acknowledgeHandler(t.payload);break;case"Open":break;default:t.type,this._logger.warn(`Unknown event: ${t.type}`)}}_acknowledgeHandler(t){if(!Op(t))throw new Error("Invalid payload");const{eventId:e}=t;if(!this._acknowledgeCallbacks.has(e))throw new Error(`acknowledge event has unknown eventId: ${e}`);const i=this._acknowledgeCallbacks.get(e);i&&(this._acknowledgeCallbacks.delete(e),i(t))}_setAcknowledgeCallback(t,e){this._acknowledgeCallbacks.set(t,e)}_cleanupAnalyticsClientMaps(){this._mediaDeviceVersion.clear(),this._encodingsVersion.clear(),this._preferredEncodingVersion.clear(),this._previousSubscriptionStats.clear()}getIntervalSec(){return this._statsRequest.intervalSec}isConnectionEstablished(){return!(!this._socket||this._socket.connectionState==="connecting"||this._socket.connectionState==="closed")}isClosed(){return this._isClosed}};ne();ne();ne();ne();ne();ne();ne();var Qx="rtc-api.skyway.ntt.com",Ls=2e4,e1=8;ne();var gn={timeout:{name:"timeout",detail:"",solution:""},internalError:{name:"internalError",detail:"",solution:""},invalidParameter:{name:"invalidParameter",detail:"",solution:""},connectionDisconnected:{name:"connectionDisconnected",detail:"",solution:""},websocketConnectionFailure:{name:"connectionFailure",detail:"",solution:""},rpcResponseError:{name:"rpcResponseError",detail:"",solution:"",error:{}},onClosedWhileRequesting:{name:"onClosedWhileRequesting",detail:"request",solution:""},failedToConnectRtcAPI:{name:"failedToConnectRtcAPI",detail:"rtc-api server",solution:"Token"},failedToUpdateMemberTTL:{name:"failedToUpdateMemberTTL",detail:"updateMemberTTL",solution:""}};ne();var t1=Hn(vh());ne();function Ln({operationName:t,info:e,error:i,path:n,payload:r,channelId:s,appId:o,memberId:c}){return new Xn({error:i,info:e,payload:{payload:r,operationName:t,channelId:s,appId:o,memberId:c},path:n})}function _r({appId:t,detail:e,channelId:i,operationName:n,payload:r,memberId:s}){return{operationName:n,payload:r,detail:e,appId:t,channelId:i,memberId:s}}var zi=new ft("packages/rtc-rpc-api-client/src/rpc.ts"),i1=class{constructor(){this._id=Vr(),this.closed=!1,this.negotiated=!1,this._reconnecting=!1,this._pendingRequests=[],this._events=new jr,this._onMessage=this._events.make(),this.onNotify=this._events.make(),this.onFatalError=this._events.make(),this.onDisconnected=this._events.make(),this.onClosed=this._events.make(),this._send=t=>new Promise((e,i)=>j(this,null,function*(){if(yield new Promise(n=>setTimeout(n,0)),this._ws.readyState!==this._ws.OPEN){i(Ln({operationName:"RPC._send",info:we(ae({},gn.internalError),{detail:"wrong state"}),path:zi.prefix,payload:{request:t,wsReadyState:Up[this._ws.readyState]}}));return}this._ws.send(JSON.stringify(t),n=>{if(n)throw i(Ln({operationName:"RPC._send",info:we(ae({},gn.internalError),{detail:"failed to send rpc message"}),path:zi.prefix,error:n}))}),e()}))}set reconnecting(t){this._reconnecting=t}get reconnecting(){return this._reconnecting}connect(t){return j(this,arguments,function*({domain:e,token:i,secure:n}){const r=i;this._ws=new t1.default(`${n?"wss":"ws"}://${e}/ws`,r),this._ws.onmessage=o=>{this._onMessage.emit(JSON.parse(o.data))},this._ws.onclose=()=>j(this,null,function*(){zi.debug("websocket closed",{id:this._id}),this.onDisconnected.emit()}),this._onMessage.add(o=>{n1(o)&&this.onNotify.emit(o)});const s=yield new Promise((o,c)=>{const h=setTimeout(()=>{c(Ln({operationName:"RPC.connect",info:we(ae({},gn.timeout),{detail:"ws.open"}),path:zi.prefix}))},5e3);this._ws.onerror=d=>{c(Ln({operationName:"RPC.connect",info:gn.websocketConnectionFailure,path:zi.prefix,error:d}))},this._ws.onopen=()=>{clearTimeout(h),o()}}).catch(o=>o);if(s)throw s;this.negotiated=!0})}close(){this.closed||(this.closed=!0,zi.debug("closed"),this._ws.close(),this.onClosed.emit(),this._events.dispose())}resolvePendingRequests(){zi.debug("resolve pendingRequests",[...this._pendingRequests]),this._pendingRequests.forEach(t=>j(this,null,function*(){yield this._send(t)})),this._pendingRequests=[]}request(t,e){return j(this,null,function*(){if(this.closed)throw Ln({operationName:"RPC.request",info:we(ae({},gn.internalError),{detail:"rpc closed"}),path:zi.prefix,payload:{method:t,params:e,id:this._id}});let i=!1;try{const n=Sd(t,e),r=()=>j(this,null,function*(){return yield this._onMessage.watch(c=>c.id===n.id,Ls).catch(()=>{if(!i)throw Ln({operationName:"RPC.request",info:we(ae({},gn.timeout),{detail:"rpc request timeout"}),path:zi.prefix,payload:{rpcTimeout:Ls,method:t,params:e,wsReadyState:Up[this._ws.readyState],id:this._id}})})}),s=()=>j(this,null,function*(){zi.warn("[start] reconnecting. pending request",_r({operationName:"RPC.request",detail:"[start] reconnecting. pending request",payload:{request:n,id:this._id}})),this._pendingRequests.push(n);const c=yield Promise.race([r(),this.onFatalError.asPromise(Ls+100).then(h=>{throw i||zi.error("[failed] reconnecting. pending request",Ln({operationName:"RPC.request",info:we(ae({},gn.internalError),{detail:"onFatalError while request"}),path:zi.prefix}),h),h})]);return i=!0,zi.warn("[end] reconnecting. pending request",_r({operationName:"RPC.request",detail:"[end] reconnecting. pending request",payload:{request:n,id:this._id}})),c});let o;if(this._reconnecting?o=yield s():(this._send(n).catch(c=>{zi.error("send error",c)}),o=yield Promise.race([r(),j(this,null,function*(){if(yield this.onDisconnected.asPromise(Ls+100),i)return{};try{const c=yield s();return zi.warn(_r({operationName:"request.pendingRequest",detail:"success to handle disconnected"})),c}catch(c){throw Ln({operationName:"RPC.request",info:gn.connectionDisconnected,path:zi.prefix,error:c})}}),this.onFatalError.asPromise(Ls+100).then(c=>{if(i)return{};throw Ln({operationName:"RPC.request",info:we(ae({},gn.internalError),{detail:"onFatalError while requesting"}),path:zi.prefix,error:c})}),this.onClosed.asPromise(Ls+100).then(()=>{if(i)return{};throw Ln({operationName:"RPC.request",info:gn.onClosedWhileRequesting,path:zi.prefix,payload:{method:t,params:e}})})]),i=!0),o.error)throw zi.warn("[failed] request ",{message:o,method:t,params:e}),Ln({operationName:"RPC.request",info:we(ae({},gn.rpcResponseError),{detail:t,error:o.error}),payload:{message:o,method:t,params:e},path:zi.prefix});return o.result}catch(n){throw i=!0,n}})}notify(t,e){return j(this,null,function*(){const i=Sd(t,e,!0);yield this._send(i)})}batch(t){return j(this,null,function*(){const e=t.map(({method:n,params:r})=>Sd(n,r));return this._send(e).catch(n=>{throw n}),yield Promise.all(e.map(n=>j(this,[n],function*({id:r}){return yield this._onMessage.watch(o=>o.id===r,Ls)})))})}},Sd=(t,e,i)=>{if(i)return{jsonrpc:"2.0",method:t,params:e};const n=Vr();return{jsonrpc:"2.0",method:t,params:e,id:n}},n1=t=>{const e=t;return!!(e.method&&e.id==null)},Up=["CONNECTING","OPEN","CLOSING","CLOSED"],Hi=new ft("packages/rtc-rpc-api-client/src/client.ts"),Bp,Hp,r1=class{constructor(t){this.config=t,this.closed=!1,this._domain=(Bp=this.config.domain)!=null?Bp:Qx,this._secure=(Hp=this.config.secure)!=null?Hp:!0,this._token=this.config.token,this._rpc=new i1,this._subscribingChannelEvents=new Set,this._subscribingChannelVersions={},this._httpClient=new Ch(`http${this.config.secure?"s":""}://${this.config.domain}`),this._reconnectCount=0,this._reconnectLimit=e1,this._events=new jr,this.onEvent=this._events.make(),this.onFatalError=this._events.make(),this.onClose=this._events.make(),this.onReconnected=this._events.make();var e,i,n,r;ft.level=(i=(e=t.log)==null?void 0:e.level)!=null?i:ft.level,ft.format=(r=(n=t.log)==null?void 0:n.format)!=null?r:ft.format,Hi.debug("RtcRpcApiClient spawned",t),this._rpc.onNotify.add(s=>{if(s.method==="channelEventNotification"){const o=s.params;this._subscribingChannelVersions[o.data.channel.id]=o.data.channel.version,this.onEvent.emit({channelId:o.data.channel.id,event:o})}}),this._rpc.onDisconnected.add(()=>j(this,null,function*(){this._rpc.negotiated&&!this._rpc.closed&&!this._rpc.reconnecting&&(yield this._reconnect())})),this._rpc.onFatalError.once(s=>{Hi.error("fatal error",s),this.onFatalError.emit(s),this.close()})}get token(){return this._token}_reconnect(){return j(this,null,function*(){if(this._reconnectCount>=this._reconnectLimit){this._rpc.onFatalError.emit(Ln({operationName:"RtcRpcApiClient._reconnect",info:{name:"failed to reconnect",detail:"_reconnectLimit exceeded",solution:""},path:Hi.prefix})),this.close();return}this._rpc.reconnecting=!0,Hi.warn("[start] reconnect",_r({operationName:"RtcRpcApiClient._reconnect",detail:"reconnect start",payload:{reconnectCount:this._reconnectCount,limit:this._reconnectLimit}})),this._reconnectCount++;const t=ns(this._reconnectCount,2)*100+ns(this._reconnectCount,2)*100*Math.random();yield new Promise(e=>setTimeout(e,t));try{yield this.connect().catch(e=>{throw Hi.warn("[failed] reconnect rtc api",_r({operationName:"RtcRpcApiClient._reconnect",detail:"connect rpc failed",payload:{reconnectCount:this._reconnectCount}}),e),e}),this._rpc.reconnecting=!1,this._reconnectCount=0,this._rpc.resolvePendingRequests(),yield Promise.all([...this._subscribingChannelEvents].map(e=>j(this,null,function*(){const[i,n]=e.split(":"),r=this._subscribingChannelVersions[n];yield this.subscribeChannelEvents({appId:i,channelId:n,offset:r})}))).catch(e=>{throw Hi.warn("subscribeChannelEvents failed",_r({operationName:"RtcRpcApiClient._reconnect",detail:"subscribeChannelEvents failed",payload:{reconnectCount:this._reconnectCount}}),e),e}),Hi.warn("[end] reconnect",_r({operationName:"RtcRpcApiClient._reconnect",detail:"reconnect finished",payload:{reconnectCount:this._reconnectCount}})),this.onReconnected.emit()}catch(e){Hi.warn("[failed] reconnect",_r({operationName:"RtcRpcApiClient._reconnect",detail:"reconnect failed",payload:{reconnectCount:this._reconnectCount}}),e),yield this._reconnect()}})}updateToken(t){return j(this,null,function*(){Hi.debug("token update",{token:t}),this._token=t,yield this._updateAuthToken()})}close(){this.closed||(this.closed=!0,Hi.debug("closed"),this._rpc.close(),this.onClose.emit(),this._events.dispose())}health(){return j(this,null,function*(){return yield this._httpClient.get("/health")})}connect(){return j(this,null,function*(){Hi.debug("connect to rtc api rpc",this._domain),yield this._rpc.connect({domain:this._domain,token:this.token,secure:this._secure}).catch(t=>{throw Ln({operationName:"RtcRpcApiClient.connect",info:gn.failedToConnectRtcAPI,error:t,path:Hi.prefix})})})}_channelSubscribed(t,e){this._subscribingChannelEvents.add(t+":"+e),Hi.debug("_channelSubscribed",{appId:t,channelId:e,_subscribingChannelEvents:[...this._subscribingChannelEvents]})}_isSubscribingChannel(t,e){return this._subscribingChannelEvents.has(t+":"+e)}createChannel(t){return j(this,arguments,function*({name:e,metadata:i,appId:n}){const{channel:r}=yield this._rpc.request("createChannel",{name:e,metadata:i,appId:n,authToken:this.token});return this._channelSubscribed(n,r.id),r})}findOrCreateChannel(t){return j(this,arguments,function*({name:e,metadata:i,appId:n}){const{channel:r}=yield this._rpc.request("findOrCreateChannel",{name:e,metadata:i,appId:n,authToken:this.token});return this._channelSubscribed(n,r.id),r})}getChannel(t){return j(this,arguments,function*({appId:e,id:i}){const n=yield this._rpc.request("getChannel",{id:i,appId:e,authToken:this.token});return this._isSubscribingChannel(e,i)||(this._channelSubscribed(e,i),yield this.subscribeChannelEvents({appId:e,channelId:i,offset:n.channel.version})),n.channel})}getChannelByName(t){return j(this,arguments,function*({name:e,appId:i}){const n=yield this._rpc.request("getChannelByName",{name:e,appId:i,authToken:this.token}),r=n.channel.id;return this._isSubscribingChannel(i,r)||(this._channelSubscribed(i,r),yield this.subscribeChannelEvents({appId:i,channelId:r,offset:n.channel.version})),n.channel})}deleteChannel(t){return j(this,arguments,function*({id:e,appId:i}){yield this._rpc.request("deleteChannel",{id:e,appId:i,authToken:this.token})})}updateChannelMetadata(t){return j(this,arguments,function*({id:e,metadata:i,appId:n}){yield this._rpc.request("updateChannelMetadata",{id:e,metadata:i,appId:n,authToken:this.token})})}addMember(t){return j(this,arguments,function*({channelId:e,name:i,metadata:n,subscribeChannelEvents:r,appId:s,ttlSec:o,subtype:c,type:h}){return yield this._rpc.request("addMember",{channelId:e,name:i,metadata:n,subscribeChannelEvents:r,appId:s,ttlSec:o&&parseInt(o.toString()),authToken:this.token,subtype:c,type:h})})}updateMemberTtl(t){return j(this,arguments,function*(e,i=new br({times:8})){const{appId:n,channelId:r,memberId:s,ttlSec:o}=e;try{yield this._rpc.request("updateMemberTtl",{appId:n,channelId:r,memberId:s,ttlSec:o&&parseInt(o.toString()),authToken:this.token})}catch(c){if(!i.exceeded)Hi.warn("retry updateMemberTtl",_r({operationName:"RtcRpcApiClient.updateMemberTtl",detail:"retry updateMemberTtl",appId:n,channelId:r,memberId:s,payload:{backoff:i.count}}),c),yield i.wait(),yield this.updateMemberTtl(e,i);else throw new Xn({path:Hi.prefix,info:gn.failedToUpdateMemberTTL,error:c})}})}updateMemberMetadata(t){return j(this,arguments,function*({channelId:e,memberId:i,metadata:n,appId:r}){yield this._rpc.request("updateMemberMetadata",{channelId:e,memberId:i,metadata:n,appId:r,authToken:this.token})})}leaveChannel(t){return j(this,arguments,function*({channelId:e,id:i,appId:n}){yield this._rpc.request("removeMember",{channelId:e,id:i,appId:n,authToken:this.token})})}publishStream(t){return j(this,arguments,function*({appId:e,channelId:i,publisherId:n,contentType:r,metadata:s,origin:o,codecCapabilities:c,encodings:h,isEnabled:d}){return{publicationId:(yield this._rpc.request("publishStream",{channelId:i,publisherId:n,contentType:r[0].toUpperCase()+r.slice(1),metadata:s,origin:o,codecCapabilities:c,encodings:h==null?void 0:h.map(v=>({id:v.id})),isEnabled:d,appId:e,authToken:this.token})).id}})}disablePublication(t){return j(this,arguments,function*({channelId:e,publicationId:i,appId:n}){yield this._rpc.request("disablePublication",{channelId:e,appId:n,publicationId:i,authToken:this.token})})}enablePublication(t){return j(this,arguments,function*({channelId:e,publicationId:i,appId:n}){yield this._rpc.request("enablePublication",{channelId:e,appId:n,publicationId:i,authToken:this.token})})}updatePublicationMetadata(t){return j(this,arguments,function*({channelId:e,publicationId:i,appId:n,metadata:r}){yield this._rpc.request("updatePublicationMetadata",{channelId:e,publicationId:i,metadata:r,appId:n,authToken:this.token})})}unpublishStream(t){return j(this,arguments,function*({channelId:e,publicationId:i,appId:n}){yield this._rpc.request("unpublishStream",{channelId:e,publicationId:i,appId:n,authToken:this.token})})}subscribeStream(t){return j(this,arguments,function*({channelId:e,subscriberId:i,publicationId:n,appId:r}){return{subscriptionId:(yield this._rpc.request("subscribeStream",{channelId:e,subscriberId:i,publicationId:n,appId:r,authToken:this.token})).id}})}unsubscribeStream(t){return j(this,arguments,function*({channelId:e,subscriptionId:i,appId:n}){yield this._rpc.request("unsubscribeStream",{channelId:e,subscriptionId:i,appId:n,authToken:this.token})})}getServerUnixtime(t){return j(this,arguments,function*(e,i=new br({times:8})){const{appId:n}=e;try{return(yield this._rpc.request("getServerUnixtime",{appId:n,authToken:this.token})).unixtime}catch(r){if(i.exceeded)throw r;return Hi.warn(_r({operationName:"RtcRpcApiClient.getServerUnixtime",detail:"retry getServerUnixtime",appId:n,payload:{backoff:i.count}}),r),yield i.wait(),this.getServerUnixtime(e,i)}})}_updateAuthToken(){return j(this,null,function*(){yield this._rpc.request("updateAuthToken",{authToken:this.token})})}subscribeChannelEvents(t){return j(this,arguments,function*({appId:e,channelId:i,offset:n}){try{Hi.debug("[start] subscribeChannelEvents",{offset:n}),yield this._rpc.request("subscribeChannelEvents",{appId:e,authToken:this.token,channelId:i,offset:n}),Hi.debug("[end] subscribeChannelEvents",{offset:n})}catch(r){if(r instanceof Xn&&r.info.name===gn.connectionDisconnected.name)Hi.warn("reconnect happened while subscribeChannelEvents. retry",_r({operationName:"RtcRpcApiClient.subscribeChannelEvents",detail:"reconnect happened while subscribeChannelEvents. retry",appId:e,channelId:i,payload:{offset:n}}),r),yield this.subscribeChannelEvents({appId:e,channelId:i,offset:n});else throw Hi.error("[failed] subscribeChannelEvents",Ln({operationName:"RtcRpcApiClient.subscribeChannelEvents",info:we(ae({},gn.internalError),{detail:"subscribeChannelEvents failed"}),path:Hi.prefix,error:r,payload:{offset:n},appId:e,channelId:i})),r}})}};ne();ne();var s1=Hn(cm()),a1=class{constructor(t={}){this.rtcApi={domain:"rtc-api.skyway.ntt.com",timeout:3e4,secure:!0,eventSubscribeTimeout:5e3},this.log={level:"error",format:"object"},Object.assign(this,(0,s1.default)(this,t))}};ne();ne();var wt=we(ae({},gn),{invalidParameter:{name:"invalidParameter",detail:"",solution:""},notFound:{name:"notFound",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},internalError:{name:"internalError",detail:"",solution:""},invalidRequestParameter:{name:"invalidRequestParameter",detail:"",solution:"API"},insufficientPermissions:{name:"insufficientPermissions",detail:"token Token permissions are insufficient",solution:"Token Add the necessary permissions to the Token"},publicationNestedTooMuch:{name:"publicationNestedTooMuch",detail:"originPublicationPublicationorigin It is not possible to specify the origin of a publication for which Origin has been set",solution:" There is no solution because it is a specification limitation"},channelNotFound:{name:"channelNotFound",detail:"channel The channel you tried to reference does not exist.",solution:"channelIdchannelName Make sure that the Channel id and channel name are correct."},memberNotFound:{name:"memberNotFound",detail:"Member The member you tried to reference does not exist.",solution:"memberIdmemberName Make sure that the member id and member name is correct."},publicationNotFound:{name:"publicationNotFound",detail:"Publication The Publication you tried to reference does not exist.",solution:"publicationId Make sure that the publication id is correct."},subscriptionNotFound:{name:"subscriptionNotFound",detail:"Subscription The Subscription you tried to reference does not exist.",solution:"subscriptionId Make sure that the subscription id is correct."},operationConflicted:{name:"operationConflicted",detail:" The channel with the given name has already been created by a conflicting request up to now",solution:"channel"},channelNameDuplicated:{name:"channelNameDuplicated",detail:"Channel A channel with that name already exists",solution:"channel"},memberNameDuplicated:{name:"memberNameDuplicated",detail:"Member A member with that name already exists",solution:"member"},subscriptionAlreadyExists:{name:"subscriptionAlreadyExists",detail:"PublicationSubscribe",solution:"publicationId"},rateLimitExceeded:{name:"rateLimitExceeded",detail:"",solution:""},authTokenExpired:{name:"authTokenExpired",detail:"AuthToken",solution:"ExpAuthToken"},serverBusy:{name:"serverBusy",detail:"",solution:""}});ne();function jp({appId:t,detail:e,channelId:i,operationName:n,payload:r}){return{operationName:n,payload:r,detail:e,appId:t,channelId:i}}function xt({operationName:t,info:e,error:i,path:n,channelId:r,appId:s,payload:o}){return new Xn({error:i,info:e,payload:{payload:o,operationName:t,channelId:r,appId:s},path:n})}var Ht=new ft("packages/rtc-api-client/src/infrastructure/api.ts"),o1=class{constructor(t){this._client=t,this.closed=!1,this.onClose=new gt,this.onFatalError=new gt,this._token=Xa.Decode(this._client.token),t.onClose.once(()=>{this.close()}),t.onFatalError.add(e=>{this.onFatalError.emit(e)})}connect(){return j(this,null,function*(){yield this._client.connect()})}updateAuthToken(t){return j(this,null,function*(){this._token=Xa.Decode(t),yield this._client.updateToken(t)})}close(){this.closed||(this.closed=!0,Ht.debug("closed"),this._client.close(),this.onClose.emit(),this.onClose.removeAllListeners())}_commonError(t,e,i){switch(e){case-32602:return xt({operationName:t,info:wt.invalidRequestParameter,path:Ht.prefix,error:i});case-32603:return xt({operationName:t,info:wt.internalError,path:Ht.prefix,error:i});case 403:case 4030:return xt({operationName:t,info:wt.insufficientPermissions,path:Ht.prefix,error:i})}}createChannel(t,e){return j(this,null,function*(){const{id:i}=yield this._client.createChannel({appId:t,name:e.name,metadata:e.metadata}).catch(r=>{var s,o,c;const{info:h}=r,d=this._commonError("RtcApiImpl.createChannel",(o=(s=h==null?void 0:h.error)==null?void 0:s.code)!=null?o:-1,r);if(d)throw d;switch((c=h==null?void 0:h.error)==null?void 0:c.code){case 404:throw xt({operationName:"RtcApiImpl.createChannel",path:Ht.prefix,info:wt.channelNotFound,error:r});case 409:throw xt({operationName:"RtcApiImpl.createChannel",path:Ht.prefix,info:wt.channelNameDuplicated,error:r});default:throw xt({operationName:"RtcApiImpl.createChannel",path:Ht.prefix,info:wt.internalError,error:r})}});return yield this.getChannel(t,{id:i})})}getChannel(t,e){return j(this,arguments,function*(i,{name:n,id:r}){if(r)return yield this._client.getChannel({appId:i,id:r}).catch(s=>{var o,c,h;const{info:d}=s,p=this._commonError("RtcApiImpl.getChannel",(c=(o=d==null?void 0:d.error)==null?void 0:o.code)!=null?c:-1,s);if(p)throw p;switch((h=d==null?void 0:d.error)==null?void 0:h.code){case 404:throw xt({operationName:"RtcApiImpl.getChannel",path:Ht.prefix,info:wt.channelNotFound,error:s});default:throw xt({operationName:"RtcApiImpl.getChannel",path:Ht.prefix,info:wt.internalError,error:s})}});if(n)return yield this._client.getChannelByName({appId:i,name:n}).catch(s=>{var o,c,h;const{info:d}=s,p=this._commonError("RtcApiImpl.getChannel",(c=(o=d==null?void 0:d.error)==null?void 0:o.code)!=null?c:-1,s);if(p)throw p;switch((h=d==null?void 0:d.error)==null?void 0:h.code){case 404:throw xt({operationName:"getChannel",path:Ht.prefix,info:wt.channelNotFound,error:s});default:throw xt({operationName:"getChannel",path:Ht.prefix,info:wt.internalError,error:s})}});throw xt({operationName:"RtcApiImpl.createChannel",path:Ht.prefix,info:wt.invalidRequestParameter})})}findOrCreateChannel(t,e){return j(this,null,function*(){return this._client.findOrCreateChannel(we(ae({},e),{appId:t})).catch(i=>{var n,r,s,o;const{info:c}=i,h=this._commonError("RtcApiImpl.findOrCreateChannel",(r=(n=c==null?void 0:c.error)==null?void 0:n.code)!=null?r:-1,i);if(h)throw h;if(e.name&&((s=c==null?void 0:c.error)==null?void 0:s.code)===409)return this.getChannel(t,{name:e.name});switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.findOrCreateChannel",path:Ht.prefix,info:wt.channelNotFound,error:i});case 409:throw xt({operationName:"RtcApiImpl.findOrCreateChannel",path:Ht.prefix,info:wt.channelNameDuplicated,error:i});default:throw xt({operationName:"RtcApiImpl.findOrCreateChannel",path:Ht.prefix,info:wt.internalError,error:i})}})})}deleteChannel(t,e){return j(this,null,function*(){yield this._client.deleteChannel({appId:t,id:e}).catch(i=>{var n,r,s;const{info:o}=i,c=this._commonError("RtcApiImpl.deleteChannel",(r=(n=o==null?void 0:o.error)==null?void 0:n.code)!=null?r:-1,i);if(c)throw c;switch((s=o==null?void 0:o.error)==null?void 0:s.code){case 404:throw xt({operationName:"RtcApiImpl.deleteChannel",path:Ht.prefix,info:wt.channelNotFound,error:i});default:throw xt({operationName:"RtcApiImpl.deleteChannel",path:Ht.prefix,info:wt.internalError,error:i})}})})}updateChannelMetadata(t,e,i){return j(this,null,function*(){yield this._client.updateChannelMetadata({appId:t,id:e,metadata:i}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.updateChannelMetadata",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.updateChannelMetadata",path:Ht.prefix,info:wt.channelNotFound,error:n});default:throw xt({operationName:"RtcApiImpl.updateChannelMetadata",path:Ht.prefix,info:wt.internalError,error:n})}})})}join(t,e,i){return j(this,null,function*(){const{memberId:n}=yield this._client.addMember({appId:t,channelId:e,name:i.name,metadata:i.metadata,ttlSec:i.ttlSec,type:i.type,subtype:i.subtype}).catch(s=>{var o,c,h;const{info:d}=s,p=this._commonError("RtcApiImpl.addMember",(c=(o=d==null?void 0:d.error)==null?void 0:o.code)!=null?c:-1,s);if(p)throw p;switch((h=d==null?void 0:d.error)==null?void 0:h.code){case 404:throw xt({operationName:"RtcApiImpl.addMember",path:Ht.prefix,info:wt.channelNotFound,error:s});case 409:throw xt({operationName:"RtcApiImpl.addMember",path:Ht.prefix,info:wt.memberNameDuplicated,error:s});default:throw xt({operationName:"RtcApiImpl.addMember",path:Ht.prefix,info:wt.internalError,error:s})}});return{id:n,name:i.name,type:i.type,subtype:i.subtype,metadata:i.metadata}})}updateMemberTtl(t,e,i,n){return j(this,null,function*(){yield this._client.updateMemberTtl({appId:t,channelId:e,memberId:i,ttlSec:n}).catch(r=>{var s,o,c;const{info:h}=r,d=this._commonError("RtcApiImpl.updateMemberTtl",(o=(s=h==null?void 0:h.error)==null?void 0:s.code)!=null?o:-1,r);if(d)throw d;switch((c=h==null?void 0:h.error)==null?void 0:c.code){case 404:throw xt({operationName:"RtcApiImpl.updateMemberTtl",path:Ht.prefix,info:wt.memberNotFound,error:r});default:throw xt({operationName:"RtcApiImpl.updateMemberTtl",path:Ht.prefix,info:wt.internalError,error:r})}})})}getServerUnixtime(t){return j(this,null,function*(){return yield this._client.getServerUnixtime({appId:t}).catch(e=>{var i,n;const{info:r}=e,s=this._commonError("RtcApiImpl.getServerUnixtime",(n=(i=r==null?void 0:r.error)==null?void 0:i.code)!=null?n:-1,e);throw s||xt({operationName:"RtcApiImpl.getServerUnixtime",path:Ht.prefix,info:wt.internalError,error:e})})})}updateMemberMetadata(t,e,i,n){return j(this,null,function*(){yield this._client.updateMemberMetadata({appId:t,channelId:e,memberId:i,metadata:n}).catch(r=>{var s,o,c;const{info:h}=r,d=this._commonError("RtcApiImpl.updateMemberMetadata",(o=(s=h==null?void 0:h.error)==null?void 0:s.code)!=null?o:-1,r);if(d)throw d;switch((c=h==null?void 0:h.error)==null?void 0:c.code){case 404:throw xt({operationName:"RtcApiImpl.updateMemberMetadata",path:Ht.prefix,info:wt.memberNotFound,error:r});default:throw xt({operationName:"RtcApiImpl.updateMemberMetadata",path:Ht.prefix,info:wt.internalError,error:r})}})})}leave(t,e,i){return j(this,null,function*(){yield this._client.leaveChannel({channelId:e,id:i,appId:t}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.leaveChannel",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.leaveChannel",path:Ht.prefix,info:wt.memberNotFound,error:n});default:throw xt({operationName:"RtcApiImpl.leaveChannel",path:Ht.prefix,info:wt.internalError,error:n})}})})}publish(t,e){return j(this,null,function*(){const{publicationId:i}=yield this._client.publishStream({channelId:e.channel,publisherId:e.publisher,contentType:e.contentType,metadata:e.metadata,origin:e.origin,codecCapabilities:e.codecCapabilities,encodings:e.encodings,isEnabled:e.isEnabled,appId:t}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.publish",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){default:throw xt({operationName:"RtcApiImpl.publish",path:Ht.prefix,info:wt.internalError,error:n})}});return i})}updatePublicationMetadata(t,e,i,n){return j(this,null,function*(){yield this._client.updatePublicationMetadata({channelId:e,publicationId:i,metadata:n,appId:t}).catch(r=>{var s,o,c;const{info:h}=r,d=this._commonError("RtcApiImpl.updatePublicationMetadata",(o=(s=h==null?void 0:h.error)==null?void 0:s.code)!=null?o:-1,r);if(d)throw d;switch((c=h==null?void 0:h.error)==null?void 0:c.code){case 404:throw xt({operationName:"RtcApiImpl.updatePublicationMetadata",path:Ht.prefix,info:wt.publicationNotFound,error:r});default:throw xt({operationName:"RtcApiImpl.updatePublicationMetadata",path:Ht.prefix,info:wt.internalError,error:r})}})})}disablePublication(t,e,i){return j(this,null,function*(){yield this._client.disablePublication({channelId:e,publicationId:i,appId:t}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.disablePublication",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.disablePublication",path:Ht.prefix,info:wt.publicationNotFound,error:n});default:throw xt({operationName:"RtcApiImpl.disablePublication",path:Ht.prefix,info:wt.internalError,error:n})}})})}enablePublication(t,e,i){return j(this,null,function*(){yield this._client.enablePublication({channelId:e,publicationId:i,appId:t}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.enablePublication",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.enablePublication",path:Ht.prefix,info:wt.publicationNotFound,error:n});default:throw xt({operationName:"RtcApiImpl.enablePublication",path:Ht.prefix,info:wt.internalError,error:n})}})})}unpublish(t,e,i){return j(this,null,function*(){yield this._client.unpublishStream({channelId:e,publicationId:i,appId:t}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.unpublishStream",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.unpublishStream",path:Ht.prefix,info:wt.publicationNotFound,error:n});default:throw xt({operationName:"RtcApiImpl.unpublishStream",path:Ht.prefix,info:wt.internalError,error:n})}})})}subscribe(t,e){return j(this,null,function*(){const{subscriptionId:i}=yield this._client.subscribeStream({channelId:e.channel.id,subscriberId:e.subscriber.id,publicationId:e.publication.id,appId:t}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.subscribeStream",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.subscribeStream",path:Ht.prefix,info:wt.publicationNotFound,error:n});case 409:throw xt({operationName:"RtcApiImpl.subscribeStream",path:Ht.prefix,info:wt.subscriptionAlreadyExists,error:n});default:throw xt({operationName:"RtcApiImpl.subscribeStream",path:Ht.prefix,info:wt.internalError,error:n})}});return i})}unsubscribe(t,e,i){return j(this,null,function*(){yield this._client.unsubscribeStream({appId:t,channelId:e,subscriptionId:i}).catch(n=>{var r,s,o;const{info:c}=n,h=this._commonError("RtcApiImpl.unsubscribeStream",(s=(r=c==null?void 0:c.error)==null?void 0:r.code)!=null?s:-1,n);if(h)throw h;switch((o=c==null?void 0:c.error)==null?void 0:o.code){case 404:throw xt({operationName:"RtcApiImpl.unsubscribeStream",path:Ht.prefix,info:wt.publicationNotFound,error:n});default:throw xt({operationName:"RtcApiImpl.unsubscribeStream",path:Ht.prefix,info:wt.internalError,error:n})}})})}};ne();var qs=new ft("packages/rtc-api-client/src/infrastructure/eventObserver.ts"),c1=class{constructor(t,e,i,n){this.onEvent=new gt,this._disposer=[];const r=new l1(i.version,s=>j(null,null,function*(){yield e.subscribeChannelEvents({appId:t,channelId:i.id,offset:s}),yield new Promise(o=>setTimeout(o,n.eventSubscribeTimeout)),r.packetLostHappened&&qs.error(xt({operationName:"EventObserverImpl.eventJitterBuffer",info:we(ae({},wt.internalError),{detail:"failed to resolve event lost"}),channelId:i.id,appId:t,path:qs.prefix}))}));this._disposer=[e.onEvent.add(s=>j(this,[s],function*({channelId:o,event:c}){o===i.id&&r.push({event:c,version:c.data.channel.version})})).removeListener,r.onEvent.add(s=>{this.onEvent.emit(s)}).removeListener]}dispose(){this._disposer.forEach(t=>t()),this.onEvent.removeAllListeners()}},l1=class{constructor(t,e,i=1e3){this.presentVersion=t,this.onPacketLost=e,this.packetLifetime=i,this.onEvent=new gt,this.eventBuffer={},this.packetLostHappened=!1}get expectNextVersion(){return this.presentVersion+1}push(t){const e=t.version;if(e<this.expectNextVersion){qs.debug("duplicate event",we(ae({},t),{presentVersion:this.presentVersion}));return}if(e>this.expectNextVersion){qs.debug("maybe miss order event received",we(ae({},t),{presentVersion:this.presentVersion})),this.eventBuffer[e]=t,this.handlePacketLifetime();return}this.packetLostHappened&&(qs.warn("event packetLost resolved",jp({operationName:"EventJitterBuffer.push",detail:"event packetLost resolved",payload:{eventFrame:t}})),this.packetLostHappened=!1),this.eventBuffer[e]=t,this.resolveEvents()}handlePacketLifetime(){const[t]=Object.keys(this.eventBuffer).sort().map(e=>this.eventBuffer[Number(e)]);this.packetLifeTimer==null&&t&&(qs.debug("set event packetLost timer",we(ae({},t),{presentVersion:this.presentVersion})),this.packetLifeTimer=setTimeout(()=>j(this,null,function*(){if(this.presentVersion<t.version){if(qs.warn("event packetLost",jp({operationName:"EventJitterBuffer.handlePacketLifetime",detail:"eventPacket lost",payload:{oldestBufferedEvent:t,eventBufferLength:Object.keys(this.eventBuffer).length,presentVersion:this.presentVersion}})),this.packetLostHappened)return;this.packetLostHappened=!0,yield this.onPacketLost(this.expectNextVersion)}this.packetLifeTimer=void 0,this.handlePacketLifetime()}),this.packetLifetime))}resolveEvents(){const t=[];for(let e=this.expectNextVersion;;e++){const i=this.eventBuffer[e];if(i)t.push(i),delete this.eventBuffer[e];else break}t.length>0&&(this.presentVersion=t.slice(-1)[0].version,t.forEach(e=>{this.onEvent.emit(e.event)}))}},hr=new ft("packages/rtc-api-client/src/client.ts"),d1=class $g{constructor(e,i,n,r){this.appId=e,this.config=i,this.apiClient=n,this._eventObserverFactory=r,this.closed=!1,this.onFatalError=new gt,this.apiClient.onFatalError.pipe(this.onFatalError)}static Create(e){return j(this,null,function*(){const i=new a1(e);i.log&&(ft.level=i.log.level,ft.format=i.log.format),hr.debug("RtcApiClient spawned",i);const n=new r1(we(ae({},i.rtcApi),{token:e.token,log:i.log})),r=new o1(n);yield r.connect();const s=(o,c)=>new c1(o,n,c,i.rtcApi);return new $g(e.appId,i,r,s)})}updateAuthToken(e){return j(this,null,function*(){yield this.apiClient.updateAuthToken(e)})}getServerUnixtimeInMs(){return j(this,null,function*(){return this.apiClient.getServerUnixtime(this.appId)})}getServerUnixtimeInSec(){return j(this,null,function*(){return Math.floor((yield this.getServerUnixtimeInMs())/1e3)})}createChannel(){return j(this,arguments,function*(e={}){hr.debug("[start] apiClient.createChannel",{init:e});const i=yield this.apiClient.createChannel(this.appId,e).catch(r=>{throw hr.debug("[failed] apiClient.createChannel",{init:e,e:r}),r});return hr.debug("[end] apiClient.createChannel",{init:e,channelDto:i}),wd(this.appId,this._eventObserverFactory(this.appId,i),this.apiClient,i,this.config)})}findChannel(e){return j(this,null,function*(){hr.debug("[start] apiClient.getChannel",{query:e});const i=yield this.apiClient.getChannel(this.appId,e).catch(r=>{throw hr.debug("[failed] apiClient.getChannel",{query:e,e:r}),r}),n=wd(this.appId,this._eventObserverFactory(this.appId,i),this.apiClient,i,this.config);return hr.debug("[end] apiClient.getChannel",{channelId:n.id}),n})}findOrCreateChannel(e){return j(this,null,function*(){hr.debug("[start] apiClient.findOrCreateChannel",{query:e});const i=yield this.apiClient.findOrCreateChannel(this.appId,e).catch(r=>{throw hr.debug("[failed] apiClient.findOrCreateChannel",{query:e,e:r}),r});return hr.debug("[end] apiClient.findOrCreateChannel",{query:e}),wd(this.appId,this._eventObserverFactory(this.appId,i),this.apiClient,i,this.config)})}deleteChannel(e){return this.apiClient.deleteChannel(this.appId,e)}close(){this.closed||(this.closed=!0,hr.debug("closed",{appid:this.appId}),this.apiClient.close())}};ne();ne();var u1={};ne();var fi=new ft("packages/rtc-api-client/src/domain/channel.ts"),h1=class{constructor(t,{id:e,name:i,members:n,metadata:r,publications:s,subscriptions:o,version:c},h,d,p){this.appId=t,this.eventObserver=h,this.apiClient=d,this.config=p,this.disposed=!1,this._events=new jr,this.onClosed=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberListChanged=this._events.make(),this.onMemberJoined=this._events.make(),this.onMemberLeft=this._events.make(),this.onMemberMetadataUpdated=this._events.make(),this.onPublicationDisabled=this._events.make(),this.onPublicationEnabled=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationMetadataUpdated=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.updateChannelMetadata=v=>new Promise((g,_)=>{let S=!1;this.apiClient.updateChannelMetadata(this.appId,this.id,v).catch(E=>{S=!0,_(E)}),this.onMetadataUpdated.watch(E=>E.channel.metadata===v).then(()=>g()).catch(E=>{S||_(xt({operationName:"ChannelImpl.updateChannelMetadata",info:we(ae({},wt.timeout),{detail:"onMetadataUpdated"}),path:fi.prefix,error:E,appId:this.appId,channelId:this.id}))})}),this.leave=(v,g)=>new Promise((_,S)=>{let E=!1;this.apiClient.leave(this.appId,v,g).catch(M=>{E=!0,S(M)}),this.onMemberLeft.watch(M=>M.member.id===g,this.config.rtcApi.timeout).then(()=>_()).catch(M=>{E||S(xt({operationName:"ChannelImpl.leave",info:we(ae({},wt.timeout),{detail:"onMemberLeft"}),path:fi.prefix,error:M,appId:this.appId,channelId:this.id}))})}),this.updateMemberMetadata=(v,g)=>new Promise((_,S)=>{let E=!1;this.apiClient.updateMemberMetadata(this.appId,this.id,v,g).catch(M=>{E=!0,S(M)}),this.onMemberMetadataUpdated.watch(M=>M.member.id===v&&M.member.metadata===g).then(()=>_()).catch(M=>{E||S(xt({operationName:"ChannelImpl.updateMemberMetadata",info:we(ae({},wt.timeout),{detail:"onMemberMetadataUpdated"}),path:fi.prefix,error:M,appId:this.appId,channelId:this.id}))})}),this.unpublish=v=>new Promise((g,_)=>{let S=!1;this.apiClient.unpublish(this.appId,this.id,v).catch(E=>{S=!0,_(E)}),this.onStreamUnpublished.watch(E=>E.publication.id===v).then(()=>g()).catch(E=>{S||_(xt({operationName:"ChannelImpl.unpublish",info:we(ae({},wt.timeout),{detail:"onStreamUnpublished"}),path:fi.prefix,error:E,payload:{publicationId:v},appId:this.appId,channelId:this.id}))})}),this.updatePublicationMetadata=(v,g)=>new Promise((_,S)=>{let E=!1;this.apiClient.updatePublicationMetadata(this.appId,this.id,v,g).catch(M=>{E=!0,S(M)}),this.onPublicationMetadataUpdated.watch(M=>M.publication.id===v&&M.publication.metadata===g).then(()=>_()).catch(M=>{E||S(xt({operationName:"ChannelImpl.updatePublicationMetadata",info:we(ae({},wt.timeout),{detail:"onPublicationMetadataUpdated"}),path:fi.prefix,error:M,payload:{publicationId:v},appId:this.appId,channelId:this.id}))})}),this.disablePublication=v=>new Promise((g,_)=>{let S=!1;this.apiClient.disablePublication(this.appId,this.id,v).catch(E=>{S=!0,_(E)}),this.onPublicationDisabled.watch(E=>E.publication.id===v).then(()=>g()).catch(E=>{S||_(xt({operationName:"ChannelImpl.disablePublication",info:we(ae({},wt.timeout),{detail:"onPublicationDisabled"}),path:fi.prefix,error:E,payload:{publicationId:v},appId:this.appId,channelId:this.id}))})}),this.enablePublication=v=>new Promise((g,_)=>{let S=!1;this.apiClient.enablePublication(this.appId,this.id,v).catch(E=>{S=!0,_(E)}),this.onPublicationEnabled.watch(E=>E.publication.id===v).then(()=>g()).catch(E=>{S||_(xt({operationName:"ChannelImpl.enablePublication",info:we(ae({},wt.timeout),{detail:"onPublicationEnabled"}),path:fi.prefix,error:E,payload:{publicationId:v},appId:this.appId,channelId:this.id}))})}),this.unsubscribe=v=>new Promise((g,_)=>{let S=!1;this.apiClient.unsubscribe(this.appId,this.id,v).catch(E=>{S=!0,_(E)}),this.onPublicationUnsubscribed.watch(E=>E.subscription.id===v).then(()=>g()).catch(E=>{S||_(xt({operationName:"ChannelImpl.unsubscribe",info:we(ae({},wt.timeout),{detail:"onPublicationUnsubscribed"}),path:fi.prefix,error:E,payload:{subscriptionId:v},appId:this.appId,channelId:this.id}))})}),this.id=e,this.name=i,this.metadata=r,this.members=n,this.publications=s,this.subscriptions=o,this.version=c,h.onEvent.add(v=>{fi.debug("received event: ",v),this.version=v.data.channel.version;try{switch(v.type){case"ChannelDeleted":this._channelClosed();break;case"ChannelMetadataUpdated":this._channelMetadataUpdated(v.data);break;case"MemberAdded":this._memberJoined(v.data);break;case"MemberRemoved":this._memberLeft(v.data);break;case"MemberMetadataUpdated":this._memberMetadataUpdated(v.data);break;case"StreamPublished":this._streamPublished(v.data);break;case"StreamUnpublished":this._streamUnpublished(v.data);break;case"PublicationMetadataUpdated":this._publicationMetadataUpdated(v.data);break;case"PublicationDisabled":this._publicationDisabled(v.data);break;case"PublicationEnabled":this._publicationEnabled(v.data);break;case"StreamSubscribed":this._streamSubscribed(v.data);break;case"StreamUnsubscribed":this._streamUnsubscribed(v.data);break}}catch(g){fi.error(g)}}),d.onClose.once(()=>{this.dispose()})}getMember(t){return this.members.find(e=>e.id===t)}addMember(t){const e=this.getMember(t.id);return e||(this.members.push(t),t)}deleteMember(t){this.members=this.members.filter(e=>e.id!==t)}getPublication(t){return this.publications.find(e=>e.id===t)}addPublication(t){var e,i;const n=this.getPublication(t.id);if(n)return n;const r=we(ae({},t),{channelId:this.id,codecCapabilities:(e=t.codecCapabilities)!=null?e:[],encodings:(i=t.encodings)!=null?i:[]});return this.publications.push(r),r}deletePublication(t){this.publications=this.publications.filter(e=>e.id!==t)}getSubscription(t){return this.subscriptions.find(e=>e.id===t)}addSubscription(t){const e=this.getSubscription(t.id);if(e)return e;const i=this.getPublication(t.publicationId),n=we(ae({},t),{channelId:this.id,publisherId:i.publisherId,contentType:i.contentType});return this.subscriptions.push(n),n}deleteSubscription(t){this.subscriptions=this.subscriptions.filter(e=>e.id!==t)}_channelClosed(){this.onClosed.emit({})}_channelMetadataUpdated(t){this.metadata=t.channel.metadata,this.onMetadataUpdated.emit(t)}_memberJoined(t){this.addMember(t.member),this.onMemberJoined.emit(t),this.onMemberListChanged.emit({})}_memberLeft(t){const e=this.getMember(t.member.id);if(!e)throw xt({operationName:"ChannelImpl._memberLeft",info:wt.memberNotFound,path:fi.prefix,payload:{event:t},appId:this.appId,channelId:this.id});this.deleteMember(e.id),this.onMemberLeft.emit({member:e}),this.onMemberListChanged.emit({})}_memberMetadataUpdated(t){const e=this.getMember(t.member.id);if(!e)throw xt({operationName:"ChannelImpl._memberMetadataUpdated",info:wt.memberNotFound,path:fi.prefix,payload:{event:t},appId:this.appId,channelId:this.id});e.metadata=t.member.metadata,this.onMemberMetadataUpdated.emit(t)}_streamPublished(t){const e=this.addPublication(t.publication),i=we(ae({},t),{publication:e});this.onStreamPublished.emit(i),this.onPublicationListChanged.emit({})}_streamUnpublished(t){const e=this.getPublication(t.publication.id);if(!e)throw xt({operationName:"ChannelImpl._streamUnpublished",info:wt.publicationNotFound,path:fi.prefix,payload:{event:t},appId:this.appId,channelId:this.id});this.deletePublication(e.id);const i=we(ae({},t),{publication:e});this.onStreamUnpublished.emit(i),this.onPublicationListChanged.emit({})}_publicationMetadataUpdated(t){const e=this.getPublication(t.publication.id);if(!e)throw xt({operationName:"ChannelImpl._publicationMetadataUpdated",info:wt.publicationNotFound,path:fi.prefix,payload:{event:t},appId:this.appId,channelId:this.id});e.metadata=t.publication.metadata;const i=we(ae({},t),{publication:e});this.onPublicationMetadataUpdated.emit(i)}_publicationDisabled(t){const e=this.getPublication(t.publication.id);if(!e)throw xt({operationName:"ChannelImpl._publicationDisabled",info:wt.publicationNotFound,path:fi.prefix,payload:{event:t},appId:this.appId,channelId:this.id});e.isEnabled=t.publication.isEnabled;const i={publication:e};this.onPublicationDisabled.emit(i)}_publicationEnabled(t){const e=this.getPublication(t.publication.id);if(!e)throw xt({operationName:"ChannelImpl._publicationEnabled",info:wt.publicationNotFound,path:fi.prefix,payload:{event:u1},appId:this.appId,channelId:this.id});e.isEnabled=t.publication.isEnabled;const i={publication:e};this.onPublicationEnabled.emit(i)}_streamSubscribed(t){const e=this.addSubscription(t.subscription),i=we(ae({},t),{subscription:e});this.onPublicationSubscribed.emit(i),this.onSubscriptionListChanged.emit({})}_streamUnsubscribed(t){const e=this.getSubscription(t.subscription.id);if(!e)throw xt({operationName:"ChannelImpl._streamUnsubscribed",info:wt.subscriptionNotFound,path:fi.prefix,payload:{event:t},appId:this.appId,channelId:this.id});this.deleteSubscription(e.id);const i=we(ae({},t),{subscription:e});this.onPublicationUnsubscribed.emit(i),this.onSubscriptionListChanged.emit({})}joinChannel(t){return j(this,null,function*(){var e;t.type&&(t.type=t.type[0].toUpperCase()+t.type.slice(1)),t.subtype&&(t.subtype=t.subtype[0].toUpperCase()+t.subtype.slice(1)),fi.debug("[start] joinChannel",{memberInit:t});const i=yield this.apiClient.join(this.appId,this.id,ae({},t)),n=(e=this.getMember(i.id))!=null?e:(yield this.onMemberJoined.watch(r=>r.member.id===i.id,this.config.rtcApi.timeout).catch(r=>{throw xt({operationName:"ChannelImpl.joinChannel",info:we(ae({},wt.timeout),{detail:"onMemberJoined"}),path:fi.prefix,error:r,appId:this.appId,channelId:this.id})})).member;return fi.debug("[end] joinChannel",{member:n}),n})}updateMemberTtl(t,e){return this.apiClient.updateMemberTtl(this.appId,this.id,t,e)}publish(t){return j(this,null,function*(){var e,i,n;const r=fi.debug("[start] apiClient.publish",{init:t}),s=this.id,o=yield this.apiClient.publish(this.appId,we(ae({},t),{channel:s})),c={id:o,channelId:s,publisherId:t.publisher,origin:t.origin,contentType:t.contentType,metadata:t.metadata,codecCapabilities:(e=t.codecCapabilities)!=null?e:[],encodings:(i=t.encodings)!=null?i:[],isEnabled:(n=t.isEnabled)!=null?n:!0};fi.elapsed(r,"[ongoing] apiClient.publish",{publicationDto:c});const h=this.getPublication(o);if(h)return h;const{publication:d}=yield this.onStreamPublished.watch(p=>p.publication.id===o,this.config.rtcApi.timeout).catch(p=>{throw xt({operationName:"ChannelImpl.publish",info:we(ae({},wt.timeout),{detail:"onStreamPublished"}),path:fi.prefix,error:p,payload:{publicationDto:c},appId:this.appId,channelId:this.id})});return fi.elapsed(r,"[end] apiClient.publish",{publicationDto:c}),d})}subscribe(t){return j(this,null,function*(){const e=fi.debug("[start] apiClient.subscribe",{init:t}),i=yield this.apiClient.subscribe(this.appId,we(ae({},t),{channel:this})),n={id:i,publicationId:t.publication.id,channelId:this.id,publisherId:t.publication.publisherId,subscriberId:t.subscriber.id,contentType:t.publication.contentType};fi.elapsed(e,"[ongoing] apiClient.subscribe",{subscriptionDto:n});const r=this.getSubscription(i);if(r)return fi.elapsed(e,"[end] apiClient.subscribe",{subscriptionDto:n}),r;const{subscription:s}=yield this.onPublicationSubscribed.watch(o=>o.subscription.id===i,this.config.rtcApi.timeout).catch(o=>{throw fi.elapsed(e,"[fail] apiClient.subscribe",o),xt({operationName:"ChannelImpl.subscribe",info:we(ae({},wt.timeout),{detail:"onPublicationSubscribed"}),path:fi.prefix,error:o,payload:{subscriptionDto:n}})});return fi.elapsed(e,"[end] apiClient.subscribe",{subscriptionDto:n}),s})}close(){return this.apiClient.deleteChannel(this.appId,this.id)}dispose(){this.disposed||(this.disposed=!0,fi.debug("disposed",{id:this.id}),this.eventObserver.dispose(),this._events.dispose())}};function wd(t,e,i,n,r){return new h1(t,n,e,i,r)}ne();var p1=Hn(cm()),f1=class{constructor(t={}){this.rtcApi={domain:"rtc-api.skyway.ntt.com",timeout:3e4,secure:!0,eventSubscribeTimeout:5e3},this.iceParamServer={domain:"ice-params.skyway.ntt.com",version:1,secure:!0},this.signalingService={domain:"signaling.skyway.ntt.com",secure:!0},this.analyticsService={domain:"analytics-logging.skyway.ntt.com",secure:!0},this.rtcConfig={timeout:3e4,turnPolicy:"enable",turnProtocol:"all",encodedInsertableStreams:!1,iceDisconnectBufferTimeout:5e3},this.token={updateReminderSec:30},this.log={level:"error",format:"string"},this.internal={disableDPlane:!1},this.member={keepaliveIntervalGapSec:30,keepaliveIntervalSec:30},Object.assign(this,(0,p1.default)(this,t))}};ne();ne();var Ah=class{constructor(){this._onContextAttached=new gt}_attachContext(t){this._context=t,this._onContextAttached.emit(t)}};ne();var m1=new ft("packages/core/src/plugin/internal/person/connection/messageBuffer.ts"),g1=class{constructor(t){this.signaling=t,this._indicateMessageBuffer={},this._excludeConnectionIndicateBuffering=new Set,this._disposer=new Yn,this.signaling.onMessage.add(e=>{const i=e.src.id+e.src.name;this._excludeConnectionIndicateBuffering.has(i)||(this._indicateMessageBuffer[i]||(this._indicateMessageBuffer[i]=[]),this._indicateMessageBuffer[i].push(e))}).disposer(this._disposer)}resolveMessagingBuffer({id:t,name:e}){const i=t+e,n=this._indicateMessageBuffer[i];(n==null?void 0:n.length)>0&&(m1.debug("resolveMessagingBuffer",{length:n.length}),n.forEach(r=>{this.signaling.onMessage.emit(r)}),delete this._indicateMessageBuffer[i]),this._excludeConnectionIndicateBuffering.add(i)}close(){this._disposer.dispose(),this._indicateMessageBuffer={},this._excludeConnectionIndicateBuffering=new Set}};ne();ne();ne();var mo=Hn(ln());ne();ne();ne();ne();var Zg=class{constructor(t,e){this.id=t,this.contentType=e,this.side="remote",this.onConnectionStateChanged=new gt,this._onConnectionStateChanged=new gt,this._connectionState="new",this._getTransport=()=>{},this.getStats=()=>this._getStats(),this._getStats=()=>j(null,null,function*(){return[]}),this._onConnectionStateChanged.pipe(this.onConnectionStateChanged)}_setConnectionState(t){this._connectionState!==t&&(this._connectionState=t,this._onConnectionStateChanged.emit(t))}getRTCPeerConnection(){return this._getRTCPeerConnection()}_getRTCPeerConnection(){var t;return(t=this._getTransport())==null?void 0:t.rtcPeerConnection}getConnectionState(){return this._getConnectionState()}_getConnectionState(){return this._connectionState}toJSON(){return{contentType:this.contentType,id:this.id,codec:this.codec,side:this.side}}},Yg=class extends Zg{constructor(t,e,i){super(t,e),this.id=t,this.contentType=e,this.track=i}get isEnabled(){return this.track.enabled}setIsEnabled(t){this.track.enabled=t}attach(t){this._element=t,wg(t,this.track)}detach(){this._element&&(xg(this._element,this.track),this._element=void 0)}},v1=class extends Yg{constructor(t,e){super(t,"audio",e),this.track=e,this.contentType="audio"}};ne();var _1=class extends Zg{constructor(t,e){super(t,"data"),this._datachannel=e,this._isEnabled=!0,this.contentType="data",this.onData=new gt,e.onmessage=({data:i})=>{this.isEnabled&&(typeof i=="string"&&i.includes(xu)&&(i=JSON.parse(i.slice(xu.length))),this.onData.emit(i))}}get isEnabled(){return this._isEnabled}setIsEnabled(t){this._isEnabled=t}};ne();var b1=class extends Yg{constructor(t,e){super(t,"video",e),this.track=e,this.contentType="video"}},y1=new ft("packages/core/src/media/stream/remote/factory.ts"),Cu=(t,e,i)=>{if(e instanceof RTCDataChannel){const n=new _1(t,e);return n.codec=i,n}else if(e.kind==="audio"){const n=new v1(t,e);return n.codec=i,n}else if(e.kind==="video"){const n=new b1(t,e);return n.codec=i,n}throw je({operationName:"createRemoteStream",path:y1.prefix,info:we(ae({},Je.invalidArgumentValue),{detail:"invalid stream type"})})};ne();var S1=new ft("packages/core/src/plugin/internal/person/util.ts"),Ro=(t,e)=>j(null,null,function*(){const i=S1.createBlock({label:"setEncodingParams"}),n=t.getParameters();i.debug("getParameters",{params:n,newEncodings:e}),n.encodings==null&&(n.encodings=[]),n.encodings=e.map((r,s)=>ae(ae({},n.encodings[s]||{}),r)),yield t.setParameters(n)}),Jg=()=>Rp()==="Safari12"||Rp()==="Safari11";function w1(t){switch(t){case"closed":case"disconnected":case"failed":return"disconnected";case"connected":return"connected";case"connecting":return"connecting";case"new":return"new";case"reconnecting":return"reconnecting"}}var x1=t=>{const e=[];return t.forEach(i=>{e.push(JSON.parse(JSON.stringify(i)))}),e};ne();var Qg=class ev{constructor(e,i){this.publicationId=e,this.streamId=i}static fromLabel(e){const{p:i,s:n}=JSON.parse(e);return new ev(i,n)}toLabel(){return JSON.stringify({p:this.publicationId,s:this.streamId})}};ne();var pr=new ft("packages/core/src/plugin/internal/person/connection/peer.ts"),tv=class{constructor(t,e,i,n,r,s,o){this._context=t,this._iceManager=e,this.signaling=i,this.analytics=n,this.localPerson=r,this.endpoint=s,this.role=o,this._pendingCandidates=[],this.pc=new RTCPeerConnection(we(ae({},this._context.config.rtcConfig),{iceTransportPolicy:this._context.config.rtcConfig.turnPolicy==="turnOnly"?"relay":void 0,iceServers:this._iceManager.iceServers})),this.onSignalingStateChanged=new gt,this.onPeerConnectionStateChanged=new gt,this.onDisconnect=new gt,this.connected=!1,this.disconnected=!1,this.rtcPeerConnectionId=io(),this._onICECandidate=d=>j(this,null,function*(){if(d.candidate==null||d.candidate===""||this.pc.connectionState==="closed")return;const p={kind:"iceCandidateMessage",payload:{candidate:d.candidate,role:this.role}};pr.debug("[start] send candidate",{message:p,localPerson:this.localPerson}),this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"iceCandidate",data:{candidate:JSON.stringify(d.candidate)},createdAt:Date.now()});try{yield this.signaling.send(this.endpoint,p),pr.debug("[end] send candidate",{message:p,localPerson:this.localPerson})}catch(v){pr.warn("[failed] send candidate",qi({operationName:"Peer._onICECandidate",channel:this.localPerson.channel,detail:"[failed] send candidate",payload:{message:p}}),v)}}),this._onICECandidateError=d=>j(this,null,function*(){this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"iceCandidateError",data:{event:JSON.stringify(d)},createdAt:Date.now()})}),this._onIceGatheringStateChange=d=>j(this,null,function*(){if(this.localPerson._analytics&&!this.localPerson._analytics.isClosed()){const p=this.pc.iceGatheringState;this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"iceGatheringStateChange",data:{event:p},createdAt:Date.now()})}}),this._onConnectionStateChange=()=>j(this,null,function*(){const d=this.pc.connectionState;switch(this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"connectionStateChange",data:{connectionState:d},createdAt:Date.now()}),d){case"connected":this.connected=!0,this._pendingCandidates=[];break}this.onPeerConnectionStateChanged.emit(this.pc.connectionState)}),this._onIceConnectionStateChange=()=>j(this,null,function*(){if(this.localPerson._analytics&&!this.localPerson._analytics.isClosed()){const d=this.pc.iceConnectionState;this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"iceConnectionStateChange",data:{iceConnectionState:d},createdAt:Date.now()})}}),this._onSignalingStateChange=()=>j(this,null,function*(){if(this.localPerson._analytics&&!this.localPerson._analytics.isClosed()){const d=this.pc.signalingState;this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"signalingStateChange",data:{signalingState:d},createdAt:Date.now()})}}),this.waitForSignalingState=(d,p=1e4)=>j(this,null,function*(){this.pc.signalingState!==d&&(yield this.onSignalingStateChanged.watch(()=>this.pc.signalingState===d,p).catch(v=>{throw je({operationName:"Peer.waitForSignalingState",info:we(ae({},Je.timeout),{detail:"waitForSignalingState timeout"}),path:pr.prefix,context:this._context,channel:this.localPerson.channel,error:v})}))}),this.waitForConnectionState=(d,p=1e4)=>j(this,null,function*(){d!==this.pc.connectionState&&(yield this.onPeerConnectionStateChanged.watch(()=>d===this.pc.connectionState,p).catch(v=>{throw je({operationName:"Peer.waitForConnectionState",info:we(ae({},Je.timeout),{detail:"waitForConnectionState timeout"}),path:pr.prefix,context:this._context,channel:this.localPerson.channel,error:v})}))}),this.waitForStats=d=>j(this,[d],function*({track:p,cb:v,interval:g,timeout:_,logging:S}){g??(g=100),_??(_=1e4);for(let E=0;;E+=g){if(E>=_)throw je({operationName:"Peer.waitForStats",info:we(ae({},Je.timeout),{detail:"waitForStats timeout"}),path:pr.prefix,context:this._context,channel:this.localPerson.channel});const M=yield this.pc.getStats(p),R=x1(M);if(S&&pr.debug("Peer.waitForStats",R),v(R))break;yield new Promise(N=>setTimeout(N,g))}});var c;pr.debug("peerConfig",this.pc.getConfiguration()),this.setPeerConnectionListener();const h=(c=this.pc)==null?void 0:c.peerIdentity;h&&h.catch(d=>{pr.debug("firefox peerIdentity",d)})}setPeerConnectionListener(){this.pc.onicecandidate=this._onICECandidate,this.pc.onicecandidateerror=this._onICECandidateError,this.pc.onicegatheringstatechange=this._onIceGatheringStateChange,this.pc.onconnectionstatechange=this._onConnectionStateChange,this.pc.oniceconnectionstatechange=this._onIceConnectionStateChange,this.pc.onsignalingstatechange=()=>{this._onSignalingStateChange(),this.onSignalingStateChanged.emit(this.pc.signalingState)}}unSetPeerConnectionListener(){this.pc.onicecandidate=null,this.pc.onicecandidateerror=null,this.pc.onicegatheringstatechange=null,this.pc.onconnectionstatechange=null,this.pc.oniceconnectionstatechange=null,this.pc.onsignalingstatechange=null}handleCandidate(t){return j(this,null,function*(){this._pendingCandidates.push(t),this.pc.remoteDescription&&(yield this.resolveCandidates())})}resolveCandidates(){return j(this,null,function*(){const t=[...this._pendingCandidates];this._pendingCandidates=[],pr.debug("addIceCandidates",t),yield Promise.all(t.map(e=>{this.pc.signalingState!=="closed"&&this.pc.addIceCandidate(e).catch(i=>{pr.warn("[failed] add ice candidate",qi({operationName:"Peer.resolveCandidates",channel:this.localPerson.channel,detail:"[failed] send candidate",payload:{endpointId:this.endpoint.id}}),i)})}))})}},ds=new ft("packages/core/src/plugin/internal/person/connection/receiver.ts"),E1=class extends tv{constructor(t,e,i,n,r,s){super(t,e,i,n,r,s,"receiver"),this.id=Vr(),this.onConnectionStateChanged=new gt,this.onStreamAdded=new gt,this.onError=new gt,this._connectionState="new",this._publicationInfo={},this.streams={},this._subscriptions={},this._promiseQueue=new As,this._disposer=new Yn,this._log=ds.createBlock({localPersonId:this.localPerson.id,id:this.id}),this._log.debug("spawned"),this.signaling.onMessage.add(o=>j(this,[o],function*({src:c,data:h}){if(!(c.id===s.id&&c.name===s.name))return;const d=h;switch(d.kind){case"senderProduceMessage":this._promiseQueue.push(()=>this._handleSenderProduce(d.payload)).catch(p=>this._log.error("handle senderProduceMessage failed",p,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}));break;case"senderUnproduceMessage":this._promiseQueue.push(()=>this._handleSenderUnproduce(d.payload)).catch(p=>this._log.error("handle handleSenderUnproduce",p,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}));break;case"senderRestartIceMessage":this._promiseQueue.push(()=>this._handleSenderRestartIce(d.payload)).catch(p=>this._log.error("_handleSenderRestartIce",p,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}));break;case"iceCandidateMessage":{const{role:p,candidate:v}=d.payload;p==="sender"&&(yield this.handleCandidate(v))}break}})).disposer(this._disposer),this.pc.ontrack=o=>j(this,[o],function*({track:c,transceiver:h}){if(!h.mid)throw je({operationName:"Receiver.pc.ontrack",info:we(ae({},Je.missingProperty),{detail:"mid missing"}),path:ds.prefix,context:this._context,channel:this.localPerson.channel});const d=Object.values(this._publicationInfo).find(_=>{var S;return _.mid===((S=h.mid)==null?void 0:S.toString())});if(!d){const _=je({operationName:"Receiver.pc.ontrack",info:we(ae({},Je.notFound),{detail:"publicationInfo not found"}),path:ds.prefix,context:this._context,channel:r.channel,payload:{endpointId:this.endpoint.id,publicationInfo:this._publicationInfo,mid:h.mid}});this.onError.emit(_),this._log.error(_);return}const p=mo.parse(this.pc.remoteDescription.sdp),v=this._getCodecFromSdp(p,h,c.kind),g=Cu(d.streamId,c,v);g.codec=v,this._setupTransportAccessForStream(g),this.streams[d.publicationId]=g,this._log.debug("MediaStreamTrack added",d,c,v),this.onStreamAdded.emit({publicationId:d.publicationId,stream:g})}),this.pc.ondatachannel=o=>j(this,[o],function*({channel:c}){const{publicationId:h,streamId:d}=Qg.fromLabel(c.label),p={mimeType:"datachannel"},v=Cu(d,c,p);this._setupTransportAccessForStream(v),this.streams[h]=v,this._log.debug("DataChannel added",h,c,p),this.onStreamAdded.emit({publicationId:h,stream:v})}),this.onPeerConnectionStateChanged.add(o=>{switch(o){case"connecting":case"connected":this._setConnectionState(o);break;case"failed":case"closed":this._setConnectionState("disconnected");break}}).disposer(this._disposer)}_setConnectionState(t){this._connectionState!==t&&(this._log.debug("onConnectionStateChanged",this.id,this._connectionState,t),this._connectionState=t,this.onConnectionStateChanged.emit(t))}_setupTransportAccessForStream(t){t._getTransport=()=>({rtcPeerConnection:this.pc,connectionState:w1(this.pc.connectionState)}),t._getStats=()=>j(this,null,function*(){if(t.contentType==="data"){const n=yield this.pc.getStats();return za(n)}const e=yield this.pc.getStats(t.track);return za(e)}),this._disposer.push(()=>{t._getTransport=()=>{}}),this.onConnectionStateChanged.add(e=>{t._setConnectionState(e),this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"skywayConnectionStateChange",data:{skywayConnectionState:e},createdAt:Date.now()})}).disposer(this._disposer)}_getCodecFromSdp(t,e,i){var n;const r=t.media.find(v=>{var g,_;return((g=v.mid)==null?void 0:g.toString())===((_=e.mid)==null?void 0:_.toString())});if(!r)throw je({operationName:"Receiver._getCodecFromSdp",info:we(ae({},Je.notFound),{detail:"m-line not exist"}),path:ds.prefix,context:this._context,channel:this.localPerson.channel});const s=(n=r.payloads)==null?void 0:n.toString().split(" ")[0],o=r.rtp.find(v=>v.payload.toString()===s),c=`${i}/${o.codec}`.toLowerCase();let h={};const d=r.fmtp.find(v=>v.payload.toString()===s);return d!=null&&d.config&&(h=_g(d.config)),{mimeType:c,parameters:h}}get hasMedia(){const t=Object.values(this.streams).length;return this._log.debug("hasMedia",{count:t}),t>0}close(){this._log.debug("closed"),this.unSetPeerConnectionListener(),this.pc.close(),this._setConnectionState("disconnected"),this._disposer.dispose()}add(t){this._subscriptions[t.id]=t}remove(t){const e=this._subscriptions[t];if(!e)return;delete this._subscriptions[e.id];const i=e.publication.id;this.streams[i]&&delete this.streams[i]}_validateRemoteOffer(t){const e=mo.parse(t);this._log.debug("_validateRemoteOffer",{sdpObject:e});for(const i of e.media){if(i.direction==="inactive")continue;if(!Object.values(this._publicationInfo).find(r=>{var s;return((s=i.mid)==null?void 0:s.toString())===r.mid})){const r=je({operationName:"Receiver._validateRemoteOffer",info:we(ae({},Je.notFound),{detail:"mismatch between sdp and state"}),path:ds.prefix,context:this._context,channel:this.localPerson.channel,payload:{sdpMedia:e.media,sdpMediaLine:i,info:this._publicationInfo}});throw this.onError.emit(r),r}}}get isWrongSignalingState(){return this.pc.signalingState==="have-local-offer"&&this.pc.remoteDescription||this.pc.signalingState==="have-remote-offer"}_handleSenderProduce(t){return j(this,arguments,function*({sdp:e,publicationId:i,info:n}){if(this.pc.signalingState!=="closed"){if(this.pc.signalingState!=="stable"){if(this.isWrongSignalingState){this._log.warn("_handleSenderProduce wait for be stable",qi({operationName:"Receiver._handleSenderProduce",channel:this.localPerson.channel,detail:"_handleSenderProduce wait for be stable",payload:{signalingState:this.pc.signalingState}})),yield this.waitForSignalingState("stable"),yield this._handleSenderProduce({sdp:e,publicationId:i,info:n});return}throw je({operationName:"Receiver._handleSenderProduce",context:this._context,channel:this.localPerson.channel,info:we(ae({},Je.internal),{detail:"wrong signalingState"}),payload:{signalingState:this.pc.signalingState},path:ds.prefix})}this._log.debug("_handleSenderProduce",{info:n,publicationId:i,publicationInfo:Object.values(this._publicationInfo)}),this._publicationInfo[n.publicationId]=n,this._validateRemoteOffer(e.sdp),yield this.sendAnswer(e),yield this.resolveCandidates()}})}_handleSenderUnproduce(t){return j(this,arguments,function*({sdp:e,publicationId:i}){if(this.pc.signalingState==="closed"){this._log.warn("signalingState closed",qi({channel:this.localPerson.channel,detail:"signalingState closed",operationName:"Receiver._handleSenderUnproduce"}));return}if(this._log.debug("<handleSenderUnproduce> start",{sdp:e,publicationId:i}),this.pc.signalingState!=="stable"){if(this.isWrongSignalingState){this._log.warn("signalingState is not stable",qi({channel:this.localPerson.channel,detail:"signalingState is not stable",operationName:"Receiver._handleSenderUnproduce",payload:{signalingState:this.pc.signalingState}})),yield this.waitForSignalingState("stable"),yield this._handleSenderUnproduce({sdp:e,publicationId:i});return}throw je({operationName:"Receiver._handleSenderProduce",context:this._context,channel:this.localPerson.channel,info:we(ae({},Je.internal),{detail:"wrong signalingState"}),payload:{signalingState:this.pc.signalingState},path:ds.prefix})}delete this._publicationInfo[i],yield this.sendAnswer(e),yield this.resolveCandidates(),this._log.debug("<handleSenderUnproduce> end",{publicationId:i})})}_handleSenderRestartIce(t){return j(this,arguments,function*({sdp:e}){if(this.pc.signalingState!=="closed"){if(this.pc.signalingState!=="stable"){if(this.isWrongSignalingState){this._log.warn("signalingState is not stable",qi({channel:this.localPerson.channel,detail:"signalingState is not stable",operationName:"Receiver._handleSenderRestartIce",payload:{signalingState:this.pc.signalingState}})),yield this.waitForSignalingState("stable"),yield this._handleSenderRestartIce({sdp:e});return}throw je({operationName:"Receiver._handleSenderRestartIce",context:this._context,channel:this.localPerson.channel,info:we(ae({},Je.internal),{detail:"wrong signalingState"}),payload:{signalingState:this.pc.signalingState},path:ds.prefix})}this._setConnectionState("reconnecting"),yield this.sendAnswer(e),yield this.resolveCandidates(),this.pc.connectionState==="connected"&&this._setConnectionState("connected")}})}sendAnswer(t){return j(this,null,function*(){this._log.debug("[receiver] start: sendAnswer"),yield this.pc.setRemoteDescription(t);const e=yield this.pc.createAnswer();this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"answer",data:{answer:JSON.stringify(e)},createdAt:Date.now()});const i=mo.parse(this.pc.remoteDescription.sdp),n=mo.parse(e.sdp);i.media.forEach((o,c)=>{const h=n.media[c];h.fmtp=FS(h.fmtp).map(d=>{const p=o.fmtp.find(v=>v.payload===d.payload);return p||d})});const r=mo.write(n);yield this.pc.setLocalDescription({type:"answer",sdp:r});const s={kind:"receiverAnswerMessage",payload:{sdp:this.pc.localDescription}};yield this.signaling.send(this.endpoint,s).catch(o=>this._log.error("failed to send answer",o,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id})),this._log.debug("[receiver] end: sendAnswer")})}get subscriptions(){return this._subscriptions}};ne();var C1=Hn(bm()),Vp=Hn(ln()),wn=new ft("packages/core/src/plugin/internal/person/connection/sender.ts"),T1=class extends tv{constructor(t,e,i,n,r,s){super(t,e,i,n,r,s,"sender"),this.id=Vr(),this.onConnectionStateChanged=new gt,this.publications={},this.transceivers={},this.datachannels={},this._pendingPublications=[],this._isNegotiating=!1,this.promiseQueue=new As,this._disposer=new Yn,this._ms=new MediaStream,this._backoffIceRestarted=new br({times:8,interval:100,jitter:100}),this._connectionState="new",this._log=wn.createBlock({localPersonId:this.localPerson.id,id:this.id}),this._unsubscribeStreamEnableChange={},this._cleanupStreamCallbacks={},this.restartIce=()=>j(this,null,function*(){if(this._backoffIceRestarted.exceeded){this._log.error(je({operationName:"Sender.restartIce",context:this._context,channel:this.localPerson.channel,info:we(ae({},Je.internal),{detail:"restartIce limit exceeded"}),path:wn.prefix})),this._setConnectionState("disconnected");return}this._log.warn("[start] restartIce",qi({operationName:"Sender.restartIce",detail:"start restartIce",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}}));const o=()=>{if(this.endpoint.state==="left")return this._log.warn("endpointMemberLeft",qi({operationName:"restartIce",detail:"endpointMemberLeft",channel:this.localPerson.channel,payload:{endpointId:this.endpoint.id}})),this._setConnectionState("disconnected"),!0;if(this.pc.connectionState==="connected")return this._log.warn("[end] restartIce",qi({operationName:"restartIce",detail:"reconnected",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}})),this._backoffIceRestarted.reset(),this._setConnectionState("connected"),this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.id,type:"restartIce",data:void 0,createdAt:Date.now()}),!0};if(this._setConnectionState("reconnecting"),yield this._backoffIceRestarted.wait(),o())return;let c=yield this._iceManager.updateIceParams().catch(p=>p);if(c){this._log.warn("[failed] restartIce",qi({operationName:"restartIce",detail:"update IceParams failed",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}}),c),yield this.restartIce();return}if(this.pc.setConfiguration&&(this.pc.setConfiguration(we(ae({},this.pc.getConfiguration()),{iceServers:this._iceManager.iceServers})),this._log.debug("<restartIce> setConfiguration",{iceServers:this._iceManager.iceServers})),o())return;if(this.signaling.connectionState!=="connected"){if(this._log.warn("<restartIce> reconnect signaling service",qi({operationName:"restartIce",detail:"reconnect signaling service",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}})),c=yield this.signaling.onConnectionStateChanged.watch(p=>p==="connected",1e4).catch(p=>p).then(()=>{}),c instanceof Xn){yield this.restartIce();return}if(o())return}const h=yield this.pc.createOffer({iceRestart:!0});this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"offer",data:{offer:JSON.stringify(h)},createdAt:Date.now()}),yield this.pc.setLocalDescription(h);const d={kind:"senderRestartIceMessage",payload:{sdp:this.pc.localDescription}};if(c=yield this.signaling.send(this.endpoint,d,1e4).catch(p=>p),c){this._log.warn("<restartIce> [failed]",qi({operationName:"restartIce",detail:"timeout send signaling message",channel:this.localPerson.channel,payload:{count:this._backoffIceRestarted.count}}),c),yield this.restartIce();return}c=yield this.waitForConnectionState("connected",this._context.config.rtcConfig.iceDisconnectBufferTimeout).catch(p=>p),!(!c&&o())&&(yield this.restartIce())}),this._log.debug("spawned"),this.signaling.onMessage.add(o=>j(this,[o],function*({src:c,data:h}){if(!(c.id===s.id&&c.name===s.name))return;const d=h;switch(d.kind){case"receiverAnswerMessage":this.promiseQueue.push(()=>this._handleReceiverAnswer(d.payload)).catch(p=>this._log.error("handle receiverAnswerMessage",{localPersonId:this.localPerson.id,endpointId:this.endpoint.id,err:p}));break;case"iceCandidateMessage":{const{role:p,candidate:v}=d.payload;p==="receiver"&&(yield this.handleCandidate(v))}break}})).disposer(this._disposer),this.onPeerConnectionStateChanged.add(o=>j(this,null,function*(){try{switch(wn.debug("onPeerConnectionStateChanged",{state:o}),o){case"disconnected":case"failed":(yield this.waitForConnectionState("connected",t.config.rtcConfig.iceDisconnectBufferTimeout).catch(h=>h))&&this._connectionState!=="reconnecting"&&(yield this.restartIce());break;case"connecting":case"connected":this._setConnectionState(o);break;case"closed":this._setConnectionState("disconnected");break}}catch(c){wn.error("onPeerConnectionStateChanged",c,this.id)}})).disposer(this._disposer)}_setConnectionState(t){this._connectionState!==t&&(this._log.debug("onConnectionStateChanged",this.id,this._connectionState,t),this._connectionState=t,this.onConnectionStateChanged.emit(t))}get hasMedia(){const t=Object.keys(this.publications).length;return this._log.debug("hasMedia",{count:t}),t>0}_getMid(t,e){if(t.contentType==="data"){const i=e.media.find(n=>n.type==="application");if((i==null?void 0:i.mid)==null)throw je({operationName:"Sender._getMid",info:we(ae({},Je.missingProperty),{detail:"datachannel mid undefined"}),path:wn.prefix,context:this._context,channel:this.localPerson.channel});return i.mid.toString()}else{const n=this.transceivers[t.id].mid;if(n==null)throw je({operationName:"Sender._getMid",info:we(ae({},Je.missingProperty),{detail:"media mid undefined"}),path:wn.prefix,context:this._context,channel:this.localPerson.channel});return n.toString()}}_listenStreamEnableChange(t,e){this._unsubscribeStreamEnableChange[e]&&this._unsubscribeStreamEnableChange[e]();const{removeListener:i}=t._onEnableChanged.add(n=>j(this,null,function*(){yield this._replaceTrack(e,n).catch(r=>{wn.warn(qi({member:this.localPerson,detail:"_replaceTrack failed",operationName:"Sender._listenStreamEnableChange",payload:r}))})}));this._unsubscribeStreamEnableChange[e]=i}add(t){return j(this,null,function*(){var e,i;if(this._isNegotiating||this.pc.signalingState!=="stable"){this._pendingPublications.push(t),this._log.debug("<add> isNegotiating",{publication:t,isNegotiating:this._isNegotiating,signalingState:this.pc.signalingState,pendingPublications:this._pendingPublications.length});return}this._isNegotiating=!0,this._log.debug("<add> add publication",{publication:t}),this.publications[t.id]=t;const n=t.stream;if(!n)throw je({operationName:"Sender.add",info:we(ae({},Je.missingProperty),{detail:"<add> stream not found"}),path:wn.prefix,context:this._context,channel:this.localPerson.channel});if(this._cleanupStreamCallbacks[n.id]=this._setupTransportAccessForStream(n),n.contentType==="data"){const h=this.pc.createDataChannel(new Qg(t.id,n.id).toLabel(),n.options);n._onWriteData.add(d=>{h.readyState==="open"&&h.send(d)}).disposer(this._disposer),this.datachannels[t.id]=h}else{t._onReplaceStream.add(d=>j(this,[d],function*({newStream:p,oldStream:v}){p._replacingTrack=!0,this._listenStreamEnableChange(p,t.id),this._cleanupStreamCallbacks[v.id]&&this._cleanupStreamCallbacks[v.id](),this._cleanupStreamCallbacks[p.id]=this._setupTransportAccessForStream(p),yield this._replaceTrack(t.id,p.track),p._replacingTrack=!1,p._onReplacingTrackDone.emit()})).disposer(this._disposer),this._listenStreamEnableChange(n,t.id);const h=this.pc.addTransceiver(n.track,{direction:"sendonly",streams:[this._ms]});t._onEncodingsChanged.add(d=>j(this,null,function*(){yield Ro(h.sender,d).catch(p=>{this._log.error("_onEncodingsChanged failed",p)})})).disposer(this._disposer),this.transceivers[t.id]=h}const r=yield this.pc.createOffer().catch(h=>{throw je({operationName:"Sender.add",info:we(ae({},Je.internal),{detail:"can't create offer"}),path:wn.prefix,context:this._context,channel:this.localPerson.channel,error:h})});this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"offer",data:{offer:JSON.stringify(r)},createdAt:Date.now()}),yield this.pc.setLocalDescription(r);const s=Vp.parse(this.pc.localDescription.sdp);this._log.debug("<add> create offer base",s);const o=this._getMid(t,s);if(t.contentType!=="data"){R1((e=t.codecCapabilities)!=null?e:[],o,s);const h=Vp.write(s);if(yield this.pc.setLocalDescription({type:"offer",sdp:h}),this._log.debug("<add> create offer",this.pc.localDescription),((i=t.encodings)==null?void 0:i.length)>0)if(Jg())this._safariSetupEncoding(t);else{const d=this.transceivers[t.id];yield Ro(d.sender,[t.encodings[0]])}}const c={kind:"senderProduceMessage",payload:{sdp:this.pc.localDescription,publicationId:t.id,info:{publicationId:t.id,streamId:n.id,mid:o}}};this._log.debug("[start] send message",c),yield this.signaling.send(this.endpoint,c).catch(h=>{throw this._log.error("[failed] send message :",h,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}),h}),this._log.debug("[end] send message",c)})}_setupTransportAccessForStream(t){t._getTransportCallbacks[this.endpoint.id]=()=>({rtcPeerConnection:this.pc,connectionState:this._connectionState}),t._getStatsCallbacks[this.endpoint.id]=()=>j(this,null,function*(){if(t.contentType==="data"){const r=yield this.pc.getStats();return za(r)}t._replacingTrack&&(yield t._onReplacingTrackDone.asPromise(200));const i=yield this.pc.getStats(t.track);return za(i)});const e=()=>{delete t._getTransportCallbacks[this.endpoint.id],delete t._getStatsCallbacks[this.endpoint.id]};return this._disposer.push(()=>{e()}),this.onConnectionStateChanged.add(i=>{t._setConnectionState(this.endpoint,i),this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"skywayConnectionStateChange",data:{skywayConnectionState:i},createdAt:Date.now()})}).disposer(this._disposer),e}remove(t){return j(this,null,function*(){const e=this.publications[t];if(!e){this._log.warn("<remove> publication not found",qi({operationName:"Sender.remove",detail:"publication already removed",channel:this.localPerson.channel,payload:{publicationId:t}}));return}if(delete this.publications[t],this._isNegotiating||this.pc.signalingState!=="stable"){this._pendingPublications.push(t),this._log.debug("<remove> isNegotiating",{publicationId:t,_isNegotiating:this._isNegotiating,signalingState:this.pc.signalingState});return}this._isNegotiating=!0,this._log.debug("<remove> [start]",{publicationId:t});const i=e.stream;if(!i)throw je({operationName:"Sender.remove",info:we(ae({},Je.missingProperty),{detail:"<remove> publication not have stream"}),path:wn.prefix,context:this._context,channel:this.localPerson.channel,payload:{publication:e}});i.contentType==="data"?(this.datachannels[t].close(),delete this.datachannels[t]):(this.transceivers[t].stop(),delete this.transceivers[t]);const n=yield this.pc.createOffer().catch(s=>{throw je({operationName:"Sender.remove",info:we(ae({},Je.internal),{detail:"<remove> can't create offer"}),path:wn.prefix,context:this._context,channel:this.localPerson.channel,error:s})});this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.rtcPeerConnectionId,type:"offer",data:{offer:JSON.stringify(n)},createdAt:Date.now()}),yield this.pc.setLocalDescription(n);const r={kind:"senderUnproduceMessage",payload:{sdp:this.pc.localDescription,publicationId:t}};this._log.debug("<remove> send message",{message:r}),yield this.signaling.send(this.endpoint,r).catch(s=>{throw this._log.error("<remove> in remote error :",s,{localPersonId:this.localPerson.id,endpointId:this.endpoint.id}),s}),this._log.debug("<remove> [end]",{publicationId:t})})}_replaceTrack(t,e){return j(this,null,function*(){const i=this.transceivers[t];if(!i){this._log.warn("can't replace track, transceiver not found",qi({operationName:"Sender._replaceTrack",detail:"transceiver already removed",channel:this.localPerson.channel,payload:{publicationId:t}}));return}yield i.sender.replaceTrack(e).catch(n=>{throw je({operationName:"Sender._replaceTrack",context:this._context,info:Je.internal,error:n,path:wn.prefix,channel:this.localPerson.channel})})})}_handleReceiverAnswer(t){return j(this,arguments,function*({sdp:e}){this.pc.signalingState!=="closed"&&(this._log.debug("<handleReceiverAnswer> [start]"),yield this.pc.setRemoteDescription(new RTCSessionDescription(e)).catch(i=>{const n=je({operationName:"Sender._handleReceiverAnswer",context:this._context,info:we(ae({},Je.internal),{detail:"failed to setRemoteDescription"}),path:wn.prefix,payload:{sdp:e},channel:this.localPerson.channel,error:i});throw this._log.error(n),n}),this._log.debug("<handleReceiverAnswer> sRD"),yield this.resolveCandidates(),this._log.debug("<handleReceiverAnswer> resolveCandidates"),yield this.waitForSignalingState("stable"),this._log.debug("<handleReceiverAnswer> waitForSignalingState"),this._isNegotiating=!1,yield this._resolvePendingSender(),this._log.debug("<handleReceiverAnswer> _resolvePendingSender",this._pendingPublications.length),this._log.debug("<handleReceiverAnswer> [end]"))})}_safariSetupEncoding(t){const e=this.transceivers[t.id],i=t.stream;this.waitForStats({track:i.track,cb:n=>{const r=n.find(s=>s.id.includes("RTCOutboundRTP")||s.type.includes("outbound-rtp"));return(r==null?void 0:r.keyFramesEncoded)>0},interval:10,timeout:this._context.config.rtcConfig.timeout}).then(()=>{wn.debug("safari wait for stats resolved, setEncodingParams"),Ro(e.sender,[t.encodings[0]]).catch(n=>{this._log.error("setEncodingParams failed",n)})}).catch(n=>{this._log.error("waitForStats",n)})}_resolvePendingSender(){return j(this,null,function*(){const t=this._pendingPublications.shift();t&&(this._log.debug("resolve pending sender",{publication:t}),typeof t=="string"?yield this.remove(t):yield this.add(t))})}close(){this._log.debug("closed"),this.unSetPeerConnectionListener(),Object.values(this._unsubscribeStreamEnableChange).forEach(t=>t()),this.pc.close(),this._setConnectionState("disconnected"),this._disposer.dispose()}};function R1(t,e,i){var n,r;const s=i.media.find(d=>{var p;return((p=d.mid)==null?void 0:p.toString())===e});if(!s)throw je({operationName:"applyCodecCapabilities",info:we(ae({},Je.notFound),{detail:"media not found"}),path:wn.prefix});t.forEach(d=>{var p;if(d.parameters)for(const[v,g]of Object.entries((p=d.parameters)!=null?p:{})){if(g===!1||!d.parameters[v])return;v==="usedtx"&&g&&(d.parameters[v]=1)}});const o=(d,p,v)=>{var g;const _=p.map(M=>we(ae({},M),{parameters:kS(v,M.payload)})),S=zp(d.mimeType);return S&&(g=_.find(M=>{var R,N;return M.codec.toLowerCase()!==S.toLowerCase()?!1:Object.keys((R=d.parameters)!=null?R:{}).length===0||M1(d.mimeType)==="audio"?!0:(0,C1.default)(M.parameters,(N=d.parameters)!=null?N:{})}))!=null?g:void 0},c=t.map(d=>o(d,s.rtp,s.fmtp)).filter(d=>d!=null),h=[...c,...s.rtp.filter(d=>!c.find(p=>p.payload===d.payload))];for(const d of s.fmtp){const p=d.payload,v=h.find(S=>S.payload===p);if(v){const S=t.find(E=>o(E,[v],s.fmtp));S&&S.parameters&&Object.keys(S.parameters).length>0&&(d.config="",Object.entries(S.parameters).forEach(([E,M])=>{M===!1||d.config.includes(E)||(d.config.length>0?d.config+=`;${E}=${M}`:d.config=`${E}=${M}`)}))}const g=h.find(S=>S.codec.toLowerCase()==="opus"),_=(r=(n=t.find(S=>zp(S.mimeType).toLowerCase()==="opus"))==null?void 0:n.parameters)==null?void 0:r.usedtx;g&&_!==!1&&d.payload===g.payload&&!d.config.includes("usedtx")&&(d.config.length>0?d.config+=";usedtx=1":d.config="usedtx=1")}s.payloads=h.map(d=>d.payload.toString()).join(" ")}var zp=t=>t.split("/")[1],M1=t=>t.split("/")[0],wc=new ft("packages/core/src/plugin/internal/person/connection/index.ts"),P1=class{constructor(t,e,i,n,r,s,o){this._iceManager=t,this._signaling=e,this._analytics=i,this._context=n,this.channelId=r,this.localPerson=s,this.remoteMember=o,this.id=Vr(),this.type="p2p",this.onDisconnect=new gt,this.onClose=new gt,this.closed=!1,this.disconnected=!1,this._log=wc.createBlock({id:this.id,localPersonId:this.localPerson.id}),this._pubsubQueue=new As,this.sendSubscriptionStatsReportTimers=new Map,this._waitingSendSubscriptionStatsReportsFromPublish=new Map,this._waitingSendSubscriptionStatsReportsFromSubscribe=[],this.sender=new T1(this._context,this._iceManager,this._signaling,this._analytics,this.localPerson,this.remoteMember),this.receiver=new E1(this._context,this._iceManager,this._signaling,this._analytics,this.localPerson,this.remoteMember),this.sender.onDisconnect.once(()=>{this.disconnected=!0,this.onDisconnect.emit()}),this.receiver.onDisconnect.once(()=>{this.disconnected=!0,this.onDisconnect.emit()}),this._analytics&&this._analytics.onConnectionStateChanged.add(c=>{if(c==="connected"){if(this._waitingSendSubscriptionStatsReportsFromPublish.size>0){for(const[h,d]of this._waitingSendSubscriptionStatsReportsFromPublish){const p=this.sender.publications[d];p&&this.startSendSubscriptionStatsReportTimer(p,h)}this._waitingSendSubscriptionStatsReportsFromPublish.clear()}if(this._waitingSendSubscriptionStatsReportsFromSubscribe.length>0){for(const h of this._waitingSendSubscriptionStatsReportsFromSubscribe){const d=this.receiver.subscriptions[h];d&&this.startSendSubscriptionStatsReportTimer(d,h)}this._waitingSendSubscriptionStatsReportsFromSubscribe=[]}}})}startPublishing(t,e){return j(this,null,function*(){yield this._pubsubQueue.push(()=>j(this,null,function*(){this._log.debug("startPublishing",{publication:t}),yield this.sender.add(t)})),this._analytics&&!this._analytics.isClosed()&&(this._analytics.client.sendBindingRtcPeerConnectionToSubscription({subscriptionId:e,role:"sender",rtcPeerConnectionId:this.sender.rtcPeerConnectionId}),this._analytics.client.isConnectionEstablished()?this.startSendSubscriptionStatsReportTimer(t,e):this._waitingSendSubscriptionStatsReportsFromPublish.set(e,t.id))})}stopPublishing(t){return j(this,null,function*(){yield this._pubsubQueue.push(()=>j(this,null,function*(){this._log.debug("<stopPublishing> start",{publication:t}),this.sender.remove(t.id).then(()=>{this._log.debug("<stopPublishing> removed",{publication:t})}).catch(i=>{this._log.error("<stopPublishing> remove failed",i,{publication:t})}),this._closeIfNeeded(),this._log.debug("<stopPublishing> end",{publication:t})}));const e=this.sendSubscriptionStatsReportTimers.get(t.id);e&&(clearInterval(e),this.sendSubscriptionStatsReportTimers.delete(t.id))})}startSubscribing(t){return j(this,null,function*(){yield this._pubsubQueue.push(()=>j(this,null,function*(){this._log.debug("startSubscribing",{subscription:t}),this.receiver.add(t);const e=t.publication.id;let i=this.receiver.streams[e];i||(yield this.receiver.onStreamAdded.watch(n=>n.publicationId===e,this._context.config.rtcConfig.timeout).catch(()=>{throw je({operationName:"P2PConnection.startSubscribing",info:we(ae({},Je.timeout),{detail:"onStreamAdded"}),path:wc.prefix,context:this._context,channel:this.localPerson.channel,payload:{subscription:t}})}),i=this.receiver.streams[e]),i.setIsEnabled(t.publication.state==="enabled"),t.codec=i.codec,t._setStream(i),this._analytics&&!this._analytics.isClosed()&&(this._analytics.client.sendBindingRtcPeerConnectionToSubscription({subscriptionId:t.id,role:"receiver",rtcPeerConnectionId:this.receiver.rtcPeerConnectionId}),this._analytics.client.isConnectionEstablished()?this.startSendSubscriptionStatsReportTimer(t,t.id):this._waitingSendSubscriptionStatsReportsFromSubscribe.push(t.id))}))})}stopSubscribing(t){return j(this,null,function*(){yield this._pubsubQueue.push(()=>j(this,null,function*(){this._log.debug("stopSubscribing",{subscription:t}),this.receiver.remove(t.id),this._closeIfNeeded()}));const e=this.sendSubscriptionStatsReportTimers.get(t.id);e&&(clearInterval(e),this.sendSubscriptionStatsReportTimers.delete(t.id))})}_closeIfNeeded(){this.sender.hasMedia||this.receiver.hasMedia||this.close({reason:"no media"})}getStats(t){return j(this,null,function*(){const e=t.stream;if(!e)throw je({operationName:"P2PConnection.getStats",info:we(ae({},Je.invalidArgumentValue),{detail:"Subscription or Publication must has stream"}),path:wc.prefix,context:this._context,channel:this.localPerson.channel});return e.side==="local"?e.contentType==="data"?this.sender.pc.getStats():this.sender.pc.getStats(e.track):e.contentType==="data"?this.receiver.pc.getStats():this.receiver.pc.getStats(e.track)})}close({reason:t}={}){if(!this.closed){this.closed=!0,this._log.debug("closed",{endpointId:this.remoteMember.id,reason:t,sender:this.sender.id,receiver:this.receiver.id,id:this.id}),this.sender.close(),this.receiver.close();for(const e of this.sendSubscriptionStatsReportTimers.values())clearInterval(e);this.sendSubscriptionStatsReportTimers.clear(),this._waitingSendSubscriptionStatsReportsFromPublish.clear(),this._waitingSendSubscriptionStatsReportsFromSubscribe=[],this.onClose.emit()}}startSendSubscriptionStatsReportTimer(t,e){if(this._analytics){const i=t instanceof Kg?"sender":"receiver",n=this._analytics.client.getIntervalSec();this.sendSubscriptionStatsReportTimers.set(t.id,setInterval(()=>j(this,null,function*(){if(!this._analytics)throw je({operationName:"P2PConnection.sendSubscriptionStatsReportTimer",info:we(ae({},Je.missingProperty),{detail:"AnalyticsSession not exist"}),path:wc.prefix,context:this._context,channel:this.localPerson.channel});if(this._analytics.isClosed()){const s=this.sendSubscriptionStatsReportTimers.get(t.id);s&&(clearInterval(s),this.sendSubscriptionStatsReportTimers.delete(t.id));return}const r=yield this.getStats(t);r&&this._analytics.client.sendSubscriptionStatsReport(r,{subscriptionId:e,role:i,contentType:t.contentType,createdAt:Date.now()})}),n*1e3))}}},go=new ft("packages/core/src/plugin/internal/person/member.ts"),el=class extends Vl{constructor(t){super(t),this.args=t,this.type="person",this.subtype="person",this.side="remote",this._connections={},this._context=this.args.channel._context,this._disposer=new Yn,this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.subscribe=e=>new Promise((i,n)=>{let r=!1;this.channel._subscribe(this.id,e).catch(s=>{r=!0,n(s)}),this.onPublicationSubscribed.watch(({subscription:s})=>s.publication.id===e,this._context.config.rtcApi.timeout).then(({subscription:s})=>{i({subscription:s})}).catch(()=>{r||n(je({operationName:"RemotePersonImpl.subscribe",info:we(ae({},Je.timeout),{detail:"onPublicationSubscribed"}),path:go.prefix,context:this._context,channel:this.channel}))})}),this.plugin=t.plugin,this.channel.onPublicationUnsubscribed.add(({subscription:e})=>{e.subscriber.id===this.id&&(this.onPublicationUnsubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit())}).disposer(this._disposer),this.channel.onPublicationSubscribed.add(({subscription:e})=>{e.subscriber.id===this.id&&(this.onPublicationSubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit())}).disposer(this._disposer),this.channel.onStreamPublished.add(({publication:e})=>{e.publisher.id===this.id&&this.onPublicationListChanged.emit()}).disposer(this._disposer),this.channel.onStreamUnpublished.add(({publication:e})=>{e.publisher.id===this.id&&this.onPublicationListChanged.emit()}).disposer(this._disposer),this.onLeft.once(()=>{go.debug("RemotePerson left: ",this.toJSON()),Object.values(this._connections).forEach(e=>{e.close({reason:"remote person left"})}),this._connections={}})}_getConnection(t){return this._connections[t]}_getOrCreateConnection(t){var e;return(e=this._getConnection(t.id))!=null?e:this._createConnection(this.channel,t,this)}_createConnection(t,e,i){if(e.side!=="local")throw je({operationName:"RemotePersonImpl._createConnection",info:we(ae({},Je.invalidArgumentValue),{detail:"wrong localPerson type"}),path:go.prefix,context:this._context,channel:this.channel});if(!e._signaling)throw je({operationName:"RemotePersonImpl._createConnection",info:we(ae({},Je.missingProperty),{detail:"signalingSession not exist"}),path:go.prefix,context:this._context,channel:this.channel});const n=new P1(e.iceManager,e._signaling,e._analytics,this._context,t.id,e,i);return this.plugin._messageBuffers[e.id].resolveMessagingBuffer(i),n.onClose.once(()=>{go.debug("connection closed",this.toJSON(),{connectionId:n.id}),delete this._connections[e.id]}),this._connections[e.id]=n,n}unsubscribe(t){return j(this,null,function*(){yield this.channel._unsubscribe(t)})}_dispose(){this._disposer.dispose()}},A1=class extends Ah{constructor(){super(...arguments),this.subtype="person",this._messageBuffers={},this._whenCreateLocalPerson=t=>j(this,null,function*(){t._signaling&&(this._messageBuffers[t.id]=new g1(t._signaling))}),this._whenDisposeLocalPerson=t=>j(this,null,function*(){const e=this._messageBuffers[t.id];e&&(e.close(),delete this._messageBuffers[t.id])}),this._createRemoteMember=(t,e)=>new el(we(ae({},this._context),{context:this._context,channel:t,metadata:e.metadata,id:e.id,name:e.name,plugin:this}))}},D1=t=>{const e=new A1;return t.registerPlugin(e),e};ne();var I1=class extends Ah{constructor(){super(...arguments),this.subtype="unknown",this._createRemoteMember=(t,e)=>new yg(we(ae({},this._context),{context:this._context,channel:t,metadata:e.metadata,id:e.id,name:e.name,plugin:this,subtype:e.subtype}))}};ne();var F1="1.13.0",Gn=new ft("packages/core/src/context.ts"),iv=class nv{constructor(e,i,n,r){this.config=i,this.authToken=n,this.info=r,this.disposed=!1,this.plugins=[],this._unknownPlugin=new I1,this._reminderSec=this.config.token.updateReminderSec,this._events=new jr,this.onTokenUpdateReminder=this._events.make(),this.onTokenExpired=this._events.make(),this.onFatalError=this._events.make(),this._onTokenUpdated=this._events.make(),this._onDisposed=this._events.make(),this._authTokenString=n.tokenString,this.appId=this.authToken.getAppId(),D1(this),this._api=e,this._api.onFatalError.once(s=>{Gn.error("onFatalError",{appId:this.appId,error:s}),this.onFatalError.emit(je({operationName:"SkyWayContext._api.onFatalError",context:this,info:Je.rtcApiFatalError,error:s,path:Gn.prefix})),this.dispose()})}static Create(e){return j(this,arguments,function*(i,n={}){const r=new f1(n);ft.level=r.log.level,ft.format=r.log.format;const s=Xa.Decode(i),{osName:o,osVersion:c,browserName:h,browserVersion:d}=bg(),p={sdkName:"core",sdkVersion:this.version,osName:o,osVersion:c,browserName:h,browserVersion:d},v={rapi:r.rtcApi.domain,signaling:r.signalingService.domain,ice:r.iceParamServer.domain};Gn.info("core sdk spawned",{operationName:"SkyWayContext.Create",runtime:p,endpoint:v,config:r,token:s});try{const g=s.getAppId(),_=yield d1.Create({appId:g,token:i,log:r.log,rtcApi:r.rtcApi}),S=new nv(_,r,s,{endpoint:v,runtime:p});return yield S._setTokenExpireTimer(),S}catch(g){throw je({operationName:"SkyWayContext.Create",info:Je.connectRtcApiFailed,error:g,path:Gn.prefix})}})}get authTokenString(){return this._authTokenString}_setTokenExpireTimer(){return j(this,null,function*(){const e=yield this._api.getServerUnixtimeInSec(),i=this.authToken.exp-e;if(i<0)throw je({operationName:"SkyWayContext._setTokenExpireTimer",context:this,info:Je.invalidExpireTokenValue,path:Gn.prefix,payload:{exp:this.authToken.exp,now:e}});this.tokenUpdateReminderTimer&&clearTimeout(this.tokenUpdateReminderTimer);const n=i-this._reminderSec;if(n<0)throw je({operationName:"SkyWayContext._setTokenExpireTimer",context:this,info:Je.invalidRemindExpireTokenValue,path:Gn.prefix,payload:{expiresInSec:i,reminderSec:this._reminderSec}});Gn.debug("_setTokenExpireTimer",{expiresInSec:i,tokenExpireReminderTimeSec:n}),this.tokenUpdateReminderTimer=setTimeout(()=>{Gn.debug("tokenUpdateReminder",{appid:this.appId}),this.onTokenUpdateReminder.emit()},n*1e3),this.tokenExpiredTimer&&clearTimeout(this.tokenExpiredTimer),this.tokenExpiredTimer=setTimeout(()=>{Gn.debug("tokenExpired",{appid:this.appId}),this.onTokenExpired.emit()},i*1e3)})}updateAuthToken(e){return j(this,null,function*(){const i=Xa.Decode(e),n=i.getAppId();if(Gn.info({operationName:"SkyWayContext.updateAuthToken"},{oldToken:this.authToken,newToken:i}),n!==this.appId)throw je({operationName:"SkyWayContext.updateAuthToken",context:this,info:Je.invalidTokenAppId,path:Gn.prefix,payload:{invalid:n,expect:this.appId}});this._authTokenString=e,this.authToken=i,this._onTokenUpdated.emit(e),yield this._setTokenExpireTimer(),yield this._api.updateAuthToken(e)})}registerPlugin(e){this.plugins.find(i=>i.subtype===e.subtype)||(e._attachContext(this),this.plugins.push(e))}_createRemoteMember(e,i){const n=e._getMember(i.id);if(n)return n;Gn.debug("createRemoteMember",{memberDto:i}),i.type=i.type.toLowerCase(),i.subtype=i.subtype.toLowerCase();let r=this.plugins.find(o=>o.subtype===i.subtype);return r||(r=this._unknownPlugin),r._createRemoteMember(e,i)}dispose(){this.disposed||(this.disposed=!0,Gn.debug("disposed",{appid:this.appId}),clearTimeout(this.tokenUpdateReminderTimer),this._onDisposed.emit(),this._events.dispose(),this._api.close())}};iv.version=F1;var rv=iv,Kn=new ft("packages/core/src/external/analytics.ts");function N1(t,e,i){return j(this,null,function*(){const{analyticsService:n}=t.config,r=new Jx({token:t.authTokenString,channelId:e.id,channelName:e.name,memberId:i.id,memberName:i.name,sdkVersion:rv.version},{logger:{error:(o,c)=>j(null,null,function*(){Kn.error(`AnalyticsClient error: ${o}`,je({operationName:"AnalyticsClient.logger",context:t,info:we(ae({},Je.internal),{detail:"AnalyticsClient error"}),error:c,path:Kn.prefix,channel:e}))}),debug:(o,...c)=>{Kn.debug("[analytics]:",o,...c)},warn:(o,...c)=>{Kn.warn("[analytics]:",o,...c)}},analyticsLoggingServerDomain:n.domain,secure:n.secure}),s=new L1(r,t);return s.connectWithTimeout().catch(o=>{s.close(),Kn.error(`AnalyticsClient error: ${o.message}`,je({operationName:"AnalyticsClient.logger",context:t,info:we(ae({},Je.internal),{detail:"AnalyticsClient error"}),error:o,path:Kn.prefix,channel:e})),s.onConnectionFailed.emit({})}),s})}var L1=class{constructor(t,e){this.client=t,this.context=e,this.onConnectionFailed=new gt,this.onConnectionStateChanged=new gt,this.onMessage=new gt,this._isClosed=!1,this._listen(),e._onTokenUpdated.add(i=>{this.client.setNewSkyWayAuthToken(i)})}_listen(){this.client.onConnectionFailed.addOneTimeListener(()=>{this.onConnectionFailed.emit({})}),this.client.onConnectionStateChanged.addListener(t=>{t==="closed"&&!this.isClosed()&&this.client.isClosed()&&this.close(),this.onConnectionStateChanged.emit(t)})}get connectionState(){return this.client.connectionState}_connect(){return j(this,null,function*(){Kn.debug("[start] connect analyticsService"),yield this.client.connect().then(()=>{Kn.debug("[end] connect analyticsService")}).catch(t=>{this.close(),Kn.debug("[end] failed connect analyticsService: also unreachable to server"),Kn.error(`AnalyticsClient error: ${t.message}`,je({operationName:"AnalyticsClient.logger",info:we(ae({},Je.internal),{detail:"AnalyticsClient error"}),error:t,path:Kn.prefix})),this.onConnectionFailed.emit({})})})}connectWithTimeout(){return j(this,null,function*(){let t;const e=new Promise((n,r)=>{t=setTimeout(()=>{Kn.debug("[end] failed connect analyticsService: no initial response from the server"),r(new Error("failed connect analyticsService"))},3e4)}),i=new Promise((n,r)=>{this.client.onAnalyticsNotEnabledError.addOneTimeListener(s=>{Kn.warn(`[end] failed connect analyticsService: ${s.reason}`),n()})});return Promise.race([this._connect(),e,i]).finally(()=>{clearTimeout(t)})})}close(){this._isClosed=!0,this.onConnectionFailed.removeAllListeners(),this.onConnectionStateChanged.removeAllListeners(),this.onMessage.removeAllListeners()}isClosed(){return this._isClosed}};ne();var Gp=new ft("packages/core/src/external/ice.ts"),O1=class{constructor(t){this.args=t,this.domain=this.args.domain,this.version=this.args.version,this.secure=this.args.secure,this.memberId=this.args.memberId,this.channelId=this.args.channelId,this.ttl=this.args.ttl,this.context=this.args.context,this._stunServers=[],this._turnServers=[],this._endpoint=`http${this.secure?"s":""}://${this.domain}/v${this.version}`,this.http=new Ch(this._endpoint)}updateIceParams(){return j(this,null,function*(){const t={memberId:this.memberId,channelId:this.channelId,ttl:this.ttl};Gp.debug("[start] fetch iceParams");const e=new br({times:6,interval:500,jitter:100}),{turn:i,stun:n}=yield this.http.post("/ice-params",t,{headers:{authorization:`Bearer ${this.context.authTokenString}`},retry:()=>e.wait()});i&&(this._turnServers=[{credential:i.credential,urls:`turn:${i.domain}:${i.port}?transport=tcp`,username:i.username},{credential:i.credential,urls:`turn:${i.domain}:${i.port}?transport=udp`,username:i.username},{credential:i.credential,urls:`turns:${i.domain}:${i.port}?transport=tcp`,username:i.username}]),this._stunServers=[{urls:`stun:${n.domain}:${n.port}`}],Gp.debug("[end] fetch iceParams",{turn:i,stun:n})})}get iceServers(){let t=[...this._stunServers];const e=this._turnServers.filter(i=>{const n=i.urls;switch(this.context.config.rtcConfig.turnProtocol){case"all":return!0;case"udp":return n.endsWith("udp");case"tcp":return!n.startsWith("turns")&&n.endsWith("tcp");case"tls":return n.startsWith("turns")}});return this.context.config.rtcConfig.turnPolicy!=="disable"&&(t=[...t,...e]),t}};ne();ne();ne();ne();var k1=20480,xc=class{constructor(t,e={}){if(this.event=t,this.payload=e,this.eventId=Vr(),this.data=JSON.stringify({event:this.event,eventId:this.eventId,payload:this.payload}),this.data.length>k1)throw new Error("payload size exceeds the upper limit")}};ne();var U1=["rateLimitExceeded","targetNotFound","payloadLengthExceeded","invalidPayload","unknown","parameterError","permissionError"];function qp(t){return!(!t||typeof t!="object"||!sv(t.src)||!t.data||typeof t.data!="object")}function B1(t){return!(!t||typeof t!="object"||typeof t.eventId!="string"||typeof t.ok!="boolean"||typeof t.reason<"u"&&(typeof t.reason!="string"||!U1.includes(t.reason)))}function sv(t){return!(t===void 0||Array.isArray(t)||typeof t!="object"||typeof t.id!="string"||typeof t.name<"u"&&typeof t.name!="string")}ne();var Wp=Hn(vh());ne();var Zs=class{constructor(){this._listeners=new Map,this._listenerIndex=0,this.emit=t=>{this._listeners.forEach(e=>e(t))},this.removeAllListeners=()=>{this._listeners.clear()},this.addListener=t=>{const e=this._listenerIndex;return this._listeners.set(e,t),this._listenerIndex++,{removeListener:()=>{this._listeners.delete(e)}}},this.addOneTimeListener=t=>{const e=this.addListener(i=>{e.removeListener(),t(i)});return e},this.asPromise=t=>new Promise((e,i)=>{let n=()=>{};const r=t&&setTimeout(()=>{i("Event asPromise timeout"),n()},t);n=this.addOneTimeListener(o=>{r&&clearTimeout(r),e(o)}).removeListener})}};ne();var H1="1.0.4",j1=["open","sendRequestSignalingMessage","sendResponseSignalingMessage","acknowledge"],V1=t=>(ns(2,t)+Math.random())*1e3,z1=class{constructor({channelId:t,channelName:e,memberId:i,memberName:n,sessionEndpoint:r,token:s,logger:o}){this._isOpen=!1,this._isDestroyed=!1,this._reconnectCount=0,this.connectionState="closed",this.onConnectionStateChanged=new Zs,this.onOpened=new Zs,this.onEventReceived=new Zs,this.onConnectionFailed=new Zs,this._sessionEndpoint=r,this._channelId=t,this._channelName=e,this._memberId=i,this._memberName=n,this._token=s,this._logger=o,this._connect()}_setConnectionState(t){this._logger.debug(`connectionState changed : ${t}`),this.connectionState=t,this.onConnectionStateChanged.emit(t)}_connect(){let t;try{const e=`SkyWayAuthToken!${this._token}`,i={channelId:this._channelId,channelName:this._channelName,memberId:this._memberId,memberName:this._memberName,platform:"javascript",version:H1},n=Object.entries(i).filter(([s,o])=>o!==void 0).map(s=>s.join("=")).join("&"),r=`${this._sessionEndpoint}?${n}`;t=new Wp.default(r,e),this._logger.debug(`Connecting to signaling-server: ${this._sessionEndpoint}`),t.onerror=s=>{this._logger.error("WebSocket error occurred",s.error),t.close(4202)}}catch(e){const i=e instanceof Error?e:new Error;this._logger.error("Failed to create WebSocket instance",i),this.reconnect();return}t.onopen=()=>{this._logger.debug("Connected to signaling-server")},t.onclose=e=>{const i="Close event fired: "+JSON.stringify({code:e.code,reason:e.reason,type:e.type});if(4100<=e.code&&e.code<=4199?this._logger.error(i,new Error):this._logger.debug(i),e.code!==1e3&&!(4e3<=e.code&&e.code<=4199)){this.reconnect();return}e.code!==4e3&&(this._logger.debug("Closed the connection to signaling-server"),this.onConnectionFailed.emit(),this.destroy())},t.onmessage=e=>{this._messageHandler(e.data)},this._ws=t}updateAuthToken(t){this._token=t}reconnect(){if(this._ws!==void 0&&this._ws.close(4e3),this._ws=void 0,this._isOpen=!1,this._reconnectCount>=8)this.onConnectionFailed.emit(),this.destroy(),this._logger.error("Failed to reconnect for eight times",new Error);else{this._setConnectionState("reconnecting");const t=V1(this._reconnectCount);this._reconnectTimer=setTimeout(()=>{this._connect(),this._reconnectCount++,this._logger.debug(`Try to reconnect: count = ${this._reconnectCount}`)},t)}}destroy(){this._isDestroyed=!0,this._setConnectionState("closed"),this.onConnectionStateChanged.removeAllListeners(),this.onOpened.removeAllListeners(),this.onEventReceived.removeAllListeners(),this.onConnectionFailed.removeAllListeners(),this._reconnectTimer&&clearTimeout(this._reconnectTimer),this._ws!==void 0&&this._ws.close(1e3)}send(t){return new Promise((e,i)=>{const n=()=>{this.onOpened.addOneTimeListener(()=>{this.send(t).then(()=>{e()}).catch(r=>{i(r)})}),this.onConnectionFailed.addOneTimeListener(()=>{i(new Error("Connection failed"))})};if(this._isDestroyed){i(new Error("The socket is already destroyed"));return}if(this._ws===void 0||!this._isOpen){this._logger.debug("Retry send the client event when connected because WebSocket is undefined or isOpen = false"),n();return}this._logger.debug(`Send the event: ${t.data}`),this._ws.send(t.data,r=>{if(r){if(this._ws===void 0||!this._isOpen||this._ws.readyState!==Wp.default.OPEN){this._logger.debug("Retry send the client event when connected because WebSocket.send failed"),n();return}i(r)}else e()})})}_messageHandler(t){if(typeof t!="string"){this._logger.error("Received invalid message: not string",new Error);return}let e;try{e=JSON.parse(t)}catch(i){const n=i instanceof Error?i:new Error;this._logger.error("Received invalid message: parse error",n);return}if(!G1(e)){this._logger.error(`Received invalid message: ${e}`,new Error);return}e.event==="open"?(this._logger.debug("Received a open event"),this._isOpen=!0,this._setConnectionState("connected"),this._reconnectCount!==0&&(this._reconnectCount=0,this._logger.debug("Succeeded to reconnect")),this.onOpened.emit()):(this._logger.debug(`Received the event: ${e.event}, payload: ${JSON.stringify(e.payload)}`),this.onEventReceived.emit(e))}};function G1(t){return!(!t||typeof t!="object"||typeof t.event!="string"||!j1.includes(t.event)||typeof t.eventId!="string"||t.payload&&typeof t.payload!="object")}var Kp="signaling.skyway.ntt.com",q1="v1",W1=class{constructor({token:t,channelId:e,channelName:i,memberId:n,memberName:r},s){this.onConnectionStateChanged=new Zs,this.onConnectionFailed=new Zs,this.onRequested=new Zs,this._connectivityCheckTimers=new Map,this._responseCallbacks=new Map,this._acknowledgeCallbacks=new Map,this._token=t,this._channelId=e,this._channelName=i,this._memberId=n,this._memberName=r;const o={connectivityCheckIntervalSec:30,signalingServerDomain:Kp,secure:!0,logger:{debug:c=>{console.debug(c)},error:c=>{console.error(c)}}};this._options=Object.assign({},o,s??{}),this._logger=this._options.logger,this._logger.debug(`Created instance with the options: ${this._options}`)}get connectionState(){var t,e;return(e=(t=this._socket)==null?void 0:t.connectionState)!=null?e:"closed"}connect(){return j(this,null,function*(){const t=this._options.secure?"wss":"ws",e=this._options.signalingServerDomain||Kp;this._socket=new z1({sessionEndpoint:`${t}://${e}/${q1}/ws`,channelId:this._channelId,channelName:this._channelName,memberId:this._memberId,memberName:this._memberName,token:this._token,logger:this._logger}),this._socket.onEventReceived.addListener(i=>{try{this._eventReceivedHandler(i)}catch(n){this._logger.error("in _eventReceivedHandler",n)}}),this._socket.onConnectionFailed.addListener(()=>{this.onConnectionFailed.emit()}),this._socket.onConnectionStateChanged.addListener(i=>{this.onConnectionStateChanged.emit(i)}),yield this._socket.onOpened.asPromise(15*1e3),this._startConnectivityCheck()})}disconnect(){var t;this._stopConnectivityCheck(),(t=this._socket)==null||t.destroy(),this._socket=void 0,this._responseCallbacks.clear(),this._acknowledgeCallbacks.clear()}_startConnectivityCheck(){if(this._connectivityCheckInterval){this._logger.debug("connectivity check timer is already set");return}this._connectivityCheckInterval=setInterval(()=>{var t;const e=new xc("checkConnectivity");(t=this._socket)==null||t.send(e).catch(()=>{this._acknowledgeCallbacks.delete(e.eventId)}),this._connectivityCheckTimers.set(e.eventId,setTimeout(()=>{var i;this._acknowledgeCallbacks.delete(e.eventId),(i=this._socket)==null||i.reconnect(),this._logger.debug("connectivity check timer is expired")},5*1e3)),this._setAcknowledgeCallback(e.eventId,i=>{var n;const r=this._connectivityCheckTimers.get(e.eventId);r&&(clearTimeout(r),this._connectivityCheckTimers.delete(e.eventId)),i.ok||((n=this._socket)==null||n.reconnect(),this._logger.debug("connectivity check response from server was not ok"))})},this._options.connectivityCheckIntervalSec*1e3),this._logger.debug("Started connectivity check timer")}_stopConnectivityCheck(){if(!this._connectivityCheckInterval){this._logger.debug("connectivity check timer is not set");return}clearInterval(this._connectivityCheckInterval),this._connectivityCheckInterval=void 0,this._logger.debug("Stopped connectivity check timer");for(const[t,e]of this._connectivityCheckTimers)clearTimeout(e);this._connectivityCheckTimers.clear()}request(t,e,i=10){return K1(t),Xp(e),new Promise((n,r)=>{if(this._socket===void 0){r(new Error("websocket is not connected"));return}const s={dst:t,data:e},o=new xc("sendRequestSignalingMessage",s),c=setTimeout(()=>{this._acknowledgeCallbacks.delete(o.eventId),r(new Error("request timeout"))},i*1e3);this._setResponseCallback(o.eventId,h=>{clearTimeout(c),n(h)}),this._setAcknowledgeCallback(o.eventId,h=>{h.ok||(clearTimeout(c),r(h))}),this._socket.send(o).catch(h=>{this._acknowledgeCallbacks.delete(o.eventId),clearTimeout(c),r(h)})})}_response(t,e,i,n){return new Promise((r,s)=>{if(Xp(i),this._socket===void 0){s(new Error("websocket is not connected"));return}const o={dst:t,requestEventId:e,data:i},c=new xc("sendResponseSignalingMessage",o),h=setTimeout(()=>{this._acknowledgeCallbacks.delete(c.eventId),s(new Error("response timeout"))},n*1e3);this._setAcknowledgeCallback(c.eventId,d=>{clearTimeout(h),d.ok?r():s(d)}),this._socket.send(c).catch(d=>{this._acknowledgeCallbacks.delete(c.eventId),clearTimeout(h),s(d)})})}updateSkyWayAuthToken(t,e=10){return new Promise((i,n)=>{if(this._socket===void 0){n(new Error("websocket is not connected"));return}const r={token:t},s=new xc("updateSkyWayAuthToken",r),o=setTimeout(()=>{this._acknowledgeCallbacks.delete(s.eventId),n(new Error("updateSkyWayAuthToken timeout"))},e*1e3);this._setAcknowledgeCallback(s.eventId,c=>{if(clearTimeout(o),c.ok){if(this._socket===void 0){n(new Error("websocket is not connected"));return}this._socket.updateAuthToken(t),i()}else n(c)}),this._socket.send(s).catch(c=>{this._acknowledgeCallbacks.delete(s.eventId),clearTimeout(o),n(c)})})}_eventReceivedHandler(t){switch(t.event){case"acknowledge":this._acknowledgeHandler(t.payload);break;case"sendRequestSignalingMessage":this._eventMessageRequestHandler(t.payload);break;case"sendResponseSignalingMessage":this._eventMessageResponseHandler(t.payload);break;case"open":break;default:t.event,this._logger.debug(`Unknown event: ${t.event}`)}}_acknowledgeHandler(t){if(!B1(t))throw new Error("Invalid payload");const{eventId:e}=t;if(!this._acknowledgeCallbacks.has(e))throw new Error(`acknowledge event has unknown eventId: ${e}`);const i=this._acknowledgeCallbacks.get(e);i&&(this._acknowledgeCallbacks.delete(e),i(t))}_eventMessageRequestHandler(t){if(!qp(t))throw new Error("Invalid payload");if(!t.requestEventId)throw new Error("Invalid payload");const e=t.src,i=t.requestEventId,n=(r,s=10)=>j(this,null,function*(){yield this._response(e,i,r,s)});this.onRequested.emit({data:t.data,reply:n,requestEventId:t.requestEventId,src:t.src})}_eventMessageResponseHandler(t){if(!qp(t))throw new Error("Invalid payload");if(!t.requestEventId||!this._responseCallbacks.has(t.requestEventId))throw new Error(`received response has unknown eventId: ${t.requestEventId}`);const e=this._responseCallbacks.get(t.requestEventId);e&&(this._responseCallbacks.delete(t.requestEventId),e(t.data))}_setResponseCallback(t,e){this._responseCallbacks.set(t,e)}_setAcknowledgeCallback(t,e){this._acknowledgeCallbacks.set(t,e)}};function Xp(t){if(!t||typeof t!="object")throw new Error("the type of data must be object")}function K1(t){if(!sv(t))throw new Error("the type of target must be {id: string, name: string}");if(!zS(t.id))throw new Error("the type of target.id must be uuid format")}ne();var ir=new ft("packages/core/src/external/signaling.ts");function X1(t,e,i){return j(this,null,function*(){const{signalingService:n}=t.config,r=new W1({token:t.authTokenString,channelId:e.id,channelName:e.name,memberId:i.id,memberName:i.name},{logger:{error:o=>j(null,null,function*(){ir.error("SignalingClient error",je({operationName:"SignalingClient.logger",context:t,info:we(ae({},Je.internal),{detail:"signalingClient error"}),error:o,path:ir.prefix,channel:e}))}),debug:o=>{}},signalingServerDomain:n.domain,secure:n.secure}),s=new $1(r,t);return yield s.connect(),s})}var $1=class{constructor(t,e){this._client=t,this.context=e,this.onConnectionFailed=new gt,this.onConnectionStateChanged=new gt,this.onMessage=new gt,this.closed=!1,this._chunkedMessageBuffer={},this._backoffUpdateSkyWayAuthToken=new br({times:8,interval:100,jitter:100}),this._disposer=new Yn,this._listen(),e._onTokenUpdated.add(i=>j(this,null,function*(){yield this._updateSkyWayAuthToken(i)})).disposer(this._disposer)}updateClient(t){this._client=t,this._listen()}_listen(){this._client.onConnectionFailed.addOneTimeListener(()=>{this.onConnectionFailed.emit({})}),this._client.onConnectionStateChanged.addListener(t=>{ir.debug("signalingClient onConnectionStateChanged",t),this.onConnectionStateChanged.emit(t)}),this._client.onRequested.addListener(t=>j(this,[t],function*({data:e,src:i,reply:n}){var r;const s=e,{chunk:o,length:c,offset:h,id:d,type:p}=s;if(p===xd){if(c===0)this.onMessage.emit({src:i,data:JSON.parse(o)});else if(this._chunkedMessageBuffer[d]=[...(r=this._chunkedMessageBuffer[d])!=null?r:[],s.chunk],c===h){const v=this._chunkedMessageBuffer[d].join("");delete this._chunkedMessageBuffer[d],this.onMessage.emit({src:i,data:JSON.parse(v)})}yield n({}).catch(v=>{this.closed||ir.warn("failed to reply",qi({operationName:"SignalingSession.reply",detail:"SignalingClient failed to reply"}),v)})}}))}_updateSkyWayAuthToken(t){return j(this,null,function*(){if(this._backoffUpdateSkyWayAuthToken.exceeded){ir.error("[failed] updateSkyWayAuthToken");return}yield this._backoffUpdateSkyWayAuthToken.wait(),ir.debug("[start] updateSkyWayAuthToken",{count:this._backoffUpdateSkyWayAuthToken.count});const e=yield this._client.updateSkyWayAuthToken(t).catch(i=>i);if(e){ir.warn("[retry] updateSkyWayAuthToken",qi({operationName:"SignalingSession._updateSkyWayAuthToken",detail:"[retry] updateSkyWayAuthToken"}),e),yield this._updateSkyWayAuthToken(t);return}ir.debug("[end] updateSkyWayAuthToken"),this._backoffUpdateSkyWayAuthToken.reset()})}get connectionState(){return this._client.connectionState}connect(){return j(this,null,function*(){ir.debug("[start] connect signalingService"),yield this._client.connect().catch(t=>{throw je({operationName:"signalingSession.connect",path:ir.prefix,info:we(ae({},Je.internal),{detail:"signalingClient failed to connect Server"}),context:this.context,error:t})}),ir.debug("[end] connect signalingService")})}close(){this.closed=!0,this._disposer.dispose(),this._client.disconnect()}send(t,e,i=1e4){return j(this,null,function*(){var n;try{const r=JSON.stringify(e),s=io();if(r.length>20480){const o=(n=r.match(/.{1,20480}/g))!=null?n:[];let c=0;for(const h of o){const d={type:xd,length:o.length-1,offset:c++,chunk:h,id:s};yield this._client.request(t,d,i/1e3)}}else{const o={type:xd,length:0,offset:0,chunk:r,id:s};yield this._client.request(t,o,i/1e3)}}catch(r){if(this.closed||t.state!=="joined")return;throw je({operationName:"SignalingSession.send",context:this.context,info:we(ae({},Je.internal),{detail:"signalingClient"}),error:r,path:ir.prefix,payload:{target:t,data:e}})}})}},xd="signalingMessage",$p=new ft("packages/core/src/member/person/local/factory.ts");function Z1(t,e,i){return j(this,arguments,function*(n,r,s,{keepaliveIntervalSec:o,keepaliveIntervalGapSec:c,disableSignaling:h,disableAnalytics:d}={}){var p;$p.debug("createLocalPerson",{channel:r,memberDto:s,keepaliveIntervalSec:o,keepaliveIntervalGapSec:c});const{iceParamServer:v}=n.config,g=h===!0?void 0:yield X1(n,r,s),S=Xa.Decode(n.authTokenString).getAnalyticsEnabled(),E=d===!0||!S?void 0:yield N1(n,r,s),M=new O1(we(ae({},v),{memberId:s.id,channelId:r.id,ttl:jx,context:n}));yield M.updateIceParams().catch(N=>{throw je({operationName:"createLocalPerson",context:n,channel:r,info:we(ae({},Je.internal),{detail:"updateIceParams failed"}),path:$p.prefix,error:N})});const R=yield Y1.Create({iceManager:M,channel:r,signaling:g,analytics:E,metadata:s.metadata,name:s.name,id:s.id,keepaliveIntervalSec:o,keepaliveIntervalGapSec:c,context:n});for(const N of n.plugins)yield(p=N._whenCreateLocalPerson)==null?void 0:p.call(N,R),R._onDisposed.once(()=>j(null,null,function*(){var b;yield(b=N._whenDisposeLocalPerson)==null?void 0:b.call(N,R)}));return R})}var Ot=new ft("packages/core/src/member/localPerson/index.ts"),Y1=class av extends Vl{constructor(e){super(e),this.args=e,this.type="person",this.subtype="person",this.side="local",this.keepaliveIntervalSec=this.args.keepaliveIntervalSec,this.keepaliveIntervalGapSec=this.args.keepaliveIntervalGapSec,this.disableSignaling=this.args.disableSignaling,this.disableAnalytics=this.args.disableAnalytics,this.config=this.context.config,this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onFatalError=this._events.make(),this._onStreamSubscribeFailed=this._events.make(),this._onDisposed=this._events.make(),this._disposer=new Yn,this._subscribing={},this._requestQueue=new As,this.iceManager=this.args.iceManager,this._disposed=!1,this._publishingAgent=new Bx(this),this._subscribingAgent=new Hx(this),this._signaling=e.signaling,this._analytics=e.analytics,this._listenChannelEvent(),this._listenBeforeUnload()}static Create(...e){return j(this,null,function*(){const i=new av(...e);return yield i._setupTtlTimer(),i})}_listenChannelEvent(){this.channel.onPublicationSubscribed.add(e=>j(this,[e],function*({subscription:i}){yield this._handleOnPublicationSubscribe(i).catch(n=>Ot.error("_handleOnStreamSubscribe",n))})).disposer(this._disposer),this.channel.onPublicationUnsubscribed.add(e=>j(this,[e],function*({subscription:i}){yield this._handleOnPublicationUnsubscribe(i).catch(n=>Ot.error("_handleOnStreamUnsubscribe",n))})).disposer(this._disposer),this.channel._onDisposed.once(()=>{this.dispose()}),this.onLeft.once(()=>{this.dispose()})}_setupTtlTimer(){return j(this,null,function*(){const{keepaliveIntervalSec:e,keepaliveIntervalGapSec:i}=this;if(e==null||(Ot.debug("_setupTtlTimer",this.toJSON(),{keepaliveIntervalSec:e,keepaliveIntervalGapSec:i}),e===-1))return;const n=()=>j(this,null,function*(){if(this._disposed)return;const r=yield this.context._api.getServerUnixtimeInSec();this.ttlSec=Math.floor(r+e+(i??0));try{yield this.channel._updateMemberTtl(this.id,this.ttlSec),Ot.debug("updateTtl",this.toJSON(),{now:r,ttlSec:this.ttlSec,keepaliveIntervalSec:e??0,keepaliveIntervalGapSec:i??0,diff:this.ttlSec-r})}catch(s){if(this._disposed)return;throw s}});yield n(),this.ttlInterval=setInterval(()=>j(this,null,function*(){yield n().catch(r=>{this._disposed||(this.onFatalError.emit(je({operationName:"localPerson._setupTtlTimer",path:Ot.prefix,info:we(ae({},Je.internal),{detail:"updateMemberTtl failed"}),channel:this.channel,context:this.context,error:r})),this.dispose())})}),e*1e3)})}_listenBeforeUnload(){if(window){const e=()=>j(this,null,function*(){window.removeEventListener("beforeunload",e),this.state==="joined"&&(Ot.debug("leave by beforeunload",this.toJSON()),yield this.leave())});window.addEventListener("beforeunload",e)}}_handleOnPublicationSubscribe(e){return j(this,null,function*(){var i;if(e.subscriber.id===this.id)try{const n=Ot.info("[start] startSubscribing",yield Gt({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e}),r=(i=this._subscribing[e.publication.id])==null?void 0:i.options;r&&(e.preferredEncoding=r.preferredEncodingId),yield this._subscribingAgent.startSubscribing(e),this.onPublicationSubscribed.emit({subscription:e,stream:e.stream}),this.onSubscriptionListChanged.emit(),Ot.elapsed(n,"[end] startSubscribing",yield Gt({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e})}catch(n){throw this._onStreamSubscribeFailed.emit({error:n,subscription:e}),n}if(e.publication.publisher.id===this.id){if(e.subscriber.id===this.id)throw je({operationName:"localPerson._handleOnStreamSubscribe",path:Ot.prefix,info:we(ae({},Je.internal),{detail:"can not subscribe own Publication"}),channel:this.channel,context:this.context});const n=Ot.info("[start] startPublishing",yield Gt({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e});yield this._publishingAgent.startPublishing(e).catch(r=>{throw Ot.error("[failed] startPublishing",r,{subscription:e}),r}),Ot.elapsed(n,"[end] startPublishing",yield Gt({operationName:"onPublicationSubscribed",channel:this.channel}),{subscription:e})}})}_handleOnPublicationUnsubscribe(e){return j(this,null,function*(){if(e.publication.publisher.id===this.id){const i=Ot.info("[start] stopPublishing",yield Gt({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e});yield this._publishingAgent.stopPublishing(e.publication,e.subscriber).catch(n=>{throw Ot.error("[failed] stopPublishing",n,{subscription:e}),n}),Ot.elapsed(i,"[end] stopPublishing",yield Gt({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e})}if(e.subscriber.id===this.id){const i=Ot.info("[start] stopSubscribing",yield Gt({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e});yield this._subscribingAgent.stopSubscribing(e).catch(n=>{throw Ot.error("[failed] stopSubscribing",{subscription:e},n),n}),this.onPublicationUnsubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit(),Ot.elapsed(i,"[end] stopSubscribing",yield Gt({operationName:"onPublicationUnsubscribed",channel:this.channel}),{subscription:e})}})}publish(e){return j(this,arguments,function*(i,n={}){var r,s,o,c;const h=Ot.info("[start] publish",yield Gt({operationName:"localPerson.publish",channel:this.channel}),{options:n});if(this.state!=="joined")throw je({operationName:"localPerson.publish",info:Je.localPersonNotJoinedChannel,path:Ot.prefix,channel:this.channel,context:this.context});if(i.published)throw je({operationName:"localPerson.publish",channel:this.channel,context:this.context,info:Je.alreadyPublishedStream,path:Ot.prefix});i.published=!0,n.codecCapabilities&&(n.codecCapabilities=n.codecCapabilities.filter(g=>g!=null));const d={metadata:n.metadata,publisher:this.id,channel:this.channel.id,contentType:i.contentType,codecCapabilities:(r=n.codecCapabilities)!=null?r:[],isEnabled:n.isEnabled};i.contentType==="video"&&d.codecCapabilities.length===0&&(d.codecCapabilities=[{mimeType:"video/vp8"}]),n.encodings&&n.encodings.length>0&&(d.encodings=Eu(Xg(n.encodings)));const p=yield this._requestQueue.push(()=>this.channel._publish(d).catch(g=>{throw je({operationName:"localPerson.publish",context:this.context,channel:this.channel,info:g.info,path:Ot.prefix,error:g})}));i.contentType==="data"?i.setIsEnabled(p.isEnabled):yield i.setEnabled(p.isEnabled);const v=this.channel._addPublication(p);if(v._setStream(i),(s=d.codecCapabilities)!=null&&s.length&&v.setCodecCapabilities(d.codecCapabilities),(o=d.encodings)!=null&&o.length&&v.setEncodings(d.encodings),yield this._handleOnStreamPublish(v),Ot.elapsed(h,"[end] publish",yield Gt({operationName:"localPerson.publish",channel:this.channel}),{publication:v}),["video","audio"].includes(v.contentType)&&this._analytics&&!this._analytics.isClosed()){this._analytics.client.sendMediaDeviceReport({publicationId:v.id,mediaDeviceName:v.deviceName,mediaDeviceTrigger:"publish",updatedAt:Date.now()});const g=(c=d.encodings)!=null?c:[];this._analytics.client.sendPublicationUpdateEncodingsReport({publicationId:v.id,encodings:g,updatedAt:Date.now()})}return v})}_handleOnStreamPublish(e){return j(this,null,function*(){Ot.info("onStreamPublished",yield Gt({operationName:"onStreamPublished",channel:this.channel})),this.onStreamPublished.emit({publication:e}),this.onPublicationListChanged.emit()})}unpublish(e){return j(this,null,function*(){const i=Ot.info("[start] unpublish",yield Gt({operationName:"localPerson.unpublish",channel:this.channel})),n=typeof e=="string"?e:e.id;if(this.state!=="joined")throw je({operationName:"localPerson.unpublish",info:Je.localPersonNotJoinedChannel,path:Ot.prefix,context:this.context,channel:this.channel});const r=this.channel._getPublication(n);if(!r)throw je({operationName:"localPerson.unpublish",info:Je.publicationNotExist,path:Ot.prefix,context:this.context,channel:this.channel,payload:{publicationId:n}});r.stream&&r.stream._unpublished(),yield this._requestQueue.push(()=>this.channel._unpublish(n)),r.subscriptions.map(s=>s.subscriber).forEach(s=>{Ux(s)&&this._publishingAgent.stopPublishing(r,s).catch(o=>{Ot.error("[failed] stopPublishing",o,{publication:r})})}),yield this._handleOnStreamUnpublished(r),Ot.elapsed(i,"[end] unpublish",yield Gt({operationName:"localPerson.unpublish",channel:this.channel}),{publication:r})})}_handleOnStreamUnpublished(e){return j(this,null,function*(){Ot.info("onStreamUnpublished",yield Gt({operationName:"onStreamUnpublished",channel:this.channel})),this.onStreamUnpublished.emit({publication:e}),this.onPublicationListChanged.emit()})}subscribe(e){return j(this,arguments,function*(i,n={}){const r=Ot.info("[start] subscribe",yield Gt({operationName:"localPerson.subscribe",channel:this.channel}),{target:i}),s=typeof i=="string"?i:i.id;if(this.state!=="joined")throw je({operationName:"localPerson.subscribe",info:Je.localPersonNotJoinedChannel,path:Ot.prefix,context:this.context,channel:this.channel,payload:{target:i}});const o=this.channel._getPublication(s);if(o==null)throw je({operationName:"localPerson.subscribe",info:Je.publicationNotExist,path:Ot.prefix,context:this.context,channel:this.channel,payload:o});this._validatePublicationForSubscribe(o),this._subscribing[o.id]={options:n,processing:!0};const c=this._subscribing[o.id];try{const h=yield this._requestQueue.push(()=>this.channel._subscribe(this.id,s));Ot.elapsed(r,"[elapsed] subscribe / subscriptionDto received",{subscriptionDto:h});const d=this.channel._addSubscription(h);return d.stream||(yield Promise.race([new Promise((p,v)=>{this.onPublicationSubscribed.watch(({subscription:g})=>g.publication.id===s,this.context.config.rtcApi.timeout).then(p).catch(g=>j(this,null,function*(){c.processing&&v(je({operationName:"localPerson.subscribe",info:we(ae({},Je.timeout),{detail:"failed to subscribe publication. maybe publisher already left room"}),path:Ot.prefix,context:this.context,channel:this.channel,payload:{subscription:d,publication:o},error:g}))}))}),new Promise((p,v)=>{this.channel.onMemberLeft.watch(g=>g.member.id===o.publisher.id,this.context.config.rtcApi.timeout+1e3).then(()=>{c.processing&&v(je({operationName:"localPerson.subscribe",info:we(ae({},Je.internal),{detail:"failed to subscribe publication. publisher already left room"}),path:Ot.prefix,context:this.context,channel:this.channel,payload:{subscription:d,publication:o}}))}).catch(p)}),new Promise((p,v)=>{this._onStreamSubscribeFailed.watch(g=>g.subscription.publication.id===o.id,this.context.config.rtcApi.timeout+1e3).then(g=>{var _,S;if(c.processing){const E=(S=(_=g==null?void 0:g.error)==null?void 0:_.info)!=null?S:we(ae({},Je.internal),{detail:"subscribe _onStreamSubscribeFailed"});v(je({operationName:"localPerson.subscribe",info:E,path:Ot.prefix,context:this.context,channel:this.channel,error:g.error,payload:{subscription:d,publication:o}}))}}).catch(p)})])),c.processing=!1,Ot.elapsed(r,"[end] subscribe",yield Gt({operationName:"localPerson.subscribe",channel:this.channel}),{subscription:d,publication:o}),{subscription:d,stream:d.stream}}catch(h){throw c.processing=!1,Ot.warn("[failed] subscribe",h,{publication:o}),h}})}_validatePublicationForSubscribe(e){if(e.publisher.id===this.id)throw je({operationName:"localPerson._validatePublicationForSubscribe",info:Je.publicationNotExist,path:Ot.prefix,context:this.context,channel:this.channel,payload:{publication:e}});if(e.publisher instanceof yg)throw je({operationName:"localPerson._validatePublicationForSubscribe",info:Je.unknownMemberType,path:Ot.prefix,context:this.context,channel:this.channel,payload:{publication:e}});if(this.subscriptions.find(i=>i.publication.id===e.id))throw je({operationName:"localPerson._validatePublicationForSubscribe",info:Je.alreadySubscribedPublication,path:Ot.prefix,context:this.context,channel:this.channel,payload:{publication:e}})}unsubscribe(e){return j(this,null,function*(){const i=Ot.info("[start] unsubscribe",yield Gt({operationName:"localPerson.unsubscribe",channel:this.channel})),n=typeof e=="string"?e:e.id;if(this.state!=="joined")throw je({operationName:"localPerson.unsubscribe",info:Je.localPersonNotJoinedChannel,path:Ot.prefix,context:this.context,channel:this.channel});const r=this.subscriptions.find(s=>s.id===n);if(!r)throw je({operationName:"localPerson.unsubscribe",info:Je.subscriptionNotExist,path:Ot.prefix,context:this.context,channel:this.channel,payload:{subscriptionId:n}});delete this._subscribing[r.publication.id],yield this._requestQueue.push(()=>this.channel._unsubscribe(n)),Ot.elapsed(i,"[end] unsubscribe",yield Gt({operationName:"localPerson.unsubscribe",channel:this.channel}),{subscription:r})})}_getConnections(){return this.channel.members.map(n=>n._getConnection(this.id)).filter(n=>(n==null?void 0:n.closed)===!1)}dispose(){this._disposed||(this._disposed=!0,Ot.debug("disposed",this.toJSON()),clearInterval(this.ttlInterval),this._signaling&&this._signaling.close(),this._analytics&&this._analytics.close(),this._getConnections().forEach(e=>e.close({reason:"localPerson disposed"})),this._onDisposed.emit(),this._events.dispose(),this._disposer.dispose())}};ne();ne();var Nr=new ft("packages/core/src/subscription/index.ts"),J1=class{constructor(t){this._disposer=new Yn,this._state="enabled",this.onCanceled=new gt,this.onStreamAttached=new gt,this.onConnectionStateChanged=new gt,this._onChangeEncoding=new gt,this.cancel=()=>new Promise((e,i)=>{let n=!1;this._channel._unsubscribe(this.id).catch(r=>{n=!0,i(r)}),this.onCanceled.asPromise(this._context.config.rtcApi.timeout).then(()=>e()).catch(r=>{n||i(r)})}),this._channel=t.channel,this._context=this._channel._context,this.id=t.id,this.contentType=t.contentType,this.subscriber=t.subscriber,this.publication=t.publication,Nr.debug("subscription spawned",this.toJSON()),this._handlePublicationEnabled()}get state(){return this._state}_handlePublicationEnabled(){this.publication.onDisabled.add(()=>{this.stream&&(Nr.debug("disabled",this),this.stream.setIsEnabled(!1))}).disposer(this._disposer),this.publication.onEnabled.add(()=>{this.stream&&(Nr.debug("enabled",this),this.stream.setIsEnabled(!0))}).disposer(this._disposer),this.stream&&this.stream.setIsEnabled(this.publication.state==="enabled")}_setStream(t){this._stream=t,this.onStreamAttached.emit(),t._onConnectionStateChanged.add(e=>{Nr.debug("onConnectionStateChanged",this.id,e),this.onConnectionStateChanged.emit(e)})}get stream(){return this._stream}toJSON(){return{id:this.id,contentType:this.contentType,subscriber:this.subscriber,publication:this.publication,channelId:this._channel.id,state:this.state,stream:this.stream}}_canceled(){this._state="canceled",this.onCanceled.emit(),this._disposer.dispose()}changePreferredEncoding(t){if(!this.stream)throw je({operationName:"SubscriptionImpl.changePreferredEncoding",info:Je.streamNotExistInSubscription,path:Nr.prefix,context:this._context,channel:this._channel});if(this.stream.contentType==="data")throw je({operationName:"SubscriptionImpl.changePreferredEncoding",info:Je.dataStreamNotSupportEncoding,path:Nr.prefix,context:this._context,channel:this._channel});if(!this.publication.encodings.map(e=>e.id).includes(t))throw je({operationName:"SubscriptionImpl.changePreferredEncoding",info:Je.correspondingEncodeNotExistForId,path:Nr.prefix,context:this._context,channel:this._channel});this.preferredEncoding=t,this._onChangeEncoding.emit()}getStats(){if(!this.stream)throw je({operationName:"SubscriptionImpl.getStats",info:Je.streamNotExistInSubscription,path:Nr.prefix,context:this._context,channel:this._channel});return this.stream._getStats()}getRTCPeerConnection(){if(!this.stream)throw je({operationName:"SubscriptionImpl.getRTCPeerConnection",info:Je.streamNotExistInSubscription,path:Nr.prefix,context:this._context,channel:this._channel});return this.stream._getRTCPeerConnection()}getConnectionState(){if(!this.stream)throw je({operationName:"SubscriptionImpl.getConnectionState",info:Je.streamNotExistInSubscription,path:Nr.prefix,context:this._context,channel:this._channel});return this.stream._getConnectionState()}};function Q1(t,{subscriberId:e,publicationId:i,id:n}){const r=t._getSubscription(n);if(r)return r;const o=t._getPublication(i).contentType;return new J1({channel:t,id:n,subscriber:t._getMember(e),publication:t._getPublication(i),contentType:o})}var Si=new ft("packages/core/src/channel/index.ts"),Ed=class{constructor(t,e){this._context=t,this._channelImpl=e,this.id=this._channelImpl.id,this.name=this._channelImpl.name,this.appId=this._context.appId,this.disposed=!1,this.config=this._context.config,this._state="opened",this._api=this._context._api,this._members={},this._getMember=i=>this._members[i],this._publications={},this._getPublication=i=>this._publications[i],this._subscriptions={},this._getSubscription=i=>this._subscriptions[i],this._events=new jr,this.onClosed=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberListChanged=this._events.make(),this.onMemberJoined=this._events.make(),this.onMemberLeft=this._events.make(),this.onMemberMetadataUpdated=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationMetadataUpdated=this._events.make(),this.onPublicationEnabled=this._events.make(),this.onPublicationDisabled=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this._onDisposed=this._events.make(),this.leave=i=>j(this,null,function*(){return this._channelImpl.leave(this.id,i.id)}),this.updateMetadata=i=>this._channelImpl.updateChannelMetadata(i),this.close=()=>new Promise((i,n)=>j(this,null,function*(){if(this.state==="closed"){n(je({operationName:"SkyWayChannelImpl.close",path:Si.prefix,info:Je.alreadyChannelClosed,channel:this,context:this._context,payload:this.toJSON()}));return}const r=Si.info("[start] close channel",yield Gt({operationName:"SkyWayChannelImpl.close",channel:this}));try{yield this._channelImpl.close().catch(s=>{throw je({operationName:"SkyWayChannelImpl.close",context:this._context,info:we(ae({},Je.internal),{detail:"_api.deleteChannel failed"}),error:s,path:Si.prefix,channel:this})}),this._state!=="closed"&&(yield this.onClosed.asPromise(this._context.config.rtcApi.timeout).catch(s=>{throw je({operationName:"SkyWayChannelImpl.close",context:this._context,info:we(ae({},Je.timeout),{detail:"channel.onClosed"}),error:s,path:Si.prefix,channel:this})}))}catch(s){Si.error(s.message,s),n(s)}Si.elapsed(r,"[end] close channel",yield Gt({operationName:"SkyWayChannelImpl.close",channel:this})),i()})),this._updateMemberTtl=(i,n)=>this._channelImpl.updateMemberTtl(i,n),this._updateMemberMetadata=(i,n)=>this._channelImpl.updateMemberMetadata(i,n),this._publish=i=>this._channelImpl.publish(i),this._unpublish=i=>j(this,null,function*(){return this._channelImpl.unpublish(i)}),this._subscribe=(i,n)=>{const r=this._getPublication(n),s=this._getMember(i);if(s==null)throw je({operationName:"SkyWayChannelImpl._subscribe",path:Si.prefix,info:we(ae({},Je.internal),{detail:"subscriber not found"}),channel:this,context:this._context,payload:{subscriberId:i,publicationId:n}});return this._channelImpl.subscribe({publication:r.toJSON(),subscriber:s.toJSON()})},this._unsubscribe=i=>j(this,null,function*(){if(!this._getSubscription(i))throw je({operationName:"SkyWayChannelImpl._unsubscribe",path:Si.prefix,info:we(ae({},Je.internal),{detail:"can't unsubscribe not exist subscription"}),channel:this,context:this._context,payload:{subscriptionId:i}});yield this._channelImpl.unsubscribe(i)}),this._updatePublicationMetadata=(i,n)=>this._channelImpl.updatePublicationMetadata(i,n),this._disablePublication=i=>this._channelImpl.disablePublication(i),this._enablePublication=i=>this._channelImpl.enablePublication(i),this._setupPropertiesFromChannel(),this._setupListenChannelEvent(),t._onDisposed.once(()=>{this.dispose()}),Si.debug("channel spawned",this.toJSON())}_addMember(t){const e=this._getMember(t.id);if(e)return e;const i=this._context._createRemoteMember(this,t);return this._members[i.id]=i,i}_removeMember(t){delete this._members[t]}_addPublication(t){const e=this._getPublication(t.id);if(e)return e;const i=kx(this,t);return this._publications[t.id]=i,i}_removePublication(t){delete this._publications[t]}_addSubscription(t){const e=this._getSubscription(t.id);if(e)return e;const i=Q1(this,t);return this._subscriptions[t.id]=i,i}_removeSubscription(t){delete this._subscriptions[t]}get localPerson(){return this._localPerson}get members(){return Object.values(this._members)}get bots(){return this.members.filter(t=>t.type==="bot")}get publications(){return Object.values(this._publications)}get subscriptions(){return Object.values(this._subscriptions)}get metadata(){return this._channelImpl.metadata}get state(){return this._state}toJSON(){return{id:this.id,name:this.name,appId:this.appId,metadata:this.metadata,members:this.members,publications:this.publications,subscriptions:this.subscriptions}}_setupPropertiesFromChannel(){this._channelImpl.members.forEach(t=>{this._addMember(t)}),this._channelImpl.publications.forEach(t=>{this._addPublication(t)}),this._channelImpl.subscriptions.forEach(t=>{this._addSubscription(t)})}_setupListenChannelEvent(){this._channelImpl.onClosed.add(()=>this._handleOnChannelClose()),this._channelImpl.onMetadataUpdated.add(({channel:t})=>this._handleOnChannelMetadataUpdate(t.metadata)),this._channelImpl.onMemberJoined.add(({member:t})=>{this._handleOnMemberJoin(t)}),this._channelImpl.onMemberLeft.add(({member:t})=>{this._handleOnMemberLeft(t)}),this._channelImpl.onMemberListChanged.pipe(this.onMemberListChanged),this._channelImpl.onMemberMetadataUpdated.add(({member:t})=>{this._handleOnMemberMetadataUpdate(t,t.metadata)}),this._channelImpl.onStreamPublished.add(({publication:t})=>{this._handleOnStreamPublish(t)}),this._channelImpl.onStreamUnpublished.add(({publication:t})=>{this._handleOnStreamUnpublish(t)}),this._channelImpl.onPublicationListChanged.pipe(this.onPublicationListChanged),this._channelImpl.onPublicationMetadataUpdated.add(({publication:t})=>{this._handleOnPublicationMetadataUpdate(t,t.metadata)}),this._channelImpl.onPublicationEnabled.add(t=>j(this,[t],function*({publication:e}){return yield this._handleOnPublicationEnabled(e)})),this._channelImpl.onPublicationDisabled.add(t=>j(this,[t],function*({publication:e}){return yield this._handleOnPublicationDisabled(e)})),this._channelImpl.onPublicationSubscribed.add(({subscription:t})=>{this._handleOnStreamSubscribe(t)}),this._channelImpl.onPublicationUnsubscribed.add(({subscription:t})=>{this._handleOnStreamUnsubscribe(t)}),this._channelImpl.onSubscriptionListChanged.pipe(this.onSubscriptionListChanged)}_handleOnChannelClose(){this._state="closed",this.onClosed.emit({}),this.dispose()}_handleOnChannelMetadataUpdate(t){this.onMetadataUpdated.emit({metadata:t})}_handleOnMemberJoin(t){const e=this._addMember(t);this.onMemberJoined.emit({member:e})}_handleOnMemberLeft(t){var e;const i=this._getMember(t.id);this._removeMember(i.id),i._left(),((e=this.localPerson)==null?void 0:e.id)===t.id&&(this.localPerson._left(),this._localPerson=void 0),this.onMemberLeft.emit({member:i})}_handleOnMemberMetadataUpdate(t,e){var i;const n=this._getMember(t.id);n._metadataUpdated(e),((i=this.localPerson)==null?void 0:i.id)===t.id&&this.localPerson._metadataUpdated(e),this.onMemberMetadataUpdated.emit({member:n,metadata:e})}_handleOnStreamPublish(t){const e=this._addPublication(t);this.onStreamPublished.emit({publication:e})}_handleOnStreamUnpublish(t){const e=this._getPublication(t.id);this._removePublication(e.id),e._unpublished(),this.onStreamUnpublished.emit({publication:e})}_handleOnPublicationMetadataUpdate(t,e){const i=this._getPublication(t.id);i._updateMetadata(e),this.onPublicationMetadataUpdated.emit({publication:i,metadata:e})}_handleOnPublicationEnabled(t){return j(this,null,function*(){const e=this._getPublication(t.id);e._enable(),this.onPublicationEnabled.emit({publication:e})})}_handleOnPublicationDisabled(t){return j(this,null,function*(){const e=this._getPublication(t.id);yield e._disable(),this.onPublicationDisabled.emit({publication:e})})}_handleOnStreamSubscribe(t){const e=this._addSubscription(t);this._getPublication(e.publication.id)._subscribed(e),this.onPublicationSubscribed.emit({subscription:e})}_handleOnStreamUnsubscribe(t){const e=this._getSubscription(t.id);this._removeSubscription(e.id),e._canceled(),this._getPublication(e.publication.id)._unsubscribed(e),this.onPublicationUnsubscribed.emit({subscription:e})}join(){return j(this,arguments,function*(t={}){var e,i;const n=Si.info("[start] join",yield Gt({operationName:"SkyWayChannelImpl.join",channel:this}));if(this._localPerson)throw je({operationName:"SkyWayChannelImpl.join",path:Si.prefix,info:Je.alreadyLocalPersonExist,channel:this,context:this._context});if(t.name!=null&&this.members.find(d=>d.name===t.name))throw je({operationName:"SkyWayChannelImpl.join",path:Si.prefix,info:Je.alreadySameNameMemberExist,channel:this,context:this._context,payload:t});(e=t.keepaliveIntervalSec)!=null||(t.keepaliveIntervalSec=this.config.member.keepaliveIntervalSec),(i=t.keepaliveIntervalGapSec)!=null||(t.keepaliveIntervalGapSec=this.config.member.keepaliveIntervalGapSec);const r=we(ae({},t),{type:"person",subtype:"person"});t.keepaliveIntervalSec!==null&&(r.ttlSec=(yield this._context._api.getServerUnixtimeInSec())+t.keepaliveIntervalSec);const s=yield this._channelImpl.joinChannel(r).catch(h=>{throw Si.error("[failed] join",h),h});Si.elapsed(n,"[elapsed] join / channelImpl.joinChannel",{member:s});const o=yield this._createLocalPerson(s,t),c=new Lp(o);return Si.elapsed(n,"[end] join",{person:o}),c})}moveChannel(t){return j(this,null,function*(){if(this._localPerson)throw je({operationName:"SkyWayChannelImpl.moveChannel",path:Si.prefix,info:Je.alreadyLocalPersonExist,channel:this,context:this._context});if(!(t instanceof Lp))throw je({operationName:"SkyWayChannelImpl.moveChannel",path:Si.prefix,info:Je.invalidArgumentValue,channel:this,context:this._context});const e=t.channel;if(this.id===e.id)throw je({operationName:"SkyWayChannelImpl.moveChannel",path:Si.prefix,info:Je.cantMoveSameIdChannel,channel:this,context:this._context});yield e.leave(t);const i={name:t.name,type:t.type,subtype:t.subtype,metadata:t.metadata};t.keepaliveIntervalSec!=null&&(i.ttlSec=(yield this._context._api.getServerUnixtimeInSec())+t.keepaliveIntervalSec);const n=yield this._channelImpl.joinChannel(i),r=yield this._createLocalPerson(n,{keepaliveIntervalSec:t.keepaliveIntervalSec,keepaliveIntervalGapSec:t.keepaliveIntervalGapSec,disableSignaling:t.disableSignaling,disableAnalytics:t.disableAnalytics});t.apply(r)})}_createLocalPerson(t,e){return j(this,null,function*(){const i=yield Z1(this._context,this,t,e);return this._localPerson=i,i})}dispose(){this.disposed||(this.disposed=!0,Si.debug("disposed",this.toJSON()),this._channelImpl.dispose(),this._onDisposed.emit(),this._events.dispose())}},Dh=class{static Create(t){return j(this,arguments,function*(e,i={}){const n=Si.info("[start] createChannel",{operationName:"SkyWayChannel.Create"}),r=yield e._api.createChannel(i).catch(o=>{throw Si.error("[failed] createChannel",o),o}),s=new Ed(e,r);return Si.elapsed(n,"[end] createChannel"),s})}static Find(t,e){return j(this,null,function*(){const i=Si.info("[start] findChannel",{operationName:"SkyWayChannel.Find"}),n=yield t._api.findChannel(e).catch(s=>{throw Si.error("[failed] findChannel",s),s}),r=new Ed(t,n);return Si.elapsed(i,"[end] findChannel"),r})}static FindOrCreate(t,e){return j(this,null,function*(){const i=Si.info("[start] findOrCreateChannel",{operationName:"SkyWayChannel.FindOrCreate"}),n=yield t._api.findOrCreateChannel(e).catch(s=>{throw Si.error("[failed] findOrCreateChannel",s),s}),r=new Ed(t,n);return Si.elapsed(i,"[end] findOrCreateChannel"),r})}constructor(){}};ne();ne();ne();var Cd=new ft("packages/core/src/media/factory.ts"),eE=class{constructor(){if(this.onDeviceChange=new gt,this._devices=[],!(navigator!=null&&navigator.mediaDevices))throw je({operationName:"StreamFactory.constructor",info:Je.mediaDevicesNotFound,path:Cd.prefix});navigator.mediaDevices.addEventListener("devicechange",()=>j(this,null,function*(){const t=yield this._enumerateDevicesArray(),e=[];this._devices.forEach(n=>{t.map(r=>r.id).includes(n.id)||e.push(n)});const i=[];t.map(n=>n.id).forEach(n=>{this._devices.map(r=>r.id).includes(n)||i.push(t.find(r=>r.id===n))}),Cd.debug("device changed",{added:i,removed:e}),e.forEach(n=>{this.onDeviceChange.emit({state:"removed",device:n})}),i.forEach(n=>{this.onDeviceChange.emit({state:"added",device:n})}),this._devices=t}))}_enumerateDevicesArray(){return j(this,null,function*(){return(yield navigator.mediaDevices.enumerateDevices()).map(e=>new tE(e)).filter(e=>e.id.length>0)})}_enumerateDevicesWithAuth(){return j(this,arguments,function*({video:t,audio:e}={audio:!0,video:!0}){let i=[];return(t||e)&&(i=(yield navigator.mediaDevices.getUserMedia({video:t,audio:e})).getTracks()),this._devices=yield this._enumerateDevicesArray(),i.forEach(n=>n.stop()),this._devices})}enumerateDevices(){return j(this,null,function*(){return yield this._enumerateDevicesWithAuth()})}enumerateInputVideoDevices(){return j(this,null,function*(){return(yield this._enumerateDevicesWithAuth({video:!0})).filter(e=>e.kind==="videoinput")})}enumerateInputAudioDevices(){return j(this,null,function*(){return(yield this._enumerateDevicesWithAuth({audio:!0})).filter(e=>e.kind==="audioinput")})}enumerateOutputAudioDevices(){return j(this,null,function*(){return(yield this._enumerateDevicesWithAuth({audio:!0})).filter(e=>e.kind==="audiooutput")})}createCameraVideoStream(){return j(this,arguments,function*(t={}){var e;t.stopTrackWhenDisabled=(e=t.stopTrackWhenDisabled)!=null?e:!0;const[i]=(yield navigator.mediaDevices.getUserMedia({video:t})).getTracks(),n=new bd(i,t);return n._setLabel("camera"),n})}createMicrophoneAudioStream(){return j(this,arguments,function*(t={}){var e;t.stopTrackWhenDisabled=(e=t.stopTrackWhenDisabled)!=null?e:!0;const[i]=(yield navigator.mediaDevices.getUserMedia({audio:t})).getTracks(),n=new _d(i,t);return n._setLabel("microphone"),n})}createDisplayStreams(){return j(this,arguments,function*(t={}){var e,i,n;const r=(e=t.video)!=null?e:{};(i=r.stopTrackWhenDisabled)!=null||(r.stopTrackWhenDisabled=!0);let s=t.audio;s&&(s=typeof s=="boolean"?{}:s,(n=s.stopTrackWhenDisabled)!=null||(s.stopTrackWhenDisabled=!0)),t={audio:s,video:r};const o=yield navigator.mediaDevices.getDisplayMedia(t),[c]=o.getVideoTracks(),[h]=o.getAudioTracks();t.audio&&!h&&Cd.warn(qi({operationName:"StreamFactory.createDisplayStreams",detail:"This client does not support device audio capture"}));const d=new bd(c,we(ae({},r),{isDisplayMedia:!0}));d._setLabel("displayVideo");const p=h?new _d(h,we(ae({},s),{isDisplayMedia:!0})):void 0;return p&&p._setLabel("displayAudio"),{video:d,audio:p}})}createDataStream(){return j(this,arguments,function*(t={}){return new Ph(t)})}createMicrophoneAudioAndCameraStream(){return j(this,arguments,function*({audio:t,video:e}={}){var i,n;const r=yield navigator.mediaDevices.getUserMedia({audio:t??!0,video:e??!0}),[s]=r.getAudioTracks(),[o]=r.getVideoTracks();t=t??{},t.stopTrackWhenDisabled=(i=t.stopTrackWhenDisabled)!=null?i:!0;const c=new _d(s,t);c._setLabel("microphone"),e=e??{},e.stopTrackWhenDisabled=(n=e.stopTrackWhenDisabled)!=null?n:!0;const h=new bd(o,e);return h._setLabel("camera"),{audio:c,video:h}})}createCustomVideoStream(t){return j(this,arguments,function*(e,i={}){var n,r;i.stopTrackWhenDisabled=(n=i.stopTrackWhenDisabled)!=null?n:!0;const s=new Lx(i),o=yield e.createProcessedStream({constraints:(r=i.constraints)!=null?r:{},stopTrackWhenDisabled:i.stopTrackWhenDisabled,onUpdateTrack:c=>s.updateTrack(c)});return yield s.setStream(o),s})}},Zp=new eE,tE=class{constructor(t){this.id=t.deviceId,this.label=t.label,this.kind=t.kind}};ne();ne();ne();ne();ne();ne();ne();ne();ne();ne();var ov={domain:"sfu.skyway.ntt.com",secure:!0,version:4};ne();var _s={invalidParameter:{name:"invalidParameter",detail:"",solution:""},invalidRequestParameter:{name:"invalidRequestParameter",detail:"",solution:""},notFound:{name:"notFound",detail:"",solution:""},maxSubscriberExceededError:{name:"maxSubscribersExceededError",detail:"forwardingmaxSubscribersmaxSubscribersSubscribe",solution:"maxSubscribers"},quotaExceededError:{name:"quotaExceededError",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},insufficientPermissions:{name:"insufficientPermissions",detail:"token",solution:"token"},backendError:{name:"backendError:",detail:"",solution:""},notAllowedConsumeError:{name:"notAllowedConsumeError",detail:"ForwardingConsume",solution:"Forwardingmember"}};ne();function Os({operationName:t,info:e,error:i,path:n,payload:r}){return new Xn({error:i,info:e,payload:{payload:r,operationName:t},path:n})}function vo({appId:t,detail:e,channelId:i,operationName:n,payload:r,memberId:s,botId:o}){return{operationName:n,payload:r,detail:e,appId:t,channelId:i,memberId:s,botId:o}}var yn=new ft("packages/sfu-api-client/src/api.ts"),iE=class{constructor(t,e){this._token=t,this._headers={authorization:`Bearer ${this._token}`},this.options=ae(ae({},ov),e),this.endpoint=`http${this.options.secure?"s":""}://${this.options.domain}/v${this.options.version}`,this.http=new Ch(this.endpoint),ft.level=this.options.log.level,ft.format=this.options.log.format,yn.debug("SfuRestApiClient spawned",{endpoint:this.endpoint})}updateToken(t){this._token=t}_commonErrorHandler(t,e){switch(t==null?void 0:t.status){case 401:return Os({operationName:e,info:_s.invalidRequestParameter,path:yn.prefix,payload:t});case 403:return Os({operationName:e,info:_s.insufficientPermissions,path:yn.prefix,payload:t});case 404:return Os({operationName:e,info:_s.notFound,path:yn.prefix,payload:t});case 429:return Os({operationName:e,info:_s.quotaExceededError,path:yn.prefix,payload:t});default:return Os({operationName:e,info:_s.backendError,path:yn.prefix,payload:t})}}createBot(t){return j(this,arguments,function*({appId:e,channelId:i}){return(yield this.http.post("/bots",{appId:e,channelId:i},{headers:{authorization:`Bearer ${this._token}`}}).catch(r=>{throw this._commonErrorHandler(r,"SfuRestApiClient.createBot")})).id})}deleteBot(t){return j(this,arguments,function*({botId:e}){yield this.http.delete(`/bots/${e}`,{headers:{authorization:`Bearer ${this._token}`}}).catch(i=>{throw this._commonErrorHandler(i,"SfuRestApiClient.deleteBot")})})}startForwarding(t){return j(this,arguments,function*({botId:e,publicationId:i,maxSubscribers:n,contentType:r,publisherId:s}){const o=new br,c={publicationId:i,maxSubscribers:n,contentType:r[0].toUpperCase()+r.slice(1),publisherId:s},h=yield this.http.post(`/bots/${e}/forwardings`,c,{headers:{authorization:`Bearer ${this._token}`},retry:d=>j(this,null,function*(){return[400,403,429].includes(d.status)?!1:yield o.wait()})}).catch(d=>{throw this._commonErrorHandler(d,"SfuRestApiClient.startForwarding")});return o.count>0&&yn.warn("success to retry startForwarding",vo({operationName:"SfuRestApiClient.startForwarding",detail:"success to retry startForwarding",botId:e,memberId:s,payload:{publicationId:i,count:o.count}})),h})}createProducer(t){return j(this,arguments,function*({botId:e,forwardingId:i,transportId:n,producerOptions:r}){const s=new br,o=yield this.http.put(`/bots/${e}/forwardings/${i}/transports/producers`,{transportId:n,producerOptions:r},{headers:{authorization:`Bearer ${this._token}`},retry:()=>j(this,null,function*(){return yield s.wait()})}).catch(c=>{throw this._commonErrorHandler(c,"SfuRestApiClient.createProducer")});return s.count>0&&yn.warn("success to retry createProducer",vo({operationName:"SfuRestApiClient.createProducer",detail:"success to retry createProducer",botId:e,payload:{forwardingId:i,transportId:n,count:s.count}})),o})}createConsumer(t){return j(this,arguments,function*({botId:e,forwardingId:i,rtpCapabilities:n,subscriptionId:r,subscriberId:s,spatialLayer:o,originPublicationId:c}){const h=new br({times:5,interval:100}),d={rtpCapabilities:n,subscriptionId:r,subscriberId:s,spatialLayer:o,originPublicationId:c},p=yield this.http.post(`/bots/${e}/forwardings/${i}/transports/consumers`,d,{retry:v=>j(this,null,function*(){return[400,403,429].includes(v.status)?!1:yield h.wait()}),headers:{authorization:`Bearer ${this._token}`}}).catch(v=>{throw v.status===429?Os({operationName:"SfuRestApiClient.createConsumer",info:_s.maxSubscriberExceededError,path:yn.prefix,payload:v}):v.status===403?Os({operationName:"SfuRestApiClient.createConsumer",info:_s.notAllowedConsumeError,path:yn.prefix,payload:v}):this._commonErrorHandler(v,"SfuRestApiClient.createConsumer")});return h.count>0&&yn.warn("success to retry createConsumer",vo({operationName:"SfuRestApiClient.createConsumer",detail:"success to retry createConsumer",botId:e,payload:{forwardingId:i,count:h.count}})),yn.debug("response of createConsumer",p),p})}connect(t){return j(this,arguments,function*({transportId:e,dtlsParameters:i}){const n=new br,r={transportId:e,dtlsParameters:i},s=yield this.http.put("/transports/connections",r,{headers:{authorization:`Bearer ${this._token}`},retry:()=>j(this,null,function*(){return yield n.wait()})}).catch(o=>{throw this._commonErrorHandler(o,"SfuRestApiClient.connect")});return n.count>0&&yn.warn("success to retry connect",vo({operationName:"SfuRestApiClient.connect",detail:"success to retry connect",payload:{transportId:e,count:n.count}})),s})}changeConsumerLayer(t){return j(this,arguments,function*({transportId:e,consumerId:i,spatialLayer:n,publicationId:r}){return yield this.http.put(`transports/consumers/${i}/layers`,{transportId:e,spatialLayer:n,publicationId:r},{headers:{authorization:`Bearer ${this._token}`}}).catch(o=>{throw this._commonErrorHandler(o,"SfuRestApiClient.changeConsumerLayer")})})}stopForwarding({botId:t,forwardingId:e}){let i=!1;return{promise:this.http.delete(`/bots/${t}/forwardings/${e}`,{headers:{authorization:`Bearer ${this._token}`}}).catch(r=>{throw this._commonErrorHandler(r,"SfuRestApiClient.stopForwarding")}).then(r=>{i=r}),fulfilled:i}}iceRestart(t){return j(this,arguments,function*({transportId:e}){return(yield this.http.put("/transports/connections/ice",{transportId:e},{headers:this._headers}).catch(n=>{throw this._commonErrorHandler(n,"SfuRestApiClient.iceRestart")})).iceParameters})}getRtpCapabilities(t){return j(this,arguments,function*({botId:e,forwardingId:i,originPublicationId:n}){const r=new br,s=yield this.http.get(`/bots/${e}/forwardings/${i}/transports/rtp-capabilities?originPublicationId=${n}`,{headers:{authorization:`Bearer ${this._token}`},retry:()=>j(this,null,function*(){return yield r.wait()})}).catch(o=>{throw this._commonErrorHandler(o,"SfuRestApiClient.getRtpCapabilities")});return r.count>0&&yn.warn("getCapabilities to retry connect",vo({operationName:"SfuRestApiClient.getRtpCapabilities",detail:"getCapabilities to retry connect",botId:e,payload:{forwardingId:i,count:r.count}})),s.rtpCapabilities})}confirmSubscription(t){return j(this,arguments,function*({forwardingId:e,subscriptionId:i,identifierKey:n}){const r={forwardingId:e,subscriptionId:i,identifierKey:n},s=yield this.http.post("/confirm-subscription",r,{headers:{authorization:`Bearer ${this._token}`}}).catch(o=>{throw this._commonErrorHandler(o,"SfuRestApiClient.confirmSubscription")});return yn.debug("response of confirmSubscription",s),s})}},vi=we(ae({},_s),{invalidParameter:{name:"invalidParameter",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},internal:{name:"internal",detail:"",solution:""},sfuBotNotInChannel:{name:"sfuBotNotInChannel",detail:"SfuBotChannel",solution:"SfuBot"},remotePublisherId:{name:"remotePublisherId",detail:"publisherremotePublicationForwarding",solution:"PublicationLocalPublish"},dataStreamNotSupported:{name:"dataStreamNotSupported",detail:"dataStreamSFU",solution:""},streamNotExistInPublication:{name:"streamNotExistInPublication",detail:"PublicationStreamRemoteMemberPublicationStream",solution:"Publication"},invalidPreferredEncoding:{name:"invalidPreferredEncoding",detail:"preferredEncoding",solution:""},invalidEncodings:{name:"invalidEncodings",detail:"",solution:"PublicationForwarding"},receiverNotFound:{name:"receiverNotFound",detail:"SFURemoteMemberSubscription",solution:"SFUsubscriptionLocalPersonSubscribeSubscription"},consumerNotFound:{name:"consumerNotFound",detail:"SFULocalPersonUnsubscribeSubscription",solution:"Subscription"},forwardingNotFound:{name:"forwardingNotFound",detail:"Forwarding",solution:"Forwarding"},netWorkError:{name:"netWorkError",detail:"",solution:""},confirmSubscriptionFailed:{name:"confirmSubscriptionFailed",detail:"Forwardingconsume",solution:""}});ne();function Tu(t,e){let i=0;for(;i<e.length&&e[i].id!==t;i++);return i}function Ws({channel:t,detail:e,operationName:i,payload:n,bot:r}){var s;const o={operationName:i,payload:n,detail:e};return t&&(o.appId=t.appId,o.channelId=t.id,t.localPerson&&(o.memberId=t.localPerson.id)),r&&(o.botId=r.id,o.appId=r.channel.appId,o.channelId=r.channel.id,o.memberId=(s=r.channel.localPerson)==null?void 0:s.id),o}ne();var Qn=new ft("packages/sfu-bot/src/connection/receiver.ts"),nE=class{constructor(t,e,i,n,r,s,o){this.subscription=t,this._api=e,this._transportRepository=i,this._localPerson=n,this._bot=r,this._iceManager=s,this._context=o,this._disposer=new Yn,this.sendSubscriptionStatsReportTimer=null,this._waitingSendSubscriptionStatsReports=[];const c=this._localPerson._analytics;c&&c.onConnectionStateChanged.add(h=>{if(h==="connected"&&this._waitingSendSubscriptionStatsReports.length>0){for(const d of this._waitingSendSubscriptionStatsReports)this.consumer&&this.consumer.id===d&&this.startSendSubscriptionStatsReportTimer();this._waitingSendSubscriptionStatsReports=[]}})}toJSON(){return{transport:this.transport,subscription:this.subscription}}consume(){return j(this,null,function*(){var t,e;let i=this._transportRepository.rtpCapabilities;i||(Qn.debug("[start] getCapabilities"),i=yield this._api.getRtpCapabilities({botId:this._bot.id,forwardingId:this.subscription.publication.id,originPublicationId:this.subscription.publication.origin.id}),Qn.debug("[end] getCapabilities"),yield this._transportRepository.loadDevice(i).catch(_=>{throw je({operationName:"Receiver.consume",context:this._context,channel:this._localPerson.channel,info:we(ae({},vi.internal),{detail:"sfu loadDevice failed"}),path:Qn.prefix,error:_})}));const n=this.subscription.preferredEncoding?Tu(this.subscription.preferredEncoding,(e=(t=this.subscription.publication.origin)==null?void 0:t.encodings)!=null?e:[]):void 0;Qn.debug("[start] createConsumer",{subscription:this.subscription});const{consumerOptions:r,transportOptions:s,transportId:o,producerId:c}=yield this._api.createConsumer({botId:this._bot.id,forwardingId:this.subscription.publication.id,rtpCapabilities:i,subscriptionId:this.subscription.id,subscriberId:this.subscription.subscriber.id,spatialLayer:n,originPublicationId:this.subscription.publication.origin.id});s&&this._transportRepository.createTransport(this._localPerson.id,this._bot,s,"recv",this._iceManager,this._localPerson._analytics),this.transport=this._transportRepository.getTransport(this._localPerson.id,o),this.transport||(Qn.warn("transport is under race condition",{transportId:o}),yield this._transportRepository.onTransportCreated.watch(_=>_===o,this._bot.options.endpointTimeout).catch(_=>{throw je({operationName:"Receiver.consume",context:this._context,channel:this._localPerson.channel,info:we(ae({},vi.timeout),{detail:"receiver sfuTransport not found"}),path:Qn.prefix,error:_,payload:{transportOptions:s,transportId:o,producerId:c,consumerOptions:r,subscription:this.subscription}})}),this.transport=this._transportRepository.getTransport(this._localPerson.id,o)),this._localPerson._analytics&&!this._localPerson._analytics.isClosed()&&this._localPerson._analytics.client.sendBindingRtcPeerConnectionToSubscription({subscriptionId:this.subscription.id,role:"receiver",rtcPeerConnectionId:this.transport.id}),Qn.debug("[end] createConsumer"),Qn.debug("[start] consume",{consumerOptions:r,subscription:this.subscription});const h=yield this.transport.msTransport.consume(we(ae({},r),{producerId:c})).catch(_=>{throw je({operationName:"Receiver.consume",context:this._context,channel:this._localPerson.channel,info:we(ae({},vi.internal),{detail:"consume failed, maybe subscribing unsupported codec"}),path:Qn.prefix,error:_})});this.consumer=h,Qn.debug("[end] consume",{subscription:this.subscription});const[d]=h.rtpParameters.codecs,p=Cu(io(),h.track,d),v={mimeType:d.mimeType,parameters:d.parameters};this._setupTransportAccessForStream(p,h);const g=this._localPerson._analytics;return g&&!g.isClosed()&&(g.client.isConnectionEstablished()?this.startSendSubscriptionStatsReportTimer():this._waitingSendSubscriptionStatsReports.push(h.id)),{stream:p,codec:v}})}_setupTransportAccessForStream(t,e){const i=this.transport,n=this.pc;t._getTransport=()=>({rtcPeerConnection:n,connectionState:i.connectionState,info:this}),t._getStats=()=>j(this,null,function*(){const r=yield e.getStats();let s=za(r);return s=s.map(o=>(o.sfuTransportId=i.id,o)),s}),this._disposer.push(()=>{t._getTransport=()=>{}}),i.onConnectionStateChanged.add(r=>{Qn.debug("transport connection state changed",i.id,r),t._setConnectionState(r)})}unconsume(){if(!this.consumer){Qn.debug("unconsume failed, consumer not exist",{subscription:this.subscription});return}this.consumer.close(),this.consumer=void 0,this.sendSubscriptionStatsReportTimer&&clearInterval(this.sendSubscriptionStatsReportTimer)}close(){this._disposer.dispose()}get pc(){var t;return(t=this.transport)==null?void 0:t.pc}startSendSubscriptionStatsReportTimer(){const t=this._localPerson._analytics;if(t){const e=t.client.getIntervalSec();this.sendSubscriptionStatsReportTimer=setInterval(()=>j(this,null,function*(){if(!t||t.isClosed()){this.sendSubscriptionStatsReportTimer&&clearInterval(this.sendSubscriptionStatsReportTimer);return}if(this.consumer){const i=yield this.consumer.getStats();i&&t.client.sendSubscriptionStatsReport(i,{subscriptionId:this.subscription.id,role:"receiver",contentType:this.subscription.contentType,createdAt:Date.now()})}}),e*1e3)}}};ne();var Yp=Hn(bm());ne();var Ec=new ft("packages/sfu-bot/src/connection/sender.ts"),rE=class{constructor(t){this.props=t,this.state="started",this.configure=this.props.configure,this.originPublication=this.props.originPublication,this.relayingPublication=this.props.relayingPublication,this._identifierKey=this.props.identifierKey,this._api=this.props.api,this._context=this.props.context,this.onStopped=new gt,this.relayingPublication.onSubscribed.add(e=>j(this,null,function*(){yield this.confirmSubscription(e.subscription).catch(i=>i)})),this.relayingPublication.subscriptions.forEach(e=>j(this,null,function*(){yield this.confirmSubscription(e).catch(i=>i)}))}get id(){return this.relayingPublication.id}_stop(){this.state="stopped",this.onStopped.emit()}toJSON(){return{id:this.id,configure:this.configure,originPublication:this.originPublication,relayingPublication:this.relayingPublication}}confirmSubscription(t){return j(this,null,function*(){Ec.debug("[start] Forwarding confirmSubscription");const{message:e}=yield this._api.confirmSubscription({forwardingId:this.id,subscriptionId:t.id,identifierKey:this._identifierKey}).catch(i=>{throw Ec.error("Forwarding confirmSubscription failed:",i),je({operationName:"Forwarding.confirmSubscription",context:this._context,info:vi.confirmSubscriptionFailed,path:Ec.prefix,payload:i})});Ec.debug("[end] Forwarding confirmSubscription",{message:e})})}},Di=new ft("packages/sfu-bot/src/connection/sender.ts"),sE=class{constructor(t,e,i,n,r,s,o,c){this.publication=t,this.channel=e,this._api=i,this._transportRepository=n,this._localPerson=r,this._bot=s,this._iceManager=o,this._context=c,this._disposer=new Yn,this._connectionState="new",this.onConnectionStateChanged=new gt,this.closed=!1,this.sendSubscriptionStatsReportTimer=null,this._waitingSendSubscriptionStatsReports=[];const h=this._localPerson._analytics;h&&h.onConnectionStateChanged.add(d=>{if(d==="connected"&&this._waitingSendSubscriptionStatsReports.length>0){for(const p of this._waitingSendSubscriptionStatsReports)this._producer&&this._producer.id===p&&this.startSendSubscriptionStatsReportTimer();this._waitingSendSubscriptionStatsReports=[]}})}_setConnectionState(t){this._connectionState!==t&&(Di.debug("_setConnectionState",{state:t,forwardingId:this.forwardingId}),this._connectionState=t,this.onConnectionStateChanged.emit(t))}toJSON(){return{forwarding:this.forwarding,broadcasterTransport:this._broadcasterTransport,_connectionState:this._connectionState}}startForwarding(t){return j(this,null,function*(){if(this.publication.contentType==="data")throw je({operationName:"Sender.startForwarding",context:this._context,info:vi.dataStreamNotSupported,path:Di.prefix,channel:this.channel});const e=this.publication.stream;if(!e)throw je({operationName:"Sender.startForwarding",context:this._context,info:vi.streamNotExistInPublication,path:Di.prefix,channel:this.channel});this.onConnectionStateChanged.add(_=>{var S;Di.debug("transport connection state changed",(S=this._broadcasterTransport)==null?void 0:S.id,_),e._setConnectionState(this._bot,_)}).disposer(this._disposer),Di.debug("[start] Sender startForwarding",{botId:this._bot.id,publicationId:this.publication.id,contentType:this.publication.contentType,maxSubscribers:t.maxSubscribers});const{forwardingId:i,broadcasterTransportId:n,broadcasterTransportOptions:r,rtpCapabilities:s,identifierKey:o}=yield this._api.startForwarding({botId:this._bot.id,publicationId:this.publication.id,contentType:this.publication.contentType,maxSubscribers:t.maxSubscribers,publisherId:this.publication.publisher.id});if(this.forwardingId=i,r&&(Di.debug("sender create new transport",{broadcasterTransportOptions:r}),yield this._transportRepository.loadDevice(s),this._broadcasterTransport=this._transportRepository.createTransport(this._localPerson.id,this._bot,r,"send",this._iceManager,this._localPerson._analytics)),this._broadcasterTransport=this._transportRepository.getTransport(this._localPerson.id,n),!this._broadcasterTransport)throw je({operationName:"Sender.startForwarding",context:this._context,info:we(ae({},vi.internal),{detail:"_broadcasterTransport not found"}),path:Di.prefix,channel:this.channel,payload:{broadcasterTransportOptions:r}});this._broadcasterTransport.onConnectionStateChanged.add(_=>{this._setConnectionState(_)}).disposer(this._disposer),this._setConnectionState(this._broadcasterTransport.connectionState);const c=yield this._produce(e,this._broadcasterTransport);this._cleanupStreamCallbacks=this._setupTransportAccessForStream(e,this._broadcasterTransport,c);const h=this._localPerson._analytics;h&&!h.isClosed()&&(h.client.isConnectionEstablished()?this.startSendSubscriptionStatsReportTimer():this._waitingSendSubscriptionStatsReports.push(c.id)),Di.debug("[end] Sender startForwarding",{forwardingId:i});let d=this.channel._getPublication(i);d||(d=(yield this.channel.onStreamPublished.watch(_=>_.publication.id===i,this._context.config.rtcApi.timeout).catch(()=>{throw je({operationName:"Sender.startForwarding",context:this._context,info:we(ae({},vi.timeout),{detail:"SfuBotMember onStreamPublished"}),path:Di.prefix,channel:this.channel,payload:{forwardingId:i}})})).publication);const p=new rE({configure:t,originPublication:this.publication,relayingPublication:d,api:this._api,context:this._context,identifierKey:o});this.forwarding=p;const v=this.channel.subscriptions.find(_=>_.publication.id===this.publication.id),[g]=c.rtpParameters.codecs;return v.codec=g,this._localPerson._analytics&&this._localPerson._analytics.client.connectionState!=="closed"&&this._localPerson._analytics.client.sendBindingRtcPeerConnectionToSubscription({subscriptionId:v.id,role:"sender",rtcPeerConnectionId:this._broadcasterTransport.id}),Jg()&&Tp({stream:e,remoteMember:this._bot.id,end:_=>{const S=_.find(E=>E.id.includes("RTCOutboundRTP")||E.type.includes("outbound-rtp"));return(S==null?void 0:S.keyFramesEncoded)>0},interval:10}).then(()=>j(this,null,function*(){const _=this.publication.encodings;(_==null?void 0:_.length)>0&&(yield Ro(c.rtpSender,_).catch(S=>{Di.error("_onEncodingsChanged failed",S,this)}))})).catch(_=>{Di.error("setEncodingParams waitForLocalStats failed",_,this)}),Tp({stream:e,remoteMember:this._bot.id,end:_=>!!_.find(S=>S.type.includes("local-candidate"))}).then(()=>j(this,null,function*(){const _=yield Gt({operationName:"startForwarding/waitForLocalStats",channel:this.channel});Di.debug(_,"forwarding connection connected",{broadcasterTransportId:n})})).catch(()=>{}),p})}_listenStreamEnableChange(t){this._unsubscribeStreamEnableChange&&this._unsubscribeStreamEnableChange();const{removeListener:e}=t._onEnableChanged.add(i=>j(this,null,function*(){yield this._replaceTrack(i).catch(n=>{Di.warn(Ws({detail:"replaceTrack failed",operationName:"Sender._listenStreamEnableChange",bot:this._bot,payload:n}))})}));this._unsubscribeStreamEnableChange=e}_produce(t,e){return j(this,null,function*(){var i,n,r,s,o,c,h,d;this.publication._onReplaceStream.add(R=>j(this,[R],function*({newStream:N}){if(!this._broadcasterTransport)throw je({operationName:"Sender._produce",context:this._context,info:we(ae({},vi.internal),{detail:"_broadcasterTransport not found"}),path:Di.prefix,channel:this.channel});this._listenStreamEnableChange(N),this._cleanupStreamCallbacks&&this._cleanupStreamCallbacks(),this._cleanupStreamCallbacks=this._setupTransportAccessForStream(N,this._broadcasterTransport,M),yield this._replaceTrack(N.track)})).disposer(this._disposer),this._listenStreamEnableChange(t);const p=io(),v={track:t.track,stopTracks:!1,appData:{transactionId:p},disableTrackOnPause:!1},g=this.publication.encodings;g&&(v.encodings=g),this.publication._onEncodingsChanged.add(R=>j(this,null,function*(){yield Ro(M.rtpSender,R).catch(N=>{Di.error("_onEncodingsChanged failed",N,this)})})).disposer(this._disposer);const _=this.publication.codecCapabilities,S=(n=(i=this._transportRepository.rtpCapabilities)==null?void 0:i.codecs)!=null?n:[];Di.debug("select codec",{codecCapabilities:_,deviceCodecs:S});const[E]=_.map(R=>R.mimeType.toLowerCase().includes("video")?S.find(m=>{var w;return!(m.mimeType.toLowerCase()!==R.mimeType.toLowerCase()||Object.keys((w=R.parameters)!=null?w:{}).length>0&&!(0,Yp.default)(R.parameters,m.parameters))}):S.find(b=>b.mimeType.toLowerCase()===R.mimeType.toLowerCase()));if(Di.debug("selected codec",{codec:E}),E){const[R,N]=E.mimeType.split("/");v.codec=we(ae({},E),{mimeType:`${R}/${N.toUpperCase()}`}),t.contentType==="video"&&this._fixVideoCodecWithParametersOrder(E)}else _.length>0&&Di.warn("preferred codec not supported",Ws({channel:this.channel,detail:"preferred codec not supported",operationName:"Sender._produce",bot:this._bot,payload:{codecCapabilities:_,deviceCodecs:S}}));t.contentType==="audio"&&(((s=(r=_.find(m=>m.mimeType.toLowerCase()==="audio/opus"))==null?void 0:r.parameters)==null?void 0:s.usedtx)!==!1&&(v.codecOptions=we(ae({},v.codecOptions),{opusDtx:!0})),(c=(o=_.find(m=>m.mimeType.toLowerCase()==="audio/opus"))==null?void 0:o.parameters)!=null&&c.stereo&&(v.codecOptions=we(ae({},v.codecOptions),{opusStereo:!0})),(d=(h=_.find(m=>m.mimeType.toLowerCase()==="audio/opus"))==null?void 0:h.parameters)!=null&&d.useinbandfec&&(v.codecOptions=we(ae({},v.codecOptions),{opusFec:!0}))),e.onProduce.watch(R=>{var N;return((N=R.producerOptions.appData)==null?void 0:N.transactionId)===p},this._context.config.rtcConfig.timeout).then(R=>j(this,null,function*(){try{const{producerId:N}=yield this._api.createProducer({botId:this._bot.id,transportId:e.id,forwardingId:this.forwardingId,producerOptions:R.producerOptions});R.callback({id:N})}catch(N){R.errback(N)}})).catch(R=>{Di.error("onProduce failed",R,this)}),Di.debug("[start] msTransport.produce",this);const M=yield e.msTransport.produce(v).catch(R=>{throw je({operationName:"Sender._produce",context:this._context,info:we(ae({},vi.internal),{detail:"msTransport.produce failed"}),path:Di.prefix,channel:this.channel,error:R})});return Di.debug("[end] msTransport.produce",this),this._producer=M,M})}_fixVideoCodecWithParametersOrder(t){const e=this._broadcasterTransport.msTransport._handler,i=r=>r.mimeType===t.mimeType?t.parameters&&Object.keys(t.parameters).length>0?!!(0,Yp.default)(r.parameters,t.parameters):!0:!1,n=(r,s)=>{for(const o of Object.keys(r))o!=="payloadType"&&(r[o]=s[o])};if(e._sendingRtpParametersByKind){const r=e._sendingRtpParametersByKind.video,s=r.codecs.find(i);if(r&&s){const o=JSON.parse(JSON.stringify(r)),[c]=r.codecs,h=JSON.parse(JSON.stringify(c));n(c,s),n(s,h),Di.debug("sort _sendingRtpParametersByKind",{origin:o,new:r.codecs})}}if(e._sendingRemoteRtpParametersByKind){const r=e._sendingRemoteRtpParametersByKind.video,s=r.codecs.find(i);if(r&&s){const o=JSON.parse(JSON.stringify(r)),[c]=r.codecs,h=JSON.parse(JSON.stringify(c));n(c,s),n(s,h),Di.debug("sort _sendingRemoteRtpParametersByKind",{origin:o,new:r.codecs})}}}_setupTransportAccessForStream(t,e,i){t._getTransportCallbacks[this._bot.id]=()=>({rtcPeerConnection:e.pc,connectionState:e.connectionState,info:this}),t._getStatsCallbacks[this._bot.id]=()=>j(this,null,function*(){if(i.closed)return delete t._getStatsCallbacks[this._bot.id],[];const r=yield i.getStats();let s=za(r);return s=s.map(o=>(o.sfuTransportId=e.id,o)),s});const n=()=>{delete t._getTransportCallbacks[this._bot.id],delete t._getStatsCallbacks[this._bot.id]};return this._disposer.push(()=>{n()}),n}unproduce(){this._producer&&(this._producer.close(),this._producer=void 0,this.sendSubscriptionStatsReportTimer&&clearInterval(this.sendSubscriptionStatsReportTimer))}_replaceTrack(t){return j(this,null,function*(){var e,i;yield(i=(e=this._producer)==null?void 0:e.replaceTrack)==null?void 0:i.call(e,{track:t}).catch(n=>{throw je({operationName:"Sender._replaceTrack",context:this._context,info:vi.internal,error:n,path:Di.prefix,channel:this.channel})})})}close(){this.closed=!0,this._unsubscribeStreamEnableChange&&this._unsubscribeStreamEnableChange(),this._setConnectionState("disconnected"),this._disposer.dispose()}get pc(){var t;return(t=this._broadcasterTransport)==null?void 0:t.pc}startSendSubscriptionStatsReportTimer(){const t=this._localPerson._analytics,e=this._bot.subscriptions.find(i=>i.publication.id===this.publication.id);if(e&&t){const i=t.client.getIntervalSec();this.sendSubscriptionStatsReportTimer=setInterval(()=>j(this,null,function*(){if(!t||t.isClosed()){this.sendSubscriptionStatsReportTimer&&clearInterval(this.sendSubscriptionStatsReportTimer);return}if(this._producer){const n=yield this._producer.getStats();n&&t.client.sendSubscriptionStatsReport(n,{subscriptionId:e.id,role:"sender",contentType:this.publication.contentType,createdAt:Date.now()})}}),i*1e3)}}},er=new ft("packages/sfu-bot/src/connection/index.ts"),aE=class{constructor(t,e,i,n,r,s){this._api=t,this.channel=e,this.localPerson=i,this.remoteMember=n,this._transportRepository=r,this._context=s,this.type="sfu",this.onDisconnect=new gt,this.onClose=new gt,this.closed=!1,this._receivers={},this._senders={}}addSender(t){const e=new sE(t,this.channel,this._api,this._transportRepository,this.localPerson,this.remoteMember,this.localPerson.iceManager,this._context);return this._senders[t.id]=e,e}removeSender(t){er.debug("removeSender",t);const e=this._senders[t];e&&e.unproduce()}startSubscribing(t){return j(this,null,function*(){var e;const i=new nE(t,this._api,this._transportRepository,this.localPerson,this.remoteMember,this.localPerson.iceManager,this._context);this._receivers[t.id]=i;const n=er.debug("[start] _startSubscribing consume"),{stream:r,codec:s}=yield i.consume().catch(o=>{throw er.error("[failed] _startSubscribing consume",je({operationName:"SFUConnection.startSubscribing",context:this._context,channel:this.channel,info:we(ae({},vi.internal),{detail:"failed to receiver.consume"}),error:o,path:er.prefix,payload:{subscription:t.toJSON()}})),o});if(er.elapsed(n,"[end] _startSubscribing consume"),r.setIsEnabled(t.publication.state==="enabled"),t.codec=s,t._setStream(r),this.localPerson._analytics&&!this.localPerson._analytics.isClosed()){const o=t.preferredEncoding,c=(e=t.publication.origin)==null?void 0:e.encodings;if(!o||!c||c.length===0)return;const h=Tu(o,c);this.localPerson._analytics.client.sendSubscriptionUpdatePreferredEncodingReport({subscriptionId:t.id,preferredEncodingIndex:h,updatedAt:Date.now()})}})}stopSubscribing(t){return j(this,null,function*(){const e=this._receivers[t.id];e&&e.unconsume()})}stopPublishing(t){return j(this,null,function*(){this.removeSender(t.id)})}close({reason:t}={}){this.closed||(er.debug("close sfu connection",{remote:this.remoteMember,local:this.localPerson,reason:t}),this.closed=!0,Object.values(this._senders).forEach(e=>{e.close()}),Object.values(this._receivers).forEach(e=>{e.close()}),this._senders={},this._receivers={},this.onClose.emit())}_getReceiver(t){return this._receivers[t]}changePreferredEncoding(t){return j(this,null,function*(){var e;const i=t.preferredEncoding,n=(e=t.publication.origin)==null?void 0:e.encodings;if(er.debug("changePreferredEncoding",{preferredEncoding:i,encodings:n,subscription:t}),!i)throw je({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:vi.invalidPreferredEncoding,path:er.prefix,payload:{subscription:t}});if(!n||n.length===0)throw je({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:vi.invalidEncodings,path:er.prefix,payload:{subscription:t}});const r=Tu(i,n),s=this._getReceiver(t.id);if(!s)throw je({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:vi.receiverNotFound,path:er.prefix,payload:{subscription:t}});const o=s.transport;if(!o)throw je({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:we(ae({},vi.internal),{detail:"transport not found"}),path:er.prefix,payload:{subscription:t}});const c=s.consumer;if(!c)throw je({operationName:"SFUConnection.changePreferredEncoding",context:this._context,channel:this.channel,info:vi.consumerNotFound,path:er.prefix,payload:{subscription:t}});yield this._api.changeConsumerLayer({transportId:o.id,consumerId:c.id,publicationId:t.publication.id,spatialLayer:r}),this.localPerson._analytics&&!this.localPerson._analytics.isClosed()&&this.localPerson._analytics.client.sendSubscriptionUpdatePreferredEncodingReport({subscriptionId:t.id,preferredEncodingIndex:r,updatedAt:Date.now()})})}};ne();ne();var oE=10,Sn=new ft("packages/sfu-bot/src/member.ts"),cv=class lv extends Vl{constructor(e){super(e),this.side="remote",this.subtype=lv.subtype,this.type="bot",this._connections={},this.onForwardingStarted=new gt,this.onForwardingStopped=new gt,this.onForwardingListChanged=new gt,this._startForwardQueue=new As,this._forwardings={},this.stopForwarding=i=>new Promise((n,r)=>j(this,null,function*(){const s=Sn.info("[start] stopForwarding",yield Gt({operationName:"SfuBotMember.stopForwarding",channel:this.channel}));if(this.state!=="joined"){r(je({operationName:"SfuBotMember.stopForwarding",context:this._context,info:vi.sfuBotNotInChannel,path:Sn.prefix,channel:this.channel,payload:{status:this.state}}));return}const o=typeof i=="string"?i:i.id,c=this._forwardings[o];if(!c){r(je({operationName:"SfuBotMember.stopForwarding",context:this._context,info:vi.forwardingNotFound,path:Sn.prefix,channel:this.channel,payload:{forwardingId:o,_forwardings:Object.keys(this._forwardings)}}));return}delete this._forwardings[c.id];const{promise:h,fulfilled:d}=this._api.stopForwarding({botId:this.id,forwardingId:o});let p=!1;h.catch(v=>{p=!0,r(v)}),this.onForwardingStopped.watch(v=>v.forwarding.id===o,this._context.config.rtcApi.timeout).then(()=>j(this,null,function*(){Sn.elapsed(s,"[end] stopForwarding",yield Gt({operationName:"SfuBotMember.stopForwarding",channel:this.channel})),n()})).catch(v=>{p||r(je({operationName:"SfuBotMember.stopForwarding",context:this._context,info:we(ae({},vi.timeout),{detail:"onForwardingStopped"}),path:Sn.prefix,channel:this.channel,payload:{fulfilled:d},error:v}))})})),this._api=e.api,this._context=e.context,this._transportRepository=e.transportRepository,this.options=e.options,this.onLeft.once(()=>{Sn.debug("SfuBotMember left: ",{id:this.id}),Object.values(this._connections).forEach(i=>{i.close({reason:"sfu bot left"})}),this._connections={}})}get forwardings(){return Object.values(this._forwardings)}_getConnection(e){return this._connections[e]}_getOrCreateConnection(e){var i;return(i=this._getConnection(e.id))!=null?i:this._createConnection(this.channel,e,this)}_createConnection(e,i,n){const r=new aE(n._api,e,i,n,this._transportRepository,this._context);return r.onClose.once(()=>{delete this._connections[i.id]}),this._connections[i.id]=r,r}startForwarding(e){return j(this,arguments,function*(i,n={}){const r=Sn.info("[start] startForwarding",yield Gt({operationName:"SfuBotMember.startForwarding",channel:this.channel})),s=yield this._startForwardQueue.push(()=>this._startForwarding(i,n));return Sn.elapsed(r,"[end] startForwarding",yield Gt({operationName:"SfuBotMember.startForwarding",channel:this.channel})),s})}_startForwarding(e,i){return j(this,null,function*(){if(i.maxSubscribers==null&&(i.maxSubscribers=oE),this.state!=="joined")throw je({operationName:"SfuBotMember._startForwarding",context:this._context,channel:this.channel,info:vi.sfuBotNotInChannel,path:Sn.prefix,payload:{status:this.state}});if(!this.channel._getPublication(e.id))throw je({operationName:"SfuBotMember._startForwarding",context:this._context,channel:this.channel,info:Je.publicationNotExist,path:Sn.prefix});const n=this.channel.localPerson;if(!n)throw je({operationName:"SfuBotMember._startForwarding",context:this._context,channel:this.channel,info:Je.localPersonNotJoinedChannel,path:Sn.prefix});if(n.id!==e.publisher.id)throw je({operationName:"SfuBotMember._startForwarding",context:this._context,info:vi.remotePublisherId,path:Sn.prefix,channel:this.channel});const r=Sn.debug("[start] SfuBotMember startForwarding",{publication:e.toJSON(),configure:i}),c=yield this._getOrCreateConnection(n).addSender(e).startForwarding(i).catch(h=>{throw je({operationName:"SfuBotMember._startForwarding",context:this._context,info:we(ae({},vi.internal),{detail:"[failed] SfuBotMember startForwarding"}),path:Sn.prefix,channel:this.channel,error:h,payload:{publication:e.toJSON()}})});return this._forwardings[c.id]=c,this.listenStopForwardEvent(c),this.onForwardingStarted.emit({forwarding:c}),this.onForwardingListChanged.emit(),Sn.elapsed(r,"[end] SfuBotMember startForwarding",{forwarding:c.toJSON()}),c})}listenStopForwardEvent(e){const{removeListener:i}=this.channel.onStreamUnpublished.add(n=>{if(n.publication.id===e.id){i(),e._stop();const r=e.originPublication,s=this._getConnection(r.publisher.id);s&&s.removeSender(r.id),this.onForwardingStopped.emit({forwarding:e}),this.onForwardingListChanged.emit()}})}_dispose(){}};cv.subtype="sfu";var ea=cv;ne();var cE=we(ae({},ov),{endpointTimeout:3e4,ackTimeout:1e4,disableRestartIce:!1});ne();ne();var Jp=Hn(Wb());ne();var on=new ft("packages/sfu-bot/src/connection/transport/transport.ts"),lE=class{constructor(t,e,i,n,r,s){this.msTransport=t,this._bot=e,this._iceManager=i,this._sfuApi=n,this._context=r,this._analyticsSession=s,this._backoffIceRestart=new br({times:8,interval:100,jitter:100}),this._connectionState="new",this.onProduce=new gt,this.onProduceData=new gt,this.onMediasoupConnectionStateChanged=new gt,this.onConnectionStateChanged=new gt,this.restartIce=()=>j(this,null,function*(){if(this._backoffIceRestart.exceeded){on.error("_iceRestartedCount exceeded",je({operationName:"SfuTransport.restartIce",context:this._context,info:vi.netWorkError,path:on.prefix})),this._setConnectionState("disconnected");return}on.warn("[start] restartIce",Ws({bot:this._bot,detail:"start restartIce",operationName:"SfuTransport.restartIce",payload:{count:this._backoffIceRestart.count,transport:this}}));const p=()=>{if(this._bot.state==="left")return on.debug("bot already left",this),this._setConnectionState("disconnected"),on.warn("[end] restartIce",Ws({bot:this._bot,detail:"end restartIce",operationName:"SfuTransport.restartIce",payload:{count:this._backoffIceRestart.count,transport:this}})),!0;if(this.msTransport.connectionState==="connected")return this._backoffIceRestart.reset(),this._setConnectionState("connected"),on.warn("[end] restartIce",Ws({bot:this._bot,detail:"end restartIce",operationName:"SfuTransport.restartIce",payload:{count:this._backoffIceRestart.count,transport:this}})),this._analyticsSession&&!this._analyticsSession.isClosed()&&this._analyticsSession.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.id,type:"restartIce",data:void 0,createdAt:Date.now()}),!0};if(this._setConnectionState("reconnecting"),yield this._backoffIceRestart.wait(),p())return;let v=yield this._iceManager.updateIceParams().catch(_=>_);if(v){on.warn("updateIceParams failed",Ws({operationName:"SfuTransport.restartIce",detail:"updateIceParams failed",bot:this._bot,payload:{transport:this}}),v),yield this.restartIce();return}if(yield this.msTransport.updateIceServers({iceServers:this._iceManager.iceServers}),p())return;const g=yield this._mediasoupRestartIce();if(v=yield this._waitForMsConnectionState("connected",this._context.config.rtcConfig.iceDisconnectBufferTimeout).catch(_=>_),!v&&p())return g;yield this.restartIce()}),this._waitForMsConnectionState=(p,v=1e4)=>j(this,null,function*(){p!==this.msTransport.connectionState&&(yield this.onMediasoupConnectionStateChanged.watch(()=>p===this.msTransport.connectionState,v).catch(g=>{throw je({operationName:"SfuTransport._waitForMsConnectionState",context:this._context,info:we(ae({},vi.timeout),{detail:"waitForConnectionState timeout"}),error:g,path:on.prefix})}))}),this._onConnect=p=>(v,g,_)=>j(this,[v,g,_],function*({dtlsParameters:S},E,M){try{on.debug("[start] transport connect",{transportId:p}),yield this._sfuApi.connect({transportId:p,dtlsParameters:S}),on.debug("[end] transport connect",{transportId:p}),E()}catch(R){on.error("[failed] transport connect",{error:R,transportId:p}),M(R)}});var o,c,h;const d=r.plugins.find(p=>p.subtype===zl.subtype);this._options=d.options,on.debug("peerConfig",(h=(c=(o=this.pc)==null?void 0:o.getConfiguration)==null?void 0:c.call(o))!=null?h:{}),t.on("connect",(p,v,g)=>this._onConnect(t.id)(p,v,g)),t.on("connectionstatechange",p=>{this.onMediasoupConnectionStateChanged.emit(p),this._analyticsSession&&!this._analyticsSession.isClosed()&&this._analyticsSession.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.id,type:"connectionStateChange",data:{connectionState:p},createdAt:Date.now()})}),t.on("produce",(p,v,g)=>{this.onProduce.emit({producerOptions:p,callback:v,errback:g})}),t.on("producedata",(p,v,g)=>{this.onProduceData.emit({producerOptions:p,callback:v,errback:g})}),this.onMediasoupConnectionStateChanged.add(p=>j(this,null,function*(){switch(Gt({operationName:"onMediasoupConnectionStateChanged",channel:this._bot.channel}).then(v=>{on.debug(v,{state:p,transportId:this.id,bot:e})}).catch(()=>{}),p){case"disconnected":case"failed":{if(this._connectionState==="reconnecting")return;(yield this._waitForMsConnectionState("connected",r.config.rtcConfig.iceDisconnectBufferTimeout).catch(g=>g))&&this._connectionState!=="reconnecting"&&e.options.disableRestartIce!==!0&&(yield this.restartIce())}break;case"connecting":case"connected":this._setConnectionState(p);break;case"closed":this._setConnectionState("disconnected");break}on.debug("onMediasoupConnectionStateChanged",this)}))}get pc(){var t,e,i;return(i=(e=(t=this.msTransport)==null?void 0:t._handler)==null?void 0:e._pc)!=null?i:{}}get id(){return this.msTransport.id}get connectionState(){return this._connectionState}toJSON(){return{id:this.id,direction:this.msTransport.direction,connectionState:this._connectionState}}close(){var t;on.debug("close",this.id),(t=this.pc)!=null&&t.peerIdentity&&this.pc.peerIdentity.catch(()=>{}),this.msTransport.close(),this._setConnectionState("disconnected")}_setConnectionState(t){this._connectionState!==t&&(on.debug("onConnectionStateChanged",this._connectionState,t,this),this._connectionState=t,this.onConnectionStateChanged.emit(t),this._analyticsSession&&!this._analyticsSession.isClosed()&&this._analyticsSession.client.sendRtcPeerConnectionEventReport({rtcPeerConnectionId:this.id,type:"skywayConnectionStateChange",data:{skywayConnectionState:t},createdAt:Date.now()}))}_mediasoupRestartIce(){return j(this,null,function*(){const t=yield this._sfuApi.iceRestart({transportId:this.id}).catch(e=>e);if(t instanceof Error){on.warn("iceRestart failed",Ws({operationName:"SfuTransport._mediasoupRestartIce",detail:"iceRestart failed",bot:this._bot,payload:{transport:this}}),t),yield this.restartIce();return}return yield this.msTransport.restartIce({iceParameters:t}),t})}},Td=new ft("packages/sfu-bot/src/connection/transport/transportRepository.ts"),dE=class{constructor(t,e){this._context=t,this._api=e,this.onTransportCreated=new gt,this._transports={},this.getTransport=(r,s)=>this._transports[r+s];const{browserName:i,browserVersion:n}=bg();Td.debug("runtime info",{browserName:i,browserVersion:n}),i==="Safari"&&n==null?this._device=new Jp.Device({handlerName:"Safari12"}):this._device=new Jp.Device}get rtpCapabilities(){if(this._device.loaded)return this._device.rtpCapabilities}loadDevice(t){return j(this,null,function*(){this._device.loaded||(yield this._device.load({routerRtpCapabilities:t}).catch(e=>{throw je({operationName:"TransportRepository.loadDevice",context:this._context,info:we(ae({},vi.internal),{detail:"loadDevice failed"}),path:Td.prefix,payload:{rtpCapabilities:t},error:e})}),Td.debug("device loaded",{routerRtpCapabilities:t,rtpCapabilities:this._device.rtpCapabilities}))})}createTransport(t,e,i,n,r,s){const c=(n==="send"?d=>this._device.createSendTransport(d):d=>this._device.createRecvTransport(d))(we(ae({},i),{iceServers:r.iceServers,iceTransportPolicy:this._context.config.rtcConfig.turnPolicy==="turnOnly"?"relay":void 0,additionalSettings:this._context.config.rtcConfig})),h=new lE(c,e,r,this._api,this._context,s);return this._transports[t+c.id]=h,this.onTransportCreated.emit(c.id),h}deleteTransports(t){Object.entries(ae({},this._transports)).forEach(([e,i])=>{e.includes(t)&&(i.close(),delete this._transports[e])})}};ne();var uE="1.13.0",ks=new ft("packages/sfu-bot/src/plugin.ts"),dv=class uv extends Ah{constructor(e={}){super(),this.subtype=uv.subtype,this._createRemoteMember=(i,n)=>new ea(we(ae({},this._context),{channel:i,id:n.id,name:n.name,metadata:n.metadata,plugin:this,api:this._api,context:this._context,transportRepository:this._transportRepository,options:this.options})),this.createBot=i=>j(this,null,function*(){var n;const r=ks.info("[start] createBot",yield Gt({operationName:"SfuBotPlugin.createBot",channel:i})),s=this._context.authToken.getAppId(),o=yield this._api.createBot({appId:s,channelId:i.id}),c=(n=i._getMember(o))!=null?n:(yield i.onMemberJoined.watch(h=>h.member.id===o,this._context.config.rtcApi.timeout).catch(h=>{throw je({operationName:"SfuBotPlugin.createBot",info:we(ae({},vi.timeout),{detail:"onMemberJoined"}),path:ks.prefix,error:h,context:this._context})})).member;return ks.elapsed(r,"[end] createBot",yield Gt({operationName:"SfuBotPlugin.createBot",channel:i})),c}),this.deleteBot=(i,n)=>j(this,null,function*(){return new Promise((r,s)=>j(this,null,function*(){const o=ks.info("[start] deleteBot",yield Gt({operationName:"SfuBotPlugin.deleteBot",channel:i}));let c=!1;this._api.deleteBot({botId:n}).catch(h=>{c=!0,s(h)}),i.onMemberLeft.watch(h=>h.member.id===n,this._context.config.rtcApi.timeout).then(()=>j(this,null,function*(){ks.elapsed(o,"[end] deleteBot",yield Gt({operationName:"SfuBotPlugin.deleteBot",channel:i})),r()})).catch(h=>{c||s(je({operationName:"SfuBotPlugin.deleteBot",info:we(ae({},vi.timeout),{detail:"onMemberLeft"}),path:ks.prefix,channel:i,error:h,context:this._context}))})}))}),this.options=ae(ae({},cE),e),this._onContextAttached.once(i=>{ft.level=i.config.log.level,ft.format=i.config.log.format,ks.info("SfuBotPlugin spawned",{operationName:"SfuBotPlugin.constructor",endpoint:{sfu:this.options.domain},options:this.options,sdkName:"sfu-bot",sdkVersion:uE}),this._api=new iE(i.authTokenString,we(ae({},this.options),{log:i.config.log})),this._transportRepository=new dE(i,this._api),i._onTokenUpdated.add(n=>{this._api.updateToken(n)})}),this._whenDisposeLocalPerson=i=>j(this,null,function*(){this._transportRepository.deleteTransports(i.id)})}};dv.subtype=ea.subtype;var zl=dv,hE={invalidParameter:{name:"invalidParameter",detail:"",solution:""},timeout:{name:"timeout",detail:"",solution:""},internal:{name:"internal",detail:"",solution:""},notImplemented:{name:"notImplemented",detail:"RoomType",solution:"RoomType"},roomNotOpened:{name:"roomNotOpened",detail:"RoomOpen",solution:"Room"},subscribeOtherMemberType:{name:"subscribeOtherMemberType",detail:"RemoteMemberSubscribe/UnsubscribeMemberTypePerson",solution:"RemoteMember"},sfuRoomNotSupportDataStream:{name:"sfuRoomNotSupportDataStream",detail:"SFURoomDataStream",solution:""},publicationNotHasOrigin:{name:"publicationNotHasOrigin",detail:"SfuRoomPublicationOrigin",solution:"SfuRoomP2PRoomID"},notFound:{name:"notFound",detail:"",solution:""}},Cn=ae(ae(ae({},Je),vi),hE);ne();var hv=class{constructor(t,e){this.member=t,this.room=e,this.onLeft=new gt;const{removeListener:i}=e.onMemberLeft.add(n=>{n.member.id===this.member.id&&(i(),this.onLeft.emit())});this.onMetadataUpdated=t.onMetadataUpdated}get id(){return this.member.id}get name(){return this.member.name}get roomId(){return this.room.id}get roomName(){return this.room.name}get roomType(){return this.room.type}get state(){return this.member.state}get metadata(){return this.member.metadata}get _member(){return this.member}get publications(){return this.room.publications.filter(t=>t.publisher.id===this.id)}get subscriptions(){return this.member.subscriptions.map(t=>this.room._getSubscription(t.id))}updateMetadata(t){return this.member.updateMetadata(t)}leave(){return this.member.leave()}toJSON(){return{id:this.id,name:this.name,metadata:this.metadata}}};ne();var pv=class extends hv{constructor(t,e){super(t,e),this.side="local",this._local=this._member,this.onStreamPublished=new gt,this.onStreamUnpublished=new gt,this.onPublicationListChanged=new gt,this.onPublicationSubscribed=new gt,this.onPublicationUnsubscribed=new gt,this.onSubscriptionListChanged=new gt,this.onFatalError=new gt,this._context=this.room._context,this._local.onPublicationSubscribed.add(i=>j(this,null,function*(){const n=e._addSubscription(i.subscription);this.onPublicationSubscribed.emit({subscription:n,stream:i.stream})})),this._local.onFatalError.pipe(this.onFatalError),this._listenRoomEvent(),this.onStreamPublished.add(()=>this.onPublicationListChanged.emit()),this.onStreamUnpublished.add(()=>this.onPublicationListChanged.emit()),this.onPublicationSubscribed.add(()=>this.onSubscriptionListChanged.emit()),this.onPublicationUnsubscribed.add(()=>this.onSubscriptionListChanged.emit())}get subscriptions(){return this.member.subscriptions.map(t=>this.room._getSubscription(t.id)).filter(t=>t.stream)}_listenRoomEvent(){this.room.onPublicationUnsubscribed.add(t=>{t.subscription.subscriber._member.id===this._local.id&&this.onPublicationUnsubscribed.emit(t)})}};ne();ne();function En({operationName:t,context:e,info:i,error:n,path:r,payload:s,room:o}){const c={operationName:t,payload:s};return o&&(c.appId=o._channel.appId,c.roomId=o.id,o.localRoomMember&&(c.memberId=o.localRoomMember.id)),e&&(c.info=e.info,c.plugins=e.plugins.map(h=>h.subtype)),new Xn({error:n,info:i,payload:c,path:r})}var _o=new ft("packages/room/src/member/local/p2p.ts"),pE=class extends pv{constructor(t,e){super(t,e)}publish(t){return j(this,arguments,function*(e,i={}){const n=yield this._local.publish(e,i),r=this.room._addPublication(n);return this.onStreamPublished.emit({publication:r}),r})}unpublish(t){return j(this,null,function*(){const e=typeof t=="string"?t:t.id;this._local.unpublish(e).catch(n=>{_o.error("unpublish",n,{target:t},this.toJSON())});const{publication:i}=yield this.room.onStreamUnpublished.watch(n=>n.publication.id===e,this._context.config.rtcApi.timeout).catch(n=>{throw En({operationName:"LocalP2PRoomMemberImpl.unpublish",context:this._context,room:this.room,info:we(ae({},Cn.timeout),{detail:"onStreamUnpublished"}),path:_o.prefix,error:n})});this.onStreamUnpublished.emit({publication:i})})}subscribe(t){return j(this,null,function*(){const e=typeof t=="string"?t:t.id,{subscription:i,stream:n}=yield this._local.subscribe(e);return{subscription:this.room._addSubscription(i),stream:n}})}unsubscribe(t){return j(this,null,function*(){const e=typeof t=="string"?t:t.id;this._local.unsubscribe(e).catch(i=>{_o.error("unsubscribe",i,{target:t},this.toJSON())}),yield this.room.onPublicationUnsubscribed.watch(i=>i.subscription.id===e,this._context.config.rtcApi.timeout).catch(i=>{throw En({operationName:"LocalP2PRoomMemberImpl.unsubscribe",context:this._context,room:this.room,info:we(ae({},Cn.timeout),{detail:"onPublicationUnsubscribed"}),path:_o.prefix,error:i})})})}_updateRoom(t){_o.debug("_updateRoom",{memberId:this.id}),this.room=t,this._listenRoomEvent()}};ne();ne();var fE=10,us=new ft("packages/room/src/member/local/sfu.ts"),mE=class extends pv{constructor(t,e){super(t,e)}publish(t){return j(this,arguments,function*(e,i={}){var n;if(e instanceof Ph)throw En({operationName:"LocalSFURoomMemberImpl.publish",context:this._context,room:this.room,info:Cn.sfuRoomNotSupportDataStream,path:us.prefix});i.maxSubscribers=(n=i.maxSubscribers)!=null?n:fE;const r=yield this._local.publish(e,i),s=this.room._channel.members.find(d=>d.subtype===ea.subtype);if(!s)throw En({operationName:"LocalSFURoomMemberImpl.publish",context:this._context,room:this.room,info:vi.sfuBotNotInChannel,path:us.prefix});const c=(yield s.startForwarding(r,{maxSubscribers:i.maxSubscribers})).relayingPublication,h=this.room._addPublication(c);return this.onStreamPublished.emit({publication:h}),h})}unpublish(t){return j(this,null,function*(){const e=typeof t=="string"?t:t.id,i=this.room._getPublication(e),n=i._publication.origin;if(!n)throw En({operationName:"LocalSFURoomMemberImpl.unpublish",context:this._context,room:this.room,info:Cn.publicationNotHasOrigin,path:us.prefix});this._local.unpublish(n.id).catch(r=>{us.error("unpublish error",r,{target:t},this.toJSON())}),yield this.room.onStreamUnpublished.watch(r=>r.publication.id===e,this._context.config.rtcApi.timeout).catch(r=>{throw En({operationName:"LocalSFURoomMemberImpl.unpublish",context:this._context,room:this.room,info:we(ae({},Cn.timeout),{detail:"onStreamUnpublished"}),path:us.prefix,error:r})}),this.onStreamUnpublished.emit({publication:i})})}subscribe(t,e){return j(this,null,function*(){const i=typeof t=="string"?t:t.id,{subscription:n,stream:r}=yield this._local.subscribe(i,e);return{subscription:this.room._addSubscription(n),stream:r}})}unsubscribe(t){return j(this,null,function*(){const e=typeof t=="string"?t:t.id;this._local.unsubscribe(e).catch(i=>{us.error("unsubscribe error",i,{target:t},this.toJSON())}),yield this.room.onPublicationUnsubscribed.watch(i=>i.subscription.id===e,this._context.config.rtcApi.timeout).catch(i=>{throw En({operationName:"LocalSFURoomMemberImpl.unsubscribe",context:this._context,room:this.room,info:we(ae({},Cn.timeout),{detail:"onPublicationUnsubscribed"}),path:us.prefix,error:i})})})}_updateRoom(t){us.debug("_updateRoom",{memberId:this.id}),this.room=t,this._listenRoomEvent()}};ne();var Qp=new ft("packages/room/src/member/remote/base.ts"),yl=class extends hv{constructor(t,e){super(t,e),this.side="remote",this.onPublicationSubscribed=new gt,this.onPublicationUnsubscribed=new gt,this.onSubscriptionListChanged=new gt,this.onPublicationListChanged=new gt,this._disposer=new Yn,this.subscribe=i=>new Promise((n,r)=>{if(!(this.member instanceof el)){r(En({operationName:"RemoteRoomMemberImpl.subscribe",context:this.room._context,room:this.room,info:Cn.subscribeOtherMemberType,path:Qp.prefix}));return}let s=!1;this.member.subscribe(i).catch(o=>{s=!0,r(o)}),this.onPublicationSubscribed.watch(o=>o.subscription.publication.id===i).then(o=>n(o)).catch(o=>{s||r(o)})}),this.unsubscribe=i=>new Promise((n,r)=>{if(!(this.member instanceof el)){r(En({operationName:"RemoteRoomMemberImpl.unsubscribe",context:this.room._context,room:this.room,info:Cn.subscribeOtherMemberType,path:Qp.prefix}));return}let s=!1;this.member.unsubscribe(i).catch(o=>{s=!0,r(o)}),this.onPublicationUnsubscribed.watch(o=>o.subscription.id===i).then(()=>n()).catch(o=>{s||r(o)})}),e.onPublicationSubscribed.add(i=>{i.subscription.subscriber._member.id===t.id&&(this.onPublicationSubscribed.emit(i),this.onSubscriptionListChanged.emit())}).disposer(this._disposer),e.onPublicationUnsubscribed.add(i=>{i.subscription.subscriber._member.id===t.id&&(this.onPublicationUnsubscribed.emit(i),this.onSubscriptionListChanged.emit())}).disposer(this._disposer),t instanceof el&&t.onPublicationListChanged.pipe(this.onPublicationListChanged).disposer(this._disposer)}_dispose(){this._disposer.dispose()}};ne();var tl="packages/room/src/publication/index.ts",ef=new ft(tl),gE=class{constructor(t,e){this._publication=t,this._room=e,this._disposer=new Yn,this._events=new jr,this.onCanceled=this._events.make(),this.onSubscribed=this._events.make(),this.onUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onEnabled=this._events.make(),this.onDisabled=this._events.make(),this.onStateChanged=this._events.make(),this.onConnectionStateChanged=new gt,this.enable=()=>new Promise((n,r)=>{this._origin?Promise.all([this._origin.enable(),this._publication.onEnabled.asPromise()]).then(()=>n()).catch(r):this._publication.enable().then(n).catch(r)}),this.disable=()=>new Promise((n,r)=>{this._origin?Promise.all([this._origin.disable(),this._publication.onDisabled.asPromise()]).then(()=>n()).catch(r):this._publication.disable().then(n).catch(r)}),this.replaceStream=(n,r={})=>{this._preferredPublication.replaceStream(n,r)};var i;this.id=t.id,this.contentType=t.contentType,this._origin=t.origin;{const n=(i=this._origin)!=null?i:this._publication;this.publisher=this._room._getMember(n.publisher.id)}this._setEvents()}_setEvents(){var t;this._room.onStreamUnpublished.add(e=>{e.publication.id===this.id&&this._dispose()}),this._room.onPublicationSubscribed.add(e=>{e.subscription.publication.id===this.id&&(this.onSubscribed.emit({subscription:e.subscription}),this.onSubscriptionListChanged.emit())}).disposer(this._disposer),this._room.onPublicationUnsubscribed.add(e=>{e.subscription.publication.id===this.id&&(this.onUnsubscribed.emit({subscription:e.subscription}),this.onSubscriptionListChanged.emit())}).disposer(this._disposer),this._publication.onEnabled.pipe(this.onEnabled),this._publication.onDisabled.pipe(this.onDisabled),this._publication.onStateChanged.pipe(this.onStateChanged),((t=this._origin)!=null?t:this._publication).onMetadataUpdated.pipe(this.onMetadataUpdated),this._origin?this._origin.onConnectionStateChanged.add(e=>{ef.debug("this._origin.onConnectionStateChanged",this.id,e),this.onConnectionStateChanged.emit({state:e.state})}):this._publication.onConnectionStateChanged.add(e=>{ef.debug("this._publication.onConnectionStateChanged",this.id,e),this.onConnectionStateChanged.emit({state:e.state,remoteMember:this._room._getMember(e.remoteMember.id)})})}get subscriptions(){return this._publication.subscriptions.map(t=>this._room._getSubscription(t.id))}get _preferredPublication(){var t;return(t=this._origin)!=null?t:this._publication}get codecCapabilities(){return this._preferredPublication.codecCapabilities}get encodings(){return this._preferredPublication.encodings}get stream(){return this._preferredPublication.stream}get state(){return this._preferredPublication.state}get metadata(){return this._preferredPublication.metadata}cancel(){return j(this,null,function*(){yield Promise.all([this._preferredPublication.cancel(),this.onCanceled.asPromise()])})}updateMetadata(t){return j(this,null,function*(){yield this._preferredPublication.updateMetadata(t)})}updateEncodings(t){this._preferredPublication.updateEncodings(t)}_dispose(){this.onCanceled.emit(),this._events.dispose(),this._disposer.dispose()}getStats(t){var e;if(this._origin){const i=(e=this._origin.subscriptions.find(n=>n.subscriber.subtype===ea.subtype))==null?void 0:e.subscriber;if(!i)throw En({operationName:"RoomPublicationImpl.getStats",room:this._room,path:tl,info:we(ae({},Cn.notFound),{detail:"bot not found"})});return this._origin.getStats(i)}else{const i=typeof t=="string"?t:t.id;return this._publication.getStats(i)}}getRTCPeerConnection(t){var e;if(this._origin){const i=(e=this._origin.subscriptions.find(n=>n.subscriber.subtype===ea.subtype))==null?void 0:e.subscriber;if(!i)throw En({operationName:"RoomPublicationImpl.getRTCPeerConnection",room:this._room,path:tl,info:we(ae({},Cn.notFound),{detail:"bot not found"})});return this._origin.getRTCPeerConnection(i)}else{const i=typeof t=="string"?t:t.id;return this._publication.getRTCPeerConnection(i)}}getConnectionState(t){var e;if(this._origin){const i=(e=this._origin.subscriptions.find(n=>n.subscriber.subtype===ea.subtype))==null?void 0:e.subscriber;if(!i)throw En({operationName:"RoomPublicationImpl.getConnectionState",room:this._room,path:tl,info:we(ae({},Cn.notFound),{detail:"bot not found"})});return this._origin.getConnectionState(i)}else{const i=typeof t=="string"?t:t.id;return this._publication.getConnectionState(i)}}toJSON(){return{id:this.id,contentType:this.contentType,metadata:this.metadata,publisher:this.publisher,subscriptions:this.subscriptions,codecCapabilities:this.codecCapabilities,encodings:this.encodings,state:this.state}}};ne();ne();var vE="1.13.0";ne();ne();ne();var Rd=new ft("packages/room/src/subscription/index.ts"),_E=class{constructor(t,e){this._subscription=t,this._room=e,this._context=this._room._context,this.onStreamAttached=new gt,this.onCanceled=new gt,this.onConnectionStateChanged=new gt,this.id=t.id,this.contentType=t.contentType,this.publication=this._room._getPublication(t.publication.id),this.subscriber=this._room._getMember(t.subscriber.id),t.onStreamAttached.pipe(this.onStreamAttached),t.onCanceled.pipe(this.onCanceled),t.onConnectionStateChanged.add(i=>{Rd.debug("_subscription.onConnectionStateChanged",this.id,i),this.onConnectionStateChanged.emit(i)})}get stream(){return this._subscription.stream}get state(){return this._subscription.state}get codec(){return this._subscription.codec}get preferredEncoding(){return this._subscription.preferredEncoding}changePreferredEncoding(t){this._subscription.changePreferredEncoding(t)}cancel(){return j(this,null,function*(){this._subscription.cancel().catch(t=>{Rd.error("subscription.cancel",t,this.toJSON())}),yield this._room.onPublicationUnsubscribed.watch(t=>t.subscription.id===this.id,this._context.config.rtcApi.timeout).catch(t=>{throw En({operationName:"RoomSubscriptionImpl.cancel",context:this._context,room:this._room,info:we(ae({},Cn.timeout),{detail:"onPublicationUnsubscribed"}),error:t,path:Rd.prefix})})})}toJSON(){return{id:this.id,contentType:this.contentType,publication:this.publication,codec:this.codec}}getStats(){return this._subscription.getStats()}getRTCPeerConnection(){return this._subscription.getRTCPeerConnection()}getConnectionState(){return this._subscription.getConnectionState()}},tf=new ft("packages/room/src/room/base.ts"),fv=class{constructor(t,e){this._channel=e,this._members={},this._publications={},this._subscriptions={},this._context=this._channel._context,this._events=new jr,this.onClosed=this._events.make(),this.onMetadataUpdated=this._events.make(),this.onMemberJoined=this._events.make(),this.onMemberLeft=this._events.make(),this.onMemberListChanged=this._events.make(),this.onMemberMetadataUpdated=this._events.make(),this.onStreamPublished=this._events.make(),this.onStreamUnpublished=this._events.make(),this.onPublicationListChanged=this._events.make(),this.onPublicationMetadataUpdated=this._events.make(),this.onPublicationEnabled=this._events.make(),this.onPublicationDisabled=this._events.make(),this.onPublicationSubscribed=this._events.make(),this.onPublicationUnsubscribed=this._events.make(),this.onSubscriptionListChanged=this._events.make(),this.type=t,this._channel.onClosed.pipe(this.onClosed),this._channel.onMetadataUpdated.pipe(this.onMetadataUpdated),this._channel.onMemberMetadataUpdated.add(i=>{this._handleOnMemberMetadataUpdate(i)})}_getMember(t){return this._members[t]}_getPublication(t){return this._publications[t]}_addPublication(t){const e=this._publications[t.id];if(e)return e;const i=new gE(t,this);return this._publications[t.id]=i,i}_getSubscription(t){return this._subscriptions[t]}_addSubscription(t){const e=this._subscriptions[t.id];if(e)return e;const i=new _E(t,this);return this._subscriptions[t.id]=i,i}get id(){return this._channel.id}get name(){return this._channel.name}get metadata(){return this._channel.metadata}get state(){return this._channel.state}get disposed(){return this._channel.disposed}_handleOnMemberMetadataUpdate(t){const e=this._getMember(t.member.id);this.onMemberMetadataUpdated.emit({member:e,metadata:t.metadata})}get members(){return Object.values(this._members)}get publications(){return Object.values(this._publications)}get subscriptions(){return Object.values(this._subscriptions)}joinChannel(){return j(this,arguments,function*(t={}){var e;if(this.state!=="opened")throw En({operationName:"RoomImpl.joinChannel",context:this._context,room:this,info:Cn.roomNotOpened,path:tf.prefix});t.name=(e=t.name)!=null?e:Vr();const i=yield this._channel.join(t);return this._getMember(i.id)||(yield this.onMemberJoined.watch(n=>n.member._member.id===i.id,this._context.config.rtcApi.timeout).catch(n=>{throw En({operationName:"RoomImpl.joinChannel",context:this._context,room:this,info:we(ae({},Cn.timeout),{detail:"RoomImpl onMemberJoined"}),path:tf.prefix,error:n})})),i})}leave(t){return j(this,null,function*(){yield this._channel.leave(t._member)})}moveRoom(t){return j(this,null,function*(){return yield this._channel.moveChannel(t._local),t._updateRoom(this),t})}updateMetadata(t){return this._channel.updateMetadata(t)}close(){return j(this,null,function*(){yield this._channel.close()})}dispose(){return j(this,null,function*(){return this._channel.dispose()})}toJSON(){return{type:this.type,id:this.id,name:this.name,metadata:this.metadata,members:this.members,publications:this.publications,subscriptions:this.subscriptions}}},bE=new ft("packages/room/src/room/p2p.ts"),yE=class extends fv{constructor(t){super("p2p",t),this.setChannelState(),this.setChannelListener()}setChannelState(){this._channel.members.forEach(t=>{const e=new yl(t,this);this._members[t.id]=e}),this._channel.publications.forEach(t=>{this._addPublication(t)}),this._channel.subscriptions.forEach(t=>{this._addSubscription(t)})}setChannelListener(){this._channel.onMemberJoined.add(t=>this._handleOnMemberJoin(t.member)),this._channel.onMemberLeft.add(t=>this._handleOnMemberLeft(t.member)),this._channel.onStreamPublished.add(t=>this._handleOnStreamPublish(t.publication)),this._channel.onStreamUnpublished.add(t=>this._handleOnStreamUnpublish(t.publication)),this._channel.onPublicationMetadataUpdated.add(t=>{this._handleOnPublicationMetadataUpdate(t.publication)}),this._channel.onPublicationEnabled.add(t=>{this._handleOnPublicationEnabled(t.publication)}),this._channel.onPublicationDisabled.add(t=>{this._handleOnPublicationDisabled(t.publication)}),this._channel.onPublicationSubscribed.add(t=>this._handleOnStreamSubscribe(t.subscription)),this._channel.onPublicationUnsubscribed.add(t=>this._handleOnStreamUnsubscribe(t.subscription))}_handleOnMemberJoin(t){if(this._getMember(t.id))return;const e=new yl(t,this);this._members[t.id]=e,this.onMemberJoined.emit({member:e}),this.onMemberListChanged.emit({})}_handleOnMemberLeft(t){const e=this._getMember(t.id);delete this._members[t.id],e._dispose(),this.onMemberLeft.emit({member:e}),this.onMemberListChanged.emit({})}_handleOnStreamPublish(t){if(this._getPublication(t.id))return;const e=this._addPublication(t);this.onStreamPublished.emit({publication:e}),this.onPublicationListChanged.emit({})}_handleOnStreamUnpublish(t){const e=this._getPublication(t.id);delete this._publications[t.id],this.onStreamUnpublished.emit({publication:e}),this.onPublicationListChanged.emit({})}_handleOnPublicationMetadataUpdate(t){const e=this._getPublication(t.id);this.onPublicationMetadataUpdated.emit({publication:e,metadata:e.metadata})}_handleOnPublicationEnabled(t){const e=this._getPublication(t.id);this.onPublicationEnabled.emit({publication:e})}_handleOnPublicationDisabled(t){const e=this._getPublication(t.id);this.onPublicationDisabled.emit({publication:e})}_handleOnStreamSubscribe(t){if(this._getSubscription(t.id))return;const e=this._addSubscription(t);this.onPublicationSubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit({})}_handleOnStreamUnsubscribe(t){const e=this._getSubscription(t.id);delete this._subscriptions[t.id],this.onPublicationUnsubscribed.emit({subscription:e}),this.onSubscriptionListChanged.emit({})}join(){return j(this,arguments,function*(t={}){const e=yield this.joinChannel(t),i=new pE(e,this);return bE.debug("member joined",t),this.localRoomMember=i,i.onLeft.once(()=>{this.localRoomMember=void 0}),i})}};ne();var SE=new ft("packages/room/src/room/sfu.ts"),wE=class mv extends fv{constructor(e,i){super("sfu",e),this._plugin=i,this.setChannelState(),this.setChannelListener()}static Create(e,i){return j(this,null,function*(){const n=e.plugins.find(o=>o.subtype==="sfu");return i.members.find(o=>o.subtype===ea.subtype)||(yield n.createBot(i)),new mv(i,n)})}setChannelState(){this._channel.members.forEach(e=>{if(e.type==="bot")return;const i=new yl(e,this);this._members[e.id]=i}),this._channel.publications.forEach(e=>{e.origin&&this._addPublication(e)}),this._channel.subscriptions.forEach(e=>{e.subscriber.type!=="bot"&&this._addSubscription(e)})}setChannelListener(){this._channel.onMemberJoined.add(e=>this._handleOnMemberJoin(e.member)),this._channel.onMemberLeft.add(e=>this._handleOnMemberLeft(e.member)),this._channel.onStreamPublished.add(e=>{this._handleOnStreamPublish(e.publication)}),this._channel.onStreamUnpublished.add(e=>this._handleOnStreamUnpublish(e.publication)),this._channel.onPublicationMetadataUpdated.add(e=>{this._handleOnPublicationMetadataUpdate(e.publication)}),this._channel.onPublicationEnabled.add(e=>{this._handleOnPublicationEnabled(e.publication)}),this._channel.onPublicationDisabled.add(e=>{this._handleOnPublicationDisabled(e.publication)}),this._channel.onPublicationSubscribed.add(e=>{this._handleOnStreamSubscribe(e.subscription)}),this._channel.onPublicationUnsubscribed.add(e=>this._handleOnStreamUnsubscribe(e.subscription))}_handleOnMemberJoin(e){if(e.type==="bot")return;const i=new yl(e,this);this._members[e.id]=i,this.onMemberJoined.emit({member:i}),this.onMemberListChanged.emit({})}_handleOnMemberLeft(e){const i=this._getMember(e.id);i&&(delete this._members[e.id],i._dispose(),this.onMemberLeft.emit({member:i}),this.onMemberListChanged.emit({}))}_handleOnStreamPublish(e){var i;if(!((i=e.origin)!=null&&i.id))return;const n=this._addPublication(e);this.onStreamPublished.emit({publication:n}),this.onPublicationListChanged.emit({})}_handleOnStreamUnpublish(e){var i;if(!((i=e.origin)!=null&&i.id))return;const n=this._getPublication(e.id);delete this._publications[e.id],this.onStreamUnpublished.emit({publication:n}),this.onPublicationListChanged.emit({})}_getRelayedPublication(e){return this.publications.find(n=>{var r;return((r=n._publication.origin)==null?void 0:r.id)===e})}_handleOnPublicationMetadataUpdate(e){const i=this._getRelayedPublication(e.id);i&&this.onPublicationMetadataUpdated.emit({publication:i,metadata:i.metadata})}_handleOnPublicationEnabled(e){const i=this._getRelayedPublication(e.id);i&&this.onPublicationEnabled.emit({publication:i})}_handleOnPublicationDisabled(e){const i=this._getRelayedPublication(e.id);i&&this.onPublicationDisabled.emit({publication:i})}_handleOnStreamSubscribe(e){if(e.subscriber.type==="bot")return;const i=this._addSubscription(e);this.onPublicationSubscribed.emit({subscription:i}),this.onSubscriptionListChanged.emit({})}_handleOnStreamUnsubscribe(e){if(e.subscriber.type==="bot")return;const i=this._getSubscription(e.id);delete this._subscriptions[e.id],this.onPublicationUnsubscribed.emit({subscription:i}),this.onSubscriptionListChanged.emit({})}join(){return j(this,arguments,function*(e={}){const i=yield this.joinChannel(we(ae({},e),{disableSignaling:!0})),n=new mE(i,this);return this.localRoomMember=n,n.onLeft.once(()=>{this.localRoomMember=void 0}),SE.debug("member joined",e),n})}},gv=new ft("packages/room/src/room/index.ts"),Ts=class{constructor(){}};Ts.Create=(t,e)=>j(null,null,function*(){var i,n;gv.info("room created",{operationName:"SkyWayRoom._Factory",sdkName:"room",sdkVersion:vE,init:e});const r=new zl((i=e==null?void 0:e.options)==null?void 0:i.sfu);t.registerPlugin(r);const s=yield Dh.Create(t,{name:(n=e.name)!=null?n:Vr(),metadata:e.metadata});return yield Ts._Factory(t,e.type,s)});Ts.Find=(t,e,i,n)=>j(null,null,function*(){const r=new zl(n==null?void 0:n.sfu);t.registerPlugin(r);const s=yield Dh.Find(t,e);return yield Ts._Factory(t,i,s)});Ts.FindOrCreate=(t,e)=>j(null,null,function*(){var i;const n=new zl((i=e==null?void 0:e.options)==null?void 0:i.sfu);t.registerPlugin(n);const r=yield Dh.FindOrCreate(t,ae({},e));return yield Ts._Factory(t,e.type,r)});Ts._Factory=(t,e,i)=>j(null,null,function*(){switch(e){case"p2p":return new yE(i);case"sfu":return yield wE.Create(t,i);default:throw je({operationName:"SkyWayRoom._Factory",context:t,channel:i,info:Cn.notImplemented,path:gv.prefix})}});var xE=Ts;ne();/*! Bundled license information:

jsrsasign/lib/jsrsasign.js:
  (*! CryptoJS v3.1.2 core-fix.js
   * code.google.com/p/crypto-js
   * (c) 2009-2013 by Jeff Mott. All rights reserved.
   * code.google.com/p/crypto-js/wiki/License
   * THIS IS FIX of 'core.js' to fix Hmac issue.
   * https://code.google.com/p/crypto-js/issues/detail?id=84
   * https://crypto-js.googlecode.com/svn-history/r667/branches/3.x/src/core.js
   *)
  (*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
   *)
  (*! (c) Tom Wu, Kenji Urushima | http://www-cs-students.stanford.edu/~tjw/jsbn/
   *)
  (*! (c) Stefan Thomas | https://github.com/bitcoinjs/bitcoinjs-lib
   *)
  (*! Mike Samuel (c) 2009 | code.google.com/p/json-sans-eval
   *)

queue-microtask/index.js:
  (*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> *)
*//**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */const Ih="177",ka={ROTATE:0,DOLLY:1,PAN:2},Ia={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},EE=0,nf=1,CE=2,vv=1,TE=2,Yr=3,Rs=0,Un=1,Qr=2,ws=0,Ua=1,rf=2,sf=3,af=4,RE=5,Ks=100,ME=101,PE=102,AE=103,DE=104,IE=200,FE=201,NE=202,LE=203,Ru=204,Mu=205,OE=206,kE=207,UE=208,BE=209,HE=210,jE=211,VE=212,zE=213,GE=214,Pu=0,Au=1,Du=2,$a=3,Iu=4,Fu=5,Nu=6,Lu=7,_v=0,qE=1,WE=2,xs=0,KE=1,XE=2,$E=3,ZE=4,YE=5,JE=6,QE=7,bv=300,Za=301,Ya=302,Ou=303,ku=304,Gl=306,Uu=1e3,Ys=1001,Bu=1002,Er=1003,eC=1004,Cc=1005,On=1006,Md=1007,Js=1008,ss=1009,yv=1010,Sv=1011,Go=1012,Fh=1013,ra=1014,es=1015,Jo=1016,Nh=1017,Lh=1018,qo=1020,wv=35902,xv=1021,Oh=1022,Sr=1023,Wo=1026,Ko=1027,Ev=1028,kh=1029,Cv=1030,Uh=1031,Bh=1033,il=33776,nl=33777,rl=33778,sl=33779,Hu=35840,ju=35841,Vu=35842,zu=35843,Gu=36196,qu=37492,Wu=37496,Ku=37808,Xu=37809,$u=37810,Zu=37811,Yu=37812,Ju=37813,Qu=37814,eh=37815,th=37816,ih=37817,nh=37818,rh=37819,sh=37820,ah=37821,al=36492,oh=36494,ch=36495,Tv=36283,lh=36284,dh=36285,uh=36286,tC=3200,iC=3201,nC=0,rC=1,Ss="",nr="srgb",Ja="srgb-linear",Sl="linear",wi="srgb",ma=7680,of=519,sC=512,aC=513,oC=514,Rv=515,cC=516,lC=517,dC=518,uC=519,cf=35044,lf="300 es",ts=2e3,wl=2001;class la{addEventListener(e,i){this._listeners===void 0&&(this._listeners={});const n=this._listeners;n[e]===void 0&&(n[e]=[]),n[e].indexOf(i)===-1&&n[e].push(i)}hasEventListener(e,i){const n=this._listeners;return n===void 0?!1:n[e]!==void 0&&n[e].indexOf(i)!==-1}removeEventListener(e,i){const n=this._listeners;if(n===void 0)return;const r=n[e];if(r!==void 0){const s=r.indexOf(i);s!==-1&&r.splice(s,1)}}dispatchEvent(e){const i=this._listeners;if(i===void 0)return;const n=i[e.type];if(n!==void 0){e.target=this;const r=n.slice(0);for(let s=0,o=r.length;s<o;s++)r[s].call(this,e);e.target=null}}}const fn=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],ol=Math.PI/180,hh=180/Math.PI;function Qo(){const t=Math.random()*4294967295|0,e=Math.random()*4294967295|0,i=Math.random()*4294967295|0,n=Math.random()*4294967295|0;return(fn[t&255]+fn[t>>8&255]+fn[t>>16&255]+fn[t>>24&255]+"-"+fn[e&255]+fn[e>>8&255]+"-"+fn[e>>16&15|64]+fn[e>>24&255]+"-"+fn[i&63|128]+fn[i>>8&255]+"-"+fn[i>>16&255]+fn[i>>24&255]+fn[n&255]+fn[n>>8&255]+fn[n>>16&255]+fn[n>>24&255]).toLowerCase()}function Qt(t,e,i){return Math.max(e,Math.min(i,t))}function hC(t,e){return(t%e+e)%e}function Pd(t,e,i){return(1-i)*t+i*e}function bo(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function Fn(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(t*4294967295);case Uint16Array:return Math.round(t*65535);case Uint8Array:return Math.round(t*255);case Int32Array:return Math.round(t*2147483647);case Int16Array:return Math.round(t*32767);case Int8Array:return Math.round(t*127);default:throw new Error("Invalid component type.")}}const pC={DEG2RAD:ol};class $t{constructor(e=0,i=0){$t.prototype.isVector2=!0,this.x=e,this.y=i}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,i){return this.x=e,this.y=i,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const i=this.x,n=this.y,r=e.elements;return this.x=r[0]*i+r[3]*n+r[6],this.y=r[1]*i+r[4]*n+r[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,i){return this.x=Qt(this.x,e.x,i.x),this.y=Qt(this.y,e.y,i.y),this}clampScalar(e,i){return this.x=Qt(this.x,e,i),this.y=Qt(this.y,e,i),this}clampLength(e,i){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Qt(n,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const i=Math.sqrt(this.lengthSq()*e.lengthSq());if(i===0)return Math.PI/2;const n=this.dot(e)/i;return Math.acos(Qt(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const i=this.x-e.x,n=this.y-e.y;return i*i+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this}lerpVectors(e,i,n){return this.x=e.x+(i.x-e.x)*n,this.y=e.y+(i.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this}rotateAround(e,i){const n=Math.cos(i),r=Math.sin(i),s=this.x-e.x,o=this.y-e.y;return this.x=s*n-o*r+e.x,this.y=s*r+o*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class sa{constructor(e=0,i=0,n=0,r=1){this.isQuaternion=!0,this._x=e,this._y=i,this._z=n,this._w=r}static slerpFlat(e,i,n,r,s,o,c){let h=n[r+0],d=n[r+1],p=n[r+2],v=n[r+3];const g=s[o+0],_=s[o+1],S=s[o+2],E=s[o+3];if(c===0){e[i+0]=h,e[i+1]=d,e[i+2]=p,e[i+3]=v;return}if(c===1){e[i+0]=g,e[i+1]=_,e[i+2]=S,e[i+3]=E;return}if(v!==E||h!==g||d!==_||p!==S){let M=1-c;const R=h*g+d*_+p*S+v*E,N=R>=0?1:-1,b=1-R*R;if(b>Number.EPSILON){const w=Math.sqrt(b),T=Math.atan2(w,R*N);M=Math.sin(M*T)/w,c=Math.sin(c*T)/w}const m=c*N;if(h=h*M+g*m,d=d*M+_*m,p=p*M+S*m,v=v*M+E*m,M===1-c){const w=1/Math.sqrt(h*h+d*d+p*p+v*v);h*=w,d*=w,p*=w,v*=w}}e[i]=h,e[i+1]=d,e[i+2]=p,e[i+3]=v}static multiplyQuaternionsFlat(e,i,n,r,s,o){const c=n[r],h=n[r+1],d=n[r+2],p=n[r+3],v=s[o],g=s[o+1],_=s[o+2],S=s[o+3];return e[i]=c*S+p*v+h*_-d*g,e[i+1]=h*S+p*g+d*v-c*_,e[i+2]=d*S+p*_+c*g-h*v,e[i+3]=p*S-c*v-h*g-d*_,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,i,n,r){return this._x=e,this._y=i,this._z=n,this._w=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,i=!0){const n=e._x,r=e._y,s=e._z,o=e._order,c=Math.cos,h=Math.sin,d=c(n/2),p=c(r/2),v=c(s/2),g=h(n/2),_=h(r/2),S=h(s/2);switch(o){case"XYZ":this._x=g*p*v+d*_*S,this._y=d*_*v-g*p*S,this._z=d*p*S+g*_*v,this._w=d*p*v-g*_*S;break;case"YXZ":this._x=g*p*v+d*_*S,this._y=d*_*v-g*p*S,this._z=d*p*S-g*_*v,this._w=d*p*v+g*_*S;break;case"ZXY":this._x=g*p*v-d*_*S,this._y=d*_*v+g*p*S,this._z=d*p*S+g*_*v,this._w=d*p*v-g*_*S;break;case"ZYX":this._x=g*p*v-d*_*S,this._y=d*_*v+g*p*S,this._z=d*p*S-g*_*v,this._w=d*p*v+g*_*S;break;case"YZX":this._x=g*p*v+d*_*S,this._y=d*_*v+g*p*S,this._z=d*p*S-g*_*v,this._w=d*p*v-g*_*S;break;case"XZY":this._x=g*p*v-d*_*S,this._y=d*_*v-g*p*S,this._z=d*p*S+g*_*v,this._w=d*p*v+g*_*S;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+o)}return i===!0&&this._onChangeCallback(),this}setFromAxisAngle(e,i){const n=i/2,r=Math.sin(n);return this._x=e.x*r,this._y=e.y*r,this._z=e.z*r,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const i=e.elements,n=i[0],r=i[4],s=i[8],o=i[1],c=i[5],h=i[9],d=i[2],p=i[6],v=i[10],g=n+c+v;if(g>0){const _=.5/Math.sqrt(g+1);this._w=.25/_,this._x=(p-h)*_,this._y=(s-d)*_,this._z=(o-r)*_}else if(n>c&&n>v){const _=2*Math.sqrt(1+n-c-v);this._w=(p-h)/_,this._x=.25*_,this._y=(r+o)/_,this._z=(s+d)/_}else if(c>v){const _=2*Math.sqrt(1+c-n-v);this._w=(s-d)/_,this._x=(r+o)/_,this._y=.25*_,this._z=(h+p)/_}else{const _=2*Math.sqrt(1+v-n-c);this._w=(o-r)/_,this._x=(s+d)/_,this._y=(h+p)/_,this._z=.25*_}return this._onChangeCallback(),this}setFromUnitVectors(e,i){let n=e.dot(i)+1;return n<Number.EPSILON?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*i.z-e.z*i.y,this._y=e.z*i.x-e.x*i.z,this._z=e.x*i.y-e.y*i.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Qt(this.dot(e),-1,1)))}rotateTowards(e,i){const n=this.angleTo(e);if(n===0)return this;const r=Math.min(1,i/n);return this.slerp(e,r),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return e===0?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,i){const n=e._x,r=e._y,s=e._z,o=e._w,c=i._x,h=i._y,d=i._z,p=i._w;return this._x=n*p+o*c+r*d-s*h,this._y=r*p+o*h+s*c-n*d,this._z=s*p+o*d+n*h-r*c,this._w=o*p-n*c-r*h-s*d,this._onChangeCallback(),this}slerp(e,i){if(i===0)return this;if(i===1)return this.copy(e);const n=this._x,r=this._y,s=this._z,o=this._w;let c=o*e._w+n*e._x+r*e._y+s*e._z;if(c<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,c=-c):this.copy(e),c>=1)return this._w=o,this._x=n,this._y=r,this._z=s,this;const h=1-c*c;if(h<=Number.EPSILON){const _=1-i;return this._w=_*o+i*this._w,this._x=_*n+i*this._x,this._y=_*r+i*this._y,this._z=_*s+i*this._z,this.normalize(),this}const d=Math.sqrt(h),p=Math.atan2(d,c),v=Math.sin((1-i)*p)/d,g=Math.sin(i*p)/d;return this._w=o*v+this._w*g,this._x=n*v+this._x*g,this._y=r*v+this._y*g,this._z=s*v+this._z*g,this._onChangeCallback(),this}slerpQuaternions(e,i,n){return this.copy(e).slerp(i,n)}random(){const e=2*Math.PI*Math.random(),i=2*Math.PI*Math.random(),n=Math.random(),r=Math.sqrt(1-n),s=Math.sqrt(n);return this.set(r*Math.sin(e),r*Math.cos(e),s*Math.sin(i),s*Math.cos(i))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,i=0){return this._x=e[i],this._y=e[i+1],this._z=e[i+2],this._w=e[i+3],this._onChangeCallback(),this}toArray(e=[],i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,e[i+3]=this._w,e}fromBufferAttribute(e,i){return this._x=e.getX(i),this._y=e.getY(i),this._z=e.getZ(i),this._w=e.getW(i),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class Ae{constructor(e=0,i=0,n=0){Ae.prototype.isVector3=!0,this.x=e,this.y=i,this.z=n}set(e,i,n){return n===void 0&&(n=this.z),this.x=e,this.y=i,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;case 2:this.z=i;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this.z=e.z+i.z,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this.z+=e.z*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this.z=e.z-i.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,i){return this.x=e.x*i.x,this.y=e.y*i.y,this.z=e.z*i.z,this}applyEuler(e){return this.applyQuaternion(df.setFromEuler(e))}applyAxisAngle(e,i){return this.applyQuaternion(df.setFromAxisAngle(e,i))}applyMatrix3(e){const i=this.x,n=this.y,r=this.z,s=e.elements;return this.x=s[0]*i+s[3]*n+s[6]*r,this.y=s[1]*i+s[4]*n+s[7]*r,this.z=s[2]*i+s[5]*n+s[8]*r,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const i=this.x,n=this.y,r=this.z,s=e.elements,o=1/(s[3]*i+s[7]*n+s[11]*r+s[15]);return this.x=(s[0]*i+s[4]*n+s[8]*r+s[12])*o,this.y=(s[1]*i+s[5]*n+s[9]*r+s[13])*o,this.z=(s[2]*i+s[6]*n+s[10]*r+s[14])*o,this}applyQuaternion(e){const i=this.x,n=this.y,r=this.z,s=e.x,o=e.y,c=e.z,h=e.w,d=2*(o*r-c*n),p=2*(c*i-s*r),v=2*(s*n-o*i);return this.x=i+h*d+o*v-c*p,this.y=n+h*p+c*d-s*v,this.z=r+h*v+s*p-o*d,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const i=this.x,n=this.y,r=this.z,s=e.elements;return this.x=s[0]*i+s[4]*n+s[8]*r,this.y=s[1]*i+s[5]*n+s[9]*r,this.z=s[2]*i+s[6]*n+s[10]*r,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,i){return this.x=Qt(this.x,e.x,i.x),this.y=Qt(this.y,e.y,i.y),this.z=Qt(this.z,e.z,i.z),this}clampScalar(e,i){return this.x=Qt(this.x,e,i),this.y=Qt(this.y,e,i),this.z=Qt(this.z,e,i),this}clampLength(e,i){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Qt(n,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this.z+=(e.z-this.z)*i,this}lerpVectors(e,i,n){return this.x=e.x+(i.x-e.x)*n,this.y=e.y+(i.y-e.y)*n,this.z=e.z+(i.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,i){const n=e.x,r=e.y,s=e.z,o=i.x,c=i.y,h=i.z;return this.x=r*h-s*c,this.y=s*o-n*h,this.z=n*c-r*o,this}projectOnVector(e){const i=e.lengthSq();if(i===0)return this.set(0,0,0);const n=e.dot(this)/i;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return Ad.copy(this).projectOnVector(e),this.sub(Ad)}reflect(e){return this.sub(Ad.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const i=Math.sqrt(this.lengthSq()*e.lengthSq());if(i===0)return Math.PI/2;const n=this.dot(e)/i;return Math.acos(Qt(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const i=this.x-e.x,n=this.y-e.y,r=this.z-e.z;return i*i+n*n+r*r}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,i,n){const r=Math.sin(i)*e;return this.x=r*Math.sin(n),this.y=Math.cos(i)*e,this.z=r*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,i,n){return this.x=e*Math.sin(i),this.y=n,this.z=e*Math.cos(i),this}setFromMatrixPosition(e){const i=e.elements;return this.x=i[12],this.y=i[13],this.z=i[14],this}setFromMatrixScale(e){const i=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),r=this.setFromMatrixColumn(e,2).length();return this.x=i,this.y=n,this.z=r,this}setFromMatrixColumn(e,i){return this.fromArray(e.elements,i*4)}setFromMatrix3Column(e,i){return this.fromArray(e.elements,i*3)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this.z=e[i+2],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e[i+2]=this.z,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this.z=e.getZ(i),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,i=Math.random()*2-1,n=Math.sqrt(1-i*i);return this.x=n*Math.cos(e),this.y=i,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const Ad=new Ae,df=new sa;class qt{constructor(e,i,n,r,s,o,c,h,d){qt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],e!==void 0&&this.set(e,i,n,r,s,o,c,h,d)}set(e,i,n,r,s,o,c,h,d){const p=this.elements;return p[0]=e,p[1]=r,p[2]=c,p[3]=i,p[4]=s,p[5]=h,p[6]=n,p[7]=o,p[8]=d,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const i=this.elements,n=e.elements;return i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],this}extractBasis(e,i,n){return e.setFromMatrix3Column(this,0),i.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const i=e.elements;return this.set(i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,i){const n=e.elements,r=i.elements,s=this.elements,o=n[0],c=n[3],h=n[6],d=n[1],p=n[4],v=n[7],g=n[2],_=n[5],S=n[8],E=r[0],M=r[3],R=r[6],N=r[1],b=r[4],m=r[7],w=r[2],T=r[5],P=r[8];return s[0]=o*E+c*N+h*w,s[3]=o*M+c*b+h*T,s[6]=o*R+c*m+h*P,s[1]=d*E+p*N+v*w,s[4]=d*M+p*b+v*T,s[7]=d*R+p*m+v*P,s[2]=g*E+_*N+S*w,s[5]=g*M+_*b+S*T,s[8]=g*R+_*m+S*P,this}multiplyScalar(e){const i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=e,i[4]*=e,i[7]*=e,i[2]*=e,i[5]*=e,i[8]*=e,this}determinant(){const e=this.elements,i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],c=e[5],h=e[6],d=e[7],p=e[8];return i*o*p-i*c*d-n*s*p+n*c*h+r*s*d-r*o*h}invert(){const e=this.elements,i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],c=e[5],h=e[6],d=e[7],p=e[8],v=p*o-c*d,g=c*h-p*s,_=d*s-o*h,S=i*v+n*g+r*_;if(S===0)return this.set(0,0,0,0,0,0,0,0,0);const E=1/S;return e[0]=v*E,e[1]=(r*d-p*n)*E,e[2]=(c*n-r*o)*E,e[3]=g*E,e[4]=(p*i-r*h)*E,e[5]=(r*s-c*i)*E,e[6]=_*E,e[7]=(n*h-d*i)*E,e[8]=(o*i-n*s)*E,this}transpose(){let e;const i=this.elements;return e=i[1],i[1]=i[3],i[3]=e,e=i[2],i[2]=i[6],i[6]=e,e=i[5],i[5]=i[7],i[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const i=this.elements;return e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8],this}setUvTransform(e,i,n,r,s,o,c){const h=Math.cos(s),d=Math.sin(s);return this.set(n*h,n*d,-n*(h*o+d*c)+o+e,-r*d,r*h,-r*(-d*o+h*c)+c+i,0,0,1),this}scale(e,i){return this.premultiply(Dd.makeScale(e,i)),this}rotate(e){return this.premultiply(Dd.makeRotation(-e)),this}translate(e,i){return this.premultiply(Dd.makeTranslation(e,i)),this}makeTranslation(e,i){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,i,0,0,1),this}makeRotation(e){const i=Math.cos(e),n=Math.sin(e);return this.set(i,-n,0,n,i,0,0,0,1),this}makeScale(e,i){return this.set(e,0,0,0,i,0,0,0,1),this}equals(e){const i=this.elements,n=e.elements;for(let r=0;r<9;r++)if(i[r]!==n[r])return!1;return!0}fromArray(e,i=0){for(let n=0;n<9;n++)this.elements[n]=e[n+i];return this}toArray(e=[],i=0){const n=this.elements;return e[i]=n[0],e[i+1]=n[1],e[i+2]=n[2],e[i+3]=n[3],e[i+4]=n[4],e[i+5]=n[5],e[i+6]=n[6],e[i+7]=n[7],e[i+8]=n[8],e}clone(){return new this.constructor().fromArray(this.elements)}}const Dd=new qt;function Mv(t){for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;return!1}function xl(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}function fC(){const t=xl("canvas");return t.style.display="block",t}const uf={};function Ba(t){t in uf||(uf[t]=!0,console.warn(t))}function mC(t,e,i){return new Promise(function(n,r){function s(){switch(t.clientWaitSync(e,t.SYNC_FLUSH_COMMANDS_BIT,0)){case t.WAIT_FAILED:r();break;case t.TIMEOUT_EXPIRED:setTimeout(s,i);break;default:n()}}setTimeout(s,i)})}function gC(t){const e=t.elements;e[2]=.5*e[2]+.5*e[3],e[6]=.5*e[6]+.5*e[7],e[10]=.5*e[10]+.5*e[11],e[14]=.5*e[14]+.5*e[15]}function vC(t){const e=t.elements;e[11]===-1?(e[10]=-e[10]-1,e[14]=-e[14]):(e[10]=-e[10],e[14]=-e[14]+1)}const hf=new qt().set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),pf=new qt().set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function _C(){const t={enabled:!0,workingColorSpace:Ja,spaces:{},convert:function(r,s,o){return this.enabled===!1||s===o||!s||!o||(this.spaces[s].transfer===wi&&(r.r=is(r.r),r.g=is(r.g),r.b=is(r.b)),this.spaces[s].primaries!==this.spaces[o].primaries&&(r.applyMatrix3(this.spaces[s].toXYZ),r.applyMatrix3(this.spaces[o].fromXYZ)),this.spaces[o].transfer===wi&&(r.r=Ha(r.r),r.g=Ha(r.g),r.b=Ha(r.b))),r},workingToColorSpace:function(r,s){return this.convert(r,this.workingColorSpace,s)},colorSpaceToWorking:function(r,s){return this.convert(r,s,this.workingColorSpace)},getPrimaries:function(r){return this.spaces[r].primaries},getTransfer:function(r){return r===Ss?Sl:this.spaces[r].transfer},getLuminanceCoefficients:function(r,s=this.workingColorSpace){return r.fromArray(this.spaces[s].luminanceCoefficients)},define:function(r){Object.assign(this.spaces,r)},_getMatrix:function(r,s,o){return r.copy(this.spaces[s].toXYZ).multiply(this.spaces[o].fromXYZ)},_getDrawingBufferColorSpace:function(r){return this.spaces[r].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(r=this.workingColorSpace){return this.spaces[r].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(r,s){return Ba("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),t.workingToColorSpace(r,s)},toWorkingColorSpace:function(r,s){return Ba("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),t.colorSpaceToWorking(r,s)}},e=[.64,.33,.3,.6,.15,.06],i=[.2126,.7152,.0722],n=[.3127,.329];return t.define({[Ja]:{primaries:e,whitePoint:n,transfer:Sl,toXYZ:hf,fromXYZ:pf,luminanceCoefficients:i,workingColorSpaceConfig:{unpackColorSpace:nr},outputColorSpaceConfig:{drawingBufferColorSpace:nr}},[nr]:{primaries:e,whitePoint:n,transfer:wi,toXYZ:hf,fromXYZ:pf,luminanceCoefficients:i,outputColorSpaceConfig:{drawingBufferColorSpace:nr}}}),t}const ci=_C();function is(t){return t<.04045?t*.0773993808:Math.pow(t*.9478672986+.0521327014,2.4)}function Ha(t){return t<.0031308?t*12.92:1.055*Math.pow(t,.41666)-.055}let ga;class bC{static getDataURL(e,i="image/png"){if(/^data:/i.test(e.src)||typeof HTMLCanvasElement>"u")return e.src;let n;if(e instanceof HTMLCanvasElement)n=e;else{ga===void 0&&(ga=xl("canvas")),ga.width=e.width,ga.height=e.height;const r=ga.getContext("2d");e instanceof ImageData?r.putImageData(e,0,0):r.drawImage(e,0,0,e.width,e.height),n=ga}return n.toDataURL(i)}static sRGBToLinear(e){if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap){const i=xl("canvas");i.width=e.width,i.height=e.height;const n=i.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const r=n.getImageData(0,0,e.width,e.height),s=r.data;for(let o=0;o<s.length;o++)s[o]=is(s[o]/255)*255;return n.putImageData(r,0,0),i}else if(e.data){const i=e.data.slice(0);for(let n=0;n<i.length;n++)i instanceof Uint8Array||i instanceof Uint8ClampedArray?i[n]=Math.floor(is(i[n]/255)*255):i[n]=is(i[n]);return{data:i,width:e.width,height:e.height}}else return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let yC=0;class Hh{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:yC++}),this.uuid=Qo(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const i=this.data;return i instanceof HTMLVideoElement?e.set(i.videoWidth,i.videoHeight):i!==null?e.set(i.width,i.height,i.depth||0):e.set(0,0,0),e}set needsUpdate(e){e===!0&&this.version++}toJSON(e){const i=e===void 0||typeof e=="string";if(!i&&e.images[this.uuid]!==void 0)return e.images[this.uuid];const n={uuid:this.uuid,url:""},r=this.data;if(r!==null){let s;if(Array.isArray(r)){s=[];for(let o=0,c=r.length;o<c;o++)r[o].isDataTexture?s.push(Id(r[o].image)):s.push(Id(r[o]))}else s=Id(r);n.url=s}return i||(e.images[this.uuid]=n),n}}function Id(t){return typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap?bC.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let SC=0;const Fd=new Ae;class Tn extends la{constructor(e=Tn.DEFAULT_IMAGE,i=Tn.DEFAULT_MAPPING,n=Ys,r=Ys,s=On,o=Js,c=Sr,h=ss,d=Tn.DEFAULT_ANISOTROPY,p=Ss){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:SC++}),this.uuid=Qo(),this.name="",this.source=new Hh(e),this.mipmaps=[],this.mapping=i,this.channel=0,this.wrapS=n,this.wrapT=r,this.magFilter=s,this.minFilter=o,this.anisotropy=d,this.format=c,this.internalFormat=null,this.type=h,this.offset=new $t(0,0),this.repeat=new $t(1,1),this.center=new $t(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new qt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=p,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(e&&e.depth&&e.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(Fd).x}get height(){return this.source.getSize(Fd).y}get depth(){return this.source.getSize(Fd).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const i in e){const n=e[i];if(n===void 0){console.warn(`THREE.Texture.setValues(): parameter '${i}' has value of undefined.`);continue}const r=this[i];if(r===void 0){console.warn(`THREE.Texture.setValues(): property '${i}' does not exist.`);continue}r&&n&&r.isVector2&&n.isVector2||r&&n&&r.isVector3&&n.isVector3||r&&n&&r.isMatrix3&&n.isMatrix3?r.copy(n):this[i]=n}}toJSON(e){const i=e===void 0||typeof e=="string";if(!i&&e.textures[this.uuid]!==void 0)return e.textures[this.uuid];const n={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),i||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==bv)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Uu:e.x=e.x-Math.floor(e.x);break;case Ys:e.x=e.x<0?0:1;break;case Bu:Math.abs(Math.floor(e.x)%2)===1?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x);break}if(e.y<0||e.y>1)switch(this.wrapT){case Uu:e.y=e.y-Math.floor(e.y);break;case Ys:e.y=e.y<0?0:1;break;case Bu:Math.abs(Math.floor(e.y)%2)===1?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y);break}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){e===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){e===!0&&this.pmremVersion++}}Tn.DEFAULT_IMAGE=null;Tn.DEFAULT_MAPPING=bv;Tn.DEFAULT_ANISOTROPY=1;class ji{constructor(e=0,i=0,n=0,r=1){ji.prototype.isVector4=!0,this.x=e,this.y=i,this.z=n,this.w=r}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,i,n,r){return this.x=e,this.y=i,this.z=n,this.w=r,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,i){switch(e){case 0:this.x=i;break;case 1:this.y=i;break;case 2:this.z=i;break;case 3:this.w=i;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==void 0?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,i){return this.x=e.x+i.x,this.y=e.y+i.y,this.z=e.z+i.z,this.w=e.w+i.w,this}addScaledVector(e,i){return this.x+=e.x*i,this.y+=e.y*i,this.z+=e.z*i,this.w+=e.w*i,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,i){return this.x=e.x-i.x,this.y=e.y-i.y,this.z=e.z-i.z,this.w=e.w-i.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const i=this.x,n=this.y,r=this.z,s=this.w,o=e.elements;return this.x=o[0]*i+o[4]*n+o[8]*r+o[12]*s,this.y=o[1]*i+o[5]*n+o[9]*r+o[13]*s,this.z=o[2]*i+o[6]*n+o[10]*r+o[14]*s,this.w=o[3]*i+o[7]*n+o[11]*r+o[15]*s,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const i=Math.sqrt(1-e.w*e.w);return i<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/i,this.y=e.y/i,this.z=e.z/i),this}setAxisAngleFromRotationMatrix(e){let i,n,r,s;const h=e.elements,d=h[0],p=h[4],v=h[8],g=h[1],_=h[5],S=h[9],E=h[2],M=h[6],R=h[10];if(Math.abs(p-g)<.01&&Math.abs(v-E)<.01&&Math.abs(S-M)<.01){if(Math.abs(p+g)<.1&&Math.abs(v+E)<.1&&Math.abs(S+M)<.1&&Math.abs(d+_+R-3)<.1)return this.set(1,0,0,0),this;i=Math.PI;const b=(d+1)/2,m=(_+1)/2,w=(R+1)/2,T=(p+g)/4,P=(v+E)/4,L=(S+M)/4;return b>m&&b>w?b<.01?(n=0,r=.707106781,s=.707106781):(n=Math.sqrt(b),r=T/n,s=P/n):m>w?m<.01?(n=.707106781,r=0,s=.707106781):(r=Math.sqrt(m),n=T/r,s=L/r):w<.01?(n=.707106781,r=.707106781,s=0):(s=Math.sqrt(w),n=P/s,r=L/s),this.set(n,r,s,i),this}let N=Math.sqrt((M-S)*(M-S)+(v-E)*(v-E)+(g-p)*(g-p));return Math.abs(N)<.001&&(N=1),this.x=(M-S)/N,this.y=(v-E)/N,this.z=(g-p)/N,this.w=Math.acos((d+_+R-1)/2),this}setFromMatrixPosition(e){const i=e.elements;return this.x=i[12],this.y=i[13],this.z=i[14],this.w=i[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,i){return this.x=Qt(this.x,e.x,i.x),this.y=Qt(this.y,e.y,i.y),this.z=Qt(this.z,e.z,i.z),this.w=Qt(this.w,e.w,i.w),this}clampScalar(e,i){return this.x=Qt(this.x,e,i),this.y=Qt(this.y,e,i),this.z=Qt(this.z,e,i),this.w=Qt(this.w,e,i),this}clampLength(e,i){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Qt(n,e,i))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,i){return this.x+=(e.x-this.x)*i,this.y+=(e.y-this.y)*i,this.z+=(e.z-this.z)*i,this.w+=(e.w-this.w)*i,this}lerpVectors(e,i,n){return this.x=e.x+(i.x-e.x)*n,this.y=e.y+(i.y-e.y)*n,this.z=e.z+(i.z-e.z)*n,this.w=e.w+(i.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,i=0){return this.x=e[i],this.y=e[i+1],this.z=e[i+2],this.w=e[i+3],this}toArray(e=[],i=0){return e[i]=this.x,e[i+1]=this.y,e[i+2]=this.z,e[i+3]=this.w,e}fromBufferAttribute(e,i){return this.x=e.getX(i),this.y=e.getY(i),this.z=e.getZ(i),this.w=e.getW(i),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class wC extends la{constructor(e=1,i=1,n={}){super(),n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:On,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},n),this.isRenderTarget=!0,this.width=e,this.height=i,this.depth=n.depth,this.scissor=new ji(0,0,e,i),this.scissorTest=!1,this.viewport=new ji(0,0,e,i);const r={width:e,height:i,depth:n.depth},s=new Tn(r);this.textures=[];const o=n.count;for(let c=0;c<o;c++)this.textures[c]=s.clone(),this.textures[c].isRenderTargetTexture=!0,this.textures[c].renderTarget=this;this._setTextureOptions(n),this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.resolveDepthBuffer=n.resolveDepthBuffer,this.resolveStencilBuffer=n.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=n.depthTexture,this.samples=n.samples,this.multiview=n.multiview}_setTextureOptions(e={}){const i={minFilter:On,generateMipmaps:!1,flipY:!1,internalFormat:null};e.mapping!==void 0&&(i.mapping=e.mapping),e.wrapS!==void 0&&(i.wrapS=e.wrapS),e.wrapT!==void 0&&(i.wrapT=e.wrapT),e.wrapR!==void 0&&(i.wrapR=e.wrapR),e.magFilter!==void 0&&(i.magFilter=e.magFilter),e.minFilter!==void 0&&(i.minFilter=e.minFilter),e.format!==void 0&&(i.format=e.format),e.type!==void 0&&(i.type=e.type),e.anisotropy!==void 0&&(i.anisotropy=e.anisotropy),e.colorSpace!==void 0&&(i.colorSpace=e.colorSpace),e.flipY!==void 0&&(i.flipY=e.flipY),e.generateMipmaps!==void 0&&(i.generateMipmaps=e.generateMipmaps),e.internalFormat!==void 0&&(i.internalFormat=e.internalFormat);for(let n=0;n<this.textures.length;n++)this.textures[n].setValues(i)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){this._depthTexture!==null&&(this._depthTexture.renderTarget=null),e!==null&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,i,n=1){if(this.width!==e||this.height!==i||this.depth!==n){this.width=e,this.height=i,this.depth=n;for(let r=0,s=this.textures.length;r<s;r++)this.textures[r].image.width=e,this.textures[r].image.height=i,this.textures[r].image.depth=n,this.textures[r].isArrayTexture=this.textures[r].image.depth>1;this.dispose()}this.viewport.set(0,0,e,i),this.scissor.set(0,0,e,i)}clone(){return new this.constructor().copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let i=0,n=e.textures.length;i<n;i++){this.textures[i]=e.textures[i].clone(),this.textures[i].isRenderTargetTexture=!0,this.textures[i].renderTarget=this;const r=Object.assign({},e.textures[i].image);this.textures[i].source=new Hh(r)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,e.depthTexture!==null&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class aa extends wC{constructor(e=1,i=1,n={}){super(e,i,n),this.isWebGLRenderTarget=!0}}class Pv extends Tn{constructor(e=null,i=1,n=1,r=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:i,height:n,depth:r},this.magFilter=Er,this.minFilter=Er,this.wrapR=Ys,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class xC extends Tn{constructor(e=null,i=1,n=1,r=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:i,height:n,depth:r},this.magFilter=Er,this.minFilter=Er,this.wrapR=Ys,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class ec{constructor(e=new Ae(1/0,1/0,1/0),i=new Ae(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=i}set(e,i){return this.min.copy(e),this.max.copy(i),this}setFromArray(e){this.makeEmpty();for(let i=0,n=e.length;i<n;i+=3)this.expandByPoint(fr.fromArray(e,i));return this}setFromBufferAttribute(e){this.makeEmpty();for(let i=0,n=e.count;i<n;i++)this.expandByPoint(fr.fromBufferAttribute(e,i));return this}setFromPoints(e){this.makeEmpty();for(let i=0,n=e.length;i<n;i++)this.expandByPoint(e[i]);return this}setFromCenterAndSize(e,i){const n=fr.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,i=!1){return this.makeEmpty(),this.expandByObject(e,i)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,i=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(n!==void 0){const s=n.getAttribute("position");if(i===!0&&s!==void 0&&e.isInstancedMesh!==!0)for(let o=0,c=s.count;o<c;o++)e.isMesh===!0?e.getVertexPosition(o,fr):fr.fromBufferAttribute(s,o),fr.applyMatrix4(e.matrixWorld),this.expandByPoint(fr);else e.boundingBox!==void 0?(e.boundingBox===null&&e.computeBoundingBox(),Tc.copy(e.boundingBox)):(n.boundingBox===null&&n.computeBoundingBox(),Tc.copy(n.boundingBox)),Tc.applyMatrix4(e.matrixWorld),this.union(Tc)}const r=e.children;for(let s=0,o=r.length;s<o;s++)this.expandByObject(r[s],i);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,i){return i.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,fr),fr.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let i,n;return e.normal.x>0?(i=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(i=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(i+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(i+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(i+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(i+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),i<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(yo),Rc.subVectors(this.max,yo),va.subVectors(e.a,yo),_a.subVectors(e.b,yo),ba.subVectors(e.c,yo),hs.subVectors(_a,va),ps.subVectors(ba,_a),Us.subVectors(va,ba);let i=[0,-hs.z,hs.y,0,-ps.z,ps.y,0,-Us.z,Us.y,hs.z,0,-hs.x,ps.z,0,-ps.x,Us.z,0,-Us.x,-hs.y,hs.x,0,-ps.y,ps.x,0,-Us.y,Us.x,0];return!Nd(i,va,_a,ba,Rc)||(i=[1,0,0,0,1,0,0,0,1],!Nd(i,va,_a,ba,Rc))?!1:(Mc.crossVectors(hs,ps),i=[Mc.x,Mc.y,Mc.z],Nd(i,va,_a,ba,Rc))}clampPoint(e,i){return i.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,fr).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=this.getSize(fr).length()*.5),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()?this:(qr[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),qr[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),qr[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),qr[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),qr[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),qr[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),qr[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),qr[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(qr),this)}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}const qr=[new Ae,new Ae,new Ae,new Ae,new Ae,new Ae,new Ae,new Ae],fr=new Ae,Tc=new ec,va=new Ae,_a=new Ae,ba=new Ae,hs=new Ae,ps=new Ae,Us=new Ae,yo=new Ae,Rc=new Ae,Mc=new Ae,Bs=new Ae;function Nd(t,e,i,n,r){for(let s=0,o=t.length-3;s<=o;s+=3){Bs.fromArray(t,s);const c=r.x*Math.abs(Bs.x)+r.y*Math.abs(Bs.y)+r.z*Math.abs(Bs.z),h=e.dot(Bs),d=i.dot(Bs),p=n.dot(Bs);if(Math.max(-Math.max(h,d,p),Math.min(h,d,p))>c)return!1}return!0}const EC=new ec,So=new Ae,Ld=new Ae;class jh{constructor(e=new Ae,i=-1){this.isSphere=!0,this.center=e,this.radius=i}set(e,i){return this.center.copy(e),this.radius=i,this}setFromPoints(e,i){const n=this.center;i!==void 0?n.copy(i):EC.setFromPoints(e).getCenter(n);let r=0;for(let s=0,o=e.length;s<o;s++)r=Math.max(r,n.distanceToSquared(e[s]));return this.radius=Math.sqrt(r),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const i=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=i*i}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,i){const n=this.center.distanceToSquared(e);return i.copy(e),n>this.radius*this.radius&&(i.sub(this.center).normalize(),i.multiplyScalar(this.radius).add(this.center)),i}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;So.subVectors(e,this.center);const i=So.lengthSq();if(i>this.radius*this.radius){const n=Math.sqrt(i),r=(n-this.radius)*.5;this.center.addScaledVector(So,r/n),this.radius+=r}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(this.center.equals(e.center)===!0?this.radius=Math.max(this.radius,e.radius):(Ld.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(So.copy(e.center).add(Ld)),this.expandByPoint(So.copy(e.center).sub(Ld))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}const Wr=new Ae,Od=new Ae,Pc=new Ae,fs=new Ae,kd=new Ae,Ac=new Ae,Ud=new Ae;class Av{constructor(e=new Ae,i=new Ae(0,0,-1)){this.origin=e,this.direction=i}set(e,i){return this.origin.copy(e),this.direction.copy(i),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,i){return i.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Wr)),this}closestPointToPoint(e,i){i.subVectors(e,this.origin);const n=i.dot(this.direction);return n<0?i.copy(this.origin):i.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const i=Wr.subVectors(e,this.origin).dot(this.direction);return i<0?this.origin.distanceToSquared(e):(Wr.copy(this.origin).addScaledVector(this.direction,i),Wr.distanceToSquared(e))}distanceSqToSegment(e,i,n,r){Od.copy(e).add(i).multiplyScalar(.5),Pc.copy(i).sub(e).normalize(),fs.copy(this.origin).sub(Od);const s=e.distanceTo(i)*.5,o=-this.direction.dot(Pc),c=fs.dot(this.direction),h=-fs.dot(Pc),d=fs.lengthSq(),p=Math.abs(1-o*o);let v,g,_,S;if(p>0)if(v=o*h-c,g=o*c-h,S=s*p,v>=0)if(g>=-S)if(g<=S){const E=1/p;v*=E,g*=E,_=v*(v+o*g+2*c)+g*(o*v+g+2*h)+d}else g=s,v=Math.max(0,-(o*g+c)),_=-v*v+g*(g+2*h)+d;else g=-s,v=Math.max(0,-(o*g+c)),_=-v*v+g*(g+2*h)+d;else g<=-S?(v=Math.max(0,-(-o*s+c)),g=v>0?-s:Math.min(Math.max(-s,-h),s),_=-v*v+g*(g+2*h)+d):g<=S?(v=0,g=Math.min(Math.max(-s,-h),s),_=g*(g+2*h)+d):(v=Math.max(0,-(o*s+c)),g=v>0?s:Math.min(Math.max(-s,-h),s),_=-v*v+g*(g+2*h)+d);else g=o>0?-s:s,v=Math.max(0,-(o*g+c)),_=-v*v+g*(g+2*h)+d;return n&&n.copy(this.origin).addScaledVector(this.direction,v),r&&r.copy(Od).addScaledVector(Pc,g),_}intersectSphere(e,i){Wr.subVectors(e.center,this.origin);const n=Wr.dot(this.direction),r=Wr.dot(Wr)-n*n,s=e.radius*e.radius;if(r>s)return null;const o=Math.sqrt(s-r),c=n-o,h=n+o;return h<0?null:c<0?this.at(h,i):this.at(c,i)}intersectsSphere(e){return e.radius<0?!1:this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const i=e.normal.dot(this.direction);if(i===0)return e.distanceToPoint(this.origin)===0?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/i;return n>=0?n:null}intersectPlane(e,i){const n=this.distanceToPlane(e);return n===null?null:this.at(n,i)}intersectsPlane(e){const i=e.distanceToPoint(this.origin);return i===0||e.normal.dot(this.direction)*i<0}intersectBox(e,i){let n,r,s,o,c,h;const d=1/this.direction.x,p=1/this.direction.y,v=1/this.direction.z,g=this.origin;return d>=0?(n=(e.min.x-g.x)*d,r=(e.max.x-g.x)*d):(n=(e.max.x-g.x)*d,r=(e.min.x-g.x)*d),p>=0?(s=(e.min.y-g.y)*p,o=(e.max.y-g.y)*p):(s=(e.max.y-g.y)*p,o=(e.min.y-g.y)*p),n>o||s>r||((s>n||isNaN(n))&&(n=s),(o<r||isNaN(r))&&(r=o),v>=0?(c=(e.min.z-g.z)*v,h=(e.max.z-g.z)*v):(c=(e.max.z-g.z)*v,h=(e.min.z-g.z)*v),n>h||c>r)||((c>n||n!==n)&&(n=c),(h<r||r!==r)&&(r=h),r<0)?null:this.at(n>=0?n:r,i)}intersectsBox(e){return this.intersectBox(e,Wr)!==null}intersectTriangle(e,i,n,r,s){kd.subVectors(i,e),Ac.subVectors(n,e),Ud.crossVectors(kd,Ac);let o=this.direction.dot(Ud),c;if(o>0){if(r)return null;c=1}else if(o<0)c=-1,o=-o;else return null;fs.subVectors(this.origin,e);const h=c*this.direction.dot(Ac.crossVectors(fs,Ac));if(h<0)return null;const d=c*this.direction.dot(kd.cross(fs));if(d<0||h+d>o)return null;const p=-c*fs.dot(Ud);return p<0?null:this.at(p/o,s)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class Wi{constructor(e,i,n,r,s,o,c,h,d,p,v,g,_,S,E,M){Wi.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e!==void 0&&this.set(e,i,n,r,s,o,c,h,d,p,v,g,_,S,E,M)}set(e,i,n,r,s,o,c,h,d,p,v,g,_,S,E,M){const R=this.elements;return R[0]=e,R[4]=i,R[8]=n,R[12]=r,R[1]=s,R[5]=o,R[9]=c,R[13]=h,R[2]=d,R[6]=p,R[10]=v,R[14]=g,R[3]=_,R[7]=S,R[11]=E,R[15]=M,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new Wi().fromArray(this.elements)}copy(e){const i=this.elements,n=e.elements;return i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3],i[4]=n[4],i[5]=n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8],i[9]=n[9],i[10]=n[10],i[11]=n[11],i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],this}copyPosition(e){const i=this.elements,n=e.elements;return i[12]=n[12],i[13]=n[13],i[14]=n[14],this}setFromMatrix3(e){const i=e.elements;return this.set(i[0],i[3],i[6],0,i[1],i[4],i[7],0,i[2],i[5],i[8],0,0,0,0,1),this}extractBasis(e,i,n){return e.setFromMatrixColumn(this,0),i.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,i,n){return this.set(e.x,i.x,n.x,0,e.y,i.y,n.y,0,e.z,i.z,n.z,0,0,0,0,1),this}extractRotation(e){const i=this.elements,n=e.elements,r=1/ya.setFromMatrixColumn(e,0).length(),s=1/ya.setFromMatrixColumn(e,1).length(),o=1/ya.setFromMatrixColumn(e,2).length();return i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[3]=0,i[4]=n[4]*s,i[5]=n[5]*s,i[6]=n[6]*s,i[7]=0,i[8]=n[8]*o,i[9]=n[9]*o,i[10]=n[10]*o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}makeRotationFromEuler(e){const i=this.elements,n=e.x,r=e.y,s=e.z,o=Math.cos(n),c=Math.sin(n),h=Math.cos(r),d=Math.sin(r),p=Math.cos(s),v=Math.sin(s);if(e.order==="XYZ"){const g=o*p,_=o*v,S=c*p,E=c*v;i[0]=h*p,i[4]=-h*v,i[8]=d,i[1]=_+S*d,i[5]=g-E*d,i[9]=-c*h,i[2]=E-g*d,i[6]=S+_*d,i[10]=o*h}else if(e.order==="YXZ"){const g=h*p,_=h*v,S=d*p,E=d*v;i[0]=g+E*c,i[4]=S*c-_,i[8]=o*d,i[1]=o*v,i[5]=o*p,i[9]=-c,i[2]=_*c-S,i[6]=E+g*c,i[10]=o*h}else if(e.order==="ZXY"){const g=h*p,_=h*v,S=d*p,E=d*v;i[0]=g-E*c,i[4]=-o*v,i[8]=S+_*c,i[1]=_+S*c,i[5]=o*p,i[9]=E-g*c,i[2]=-o*d,i[6]=c,i[10]=o*h}else if(e.order==="ZYX"){const g=o*p,_=o*v,S=c*p,E=c*v;i[0]=h*p,i[4]=S*d-_,i[8]=g*d+E,i[1]=h*v,i[5]=E*d+g,i[9]=_*d-S,i[2]=-d,i[6]=c*h,i[10]=o*h}else if(e.order==="YZX"){const g=o*h,_=o*d,S=c*h,E=c*d;i[0]=h*p,i[4]=E-g*v,i[8]=S*v+_,i[1]=v,i[5]=o*p,i[9]=-c*p,i[2]=-d*p,i[6]=_*v+S,i[10]=g-E*v}else if(e.order==="XZY"){const g=o*h,_=o*d,S=c*h,E=c*d;i[0]=h*p,i[4]=-v,i[8]=d*p,i[1]=g*v+E,i[5]=o*p,i[9]=_*v-S,i[2]=S*v-_,i[6]=c*p,i[10]=E*v+g}return i[3]=0,i[7]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}makeRotationFromQuaternion(e){return this.compose(CC,e,TC)}lookAt(e,i,n){const r=this.elements;return qn.subVectors(e,i),qn.lengthSq()===0&&(qn.z=1),qn.normalize(),ms.crossVectors(n,qn),ms.lengthSq()===0&&(Math.abs(n.z)===1?qn.x+=1e-4:qn.z+=1e-4,qn.normalize(),ms.crossVectors(n,qn)),ms.normalize(),Dc.crossVectors(qn,ms),r[0]=ms.x,r[4]=Dc.x,r[8]=qn.x,r[1]=ms.y,r[5]=Dc.y,r[9]=qn.y,r[2]=ms.z,r[6]=Dc.z,r[10]=qn.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,i){const n=e.elements,r=i.elements,s=this.elements,o=n[0],c=n[4],h=n[8],d=n[12],p=n[1],v=n[5],g=n[9],_=n[13],S=n[2],E=n[6],M=n[10],R=n[14],N=n[3],b=n[7],m=n[11],w=n[15],T=r[0],P=r[4],L=r[8],k=r[12],I=r[1],z=r[5],K=r[9],$=r[13],te=r[2],ee=r[6],de=r[10],X=r[14],le=r[3],_e=r[7],Se=r[11],De=r[15];return s[0]=o*T+c*I+h*te+d*le,s[4]=o*P+c*z+h*ee+d*_e,s[8]=o*L+c*K+h*de+d*Se,s[12]=o*k+c*$+h*X+d*De,s[1]=p*T+v*I+g*te+_*le,s[5]=p*P+v*z+g*ee+_*_e,s[9]=p*L+v*K+g*de+_*Se,s[13]=p*k+v*$+g*X+_*De,s[2]=S*T+E*I+M*te+R*le,s[6]=S*P+E*z+M*ee+R*_e,s[10]=S*L+E*K+M*de+R*Se,s[14]=S*k+E*$+M*X+R*De,s[3]=N*T+b*I+m*te+w*le,s[7]=N*P+b*z+m*ee+w*_e,s[11]=N*L+b*K+m*de+w*Se,s[15]=N*k+b*$+m*X+w*De,this}multiplyScalar(e){const i=this.elements;return i[0]*=e,i[4]*=e,i[8]*=e,i[12]*=e,i[1]*=e,i[5]*=e,i[9]*=e,i[13]*=e,i[2]*=e,i[6]*=e,i[10]*=e,i[14]*=e,i[3]*=e,i[7]*=e,i[11]*=e,i[15]*=e,this}determinant(){const e=this.elements,i=e[0],n=e[4],r=e[8],s=e[12],o=e[1],c=e[5],h=e[9],d=e[13],p=e[2],v=e[6],g=e[10],_=e[14],S=e[3],E=e[7],M=e[11],R=e[15];return S*(+s*h*v-r*d*v-s*c*g+n*d*g+r*c*_-n*h*_)+E*(+i*h*_-i*d*g+s*o*g-r*o*_+r*d*p-s*h*p)+M*(+i*d*v-i*c*_-s*o*v+n*o*_+s*c*p-n*d*p)+R*(-r*c*p-i*h*v+i*c*g+r*o*v-n*o*g+n*h*p)}transpose(){const e=this.elements;let i;return i=e[1],e[1]=e[4],e[4]=i,i=e[2],e[2]=e[8],e[8]=i,i=e[6],e[6]=e[9],e[9]=i,i=e[3],e[3]=e[12],e[12]=i,i=e[7],e[7]=e[13],e[13]=i,i=e[11],e[11]=e[14],e[14]=i,this}setPosition(e,i,n){const r=this.elements;return e.isVector3?(r[12]=e.x,r[13]=e.y,r[14]=e.z):(r[12]=e,r[13]=i,r[14]=n),this}invert(){const e=this.elements,i=e[0],n=e[1],r=e[2],s=e[3],o=e[4],c=e[5],h=e[6],d=e[7],p=e[8],v=e[9],g=e[10],_=e[11],S=e[12],E=e[13],M=e[14],R=e[15],N=v*M*d-E*g*d+E*h*_-c*M*_-v*h*R+c*g*R,b=S*g*d-p*M*d-S*h*_+o*M*_+p*h*R-o*g*R,m=p*E*d-S*v*d+S*c*_-o*E*_-p*c*R+o*v*R,w=S*v*h-p*E*h-S*c*g+o*E*g+p*c*M-o*v*M,T=i*N+n*b+r*m+s*w;if(T===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const P=1/T;return e[0]=N*P,e[1]=(E*g*s-v*M*s-E*r*_+n*M*_+v*r*R-n*g*R)*P,e[2]=(c*M*s-E*h*s+E*r*d-n*M*d-c*r*R+n*h*R)*P,e[3]=(v*h*s-c*g*s-v*r*d+n*g*d+c*r*_-n*h*_)*P,e[4]=b*P,e[5]=(p*M*s-S*g*s+S*r*_-i*M*_-p*r*R+i*g*R)*P,e[6]=(S*h*s-o*M*s-S*r*d+i*M*d+o*r*R-i*h*R)*P,e[7]=(o*g*s-p*h*s+p*r*d-i*g*d-o*r*_+i*h*_)*P,e[8]=m*P,e[9]=(S*v*s-p*E*s-S*n*_+i*E*_+p*n*R-i*v*R)*P,e[10]=(o*E*s-S*c*s+S*n*d-i*E*d-o*n*R+i*c*R)*P,e[11]=(p*c*s-o*v*s-p*n*d+i*v*d+o*n*_-i*c*_)*P,e[12]=w*P,e[13]=(p*E*r-S*v*r+S*n*g-i*E*g-p*n*M+i*v*M)*P,e[14]=(S*c*r-o*E*r-S*n*h+i*E*h+o*n*M-i*c*M)*P,e[15]=(o*v*r-p*c*r+p*n*h-i*v*h-o*n*g+i*c*g)*P,this}scale(e){const i=this.elements,n=e.x,r=e.y,s=e.z;return i[0]*=n,i[4]*=r,i[8]*=s,i[1]*=n,i[5]*=r,i[9]*=s,i[2]*=n,i[6]*=r,i[10]*=s,i[3]*=n,i[7]*=r,i[11]*=s,this}getMaxScaleOnAxis(){const e=this.elements,i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(i,n,r))}makeTranslation(e,i,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,i,0,0,1,n,0,0,0,1),this}makeRotationX(e){const i=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,i,-n,0,0,n,i,0,0,0,0,1),this}makeRotationY(e){const i=Math.cos(e),n=Math.sin(e);return this.set(i,0,n,0,0,1,0,0,-n,0,i,0,0,0,0,1),this}makeRotationZ(e){const i=Math.cos(e),n=Math.sin(e);return this.set(i,-n,0,0,n,i,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,i){const n=Math.cos(i),r=Math.sin(i),s=1-n,o=e.x,c=e.y,h=e.z,d=s*o,p=s*c;return this.set(d*o+n,d*c-r*h,d*h+r*c,0,d*c+r*h,p*c+n,p*h-r*o,0,d*h-r*c,p*h+r*o,s*h*h+n,0,0,0,0,1),this}makeScale(e,i,n){return this.set(e,0,0,0,0,i,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,i,n,r,s,o){return this.set(1,n,s,0,e,1,o,0,i,r,1,0,0,0,0,1),this}compose(e,i,n){const r=this.elements,s=i._x,o=i._y,c=i._z,h=i._w,d=s+s,p=o+o,v=c+c,g=s*d,_=s*p,S=s*v,E=o*p,M=o*v,R=c*v,N=h*d,b=h*p,m=h*v,w=n.x,T=n.y,P=n.z;return r[0]=(1-(E+R))*w,r[1]=(_+m)*w,r[2]=(S-b)*w,r[3]=0,r[4]=(_-m)*T,r[5]=(1-(g+R))*T,r[6]=(M+N)*T,r[7]=0,r[8]=(S+b)*P,r[9]=(M-N)*P,r[10]=(1-(g+E))*P,r[11]=0,r[12]=e.x,r[13]=e.y,r[14]=e.z,r[15]=1,this}decompose(e,i,n){const r=this.elements;let s=ya.set(r[0],r[1],r[2]).length();const o=ya.set(r[4],r[5],r[6]).length(),c=ya.set(r[8],r[9],r[10]).length();this.determinant()<0&&(s=-s),e.x=r[12],e.y=r[13],e.z=r[14],mr.copy(this);const d=1/s,p=1/o,v=1/c;return mr.elements[0]*=d,mr.elements[1]*=d,mr.elements[2]*=d,mr.elements[4]*=p,mr.elements[5]*=p,mr.elements[6]*=p,mr.elements[8]*=v,mr.elements[9]*=v,mr.elements[10]*=v,i.setFromRotationMatrix(mr),n.x=s,n.y=o,n.z=c,this}makePerspective(e,i,n,r,s,o,c=ts){const h=this.elements,d=2*s/(i-e),p=2*s/(n-r),v=(i+e)/(i-e),g=(n+r)/(n-r);let _,S;if(c===ts)_=-(o+s)/(o-s),S=-2*o*s/(o-s);else if(c===wl)_=-o/(o-s),S=-o*s/(o-s);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+c);return h[0]=d,h[4]=0,h[8]=v,h[12]=0,h[1]=0,h[5]=p,h[9]=g,h[13]=0,h[2]=0,h[6]=0,h[10]=_,h[14]=S,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(e,i,n,r,s,o,c=ts){const h=this.elements,d=1/(i-e),p=1/(n-r),v=1/(o-s),g=(i+e)*d,_=(n+r)*p;let S,E;if(c===ts)S=(o+s)*v,E=-2*v;else if(c===wl)S=s*v,E=-1*v;else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+c);return h[0]=2*d,h[4]=0,h[8]=0,h[12]=-g,h[1]=0,h[5]=2*p,h[9]=0,h[13]=-_,h[2]=0,h[6]=0,h[10]=E,h[14]=-S,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(e){const i=this.elements,n=e.elements;for(let r=0;r<16;r++)if(i[r]!==n[r])return!1;return!0}fromArray(e,i=0){for(let n=0;n<16;n++)this.elements[n]=e[n+i];return this}toArray(e=[],i=0){const n=this.elements;return e[i]=n[0],e[i+1]=n[1],e[i+2]=n[2],e[i+3]=n[3],e[i+4]=n[4],e[i+5]=n[5],e[i+6]=n[6],e[i+7]=n[7],e[i+8]=n[8],e[i+9]=n[9],e[i+10]=n[10],e[i+11]=n[11],e[i+12]=n[12],e[i+13]=n[13],e[i+14]=n[14],e[i+15]=n[15],e}}const ya=new Ae,mr=new Wi,CC=new Ae(0,0,0),TC=new Ae(1,1,1),ms=new Ae,Dc=new Ae,qn=new Ae,ff=new Wi,mf=new sa;class as{constructor(e=0,i=0,n=0,r=as.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=i,this._z=n,this._order=r}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,i,n,r=this._order){return this._x=e,this._y=i,this._z=n,this._order=r,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,i=this._order,n=!0){const r=e.elements,s=r[0],o=r[4],c=r[8],h=r[1],d=r[5],p=r[9],v=r[2],g=r[6],_=r[10];switch(i){case"XYZ":this._y=Math.asin(Qt(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(-p,_),this._z=Math.atan2(-o,s)):(this._x=Math.atan2(g,d),this._z=0);break;case"YXZ":this._x=Math.asin(-Qt(p,-1,1)),Math.abs(p)<.9999999?(this._y=Math.atan2(c,_),this._z=Math.atan2(h,d)):(this._y=Math.atan2(-v,s),this._z=0);break;case"ZXY":this._x=Math.asin(Qt(g,-1,1)),Math.abs(g)<.9999999?(this._y=Math.atan2(-v,_),this._z=Math.atan2(-o,d)):(this._y=0,this._z=Math.atan2(h,s));break;case"ZYX":this._y=Math.asin(-Qt(v,-1,1)),Math.abs(v)<.9999999?(this._x=Math.atan2(g,_),this._z=Math.atan2(h,s)):(this._x=0,this._z=Math.atan2(-o,d));break;case"YZX":this._z=Math.asin(Qt(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-p,d),this._y=Math.atan2(-v,s)):(this._x=0,this._y=Math.atan2(c,_));break;case"XZY":this._z=Math.asin(-Qt(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(g,d),this._y=Math.atan2(c,s)):(this._x=Math.atan2(-p,_),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+i)}return this._order=i,n===!0&&this._onChangeCallback(),this}setFromQuaternion(e,i,n){return ff.makeRotationFromQuaternion(e),this.setFromRotationMatrix(ff,i,n)}setFromVector3(e,i=this._order){return this.set(e.x,e.y,e.z,i)}reorder(e){return mf.setFromEuler(this),this.setFromQuaternion(mf,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],e[3]!==void 0&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],i=0){return e[i]=this._x,e[i+1]=this._y,e[i+2]=this._z,e[i+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}as.DEFAULT_ORDER="XYZ";class Dv{constructor(){this.mask=1}set(e){this.mask=(1<<e|0)>>>0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!==0}isEnabled(e){return(this.mask&(1<<e|0))!==0}}let RC=0;const gf=new Ae,Sa=new sa,Kr=new Wi,Ic=new Ae,wo=new Ae,MC=new Ae,PC=new sa,vf=new Ae(1,0,0),_f=new Ae(0,1,0),bf=new Ae(0,0,1),yf={type:"added"},AC={type:"removed"},wa={type:"childadded",child:null},Bd={type:"childremoved",child:null};class $n extends la{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:RC++}),this.uuid=Qo(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=$n.DEFAULT_UP.clone();const e=new Ae,i=new as,n=new sa,r=new Ae(1,1,1);function s(){n.setFromEuler(i,!1)}function o(){i.setFromQuaternion(n,void 0,!1)}i._onChange(s),n._onChange(o),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:i},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new Wi},normalMatrix:{value:new qt}}),this.matrix=new Wi,this.matrixWorld=new Wi,this.matrixAutoUpdate=$n.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=$n.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Dv,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,i){this.quaternion.setFromAxisAngle(e,i)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,i){return Sa.setFromAxisAngle(e,i),this.quaternion.multiply(Sa),this}rotateOnWorldAxis(e,i){return Sa.setFromAxisAngle(e,i),this.quaternion.premultiply(Sa),this}rotateX(e){return this.rotateOnAxis(vf,e)}rotateY(e){return this.rotateOnAxis(_f,e)}rotateZ(e){return this.rotateOnAxis(bf,e)}translateOnAxis(e,i){return gf.copy(e).applyQuaternion(this.quaternion),this.position.add(gf.multiplyScalar(i)),this}translateX(e){return this.translateOnAxis(vf,e)}translateY(e){return this.translateOnAxis(_f,e)}translateZ(e){return this.translateOnAxis(bf,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Kr.copy(this.matrixWorld).invert())}lookAt(e,i,n){e.isVector3?Ic.copy(e):Ic.set(e,i,n);const r=this.parent;this.updateWorldMatrix(!0,!1),wo.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Kr.lookAt(wo,Ic,this.up):Kr.lookAt(Ic,wo,this.up),this.quaternion.setFromRotationMatrix(Kr),r&&(Kr.extractRotation(r.matrixWorld),Sa.setFromRotationMatrix(Kr),this.quaternion.premultiply(Sa.invert()))}add(e){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.add(arguments[i]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(yf),wa.child=e,this.dispatchEvent(wa),wa.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let n=0;n<arguments.length;n++)this.remove(arguments[n]);return this}const i=this.children.indexOf(e);return i!==-1&&(e.parent=null,this.children.splice(i,1),e.dispatchEvent(AC),Bd.child=e,this.dispatchEvent(Bd),Bd.child=null),this}removeFromParent(){const e=this.parent;return e!==null&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Kr.copy(this.matrixWorld).invert(),e.parent!==null&&(e.parent.updateWorldMatrix(!0,!1),Kr.multiply(e.parent.matrixWorld)),e.applyMatrix4(Kr),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(yf),wa.child=e,this.dispatchEvent(wa),wa.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,i){if(this[e]===i)return this;for(let n=0,r=this.children.length;n<r;n++){const o=this.children[n].getObjectByProperty(e,i);if(o!==void 0)return o}}getObjectsByProperty(e,i,n=[]){this[e]===i&&n.push(this);const r=this.children;for(let s=0,o=r.length;s<o;s++)r[s].getObjectsByProperty(e,i,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(wo,e,MC),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(wo,PC,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const i=this.matrixWorld.elements;return e.set(i[8],i[9],i[10]).normalize()}raycast(){}traverse(e){e(this);const i=this.children;for(let n=0,r=i.length;n<r;n++)i[n].traverse(e)}traverseVisible(e){if(this.visible===!1)return;e(this);const i=this.children;for(let n=0,r=i.length;n<r;n++)i[n].traverseVisible(e)}traverseAncestors(e){const i=this.parent;i!==null&&(e(i),i.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const i=this.children;for(let n=0,r=i.length;n<r;n++)i[n].updateMatrixWorld(e)}updateWorldMatrix(e,i){const n=this.parent;if(e===!0&&n!==null&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),i===!0){const r=this.children;for(let s=0,o=r.length;s<o;s++)r[s].updateWorldMatrix(!1,!0)}}toJSON(e){const i=e===void 0||typeof e=="string",n={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const r={};r.uuid=this.uuid,r.type=this.type,this.name!==""&&(r.name=this.name),this.castShadow===!0&&(r.castShadow=!0),this.receiveShadow===!0&&(r.receiveShadow=!0),this.visible===!1&&(r.visible=!1),this.frustumCulled===!1&&(r.frustumCulled=!1),this.renderOrder!==0&&(r.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),r.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(r.matrixAutoUpdate=!1),this.isInstancedMesh&&(r.type="InstancedMesh",r.count=this.count,r.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(r.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(r.type="BatchedMesh",r.perObjectFrustumCulled=this.perObjectFrustumCulled,r.sortObjects=this.sortObjects,r.drawRanges=this._drawRanges,r.reservedRanges=this._reservedRanges,r.geometryInfo=this._geometryInfo.map(c=>({...c,boundingBox:c.boundingBox?c.boundingBox.toJSON():void 0,boundingSphere:c.boundingSphere?c.boundingSphere.toJSON():void 0})),r.instanceInfo=this._instanceInfo.map(c=>({...c})),r.availableInstanceIds=this._availableInstanceIds.slice(),r.availableGeometryIds=this._availableGeometryIds.slice(),r.nextIndexStart=this._nextIndexStart,r.nextVertexStart=this._nextVertexStart,r.geometryCount=this._geometryCount,r.maxInstanceCount=this._maxInstanceCount,r.maxVertexCount=this._maxVertexCount,r.maxIndexCount=this._maxIndexCount,r.geometryInitialized=this._geometryInitialized,r.matricesTexture=this._matricesTexture.toJSON(e),r.indirectTexture=this._indirectTexture.toJSON(e),this._colorsTexture!==null&&(r.colorsTexture=this._colorsTexture.toJSON(e)),this.boundingSphere!==null&&(r.boundingSphere=this.boundingSphere.toJSON()),this.boundingBox!==null&&(r.boundingBox=this.boundingBox.toJSON()));function s(c,h){return c[h.uuid]===void 0&&(c[h.uuid]=h.toJSON(e)),h.uuid}if(this.isScene)this.background&&(this.background.isColor?r.background=this.background.toJSON():this.background.isTexture&&(r.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(r.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){r.geometry=s(e.geometries,this.geometry);const c=this.geometry.parameters;if(c!==void 0&&c.shapes!==void 0){const h=c.shapes;if(Array.isArray(h))for(let d=0,p=h.length;d<p;d++){const v=h[d];s(e.shapes,v)}else s(e.shapes,h)}}if(this.isSkinnedMesh&&(r.bindMode=this.bindMode,r.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(s(e.skeletons,this.skeleton),r.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const c=[];for(let h=0,d=this.material.length;h<d;h++)c.push(s(e.materials,this.material[h]));r.material=c}else r.material=s(e.materials,this.material);if(this.children.length>0){r.children=[];for(let c=0;c<this.children.length;c++)r.children.push(this.children[c].toJSON(e).object)}if(this.animations.length>0){r.animations=[];for(let c=0;c<this.animations.length;c++){const h=this.animations[c];r.animations.push(s(e.animations,h))}}if(i){const c=o(e.geometries),h=o(e.materials),d=o(e.textures),p=o(e.images),v=o(e.shapes),g=o(e.skeletons),_=o(e.animations),S=o(e.nodes);c.length>0&&(n.geometries=c),h.length>0&&(n.materials=h),d.length>0&&(n.textures=d),p.length>0&&(n.images=p),v.length>0&&(n.shapes=v),g.length>0&&(n.skeletons=g),_.length>0&&(n.animations=_),S.length>0&&(n.nodes=S)}return n.object=r,n;function o(c){const h=[];for(const d in c){const p=c[d];delete p.metadata,h.push(p)}return h}}clone(e){return new this.constructor().copy(this,e)}copy(e,i=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),i===!0)for(let n=0;n<e.children.length;n++){const r=e.children[n];this.add(r.clone())}return this}}$n.DEFAULT_UP=new Ae(0,1,0);$n.DEFAULT_MATRIX_AUTO_UPDATE=!0;$n.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const gr=new Ae,Xr=new Ae,Hd=new Ae,$r=new Ae,xa=new Ae,Ea=new Ae,Sf=new Ae,jd=new Ae,Vd=new Ae,zd=new Ae,Gd=new ji,qd=new ji,Wd=new ji;class yr{constructor(e=new Ae,i=new Ae,n=new Ae){this.a=e,this.b=i,this.c=n}static getNormal(e,i,n,r){r.subVectors(n,i),gr.subVectors(e,i),r.cross(gr);const s=r.lengthSq();return s>0?r.multiplyScalar(1/Math.sqrt(s)):r.set(0,0,0)}static getBarycoord(e,i,n,r,s){gr.subVectors(r,i),Xr.subVectors(n,i),Hd.subVectors(e,i);const o=gr.dot(gr),c=gr.dot(Xr),h=gr.dot(Hd),d=Xr.dot(Xr),p=Xr.dot(Hd),v=o*d-c*c;if(v===0)return s.set(0,0,0),null;const g=1/v,_=(d*h-c*p)*g,S=(o*p-c*h)*g;return s.set(1-_-S,S,_)}static containsPoint(e,i,n,r){return this.getBarycoord(e,i,n,r,$r)===null?!1:$r.x>=0&&$r.y>=0&&$r.x+$r.y<=1}static getInterpolation(e,i,n,r,s,o,c,h){return this.getBarycoord(e,i,n,r,$r)===null?(h.x=0,h.y=0,"z"in h&&(h.z=0),"w"in h&&(h.w=0),null):(h.setScalar(0),h.addScaledVector(s,$r.x),h.addScaledVector(o,$r.y),h.addScaledVector(c,$r.z),h)}static getInterpolatedAttribute(e,i,n,r,s,o){return Gd.setScalar(0),qd.setScalar(0),Wd.setScalar(0),Gd.fromBufferAttribute(e,i),qd.fromBufferAttribute(e,n),Wd.fromBufferAttribute(e,r),o.setScalar(0),o.addScaledVector(Gd,s.x),o.addScaledVector(qd,s.y),o.addScaledVector(Wd,s.z),o}static isFrontFacing(e,i,n,r){return gr.subVectors(n,i),Xr.subVectors(e,i),gr.cross(Xr).dot(r)<0}set(e,i,n){return this.a.copy(e),this.b.copy(i),this.c.copy(n),this}setFromPointsAndIndices(e,i,n,r){return this.a.copy(e[i]),this.b.copy(e[n]),this.c.copy(e[r]),this}setFromAttributeAndIndices(e,i,n,r){return this.a.fromBufferAttribute(e,i),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,r),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return gr.subVectors(this.c,this.b),Xr.subVectors(this.a,this.b),gr.cross(Xr).length()*.5}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return yr.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,i){return yr.getBarycoord(e,this.a,this.b,this.c,i)}getInterpolation(e,i,n,r,s){return yr.getInterpolation(e,this.a,this.b,this.c,i,n,r,s)}containsPoint(e){return yr.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return yr.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,i){const n=this.a,r=this.b,s=this.c;let o,c;xa.subVectors(r,n),Ea.subVectors(s,n),jd.subVectors(e,n);const h=xa.dot(jd),d=Ea.dot(jd);if(h<=0&&d<=0)return i.copy(n);Vd.subVectors(e,r);const p=xa.dot(Vd),v=Ea.dot(Vd);if(p>=0&&v<=p)return i.copy(r);const g=h*v-p*d;if(g<=0&&h>=0&&p<=0)return o=h/(h-p),i.copy(n).addScaledVector(xa,o);zd.subVectors(e,s);const _=xa.dot(zd),S=Ea.dot(zd);if(S>=0&&_<=S)return i.copy(s);const E=_*d-h*S;if(E<=0&&d>=0&&S<=0)return c=d/(d-S),i.copy(n).addScaledVector(Ea,c);const M=p*S-_*v;if(M<=0&&v-p>=0&&_-S>=0)return Sf.subVectors(s,r),c=(v-p)/(v-p+(_-S)),i.copy(r).addScaledVector(Sf,c);const R=1/(M+E+g);return o=E*R,c=g*R,i.copy(n).addScaledVector(xa,o).addScaledVector(Ea,c)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const Iv={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},gs={h:0,s:0,l:0},Fc={h:0,s:0,l:0};function Kd(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+(e-t)*6*i:i<1/2?e:i<2/3?t+(e-t)*6*(2/3-i):t}class Ei{constructor(e,i,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,i,n)}set(e,i,n){if(i===void 0&&n===void 0){const r=e;r&&r.isColor?this.copy(r):typeof r=="number"?this.setHex(r):typeof r=="string"&&this.setStyle(r)}else this.setRGB(e,i,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,i=nr){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,ci.colorSpaceToWorking(this,i),this}setRGB(e,i,n,r=ci.workingColorSpace){return this.r=e,this.g=i,this.b=n,ci.colorSpaceToWorking(this,r),this}setHSL(e,i,n,r=ci.workingColorSpace){if(e=hC(e,1),i=Qt(i,0,1),n=Qt(n,0,1),i===0)this.r=this.g=this.b=n;else{const s=n<=.5?n*(1+i):n+i-n*i,o=2*n-s;this.r=Kd(o,s,e+1/3),this.g=Kd(o,s,e),this.b=Kd(o,s,e-1/3)}return ci.colorSpaceToWorking(this,r),this}setStyle(e,i=nr){function n(s){s!==void 0&&parseFloat(s)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let r;if(r=/^(\w+)\(([^\)]*)\)/.exec(e)){let s;const o=r[1],c=r[2];switch(o){case"rgb":case"rgba":if(s=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(c))return n(s[4]),this.setRGB(Math.min(255,parseInt(s[1],10))/255,Math.min(255,parseInt(s[2],10))/255,Math.min(255,parseInt(s[3],10))/255,i);if(s=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(c))return n(s[4]),this.setRGB(Math.min(100,parseInt(s[1],10))/100,Math.min(100,parseInt(s[2],10))/100,Math.min(100,parseInt(s[3],10))/100,i);break;case"hsl":case"hsla":if(s=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(c))return n(s[4]),this.setHSL(parseFloat(s[1])/360,parseFloat(s[2])/100,parseFloat(s[3])/100,i);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(r=/^\#([A-Fa-f\d]+)$/.exec(e)){const s=r[1],o=s.length;if(o===3)return this.setRGB(parseInt(s.charAt(0),16)/15,parseInt(s.charAt(1),16)/15,parseInt(s.charAt(2),16)/15,i);if(o===6)return this.setHex(parseInt(s,16),i);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,i);return this}setColorName(e,i=nr){const n=Iv[e.toLowerCase()];return n!==void 0?this.setHex(n,i):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=is(e.r),this.g=is(e.g),this.b=is(e.b),this}copyLinearToSRGB(e){return this.r=Ha(e.r),this.g=Ha(e.g),this.b=Ha(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=nr){return ci.workingToColorSpace(mn.copy(this),e),Math.round(Qt(mn.r*255,0,255))*65536+Math.round(Qt(mn.g*255,0,255))*256+Math.round(Qt(mn.b*255,0,255))}getHexString(e=nr){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,i=ci.workingColorSpace){ci.workingToColorSpace(mn.copy(this),i);const n=mn.r,r=mn.g,s=mn.b,o=Math.max(n,r,s),c=Math.min(n,r,s);let h,d;const p=(c+o)/2;if(c===o)h=0,d=0;else{const v=o-c;switch(d=p<=.5?v/(o+c):v/(2-o-c),o){case n:h=(r-s)/v+(r<s?6:0);break;case r:h=(s-n)/v+2;break;case s:h=(n-r)/v+4;break}h/=6}return e.h=h,e.s=d,e.l=p,e}getRGB(e,i=ci.workingColorSpace){return ci.workingToColorSpace(mn.copy(this),i),e.r=mn.r,e.g=mn.g,e.b=mn.b,e}getStyle(e=nr){ci.workingToColorSpace(mn.copy(this),e);const i=mn.r,n=mn.g,r=mn.b;return e!==nr?`color(${e} ${i.toFixed(3)} ${n.toFixed(3)} ${r.toFixed(3)})`:`rgb(${Math.round(i*255)},${Math.round(n*255)},${Math.round(r*255)})`}offsetHSL(e,i,n){return this.getHSL(gs),this.setHSL(gs.h+e,gs.s+i,gs.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,i){return this.r=e.r+i.r,this.g=e.g+i.g,this.b=e.b+i.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,i){return this.r+=(e.r-this.r)*i,this.g+=(e.g-this.g)*i,this.b+=(e.b-this.b)*i,this}lerpColors(e,i,n){return this.r=e.r+(i.r-e.r)*n,this.g=e.g+(i.g-e.g)*n,this.b=e.b+(i.b-e.b)*n,this}lerpHSL(e,i){this.getHSL(gs),e.getHSL(Fc);const n=Pd(gs.h,Fc.h,i),r=Pd(gs.s,Fc.s,i),s=Pd(gs.l,Fc.l,i);return this.setHSL(n,r,s),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const i=this.r,n=this.g,r=this.b,s=e.elements;return this.r=s[0]*i+s[3]*n+s[6]*r,this.g=s[1]*i+s[4]*n+s[7]*r,this.b=s[2]*i+s[5]*n+s[8]*r,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,i=0){return this.r=e[i],this.g=e[i+1],this.b=e[i+2],this}toArray(e=[],i=0){return e[i]=this.r,e[i+1]=this.g,e[i+2]=this.b,e}fromBufferAttribute(e,i){return this.r=e.getX(i),this.g=e.getY(i),this.b=e.getZ(i),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const mn=new Ei;Ei.NAMES=Iv;let DC=0;class ql extends la{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:DC++}),this.uuid=Qo(),this.name="",this.type="Material",this.blending=Ua,this.side=Rs,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=Ru,this.blendDst=Mu,this.blendEquation=Ks,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Ei(0,0,0),this.blendAlpha=0,this.depthFunc=$a,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=of,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=ma,this.stencilZFail=ma,this.stencilZPass=ma,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(e!==void 0)for(const i in e){const n=e[i];if(n===void 0){console.warn(`THREE.Material: parameter '${i}' has value of undefined.`);continue}const r=this[i];if(r===void 0){console.warn(`THREE.Material: '${i}' is not a property of THREE.${this.type}.`);continue}r&&r.isColor?r.set(n):r&&r.isVector3&&n&&n.isVector3?r.copy(n):this[i]=n}}toJSON(e){const i=e===void 0||typeof e=="string";i&&(e={textures:{},images:{}});const n={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};n.uuid=this.uuid,n.type=this.type,this.name!==""&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),this.roughness!==void 0&&(n.roughness=this.roughness),this.metalness!==void 0&&(n.metalness=this.metalness),this.sheen!==void 0&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),this.emissiveIntensity!==void 0&&this.emissiveIntensity!==1&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(n.shininess=this.shininess),this.clearcoat!==void 0&&(n.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.dispersion!==void 0&&(n.dispersion=this.dispersion),this.iridescence!==void 0&&(n.iridescence=this.iridescence),this.iridescenceIOR!==void 0&&(n.iridescenceIOR=this.iridescenceIOR),this.iridescenceThicknessRange!==void 0&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),this.anisotropy!==void 0&&(n.anisotropy=this.anisotropy),this.anisotropyRotation!==void 0&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,this.combine!==void 0&&(n.combine=this.combine)),this.envMapRotation!==void 0&&(n.envMapRotation=this.envMapRotation.toArray()),this.envMapIntensity!==void 0&&(n.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(n.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),this.transmission!==void 0&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),this.thickness!==void 0&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),this.attenuationDistance!==void 0&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(n.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(n.size=this.size),this.shadowSide!==null&&(n.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(n.sizeAttenuation=this.sizeAttenuation),this.blending!==Ua&&(n.blending=this.blending),this.side!==Rs&&(n.side=this.side),this.vertexColors===!0&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),this.transparent===!0&&(n.transparent=!0),this.blendSrc!==Ru&&(n.blendSrc=this.blendSrc),this.blendDst!==Mu&&(n.blendDst=this.blendDst),this.blendEquation!==Ks&&(n.blendEquation=this.blendEquation),this.blendSrcAlpha!==null&&(n.blendSrcAlpha=this.blendSrcAlpha),this.blendDstAlpha!==null&&(n.blendDstAlpha=this.blendDstAlpha),this.blendEquationAlpha!==null&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),this.blendAlpha!==0&&(n.blendAlpha=this.blendAlpha),this.depthFunc!==$a&&(n.depthFunc=this.depthFunc),this.depthTest===!1&&(n.depthTest=this.depthTest),this.depthWrite===!1&&(n.depthWrite=this.depthWrite),this.colorWrite===!1&&(n.colorWrite=this.colorWrite),this.stencilWriteMask!==255&&(n.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==of&&(n.stencilFunc=this.stencilFunc),this.stencilRef!==0&&(n.stencilRef=this.stencilRef),this.stencilFuncMask!==255&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==ma&&(n.stencilFail=this.stencilFail),this.stencilZFail!==ma&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==ma&&(n.stencilZPass=this.stencilZPass),this.stencilWrite===!0&&(n.stencilWrite=this.stencilWrite),this.rotation!==void 0&&this.rotation!==0&&(n.rotation=this.rotation),this.polygonOffset===!0&&(n.polygonOffset=!0),this.polygonOffsetFactor!==0&&(n.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(n.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth!==void 0&&this.linewidth!==1&&(n.linewidth=this.linewidth),this.dashSize!==void 0&&(n.dashSize=this.dashSize),this.gapSize!==void 0&&(n.gapSize=this.gapSize),this.scale!==void 0&&(n.scale=this.scale),this.dithering===!0&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),this.alphaHash===!0&&(n.alphaHash=!0),this.alphaToCoverage===!0&&(n.alphaToCoverage=!0),this.premultipliedAlpha===!0&&(n.premultipliedAlpha=!0),this.forceSinglePass===!0&&(n.forceSinglePass=!0),this.wireframe===!0&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(n.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(n.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(n.flatShading=!0),this.visible===!1&&(n.visible=!1),this.toneMapped===!1&&(n.toneMapped=!1),this.fog===!1&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData);function r(s){const o=[];for(const c in s){const h=s[c];delete h.metadata,o.push(h)}return o}if(i){const s=r(e.textures),o=r(e.images);s.length>0&&(n.textures=s),o.length>0&&(n.images=o)}return n}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const i=e.clippingPlanes;let n=null;if(i!==null){const r=i.length;n=new Array(r);for(let s=0;s!==r;++s)n[s]=i[s].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){e===!0&&this.version++}}class Vh extends ql{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Ei(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new as,this.combine=_v,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const Gi=new Ae,Nc=new $t;let IC=0;class Ur{constructor(e,i,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:IC++}),this.name="",this.array=e,this.itemSize=i,this.count=e!==void 0?e.length/i:0,this.normalized=n,this.usage=cf,this.updateRanges=[],this.gpuType=es,this.version=0}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,i){this.updateRanges.push({start:e,count:i})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,i,n){e*=this.itemSize,n*=i.itemSize;for(let r=0,s=this.itemSize;r<s;r++)this.array[e+r]=i.array[n+r];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(this.itemSize===2)for(let i=0,n=this.count;i<n;i++)Nc.fromBufferAttribute(this,i),Nc.applyMatrix3(e),this.setXY(i,Nc.x,Nc.y);else if(this.itemSize===3)for(let i=0,n=this.count;i<n;i++)Gi.fromBufferAttribute(this,i),Gi.applyMatrix3(e),this.setXYZ(i,Gi.x,Gi.y,Gi.z);return this}applyMatrix4(e){for(let i=0,n=this.count;i<n;i++)Gi.fromBufferAttribute(this,i),Gi.applyMatrix4(e),this.setXYZ(i,Gi.x,Gi.y,Gi.z);return this}applyNormalMatrix(e){for(let i=0,n=this.count;i<n;i++)Gi.fromBufferAttribute(this,i),Gi.applyNormalMatrix(e),this.setXYZ(i,Gi.x,Gi.y,Gi.z);return this}transformDirection(e){for(let i=0,n=this.count;i<n;i++)Gi.fromBufferAttribute(this,i),Gi.transformDirection(e),this.setXYZ(i,Gi.x,Gi.y,Gi.z);return this}set(e,i=0){return this.array.set(e,i),this}getComponent(e,i){let n=this.array[e*this.itemSize+i];return this.normalized&&(n=bo(n,this.array)),n}setComponent(e,i,n){return this.normalized&&(n=Fn(n,this.array)),this.array[e*this.itemSize+i]=n,this}getX(e){let i=this.array[e*this.itemSize];return this.normalized&&(i=bo(i,this.array)),i}setX(e,i){return this.normalized&&(i=Fn(i,this.array)),this.array[e*this.itemSize]=i,this}getY(e){let i=this.array[e*this.itemSize+1];return this.normalized&&(i=bo(i,this.array)),i}setY(e,i){return this.normalized&&(i=Fn(i,this.array)),this.array[e*this.itemSize+1]=i,this}getZ(e){let i=this.array[e*this.itemSize+2];return this.normalized&&(i=bo(i,this.array)),i}setZ(e,i){return this.normalized&&(i=Fn(i,this.array)),this.array[e*this.itemSize+2]=i,this}getW(e){let i=this.array[e*this.itemSize+3];return this.normalized&&(i=bo(i,this.array)),i}setW(e,i){return this.normalized&&(i=Fn(i,this.array)),this.array[e*this.itemSize+3]=i,this}setXY(e,i,n){return e*=this.itemSize,this.normalized&&(i=Fn(i,this.array),n=Fn(n,this.array)),this.array[e+0]=i,this.array[e+1]=n,this}setXYZ(e,i,n,r){return e*=this.itemSize,this.normalized&&(i=Fn(i,this.array),n=Fn(n,this.array),r=Fn(r,this.array)),this.array[e+0]=i,this.array[e+1]=n,this.array[e+2]=r,this}setXYZW(e,i,n,r,s){return e*=this.itemSize,this.normalized&&(i=Fn(i,this.array),n=Fn(n,this.array),r=Fn(r,this.array),s=Fn(s,this.array)),this.array[e+0]=i,this.array[e+1]=n,this.array[e+2]=r,this.array[e+3]=s,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return this.name!==""&&(e.name=this.name),this.usage!==cf&&(e.usage=this.usage),e}}class Fv extends Ur{constructor(e,i,n){super(new Uint16Array(e),i,n)}}class Nv extends Ur{constructor(e,i,n){super(new Uint32Array(e),i,n)}}class Br extends Ur{constructor(e,i,n){super(new Float32Array(e),i,n)}}let FC=0;const tr=new Wi,Xd=new $n,Ca=new Ae,Wn=new ec,xo=new ec,rn=new Ae;class Ds extends la{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:FC++}),this.uuid=Qo(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(Mv(e)?Nv:Fv)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,i){return this.attributes[e]=i,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return this.attributes[e]!==void 0}addGroup(e,i,n=0){this.groups.push({start:e,count:i,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,i){this.drawRange.start=e,this.drawRange.count=i}applyMatrix4(e){const i=this.attributes.position;i!==void 0&&(i.applyMatrix4(e),i.needsUpdate=!0);const n=this.attributes.normal;if(n!==void 0){const s=new qt().getNormalMatrix(e);n.applyNormalMatrix(s),n.needsUpdate=!0}const r=this.attributes.tangent;return r!==void 0&&(r.transformDirection(e),r.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(e){return tr.makeRotationFromQuaternion(e),this.applyMatrix4(tr),this}rotateX(e){return tr.makeRotationX(e),this.applyMatrix4(tr),this}rotateY(e){return tr.makeRotationY(e),this.applyMatrix4(tr),this}rotateZ(e){return tr.makeRotationZ(e),this.applyMatrix4(tr),this}translate(e,i,n){return tr.makeTranslation(e,i,n),this.applyMatrix4(tr),this}scale(e,i,n){return tr.makeScale(e,i,n),this.applyMatrix4(tr),this}lookAt(e){return Xd.lookAt(e),Xd.updateMatrix(),this.applyMatrix4(Xd.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Ca).negate(),this.translate(Ca.x,Ca.y,Ca.z),this}setFromPoints(e){const i=this.getAttribute("position");if(i===void 0){const n=[];for(let r=0,s=e.length;r<s;r++){const o=e[r];n.push(o.x,o.y,o.z||0)}this.setAttribute("position",new Br(n,3))}else{const n=Math.min(e.length,i.count);for(let r=0;r<n;r++){const s=e[r];i.setXYZ(r,s.x,s.y,s.z||0)}e.length>i.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),i.needsUpdate=!0}return this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new ec);const e=this.attributes.position,i=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new Ae(-1/0,-1/0,-1/0),new Ae(1/0,1/0,1/0));return}if(e!==void 0){if(this.boundingBox.setFromBufferAttribute(e),i)for(let n=0,r=i.length;n<r;n++){const s=i[n];Wn.setFromBufferAttribute(s),this.morphTargetsRelative?(rn.addVectors(this.boundingBox.min,Wn.min),this.boundingBox.expandByPoint(rn),rn.addVectors(this.boundingBox.max,Wn.max),this.boundingBox.expandByPoint(rn)):(this.boundingBox.expandByPoint(Wn.min),this.boundingBox.expandByPoint(Wn.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new jh);const e=this.attributes.position,i=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new Ae,1/0);return}if(e){const n=this.boundingSphere.center;if(Wn.setFromBufferAttribute(e),i)for(let s=0,o=i.length;s<o;s++){const c=i[s];xo.setFromBufferAttribute(c),this.morphTargetsRelative?(rn.addVectors(Wn.min,xo.min),Wn.expandByPoint(rn),rn.addVectors(Wn.max,xo.max),Wn.expandByPoint(rn)):(Wn.expandByPoint(xo.min),Wn.expandByPoint(xo.max))}Wn.getCenter(n);let r=0;for(let s=0,o=e.count;s<o;s++)rn.fromBufferAttribute(e,s),r=Math.max(r,n.distanceToSquared(rn));if(i)for(let s=0,o=i.length;s<o;s++){const c=i[s],h=this.morphTargetsRelative;for(let d=0,p=c.count;d<p;d++)rn.fromBufferAttribute(c,d),h&&(Ca.fromBufferAttribute(e,d),rn.add(Ca)),r=Math.max(r,n.distanceToSquared(rn))}this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,i=this.attributes;if(e===null||i.position===void 0||i.normal===void 0||i.uv===void 0){console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const n=i.position,r=i.normal,s=i.uv;this.hasAttribute("tangent")===!1&&this.setAttribute("tangent",new Ur(new Float32Array(4*n.count),4));const o=this.getAttribute("tangent"),c=[],h=[];for(let L=0;L<n.count;L++)c[L]=new Ae,h[L]=new Ae;const d=new Ae,p=new Ae,v=new Ae,g=new $t,_=new $t,S=new $t,E=new Ae,M=new Ae;function R(L,k,I){d.fromBufferAttribute(n,L),p.fromBufferAttribute(n,k),v.fromBufferAttribute(n,I),g.fromBufferAttribute(s,L),_.fromBufferAttribute(s,k),S.fromBufferAttribute(s,I),p.sub(d),v.sub(d),_.sub(g),S.sub(g);const z=1/(_.x*S.y-S.x*_.y);isFinite(z)&&(E.copy(p).multiplyScalar(S.y).addScaledVector(v,-_.y).multiplyScalar(z),M.copy(v).multiplyScalar(_.x).addScaledVector(p,-S.x).multiplyScalar(z),c[L].add(E),c[k].add(E),c[I].add(E),h[L].add(M),h[k].add(M),h[I].add(M))}let N=this.groups;N.length===0&&(N=[{start:0,count:e.count}]);for(let L=0,k=N.length;L<k;++L){const I=N[L],z=I.start,K=I.count;for(let $=z,te=z+K;$<te;$+=3)R(e.getX($+0),e.getX($+1),e.getX($+2))}const b=new Ae,m=new Ae,w=new Ae,T=new Ae;function P(L){w.fromBufferAttribute(r,L),T.copy(w);const k=c[L];b.copy(k),b.sub(w.multiplyScalar(w.dot(k))).normalize(),m.crossVectors(T,k);const z=m.dot(h[L])<0?-1:1;o.setXYZW(L,b.x,b.y,b.z,z)}for(let L=0,k=N.length;L<k;++L){const I=N[L],z=I.start,K=I.count;for(let $=z,te=z+K;$<te;$+=3)P(e.getX($+0)),P(e.getX($+1)),P(e.getX($+2))}}computeVertexNormals(){const e=this.index,i=this.getAttribute("position");if(i!==void 0){let n=this.getAttribute("normal");if(n===void 0)n=new Ur(new Float32Array(i.count*3),3),this.setAttribute("normal",n);else for(let g=0,_=n.count;g<_;g++)n.setXYZ(g,0,0,0);const r=new Ae,s=new Ae,o=new Ae,c=new Ae,h=new Ae,d=new Ae,p=new Ae,v=new Ae;if(e)for(let g=0,_=e.count;g<_;g+=3){const S=e.getX(g+0),E=e.getX(g+1),M=e.getX(g+2);r.fromBufferAttribute(i,S),s.fromBufferAttribute(i,E),o.fromBufferAttribute(i,M),p.subVectors(o,s),v.subVectors(r,s),p.cross(v),c.fromBufferAttribute(n,S),h.fromBufferAttribute(n,E),d.fromBufferAttribute(n,M),c.add(p),h.add(p),d.add(p),n.setXYZ(S,c.x,c.y,c.z),n.setXYZ(E,h.x,h.y,h.z),n.setXYZ(M,d.x,d.y,d.z)}else for(let g=0,_=i.count;g<_;g+=3)r.fromBufferAttribute(i,g+0),s.fromBufferAttribute(i,g+1),o.fromBufferAttribute(i,g+2),p.subVectors(o,s),v.subVectors(r,s),p.cross(v),n.setXYZ(g+0,p.x,p.y,p.z),n.setXYZ(g+1,p.x,p.y,p.z),n.setXYZ(g+2,p.x,p.y,p.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let i=0,n=e.count;i<n;i++)rn.fromBufferAttribute(e,i),rn.normalize(),e.setXYZ(i,rn.x,rn.y,rn.z)}toNonIndexed(){function e(c,h){const d=c.array,p=c.itemSize,v=c.normalized,g=new d.constructor(h.length*p);let _=0,S=0;for(let E=0,M=h.length;E<M;E++){c.isInterleavedBufferAttribute?_=h[E]*c.data.stride+c.offset:_=h[E]*p;for(let R=0;R<p;R++)g[S++]=d[_++]}return new Ur(g,p,v)}if(this.index===null)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const i=new Ds,n=this.index.array,r=this.attributes;for(const c in r){const h=r[c],d=e(h,n);i.setAttribute(c,d)}const s=this.morphAttributes;for(const c in s){const h=[],d=s[c];for(let p=0,v=d.length;p<v;p++){const g=d[p],_=e(g,n);h.push(_)}i.morphAttributes[c]=h}i.morphTargetsRelative=this.morphTargetsRelative;const o=this.groups;for(let c=0,h=o.length;c<h;c++){const d=o[c];i.addGroup(d.start,d.count,d.materialIndex)}return i}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,this.name!==""&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),this.parameters!==void 0){const h=this.parameters;for(const d in h)h[d]!==void 0&&(e[d]=h[d]);return e}e.data={attributes:{}};const i=this.index;i!==null&&(e.data.index={type:i.array.constructor.name,array:Array.prototype.slice.call(i.array)});const n=this.attributes;for(const h in n){const d=n[h];e.data.attributes[h]=d.toJSON(e.data)}const r={};let s=!1;for(const h in this.morphAttributes){const d=this.morphAttributes[h],p=[];for(let v=0,g=d.length;v<g;v++){const _=d[v];p.push(_.toJSON(e.data))}p.length>0&&(r[h]=p,s=!0)}s&&(e.data.morphAttributes=r,e.data.morphTargetsRelative=this.morphTargetsRelative);const o=this.groups;o.length>0&&(e.data.groups=JSON.parse(JSON.stringify(o)));const c=this.boundingSphere;return c!==null&&(e.data.boundingSphere=c.toJSON()),e}clone(){return new this.constructor().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const i={};this.name=e.name;const n=e.index;n!==null&&this.setIndex(n.clone());const r=e.attributes;for(const d in r){const p=r[d];this.setAttribute(d,p.clone(i))}const s=e.morphAttributes;for(const d in s){const p=[],v=s[d];for(let g=0,_=v.length;g<_;g++)p.push(v[g].clone(i));this.morphAttributes[d]=p}this.morphTargetsRelative=e.morphTargetsRelative;const o=e.groups;for(let d=0,p=o.length;d<p;d++){const v=o[d];this.addGroup(v.start,v.count,v.materialIndex)}const c=e.boundingBox;c!==null&&(this.boundingBox=c.clone());const h=e.boundingSphere;return h!==null&&(this.boundingSphere=h.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const wf=new Wi,Hs=new Av,Lc=new jh,xf=new Ae,Oc=new Ae,kc=new Ae,Uc=new Ae,$d=new Ae,Bc=new Ae,Ef=new Ae,Hc=new Ae;class Or extends $n{constructor(e=new Ds,i=new Vh){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=i,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,i){return super.copy(e,i),e.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),e.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const i=this.geometry.morphAttributes,n=Object.keys(i);if(n.length>0){const r=i[n[0]];if(r!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let s=0,o=r.length;s<o;s++){const c=r[s].name||String(s);this.morphTargetInfluences.push(0),this.morphTargetDictionary[c]=s}}}}getVertexPosition(e,i){const n=this.geometry,r=n.attributes.position,s=n.morphAttributes.position,o=n.morphTargetsRelative;i.fromBufferAttribute(r,e);const c=this.morphTargetInfluences;if(s&&c){Bc.set(0,0,0);for(let h=0,d=s.length;h<d;h++){const p=c[h],v=s[h];p!==0&&($d.fromBufferAttribute(v,e),o?Bc.addScaledVector($d,p):Bc.addScaledVector($d.sub(i),p))}i.add(Bc)}return i}raycast(e,i){const n=this.geometry,r=this.material,s=this.matrixWorld;r!==void 0&&(n.boundingSphere===null&&n.computeBoundingSphere(),Lc.copy(n.boundingSphere),Lc.applyMatrix4(s),Hs.copy(e.ray).recast(e.near),!(Lc.containsPoint(Hs.origin)===!1&&(Hs.intersectSphere(Lc,xf)===null||Hs.origin.distanceToSquared(xf)>(e.far-e.near)**2))&&(wf.copy(s).invert(),Hs.copy(e.ray).applyMatrix4(wf),!(n.boundingBox!==null&&Hs.intersectsBox(n.boundingBox)===!1)&&this._computeIntersections(e,i,Hs)))}_computeIntersections(e,i,n){let r;const s=this.geometry,o=this.material,c=s.index,h=s.attributes.position,d=s.attributes.uv,p=s.attributes.uv1,v=s.attributes.normal,g=s.groups,_=s.drawRange;if(c!==null)if(Array.isArray(o))for(let S=0,E=g.length;S<E;S++){const M=g[S],R=o[M.materialIndex],N=Math.max(M.start,_.start),b=Math.min(c.count,Math.min(M.start+M.count,_.start+_.count));for(let m=N,w=b;m<w;m+=3){const T=c.getX(m),P=c.getX(m+1),L=c.getX(m+2);r=jc(this,R,e,n,d,p,v,T,P,L),r&&(r.faceIndex=Math.floor(m/3),r.face.materialIndex=M.materialIndex,i.push(r))}}else{const S=Math.max(0,_.start),E=Math.min(c.count,_.start+_.count);for(let M=S,R=E;M<R;M+=3){const N=c.getX(M),b=c.getX(M+1),m=c.getX(M+2);r=jc(this,o,e,n,d,p,v,N,b,m),r&&(r.faceIndex=Math.floor(M/3),i.push(r))}}else if(h!==void 0)if(Array.isArray(o))for(let S=0,E=g.length;S<E;S++){const M=g[S],R=o[M.materialIndex],N=Math.max(M.start,_.start),b=Math.min(h.count,Math.min(M.start+M.count,_.start+_.count));for(let m=N,w=b;m<w;m+=3){const T=m,P=m+1,L=m+2;r=jc(this,R,e,n,d,p,v,T,P,L),r&&(r.faceIndex=Math.floor(m/3),r.face.materialIndex=M.materialIndex,i.push(r))}}else{const S=Math.max(0,_.start),E=Math.min(h.count,_.start+_.count);for(let M=S,R=E;M<R;M+=3){const N=M,b=M+1,m=M+2;r=jc(this,o,e,n,d,p,v,N,b,m),r&&(r.faceIndex=Math.floor(M/3),i.push(r))}}}}function NC(t,e,i,n,r,s,o,c){let h;if(e.side===Un?h=n.intersectTriangle(o,s,r,!0,c):h=n.intersectTriangle(r,s,o,e.side===Rs,c),h===null)return null;Hc.copy(c),Hc.applyMatrix4(t.matrixWorld);const d=i.ray.origin.distanceTo(Hc);return d<i.near||d>i.far?null:{distance:d,point:Hc.clone(),object:t}}function jc(t,e,i,n,r,s,o,c,h,d){t.getVertexPosition(c,Oc),t.getVertexPosition(h,kc),t.getVertexPosition(d,Uc);const p=NC(t,e,i,n,Oc,kc,Uc,Ef);if(p){const v=new Ae;yr.getBarycoord(Ef,Oc,kc,Uc,v),r&&(p.uv=yr.getInterpolatedAttribute(r,c,h,d,v,new $t)),s&&(p.uv1=yr.getInterpolatedAttribute(s,c,h,d,v,new $t)),o&&(p.normal=yr.getInterpolatedAttribute(o,c,h,d,v,new Ae),p.normal.dot(n.direction)>0&&p.normal.multiplyScalar(-1));const g={a:c,b:h,c:d,normal:new Ae,materialIndex:0};yr.getNormal(Oc,kc,Uc,g.normal),p.face=g,p.barycoord=v}return p}class tc extends Ds{constructor(e=1,i=1,n=1,r=1,s=1,o=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:i,depth:n,widthSegments:r,heightSegments:s,depthSegments:o};const c=this;r=Math.floor(r),s=Math.floor(s),o=Math.floor(o);const h=[],d=[],p=[],v=[];let g=0,_=0;S("z","y","x",-1,-1,n,i,e,o,s,0),S("z","y","x",1,-1,n,i,-e,o,s,1),S("x","z","y",1,1,e,n,i,r,o,2),S("x","z","y",1,-1,e,n,-i,r,o,3),S("x","y","z",1,-1,e,i,n,r,s,4),S("x","y","z",-1,-1,e,i,-n,r,s,5),this.setIndex(h),this.setAttribute("position",new Br(d,3)),this.setAttribute("normal",new Br(p,3)),this.setAttribute("uv",new Br(v,2));function S(E,M,R,N,b,m,w,T,P,L,k){const I=m/P,z=w/L,K=m/2,$=w/2,te=T/2,ee=P+1,de=L+1;let X=0,le=0;const _e=new Ae;for(let Se=0;Se<de;Se++){const De=Se*z-$;for(let We=0;We<ee;We++){const Ve=We*I-K;_e[E]=Ve*N,_e[M]=De*b,_e[R]=te,d.push(_e.x,_e.y,_e.z),_e[E]=0,_e[M]=0,_e[R]=T>0?1:-1,p.push(_e.x,_e.y,_e.z),v.push(We/P),v.push(1-Se/L),X+=1}}for(let Se=0;Se<L;Se++)for(let De=0;De<P;De++){const We=g+De+ee*Se,Ve=g+De+ee*(Se+1),Me=g+(De+1)+ee*(Se+1),ze=g+(De+1)+ee*Se;h.push(We,Ve,ze),h.push(Ve,Me,ze),le+=6}c.addGroup(_,le,k),_+=le,g+=X}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new tc(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function Qa(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const r=t[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),e[i][n]=null):e[i][n]=r.clone():Array.isArray(r)?e[i][n]=r.slice():e[i][n]=r}}return e}function xn(t){const e={};for(let i=0;i<t.length;i++){const n=Qa(t[i]);for(const r in n)e[r]=n[r]}return e}function LC(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].clone());return e}function Lv(t){const e=t.getRenderTarget();return e===null?t.outputColorSpace:e.isXRRenderTarget===!0?e.texture.colorSpace:ci.workingColorSpace}const OC={clone:Qa,merge:xn};var kC=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,UC=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;class Ms extends ql{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=kC,this.fragmentShader=UC,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,e!==void 0&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Qa(e.uniforms),this.uniformsGroups=LC(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const i=super.toJSON(e);i.glslVersion=this.glslVersion,i.uniforms={};for(const r in this.uniforms){const o=this.uniforms[r].value;o&&o.isTexture?i.uniforms[r]={type:"t",value:o.toJSON(e).uuid}:o&&o.isColor?i.uniforms[r]={type:"c",value:o.getHex()}:o&&o.isVector2?i.uniforms[r]={type:"v2",value:o.toArray()}:o&&o.isVector3?i.uniforms[r]={type:"v3",value:o.toArray()}:o&&o.isVector4?i.uniforms[r]={type:"v4",value:o.toArray()}:o&&o.isMatrix3?i.uniforms[r]={type:"m3",value:o.toArray()}:o&&o.isMatrix4?i.uniforms[r]={type:"m4",value:o.toArray()}:i.uniforms[r]={value:o}}Object.keys(this.defines).length>0&&(i.defines=this.defines),i.vertexShader=this.vertexShader,i.fragmentShader=this.fragmentShader,i.lights=this.lights,i.clipping=this.clipping;const n={};for(const r in this.extensions)this.extensions[r]===!0&&(n[r]=!0);return Object.keys(n).length>0&&(i.extensions=n),i}}class Ov extends $n{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Wi,this.projectionMatrix=new Wi,this.projectionMatrixInverse=new Wi,this.coordinateSystem=ts}copy(e,i){return super.copy(e,i),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,i){super.updateWorldMatrix(e,i),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}const vs=new Ae,Cf=new $t,Tf=new $t;class rr extends Ov{constructor(e=50,i=1,n=.1,r=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=r,this.focus=10,this.aspect=i,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,i){return super.copy(e,i),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=e.view===null?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const i=.5*this.getFilmHeight()/e;this.fov=hh*2*Math.atan(i),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(ol*.5*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return hh*2*Math.atan(Math.tan(ol*.5*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,i,n){vs.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(vs.x,vs.y).multiplyScalar(-e/vs.z),vs.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set(vs.x,vs.y).multiplyScalar(-e/vs.z)}getViewSize(e,i){return this.getViewBounds(e,Cf,Tf),i.subVectors(Tf,Cf)}setViewOffset(e,i,n,r,s,o){this.aspect=e/i,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=i,this.view.offsetX=n,this.view.offsetY=r,this.view.width=s,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let i=e*Math.tan(ol*.5*this.fov)/this.zoom,n=2*i,r=this.aspect*n,s=-.5*r;const o=this.view;if(this.view!==null&&this.view.enabled){const h=o.fullWidth,d=o.fullHeight;s+=o.offsetX*r/h,i-=o.offsetY*n/d,r*=o.width/h,n*=o.height/d}const c=this.filmOffset;c!==0&&(s+=e*c/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+r,i,i-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const i=super.toJSON(e);return i.object.fov=this.fov,i.object.zoom=this.zoom,i.object.near=this.near,i.object.far=this.far,i.object.focus=this.focus,i.object.aspect=this.aspect,this.view!==null&&(i.object.view=Object.assign({},this.view)),i.object.filmGauge=this.filmGauge,i.object.filmOffset=this.filmOffset,i}}const Ta=-90,Ra=1;class BC extends $n{constructor(e,i,n){super(),this.type="CubeCamera",this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;const r=new rr(Ta,Ra,e,i);r.layers=this.layers,this.add(r);const s=new rr(Ta,Ra,e,i);s.layers=this.layers,this.add(s);const o=new rr(Ta,Ra,e,i);o.layers=this.layers,this.add(o);const c=new rr(Ta,Ra,e,i);c.layers=this.layers,this.add(c);const h=new rr(Ta,Ra,e,i);h.layers=this.layers,this.add(h);const d=new rr(Ta,Ra,e,i);d.layers=this.layers,this.add(d)}updateCoordinateSystem(){const e=this.coordinateSystem,i=this.children.concat(),[n,r,s,o,c,h]=i;for(const d of i)this.remove(d);if(e===ts)n.up.set(0,1,0),n.lookAt(1,0,0),r.up.set(0,1,0),r.lookAt(-1,0,0),s.up.set(0,0,-1),s.lookAt(0,1,0),o.up.set(0,0,1),o.lookAt(0,-1,0),c.up.set(0,1,0),c.lookAt(0,0,1),h.up.set(0,1,0),h.lookAt(0,0,-1);else if(e===wl)n.up.set(0,-1,0),n.lookAt(-1,0,0),r.up.set(0,-1,0),r.lookAt(1,0,0),s.up.set(0,0,1),s.lookAt(0,1,0),o.up.set(0,0,-1),o.lookAt(0,-1,0),c.up.set(0,-1,0),c.lookAt(0,0,1),h.up.set(0,-1,0),h.lookAt(0,0,-1);else throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);for(const d of i)this.add(d),d.updateMatrixWorld()}update(e,i){this.parent===null&&this.updateMatrixWorld();const{renderTarget:n,activeMipmapLevel:r}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[s,o,c,h,d,p]=this.children,v=e.getRenderTarget(),g=e.getActiveCubeFace(),_=e.getActiveMipmapLevel(),S=e.xr.enabled;e.xr.enabled=!1;const E=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,r),e.render(i,s),e.setRenderTarget(n,1,r),e.render(i,o),e.setRenderTarget(n,2,r),e.render(i,c),e.setRenderTarget(n,3,r),e.render(i,h),e.setRenderTarget(n,4,r),e.render(i,d),n.texture.generateMipmaps=E,e.setRenderTarget(n,5,r),e.render(i,p),e.setRenderTarget(v,g,_),e.xr.enabled=S,n.texture.needsPMREMUpdate=!0}}class kv extends Tn{constructor(e=[],i=Za,n,r,s,o,c,h,d,p){super(e,i,n,r,s,o,c,h,d,p),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class HC extends aa{constructor(e=1,i={}){super(e,e,i),this.isWebGLCubeRenderTarget=!0;const n={width:e,height:e,depth:1},r=[n,n,n,n,n,n];this.texture=new kv(r),this._setTextureOptions(i),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,i){this.texture.type=i.type,this.texture.colorSpace=i.colorSpace,this.texture.generateMipmaps=i.generateMipmaps,this.texture.minFilter=i.minFilter,this.texture.magFilter=i.magFilter;const n={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},r=new tc(5,5,5),s=new Ms({name:"CubemapFromEquirect",uniforms:Qa(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:Un,blending:ws});s.uniforms.tEquirect.value=i;const o=new Or(r,s),c=i.minFilter;return i.minFilter===Js&&(i.minFilter=On),new BC(1,10,this).update(e,o),i.minFilter=c,o.geometry.dispose(),o.material.dispose(),this}clear(e,i=!0,n=!0,r=!0){const s=e.getRenderTarget();for(let o=0;o<6;o++)e.setRenderTarget(this,o),e.clear(i,n,r);e.setRenderTarget(s)}}class Vc extends $n{constructor(){super(),this.isGroup=!0,this.type="Group"}}const jC={type:"move"};class Zd{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new Vc,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new Vc,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Ae,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Ae),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new Vc,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Ae,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Ae),this._grip}dispatchEvent(e){return this._targetRay!==null&&this._targetRay.dispatchEvent(e),this._grip!==null&&this._grip.dispatchEvent(e),this._hand!==null&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const i=this._hand;if(i)for(const n of e.hand.values())this._getHandJoint(i,n)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(e,i,n){let r=null,s=null,o=null;const c=this._targetRay,h=this._grip,d=this._hand;if(e&&i.session.visibilityState!=="visible-blurred"){if(d&&e.hand){o=!0;for(const E of e.hand.values()){const M=i.getJointPose(E,n),R=this._getHandJoint(d,E);M!==null&&(R.matrix.fromArray(M.transform.matrix),R.matrix.decompose(R.position,R.rotation,R.scale),R.matrixWorldNeedsUpdate=!0,R.jointRadius=M.radius),R.visible=M!==null}const p=d.joints["index-finger-tip"],v=d.joints["thumb-tip"],g=p.position.distanceTo(v.position),_=.02,S=.005;d.inputState.pinching&&g>_+S?(d.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!d.inputState.pinching&&g<=_-S&&(d.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else h!==null&&e.gripSpace&&(s=i.getPose(e.gripSpace,n),s!==null&&(h.matrix.fromArray(s.transform.matrix),h.matrix.decompose(h.position,h.rotation,h.scale),h.matrixWorldNeedsUpdate=!0,s.linearVelocity?(h.hasLinearVelocity=!0,h.linearVelocity.copy(s.linearVelocity)):h.hasLinearVelocity=!1,s.angularVelocity?(h.hasAngularVelocity=!0,h.angularVelocity.copy(s.angularVelocity)):h.hasAngularVelocity=!1));c!==null&&(r=i.getPose(e.targetRaySpace,n),r===null&&s!==null&&(r=s),r!==null&&(c.matrix.fromArray(r.transform.matrix),c.matrix.decompose(c.position,c.rotation,c.scale),c.matrixWorldNeedsUpdate=!0,r.linearVelocity?(c.hasLinearVelocity=!0,c.linearVelocity.copy(r.linearVelocity)):c.hasLinearVelocity=!1,r.angularVelocity?(c.hasAngularVelocity=!0,c.angularVelocity.copy(r.angularVelocity)):c.hasAngularVelocity=!1,this.dispatchEvent(jC)))}return c!==null&&(c.visible=r!==null),h!==null&&(h.visible=s!==null),d!==null&&(d.visible=o!==null),this}_getHandJoint(e,i){if(e.joints[i.jointName]===void 0){const n=new Vc;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[i.jointName]=n,e.add(n)}return e.joints[i.jointName]}}class VC extends $n{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new as,this.environmentIntensity=1,this.environmentRotation=new as,this.overrideMaterial=null,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,i){return super.copy(e,i),e.background!==null&&(this.background=e.background.clone()),e.environment!==null&&(this.environment=e.environment.clone()),e.fog!==null&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),e.overrideMaterial!==null&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const i=super.toJSON(e);return this.fog!==null&&(i.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(i.object.backgroundBlurriness=this.backgroundBlurriness),this.backgroundIntensity!==1&&(i.object.backgroundIntensity=this.backgroundIntensity),i.object.backgroundRotation=this.backgroundRotation.toArray(),this.environmentIntensity!==1&&(i.object.environmentIntensity=this.environmentIntensity),i.object.environmentRotation=this.environmentRotation.toArray(),i}}const Yd=new Ae,zC=new Ae,GC=new qt;class bs{constructor(e=new Ae(1,0,0),i=0){this.isPlane=!0,this.normal=e,this.constant=i}set(e,i){return this.normal.copy(e),this.constant=i,this}setComponents(e,i,n,r){return this.normal.set(e,i,n),this.constant=r,this}setFromNormalAndCoplanarPoint(e,i){return this.normal.copy(e),this.constant=-i.dot(this.normal),this}setFromCoplanarPoints(e,i,n){const r=Yd.subVectors(n,i).cross(zC.subVectors(e,i)).normalize();return this.setFromNormalAndCoplanarPoint(r,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,i){return i.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,i){const n=e.delta(Yd),r=this.normal.dot(n);if(r===0)return this.distanceToPoint(e.start)===0?i.copy(e.start):null;const s=-(e.start.dot(this.normal)+this.constant)/r;return s<0||s>1?null:i.copy(e.start).addScaledVector(n,s)}intersectsLine(e){const i=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return i<0&&n>0||n<0&&i>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,i){const n=i||GC.getNormalMatrix(e),r=this.coplanarPoint(Yd).applyMatrix4(e),s=this.normal.applyMatrix3(n).normalize();return this.constant=-r.dot(s),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}const js=new jh,zc=new Ae;class Uv{constructor(e=new bs,i=new bs,n=new bs,r=new bs,s=new bs,o=new bs){this.planes=[e,i,n,r,s,o]}set(e,i,n,r,s,o){const c=this.planes;return c[0].copy(e),c[1].copy(i),c[2].copy(n),c[3].copy(r),c[4].copy(s),c[5].copy(o),this}copy(e){const i=this.planes;for(let n=0;n<6;n++)i[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,i=ts){const n=this.planes,r=e.elements,s=r[0],o=r[1],c=r[2],h=r[3],d=r[4],p=r[5],v=r[6],g=r[7],_=r[8],S=r[9],E=r[10],M=r[11],R=r[12],N=r[13],b=r[14],m=r[15];if(n[0].setComponents(h-s,g-d,M-_,m-R).normalize(),n[1].setComponents(h+s,g+d,M+_,m+R).normalize(),n[2].setComponents(h+o,g+p,M+S,m+N).normalize(),n[3].setComponents(h-o,g-p,M-S,m-N).normalize(),n[4].setComponents(h-c,g-v,M-E,m-b).normalize(),i===ts)n[5].setComponents(h+c,g+v,M+E,m+b).normalize();else if(i===wl)n[5].setComponents(c,v,E,b).normalize();else throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+i);return this}intersectsObject(e){if(e.boundingSphere!==void 0)e.boundingSphere===null&&e.computeBoundingSphere(),js.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const i=e.geometry;i.boundingSphere===null&&i.computeBoundingSphere(),js.copy(i.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(js)}intersectsSprite(e){return js.center.set(0,0,0),js.radius=.7071067811865476,js.applyMatrix4(e.matrixWorld),this.intersectsSphere(js)}intersectsSphere(e){const i=this.planes,n=e.center,r=-e.radius;for(let s=0;s<6;s++)if(i[s].distanceToPoint(n)<r)return!1;return!0}intersectsBox(e){const i=this.planes;for(let n=0;n<6;n++){const r=i[n];if(zc.x=r.normal.x>0?e.max.x:e.min.x,zc.y=r.normal.y>0?e.max.y:e.min.y,zc.z=r.normal.z>0?e.max.z:e.min.z,r.distanceToPoint(zc)<0)return!1}return!0}containsPoint(e){const i=this.planes;for(let n=0;n<6;n++)if(i[n].distanceToPoint(e)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}class qC extends Tn{constructor(e,i,n,r,s=On,o=On,c,h,d){super(e,i,n,r,s,o,c,h,d),this.isVideoTexture=!0,this.generateMipmaps=!1;const p=this;function v(){p.needsUpdate=!0,e.requestVideoFrameCallback(v)}"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback(v)}clone(){return new this.constructor(this.image).copy(this)}update(){const e=this.image;"requestVideoFrameCallback"in e===!1&&e.readyState>=e.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}class Bv extends Tn{constructor(e,i,n=ra,r,s,o,c=Er,h=Er,d,p=Wo,v=1){if(p!==Wo&&p!==Ko)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");const g={width:e,height:i,depth:v};super(g,r,s,o,c,h,p,n,d),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new Hh(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const i=super.toJSON(e);return this.compareFunction!==null&&(i.compareFunction=this.compareFunction),i}}class Wl extends Ds{constructor(e=1,i=1,n=1,r=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:i,widthSegments:n,heightSegments:r};const s=e/2,o=i/2,c=Math.floor(n),h=Math.floor(r),d=c+1,p=h+1,v=e/c,g=i/h,_=[],S=[],E=[],M=[];for(let R=0;R<p;R++){const N=R*g-o;for(let b=0;b<d;b++){const m=b*v-s;S.push(m,-N,0),E.push(0,0,1),M.push(b/c),M.push(1-R/h)}}for(let R=0;R<h;R++)for(let N=0;N<c;N++){const b=N+d*R,m=N+d*(R+1),w=N+1+d*(R+1),T=N+1+d*R;_.push(b,m,T),_.push(m,w,T)}this.setIndex(_),this.setAttribute("position",new Br(S,3)),this.setAttribute("normal",new Br(E,3)),this.setAttribute("uv",new Br(M,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Wl(e.width,e.height,e.widthSegments,e.heightSegments)}}class zh extends Ds{constructor(e=1,i=32,n=16,r=0,s=Math.PI*2,o=0,c=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:i,heightSegments:n,phiStart:r,phiLength:s,thetaStart:o,thetaLength:c},i=Math.max(3,Math.floor(i)),n=Math.max(2,Math.floor(n));const h=Math.min(o+c,Math.PI);let d=0;const p=[],v=new Ae,g=new Ae,_=[],S=[],E=[],M=[];for(let R=0;R<=n;R++){const N=[],b=R/n;let m=0;R===0&&o===0?m=.5/i:R===n&&h===Math.PI&&(m=-.5/i);for(let w=0;w<=i;w++){const T=w/i;v.x=-e*Math.cos(r+T*s)*Math.sin(o+b*c),v.y=e*Math.cos(o+b*c),v.z=e*Math.sin(r+T*s)*Math.sin(o+b*c),S.push(v.x,v.y,v.z),g.copy(v).normalize(),E.push(g.x,g.y,g.z),M.push(T+m,1-b),N.push(d++)}p.push(N)}for(let R=0;R<n;R++)for(let N=0;N<i;N++){const b=p[R][N+1],m=p[R][N],w=p[R+1][N],T=p[R+1][N+1];(R!==0||o>0)&&_.push(b,m,T),(R!==n-1||h<Math.PI)&&_.push(m,w,T)}this.setIndex(_),this.setAttribute("position",new Br(S,3)),this.setAttribute("normal",new Br(E,3)),this.setAttribute("uv",new Br(M,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new zh(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class WC extends ql{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=tC,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class KC extends ql{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}class XC extends Ov{constructor(e=-1,i=1,n=1,r=-1,s=.1,o=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=i,this.top=n,this.bottom=r,this.near=s,this.far=o,this.updateProjectionMatrix()}copy(e,i){return super.copy(e,i),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=e.view===null?null:Object.assign({},e.view),this}setViewOffset(e,i,n,r,s,o){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=i,this.view.offsetX=n,this.view.offsetY=r,this.view.width=s,this.view.height=o,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),i=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,r=(this.top+this.bottom)/2;let s=n-e,o=n+e,c=r+i,h=r-i;if(this.view!==null&&this.view.enabled){const d=(this.right-this.left)/this.view.fullWidth/this.zoom,p=(this.top-this.bottom)/this.view.fullHeight/this.zoom;s+=d*this.view.offsetX,o=s+d*this.view.width,c-=p*this.view.offsetY,h=c-p*this.view.height}this.projectionMatrix.makeOrthographic(s,o,c,h,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const i=super.toJSON(e);return i.object.zoom=this.zoom,i.object.left=this.left,i.object.right=this.right,i.object.top=this.top,i.object.bottom=this.bottom,i.object.near=this.near,i.object.far=this.far,this.view!==null&&(i.object.view=Object.assign({},this.view)),i}}class $C extends rr{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class Rf{constructor(e=1,i=0,n=0){this.radius=e,this.phi=i,this.theta=n}set(e,i,n){return this.radius=e,this.phi=i,this.theta=n,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){return this.phi=Qt(this.phi,1e-6,Math.PI-1e-6),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,i,n){return this.radius=Math.sqrt(e*e+i*i+n*n),this.radius===0?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,n),this.phi=Math.acos(Qt(i/this.radius,-1,1))),this}clone(){return new this.constructor().copy(this)}}class ZC extends la{constructor(e,i=null){super(),this.object=e,this.domElement=i,this.enabled=!0,this.state=-1,this.keys={},this.mouseButtons={LEFT:null,MIDDLE:null,RIGHT:null},this.touches={ONE:null,TWO:null}}connect(e){if(e===void 0){console.warn("THREE.Controls: connect() now requires an element.");return}this.domElement!==null&&this.disconnect(),this.domElement=e}disconnect(){}dispose(){}update(){}}function Mf(t,e,i,n){const r=YC(n);switch(i){case xv:return t*e;case Ev:return t*e/r.components*r.byteLength;case kh:return t*e/r.components*r.byteLength;case Cv:return t*e*2/r.components*r.byteLength;case Uh:return t*e*2/r.components*r.byteLength;case Oh:return t*e*3/r.components*r.byteLength;case Sr:return t*e*4/r.components*r.byteLength;case Bh:return t*e*4/r.components*r.byteLength;case il:case nl:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*8;case rl:case sl:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*16;case ju:case zu:return Math.max(t,16)*Math.max(e,8)/4;case Hu:case Vu:return Math.max(t,8)*Math.max(e,8)/2;case Gu:case qu:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*8;case Wu:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*16;case Ku:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*16;case Xu:return Math.floor((t+4)/5)*Math.floor((e+3)/4)*16;case $u:return Math.floor((t+4)/5)*Math.floor((e+4)/5)*16;case Zu:return Math.floor((t+5)/6)*Math.floor((e+4)/5)*16;case Yu:return Math.floor((t+5)/6)*Math.floor((e+5)/6)*16;case Ju:return Math.floor((t+7)/8)*Math.floor((e+4)/5)*16;case Qu:return Math.floor((t+7)/8)*Math.floor((e+5)/6)*16;case eh:return Math.floor((t+7)/8)*Math.floor((e+7)/8)*16;case th:return Math.floor((t+9)/10)*Math.floor((e+4)/5)*16;case ih:return Math.floor((t+9)/10)*Math.floor((e+5)/6)*16;case nh:return Math.floor((t+9)/10)*Math.floor((e+7)/8)*16;case rh:return Math.floor((t+9)/10)*Math.floor((e+9)/10)*16;case sh:return Math.floor((t+11)/12)*Math.floor((e+9)/10)*16;case ah:return Math.floor((t+11)/12)*Math.floor((e+11)/12)*16;case al:case oh:case ch:return Math.ceil(t/4)*Math.ceil(e/4)*16;case Tv:case lh:return Math.ceil(t/4)*Math.ceil(e/4)*8;case dh:case uh:return Math.ceil(t/4)*Math.ceil(e/4)*16}throw new Error(`Unable to determine texture byte length for ${i} format.`)}function YC(t){switch(t){case ss:case yv:return{byteLength:1,components:1};case Go:case Sv:case Jo:return{byteLength:2,components:1};case Nh:case Lh:return{byteLength:2,components:4};case ra:case Fh:case es:return{byteLength:4,components:1};case wv:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${t}.`)}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:Ih}}));typeof window<"u"&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=Ih);/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */function Hv(){let t=null,e=!1,i=null,n=null;function r(s,o){i(s,o),n=t.requestAnimationFrame(r)}return{start:function(){e!==!0&&i!==null&&(n=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(n),e=!1},setAnimationLoop:function(s){i=s},setContext:function(s){t=s}}}function JC(t){const e=new WeakMap;function i(c,h){const d=c.array,p=c.usage,v=d.byteLength,g=t.createBuffer();t.bindBuffer(h,g),t.bufferData(h,d,p),c.onUploadCallback();let _;if(d instanceof Float32Array)_=t.FLOAT;else if(d instanceof Uint16Array)c.isFloat16BufferAttribute?_=t.HALF_FLOAT:_=t.UNSIGNED_SHORT;else if(d instanceof Int16Array)_=t.SHORT;else if(d instanceof Uint32Array)_=t.UNSIGNED_INT;else if(d instanceof Int32Array)_=t.INT;else if(d instanceof Int8Array)_=t.BYTE;else if(d instanceof Uint8Array)_=t.UNSIGNED_BYTE;else if(d instanceof Uint8ClampedArray)_=t.UNSIGNED_BYTE;else throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+d);return{buffer:g,type:_,bytesPerElement:d.BYTES_PER_ELEMENT,version:c.version,size:v}}function n(c,h,d){const p=h.array,v=h.updateRanges;if(t.bindBuffer(d,c),v.length===0)t.bufferSubData(d,0,p);else{v.sort((_,S)=>_.start-S.start);let g=0;for(let _=1;_<v.length;_++){const S=v[g],E=v[_];E.start<=S.start+S.count+1?S.count=Math.max(S.count,E.start+E.count-S.start):(++g,v[g]=E)}v.length=g+1;for(let _=0,S=v.length;_<S;_++){const E=v[_];t.bufferSubData(d,E.start*p.BYTES_PER_ELEMENT,p,E.start,E.count)}h.clearUpdateRanges()}h.onUploadCallback()}function r(c){return c.isInterleavedBufferAttribute&&(c=c.data),e.get(c)}function s(c){c.isInterleavedBufferAttribute&&(c=c.data);const h=e.get(c);h&&(t.deleteBuffer(h.buffer),e.delete(c))}function o(c,h){if(c.isInterleavedBufferAttribute&&(c=c.data),c.isGLBufferAttribute){const p=e.get(c);(!p||p.version<c.version)&&e.set(c,{buffer:c.buffer,type:c.type,bytesPerElement:c.elementSize,version:c.version});return}const d=e.get(c);if(d===void 0)e.set(c,i(c,h));else if(d.version<c.version){if(d.size!==c.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");n(d.buffer,c,h),d.version=c.version}}return{get:r,remove:s,update:o}}var QC=`#ifdef USE_ALPHAHASH
	if ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;
#endif`,eT=`#ifdef USE_ALPHAHASH
	const float ALPHA_HASH_SCALE = 0.05;
	float hash2D( vec2 value ) {
		return fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );
	}
	float hash3D( vec3 value ) {
		return hash2D( vec2( hash2D( value.xy ), value.z ) );
	}
	float getAlphaHashThreshold( vec3 position ) {
		float maxDeriv = max(
			length( dFdx( position.xyz ) ),
			length( dFdy( position.xyz ) )
		);
		float pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );
		vec2 pixScales = vec2(
			exp2( floor( log2( pixScale ) ) ),
			exp2( ceil( log2( pixScale ) ) )
		);
		vec2 alpha = vec2(
			hash3D( floor( pixScales.x * position.xyz ) ),
			hash3D( floor( pixScales.y * position.xyz ) )
		);
		float lerpFactor = fract( log2( pixScale ) );
		float x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;
		float a = min( lerpFactor, 1.0 - lerpFactor );
		vec3 cases = vec3(
			x * x / ( 2.0 * a * ( 1.0 - a ) ),
			( x - 0.5 * a ) / ( 1.0 - a ),
			1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )
		);
		float threshold = ( x < ( 1.0 - a ) )
			? ( ( x < a ) ? cases.x : cases.y )
			: cases.z;
		return clamp( threshold , 1.0e-6, 1.0 );
	}
#endif`,tT=`#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;
#endif`,iT=`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,nT=`#ifdef USE_ALPHATEST
	#ifdef ALPHA_TO_COVERAGE
	diffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );
	if ( diffuseColor.a == 0.0 ) discard;
	#else
	if ( diffuseColor.a < alphaTest ) discard;
	#endif
#endif`,rT=`#ifdef USE_ALPHATEST
	uniform float alphaTest;
#endif`,sT=`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_CLEARCOAT ) 
		clearcoatSpecularIndirect *= ambientOcclusion;
	#endif
	#if defined( USE_SHEEN ) 
		sheenSpecularIndirect *= ambientOcclusion;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometryNormal, geometryViewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );
	#endif
#endif`,aT=`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,oT=`#ifdef USE_BATCHING
	#if ! defined( GL_ANGLE_multi_draw )
	#define gl_DrawID _gl_DrawID
	uniform int _gl_DrawID;
	#endif
	uniform highp sampler2D batchingTexture;
	uniform highp usampler2D batchingIdTexture;
	mat4 getBatchingMatrix( const in float i ) {
		int size = textureSize( batchingTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );
		return mat4( v1, v2, v3, v4 );
	}
	float getIndirectIndex( const in int i ) {
		int size = textureSize( batchingIdTexture, 0 ).x;
		int x = i % size;
		int y = i / size;
		return float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );
	}
#endif
#ifdef USE_BATCHING_COLOR
	uniform sampler2D batchingColorTexture;
	vec3 getBatchingColor( const in float i ) {
		int size = textureSize( batchingColorTexture, 0 ).x;
		int j = int( i );
		int x = j % size;
		int y = j / size;
		return texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;
	}
#endif`,cT=`#ifdef USE_BATCHING
	mat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );
#endif`,lT=`vec3 transformed = vec3( position );
#ifdef USE_ALPHAHASH
	vPosition = vec3( position );
#endif`,dT=`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,uT=`float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( specularColor, 1.0, dotVH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
} // validated`,hT=`#ifdef USE_IRIDESCENCE
	const mat3 XYZ_TO_REC709 = mat3(
		 3.2404542, -0.9692660,  0.0556434,
		-1.5371385,  1.8760108, -0.2040259,
		-0.4985314,  0.0415560,  1.0572252
	);
	vec3 Fresnel0ToIor( vec3 fresnel0 ) {
		vec3 sqrtF0 = sqrt( fresnel0 );
		return ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );
	}
	vec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );
	}
	float IorToFresnel0( float transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));
	}
	vec3 evalSensitivity( float OPD, vec3 shift ) {
		float phase = 2.0 * PI * OPD * 1.0e-9;
		vec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );
		vec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );
		vec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );
		vec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );
		xyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );
		xyz /= 1.0685e-7;
		vec3 rgb = XYZ_TO_REC709 * xyz;
		return rgb;
	}
	vec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {
		vec3 I;
		float iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );
		float sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );
		float cosTheta2Sq = 1.0 - sinTheta2Sq;
		if ( cosTheta2Sq < 0.0 ) {
			return vec3( 1.0 );
		}
		float cosTheta2 = sqrt( cosTheta2Sq );
		float R0 = IorToFresnel0( iridescenceIOR, outsideIOR );
		float R12 = F_Schlick( R0, 1.0, cosTheta1 );
		float T121 = 1.0 - R12;
		float phi12 = 0.0;
		if ( iridescenceIOR < outsideIOR ) phi12 = PI;
		float phi21 = PI - phi12;
		vec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );		vec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );
		vec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );
		vec3 phi23 = vec3( 0.0 );
		if ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;
		if ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;
		if ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;
		float OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;
		vec3 phi = vec3( phi21 ) + phi23;
		vec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );
		vec3 r123 = sqrt( R123 );
		vec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );
		vec3 C0 = R12 + Rs;
		I = C0;
		vec3 Cm = Rs - T121;
		for ( int m = 1; m <= 2; ++ m ) {
			Cm *= r123;
			vec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );
			I += Cm * Sm;
		}
		return max( I, vec3( 0.0 ) );
	}
#endif`,pT=`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vBumpMapUv );
		vec2 dSTdy = dFdy( vBumpMapUv );
		float Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {
		vec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );
		vec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 ) * faceDirection;
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,fT=`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#ifdef ALPHA_TO_COVERAGE
		float distanceToPlane, distanceGradient;
		float clipOpacity = 1.0;
		#pragma unroll_loop_start
		for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			distanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;
			distanceGradient = fwidth( distanceToPlane ) / 2.0;
			clipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );
			if ( clipOpacity == 0.0 ) discard;
		}
		#pragma unroll_loop_end
		#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
			float unionClipOpacity = 1.0;
			#pragma unroll_loop_start
			for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
				plane = clippingPlanes[ i ];
				distanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;
				distanceGradient = fwidth( distanceToPlane ) / 2.0;
				unionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );
			}
			#pragma unroll_loop_end
			clipOpacity *= 1.0 - unionClipOpacity;
		#endif
		diffuseColor.a *= clipOpacity;
		if ( diffuseColor.a == 0.0 ) discard;
	#else
		#pragma unroll_loop_start
		for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
		}
		#pragma unroll_loop_end
		#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
			bool clipped = true;
			#pragma unroll_loop_start
			for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
				plane = clippingPlanes[ i ];
				clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
			}
			#pragma unroll_loop_end
			if ( clipped ) discard;
		#endif
	#endif
#endif`,mT=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,gT=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,vT=`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,_T=`#if defined( USE_COLOR_ALPHA )
	diffuseColor *= vColor;
#elif defined( USE_COLOR )
	diffuseColor.rgb *= vColor;
#endif`,bT=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR )
	varying vec3 vColor;
#endif`,yT=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )
	varying vec3 vColor;
#endif`,ST=`#if defined( USE_COLOR_ALPHA )
	vColor = vec4( 1.0 );
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )
	vColor = vec3( 1.0 );
#endif
#ifdef USE_COLOR
	vColor *= color;
#endif
#ifdef USE_INSTANCING_COLOR
	vColor.xyz *= instanceColor.xyz;
#endif
#ifdef USE_BATCHING_COLOR
	vec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );
	vColor.xyz *= batchingColor.xyz;
#endif`,wT=`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement( a ) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
vec3 pow2( const in vec3 x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }
float average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract( sin( sn ) * c );
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
#ifdef USE_ALPHAHASH
	varying vec3 vPosition;
#endif
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
mat3 transposeMat3( const in mat3 m ) {
	mat3 tmp;
	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );
	return tmp;
}
bool isPerspectiveMatrix( mat4 m ) {
	return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}
vec3 BRDF_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
}
float F_Schlick( const in float f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
} // validated`,xT=`#ifdef ENVMAP_TYPE_CUBE_UV
	#define cubeUV_minMipLevel 4.0
	#define cubeUV_minTileSize 16.0
	float getFace( vec3 direction ) {
		vec3 absDirection = abs( direction );
		float face = - 1.0;
		if ( absDirection.x > absDirection.z ) {
			if ( absDirection.x > absDirection.y )
				face = direction.x > 0.0 ? 0.0 : 3.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		} else {
			if ( absDirection.z > absDirection.y )
				face = direction.z > 0.0 ? 2.0 : 5.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		}
		return face;
	}
	vec2 getUV( vec3 direction, float face ) {
		vec2 uv;
		if ( face == 0.0 ) {
			uv = vec2( direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 1.0 ) {
			uv = vec2( - direction.x, - direction.z ) / abs( direction.y );
		} else if ( face == 2.0 ) {
			uv = vec2( - direction.x, direction.y ) / abs( direction.z );
		} else if ( face == 3.0 ) {
			uv = vec2( - direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 4.0 ) {
			uv = vec2( - direction.x, direction.z ) / abs( direction.y );
		} else {
			uv = vec2( direction.x, direction.y ) / abs( direction.z );
		}
		return 0.5 * ( uv + 1.0 );
	}
	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {
		float face = getFace( direction );
		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );
		mipInt = max( mipInt, cubeUV_minMipLevel );
		float faceSize = exp2( mipInt );
		highp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;
		if ( face > 2.0 ) {
			uv.y += faceSize;
			face -= 3.0;
		}
		uv.x += face * faceSize;
		uv.x += filterInt * 3.0 * cubeUV_minTileSize;
		uv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );
		uv.x *= CUBEUV_TEXEL_WIDTH;
		uv.y *= CUBEUV_TEXEL_HEIGHT;
		#ifdef texture2DGradEXT
			return texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;
		#else
			return texture2D( envMap, uv ).rgb;
		#endif
	}
	#define cubeUV_r0 1.0
	#define cubeUV_m0 - 2.0
	#define cubeUV_r1 0.8
	#define cubeUV_m1 - 1.0
	#define cubeUV_r4 0.4
	#define cubeUV_m4 2.0
	#define cubeUV_r5 0.305
	#define cubeUV_m5 3.0
	#define cubeUV_r6 0.21
	#define cubeUV_m6 4.0
	float roughnessToMip( float roughness ) {
		float mip = 0.0;
		if ( roughness >= cubeUV_r1 ) {
			mip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;
		} else if ( roughness >= cubeUV_r4 ) {
			mip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;
		} else if ( roughness >= cubeUV_r5 ) {
			mip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;
		} else if ( roughness >= cubeUV_r6 ) {
			mip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;
		} else {
			mip = - 2.0 * log2( 1.16 * roughness );		}
		return mip;
	}
	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {
		float mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );
		float mipF = fract( mip );
		float mipInt = floor( mip );
		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );
		if ( mipF == 0.0 ) {
			return vec4( color0, 1.0 );
		} else {
			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );
			return vec4( mix( color0, color1, mipF ), 1.0 );
		}
	}
#endif`,ET=`vec3 transformedNormal = objectNormal;
#ifdef USE_TANGENT
	vec3 transformedTangent = objectTangent;
#endif
#ifdef USE_BATCHING
	mat3 bm = mat3( batchingMatrix );
	transformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );
	transformedNormal = bm * transformedNormal;
	#ifdef USE_TANGENT
		transformedTangent = bm * transformedTangent;
	#endif
#endif
#ifdef USE_INSTANCING
	mat3 im = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );
	transformedNormal = im * transformedNormal;
	#ifdef USE_TANGENT
		transformedTangent = im * transformedTangent;
	#endif
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	transformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,CT=`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,TT=`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );
#endif`,RT=`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );
	#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE
		emissiveColor = sRGBTransferEOTF( emissiveColor );
	#endif
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,MT=`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,PT="gl_FragColor = linearToOutputTexel( gl_FragColor );",AT=`vec4 LinearTransferOETF( in vec4 value ) {
	return value;
}
vec4 sRGBTransferEOTF( in vec4 value ) {
	return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}
vec4 sRGBTransferOETF( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}`,DT=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,IT=`#ifdef USE_ENVMAP
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform mat3 envMapRotation;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
	
#endif`,FT=`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,NT=`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,LT=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) {
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,OT=`#ifdef USE_FOG
	vFogDepth = - mvPosition.z;
#endif`,kT=`#ifdef USE_FOG
	varying float vFogDepth;
#endif`,UT=`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,BT=`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float vFogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,HT=`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return vec3( texture2D( gradientMap, coord ).r );
	#else
		vec2 fw = fwidth( coord ) * 0.5;
		return mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );
	#endif
}`,jT=`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,VT=`LambertMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularStrength = specularStrength;`,zT=`varying vec3 vViewPosition;
struct LambertMaterial {
	vec3 diffuseColor;
	float specularStrength;
};
void RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Lambert
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Lambert`,GT=`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
#if defined( USE_LIGHT_PROBES )
	uniform vec3 lightProbe[ 9 ];
#endif
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {
	vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	return irradiance;
}
float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
	float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
	if ( cutoffDistance > 0.0 ) {
		distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
	}
	return distanceFalloff;
}
float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {
	return smoothstep( coneCosine, penumbraCosine, angleCosine );
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {
		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = pointLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float lightDistance = length( lVector );
		light.color = pointLight.color;
		light.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = spotLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float angleCos = dot( light.direction, spotLight.direction );
		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );
		if ( spotAttenuation > 0.0 ) {
			float lightDistance = length( lVector );
			light.color = spotLight.color * spotAttenuation;
			light.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );
		} else {
			light.color = vec3( 0.0 );
			light.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {
		float dotNL = dot( normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		return irradiance;
	}
#endif`,qT=`#ifdef USE_ENVMAP
	vec3 getIBLIrradiance( const in vec3 normal ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
			vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );
			return PI * envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
			vec3 reflectVec = reflect( - viewDir, normal );
			reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );
			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );
			return envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	#ifdef USE_ANISOTROPY
		vec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {
			#ifdef ENVMAP_TYPE_CUBE_UV
				vec3 bentNormal = cross( bitangent, viewDir );
				bentNormal = normalize( cross( bentNormal, bitangent ) );
				bentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );
				return getIBLRadiance( viewDir, bentNormal, roughness );
			#else
				return vec3( 0.0 );
			#endif
		}
	#endif
#endif`,WT=`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,KT=`varying vec3 vViewPosition;
struct ToonMaterial {
	vec3 diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon`,XT=`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,$T=`varying vec3 vViewPosition;
struct BlinnPhongMaterial {
	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong`,ZT=`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );
vec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;
material.roughness = min( material.roughness, 1.0 );
#ifdef IOR
	material.ior = ior;
	#ifdef USE_SPECULAR
		float specularIntensityFactor = specularIntensity;
		vec3 specularColorFactor = specularColor;
		#ifdef USE_SPECULAR_COLORMAP
			specularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;
		#endif
		#ifdef USE_SPECULAR_INTENSITYMAP
			specularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;
		#endif
		material.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );
	#else
		float specularIntensityFactor = 1.0;
		vec3 specularColorFactor = vec3( 1.0 );
		material.specularF90 = 1.0;
	#endif
	material.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );
	material.specularF90 = 1.0;
#endif
#ifdef USE_CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	material.clearcoatF0 = vec3( 0.04 );
	material.clearcoatF90 = 1.0;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_DISPERSION
	material.dispersion = dispersion;
#endif
#ifdef USE_IRIDESCENCE
	material.iridescence = iridescence;
	material.iridescenceIOR = iridescenceIOR;
	#ifdef USE_IRIDESCENCEMAP
		material.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;
	#endif
	#ifdef USE_IRIDESCENCE_THICKNESSMAP
		material.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;
	#else
		material.iridescenceThickness = iridescenceThicknessMaximum;
	#endif
#endif
#ifdef USE_SHEEN
	material.sheenColor = sheenColor;
	#ifdef USE_SHEEN_COLORMAP
		material.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;
	#endif
	material.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );
	#ifdef USE_SHEEN_ROUGHNESSMAP
		material.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;
	#endif
#endif
#ifdef USE_ANISOTROPY
	#ifdef USE_ANISOTROPYMAP
		mat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );
		vec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;
		vec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;
	#else
		vec2 anisotropyV = anisotropyVector;
	#endif
	material.anisotropy = length( anisotropyV );
	if( material.anisotropy == 0.0 ) {
		anisotropyV = vec2( 1.0, 0.0 );
	} else {
		anisotropyV /= material.anisotropy;
		material.anisotropy = saturate( material.anisotropy );
	}
	material.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );
	material.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;
	material.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;
#endif`,YT=`struct PhysicalMaterial {
	vec3 diffuseColor;
	float roughness;
	vec3 specularColor;
	float specularF90;
	float dispersion;
	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif
	#ifdef USE_IRIDESCENCE
		float iridescence;
		float iridescenceIOR;
		float iridescenceThickness;
		vec3 iridescenceFresnel;
		vec3 iridescenceF0;
	#endif
	#ifdef USE_SHEEN
		vec3 sheenColor;
		float sheenRoughness;
	#endif
	#ifdef IOR
		float ior;
	#endif
	#ifdef USE_TRANSMISSION
		float transmission;
		float transmissionAlpha;
		float thickness;
		float attenuationDistance;
		vec3 attenuationColor;
	#endif
	#ifdef USE_ANISOTROPY
		float anisotropy;
		float alphaT;
		vec3 anisotropyT;
		vec3 anisotropyB;
	#endif
};
vec3 clearcoatSpecularDirect = vec3( 0.0 );
vec3 clearcoatSpecularIndirect = vec3( 0.0 );
vec3 sheenSpecularDirect = vec3( 0.0 );
vec3 sheenSpecularIndirect = vec3(0.0 );
vec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {
    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );
    float x2 = x * x;
    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );
    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );
}
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
#ifdef USE_ANISOTROPY
	float V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {
		float gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );
		float gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );
		float v = 0.5 / ( gv + gl );
		return saturate(v);
	}
	float D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {
		float a2 = alphaT * alphaB;
		highp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );
		highp float v2 = dot( v, v );
		float w2 = a2 / v2;
		return RECIPROCAL_PI * a2 * pow2 ( w2 );
	}
#endif
#ifdef USE_CLEARCOAT
	vec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {
		vec3 f0 = material.clearcoatF0;
		float f90 = material.clearcoatF90;
		float roughness = material.clearcoatRoughness;
		float alpha = pow2( roughness );
		vec3 halfDir = normalize( lightDir + viewDir );
		float dotNL = saturate( dot( normal, lightDir ) );
		float dotNV = saturate( dot( normal, viewDir ) );
		float dotNH = saturate( dot( normal, halfDir ) );
		float dotVH = saturate( dot( viewDir, halfDir ) );
		vec3 F = F_Schlick( f0, f90, dotVH );
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
		return F * ( V * D );
	}
#endif
vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {
	vec3 f0 = material.specularColor;
	float f90 = material.specularF90;
	float roughness = material.roughness;
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( f0, f90, dotVH );
	#ifdef USE_IRIDESCENCE
		F = mix( F, material.iridescenceFresnel, material.iridescence );
	#endif
	#ifdef USE_ANISOTROPY
		float dotTL = dot( material.anisotropyT, lightDir );
		float dotTV = dot( material.anisotropyT, viewDir );
		float dotTH = dot( material.anisotropyT, halfDir );
		float dotBL = dot( material.anisotropyB, lightDir );
		float dotBV = dot( material.anisotropyB, viewDir );
		float dotBH = dot( material.anisotropyB, halfDir );
		float V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );
		float D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );
	#else
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
	#endif
	return F * ( V * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
#if defined( USE_SHEEN )
float D_Charlie( float roughness, float dotNH ) {
	float alpha = pow2( roughness );
	float invAlpha = 1.0 / alpha;
	float cos2h = dotNH * dotNH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 );
	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );
}
float V_Neubelt( float dotNV, float dotNL ) {
	return saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );
}
vec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float D = D_Charlie( sheenRoughness, dotNH );
	float V = V_Neubelt( dotNV, dotNL );
	return sheenColor * ( D * V );
}
#endif
float IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	float r2 = roughness * roughness;
	float a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;
	float b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;
	float DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );
	return saturate( DG * RECIPROCAL_PI );
}
vec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );
	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );
	vec4 r = roughness * c0 + c1;
	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;
	vec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;
	return fab;
}
vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	return specularColor * fab.x + specularF90 * fab.y;
}
#ifdef USE_IRIDESCENCE
void computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#else
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#endif
	vec2 fab = DFGApprox( normal, viewDir, roughness );
	#ifdef USE_IRIDESCENCE
		vec3 Fr = mix( specularColor, iridescenceF0, iridescence );
	#else
		vec3 Fr = specularColor;
	#endif
	vec3 FssEss = Fr * fab.x + specularF90 * fab.y;
	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometryNormal;
		vec3 viewDir = geometryViewDir;
		vec3 position = geometryPosition;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifdef USE_CLEARCOAT
		float dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = dotNLcc * directLight.color;
		clearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );
	#endif
	#ifdef USE_SHEEN
		sheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );
	#endif
	reflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef USE_CLEARCOAT
		clearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	#ifdef USE_SHEEN
		sheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );
	#endif
	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	#ifdef USE_IRIDESCENCE
		computeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );
	#else
		computeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );
	#endif
	vec3 totalScattering = singleScattering + multiScattering;
	vec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );
	reflectedLight.indirectSpecular += radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;
	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,JT=`
vec3 geometryPosition = - vViewPosition;
vec3 geometryNormal = normal;
vec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
vec3 geometryClearcoatNormal = vec3( 0.0 );
#ifdef USE_CLEARCOAT
	geometryClearcoatNormal = clearcoatNormal;
#endif
#ifdef USE_IRIDESCENCE
	float dotNVi = saturate( dot( normal, geometryViewDir ) );
	if ( material.iridescenceThickness == 0.0 ) {
		material.iridescence = 0.0;
	} else {
		material.iridescence = saturate( material.iridescence );
	}
	if ( material.iridescence > 0.0 ) {
		material.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );
		material.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );
	}
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointLightInfo( pointLight, geometryPosition, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	vec4 spotColor;
	vec3 spotLightCoord;
	bool inSpotLightMap;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotLightInfo( spotLight, geometryPosition, directLight );
		#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX
		#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS
		#else
		#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#endif
		#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )
			spotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;
			inSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );
			spotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );
			directLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;
		#endif
		#undef SPOT_LIGHT_MAP_INDEX
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalLightInfo( directionalLight, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	#if defined( USE_LIGHT_PROBES )
		irradiance += getLightProbeIrradiance( lightProbe, geometryNormal );
	#endif
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,QT=`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		vec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getIBLIrradiance( geometryNormal );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	#ifdef USE_ANISOTROPY
		radiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );
	#else
		radiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );
	#endif
	#ifdef USE_CLEARCOAT
		clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );
	#endif
#endif`,eR=`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif`,tR=`#if defined( USE_LOGDEPTHBUF )
	gl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,iR=`#if defined( USE_LOGDEPTHBUF )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,nR=`#ifdef USE_LOGDEPTHBUF
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,rR=`#ifdef USE_LOGDEPTHBUF
	vFragDepth = 1.0 + gl_Position.w;
	vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
#endif`,sR=`#ifdef USE_MAP
	vec4 sampledDiffuseColor = texture2D( map, vMapUv );
	#ifdef DECODE_VIDEO_TEXTURE
		sampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );
	#endif
	diffuseColor *= sampledDiffuseColor;
#endif`,aR=`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,oR=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	#if defined( USE_POINTS_UV )
		vec2 uv = vUv;
	#else
		vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
	#endif
#endif
#ifdef USE_MAP
	diffuseColor *= texture2D( map, uv );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,cR=`#if defined( USE_POINTS_UV )
	varying vec2 vUv;
#else
	#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
		uniform mat3 uvTransform;
	#endif
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,lR=`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );
	metalnessFactor *= texelMetalness.b;
#endif`,dR=`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,uR=`#ifdef USE_INSTANCING_MORPH
	float morphTargetInfluences[ MORPHTARGETS_COUNT ];
	float morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		morphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;
	}
#endif`,hR=`#if defined( USE_MORPHCOLORS )
	vColor *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		#if defined( USE_COLOR_ALPHA )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];
		#elif defined( USE_COLOR )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];
		#endif
	}
#endif`,pR=`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		if ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];
	}
#endif`,fR=`#ifdef USE_MORPHTARGETS
	#ifndef USE_INSTANCING_MORPH
		uniform float morphTargetBaseInfluence;
		uniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];
	#endif
	uniform sampler2DArray morphTargetsTexture;
	uniform ivec2 morphTargetsTextureSize;
	vec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {
		int texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;
		int y = texelIndex / morphTargetsTextureSize.x;
		int x = texelIndex - y * morphTargetsTextureSize.x;
		ivec3 morphUV = ivec3( x, y, morphTargetIndex );
		return texelFetch( morphTargetsTexture, morphUV, 0 );
	}
#endif`,mR=`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		if ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];
	}
#endif`,gR=`float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;
#ifdef FLAT_SHADED
	vec3 fdx = dFdx( vViewPosition );
	vec3 fdy = dFdy( vViewPosition );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal *= faceDirection;
	#endif
#endif
#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )
	#ifdef USE_TANGENT
		mat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn = getTangentFrame( - vViewPosition, normal,
		#if defined( USE_NORMALMAP )
			vNormalMapUv
		#elif defined( USE_CLEARCOAT_NORMALMAP )
			vClearcoatNormalMapUv
		#else
			vUv
		#endif
		);
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn[0] *= faceDirection;
		tbn[1] *= faceDirection;
	#endif
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	#ifdef USE_TANGENT
		mat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn2[0] *= faceDirection;
		tbn2[1] *= faceDirection;
	#endif
#endif
vec3 nonPerturbedNormal = normal;`,vR=`#ifdef USE_NORMALMAP_OBJECTSPACE
	normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( USE_NORMALMAP_TANGENTSPACE )
	vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	normal = normalize( tbn * mapN );
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );
#endif`,_R=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,bR=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,yR=`#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif`,SR=`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef USE_NORMALMAP_OBJECTSPACE
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )
	mat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {
		vec3 q0 = dFdx( eye_pos.xyz );
		vec3 q1 = dFdy( eye_pos.xyz );
		vec2 st0 = dFdx( uv.st );
		vec2 st1 = dFdy( uv.st );
		vec3 N = surf_norm;
		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );
		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;
		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );
		return mat3( T * scale, B * scale, N );
	}
#endif`,wR=`#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal = nonPerturbedNormal;
#endif`,xR=`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	clearcoatNormal = normalize( tbn2 * clearcoatMapN );
#endif`,ER=`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif`,CR=`#ifdef USE_IRIDESCENCEMAP
	uniform sampler2D iridescenceMap;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform sampler2D iridescenceThicknessMap;
#endif`,TR=`#ifdef OPAQUE
diffuseColor.a = 1.0;
#endif
#ifdef USE_TRANSMISSION
diffuseColor.a *= material.transmissionAlpha;
#endif
gl_FragColor = vec4( outgoingLight, diffuseColor.a );`,RR=`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;
const float Inv255 = 1. / 255.;
const vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );
const vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );
const vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );
const vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );
vec4 packDepthToRGBA( const in float v ) {
	if( v <= 0.0 )
		return vec4( 0., 0., 0., 0. );
	if( v >= 1.0 )
		return vec4( 1., 1., 1., 1. );
	float vuf;
	float af = modf( v * PackFactors.a, vuf );
	float bf = modf( vuf * ShiftRight8, vuf );
	float gf = modf( vuf * ShiftRight8, vuf );
	return vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );
}
vec3 packDepthToRGB( const in float v ) {
	if( v <= 0.0 )
		return vec3( 0., 0., 0. );
	if( v >= 1.0 )
		return vec3( 1., 1., 1. );
	float vuf;
	float bf = modf( v * PackFactors.b, vuf );
	float gf = modf( vuf * ShiftRight8, vuf );
	return vec3( vuf * Inv255, gf * PackUpscale, bf );
}
vec2 packDepthToRG( const in float v ) {
	if( v <= 0.0 )
		return vec2( 0., 0. );
	if( v >= 1.0 )
		return vec2( 1., 1. );
	float vuf;
	float gf = modf( v * 256., vuf );
	return vec2( vuf * Inv255, gf );
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors4 );
}
float unpackRGBToDepth( const in vec3 v ) {
	return dot( v, UnpackFactors3 );
}
float unpackRGToDepth( const in vec2 v ) {
	return v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;
}
vec4 pack2HalfToRGBA( const in vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );
}
vec2 unpackRGBATo2Half( const in vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return depth * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * depth - far );
}`,MR=`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,PR=`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_BATCHING
	mvPosition = batchingMatrix * mvPosition;
#endif
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,AR=`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,DR=`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,IR=`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );
	roughnessFactor *= texelRoughness.g;
#endif`,FR=`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,NR=`#if NUM_SPOT_LIGHT_COORDS > 0
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#if NUM_SPOT_LIGHT_MAPS > 0
	uniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		struct SpotLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {
		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );
	}
	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {
		return unpackRGBATo2Half( texture2D( shadow, uv ) );
	}
	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){
		float occlusion = 1.0;
		vec2 distribution = texture2DDistribution( shadow, uv );
		float hard_shadow = step( compare , distribution.x );
		if (hard_shadow != 1.0 ) {
			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance );			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );
		}
		return occlusion;
	}
	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
		float shadow = 1.0;
		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;
		bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
		bool frustumTest = inFrustum && shadowCoord.z <= 1.0;
		if ( frustumTest ) {
		#if defined( SHADOWMAP_TYPE_PCF )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;
			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );
		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )
			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;
			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;
			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );
		#elif defined( SHADOWMAP_TYPE_VSM )
			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );
		#else
			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );
		#endif
		}
		return mix( 1.0, shadow, shadowIntensity );
	}
	vec2 cubeToUV( vec3 v, float texelSizeY ) {
		vec3 absV = abs( v );
		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );
		vec2 planar = v.xy;
		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;
		if ( absV.z >= almostOne ) {
			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;
		} else if ( absV.x >= almostOne ) {
			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;
		} else if ( absV.y >= almostOne ) {
			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;
		}
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );
	}
	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		float shadow = 1.0;
		vec3 lightToPosition = shadowCoord.xyz;
		
		float lightToPositionLength = length( lightToPosition );
		if ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {
			float dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );			dp += shadowBias;
			vec3 bd3D = normalize( lightToPosition );
			vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );
			#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )
				vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;
				shadow = (
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
				) * ( 1.0 / 9.0 );
			#else
				shadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );
			#endif
		}
		return mix( 1.0, shadow, shadowIntensity );
	}
#endif`,LR=`#if NUM_SPOT_LIGHT_COORDS > 0
	uniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		struct SpotLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,OR=`#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )
	vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
	vec4 shadowWorldPosition;
#endif
#if defined( USE_SHADOWMAP )
	#if NUM_DIR_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
			vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
			vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
#endif
#if NUM_SPOT_LIGHT_COORDS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {
		shadowWorldPosition = worldPosition;
		#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
			shadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;
		#endif
		vSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
#endif`,kR=`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,UR=`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,BR=`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	uniform highp sampler2D boneTexture;
	mat4 getBoneMatrix( const in float i ) {
		int size = textureSize( boneTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );
		return mat4( v1, v2, v3, v4 );
	}
#endif`,HR=`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,jR=`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,VR=`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,zR=`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,GR=`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,qR=`#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return saturate( toneMappingExposure * color );
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 CineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
const mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(
	vec3( 1.6605, - 0.1246, - 0.0182 ),
	vec3( - 0.5876, 1.1329, - 0.1006 ),
	vec3( - 0.0728, - 0.0083, 1.1187 )
);
const mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(
	vec3( 0.6274, 0.0691, 0.0164 ),
	vec3( 0.3293, 0.9195, 0.0880 ),
	vec3( 0.0433, 0.0113, 0.8956 )
);
vec3 agxDefaultContrastApprox( vec3 x ) {
	vec3 x2 = x * x;
	vec3 x4 = x2 * x2;
	return + 15.5 * x4 * x2
		- 40.14 * x4 * x
		+ 31.96 * x4
		- 6.868 * x2 * x
		+ 0.4298 * x2
		+ 0.1191 * x
		- 0.00232;
}
vec3 AgXToneMapping( vec3 color ) {
	const mat3 AgXInsetMatrix = mat3(
		vec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),
		vec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),
		vec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )
	);
	const mat3 AgXOutsetMatrix = mat3(
		vec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),
		vec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),
		vec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )
	);
	const float AgxMinEv = - 12.47393;	const float AgxMaxEv = 4.026069;
	color *= toneMappingExposure;
	color = LINEAR_SRGB_TO_LINEAR_REC2020 * color;
	color = AgXInsetMatrix * color;
	color = max( color, 1e-10 );	color = log2( color );
	color = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );
	color = clamp( color, 0.0, 1.0 );
	color = agxDefaultContrastApprox( color );
	color = AgXOutsetMatrix * color;
	color = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );
	color = LINEAR_REC2020_TO_LINEAR_SRGB * color;
	color = clamp( color, 0.0, 1.0 );
	return color;
}
vec3 NeutralToneMapping( vec3 color ) {
	const float StartCompression = 0.8 - 0.04;
	const float Desaturation = 0.15;
	color *= toneMappingExposure;
	float x = min( color.r, min( color.g, color.b ) );
	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;
	color -= offset;
	float peak = max( color.r, max( color.g, color.b ) );
	if ( peak < StartCompression ) return color;
	float d = 1. - StartCompression;
	float newPeak = 1. - d * d / ( peak + d - StartCompression );
	color *= newPeak / peak;
	float g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );
	return mix( color, vec3( newPeak ), g );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,WR=`#ifdef USE_TRANSMISSION
	material.transmission = transmission;
	material.transmissionAlpha = 1.0;
	material.thickness = thickness;
	material.attenuationDistance = attenuationDistance;
	material.attenuationColor = attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		material.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;
	#endif
	#ifdef USE_THICKNESSMAP
		material.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;
	#endif
	vec3 pos = vWorldPosition;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );
	vec4 transmitted = getIBLVolumeRefraction(
		n, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
		pos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,
		material.attenuationColor, material.attenuationDistance );
	material.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );
	totalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );
#endif`,KR=`#ifdef USE_TRANSMISSION
	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		uniform sampler2D transmissionMap;
	#endif
	#ifdef USE_THICKNESSMAP
		uniform sampler2D thicknessMap;
	#endif
	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;
	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;
	varying vec3 vWorldPosition;
	float w0( float a ) {
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );
	}
	float w1( float a ) {
		return ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );
	}
	float w2( float a ){
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );
	}
	float w3( float a ) {
		return ( 1.0 / 6.0 ) * ( a * a * a );
	}
	float g0( float a ) {
		return w0( a ) + w1( a );
	}
	float g1( float a ) {
		return w2( a ) + w3( a );
	}
	float h0( float a ) {
		return - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );
	}
	float h1( float a ) {
		return 1.0 + w3( a ) / ( w2( a ) + w3( a ) );
	}
	vec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {
		uv = uv * texelSize.zw + 0.5;
		vec2 iuv = floor( uv );
		vec2 fuv = fract( uv );
		float g0x = g0( fuv.x );
		float g1x = g1( fuv.x );
		float h0x = h0( fuv.x );
		float h1x = h1( fuv.x );
		float h0y = h0( fuv.y );
		float h1y = h1( fuv.y );
		vec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		vec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		return g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +
			g1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );
	}
	vec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {
		vec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );
		vec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );
		vec2 fLodSizeInv = 1.0 / fLodSize;
		vec2 cLodSizeInv = 1.0 / cLodSize;
		vec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );
		vec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );
		return mix( fSample, cSample, fract( lod ) );
	}
	vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
		vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
		vec3 modelScale;
		modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
		modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
		modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
		return normalize( refractionVector ) * thickness * modelScale;
	}
	float applyIorToRoughness( const in float roughness, const in float ior ) {
		return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
	}
	vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
		float lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );
		return textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );
	}
	vec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
		if ( isinf( attenuationDistance ) ) {
			return vec3( 1.0 );
		} else {
			vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
			vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );			return transmittance;
		}
	}
	vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
		const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
		const in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,
		const in vec3 attenuationColor, const in float attenuationDistance ) {
		vec4 transmittedLight;
		vec3 transmittance;
		#ifdef USE_DISPERSION
			float halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;
			vec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );
			for ( int i = 0; i < 3; i ++ ) {
				vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );
				vec3 refractedRayExit = position + transmissionRay;
				vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
				vec2 refractionCoords = ndcPos.xy / ndcPos.w;
				refractionCoords += 1.0;
				refractionCoords /= 2.0;
				vec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );
				transmittedLight[ i ] = transmissionSample[ i ];
				transmittedLight.a += transmissionSample.a;
				transmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];
			}
			transmittedLight.a /= 3.0;
		#else
			vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
			vec3 refractedRayExit = position + transmissionRay;
			vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
			vec2 refractionCoords = ndcPos.xy / ndcPos.w;
			refractionCoords += 1.0;
			refractionCoords /= 2.0;
			transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
			transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );
		#endif
		vec3 attenuatedColor = transmittance * transmittedLight.rgb;
		vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
		float transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;
		return vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );
	}
#endif`,XR=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_SPECULARMAP
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,$R=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	uniform mat3 mapTransform;
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	uniform mat3 alphaMapTransform;
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	uniform mat3 lightMapTransform;
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	uniform mat3 aoMapTransform;
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	uniform mat3 bumpMapTransform;
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	uniform mat3 normalMapTransform;
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_DISPLACEMENTMAP
	uniform mat3 displacementMapTransform;
	varying vec2 vDisplacementMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	uniform mat3 emissiveMapTransform;
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	uniform mat3 metalnessMapTransform;
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	uniform mat3 roughnessMapTransform;
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	uniform mat3 anisotropyMapTransform;
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	uniform mat3 clearcoatMapTransform;
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform mat3 clearcoatNormalMapTransform;
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform mat3 clearcoatRoughnessMapTransform;
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	uniform mat3 sheenColorMapTransform;
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	uniform mat3 sheenRoughnessMapTransform;
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	uniform mat3 iridescenceMapTransform;
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform mat3 iridescenceThicknessMapTransform;
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SPECULARMAP
	uniform mat3 specularMapTransform;
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	uniform mat3 specularColorMapTransform;
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	uniform mat3 specularIntensityMapTransform;
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,ZR=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	vUv = vec3( uv, 1 ).xy;
#endif
#ifdef USE_MAP
	vMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ALPHAMAP
	vAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_LIGHTMAP
	vLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_AOMAP
	vAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_BUMPMAP
	vBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_NORMALMAP
	vNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_DISPLACEMENTMAP
	vDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_EMISSIVEMAP
	vEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_METALNESSMAP
	vMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ROUGHNESSMAP
	vRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ANISOTROPYMAP
	vAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOATMAP
	vClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	vClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	vClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCEMAP
	vIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	vIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_COLORMAP
	vSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	vSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULARMAP
	vSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_COLORMAP
	vSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	vSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_TRANSMISSIONMAP
	vTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_THICKNESSMAP
	vThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;
#endif`,YR=`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_BATCHING
		worldPosition = batchingMatrix * worldPosition;
	#endif
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`;const JR=`varying vec2 vUv;
uniform mat3 uvTransform;
void main() {
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,QR=`uniform sampler2D t2D;
uniform float backgroundIntensity;
varying vec2 vUv;
void main() {
	vec4 texColor = texture2D( t2D, vUv );
	#ifdef DECODE_VIDEO_TEXTURE
		texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );
	#endif
	texColor.rgb *= backgroundIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,eM=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,tM=`#ifdef ENVMAP_TYPE_CUBE
	uniform samplerCube envMap;
#elif defined( ENVMAP_TYPE_CUBE_UV )
	uniform sampler2D envMap;
#endif
uniform float flipEnvMap;
uniform float backgroundBlurriness;
uniform float backgroundIntensity;
uniform mat3 backgroundRotation;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
void main() {
	#ifdef ENVMAP_TYPE_CUBE
		vec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );
	#else
		vec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );
	#endif
	texColor.rgb *= backgroundIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,iM=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,nM=`uniform samplerCube tCube;
uniform float tFlip;
uniform float opacity;
varying vec3 vWorldDirection;
void main() {
	vec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );
	gl_FragColor = texColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,rM=`#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <skinbase_vertex>
	#include <morphinstance_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,sM=`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	vec4 diffuseColor = vec4( 1.0 );
	#include <clipping_planes_fragment>
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <logdepthbuf_fragment>
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#elif DEPTH_PACKING == 3202
		gl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );
	#elif DEPTH_PACKING == 3203
		gl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );
	#endif
}`,aM=`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <skinbase_vertex>
	#include <morphinstance_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,oM=`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	vec4 diffuseColor = vec4( 1.0 );
	#include <clipping_planes_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = packDepthToRGBA( dist );
}`,cM=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,lM=`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	gl_FragColor = texture2D( tEquirect, sampleUV );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,dM=`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,uM=`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,hM=`#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,pM=`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,fM=`#define LAMBERT
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,mM=`#define LAMBERT
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_lambert_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_lambert_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,gM=`#define MATCAP
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,vM=`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
	#else
		vec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,_M=`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	vViewPosition = - mvPosition.xyz;
#endif
}`,bM=`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <packing>
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );
	#ifdef OPAQUE
		gl_FragColor.a = 1.0;
	#endif
}`,yM=`#define PHONG
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,SM=`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,wM=`#define STANDARD
varying vec3 vViewPosition;
#ifdef USE_TRANSMISSION
	varying vec3 vWorldPosition;
#endif
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition.xyz;
#endif
}`,xM=`#define STANDARD
#ifdef PHYSICAL
	#define IOR
	#define USE_SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef IOR
	uniform float ior;
#endif
#ifdef USE_SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularColor;
	#ifdef USE_SPECULAR_COLORMAP
		uniform sampler2D specularColorMap;
	#endif
	#ifdef USE_SPECULAR_INTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
#endif
#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_DISPERSION
	uniform float dispersion;
#endif
#ifdef USE_IRIDESCENCE
	uniform float iridescence;
	uniform float iridescenceIOR;
	uniform float iridescenceThicknessMinimum;
	uniform float iridescenceThicknessMaximum;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheenColor;
	uniform float sheenRoughness;
	#ifdef USE_SHEEN_COLORMAP
		uniform sampler2D sheenColorMap;
	#endif
	#ifdef USE_SHEEN_ROUGHNESSMAP
		uniform sampler2D sheenRoughnessMap;
	#endif
#endif
#ifdef USE_ANISOTROPY
	uniform vec2 anisotropyVector;
	#ifdef USE_ANISOTROPYMAP
		uniform sampler2D anisotropyMap;
	#endif
#endif
varying vec3 vViewPosition;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <iridescence_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <iridescence_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
	#include <transmission_fragment>
	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
	#ifdef USE_SHEEN
		float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );
		outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;
	#endif
	#ifdef USE_CLEARCOAT
		float dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );
		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );
		outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;
	#endif
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,EM=`#define TOON
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,CM=`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,TM=`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
#ifdef USE_POINTS_UV
	varying vec2 vUv;
	uniform mat3 uvTransform;
#endif
void main() {
	#ifdef USE_POINTS_UV
		vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	#endif
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,RM=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,MM=`#include <common>
#include <batching_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,PM=`uniform vec3 color;
uniform float opacity;
#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <logdepthbuf_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	#include <logdepthbuf_fragment>
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`,AM=`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix[ 3 ];
	vec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,DM=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`,Wt={alphahash_fragment:QC,alphahash_pars_fragment:eT,alphamap_fragment:tT,alphamap_pars_fragment:iT,alphatest_fragment:nT,alphatest_pars_fragment:rT,aomap_fragment:sT,aomap_pars_fragment:aT,batching_pars_vertex:oT,batching_vertex:cT,begin_vertex:lT,beginnormal_vertex:dT,bsdfs:uT,iridescence_fragment:hT,bumpmap_pars_fragment:pT,clipping_planes_fragment:fT,clipping_planes_pars_fragment:mT,clipping_planes_pars_vertex:gT,clipping_planes_vertex:vT,color_fragment:_T,color_pars_fragment:bT,color_pars_vertex:yT,color_vertex:ST,common:wT,cube_uv_reflection_fragment:xT,defaultnormal_vertex:ET,displacementmap_pars_vertex:CT,displacementmap_vertex:TT,emissivemap_fragment:RT,emissivemap_pars_fragment:MT,colorspace_fragment:PT,colorspace_pars_fragment:AT,envmap_fragment:DT,envmap_common_pars_fragment:IT,envmap_pars_fragment:FT,envmap_pars_vertex:NT,envmap_physical_pars_fragment:qT,envmap_vertex:LT,fog_vertex:OT,fog_pars_vertex:kT,fog_fragment:UT,fog_pars_fragment:BT,gradientmap_pars_fragment:HT,lightmap_pars_fragment:jT,lights_lambert_fragment:VT,lights_lambert_pars_fragment:zT,lights_pars_begin:GT,lights_toon_fragment:WT,lights_toon_pars_fragment:KT,lights_phong_fragment:XT,lights_phong_pars_fragment:$T,lights_physical_fragment:ZT,lights_physical_pars_fragment:YT,lights_fragment_begin:JT,lights_fragment_maps:QT,lights_fragment_end:eR,logdepthbuf_fragment:tR,logdepthbuf_pars_fragment:iR,logdepthbuf_pars_vertex:nR,logdepthbuf_vertex:rR,map_fragment:sR,map_pars_fragment:aR,map_particle_fragment:oR,map_particle_pars_fragment:cR,metalnessmap_fragment:lR,metalnessmap_pars_fragment:dR,morphinstance_vertex:uR,morphcolor_vertex:hR,morphnormal_vertex:pR,morphtarget_pars_vertex:fR,morphtarget_vertex:mR,normal_fragment_begin:gR,normal_fragment_maps:vR,normal_pars_fragment:_R,normal_pars_vertex:bR,normal_vertex:yR,normalmap_pars_fragment:SR,clearcoat_normal_fragment_begin:wR,clearcoat_normal_fragment_maps:xR,clearcoat_pars_fragment:ER,iridescence_pars_fragment:CR,opaque_fragment:TR,packing:RR,premultiplied_alpha_fragment:MR,project_vertex:PR,dithering_fragment:AR,dithering_pars_fragment:DR,roughnessmap_fragment:IR,roughnessmap_pars_fragment:FR,shadowmap_pars_fragment:NR,shadowmap_pars_vertex:LR,shadowmap_vertex:OR,shadowmask_pars_fragment:kR,skinbase_vertex:UR,skinning_pars_vertex:BR,skinning_vertex:HR,skinnormal_vertex:jR,specularmap_fragment:VR,specularmap_pars_fragment:zR,tonemapping_fragment:GR,tonemapping_pars_fragment:qR,transmission_fragment:WR,transmission_pars_fragment:KR,uv_pars_fragment:XR,uv_pars_vertex:$R,uv_vertex:ZR,worldpos_vertex:YR,background_vert:JR,background_frag:QR,backgroundCube_vert:eM,backgroundCube_frag:tM,cube_vert:iM,cube_frag:nM,depth_vert:rM,depth_frag:sM,distanceRGBA_vert:aM,distanceRGBA_frag:oM,equirect_vert:cM,equirect_frag:lM,linedashed_vert:dM,linedashed_frag:uM,meshbasic_vert:hM,meshbasic_frag:pM,meshlambert_vert:fM,meshlambert_frag:mM,meshmatcap_vert:gM,meshmatcap_frag:vM,meshnormal_vert:_M,meshnormal_frag:bM,meshphong_vert:yM,meshphong_frag:SM,meshphysical_vert:wM,meshphysical_frag:xM,meshtoon_vert:EM,meshtoon_frag:CM,points_vert:TM,points_frag:RM,shadow_vert:MM,shadow_frag:PM,sprite_vert:AM,sprite_frag:DM},ct={common:{diffuse:{value:new Ei(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new qt},alphaMap:{value:null},alphaMapTransform:{value:new qt},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new qt}},envmap:{envMap:{value:null},envMapRotation:{value:new qt},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new qt}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new qt}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new qt},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new qt},normalScale:{value:new $t(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new qt},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new qt}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new qt}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new qt}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Ei(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Ei(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new qt},alphaTest:{value:0},uvTransform:{value:new qt}},sprite:{diffuse:{value:new Ei(16777215)},opacity:{value:1},center:{value:new $t(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new qt},alphaMap:{value:null},alphaMapTransform:{value:new qt},alphaTest:{value:0}}},Lr={basic:{uniforms:xn([ct.common,ct.specularmap,ct.envmap,ct.aomap,ct.lightmap,ct.fog]),vertexShader:Wt.meshbasic_vert,fragmentShader:Wt.meshbasic_frag},lambert:{uniforms:xn([ct.common,ct.specularmap,ct.envmap,ct.aomap,ct.lightmap,ct.emissivemap,ct.bumpmap,ct.normalmap,ct.displacementmap,ct.fog,ct.lights,{emissive:{value:new Ei(0)}}]),vertexShader:Wt.meshlambert_vert,fragmentShader:Wt.meshlambert_frag},phong:{uniforms:xn([ct.common,ct.specularmap,ct.envmap,ct.aomap,ct.lightmap,ct.emissivemap,ct.bumpmap,ct.normalmap,ct.displacementmap,ct.fog,ct.lights,{emissive:{value:new Ei(0)},specular:{value:new Ei(1118481)},shininess:{value:30}}]),vertexShader:Wt.meshphong_vert,fragmentShader:Wt.meshphong_frag},standard:{uniforms:xn([ct.common,ct.envmap,ct.aomap,ct.lightmap,ct.emissivemap,ct.bumpmap,ct.normalmap,ct.displacementmap,ct.roughnessmap,ct.metalnessmap,ct.fog,ct.lights,{emissive:{value:new Ei(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Wt.meshphysical_vert,fragmentShader:Wt.meshphysical_frag},toon:{uniforms:xn([ct.common,ct.aomap,ct.lightmap,ct.emissivemap,ct.bumpmap,ct.normalmap,ct.displacementmap,ct.gradientmap,ct.fog,ct.lights,{emissive:{value:new Ei(0)}}]),vertexShader:Wt.meshtoon_vert,fragmentShader:Wt.meshtoon_frag},matcap:{uniforms:xn([ct.common,ct.bumpmap,ct.normalmap,ct.displacementmap,ct.fog,{matcap:{value:null}}]),vertexShader:Wt.meshmatcap_vert,fragmentShader:Wt.meshmatcap_frag},points:{uniforms:xn([ct.points,ct.fog]),vertexShader:Wt.points_vert,fragmentShader:Wt.points_frag},dashed:{uniforms:xn([ct.common,ct.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Wt.linedashed_vert,fragmentShader:Wt.linedashed_frag},depth:{uniforms:xn([ct.common,ct.displacementmap]),vertexShader:Wt.depth_vert,fragmentShader:Wt.depth_frag},normal:{uniforms:xn([ct.common,ct.bumpmap,ct.normalmap,ct.displacementmap,{opacity:{value:1}}]),vertexShader:Wt.meshnormal_vert,fragmentShader:Wt.meshnormal_frag},sprite:{uniforms:xn([ct.sprite,ct.fog]),vertexShader:Wt.sprite_vert,fragmentShader:Wt.sprite_frag},background:{uniforms:{uvTransform:{value:new qt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Wt.background_vert,fragmentShader:Wt.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new qt}},vertexShader:Wt.backgroundCube_vert,fragmentShader:Wt.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Wt.cube_vert,fragmentShader:Wt.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Wt.equirect_vert,fragmentShader:Wt.equirect_frag},distanceRGBA:{uniforms:xn([ct.common,ct.displacementmap,{referencePosition:{value:new Ae},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Wt.distanceRGBA_vert,fragmentShader:Wt.distanceRGBA_frag},shadow:{uniforms:xn([ct.lights,ct.fog,{color:{value:new Ei(0)},opacity:{value:1}}]),vertexShader:Wt.shadow_vert,fragmentShader:Wt.shadow_frag}};Lr.physical={uniforms:xn([Lr.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new qt},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new qt},clearcoatNormalScale:{value:new $t(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new qt},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new qt},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new qt},sheen:{value:0},sheenColor:{value:new Ei(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new qt},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new qt},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new qt},transmissionSamplerSize:{value:new $t},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new qt},attenuationDistance:{value:0},attenuationColor:{value:new Ei(0)},specularColor:{value:new Ei(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new qt},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new qt},anisotropyVector:{value:new $t},anisotropyMap:{value:null},anisotropyMapTransform:{value:new qt}}]),vertexShader:Wt.meshphysical_vert,fragmentShader:Wt.meshphysical_frag};const Gc={r:0,b:0,g:0},Vs=new as,IM=new Wi;function FM(t,e,i,n,r,s,o){const c=new Ei(0);let h=s===!0?0:1,d,p,v=null,g=0,_=null;function S(b){let m=b.isScene===!0?b.background:null;return m&&m.isTexture&&(m=(b.backgroundBlurriness>0?i:e).get(m)),m}function E(b){let m=!1;const w=S(b);w===null?R(c,h):w&&w.isColor&&(R(w,1),m=!0);const T=t.xr.getEnvironmentBlendMode();T==="additive"?n.buffers.color.setClear(0,0,0,1,o):T==="alpha-blend"&&n.buffers.color.setClear(0,0,0,0,o),(t.autoClear||m)&&(n.buffers.depth.setTest(!0),n.buffers.depth.setMask(!0),n.buffers.color.setMask(!0),t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil))}function M(b,m){const w=S(m);w&&(w.isCubeTexture||w.mapping===Gl)?(p===void 0&&(p=new Or(new tc(1,1,1),new Ms({name:"BackgroundCubeMaterial",uniforms:Qa(Lr.backgroundCube.uniforms),vertexShader:Lr.backgroundCube.vertexShader,fragmentShader:Lr.backgroundCube.fragmentShader,side:Un,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),p.geometry.deleteAttribute("normal"),p.geometry.deleteAttribute("uv"),p.onBeforeRender=function(T,P,L){this.matrixWorld.copyPosition(L.matrixWorld)},Object.defineProperty(p.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),r.update(p)),Vs.copy(m.backgroundRotation),Vs.x*=-1,Vs.y*=-1,Vs.z*=-1,w.isCubeTexture&&w.isRenderTargetTexture===!1&&(Vs.y*=-1,Vs.z*=-1),p.material.uniforms.envMap.value=w,p.material.uniforms.flipEnvMap.value=w.isCubeTexture&&w.isRenderTargetTexture===!1?-1:1,p.material.uniforms.backgroundBlurriness.value=m.backgroundBlurriness,p.material.uniforms.backgroundIntensity.value=m.backgroundIntensity,p.material.uniforms.backgroundRotation.value.setFromMatrix4(IM.makeRotationFromEuler(Vs)),p.material.toneMapped=ci.getTransfer(w.colorSpace)!==wi,(v!==w||g!==w.version||_!==t.toneMapping)&&(p.material.needsUpdate=!0,v=w,g=w.version,_=t.toneMapping),p.layers.enableAll(),b.unshift(p,p.geometry,p.material,0,0,null)):w&&w.isTexture&&(d===void 0&&(d=new Or(new Wl(2,2),new Ms({name:"BackgroundMaterial",uniforms:Qa(Lr.background.uniforms),vertexShader:Lr.background.vertexShader,fragmentShader:Lr.background.fragmentShader,side:Rs,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),d.geometry.deleteAttribute("normal"),Object.defineProperty(d.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(d)),d.material.uniforms.t2D.value=w,d.material.uniforms.backgroundIntensity.value=m.backgroundIntensity,d.material.toneMapped=ci.getTransfer(w.colorSpace)!==wi,w.matrixAutoUpdate===!0&&w.updateMatrix(),d.material.uniforms.uvTransform.value.copy(w.matrix),(v!==w||g!==w.version||_!==t.toneMapping)&&(d.material.needsUpdate=!0,v=w,g=w.version,_=t.toneMapping),d.layers.enableAll(),b.unshift(d,d.geometry,d.material,0,0,null))}function R(b,m){b.getRGB(Gc,Lv(t)),n.buffers.color.setClear(Gc.r,Gc.g,Gc.b,m,o)}function N(){p!==void 0&&(p.geometry.dispose(),p.material.dispose(),p=void 0),d!==void 0&&(d.geometry.dispose(),d.material.dispose(),d=void 0)}return{getClearColor:function(){return c},setClearColor:function(b,m=1){c.set(b),h=m,R(c,h)},getClearAlpha:function(){return h},setClearAlpha:function(b){h=b,R(c,h)},render:E,addToRenderList:M,dispose:N}}function NM(t,e){const i=t.getParameter(t.MAX_VERTEX_ATTRIBS),n={},r=g(null);let s=r,o=!1;function c(I,z,K,$,te){let ee=!1;const de=v($,K,z);s!==de&&(s=de,d(s.object)),ee=_(I,$,K,te),ee&&S(I,$,K,te),te!==null&&e.update(te,t.ELEMENT_ARRAY_BUFFER),(ee||o)&&(o=!1,m(I,z,K,$),te!==null&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.get(te).buffer))}function h(){return t.createVertexArray()}function d(I){return t.bindVertexArray(I)}function p(I){return t.deleteVertexArray(I)}function v(I,z,K){const $=K.wireframe===!0;let te=n[I.id];te===void 0&&(te={},n[I.id]=te);let ee=te[z.id];ee===void 0&&(ee={},te[z.id]=ee);let de=ee[$];return de===void 0&&(de=g(h()),ee[$]=de),de}function g(I){const z=[],K=[],$=[];for(let te=0;te<i;te++)z[te]=0,K[te]=0,$[te]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:z,enabledAttributes:K,attributeDivisors:$,object:I,attributes:{},index:null}}function _(I,z,K,$){const te=s.attributes,ee=z.attributes;let de=0;const X=K.getAttributes();for(const le in X)if(X[le].location>=0){const Se=te[le];let De=ee[le];if(De===void 0&&(le==="instanceMatrix"&&I.instanceMatrix&&(De=I.instanceMatrix),le==="instanceColor"&&I.instanceColor&&(De=I.instanceColor)),Se===void 0||Se.attribute!==De||De&&Se.data!==De.data)return!0;de++}return s.attributesNum!==de||s.index!==$}function S(I,z,K,$){const te={},ee=z.attributes;let de=0;const X=K.getAttributes();for(const le in X)if(X[le].location>=0){let Se=ee[le];Se===void 0&&(le==="instanceMatrix"&&I.instanceMatrix&&(Se=I.instanceMatrix),le==="instanceColor"&&I.instanceColor&&(Se=I.instanceColor));const De={};De.attribute=Se,Se&&Se.data&&(De.data=Se.data),te[le]=De,de++}s.attributes=te,s.attributesNum=de,s.index=$}function E(){const I=s.newAttributes;for(let z=0,K=I.length;z<K;z++)I[z]=0}function M(I){R(I,0)}function R(I,z){const K=s.newAttributes,$=s.enabledAttributes,te=s.attributeDivisors;K[I]=1,$[I]===0&&(t.enableVertexAttribArray(I),$[I]=1),te[I]!==z&&(t.vertexAttribDivisor(I,z),te[I]=z)}function N(){const I=s.newAttributes,z=s.enabledAttributes;for(let K=0,$=z.length;K<$;K++)z[K]!==I[K]&&(t.disableVertexAttribArray(K),z[K]=0)}function b(I,z,K,$,te,ee,de){de===!0?t.vertexAttribIPointer(I,z,K,te,ee):t.vertexAttribPointer(I,z,K,$,te,ee)}function m(I,z,K,$){E();const te=$.attributes,ee=K.getAttributes(),de=z.defaultAttributeValues;for(const X in ee){const le=ee[X];if(le.location>=0){let _e=te[X];if(_e===void 0&&(X==="instanceMatrix"&&I.instanceMatrix&&(_e=I.instanceMatrix),X==="instanceColor"&&I.instanceColor&&(_e=I.instanceColor)),_e!==void 0){const Se=_e.normalized,De=_e.itemSize,We=e.get(_e);if(We===void 0)continue;const Ve=We.buffer,Me=We.type,ze=We.bytesPerElement,ht=Me===t.INT||Me===t.UNSIGNED_INT||_e.gpuType===Fh;if(_e.isInterleavedBufferAttribute){const nt=_e.data,rt=nt.stride,jt=_e.offset;if(nt.isInstancedInterleavedBuffer){for(let Ct=0;Ct<le.locationSize;Ct++)R(le.location+Ct,nt.meshPerAttribute);I.isInstancedMesh!==!0&&$._maxInstanceCount===void 0&&($._maxInstanceCount=nt.meshPerAttribute*nt.count)}else for(let Ct=0;Ct<le.locationSize;Ct++)M(le.location+Ct);t.bindBuffer(t.ARRAY_BUFFER,Ve);for(let Ct=0;Ct<le.locationSize;Ct++)b(le.location+Ct,De/le.locationSize,Me,Se,rt*ze,(jt+De/le.locationSize*Ct)*ze,ht)}else{if(_e.isInstancedBufferAttribute){for(let nt=0;nt<le.locationSize;nt++)R(le.location+nt,_e.meshPerAttribute);I.isInstancedMesh!==!0&&$._maxInstanceCount===void 0&&($._maxInstanceCount=_e.meshPerAttribute*_e.count)}else for(let nt=0;nt<le.locationSize;nt++)M(le.location+nt);t.bindBuffer(t.ARRAY_BUFFER,Ve);for(let nt=0;nt<le.locationSize;nt++)b(le.location+nt,De/le.locationSize,Me,Se,De*ze,De/le.locationSize*nt*ze,ht)}}else if(de!==void 0){const Se=de[X];if(Se!==void 0)switch(Se.length){case 2:t.vertexAttrib2fv(le.location,Se);break;case 3:t.vertexAttrib3fv(le.location,Se);break;case 4:t.vertexAttrib4fv(le.location,Se);break;default:t.vertexAttrib1fv(le.location,Se)}}}}N()}function w(){L();for(const I in n){const z=n[I];for(const K in z){const $=z[K];for(const te in $)p($[te].object),delete $[te];delete z[K]}delete n[I]}}function T(I){if(n[I.id]===void 0)return;const z=n[I.id];for(const K in z){const $=z[K];for(const te in $)p($[te].object),delete $[te];delete z[K]}delete n[I.id]}function P(I){for(const z in n){const K=n[z];if(K[I.id]===void 0)continue;const $=K[I.id];for(const te in $)p($[te].object),delete $[te];delete K[I.id]}}function L(){k(),o=!0,s!==r&&(s=r,d(s.object))}function k(){r.geometry=null,r.program=null,r.wireframe=!1}return{setup:c,reset:L,resetDefaultState:k,dispose:w,releaseStatesOfGeometry:T,releaseStatesOfProgram:P,initAttributes:E,enableAttribute:M,disableUnusedAttributes:N}}function LM(t,e,i){let n;function r(d){n=d}function s(d,p){t.drawArrays(n,d,p),i.update(p,n,1)}function o(d,p,v){v!==0&&(t.drawArraysInstanced(n,d,p,v),i.update(p,n,v))}function c(d,p,v){if(v===0)return;e.get("WEBGL_multi_draw").multiDrawArraysWEBGL(n,d,0,p,0,v);let _=0;for(let S=0;S<v;S++)_+=p[S];i.update(_,n,1)}function h(d,p,v,g){if(v===0)return;const _=e.get("WEBGL_multi_draw");if(_===null)for(let S=0;S<d.length;S++)o(d[S],p[S],g[S]);else{_.multiDrawArraysInstancedWEBGL(n,d,0,p,0,g,0,v);let S=0;for(let E=0;E<v;E++)S+=p[E]*g[E];i.update(S,n,1)}}this.setMode=r,this.render=s,this.renderInstances=o,this.renderMultiDraw=c,this.renderMultiDrawInstances=h}function OM(t,e,i,n){let r;function s(){if(r!==void 0)return r;if(e.has("EXT_texture_filter_anisotropic")===!0){const P=e.get("EXT_texture_filter_anisotropic");r=t.getParameter(P.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else r=0;return r}function o(P){return!(P!==Sr&&n.convert(P)!==t.getParameter(t.IMPLEMENTATION_COLOR_READ_FORMAT))}function c(P){const L=P===Jo&&(e.has("EXT_color_buffer_half_float")||e.has("EXT_color_buffer_float"));return!(P!==ss&&n.convert(P)!==t.getParameter(t.IMPLEMENTATION_COLOR_READ_TYPE)&&P!==es&&!L)}function h(P){if(P==="highp"){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";P="mediump"}return P==="mediump"&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let d=i.precision!==void 0?i.precision:"highp";const p=h(d);p!==d&&(console.warn("THREE.WebGLRenderer:",d,"not supported, using",p,"instead."),d=p);const v=i.logarithmicDepthBuffer===!0,g=i.reverseDepthBuffer===!0&&e.has("EXT_clip_control"),_=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),S=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),E=t.getParameter(t.MAX_TEXTURE_SIZE),M=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),R=t.getParameter(t.MAX_VERTEX_ATTRIBS),N=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),b=t.getParameter(t.MAX_VARYING_VECTORS),m=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),w=S>0,T=t.getParameter(t.MAX_SAMPLES);return{isWebGL2:!0,getMaxAnisotropy:s,getMaxPrecision:h,textureFormatReadable:o,textureTypeReadable:c,precision:d,logarithmicDepthBuffer:v,reverseDepthBuffer:g,maxTextures:_,maxVertexTextures:S,maxTextureSize:E,maxCubemapSize:M,maxAttributes:R,maxVertexUniforms:N,maxVaryings:b,maxFragmentUniforms:m,vertexTextures:w,maxSamples:T}}function kM(t){const e=this;let i=null,n=0,r=!1,s=!1;const o=new bs,c=new qt,h={value:null,needsUpdate:!1};this.uniform=h,this.numPlanes=0,this.numIntersection=0,this.init=function(v,g){const _=v.length!==0||g||n!==0||r;return r=g,n=v.length,_},this.beginShadows=function(){s=!0,p(null)},this.endShadows=function(){s=!1},this.setGlobalState=function(v,g){i=p(v,g,0)},this.setState=function(v,g,_){const S=v.clippingPlanes,E=v.clipIntersection,M=v.clipShadows,R=t.get(v);if(!r||S===null||S.length===0||s&&!M)s?p(null):d();else{const N=s?0:n,b=N*4;let m=R.clippingState||null;h.value=m,m=p(S,g,b,_);for(let w=0;w!==b;++w)m[w]=i[w];R.clippingState=m,this.numIntersection=E?this.numPlanes:0,this.numPlanes+=N}};function d(){h.value!==i&&(h.value=i,h.needsUpdate=n>0),e.numPlanes=n,e.numIntersection=0}function p(v,g,_,S){const E=v!==null?v.length:0;let M=null;if(E!==0){if(M=h.value,S!==!0||M===null){const R=_+E*4,N=g.matrixWorldInverse;c.getNormalMatrix(N),(M===null||M.length<R)&&(M=new Float32Array(R));for(let b=0,m=_;b!==E;++b,m+=4)o.copy(v[b]).applyMatrix4(N,c),o.normal.toArray(M,m),M[m+3]=o.constant}h.value=M,h.needsUpdate=!0}return e.numPlanes=E,e.numIntersection=0,M}}function UM(t){let e=new WeakMap;function i(o,c){return c===Ou?o.mapping=Za:c===ku&&(o.mapping=Ya),o}function n(o){if(o&&o.isTexture){const c=o.mapping;if(c===Ou||c===ku)if(e.has(o)){const h=e.get(o).texture;return i(h,o.mapping)}else{const h=o.image;if(h&&h.height>0){const d=new HC(h.height);return d.fromEquirectangularTexture(t,o),e.set(o,d),o.addEventListener("dispose",r),i(d.texture,o.mapping)}else return null}}return o}function r(o){const c=o.target;c.removeEventListener("dispose",r);const h=e.get(c);h!==void 0&&(e.delete(c),h.dispose())}function s(){e=new WeakMap}return{get:n,dispose:s}}const Fa=4,Pf=[.125,.215,.35,.446,.526,.582],Xs=20,Jd=new XC,Af=new Ei;let Qd=null,eu=0,tu=0,iu=!1;const Gs=(1+Math.sqrt(5))/2,Ma=1/Gs,Df=[new Ae(-Gs,Ma,0),new Ae(Gs,Ma,0),new Ae(-Ma,0,Gs),new Ae(Ma,0,Gs),new Ae(0,Gs,-Ma),new Ae(0,Gs,Ma),new Ae(-1,1,-1),new Ae(1,1,-1),new Ae(-1,1,1),new Ae(1,1,1)],BM=new Ae;class If{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,i=0,n=.1,r=100,s={}){const{size:o=256,position:c=BM}=s;Qd=this._renderer.getRenderTarget(),eu=this._renderer.getActiveCubeFace(),tu=this._renderer.getActiveMipmapLevel(),iu=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(o);const h=this._allocateTargets();return h.depthBuffer=!0,this._sceneToCubeUV(e,n,r,h,c),i>0&&this._blur(h,0,0,i),this._applyPMREM(h),this._cleanup(h),h}fromEquirectangular(e,i=null){return this._fromTexture(e,i)}fromCubemap(e,i=null){return this._fromTexture(e,i)}compileCubemapShader(){this._cubemapMaterial===null&&(this._cubemapMaterial=Lf(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){this._equirectMaterial===null&&(this._equirectMaterial=Nf(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),this._cubemapMaterial!==null&&this._cubemapMaterial.dispose(),this._equirectMaterial!==null&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){this._blurMaterial!==null&&this._blurMaterial.dispose(),this._pingPongRenderTarget!==null&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(Qd,eu,tu),this._renderer.xr.enabled=iu,e.scissorTest=!1,qc(e,0,0,e.width,e.height)}_fromTexture(e,i){e.mapping===Za||e.mapping===Ya?this._setSize(e.image.length===0?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),Qd=this._renderer.getRenderTarget(),eu=this._renderer.getActiveCubeFace(),tu=this._renderer.getActiveMipmapLevel(),iu=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const n=i||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),i=4*this._cubeSize,n={magFilter:On,minFilter:On,generateMipmaps:!1,type:Jo,format:Sr,colorSpace:Ja,depthBuffer:!1},r=Ff(e,i,n);if(this._pingPongRenderTarget===null||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==i){this._pingPongRenderTarget!==null&&this._dispose(),this._pingPongRenderTarget=Ff(e,i,n);const{_lodMax:s}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=HM(s)),this._blurMaterial=jM(s,e,i)}return r}_compileMaterial(e){const i=new Or(this._lodPlanes[0],e);this._renderer.compile(i,Jd)}_sceneToCubeUV(e,i,n,r,s){const h=new rr(90,1,i,n),d=[1,-1,1,1,1,1],p=[1,1,1,-1,-1,-1],v=this._renderer,g=v.autoClear,_=v.toneMapping;v.getClearColor(Af),v.toneMapping=xs,v.autoClear=!1;const S=new Vh({name:"PMREM.Background",side:Un,depthWrite:!1,depthTest:!1}),E=new Or(new tc,S);let M=!1;const R=e.background;R?R.isColor&&(S.color.copy(R),e.background=null,M=!0):(S.color.copy(Af),M=!0);for(let N=0;N<6;N++){const b=N%3;b===0?(h.up.set(0,d[N],0),h.position.set(s.x,s.y,s.z),h.lookAt(s.x+p[N],s.y,s.z)):b===1?(h.up.set(0,0,d[N]),h.position.set(s.x,s.y,s.z),h.lookAt(s.x,s.y+p[N],s.z)):(h.up.set(0,d[N],0),h.position.set(s.x,s.y,s.z),h.lookAt(s.x,s.y,s.z+p[N]));const m=this._cubeSize;qc(r,b*m,N>2?m:0,m,m),v.setRenderTarget(r),M&&v.render(E,h),v.render(e,h)}E.geometry.dispose(),E.material.dispose(),v.toneMapping=_,v.autoClear=g,e.background=R}_textureToCubeUV(e,i){const n=this._renderer,r=e.mapping===Za||e.mapping===Ya;r?(this._cubemapMaterial===null&&(this._cubemapMaterial=Lf()),this._cubemapMaterial.uniforms.flipEnvMap.value=e.isRenderTargetTexture===!1?-1:1):this._equirectMaterial===null&&(this._equirectMaterial=Nf());const s=r?this._cubemapMaterial:this._equirectMaterial,o=new Or(this._lodPlanes[0],s),c=s.uniforms;c.envMap.value=e;const h=this._cubeSize;qc(i,0,0,3*h,2*h),n.setRenderTarget(i),n.render(o,Jd)}_applyPMREM(e){const i=this._renderer,n=i.autoClear;i.autoClear=!1;const r=this._lodPlanes.length;for(let s=1;s<r;s++){const o=Math.sqrt(this._sigmas[s]*this._sigmas[s]-this._sigmas[s-1]*this._sigmas[s-1]),c=Df[(r-s-1)%Df.length];this._blur(e,s-1,s,o,c)}i.autoClear=n}_blur(e,i,n,r,s){const o=this._pingPongRenderTarget;this._halfBlur(e,o,i,n,r,"latitudinal",s),this._halfBlur(o,e,n,n,r,"longitudinal",s)}_halfBlur(e,i,n,r,s,o,c){const h=this._renderer,d=this._blurMaterial;o!=="latitudinal"&&o!=="longitudinal"&&console.error("blur direction must be either latitudinal or longitudinal!");const p=3,v=new Or(this._lodPlanes[r],d),g=d.uniforms,_=this._sizeLods[n]-1,S=isFinite(s)?Math.PI/(2*_):2*Math.PI/(2*Xs-1),E=s/S,M=isFinite(s)?1+Math.floor(p*E):Xs;M>Xs&&console.warn(`sigmaRadians, ${s}, is too large and will clip, as it requested ${M} samples when the maximum is set to ${Xs}`);const R=[];let N=0;for(let P=0;P<Xs;++P){const L=P/E,k=Math.exp(-L*L/2);R.push(k),P===0?N+=k:P<M&&(N+=2*k)}for(let P=0;P<R.length;P++)R[P]=R[P]/N;g.envMap.value=e.texture,g.samples.value=M,g.weights.value=R,g.latitudinal.value=o==="latitudinal",c&&(g.poleAxis.value=c);const{_lodMax:b}=this;g.dTheta.value=S,g.mipInt.value=b-n;const m=this._sizeLods[r],w=3*m*(r>b-Fa?r-b+Fa:0),T=4*(this._cubeSize-m);qc(i,w,T,3*m,2*m),h.setRenderTarget(i),h.render(v,Jd)}}function HM(t){const e=[],i=[],n=[];let r=t;const s=t-Fa+1+Pf.length;for(let o=0;o<s;o++){const c=Math.pow(2,r);i.push(c);let h=1/c;o>t-Fa?h=Pf[o-t+Fa-1]:o===0&&(h=0),n.push(h);const d=1/(c-2),p=-d,v=1+d,g=[p,p,v,p,v,v,p,p,v,v,p,v],_=6,S=6,E=3,M=2,R=1,N=new Float32Array(E*S*_),b=new Float32Array(M*S*_),m=new Float32Array(R*S*_);for(let T=0;T<_;T++){const P=T%3*2/3-1,L=T>2?0:-1,k=[P,L,0,P+2/3,L,0,P+2/3,L+1,0,P,L,0,P+2/3,L+1,0,P,L+1,0];N.set(k,E*S*T),b.set(g,M*S*T);const I=[T,T,T,T,T,T];m.set(I,R*S*T)}const w=new Ds;w.setAttribute("position",new Ur(N,E)),w.setAttribute("uv",new Ur(b,M)),w.setAttribute("faceIndex",new Ur(m,R)),e.push(w),r>Fa&&r--}return{lodPlanes:e,sizeLods:i,sigmas:n}}function Ff(t,e,i){const n=new aa(t,e,i);return n.texture.mapping=Gl,n.texture.name="PMREM.cubeUv",n.scissorTest=!0,n}function qc(t,e,i,n,r){t.viewport.set(e,i,n,r),t.scissor.set(e,i,n,r)}function jM(t,e,i){const n=new Float32Array(Xs),r=new Ae(0,1,0);return new Ms({name:"SphericalGaussianBlur",defines:{n:Xs,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:`${t}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:n},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:Gh(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

			}
		`,blending:ws,depthTest:!1,depthWrite:!1})}function Nf(){return new Ms({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:Gh(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;

			#include <common>

			void main() {

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				gl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );

			}
		`,blending:ws,depthTest:!1,depthWrite:!1})}function Lf(){return new Ms({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:Gh(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			uniform float flipEnvMap;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			void main() {

				gl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );

			}
		`,blending:ws,depthTest:!1,depthWrite:!1})}function Gh(){return`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function VM(t){let e=new WeakMap,i=null;function n(c){if(c&&c.isTexture){const h=c.mapping,d=h===Ou||h===ku,p=h===Za||h===Ya;if(d||p){let v=e.get(c);const g=v!==void 0?v.texture.pmremVersion:0;if(c.isRenderTargetTexture&&c.pmremVersion!==g)return i===null&&(i=new If(t)),v=d?i.fromEquirectangular(c,v):i.fromCubemap(c,v),v.texture.pmremVersion=c.pmremVersion,e.set(c,v),v.texture;if(v!==void 0)return v.texture;{const _=c.image;return d&&_&&_.height>0||p&&_&&r(_)?(i===null&&(i=new If(t)),v=d?i.fromEquirectangular(c):i.fromCubemap(c),v.texture.pmremVersion=c.pmremVersion,e.set(c,v),c.addEventListener("dispose",s),v.texture):null}}}return c}function r(c){let h=0;const d=6;for(let p=0;p<d;p++)c[p]!==void 0&&h++;return h===d}function s(c){const h=c.target;h.removeEventListener("dispose",s);const d=e.get(h);d!==void 0&&(e.delete(h),d.dispose())}function o(){e=new WeakMap,i!==null&&(i.dispose(),i=null)}return{get:n,dispose:o}}function zM(t){const e={};function i(n){if(e[n]!==void 0)return e[n];let r;switch(n){case"WEBGL_depth_texture":r=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:r=t.getExtension(n)}return e[n]=r,r}return{has:function(n){return i(n)!==null},init:function(){i("EXT_color_buffer_float"),i("WEBGL_clip_cull_distance"),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("WEBGL_multisampled_render_to_texture"),i("WEBGL_render_shared_exponent")},get:function(n){const r=i(n);return r===null&&Ba("THREE.WebGLRenderer: "+n+" extension not supported."),r}}}function GM(t,e,i,n){const r={},s=new WeakMap;function o(v){const g=v.target;g.index!==null&&e.remove(g.index);for(const S in g.attributes)e.remove(g.attributes[S]);g.removeEventListener("dispose",o),delete r[g.id];const _=s.get(g);_&&(e.remove(_),s.delete(g)),n.releaseStatesOfGeometry(g),g.isInstancedBufferGeometry===!0&&delete g._maxInstanceCount,i.memory.geometries--}function c(v,g){return r[g.id]===!0||(g.addEventListener("dispose",o),r[g.id]=!0,i.memory.geometries++),g}function h(v){const g=v.attributes;for(const _ in g)e.update(g[_],t.ARRAY_BUFFER)}function d(v){const g=[],_=v.index,S=v.attributes.position;let E=0;if(_!==null){const N=_.array;E=_.version;for(let b=0,m=N.length;b<m;b+=3){const w=N[b+0],T=N[b+1],P=N[b+2];g.push(w,T,T,P,P,w)}}else if(S!==void 0){const N=S.array;E=S.version;for(let b=0,m=N.length/3-1;b<m;b+=3){const w=b+0,T=b+1,P=b+2;g.push(w,T,T,P,P,w)}}else return;const M=new(Mv(g)?Nv:Fv)(g,1);M.version=E;const R=s.get(v);R&&e.remove(R),s.set(v,M)}function p(v){const g=s.get(v);if(g){const _=v.index;_!==null&&g.version<_.version&&d(v)}else d(v);return s.get(v)}return{get:c,update:h,getWireframeAttribute:p}}function qM(t,e,i){let n;function r(g){n=g}let s,o;function c(g){s=g.type,o=g.bytesPerElement}function h(g,_){t.drawElements(n,_,s,g*o),i.update(_,n,1)}function d(g,_,S){S!==0&&(t.drawElementsInstanced(n,_,s,g*o,S),i.update(_,n,S))}function p(g,_,S){if(S===0)return;e.get("WEBGL_multi_draw").multiDrawElementsWEBGL(n,_,0,s,g,0,S);let M=0;for(let R=0;R<S;R++)M+=_[R];i.update(M,n,1)}function v(g,_,S,E){if(S===0)return;const M=e.get("WEBGL_multi_draw");if(M===null)for(let R=0;R<g.length;R++)d(g[R]/o,_[R],E[R]);else{M.multiDrawElementsInstancedWEBGL(n,_,0,s,g,0,E,0,S);let R=0;for(let N=0;N<S;N++)R+=_[N]*E[N];i.update(R,n,1)}}this.setMode=r,this.setIndex=c,this.render=h,this.renderInstances=d,this.renderMultiDraw=p,this.renderMultiDrawInstances=v}function WM(t){const e={geometries:0,textures:0},i={frame:0,calls:0,triangles:0,points:0,lines:0};function n(s,o,c){switch(i.calls++,o){case t.TRIANGLES:i.triangles+=c*(s/3);break;case t.LINES:i.lines+=c*(s/2);break;case t.LINE_STRIP:i.lines+=c*(s-1);break;case t.LINE_LOOP:i.lines+=c*s;break;case t.POINTS:i.points+=c*s;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",o);break}}function r(){i.calls=0,i.triangles=0,i.points=0,i.lines=0}return{memory:e,render:i,programs:null,autoReset:!0,reset:r,update:n}}function KM(t,e,i){const n=new WeakMap,r=new ji;function s(o,c,h){const d=o.morphTargetInfluences,p=c.morphAttributes.position||c.morphAttributes.normal||c.morphAttributes.color,v=p!==void 0?p.length:0;let g=n.get(c);if(g===void 0||g.count!==v){let I=function(){L.dispose(),n.delete(c),c.removeEventListener("dispose",I)};var _=I;g!==void 0&&g.texture.dispose();const S=c.morphAttributes.position!==void 0,E=c.morphAttributes.normal!==void 0,M=c.morphAttributes.color!==void 0,R=c.morphAttributes.position||[],N=c.morphAttributes.normal||[],b=c.morphAttributes.color||[];let m=0;S===!0&&(m=1),E===!0&&(m=2),M===!0&&(m=3);let w=c.attributes.position.count*m,T=1;w>e.maxTextureSize&&(T=Math.ceil(w/e.maxTextureSize),w=e.maxTextureSize);const P=new Float32Array(w*T*4*v),L=new Pv(P,w,T,v);L.type=es,L.needsUpdate=!0;const k=m*4;for(let z=0;z<v;z++){const K=R[z],$=N[z],te=b[z],ee=w*T*4*z;for(let de=0;de<K.count;de++){const X=de*k;S===!0&&(r.fromBufferAttribute(K,de),P[ee+X+0]=r.x,P[ee+X+1]=r.y,P[ee+X+2]=r.z,P[ee+X+3]=0),E===!0&&(r.fromBufferAttribute($,de),P[ee+X+4]=r.x,P[ee+X+5]=r.y,P[ee+X+6]=r.z,P[ee+X+7]=0),M===!0&&(r.fromBufferAttribute(te,de),P[ee+X+8]=r.x,P[ee+X+9]=r.y,P[ee+X+10]=r.z,P[ee+X+11]=te.itemSize===4?r.w:1)}}g={count:v,texture:L,size:new $t(w,T)},n.set(c,g),c.addEventListener("dispose",I)}if(o.isInstancedMesh===!0&&o.morphTexture!==null)h.getUniforms().setValue(t,"morphTexture",o.morphTexture,i);else{let S=0;for(let M=0;M<d.length;M++)S+=d[M];const E=c.morphTargetsRelative?1:1-S;h.getUniforms().setValue(t,"morphTargetBaseInfluence",E),h.getUniforms().setValue(t,"morphTargetInfluences",d)}h.getUniforms().setValue(t,"morphTargetsTexture",g.texture,i),h.getUniforms().setValue(t,"morphTargetsTextureSize",g.size)}return{update:s}}function XM(t,e,i,n){let r=new WeakMap;function s(h){const d=n.render.frame,p=h.geometry,v=e.get(h,p);if(r.get(v)!==d&&(e.update(v),r.set(v,d)),h.isInstancedMesh&&(h.hasEventListener("dispose",c)===!1&&h.addEventListener("dispose",c),r.get(h)!==d&&(i.update(h.instanceMatrix,t.ARRAY_BUFFER),h.instanceColor!==null&&i.update(h.instanceColor,t.ARRAY_BUFFER),r.set(h,d))),h.isSkinnedMesh){const g=h.skeleton;r.get(g)!==d&&(g.update(),r.set(g,d))}return v}function o(){r=new WeakMap}function c(h){const d=h.target;d.removeEventListener("dispose",c),i.remove(d.instanceMatrix),d.instanceColor!==null&&i.remove(d.instanceColor)}return{update:s,dispose:o}}const jv=new Tn,Of=new Bv(1,1),Vv=new Pv,zv=new xC,Gv=new kv,kf=[],Uf=[],Bf=new Float32Array(16),Hf=new Float32Array(9),jf=new Float32Array(4);function no(t,e,i){const n=t[0];if(n<=0||n>0)return t;const r=e*i;let s=kf[r];if(s===void 0&&(s=new Float32Array(r),kf[r]=s),e!==0){n.toArray(s,0);for(let o=1,c=0;o!==e;++o)c+=i,t[o].toArray(s,c)}return s}function Qi(t,e){if(t.length!==e.length)return!1;for(let i=0,n=t.length;i<n;i++)if(t[i]!==e[i])return!1;return!0}function en(t,e){for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}function Kl(t,e){let i=Uf[e];i===void 0&&(i=new Int32Array(e),Uf[e]=i);for(let n=0;n!==e;++n)i[n]=t.allocateTextureUnit();return i}function $M(t,e){const i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function ZM(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y)&&(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Qi(i,e))return;t.uniform2fv(this.addr,e),en(i,e)}}function YM(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y||i[2]!==e.z)&&(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(e.r!==void 0)(i[0]!==e.r||i[1]!==e.g||i[2]!==e.b)&&(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(Qi(i,e))return;t.uniform3fv(this.addr,e),en(i,e)}}function JM(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y||i[2]!==e.z||i[3]!==e.w)&&(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Qi(i,e))return;t.uniform4fv(this.addr,e),en(i,e)}}function QM(t,e){const i=this.cache,n=e.elements;if(n===void 0){if(Qi(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),en(i,e)}else{if(Qi(i,n))return;jf.set(n),t.uniformMatrix2fv(this.addr,!1,jf),en(i,n)}}function eP(t,e){const i=this.cache,n=e.elements;if(n===void 0){if(Qi(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),en(i,e)}else{if(Qi(i,n))return;Hf.set(n),t.uniformMatrix3fv(this.addr,!1,Hf),en(i,n)}}function tP(t,e){const i=this.cache,n=e.elements;if(n===void 0){if(Qi(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),en(i,e)}else{if(Qi(i,n))return;Bf.set(n),t.uniformMatrix4fv(this.addr,!1,Bf),en(i,n)}}function iP(t,e){const i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function nP(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y)&&(t.uniform2i(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Qi(i,e))return;t.uniform2iv(this.addr,e),en(i,e)}}function rP(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y||i[2]!==e.z)&&(t.uniform3i(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(Qi(i,e))return;t.uniform3iv(this.addr,e),en(i,e)}}function sP(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y||i[2]!==e.z||i[3]!==e.w)&&(t.uniform4i(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Qi(i,e))return;t.uniform4iv(this.addr,e),en(i,e)}}function aP(t,e){const i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function oP(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y)&&(t.uniform2ui(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(Qi(i,e))return;t.uniform2uiv(this.addr,e),en(i,e)}}function cP(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y||i[2]!==e.z)&&(t.uniform3ui(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else{if(Qi(i,e))return;t.uniform3uiv(this.addr,e),en(i,e)}}function lP(t,e){const i=this.cache;if(e.x!==void 0)(i[0]!==e.x||i[1]!==e.y||i[2]!==e.z||i[3]!==e.w)&&(t.uniform4ui(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(Qi(i,e))return;t.uniform4uiv(this.addr,e),en(i,e)}}function dP(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r);let s;this.type===t.SAMPLER_2D_SHADOW?(Of.compareFunction=Rv,s=Of):s=jv,i.setTexture2D(e||s,r)}function uP(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(e||zv,r)}function hP(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTextureCube(e||Gv,r)}function pP(t,e,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(t.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(e||Vv,r)}function fP(t){switch(t){case 5126:return $M;case 35664:return ZM;case 35665:return YM;case 35666:return JM;case 35674:return QM;case 35675:return eP;case 35676:return tP;case 5124:case 35670:return iP;case 35667:case 35671:return nP;case 35668:case 35672:return rP;case 35669:case 35673:return sP;case 5125:return aP;case 36294:return oP;case 36295:return cP;case 36296:return lP;case 35678:case 36198:case 36298:case 36306:case 35682:return dP;case 35679:case 36299:case 36307:return uP;case 35680:case 36300:case 36308:case 36293:return hP;case 36289:case 36303:case 36311:case 36292:return pP}}function mP(t,e){t.uniform1fv(this.addr,e)}function gP(t,e){const i=no(e,this.size,2);t.uniform2fv(this.addr,i)}function vP(t,e){const i=no(e,this.size,3);t.uniform3fv(this.addr,i)}function _P(t,e){const i=no(e,this.size,4);t.uniform4fv(this.addr,i)}function bP(t,e){const i=no(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,i)}function yP(t,e){const i=no(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,i)}function SP(t,e){const i=no(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,i)}function wP(t,e){t.uniform1iv(this.addr,e)}function xP(t,e){t.uniform2iv(this.addr,e)}function EP(t,e){t.uniform3iv(this.addr,e)}function CP(t,e){t.uniform4iv(this.addr,e)}function TP(t,e){t.uniform1uiv(this.addr,e)}function RP(t,e){t.uniform2uiv(this.addr,e)}function MP(t,e){t.uniform3uiv(this.addr,e)}function PP(t,e){t.uniform4uiv(this.addr,e)}function AP(t,e,i){const n=this.cache,r=e.length,s=Kl(i,r);Qi(n,s)||(t.uniform1iv(this.addr,s),en(n,s));for(let o=0;o!==r;++o)i.setTexture2D(e[o]||jv,s[o])}function DP(t,e,i){const n=this.cache,r=e.length,s=Kl(i,r);Qi(n,s)||(t.uniform1iv(this.addr,s),en(n,s));for(let o=0;o!==r;++o)i.setTexture3D(e[o]||zv,s[o])}function IP(t,e,i){const n=this.cache,r=e.length,s=Kl(i,r);Qi(n,s)||(t.uniform1iv(this.addr,s),en(n,s));for(let o=0;o!==r;++o)i.setTextureCube(e[o]||Gv,s[o])}function FP(t,e,i){const n=this.cache,r=e.length,s=Kl(i,r);Qi(n,s)||(t.uniform1iv(this.addr,s),en(n,s));for(let o=0;o!==r;++o)i.setTexture2DArray(e[o]||Vv,s[o])}function NP(t){switch(t){case 5126:return mP;case 35664:return gP;case 35665:return vP;case 35666:return _P;case 35674:return bP;case 35675:return yP;case 35676:return SP;case 5124:case 35670:return wP;case 35667:case 35671:return xP;case 35668:case 35672:return EP;case 35669:case 35673:return CP;case 5125:return TP;case 36294:return RP;case 36295:return MP;case 36296:return PP;case 35678:case 36198:case 36298:case 36306:case 35682:return AP;case 35679:case 36299:case 36307:return DP;case 35680:case 36300:case 36308:case 36293:return IP;case 36289:case 36303:case 36311:case 36292:return FP}}class LP{constructor(e,i,n){this.id=e,this.addr=n,this.cache=[],this.type=i.type,this.setValue=fP(i.type)}}class OP{constructor(e,i,n){this.id=e,this.addr=n,this.cache=[],this.type=i.type,this.size=i.size,this.setValue=NP(i.type)}}class kP{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,i,n){const r=this.seq;for(let s=0,o=r.length;s!==o;++s){const c=r[s];c.setValue(e,i[c.id],n)}}}const nu=/(\w+)(\])?(\[|\.)?/g;function Vf(t,e){t.seq.push(e),t.map[e.id]=e}function UP(t,e,i){const n=t.name,r=n.length;for(nu.lastIndex=0;;){const s=nu.exec(n),o=nu.lastIndex;let c=s[1];const h=s[2]==="]",d=s[3];if(h&&(c=c|0),d===void 0||d==="["&&o+2===r){Vf(i,d===void 0?new LP(c,t,e):new OP(c,t,e));break}else{let v=i.map[c];v===void 0&&(v=new kP(c),Vf(i,v)),i=v}}}class cl{constructor(e,i){this.seq=[],this.map={};const n=e.getProgramParameter(i,e.ACTIVE_UNIFORMS);for(let r=0;r<n;++r){const s=e.getActiveUniform(i,r),o=e.getUniformLocation(i,s.name);UP(s,o,this)}}setValue(e,i,n,r){const s=this.map[i];s!==void 0&&s.setValue(e,n,r)}setOptional(e,i,n){const r=i[n];r!==void 0&&this.setValue(e,n,r)}static upload(e,i,n,r){for(let s=0,o=i.length;s!==o;++s){const c=i[s],h=n[c.id];h.needsUpdate!==!1&&c.setValue(e,h.value,r)}}static seqWithValue(e,i){const n=[];for(let r=0,s=e.length;r!==s;++r){const o=e[r];o.id in i&&n.push(o)}return n}}function zf(t,e,i){const n=t.createShader(e);return t.shaderSource(n,i),t.compileShader(n),n}const BP=37297;let HP=0;function jP(t,e){const i=t.split(`
`),n=[],r=Math.max(e-6,0),s=Math.min(e+6,i.length);for(let o=r;o<s;o++){const c=o+1;n.push(`${c===e?">":" "} ${c}: ${i[o]}`)}return n.join(`
`)}const Gf=new qt;function VP(t){ci._getMatrix(Gf,ci.workingColorSpace,t);const e=`mat3( ${Gf.elements.map(i=>i.toFixed(4))} )`;switch(ci.getTransfer(t)){case Sl:return[e,"LinearTransferOETF"];case wi:return[e,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space: ",t),[e,"LinearTransferOETF"]}}function qf(t,e,i){const n=t.getShaderParameter(e,t.COMPILE_STATUS),r=t.getShaderInfoLog(e).trim();if(n&&r==="")return"";const s=/ERROR: 0:(\d+)/.exec(r);if(s){const o=parseInt(s[1]);return i.toUpperCase()+`

`+r+`

`+jP(t.getShaderSource(e),o)}else return r}function zP(t,e){const i=VP(e);return[`vec4 ${t}( vec4 value ) {`,`	return ${i[1]}( vec4( value.rgb * ${i[0]}, value.a ) );`,"}"].join(`
`)}function GP(t,e){let i;switch(e){case KE:i="Linear";break;case XE:i="Reinhard";break;case $E:i="Cineon";break;case ZE:i="ACESFilmic";break;case JE:i="AgX";break;case QE:i="Neutral";break;case YE:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}const Wc=new Ae;function qP(){ci.getLuminanceCoefficients(Wc);const t=Wc.x.toFixed(4),e=Wc.y.toFixed(4),i=Wc.z.toFixed(4);return["float luminance( const in vec3 rgb ) {",`	const vec3 weights = vec3( ${t}, ${e}, ${i} );`,"	return dot( weights, rgb );","}"].join(`
`)}function WP(t){return[t.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",t.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(To).join(`
`)}function KP(t){const e=[];for(const i in t){const n=t[i];n!==!1&&e.push("#define "+i+" "+n)}return e.join(`
`)}function XP(t,e){const i={},n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let r=0;r<n;r++){const s=t.getActiveAttrib(e,r),o=s.name;let c=1;s.type===t.FLOAT_MAT2&&(c=2),s.type===t.FLOAT_MAT3&&(c=3),s.type===t.FLOAT_MAT4&&(c=4),i[o]={type:s.type,location:t.getAttribLocation(e,o),locationSize:c}}return i}function To(t){return t!==""}function Wf(t,e){const i=e.numSpotLightShadows+e.numSpotLightMaps-e.numSpotLightShadowsWithMaps;return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,e.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,e.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Kf(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const $P=/^[ \t]*#include +<([\w\d./]+)>/gm;function ph(t){return t.replace($P,YP)}const ZP=new Map;function YP(t,e){let i=Wt[e];if(i===void 0){const n=ZP.get(e);if(n!==void 0)i=Wt[n],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',e,n);else throw new Error("Can not resolve #include <"+e+">")}return ph(i)}const JP=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Xf(t){return t.replace(JP,QP)}function QP(t,e,i,n){let r="";for(let s=parseInt(e);s<parseInt(i);s++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+s+" ]").replace(/UNROLLED_LOOP_INDEX/g,s);return r}function $f(t){let e=`precision ${t.precision} float;
	precision ${t.precision} int;
	precision ${t.precision} sampler2D;
	precision ${t.precision} samplerCube;
	precision ${t.precision} sampler3D;
	precision ${t.precision} sampler2DArray;
	precision ${t.precision} sampler2DShadow;
	precision ${t.precision} samplerCubeShadow;
	precision ${t.precision} sampler2DArrayShadow;
	precision ${t.precision} isampler2D;
	precision ${t.precision} isampler3D;
	precision ${t.precision} isamplerCube;
	precision ${t.precision} isampler2DArray;
	precision ${t.precision} usampler2D;
	precision ${t.precision} usampler3D;
	precision ${t.precision} usamplerCube;
	precision ${t.precision} usampler2DArray;
	`;return t.precision==="highp"?e+=`
#define HIGH_PRECISION`:t.precision==="mediump"?e+=`
#define MEDIUM_PRECISION`:t.precision==="lowp"&&(e+=`
#define LOW_PRECISION`),e}function eA(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===vv?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===TE?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===Yr&&(e="SHADOWMAP_TYPE_VSM"),e}function tA(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case Za:case Ya:e="ENVMAP_TYPE_CUBE";break;case Gl:e="ENVMAP_TYPE_CUBE_UV";break}return e}function iA(t){let e="ENVMAP_MODE_REFLECTION";if(t.envMap)switch(t.envMapMode){case Ya:e="ENVMAP_MODE_REFRACTION";break}return e}function nA(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case _v:e="ENVMAP_BLENDING_MULTIPLY";break;case qE:e="ENVMAP_BLENDING_MIX";break;case WE:e="ENVMAP_BLENDING_ADD";break}return e}function rA(t){const e=t.envMapCubeUVHeight;if(e===null)return null;const i=Math.log2(e)-2,n=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,i),7*16)),texelHeight:n,maxMip:i}}function sA(t,e,i,n){const r=t.getContext(),s=i.defines;let o=i.vertexShader,c=i.fragmentShader;const h=eA(i),d=tA(i),p=iA(i),v=nA(i),g=rA(i),_=WP(i),S=KP(s),E=r.createProgram();let M,R,N=i.glslVersion?"#version "+i.glslVersion+`
`:"";i.isRawShaderMaterial?(M=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,S].filter(To).join(`
`),M.length>0&&(M+=`
`),R=["#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,S].filter(To).join(`
`),R.length>0&&(R+=`
`)):(M=[$f(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,S,i.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",i.batching?"#define USE_BATCHING":"",i.batchingColor?"#define USE_BATCHING_COLOR":"",i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.instancingMorph?"#define USE_INSTANCING_MORPH":"",i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+p:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.displacementMap?"#define USE_DISPLACEMENTMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.mapUv?"#define MAP_UV "+i.mapUv:"",i.alphaMapUv?"#define ALPHAMAP_UV "+i.alphaMapUv:"",i.lightMapUv?"#define LIGHTMAP_UV "+i.lightMapUv:"",i.aoMapUv?"#define AOMAP_UV "+i.aoMapUv:"",i.emissiveMapUv?"#define EMISSIVEMAP_UV "+i.emissiveMapUv:"",i.bumpMapUv?"#define BUMPMAP_UV "+i.bumpMapUv:"",i.normalMapUv?"#define NORMALMAP_UV "+i.normalMapUv:"",i.displacementMapUv?"#define DISPLACEMENTMAP_UV "+i.displacementMapUv:"",i.metalnessMapUv?"#define METALNESSMAP_UV "+i.metalnessMapUv:"",i.roughnessMapUv?"#define ROUGHNESSMAP_UV "+i.roughnessMapUv:"",i.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+i.anisotropyMapUv:"",i.clearcoatMapUv?"#define CLEARCOATMAP_UV "+i.clearcoatMapUv:"",i.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+i.clearcoatNormalMapUv:"",i.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+i.clearcoatRoughnessMapUv:"",i.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+i.iridescenceMapUv:"",i.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+i.iridescenceThicknessMapUv:"",i.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+i.sheenColorMapUv:"",i.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+i.sheenRoughnessMapUv:"",i.specularMapUv?"#define SPECULARMAP_UV "+i.specularMapUv:"",i.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+i.specularColorMapUv:"",i.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+i.specularIntensityMapUv:"",i.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+i.transmissionMapUv:"",i.thicknessMapUv?"#define THICKNESSMAP_UV "+i.thicknessMapUv:"",i.vertexTangents&&i.flatShading===!1?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&i.flatShading===!1?"#define USE_MORPHNORMALS":"",i.morphColors?"#define USE_MORPHCOLORS":"",i.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+i.morphTextureStride:"",i.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","	uniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","	attribute vec2 uv1;","#endif","#ifdef USE_UV2","	attribute vec2 uv2;","#endif","#ifdef USE_UV3","	attribute vec2 uv3;","#endif","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter(To).join(`
`),R=[$f(i),"#define SHADER_TYPE "+i.shaderType,"#define SHADER_NAME "+i.shaderName,S,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+d:"",i.envMap?"#define "+p:"",i.envMap?"#define "+v:"",g?"#define CUBEUV_TEXEL_WIDTH "+g.texelWidth:"",g?"#define CUBEUV_TEXEL_HEIGHT "+g.texelHeight:"",g?"#define CUBEUV_MAX_MIP "+g.maxMip+".0":"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",i.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.anisotropy?"#define USE_ANISOTROPY":"",i.anisotropyMap?"#define USE_ANISOTROPYMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.dispersion?"#define USE_DISPERSION":"",i.iridescence?"#define USE_IRIDESCENCE":"",i.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",i.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",i.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.alphaHash?"#define USE_ALPHAHASH":"",i.sheen?"#define USE_SHEEN":"",i.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",i.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents&&i.flatShading===!1?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor||i.batchingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUv1s?"#define USE_UV1":"",i.vertexUv2s?"#define USE_UV2":"",i.vertexUv3s?"#define USE_UV3":"",i.pointsUvs?"#define USE_POINTS_UV":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+h:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.numLightProbes>0?"#define USE_LIGHT_PROBES":"",i.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",i.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",i.toneMapping!==xs?"#define TONE_MAPPING":"",i.toneMapping!==xs?Wt.tonemapping_pars_fragment:"",i.toneMapping!==xs?GP("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",i.opaque?"#define OPAQUE":"",Wt.colorspace_pars_fragment,zP("linearToOutputTexel",i.outputColorSpace),qP(),i.useDepthPacking?"#define DEPTH_PACKING "+i.depthPacking:"",`
`].filter(To).join(`
`)),o=ph(o),o=Wf(o,i),o=Kf(o,i),c=ph(c),c=Wf(c,i),c=Kf(c,i),o=Xf(o),c=Xf(c),i.isRawShaderMaterial!==!0&&(N=`#version 300 es
`,M=[_,"#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+M,R=["#define varying in",i.glslVersion===lf?"":"layout(location = 0) out highp vec4 pc_fragColor;",i.glslVersion===lf?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join(`
`)+`
`+R);const b=N+M+o,m=N+R+c,w=zf(r,r.VERTEX_SHADER,b),T=zf(r,r.FRAGMENT_SHADER,m);r.attachShader(E,w),r.attachShader(E,T),i.index0AttributeName!==void 0?r.bindAttribLocation(E,0,i.index0AttributeName):i.morphTargets===!0&&r.bindAttribLocation(E,0,"position"),r.linkProgram(E);function P(z){if(t.debug.checkShaderErrors){const K=r.getProgramInfoLog(E).trim(),$=r.getShaderInfoLog(w).trim(),te=r.getShaderInfoLog(T).trim();let ee=!0,de=!0;if(r.getProgramParameter(E,r.LINK_STATUS)===!1)if(ee=!1,typeof t.debug.onShaderError=="function")t.debug.onShaderError(r,E,w,T);else{const X=qf(r,w,"vertex"),le=qf(r,T,"fragment");console.error("THREE.WebGLProgram: Shader Error "+r.getError()+" - VALIDATE_STATUS "+r.getProgramParameter(E,r.VALIDATE_STATUS)+`

Material Name: `+z.name+`
Material Type: `+z.type+`

Program Info Log: `+K+`
`+X+`
`+le)}else K!==""?console.warn("THREE.WebGLProgram: Program Info Log:",K):($===""||te==="")&&(de=!1);de&&(z.diagnostics={runnable:ee,programLog:K,vertexShader:{log:$,prefix:M},fragmentShader:{log:te,prefix:R}})}r.deleteShader(w),r.deleteShader(T),L=new cl(r,E),k=XP(r,E)}let L;this.getUniforms=function(){return L===void 0&&P(this),L};let k;this.getAttributes=function(){return k===void 0&&P(this),k};let I=i.rendererExtensionParallelShaderCompile===!1;return this.isReady=function(){return I===!1&&(I=r.getProgramParameter(E,BP)),I},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(E),this.program=void 0},this.type=i.shaderType,this.name=i.shaderName,this.id=HP++,this.cacheKey=e,this.usedTimes=1,this.program=E,this.vertexShader=w,this.fragmentShader=T,this}let aA=0;class oA{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const i=e.vertexShader,n=e.fragmentShader,r=this._getShaderStage(i),s=this._getShaderStage(n),o=this._getShaderCacheForMaterial(e);return o.has(r)===!1&&(o.add(r),r.usedTimes++),o.has(s)===!1&&(o.add(s),s.usedTimes++),this}remove(e){const i=this.materialCache.get(e);for(const n of i)n.usedTimes--,n.usedTimes===0&&this.shaderCache.delete(n.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const i=this.materialCache;let n=i.get(e);return n===void 0&&(n=new Set,i.set(e,n)),n}_getShaderStage(e){const i=this.shaderCache;let n=i.get(e);return n===void 0&&(n=new cA(e),i.set(e,n)),n}}class cA{constructor(e){this.id=aA++,this.code=e,this.usedTimes=0}}function lA(t,e,i,n,r,s,o){const c=new Dv,h=new oA,d=new Set,p=[],v=r.logarithmicDepthBuffer,g=r.vertexTextures;let _=r.precision;const S={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function E(k){return d.add(k),k===0?"uv":`uv${k}`}function M(k,I,z,K,$){const te=K.fog,ee=$.geometry,de=k.isMeshStandardMaterial?K.environment:null,X=(k.isMeshStandardMaterial?i:e).get(k.envMap||de),le=X&&X.mapping===Gl?X.image.height:null,_e=S[k.type];k.precision!==null&&(_=r.getMaxPrecision(k.precision),_!==k.precision&&console.warn("THREE.WebGLProgram.getParameters:",k.precision,"not supported, using",_,"instead."));const Se=ee.morphAttributes.position||ee.morphAttributes.normal||ee.morphAttributes.color,De=Se!==void 0?Se.length:0;let We=0;ee.morphAttributes.position!==void 0&&(We=1),ee.morphAttributes.normal!==void 0&&(We=2),ee.morphAttributes.color!==void 0&&(We=3);let Ve,Me,ze,ht;if(_e){const ui=Lr[_e];Ve=ui.vertexShader,Me=ui.fragmentShader}else Ve=k.vertexShader,Me=k.fragmentShader,h.update(k),ze=h.getVertexShaderID(k),ht=h.getFragmentShaderID(k);const nt=t.getRenderTarget(),rt=t.state.buffers.depth.getReversed(),jt=$.isInstancedMesh===!0,Ct=$.isBatchedMesh===!0,li=!!k.map,di=!!k.matcap,zt=!!X,he=!!k.aoMap,mi=!!k.lightMap,ti=!!k.bumpMap,si=!!k.normalMap,yt=!!k.displacementMap,Xt=!!k.emissiveMap,Rt=!!k.metalnessMap,Ut=!!k.roughnessMap,Ii=k.anisotropy>0,ue=k.clearcoat>0,ie=k.dispersion>0,Re=k.iridescence>0,Pe=k.sheen>0,Oe=k.transmission>0,Ce=Ii&&!!k.anisotropyMap,tt=ue&&!!k.clearcoatMap,et=ue&&!!k.clearcoatNormalMap,ut=ue&&!!k.clearcoatRoughnessMap,Qe=Re&&!!k.iridescenceMap,Ie=Re&&!!k.iridescenceThicknessMap,it=Pe&&!!k.sheenColorMap,Pt=Pe&&!!k.sheenRoughnessMap,Mt=!!k.specularMap,st=!!k.specularColorMap,kt=!!k.specularIntensityMap,ve=Oe&&!!k.transmissionMap,ot=Oe&&!!k.thicknessMap,Ke=!!k.gradientMap,bt=!!k.alphaMap,Ze=k.alphaTest>0,Ge=!!k.alphaHash,St=!!k.extensions;let Bt=xs;k.toneMapped&&(nt===null||nt.isXRRenderTarget===!0)&&(Bt=t.toneMapping);const Ci={shaderID:_e,shaderType:k.type,shaderName:k.name,vertexShader:Ve,fragmentShader:Me,defines:k.defines,customVertexShaderID:ze,customFragmentShaderID:ht,isRawShaderMaterial:k.isRawShaderMaterial===!0,glslVersion:k.glslVersion,precision:_,batching:Ct,batchingColor:Ct&&$._colorsTexture!==null,instancing:jt,instancingColor:jt&&$.instanceColor!==null,instancingMorph:jt&&$.morphTexture!==null,supportsVertexTextures:g,outputColorSpace:nt===null?t.outputColorSpace:nt.isXRRenderTarget===!0?nt.texture.colorSpace:Ja,alphaToCoverage:!!k.alphaToCoverage,map:li,matcap:di,envMap:zt,envMapMode:zt&&X.mapping,envMapCubeUVHeight:le,aoMap:he,lightMap:mi,bumpMap:ti,normalMap:si,displacementMap:g&&yt,emissiveMap:Xt,normalMapObjectSpace:si&&k.normalMapType===rC,normalMapTangentSpace:si&&k.normalMapType===nC,metalnessMap:Rt,roughnessMap:Ut,anisotropy:Ii,anisotropyMap:Ce,clearcoat:ue,clearcoatMap:tt,clearcoatNormalMap:et,clearcoatRoughnessMap:ut,dispersion:ie,iridescence:Re,iridescenceMap:Qe,iridescenceThicknessMap:Ie,sheen:Pe,sheenColorMap:it,sheenRoughnessMap:Pt,specularMap:Mt,specularColorMap:st,specularIntensityMap:kt,transmission:Oe,transmissionMap:ve,thicknessMap:ot,gradientMap:Ke,opaque:k.transparent===!1&&k.blending===Ua&&k.alphaToCoverage===!1,alphaMap:bt,alphaTest:Ze,alphaHash:Ge,combine:k.combine,mapUv:li&&E(k.map.channel),aoMapUv:he&&E(k.aoMap.channel),lightMapUv:mi&&E(k.lightMap.channel),bumpMapUv:ti&&E(k.bumpMap.channel),normalMapUv:si&&E(k.normalMap.channel),displacementMapUv:yt&&E(k.displacementMap.channel),emissiveMapUv:Xt&&E(k.emissiveMap.channel),metalnessMapUv:Rt&&E(k.metalnessMap.channel),roughnessMapUv:Ut&&E(k.roughnessMap.channel),anisotropyMapUv:Ce&&E(k.anisotropyMap.channel),clearcoatMapUv:tt&&E(k.clearcoatMap.channel),clearcoatNormalMapUv:et&&E(k.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:ut&&E(k.clearcoatRoughnessMap.channel),iridescenceMapUv:Qe&&E(k.iridescenceMap.channel),iridescenceThicknessMapUv:Ie&&E(k.iridescenceThicknessMap.channel),sheenColorMapUv:it&&E(k.sheenColorMap.channel),sheenRoughnessMapUv:Pt&&E(k.sheenRoughnessMap.channel),specularMapUv:Mt&&E(k.specularMap.channel),specularColorMapUv:st&&E(k.specularColorMap.channel),specularIntensityMapUv:kt&&E(k.specularIntensityMap.channel),transmissionMapUv:ve&&E(k.transmissionMap.channel),thicknessMapUv:ot&&E(k.thicknessMap.channel),alphaMapUv:bt&&E(k.alphaMap.channel),vertexTangents:!!ee.attributes.tangent&&(si||Ii),vertexColors:k.vertexColors,vertexAlphas:k.vertexColors===!0&&!!ee.attributes.color&&ee.attributes.color.itemSize===4,pointsUvs:$.isPoints===!0&&!!ee.attributes.uv&&(li||bt),fog:!!te,useFog:k.fog===!0,fogExp2:!!te&&te.isFogExp2,flatShading:k.flatShading===!0,sizeAttenuation:k.sizeAttenuation===!0,logarithmicDepthBuffer:v,reverseDepthBuffer:rt,skinning:$.isSkinnedMesh===!0,morphTargets:ee.morphAttributes.position!==void 0,morphNormals:ee.morphAttributes.normal!==void 0,morphColors:ee.morphAttributes.color!==void 0,morphTargetsCount:De,morphTextureStride:We,numDirLights:I.directional.length,numPointLights:I.point.length,numSpotLights:I.spot.length,numSpotLightMaps:I.spotLightMap.length,numRectAreaLights:I.rectArea.length,numHemiLights:I.hemi.length,numDirLightShadows:I.directionalShadowMap.length,numPointLightShadows:I.pointShadowMap.length,numSpotLightShadows:I.spotShadowMap.length,numSpotLightShadowsWithMaps:I.numSpotLightShadowsWithMaps,numLightProbes:I.numLightProbes,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:k.dithering,shadowMapEnabled:t.shadowMap.enabled&&z.length>0,shadowMapType:t.shadowMap.type,toneMapping:Bt,decodeVideoTexture:li&&k.map.isVideoTexture===!0&&ci.getTransfer(k.map.colorSpace)===wi,decodeVideoTextureEmissive:Xt&&k.emissiveMap.isVideoTexture===!0&&ci.getTransfer(k.emissiveMap.colorSpace)===wi,premultipliedAlpha:k.premultipliedAlpha,doubleSided:k.side===Qr,flipSided:k.side===Un,useDepthPacking:k.depthPacking>=0,depthPacking:k.depthPacking||0,index0AttributeName:k.index0AttributeName,extensionClipCullDistance:St&&k.extensions.clipCullDistance===!0&&n.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(St&&k.extensions.multiDraw===!0||Ct)&&n.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:n.has("KHR_parallel_shader_compile"),customProgramCacheKey:k.customProgramCacheKey()};return Ci.vertexUv1s=d.has(1),Ci.vertexUv2s=d.has(2),Ci.vertexUv3s=d.has(3),d.clear(),Ci}function R(k){const I=[];if(k.shaderID?I.push(k.shaderID):(I.push(k.customVertexShaderID),I.push(k.customFragmentShaderID)),k.defines!==void 0)for(const z in k.defines)I.push(z),I.push(k.defines[z]);return k.isRawShaderMaterial===!1&&(N(I,k),b(I,k),I.push(t.outputColorSpace)),I.push(k.customProgramCacheKey),I.join()}function N(k,I){k.push(I.precision),k.push(I.outputColorSpace),k.push(I.envMapMode),k.push(I.envMapCubeUVHeight),k.push(I.mapUv),k.push(I.alphaMapUv),k.push(I.lightMapUv),k.push(I.aoMapUv),k.push(I.bumpMapUv),k.push(I.normalMapUv),k.push(I.displacementMapUv),k.push(I.emissiveMapUv),k.push(I.metalnessMapUv),k.push(I.roughnessMapUv),k.push(I.anisotropyMapUv),k.push(I.clearcoatMapUv),k.push(I.clearcoatNormalMapUv),k.push(I.clearcoatRoughnessMapUv),k.push(I.iridescenceMapUv),k.push(I.iridescenceThicknessMapUv),k.push(I.sheenColorMapUv),k.push(I.sheenRoughnessMapUv),k.push(I.specularMapUv),k.push(I.specularColorMapUv),k.push(I.specularIntensityMapUv),k.push(I.transmissionMapUv),k.push(I.thicknessMapUv),k.push(I.combine),k.push(I.fogExp2),k.push(I.sizeAttenuation),k.push(I.morphTargetsCount),k.push(I.morphAttributeCount),k.push(I.numDirLights),k.push(I.numPointLights),k.push(I.numSpotLights),k.push(I.numSpotLightMaps),k.push(I.numHemiLights),k.push(I.numRectAreaLights),k.push(I.numDirLightShadows),k.push(I.numPointLightShadows),k.push(I.numSpotLightShadows),k.push(I.numSpotLightShadowsWithMaps),k.push(I.numLightProbes),k.push(I.shadowMapType),k.push(I.toneMapping),k.push(I.numClippingPlanes),k.push(I.numClipIntersection),k.push(I.depthPacking)}function b(k,I){c.disableAll(),I.supportsVertexTextures&&c.enable(0),I.instancing&&c.enable(1),I.instancingColor&&c.enable(2),I.instancingMorph&&c.enable(3),I.matcap&&c.enable(4),I.envMap&&c.enable(5),I.normalMapObjectSpace&&c.enable(6),I.normalMapTangentSpace&&c.enable(7),I.clearcoat&&c.enable(8),I.iridescence&&c.enable(9),I.alphaTest&&c.enable(10),I.vertexColors&&c.enable(11),I.vertexAlphas&&c.enable(12),I.vertexUv1s&&c.enable(13),I.vertexUv2s&&c.enable(14),I.vertexUv3s&&c.enable(15),I.vertexTangents&&c.enable(16),I.anisotropy&&c.enable(17),I.alphaHash&&c.enable(18),I.batching&&c.enable(19),I.dispersion&&c.enable(20),I.batchingColor&&c.enable(21),k.push(c.mask),c.disableAll(),I.fog&&c.enable(0),I.useFog&&c.enable(1),I.flatShading&&c.enable(2),I.logarithmicDepthBuffer&&c.enable(3),I.reverseDepthBuffer&&c.enable(4),I.skinning&&c.enable(5),I.morphTargets&&c.enable(6),I.morphNormals&&c.enable(7),I.morphColors&&c.enable(8),I.premultipliedAlpha&&c.enable(9),I.shadowMapEnabled&&c.enable(10),I.doubleSided&&c.enable(11),I.flipSided&&c.enable(12),I.useDepthPacking&&c.enable(13),I.dithering&&c.enable(14),I.transmission&&c.enable(15),I.sheen&&c.enable(16),I.opaque&&c.enable(17),I.pointsUvs&&c.enable(18),I.decodeVideoTexture&&c.enable(19),I.decodeVideoTextureEmissive&&c.enable(20),I.alphaToCoverage&&c.enable(21),k.push(c.mask)}function m(k){const I=S[k.type];let z;if(I){const K=Lr[I];z=OC.clone(K.uniforms)}else z=k.uniforms;return z}function w(k,I){let z;for(let K=0,$=p.length;K<$;K++){const te=p[K];if(te.cacheKey===I){z=te,++z.usedTimes;break}}return z===void 0&&(z=new sA(t,I,k,s),p.push(z)),z}function T(k){if(--k.usedTimes===0){const I=p.indexOf(k);p[I]=p[p.length-1],p.pop(),k.destroy()}}function P(k){h.remove(k)}function L(){h.dispose()}return{getParameters:M,getProgramCacheKey:R,getUniforms:m,acquireProgram:w,releaseProgram:T,releaseShaderCache:P,programs:p,dispose:L}}function dA(){let t=new WeakMap;function e(o){return t.has(o)}function i(o){let c=t.get(o);return c===void 0&&(c={},t.set(o,c)),c}function n(o){t.delete(o)}function r(o,c,h){t.get(o)[c]=h}function s(){t=new WeakMap}return{has:e,get:i,remove:n,update:r,dispose:s}}function uA(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function Zf(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function Yf(){const t=[];let e=0;const i=[],n=[],r=[];function s(){e=0,i.length=0,n.length=0,r.length=0}function o(v,g,_,S,E,M){let R=t[e];return R===void 0?(R={id:v.id,object:v,geometry:g,material:_,groupOrder:S,renderOrder:v.renderOrder,z:E,group:M},t[e]=R):(R.id=v.id,R.object=v,R.geometry=g,R.material=_,R.groupOrder=S,R.renderOrder=v.renderOrder,R.z=E,R.group=M),e++,R}function c(v,g,_,S,E,M){const R=o(v,g,_,S,E,M);_.transmission>0?n.push(R):_.transparent===!0?r.push(R):i.push(R)}function h(v,g,_,S,E,M){const R=o(v,g,_,S,E,M);_.transmission>0?n.unshift(R):_.transparent===!0?r.unshift(R):i.unshift(R)}function d(v,g){i.length>1&&i.sort(v||uA),n.length>1&&n.sort(g||Zf),r.length>1&&r.sort(g||Zf)}function p(){for(let v=e,g=t.length;v<g;v++){const _=t[v];if(_.id===null)break;_.id=null,_.object=null,_.geometry=null,_.material=null,_.group=null}}return{opaque:i,transmissive:n,transparent:r,init:s,push:c,unshift:h,finish:p,sort:d}}function hA(){let t=new WeakMap;function e(n,r){const s=t.get(n);let o;return s===void 0?(o=new Yf,t.set(n,[o])):r>=s.length?(o=new Yf,s.push(o)):o=s[r],o}function i(){t=new WeakMap}return{get:e,dispose:i}}function pA(){const t={};return{get:function(e){if(t[e.id]!==void 0)return t[e.id];let i;switch(e.type){case"DirectionalLight":i={direction:new Ae,color:new Ei};break;case"SpotLight":i={position:new Ae,direction:new Ae,color:new Ei,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new Ae,color:new Ei,distance:0,decay:0};break;case"HemisphereLight":i={direction:new Ae,skyColor:new Ei,groundColor:new Ei};break;case"RectAreaLight":i={color:new Ei,position:new Ae,halfWidth:new Ae,halfHeight:new Ae};break}return t[e.id]=i,i}}}function fA(){const t={};return{get:function(e){if(t[e.id]!==void 0)return t[e.id];let i;switch(e.type){case"DirectionalLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new $t};break;case"SpotLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new $t};break;case"PointLight":i={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new $t,shadowCameraNear:1,shadowCameraFar:1e3};break}return t[e.id]=i,i}}}let mA=0;function gA(t,e){return(e.castShadow?2:0)-(t.castShadow?2:0)+(e.map?1:0)-(t.map?1:0)}function vA(t){const e=new pA,i=fA(),n={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let d=0;d<9;d++)n.probe.push(new Ae);const r=new Ae,s=new Wi,o=new Wi;function c(d){let p=0,v=0,g=0;for(let k=0;k<9;k++)n.probe[k].set(0,0,0);let _=0,S=0,E=0,M=0,R=0,N=0,b=0,m=0,w=0,T=0,P=0;d.sort(gA);for(let k=0,I=d.length;k<I;k++){const z=d[k],K=z.color,$=z.intensity,te=z.distance,ee=z.shadow&&z.shadow.map?z.shadow.map.texture:null;if(z.isAmbientLight)p+=K.r*$,v+=K.g*$,g+=K.b*$;else if(z.isLightProbe){for(let de=0;de<9;de++)n.probe[de].addScaledVector(z.sh.coefficients[de],$);P++}else if(z.isDirectionalLight){const de=e.get(z);if(de.color.copy(z.color).multiplyScalar(z.intensity),z.castShadow){const X=z.shadow,le=i.get(z);le.shadowIntensity=X.intensity,le.shadowBias=X.bias,le.shadowNormalBias=X.normalBias,le.shadowRadius=X.radius,le.shadowMapSize=X.mapSize,n.directionalShadow[_]=le,n.directionalShadowMap[_]=ee,n.directionalShadowMatrix[_]=z.shadow.matrix,N++}n.directional[_]=de,_++}else if(z.isSpotLight){const de=e.get(z);de.position.setFromMatrixPosition(z.matrixWorld),de.color.copy(K).multiplyScalar($),de.distance=te,de.coneCos=Math.cos(z.angle),de.penumbraCos=Math.cos(z.angle*(1-z.penumbra)),de.decay=z.decay,n.spot[E]=de;const X=z.shadow;if(z.map&&(n.spotLightMap[w]=z.map,w++,X.updateMatrices(z),z.castShadow&&T++),n.spotLightMatrix[E]=X.matrix,z.castShadow){const le=i.get(z);le.shadowIntensity=X.intensity,le.shadowBias=X.bias,le.shadowNormalBias=X.normalBias,le.shadowRadius=X.radius,le.shadowMapSize=X.mapSize,n.spotShadow[E]=le,n.spotShadowMap[E]=ee,m++}E++}else if(z.isRectAreaLight){const de=e.get(z);de.color.copy(K).multiplyScalar($),de.halfWidth.set(z.width*.5,0,0),de.halfHeight.set(0,z.height*.5,0),n.rectArea[M]=de,M++}else if(z.isPointLight){const de=e.get(z);if(de.color.copy(z.color).multiplyScalar(z.intensity),de.distance=z.distance,de.decay=z.decay,z.castShadow){const X=z.shadow,le=i.get(z);le.shadowIntensity=X.intensity,le.shadowBias=X.bias,le.shadowNormalBias=X.normalBias,le.shadowRadius=X.radius,le.shadowMapSize=X.mapSize,le.shadowCameraNear=X.camera.near,le.shadowCameraFar=X.camera.far,n.pointShadow[S]=le,n.pointShadowMap[S]=ee,n.pointShadowMatrix[S]=z.shadow.matrix,b++}n.point[S]=de,S++}else if(z.isHemisphereLight){const de=e.get(z);de.skyColor.copy(z.color).multiplyScalar($),de.groundColor.copy(z.groundColor).multiplyScalar($),n.hemi[R]=de,R++}}M>0&&(t.has("OES_texture_float_linear")===!0?(n.rectAreaLTC1=ct.LTC_FLOAT_1,n.rectAreaLTC2=ct.LTC_FLOAT_2):(n.rectAreaLTC1=ct.LTC_HALF_1,n.rectAreaLTC2=ct.LTC_HALF_2)),n.ambient[0]=p,n.ambient[1]=v,n.ambient[2]=g;const L=n.hash;(L.directionalLength!==_||L.pointLength!==S||L.spotLength!==E||L.rectAreaLength!==M||L.hemiLength!==R||L.numDirectionalShadows!==N||L.numPointShadows!==b||L.numSpotShadows!==m||L.numSpotMaps!==w||L.numLightProbes!==P)&&(n.directional.length=_,n.spot.length=E,n.rectArea.length=M,n.point.length=S,n.hemi.length=R,n.directionalShadow.length=N,n.directionalShadowMap.length=N,n.pointShadow.length=b,n.pointShadowMap.length=b,n.spotShadow.length=m,n.spotShadowMap.length=m,n.directionalShadowMatrix.length=N,n.pointShadowMatrix.length=b,n.spotLightMatrix.length=m+w-T,n.spotLightMap.length=w,n.numSpotLightShadowsWithMaps=T,n.numLightProbes=P,L.directionalLength=_,L.pointLength=S,L.spotLength=E,L.rectAreaLength=M,L.hemiLength=R,L.numDirectionalShadows=N,L.numPointShadows=b,L.numSpotShadows=m,L.numSpotMaps=w,L.numLightProbes=P,n.version=mA++)}function h(d,p){let v=0,g=0,_=0,S=0,E=0;const M=p.matrixWorldInverse;for(let R=0,N=d.length;R<N;R++){const b=d[R];if(b.isDirectionalLight){const m=n.directional[v];m.direction.setFromMatrixPosition(b.matrixWorld),r.setFromMatrixPosition(b.target.matrixWorld),m.direction.sub(r),m.direction.transformDirection(M),v++}else if(b.isSpotLight){const m=n.spot[_];m.position.setFromMatrixPosition(b.matrixWorld),m.position.applyMatrix4(M),m.direction.setFromMatrixPosition(b.matrixWorld),r.setFromMatrixPosition(b.target.matrixWorld),m.direction.sub(r),m.direction.transformDirection(M),_++}else if(b.isRectAreaLight){const m=n.rectArea[S];m.position.setFromMatrixPosition(b.matrixWorld),m.position.applyMatrix4(M),o.identity(),s.copy(b.matrixWorld),s.premultiply(M),o.extractRotation(s),m.halfWidth.set(b.width*.5,0,0),m.halfHeight.set(0,b.height*.5,0),m.halfWidth.applyMatrix4(o),m.halfHeight.applyMatrix4(o),S++}else if(b.isPointLight){const m=n.point[g];m.position.setFromMatrixPosition(b.matrixWorld),m.position.applyMatrix4(M),g++}else if(b.isHemisphereLight){const m=n.hemi[E];m.direction.setFromMatrixPosition(b.matrixWorld),m.direction.transformDirection(M),E++}}}return{setup:c,setupView:h,state:n}}function Jf(t){const e=new vA(t),i=[],n=[];function r(p){d.camera=p,i.length=0,n.length=0}function s(p){i.push(p)}function o(p){n.push(p)}function c(){e.setup(i)}function h(p){e.setupView(i,p)}const d={lightsArray:i,shadowsArray:n,camera:null,lights:e,transmissionRenderTarget:{}};return{init:r,state:d,setupLights:c,setupLightsView:h,pushLight:s,pushShadow:o}}function _A(t){let e=new WeakMap;function i(r,s=0){const o=e.get(r);let c;return o===void 0?(c=new Jf(t),e.set(r,[c])):s>=o.length?(c=new Jf(t),o.push(c)):c=o[s],c}function n(){e=new WeakMap}return{get:i,dispose:n}}const bA=`void main() {
	gl_Position = vec4( position, 1.0 );
}`,yA=`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
#include <packing>
void main() {
	const float samples = float( VSM_SAMPLES );
	float mean = 0.0;
	float squared_mean = 0.0;
	float uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );
	float uvStart = samples <= 1.0 ? 0.0 : - 1.0;
	for ( float i = 0.0; i < samples; i ++ ) {
		float uvOffset = uvStart + i * uvStride;
		#ifdef HORIZONTAL_PASS
			vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
		#else
			float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );
			mean += depth;
			squared_mean += depth * depth;
		#endif
	}
	mean = mean / samples;
	squared_mean = squared_mean / samples;
	float std_dev = sqrt( squared_mean - mean * mean );
	gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );
}`;function SA(t,e,i){let n=new Uv;const r=new $t,s=new $t,o=new ji,c=new WC({depthPacking:iC}),h=new KC,d={},p=i.maxTextureSize,v={[Rs]:Un,[Un]:Rs,[Qr]:Qr},g=new Ms({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new $t},radius:{value:4}},vertexShader:bA,fragmentShader:yA}),_=g.clone();_.defines.HORIZONTAL_PASS=1;const S=new Ds;S.setAttribute("position",new Ur(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const E=new Or(S,g),M=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=vv;let R=this.type;this.render=function(T,P,L){if(M.enabled===!1||M.autoUpdate===!1&&M.needsUpdate===!1||T.length===0)return;const k=t.getRenderTarget(),I=t.getActiveCubeFace(),z=t.getActiveMipmapLevel(),K=t.state;K.setBlending(ws),K.buffers.color.setClear(1,1,1,1),K.buffers.depth.setTest(!0),K.setScissorTest(!1);const $=R!==Yr&&this.type===Yr,te=R===Yr&&this.type!==Yr;for(let ee=0,de=T.length;ee<de;ee++){const X=T[ee],le=X.shadow;if(le===void 0){console.warn("THREE.WebGLShadowMap:",X,"has no shadow.");continue}if(le.autoUpdate===!1&&le.needsUpdate===!1)continue;r.copy(le.mapSize);const _e=le.getFrameExtents();if(r.multiply(_e),s.copy(le.mapSize),(r.x>p||r.y>p)&&(r.x>p&&(s.x=Math.floor(p/_e.x),r.x=s.x*_e.x,le.mapSize.x=s.x),r.y>p&&(s.y=Math.floor(p/_e.y),r.y=s.y*_e.y,le.mapSize.y=s.y)),le.map===null||$===!0||te===!0){const De=this.type!==Yr?{minFilter:Er,magFilter:Er}:{};le.map!==null&&le.map.dispose(),le.map=new aa(r.x,r.y,De),le.map.texture.name=X.name+".shadowMap",le.camera.updateProjectionMatrix()}t.setRenderTarget(le.map),t.clear();const Se=le.getViewportCount();for(let De=0;De<Se;De++){const We=le.getViewport(De);o.set(s.x*We.x,s.y*We.y,s.x*We.z,s.y*We.w),K.viewport(o),le.updateMatrices(X,De),n=le.getFrustum(),m(P,L,le.camera,X,this.type)}le.isPointLightShadow!==!0&&this.type===Yr&&N(le,L),le.needsUpdate=!1}R=this.type,M.needsUpdate=!1,t.setRenderTarget(k,I,z)};function N(T,P){const L=e.update(E);g.defines.VSM_SAMPLES!==T.blurSamples&&(g.defines.VSM_SAMPLES=T.blurSamples,_.defines.VSM_SAMPLES=T.blurSamples,g.needsUpdate=!0,_.needsUpdate=!0),T.mapPass===null&&(T.mapPass=new aa(r.x,r.y)),g.uniforms.shadow_pass.value=T.map.texture,g.uniforms.resolution.value=T.mapSize,g.uniforms.radius.value=T.radius,t.setRenderTarget(T.mapPass),t.clear(),t.renderBufferDirect(P,null,L,g,E,null),_.uniforms.shadow_pass.value=T.mapPass.texture,_.uniforms.resolution.value=T.mapSize,_.uniforms.radius.value=T.radius,t.setRenderTarget(T.map),t.clear(),t.renderBufferDirect(P,null,L,_,E,null)}function b(T,P,L,k){let I=null;const z=L.isPointLight===!0?T.customDistanceMaterial:T.customDepthMaterial;if(z!==void 0)I=z;else if(I=L.isPointLight===!0?h:c,t.localClippingEnabled&&P.clipShadows===!0&&Array.isArray(P.clippingPlanes)&&P.clippingPlanes.length!==0||P.displacementMap&&P.displacementScale!==0||P.alphaMap&&P.alphaTest>0||P.map&&P.alphaTest>0||P.alphaToCoverage===!0){const K=I.uuid,$=P.uuid;let te=d[K];te===void 0&&(te={},d[K]=te);let ee=te[$];ee===void 0&&(ee=I.clone(),te[$]=ee,P.addEventListener("dispose",w)),I=ee}if(I.visible=P.visible,I.wireframe=P.wireframe,k===Yr?I.side=P.shadowSide!==null?P.shadowSide:P.side:I.side=P.shadowSide!==null?P.shadowSide:v[P.side],I.alphaMap=P.alphaMap,I.alphaTest=P.alphaToCoverage===!0?.5:P.alphaTest,I.map=P.map,I.clipShadows=P.clipShadows,I.clippingPlanes=P.clippingPlanes,I.clipIntersection=P.clipIntersection,I.displacementMap=P.displacementMap,I.displacementScale=P.displacementScale,I.displacementBias=P.displacementBias,I.wireframeLinewidth=P.wireframeLinewidth,I.linewidth=P.linewidth,L.isPointLight===!0&&I.isMeshDistanceMaterial===!0){const K=t.properties.get(I);K.light=L}return I}function m(T,P,L,k,I){if(T.visible===!1)return;if(T.layers.test(P.layers)&&(T.isMesh||T.isLine||T.isPoints)&&(T.castShadow||T.receiveShadow&&I===Yr)&&(!T.frustumCulled||n.intersectsObject(T))){T.modelViewMatrix.multiplyMatrices(L.matrixWorldInverse,T.matrixWorld);const $=e.update(T),te=T.material;if(Array.isArray(te)){const ee=$.groups;for(let de=0,X=ee.length;de<X;de++){const le=ee[de],_e=te[le.materialIndex];if(_e&&_e.visible){const Se=b(T,_e,k,I);T.onBeforeShadow(t,T,P,L,$,Se,le),t.renderBufferDirect(L,null,$,Se,T,le),T.onAfterShadow(t,T,P,L,$,Se,le)}}}else if(te.visible){const ee=b(T,te,k,I);T.onBeforeShadow(t,T,P,L,$,ee,null),t.renderBufferDirect(L,null,$,ee,T,null),T.onAfterShadow(t,T,P,L,$,ee,null)}}const K=T.children;for(let $=0,te=K.length;$<te;$++)m(K[$],P,L,k,I)}function w(T){T.target.removeEventListener("dispose",w);for(const L in d){const k=d[L],I=T.target.uuid;I in k&&(k[I].dispose(),delete k[I])}}}const wA={[Pu]:Au,[Du]:Nu,[Iu]:Lu,[$a]:Fu,[Au]:Pu,[Nu]:Du,[Lu]:Iu,[Fu]:$a};function xA(t,e){function i(){let ve=!1;const ot=new ji;let Ke=null;const bt=new ji(0,0,0,0);return{setMask:function(Ze){Ke!==Ze&&!ve&&(t.colorMask(Ze,Ze,Ze,Ze),Ke=Ze)},setLocked:function(Ze){ve=Ze},setClear:function(Ze,Ge,St,Bt,Ci){Ci===!0&&(Ze*=Bt,Ge*=Bt,St*=Bt),ot.set(Ze,Ge,St,Bt),bt.equals(ot)===!1&&(t.clearColor(Ze,Ge,St,Bt),bt.copy(ot))},reset:function(){ve=!1,Ke=null,bt.set(-1,0,0,0)}}}function n(){let ve=!1,ot=!1,Ke=null,bt=null,Ze=null;return{setReversed:function(Ge){if(ot!==Ge){const St=e.get("EXT_clip_control");Ge?St.clipControlEXT(St.LOWER_LEFT_EXT,St.ZERO_TO_ONE_EXT):St.clipControlEXT(St.LOWER_LEFT_EXT,St.NEGATIVE_ONE_TO_ONE_EXT),ot=Ge;const Bt=Ze;Ze=null,this.setClear(Bt)}},getReversed:function(){return ot},setTest:function(Ge){Ge?nt(t.DEPTH_TEST):rt(t.DEPTH_TEST)},setMask:function(Ge){Ke!==Ge&&!ve&&(t.depthMask(Ge),Ke=Ge)},setFunc:function(Ge){if(ot&&(Ge=wA[Ge]),bt!==Ge){switch(Ge){case Pu:t.depthFunc(t.NEVER);break;case Au:t.depthFunc(t.ALWAYS);break;case Du:t.depthFunc(t.LESS);break;case $a:t.depthFunc(t.LEQUAL);break;case Iu:t.depthFunc(t.EQUAL);break;case Fu:t.depthFunc(t.GEQUAL);break;case Nu:t.depthFunc(t.GREATER);break;case Lu:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}bt=Ge}},setLocked:function(Ge){ve=Ge},setClear:function(Ge){Ze!==Ge&&(ot&&(Ge=1-Ge),t.clearDepth(Ge),Ze=Ge)},reset:function(){ve=!1,Ke=null,bt=null,Ze=null,ot=!1}}}function r(){let ve=!1,ot=null,Ke=null,bt=null,Ze=null,Ge=null,St=null,Bt=null,Ci=null;return{setTest:function(ui){ve||(ui?nt(t.STENCIL_TEST):rt(t.STENCIL_TEST))},setMask:function(ui){ot!==ui&&!ve&&(t.stencilMask(ui),ot=ui)},setFunc:function(ui,Vn,ar){(Ke!==ui||bt!==Vn||Ze!==ar)&&(t.stencilFunc(ui,Vn,ar),Ke=ui,bt=Vn,Ze=ar)},setOp:function(ui,Vn,ar){(Ge!==ui||St!==Vn||Bt!==ar)&&(t.stencilOp(ui,Vn,ar),Ge=ui,St=Vn,Bt=ar)},setLocked:function(ui){ve=ui},setClear:function(ui){Ci!==ui&&(t.clearStencil(ui),Ci=ui)},reset:function(){ve=!1,ot=null,Ke=null,bt=null,Ze=null,Ge=null,St=null,Bt=null,Ci=null}}}const s=new i,o=new n,c=new r,h=new WeakMap,d=new WeakMap;let p={},v={},g=new WeakMap,_=[],S=null,E=!1,M=null,R=null,N=null,b=null,m=null,w=null,T=null,P=new Ei(0,0,0),L=0,k=!1,I=null,z=null,K=null,$=null,te=null;const ee=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let de=!1,X=0;const le=t.getParameter(t.VERSION);le.indexOf("WebGL")!==-1?(X=parseFloat(/^WebGL (\d)/.exec(le)[1]),de=X>=1):le.indexOf("OpenGL ES")!==-1&&(X=parseFloat(/^OpenGL ES (\d)/.exec(le)[1]),de=X>=2);let _e=null,Se={};const De=t.getParameter(t.SCISSOR_BOX),We=t.getParameter(t.VIEWPORT),Ve=new ji().fromArray(De),Me=new ji().fromArray(We);function ze(ve,ot,Ke,bt){const Ze=new Uint8Array(4),Ge=t.createTexture();t.bindTexture(ve,Ge),t.texParameteri(ve,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(ve,t.TEXTURE_MAG_FILTER,t.NEAREST);for(let St=0;St<Ke;St++)ve===t.TEXTURE_3D||ve===t.TEXTURE_2D_ARRAY?t.texImage3D(ot,0,t.RGBA,1,1,bt,0,t.RGBA,t.UNSIGNED_BYTE,Ze):t.texImage2D(ot+St,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Ze);return Ge}const ht={};ht[t.TEXTURE_2D]=ze(t.TEXTURE_2D,t.TEXTURE_2D,1),ht[t.TEXTURE_CUBE_MAP]=ze(t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),ht[t.TEXTURE_2D_ARRAY]=ze(t.TEXTURE_2D_ARRAY,t.TEXTURE_2D_ARRAY,1,1),ht[t.TEXTURE_3D]=ze(t.TEXTURE_3D,t.TEXTURE_3D,1,1),s.setClear(0,0,0,1),o.setClear(1),c.setClear(0),nt(t.DEPTH_TEST),o.setFunc($a),ti(!1),si(nf),nt(t.CULL_FACE),he(ws);function nt(ve){p[ve]!==!0&&(t.enable(ve),p[ve]=!0)}function rt(ve){p[ve]!==!1&&(t.disable(ve),p[ve]=!1)}function jt(ve,ot){return v[ve]!==ot?(t.bindFramebuffer(ve,ot),v[ve]=ot,ve===t.DRAW_FRAMEBUFFER&&(v[t.FRAMEBUFFER]=ot),ve===t.FRAMEBUFFER&&(v[t.DRAW_FRAMEBUFFER]=ot),!0):!1}function Ct(ve,ot){let Ke=_,bt=!1;if(ve){Ke=g.get(ot),Ke===void 0&&(Ke=[],g.set(ot,Ke));const Ze=ve.textures;if(Ke.length!==Ze.length||Ke[0]!==t.COLOR_ATTACHMENT0){for(let Ge=0,St=Ze.length;Ge<St;Ge++)Ke[Ge]=t.COLOR_ATTACHMENT0+Ge;Ke.length=Ze.length,bt=!0}}else Ke[0]!==t.BACK&&(Ke[0]=t.BACK,bt=!0);bt&&t.drawBuffers(Ke)}function li(ve){return S!==ve?(t.useProgram(ve),S=ve,!0):!1}const di={[Ks]:t.FUNC_ADD,[ME]:t.FUNC_SUBTRACT,[PE]:t.FUNC_REVERSE_SUBTRACT};di[AE]=t.MIN,di[DE]=t.MAX;const zt={[IE]:t.ZERO,[FE]:t.ONE,[NE]:t.SRC_COLOR,[Ru]:t.SRC_ALPHA,[HE]:t.SRC_ALPHA_SATURATE,[UE]:t.DST_COLOR,[OE]:t.DST_ALPHA,[LE]:t.ONE_MINUS_SRC_COLOR,[Mu]:t.ONE_MINUS_SRC_ALPHA,[BE]:t.ONE_MINUS_DST_COLOR,[kE]:t.ONE_MINUS_DST_ALPHA,[jE]:t.CONSTANT_COLOR,[VE]:t.ONE_MINUS_CONSTANT_COLOR,[zE]:t.CONSTANT_ALPHA,[GE]:t.ONE_MINUS_CONSTANT_ALPHA};function he(ve,ot,Ke,bt,Ze,Ge,St,Bt,Ci,ui){if(ve===ws){E===!0&&(rt(t.BLEND),E=!1);return}if(E===!1&&(nt(t.BLEND),E=!0),ve!==RE){if(ve!==M||ui!==k){if((R!==Ks||m!==Ks)&&(t.blendEquation(t.FUNC_ADD),R=Ks,m=Ks),ui)switch(ve){case Ua:t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case rf:t.blendFunc(t.ONE,t.ONE);break;case sf:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case af:t.blendFuncSeparate(t.ZERO,t.SRC_COLOR,t.ZERO,t.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",ve);break}else switch(ve){case Ua:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case rf:t.blendFunc(t.SRC_ALPHA,t.ONE);break;case sf:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case af:t.blendFunc(t.ZERO,t.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",ve);break}N=null,b=null,w=null,T=null,P.set(0,0,0),L=0,M=ve,k=ui}return}Ze=Ze||ot,Ge=Ge||Ke,St=St||bt,(ot!==R||Ze!==m)&&(t.blendEquationSeparate(di[ot],di[Ze]),R=ot,m=Ze),(Ke!==N||bt!==b||Ge!==w||St!==T)&&(t.blendFuncSeparate(zt[Ke],zt[bt],zt[Ge],zt[St]),N=Ke,b=bt,w=Ge,T=St),(Bt.equals(P)===!1||Ci!==L)&&(t.blendColor(Bt.r,Bt.g,Bt.b,Ci),P.copy(Bt),L=Ci),M=ve,k=!1}function mi(ve,ot){ve.side===Qr?rt(t.CULL_FACE):nt(t.CULL_FACE);let Ke=ve.side===Un;ot&&(Ke=!Ke),ti(Ke),ve.blending===Ua&&ve.transparent===!1?he(ws):he(ve.blending,ve.blendEquation,ve.blendSrc,ve.blendDst,ve.blendEquationAlpha,ve.blendSrcAlpha,ve.blendDstAlpha,ve.blendColor,ve.blendAlpha,ve.premultipliedAlpha),o.setFunc(ve.depthFunc),o.setTest(ve.depthTest),o.setMask(ve.depthWrite),s.setMask(ve.colorWrite);const bt=ve.stencilWrite;c.setTest(bt),bt&&(c.setMask(ve.stencilWriteMask),c.setFunc(ve.stencilFunc,ve.stencilRef,ve.stencilFuncMask),c.setOp(ve.stencilFail,ve.stencilZFail,ve.stencilZPass)),Xt(ve.polygonOffset,ve.polygonOffsetFactor,ve.polygonOffsetUnits),ve.alphaToCoverage===!0?nt(t.SAMPLE_ALPHA_TO_COVERAGE):rt(t.SAMPLE_ALPHA_TO_COVERAGE)}function ti(ve){I!==ve&&(ve?t.frontFace(t.CW):t.frontFace(t.CCW),I=ve)}function si(ve){ve!==EE?(nt(t.CULL_FACE),ve!==z&&(ve===nf?t.cullFace(t.BACK):ve===CE?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):rt(t.CULL_FACE),z=ve}function yt(ve){ve!==K&&(de&&t.lineWidth(ve),K=ve)}function Xt(ve,ot,Ke){ve?(nt(t.POLYGON_OFFSET_FILL),($!==ot||te!==Ke)&&(t.polygonOffset(ot,Ke),$=ot,te=Ke)):rt(t.POLYGON_OFFSET_FILL)}function Rt(ve){ve?nt(t.SCISSOR_TEST):rt(t.SCISSOR_TEST)}function Ut(ve){ve===void 0&&(ve=t.TEXTURE0+ee-1),_e!==ve&&(t.activeTexture(ve),_e=ve)}function Ii(ve,ot,Ke){Ke===void 0&&(_e===null?Ke=t.TEXTURE0+ee-1:Ke=_e);let bt=Se[Ke];bt===void 0&&(bt={type:void 0,texture:void 0},Se[Ke]=bt),(bt.type!==ve||bt.texture!==ot)&&(_e!==Ke&&(t.activeTexture(Ke),_e=Ke),t.bindTexture(ve,ot||ht[ve]),bt.type=ve,bt.texture=ot)}function ue(){const ve=Se[_e];ve!==void 0&&ve.type!==void 0&&(t.bindTexture(ve.type,null),ve.type=void 0,ve.texture=void 0)}function ie(){try{t.compressedTexImage2D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function Re(){try{t.compressedTexImage3D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function Pe(){try{t.texSubImage2D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function Oe(){try{t.texSubImage3D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function Ce(){try{t.compressedTexSubImage2D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function tt(){try{t.compressedTexSubImage3D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function et(){try{t.texStorage2D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function ut(){try{t.texStorage3D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function Qe(){try{t.texImage2D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function Ie(){try{t.texImage3D(...arguments)}catch(ve){console.error("THREE.WebGLState:",ve)}}function it(ve){Ve.equals(ve)===!1&&(t.scissor(ve.x,ve.y,ve.z,ve.w),Ve.copy(ve))}function Pt(ve){Me.equals(ve)===!1&&(t.viewport(ve.x,ve.y,ve.z,ve.w),Me.copy(ve))}function Mt(ve,ot){let Ke=d.get(ot);Ke===void 0&&(Ke=new WeakMap,d.set(ot,Ke));let bt=Ke.get(ve);bt===void 0&&(bt=t.getUniformBlockIndex(ot,ve.name),Ke.set(ve,bt))}function st(ve,ot){const bt=d.get(ot).get(ve);h.get(ot)!==bt&&(t.uniformBlockBinding(ot,bt,ve.__bindingPointIndex),h.set(ot,bt))}function kt(){t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SCISSOR_TEST),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.blendColor(0,0,0,0),t.colorMask(!0,!0,!0,!0),t.clearColor(0,0,0,0),t.depthMask(!0),t.depthFunc(t.LESS),o.setReversed(!1),t.clearDepth(1),t.stencilMask(4294967295),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.clearStencil(0),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.activeTexture(t.TEXTURE0),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.useProgram(null),t.lineWidth(1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.viewport(0,0,t.canvas.width,t.canvas.height),p={},_e=null,Se={},v={},g=new WeakMap,_=[],S=null,E=!1,M=null,R=null,N=null,b=null,m=null,w=null,T=null,P=new Ei(0,0,0),L=0,k=!1,I=null,z=null,K=null,$=null,te=null,Ve.set(0,0,t.canvas.width,t.canvas.height),Me.set(0,0,t.canvas.width,t.canvas.height),s.reset(),o.reset(),c.reset()}return{buffers:{color:s,depth:o,stencil:c},enable:nt,disable:rt,bindFramebuffer:jt,drawBuffers:Ct,useProgram:li,setBlending:he,setMaterial:mi,setFlipSided:ti,setCullFace:si,setLineWidth:yt,setPolygonOffset:Xt,setScissorTest:Rt,activeTexture:Ut,bindTexture:Ii,unbindTexture:ue,compressedTexImage2D:ie,compressedTexImage3D:Re,texImage2D:Qe,texImage3D:Ie,updateUBOMapping:Mt,uniformBlockBinding:st,texStorage2D:et,texStorage3D:ut,texSubImage2D:Pe,texSubImage3D:Oe,compressedTexSubImage2D:Ce,compressedTexSubImage3D:tt,scissor:it,viewport:Pt,reset:kt}}function EA(t,e,i,n,r,s,o){const c=e.has("WEBGL_multisampled_render_to_texture")?e.get("WEBGL_multisampled_render_to_texture"):null,h=typeof navigator>"u"?!1:/OculusBrowser/g.test(navigator.userAgent),d=new $t,p=new WeakMap;let v;const g=new WeakMap;let _=!1;try{_=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function S(ue,ie){return _?new OffscreenCanvas(ue,ie):xl("canvas")}function E(ue,ie,Re){let Pe=1;const Oe=Ii(ue);if((Oe.width>Re||Oe.height>Re)&&(Pe=Re/Math.max(Oe.width,Oe.height)),Pe<1)if(typeof HTMLImageElement<"u"&&ue instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&ue instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&ue instanceof ImageBitmap||typeof VideoFrame<"u"&&ue instanceof VideoFrame){const Ce=Math.floor(Pe*Oe.width),tt=Math.floor(Pe*Oe.height);v===void 0&&(v=S(Ce,tt));const et=ie?S(Ce,tt):v;return et.width=Ce,et.height=tt,et.getContext("2d").drawImage(ue,0,0,Ce,tt),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+Oe.width+"x"+Oe.height+") to ("+Ce+"x"+tt+")."),et}else return"data"in ue&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+Oe.width+"x"+Oe.height+")."),ue;return ue}function M(ue){return ue.generateMipmaps}function R(ue){t.generateMipmap(ue)}function N(ue){return ue.isWebGLCubeRenderTarget?t.TEXTURE_CUBE_MAP:ue.isWebGL3DRenderTarget?t.TEXTURE_3D:ue.isWebGLArrayRenderTarget||ue.isCompressedArrayTexture?t.TEXTURE_2D_ARRAY:t.TEXTURE_2D}function b(ue,ie,Re,Pe,Oe=!1){if(ue!==null){if(t[ue]!==void 0)return t[ue];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+ue+"'")}let Ce=ie;if(ie===t.RED&&(Re===t.FLOAT&&(Ce=t.R32F),Re===t.HALF_FLOAT&&(Ce=t.R16F),Re===t.UNSIGNED_BYTE&&(Ce=t.R8)),ie===t.RED_INTEGER&&(Re===t.UNSIGNED_BYTE&&(Ce=t.R8UI),Re===t.UNSIGNED_SHORT&&(Ce=t.R16UI),Re===t.UNSIGNED_INT&&(Ce=t.R32UI),Re===t.BYTE&&(Ce=t.R8I),Re===t.SHORT&&(Ce=t.R16I),Re===t.INT&&(Ce=t.R32I)),ie===t.RG&&(Re===t.FLOAT&&(Ce=t.RG32F),Re===t.HALF_FLOAT&&(Ce=t.RG16F),Re===t.UNSIGNED_BYTE&&(Ce=t.RG8)),ie===t.RG_INTEGER&&(Re===t.UNSIGNED_BYTE&&(Ce=t.RG8UI),Re===t.UNSIGNED_SHORT&&(Ce=t.RG16UI),Re===t.UNSIGNED_INT&&(Ce=t.RG32UI),Re===t.BYTE&&(Ce=t.RG8I),Re===t.SHORT&&(Ce=t.RG16I),Re===t.INT&&(Ce=t.RG32I)),ie===t.RGB_INTEGER&&(Re===t.UNSIGNED_BYTE&&(Ce=t.RGB8UI),Re===t.UNSIGNED_SHORT&&(Ce=t.RGB16UI),Re===t.UNSIGNED_INT&&(Ce=t.RGB32UI),Re===t.BYTE&&(Ce=t.RGB8I),Re===t.SHORT&&(Ce=t.RGB16I),Re===t.INT&&(Ce=t.RGB32I)),ie===t.RGBA_INTEGER&&(Re===t.UNSIGNED_BYTE&&(Ce=t.RGBA8UI),Re===t.UNSIGNED_SHORT&&(Ce=t.RGBA16UI),Re===t.UNSIGNED_INT&&(Ce=t.RGBA32UI),Re===t.BYTE&&(Ce=t.RGBA8I),Re===t.SHORT&&(Ce=t.RGBA16I),Re===t.INT&&(Ce=t.RGBA32I)),ie===t.RGB&&Re===t.UNSIGNED_INT_5_9_9_9_REV&&(Ce=t.RGB9_E5),ie===t.RGBA){const tt=Oe?Sl:ci.getTransfer(Pe);Re===t.FLOAT&&(Ce=t.RGBA32F),Re===t.HALF_FLOAT&&(Ce=t.RGBA16F),Re===t.UNSIGNED_BYTE&&(Ce=tt===wi?t.SRGB8_ALPHA8:t.RGBA8),Re===t.UNSIGNED_SHORT_4_4_4_4&&(Ce=t.RGBA4),Re===t.UNSIGNED_SHORT_5_5_5_1&&(Ce=t.RGB5_A1)}return(Ce===t.R16F||Ce===t.R32F||Ce===t.RG16F||Ce===t.RG32F||Ce===t.RGBA16F||Ce===t.RGBA32F)&&e.get("EXT_color_buffer_float"),Ce}function m(ue,ie){let Re;return ue?ie===null||ie===ra||ie===qo?Re=t.DEPTH24_STENCIL8:ie===es?Re=t.DEPTH32F_STENCIL8:ie===Go&&(Re=t.DEPTH24_STENCIL8,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):ie===null||ie===ra||ie===qo?Re=t.DEPTH_COMPONENT24:ie===es?Re=t.DEPTH_COMPONENT32F:ie===Go&&(Re=t.DEPTH_COMPONENT16),Re}function w(ue,ie){return M(ue)===!0||ue.isFramebufferTexture&&ue.minFilter!==Er&&ue.minFilter!==On?Math.log2(Math.max(ie.width,ie.height))+1:ue.mipmaps!==void 0&&ue.mipmaps.length>0?ue.mipmaps.length:ue.isCompressedTexture&&Array.isArray(ue.image)?ie.mipmaps.length:1}function T(ue){const ie=ue.target;ie.removeEventListener("dispose",T),L(ie),ie.isVideoTexture&&p.delete(ie)}function P(ue){const ie=ue.target;ie.removeEventListener("dispose",P),I(ie)}function L(ue){const ie=n.get(ue);if(ie.__webglInit===void 0)return;const Re=ue.source,Pe=g.get(Re);if(Pe){const Oe=Pe[ie.__cacheKey];Oe.usedTimes--,Oe.usedTimes===0&&k(ue),Object.keys(Pe).length===0&&g.delete(Re)}n.remove(ue)}function k(ue){const ie=n.get(ue);t.deleteTexture(ie.__webglTexture);const Re=ue.source,Pe=g.get(Re);delete Pe[ie.__cacheKey],o.memory.textures--}function I(ue){const ie=n.get(ue);if(ue.depthTexture&&(ue.depthTexture.dispose(),n.remove(ue.depthTexture)),ue.isWebGLCubeRenderTarget)for(let Pe=0;Pe<6;Pe++){if(Array.isArray(ie.__webglFramebuffer[Pe]))for(let Oe=0;Oe<ie.__webglFramebuffer[Pe].length;Oe++)t.deleteFramebuffer(ie.__webglFramebuffer[Pe][Oe]);else t.deleteFramebuffer(ie.__webglFramebuffer[Pe]);ie.__webglDepthbuffer&&t.deleteRenderbuffer(ie.__webglDepthbuffer[Pe])}else{if(Array.isArray(ie.__webglFramebuffer))for(let Pe=0;Pe<ie.__webglFramebuffer.length;Pe++)t.deleteFramebuffer(ie.__webglFramebuffer[Pe]);else t.deleteFramebuffer(ie.__webglFramebuffer);if(ie.__webglDepthbuffer&&t.deleteRenderbuffer(ie.__webglDepthbuffer),ie.__webglMultisampledFramebuffer&&t.deleteFramebuffer(ie.__webglMultisampledFramebuffer),ie.__webglColorRenderbuffer)for(let Pe=0;Pe<ie.__webglColorRenderbuffer.length;Pe++)ie.__webglColorRenderbuffer[Pe]&&t.deleteRenderbuffer(ie.__webglColorRenderbuffer[Pe]);ie.__webglDepthRenderbuffer&&t.deleteRenderbuffer(ie.__webglDepthRenderbuffer)}const Re=ue.textures;for(let Pe=0,Oe=Re.length;Pe<Oe;Pe++){const Ce=n.get(Re[Pe]);Ce.__webglTexture&&(t.deleteTexture(Ce.__webglTexture),o.memory.textures--),n.remove(Re[Pe])}n.remove(ue)}let z=0;function K(){z=0}function $(){const ue=z;return ue>=r.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+ue+" texture units while this GPU supports only "+r.maxTextures),z+=1,ue}function te(ue){const ie=[];return ie.push(ue.wrapS),ie.push(ue.wrapT),ie.push(ue.wrapR||0),ie.push(ue.magFilter),ie.push(ue.minFilter),ie.push(ue.anisotropy),ie.push(ue.internalFormat),ie.push(ue.format),ie.push(ue.type),ie.push(ue.generateMipmaps),ie.push(ue.premultiplyAlpha),ie.push(ue.flipY),ie.push(ue.unpackAlignment),ie.push(ue.colorSpace),ie.join()}function ee(ue,ie){const Re=n.get(ue);if(ue.isVideoTexture&&Rt(ue),ue.isRenderTargetTexture===!1&&ue.version>0&&Re.__version!==ue.version){const Pe=ue.image;if(Pe===null)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else if(Pe.complete===!1)console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete");else{ht(Re,ue,ie);return}}i.bindTexture(t.TEXTURE_2D,Re.__webglTexture,t.TEXTURE0+ie)}function de(ue,ie){const Re=n.get(ue);if(ue.version>0&&Re.__version!==ue.version){ht(Re,ue,ie);return}i.bindTexture(t.TEXTURE_2D_ARRAY,Re.__webglTexture,t.TEXTURE0+ie)}function X(ue,ie){const Re=n.get(ue);if(ue.version>0&&Re.__version!==ue.version){ht(Re,ue,ie);return}i.bindTexture(t.TEXTURE_3D,Re.__webglTexture,t.TEXTURE0+ie)}function le(ue,ie){const Re=n.get(ue);if(ue.version>0&&Re.__version!==ue.version){nt(Re,ue,ie);return}i.bindTexture(t.TEXTURE_CUBE_MAP,Re.__webglTexture,t.TEXTURE0+ie)}const _e={[Uu]:t.REPEAT,[Ys]:t.CLAMP_TO_EDGE,[Bu]:t.MIRRORED_REPEAT},Se={[Er]:t.NEAREST,[eC]:t.NEAREST_MIPMAP_NEAREST,[Cc]:t.NEAREST_MIPMAP_LINEAR,[On]:t.LINEAR,[Md]:t.LINEAR_MIPMAP_NEAREST,[Js]:t.LINEAR_MIPMAP_LINEAR},De={[sC]:t.NEVER,[uC]:t.ALWAYS,[aC]:t.LESS,[Rv]:t.LEQUAL,[oC]:t.EQUAL,[dC]:t.GEQUAL,[cC]:t.GREATER,[lC]:t.NOTEQUAL};function We(ue,ie){if(ie.type===es&&e.has("OES_texture_float_linear")===!1&&(ie.magFilter===On||ie.magFilter===Md||ie.magFilter===Cc||ie.magFilter===Js||ie.minFilter===On||ie.minFilter===Md||ie.minFilter===Cc||ie.minFilter===Js)&&console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),t.texParameteri(ue,t.TEXTURE_WRAP_S,_e[ie.wrapS]),t.texParameteri(ue,t.TEXTURE_WRAP_T,_e[ie.wrapT]),(ue===t.TEXTURE_3D||ue===t.TEXTURE_2D_ARRAY)&&t.texParameteri(ue,t.TEXTURE_WRAP_R,_e[ie.wrapR]),t.texParameteri(ue,t.TEXTURE_MAG_FILTER,Se[ie.magFilter]),t.texParameteri(ue,t.TEXTURE_MIN_FILTER,Se[ie.minFilter]),ie.compareFunction&&(t.texParameteri(ue,t.TEXTURE_COMPARE_MODE,t.COMPARE_REF_TO_TEXTURE),t.texParameteri(ue,t.TEXTURE_COMPARE_FUNC,De[ie.compareFunction])),e.has("EXT_texture_filter_anisotropic")===!0){if(ie.magFilter===Er||ie.minFilter!==Cc&&ie.minFilter!==Js||ie.type===es&&e.has("OES_texture_float_linear")===!1)return;if(ie.anisotropy>1||n.get(ie).__currentAnisotropy){const Re=e.get("EXT_texture_filter_anisotropic");t.texParameterf(ue,Re.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(ie.anisotropy,r.getMaxAnisotropy())),n.get(ie).__currentAnisotropy=ie.anisotropy}}}function Ve(ue,ie){let Re=!1;ue.__webglInit===void 0&&(ue.__webglInit=!0,ie.addEventListener("dispose",T));const Pe=ie.source;let Oe=g.get(Pe);Oe===void 0&&(Oe={},g.set(Pe,Oe));const Ce=te(ie);if(Ce!==ue.__cacheKey){Oe[Ce]===void 0&&(Oe[Ce]={texture:t.createTexture(),usedTimes:0},o.memory.textures++,Re=!0),Oe[Ce].usedTimes++;const tt=Oe[ue.__cacheKey];tt!==void 0&&(Oe[ue.__cacheKey].usedTimes--,tt.usedTimes===0&&k(ie)),ue.__cacheKey=Ce,ue.__webglTexture=Oe[Ce].texture}return Re}function Me(ue,ie,Re){return Math.floor(Math.floor(ue/Re)/ie)}function ze(ue,ie,Re,Pe){const Ce=ue.updateRanges;if(Ce.length===0)i.texSubImage2D(t.TEXTURE_2D,0,0,0,ie.width,ie.height,Re,Pe,ie.data);else{Ce.sort((Ie,it)=>Ie.start-it.start);let tt=0;for(let Ie=1;Ie<Ce.length;Ie++){const it=Ce[tt],Pt=Ce[Ie],Mt=it.start+it.count,st=Me(Pt.start,ie.width,4),kt=Me(it.start,ie.width,4);Pt.start<=Mt+1&&st===kt&&Me(Pt.start+Pt.count-1,ie.width,4)===st?it.count=Math.max(it.count,Pt.start+Pt.count-it.start):(++tt,Ce[tt]=Pt)}Ce.length=tt+1;const et=t.getParameter(t.UNPACK_ROW_LENGTH),ut=t.getParameter(t.UNPACK_SKIP_PIXELS),Qe=t.getParameter(t.UNPACK_SKIP_ROWS);t.pixelStorei(t.UNPACK_ROW_LENGTH,ie.width);for(let Ie=0,it=Ce.length;Ie<it;Ie++){const Pt=Ce[Ie],Mt=Math.floor(Pt.start/4),st=Math.ceil(Pt.count/4),kt=Mt%ie.width,ve=Math.floor(Mt/ie.width),ot=st,Ke=1;t.pixelStorei(t.UNPACK_SKIP_PIXELS,kt),t.pixelStorei(t.UNPACK_SKIP_ROWS,ve),i.texSubImage2D(t.TEXTURE_2D,0,kt,ve,ot,Ke,Re,Pe,ie.data)}ue.clearUpdateRanges(),t.pixelStorei(t.UNPACK_ROW_LENGTH,et),t.pixelStorei(t.UNPACK_SKIP_PIXELS,ut),t.pixelStorei(t.UNPACK_SKIP_ROWS,Qe)}}function ht(ue,ie,Re){let Pe=t.TEXTURE_2D;(ie.isDataArrayTexture||ie.isCompressedArrayTexture)&&(Pe=t.TEXTURE_2D_ARRAY),ie.isData3DTexture&&(Pe=t.TEXTURE_3D);const Oe=Ve(ue,ie),Ce=ie.source;i.bindTexture(Pe,ue.__webglTexture,t.TEXTURE0+Re);const tt=n.get(Ce);if(Ce.version!==tt.__version||Oe===!0){i.activeTexture(t.TEXTURE0+Re);const et=ci.getPrimaries(ci.workingColorSpace),ut=ie.colorSpace===Ss?null:ci.getPrimaries(ie.colorSpace),Qe=ie.colorSpace===Ss||et===ut?t.NONE:t.BROWSER_DEFAULT_WEBGL;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,ie.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,ie.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,ie.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,Qe);let Ie=E(ie.image,!1,r.maxTextureSize);Ie=Ut(ie,Ie);const it=s.convert(ie.format,ie.colorSpace),Pt=s.convert(ie.type);let Mt=b(ie.internalFormat,it,Pt,ie.colorSpace,ie.isVideoTexture);We(Pe,ie);let st;const kt=ie.mipmaps,ve=ie.isVideoTexture!==!0,ot=tt.__version===void 0||Oe===!0,Ke=Ce.dataReady,bt=w(ie,Ie);if(ie.isDepthTexture)Mt=m(ie.format===Ko,ie.type),ot&&(ve?i.texStorage2D(t.TEXTURE_2D,1,Mt,Ie.width,Ie.height):i.texImage2D(t.TEXTURE_2D,0,Mt,Ie.width,Ie.height,0,it,Pt,null));else if(ie.isDataTexture)if(kt.length>0){ve&&ot&&i.texStorage2D(t.TEXTURE_2D,bt,Mt,kt[0].width,kt[0].height);for(let Ze=0,Ge=kt.length;Ze<Ge;Ze++)st=kt[Ze],ve?Ke&&i.texSubImage2D(t.TEXTURE_2D,Ze,0,0,st.width,st.height,it,Pt,st.data):i.texImage2D(t.TEXTURE_2D,Ze,Mt,st.width,st.height,0,it,Pt,st.data);ie.generateMipmaps=!1}else ve?(ot&&i.texStorage2D(t.TEXTURE_2D,bt,Mt,Ie.width,Ie.height),Ke&&ze(ie,Ie,it,Pt)):i.texImage2D(t.TEXTURE_2D,0,Mt,Ie.width,Ie.height,0,it,Pt,Ie.data);else if(ie.isCompressedTexture)if(ie.isCompressedArrayTexture){ve&&ot&&i.texStorage3D(t.TEXTURE_2D_ARRAY,bt,Mt,kt[0].width,kt[0].height,Ie.depth);for(let Ze=0,Ge=kt.length;Ze<Ge;Ze++)if(st=kt[Ze],ie.format!==Sr)if(it!==null)if(ve){if(Ke)if(ie.layerUpdates.size>0){const St=Mf(st.width,st.height,ie.format,ie.type);for(const Bt of ie.layerUpdates){const Ci=st.data.subarray(Bt*St/st.data.BYTES_PER_ELEMENT,(Bt+1)*St/st.data.BYTES_PER_ELEMENT);i.compressedTexSubImage3D(t.TEXTURE_2D_ARRAY,Ze,0,0,Bt,st.width,st.height,1,it,Ci)}ie.clearLayerUpdates()}else i.compressedTexSubImage3D(t.TEXTURE_2D_ARRAY,Ze,0,0,0,st.width,st.height,Ie.depth,it,st.data)}else i.compressedTexImage3D(t.TEXTURE_2D_ARRAY,Ze,Mt,st.width,st.height,Ie.depth,0,st.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else ve?Ke&&i.texSubImage3D(t.TEXTURE_2D_ARRAY,Ze,0,0,0,st.width,st.height,Ie.depth,it,Pt,st.data):i.texImage3D(t.TEXTURE_2D_ARRAY,Ze,Mt,st.width,st.height,Ie.depth,0,it,Pt,st.data)}else{ve&&ot&&i.texStorage2D(t.TEXTURE_2D,bt,Mt,kt[0].width,kt[0].height);for(let Ze=0,Ge=kt.length;Ze<Ge;Ze++)st=kt[Ze],ie.format!==Sr?it!==null?ve?Ke&&i.compressedTexSubImage2D(t.TEXTURE_2D,Ze,0,0,st.width,st.height,it,st.data):i.compressedTexImage2D(t.TEXTURE_2D,Ze,Mt,st.width,st.height,0,st.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):ve?Ke&&i.texSubImage2D(t.TEXTURE_2D,Ze,0,0,st.width,st.height,it,Pt,st.data):i.texImage2D(t.TEXTURE_2D,Ze,Mt,st.width,st.height,0,it,Pt,st.data)}else if(ie.isDataArrayTexture)if(ve){if(ot&&i.texStorage3D(t.TEXTURE_2D_ARRAY,bt,Mt,Ie.width,Ie.height,Ie.depth),Ke)if(ie.layerUpdates.size>0){const Ze=Mf(Ie.width,Ie.height,ie.format,ie.type);for(const Ge of ie.layerUpdates){const St=Ie.data.subarray(Ge*Ze/Ie.data.BYTES_PER_ELEMENT,(Ge+1)*Ze/Ie.data.BYTES_PER_ELEMENT);i.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,Ge,Ie.width,Ie.height,1,it,Pt,St)}ie.clearLayerUpdates()}else i.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,0,Ie.width,Ie.height,Ie.depth,it,Pt,Ie.data)}else i.texImage3D(t.TEXTURE_2D_ARRAY,0,Mt,Ie.width,Ie.height,Ie.depth,0,it,Pt,Ie.data);else if(ie.isData3DTexture)ve?(ot&&i.texStorage3D(t.TEXTURE_3D,bt,Mt,Ie.width,Ie.height,Ie.depth),Ke&&i.texSubImage3D(t.TEXTURE_3D,0,0,0,0,Ie.width,Ie.height,Ie.depth,it,Pt,Ie.data)):i.texImage3D(t.TEXTURE_3D,0,Mt,Ie.width,Ie.height,Ie.depth,0,it,Pt,Ie.data);else if(ie.isFramebufferTexture){if(ot)if(ve)i.texStorage2D(t.TEXTURE_2D,bt,Mt,Ie.width,Ie.height);else{let Ze=Ie.width,Ge=Ie.height;for(let St=0;St<bt;St++)i.texImage2D(t.TEXTURE_2D,St,Mt,Ze,Ge,0,it,Pt,null),Ze>>=1,Ge>>=1}}else if(kt.length>0){if(ve&&ot){const Ze=Ii(kt[0]);i.texStorage2D(t.TEXTURE_2D,bt,Mt,Ze.width,Ze.height)}for(let Ze=0,Ge=kt.length;Ze<Ge;Ze++)st=kt[Ze],ve?Ke&&i.texSubImage2D(t.TEXTURE_2D,Ze,0,0,it,Pt,st):i.texImage2D(t.TEXTURE_2D,Ze,Mt,it,Pt,st);ie.generateMipmaps=!1}else if(ve){if(ot){const Ze=Ii(Ie);i.texStorage2D(t.TEXTURE_2D,bt,Mt,Ze.width,Ze.height)}Ke&&i.texSubImage2D(t.TEXTURE_2D,0,0,0,it,Pt,Ie)}else i.texImage2D(t.TEXTURE_2D,0,Mt,it,Pt,Ie);M(ie)&&R(Pe),tt.__version=Ce.version,ie.onUpdate&&ie.onUpdate(ie)}ue.__version=ie.version}function nt(ue,ie,Re){if(ie.image.length!==6)return;const Pe=Ve(ue,ie),Oe=ie.source;i.bindTexture(t.TEXTURE_CUBE_MAP,ue.__webglTexture,t.TEXTURE0+Re);const Ce=n.get(Oe);if(Oe.version!==Ce.__version||Pe===!0){i.activeTexture(t.TEXTURE0+Re);const tt=ci.getPrimaries(ci.workingColorSpace),et=ie.colorSpace===Ss?null:ci.getPrimaries(ie.colorSpace),ut=ie.colorSpace===Ss||tt===et?t.NONE:t.BROWSER_DEFAULT_WEBGL;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,ie.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,ie.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,ie.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,ut);const Qe=ie.isCompressedTexture||ie.image[0].isCompressedTexture,Ie=ie.image[0]&&ie.image[0].isDataTexture,it=[];for(let Ge=0;Ge<6;Ge++)!Qe&&!Ie?it[Ge]=E(ie.image[Ge],!0,r.maxCubemapSize):it[Ge]=Ie?ie.image[Ge].image:ie.image[Ge],it[Ge]=Ut(ie,it[Ge]);const Pt=it[0],Mt=s.convert(ie.format,ie.colorSpace),st=s.convert(ie.type),kt=b(ie.internalFormat,Mt,st,ie.colorSpace),ve=ie.isVideoTexture!==!0,ot=Ce.__version===void 0||Pe===!0,Ke=Oe.dataReady;let bt=w(ie,Pt);We(t.TEXTURE_CUBE_MAP,ie);let Ze;if(Qe){ve&&ot&&i.texStorage2D(t.TEXTURE_CUBE_MAP,bt,kt,Pt.width,Pt.height);for(let Ge=0;Ge<6;Ge++){Ze=it[Ge].mipmaps;for(let St=0;St<Ze.length;St++){const Bt=Ze[St];ie.format!==Sr?Mt!==null?ve?Ke&&i.compressedTexSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St,0,0,Bt.width,Bt.height,Mt,Bt.data):i.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St,kt,Bt.width,Bt.height,0,Bt.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):ve?Ke&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St,0,0,Bt.width,Bt.height,Mt,st,Bt.data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St,kt,Bt.width,Bt.height,0,Mt,st,Bt.data)}}}else{if(Ze=ie.mipmaps,ve&&ot){Ze.length>0&&bt++;const Ge=Ii(it[0]);i.texStorage2D(t.TEXTURE_CUBE_MAP,bt,kt,Ge.width,Ge.height)}for(let Ge=0;Ge<6;Ge++)if(Ie){ve?Ke&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,0,0,0,it[Ge].width,it[Ge].height,Mt,st,it[Ge].data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,0,kt,it[Ge].width,it[Ge].height,0,Mt,st,it[Ge].data);for(let St=0;St<Ze.length;St++){const Ci=Ze[St].image[Ge].image;ve?Ke&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St+1,0,0,Ci.width,Ci.height,Mt,st,Ci.data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St+1,kt,Ci.width,Ci.height,0,Mt,st,Ci.data)}}else{ve?Ke&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,0,0,0,Mt,st,it[Ge]):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,0,kt,Mt,st,it[Ge]);for(let St=0;St<Ze.length;St++){const Bt=Ze[St];ve?Ke&&i.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St+1,0,0,Mt,st,Bt.image[Ge]):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,St+1,kt,Mt,st,Bt.image[Ge])}}}M(ie)&&R(t.TEXTURE_CUBE_MAP),Ce.__version=Oe.version,ie.onUpdate&&ie.onUpdate(ie)}ue.__version=ie.version}function rt(ue,ie,Re,Pe,Oe,Ce){const tt=s.convert(Re.format,Re.colorSpace),et=s.convert(Re.type),ut=b(Re.internalFormat,tt,et,Re.colorSpace),Qe=n.get(ie),Ie=n.get(Re);if(Ie.__renderTarget=ie,!Qe.__hasExternalTextures){const it=Math.max(1,ie.width>>Ce),Pt=Math.max(1,ie.height>>Ce);Oe===t.TEXTURE_3D||Oe===t.TEXTURE_2D_ARRAY?i.texImage3D(Oe,Ce,ut,it,Pt,ie.depth,0,tt,et,null):i.texImage2D(Oe,Ce,ut,it,Pt,0,tt,et,null)}i.bindFramebuffer(t.FRAMEBUFFER,ue),Xt(ie)?c.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,Pe,Oe,Ie.__webglTexture,0,yt(ie)):(Oe===t.TEXTURE_2D||Oe>=t.TEXTURE_CUBE_MAP_POSITIVE_X&&Oe<=t.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&t.framebufferTexture2D(t.FRAMEBUFFER,Pe,Oe,Ie.__webglTexture,Ce),i.bindFramebuffer(t.FRAMEBUFFER,null)}function jt(ue,ie,Re){if(t.bindRenderbuffer(t.RENDERBUFFER,ue),ie.depthBuffer){const Pe=ie.depthTexture,Oe=Pe&&Pe.isDepthTexture?Pe.type:null,Ce=m(ie.stencilBuffer,Oe),tt=ie.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT,et=yt(ie);Xt(ie)?c.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,et,Ce,ie.width,ie.height):Re?t.renderbufferStorageMultisample(t.RENDERBUFFER,et,Ce,ie.width,ie.height):t.renderbufferStorage(t.RENDERBUFFER,Ce,ie.width,ie.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,tt,t.RENDERBUFFER,ue)}else{const Pe=ie.textures;for(let Oe=0;Oe<Pe.length;Oe++){const Ce=Pe[Oe],tt=s.convert(Ce.format,Ce.colorSpace),et=s.convert(Ce.type),ut=b(Ce.internalFormat,tt,et,Ce.colorSpace),Qe=yt(ie);Re&&Xt(ie)===!1?t.renderbufferStorageMultisample(t.RENDERBUFFER,Qe,ut,ie.width,ie.height):Xt(ie)?c.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,Qe,ut,ie.width,ie.height):t.renderbufferStorage(t.RENDERBUFFER,ut,ie.width,ie.height)}}t.bindRenderbuffer(t.RENDERBUFFER,null)}function Ct(ue,ie){if(ie&&ie.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(t.FRAMEBUFFER,ue),!(ie.depthTexture&&ie.depthTexture.isDepthTexture))throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const Pe=n.get(ie.depthTexture);Pe.__renderTarget=ie,(!Pe.__webglTexture||ie.depthTexture.image.width!==ie.width||ie.depthTexture.image.height!==ie.height)&&(ie.depthTexture.image.width=ie.width,ie.depthTexture.image.height=ie.height,ie.depthTexture.needsUpdate=!0),ee(ie.depthTexture,0);const Oe=Pe.__webglTexture,Ce=yt(ie);if(ie.depthTexture.format===Wo)Xt(ie)?c.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,Oe,0,Ce):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,Oe,0);else if(ie.depthTexture.format===Ko)Xt(ie)?c.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,Oe,0,Ce):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,Oe,0);else throw new Error("Unknown depthTexture format")}function li(ue){const ie=n.get(ue),Re=ue.isWebGLCubeRenderTarget===!0;if(ie.__boundDepthTexture!==ue.depthTexture){const Pe=ue.depthTexture;if(ie.__depthDisposeCallback&&ie.__depthDisposeCallback(),Pe){const Oe=()=>{delete ie.__boundDepthTexture,delete ie.__depthDisposeCallback,Pe.removeEventListener("dispose",Oe)};Pe.addEventListener("dispose",Oe),ie.__depthDisposeCallback=Oe}ie.__boundDepthTexture=Pe}if(ue.depthTexture&&!ie.__autoAllocateDepthBuffer){if(Re)throw new Error("target.depthTexture not supported in Cube render targets");const Pe=ue.texture.mipmaps;Pe&&Pe.length>0?Ct(ie.__webglFramebuffer[0],ue):Ct(ie.__webglFramebuffer,ue)}else if(Re){ie.__webglDepthbuffer=[];for(let Pe=0;Pe<6;Pe++)if(i.bindFramebuffer(t.FRAMEBUFFER,ie.__webglFramebuffer[Pe]),ie.__webglDepthbuffer[Pe]===void 0)ie.__webglDepthbuffer[Pe]=t.createRenderbuffer(),jt(ie.__webglDepthbuffer[Pe],ue,!1);else{const Oe=ue.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT,Ce=ie.__webglDepthbuffer[Pe];t.bindRenderbuffer(t.RENDERBUFFER,Ce),t.framebufferRenderbuffer(t.FRAMEBUFFER,Oe,t.RENDERBUFFER,Ce)}}else{const Pe=ue.texture.mipmaps;if(Pe&&Pe.length>0?i.bindFramebuffer(t.FRAMEBUFFER,ie.__webglFramebuffer[0]):i.bindFramebuffer(t.FRAMEBUFFER,ie.__webglFramebuffer),ie.__webglDepthbuffer===void 0)ie.__webglDepthbuffer=t.createRenderbuffer(),jt(ie.__webglDepthbuffer,ue,!1);else{const Oe=ue.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT,Ce=ie.__webglDepthbuffer;t.bindRenderbuffer(t.RENDERBUFFER,Ce),t.framebufferRenderbuffer(t.FRAMEBUFFER,Oe,t.RENDERBUFFER,Ce)}}i.bindFramebuffer(t.FRAMEBUFFER,null)}function di(ue,ie,Re){const Pe=n.get(ue);ie!==void 0&&rt(Pe.__webglFramebuffer,ue,ue.texture,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,0),Re!==void 0&&li(ue)}function zt(ue){const ie=ue.texture,Re=n.get(ue),Pe=n.get(ie);ue.addEventListener("dispose",P);const Oe=ue.textures,Ce=ue.isWebGLCubeRenderTarget===!0,tt=Oe.length>1;if(tt||(Pe.__webglTexture===void 0&&(Pe.__webglTexture=t.createTexture()),Pe.__version=ie.version,o.memory.textures++),Ce){Re.__webglFramebuffer=[];for(let et=0;et<6;et++)if(ie.mipmaps&&ie.mipmaps.length>0){Re.__webglFramebuffer[et]=[];for(let ut=0;ut<ie.mipmaps.length;ut++)Re.__webglFramebuffer[et][ut]=t.createFramebuffer()}else Re.__webglFramebuffer[et]=t.createFramebuffer()}else{if(ie.mipmaps&&ie.mipmaps.length>0){Re.__webglFramebuffer=[];for(let et=0;et<ie.mipmaps.length;et++)Re.__webglFramebuffer[et]=t.createFramebuffer()}else Re.__webglFramebuffer=t.createFramebuffer();if(tt)for(let et=0,ut=Oe.length;et<ut;et++){const Qe=n.get(Oe[et]);Qe.__webglTexture===void 0&&(Qe.__webglTexture=t.createTexture(),o.memory.textures++)}if(ue.samples>0&&Xt(ue)===!1){Re.__webglMultisampledFramebuffer=t.createFramebuffer(),Re.__webglColorRenderbuffer=[],i.bindFramebuffer(t.FRAMEBUFFER,Re.__webglMultisampledFramebuffer);for(let et=0;et<Oe.length;et++){const ut=Oe[et];Re.__webglColorRenderbuffer[et]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,Re.__webglColorRenderbuffer[et]);const Qe=s.convert(ut.format,ut.colorSpace),Ie=s.convert(ut.type),it=b(ut.internalFormat,Qe,Ie,ut.colorSpace,ue.isXRRenderTarget===!0),Pt=yt(ue);t.renderbufferStorageMultisample(t.RENDERBUFFER,Pt,it,ue.width,ue.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+et,t.RENDERBUFFER,Re.__webglColorRenderbuffer[et])}t.bindRenderbuffer(t.RENDERBUFFER,null),ue.depthBuffer&&(Re.__webglDepthRenderbuffer=t.createRenderbuffer(),jt(Re.__webglDepthRenderbuffer,ue,!0)),i.bindFramebuffer(t.FRAMEBUFFER,null)}}if(Ce){i.bindTexture(t.TEXTURE_CUBE_MAP,Pe.__webglTexture),We(t.TEXTURE_CUBE_MAP,ie);for(let et=0;et<6;et++)if(ie.mipmaps&&ie.mipmaps.length>0)for(let ut=0;ut<ie.mipmaps.length;ut++)rt(Re.__webglFramebuffer[et][ut],ue,ie,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+et,ut);else rt(Re.__webglFramebuffer[et],ue,ie,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+et,0);M(ie)&&R(t.TEXTURE_CUBE_MAP),i.unbindTexture()}else if(tt){for(let et=0,ut=Oe.length;et<ut;et++){const Qe=Oe[et],Ie=n.get(Qe);i.bindTexture(t.TEXTURE_2D,Ie.__webglTexture),We(t.TEXTURE_2D,Qe),rt(Re.__webglFramebuffer,ue,Qe,t.COLOR_ATTACHMENT0+et,t.TEXTURE_2D,0),M(Qe)&&R(t.TEXTURE_2D)}i.unbindTexture()}else{let et=t.TEXTURE_2D;if((ue.isWebGL3DRenderTarget||ue.isWebGLArrayRenderTarget)&&(et=ue.isWebGL3DRenderTarget?t.TEXTURE_3D:t.TEXTURE_2D_ARRAY),i.bindTexture(et,Pe.__webglTexture),We(et,ie),ie.mipmaps&&ie.mipmaps.length>0)for(let ut=0;ut<ie.mipmaps.length;ut++)rt(Re.__webglFramebuffer[ut],ue,ie,t.COLOR_ATTACHMENT0,et,ut);else rt(Re.__webglFramebuffer,ue,ie,t.COLOR_ATTACHMENT0,et,0);M(ie)&&R(et),i.unbindTexture()}ue.depthBuffer&&li(ue)}function he(ue){const ie=ue.textures;for(let Re=0,Pe=ie.length;Re<Pe;Re++){const Oe=ie[Re];if(M(Oe)){const Ce=N(ue),tt=n.get(Oe).__webglTexture;i.bindTexture(Ce,tt),R(Ce),i.unbindTexture()}}}const mi=[],ti=[];function si(ue){if(ue.samples>0){if(Xt(ue)===!1){const ie=ue.textures,Re=ue.width,Pe=ue.height;let Oe=t.COLOR_BUFFER_BIT;const Ce=ue.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT,tt=n.get(ue),et=ie.length>1;if(et)for(let Qe=0;Qe<ie.length;Qe++)i.bindFramebuffer(t.FRAMEBUFFER,tt.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+Qe,t.RENDERBUFFER,null),i.bindFramebuffer(t.FRAMEBUFFER,tt.__webglFramebuffer),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+Qe,t.TEXTURE_2D,null,0);i.bindFramebuffer(t.READ_FRAMEBUFFER,tt.__webglMultisampledFramebuffer);const ut=ue.texture.mipmaps;ut&&ut.length>0?i.bindFramebuffer(t.DRAW_FRAMEBUFFER,tt.__webglFramebuffer[0]):i.bindFramebuffer(t.DRAW_FRAMEBUFFER,tt.__webglFramebuffer);for(let Qe=0;Qe<ie.length;Qe++){if(ue.resolveDepthBuffer&&(ue.depthBuffer&&(Oe|=t.DEPTH_BUFFER_BIT),ue.stencilBuffer&&ue.resolveStencilBuffer&&(Oe|=t.STENCIL_BUFFER_BIT)),et){t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,tt.__webglColorRenderbuffer[Qe]);const Ie=n.get(ie[Qe]).__webglTexture;t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,Ie,0)}t.blitFramebuffer(0,0,Re,Pe,0,0,Re,Pe,Oe,t.NEAREST),h===!0&&(mi.length=0,ti.length=0,mi.push(t.COLOR_ATTACHMENT0+Qe),ue.depthBuffer&&ue.resolveDepthBuffer===!1&&(mi.push(Ce),ti.push(Ce),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,ti)),t.invalidateFramebuffer(t.READ_FRAMEBUFFER,mi))}if(i.bindFramebuffer(t.READ_FRAMEBUFFER,null),i.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),et)for(let Qe=0;Qe<ie.length;Qe++){i.bindFramebuffer(t.FRAMEBUFFER,tt.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+Qe,t.RENDERBUFFER,tt.__webglColorRenderbuffer[Qe]);const Ie=n.get(ie[Qe]).__webglTexture;i.bindFramebuffer(t.FRAMEBUFFER,tt.__webglFramebuffer),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+Qe,t.TEXTURE_2D,Ie,0)}i.bindFramebuffer(t.DRAW_FRAMEBUFFER,tt.__webglMultisampledFramebuffer)}else if(ue.depthBuffer&&ue.resolveDepthBuffer===!1&&h){const ie=ue.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,[ie])}}}function yt(ue){return Math.min(r.maxSamples,ue.samples)}function Xt(ue){const ie=n.get(ue);return ue.samples>0&&e.has("WEBGL_multisampled_render_to_texture")===!0&&ie.__useRenderToTexture!==!1}function Rt(ue){const ie=o.render.frame;p.get(ue)!==ie&&(p.set(ue,ie),ue.update())}function Ut(ue,ie){const Re=ue.colorSpace,Pe=ue.format,Oe=ue.type;return ue.isCompressedTexture===!0||ue.isVideoTexture===!0||Re!==Ja&&Re!==Ss&&(ci.getTransfer(Re)===wi?(Pe!==Sr||Oe!==ss)&&console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",Re)),ie}function Ii(ue){return typeof HTMLImageElement<"u"&&ue instanceof HTMLImageElement?(d.width=ue.naturalWidth||ue.width,d.height=ue.naturalHeight||ue.height):typeof VideoFrame<"u"&&ue instanceof VideoFrame?(d.width=ue.displayWidth,d.height=ue.displayHeight):(d.width=ue.width,d.height=ue.height),d}this.allocateTextureUnit=$,this.resetTextureUnits=K,this.setTexture2D=ee,this.setTexture2DArray=de,this.setTexture3D=X,this.setTextureCube=le,this.rebindTextures=di,this.setupRenderTarget=zt,this.updateRenderTargetMipmap=he,this.updateMultisampleRenderTarget=si,this.setupDepthRenderbuffer=li,this.setupFrameBufferTexture=rt,this.useMultisampledRTT=Xt}function CA(t,e){function i(n,r=Ss){let s;const o=ci.getTransfer(r);if(n===ss)return t.UNSIGNED_BYTE;if(n===Nh)return t.UNSIGNED_SHORT_4_4_4_4;if(n===Lh)return t.UNSIGNED_SHORT_5_5_5_1;if(n===wv)return t.UNSIGNED_INT_5_9_9_9_REV;if(n===yv)return t.BYTE;if(n===Sv)return t.SHORT;if(n===Go)return t.UNSIGNED_SHORT;if(n===Fh)return t.INT;if(n===ra)return t.UNSIGNED_INT;if(n===es)return t.FLOAT;if(n===Jo)return t.HALF_FLOAT;if(n===xv)return t.ALPHA;if(n===Oh)return t.RGB;if(n===Sr)return t.RGBA;if(n===Wo)return t.DEPTH_COMPONENT;if(n===Ko)return t.DEPTH_STENCIL;if(n===Ev)return t.RED;if(n===kh)return t.RED_INTEGER;if(n===Cv)return t.RG;if(n===Uh)return t.RG_INTEGER;if(n===Bh)return t.RGBA_INTEGER;if(n===il||n===nl||n===rl||n===sl)if(o===wi)if(s=e.get("WEBGL_compressed_texture_s3tc_srgb"),s!==null){if(n===il)return s.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===nl)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===rl)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===sl)return s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null;else if(s=e.get("WEBGL_compressed_texture_s3tc"),s!==null){if(n===il)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===nl)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===rl)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===sl)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(n===Hu||n===ju||n===Vu||n===zu)if(s=e.get("WEBGL_compressed_texture_pvrtc"),s!==null){if(n===Hu)return s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===ju)return s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===Vu)return s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===zu)return s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(n===Gu||n===qu||n===Wu)if(s=e.get("WEBGL_compressed_texture_etc"),s!==null){if(n===Gu||n===qu)return o===wi?s.COMPRESSED_SRGB8_ETC2:s.COMPRESSED_RGB8_ETC2;if(n===Wu)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:s.COMPRESSED_RGBA8_ETC2_EAC}else return null;if(n===Ku||n===Xu||n===$u||n===Zu||n===Yu||n===Ju||n===Qu||n===eh||n===th||n===ih||n===nh||n===rh||n===sh||n===ah)if(s=e.get("WEBGL_compressed_texture_astc"),s!==null){if(n===Ku)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:s.COMPRESSED_RGBA_ASTC_4x4_KHR;if(n===Xu)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:s.COMPRESSED_RGBA_ASTC_5x4_KHR;if(n===$u)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:s.COMPRESSED_RGBA_ASTC_5x5_KHR;if(n===Zu)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:s.COMPRESSED_RGBA_ASTC_6x5_KHR;if(n===Yu)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:s.COMPRESSED_RGBA_ASTC_6x6_KHR;if(n===Ju)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:s.COMPRESSED_RGBA_ASTC_8x5_KHR;if(n===Qu)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:s.COMPRESSED_RGBA_ASTC_8x6_KHR;if(n===eh)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:s.COMPRESSED_RGBA_ASTC_8x8_KHR;if(n===th)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:s.COMPRESSED_RGBA_ASTC_10x5_KHR;if(n===ih)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:s.COMPRESSED_RGBA_ASTC_10x6_KHR;if(n===nh)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:s.COMPRESSED_RGBA_ASTC_10x8_KHR;if(n===rh)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:s.COMPRESSED_RGBA_ASTC_10x10_KHR;if(n===sh)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:s.COMPRESSED_RGBA_ASTC_12x10_KHR;if(n===ah)return o===wi?s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:s.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null;if(n===al||n===oh||n===ch)if(s=e.get("EXT_texture_compression_bptc"),s!==null){if(n===al)return o===wi?s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:s.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(n===oh)return s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(n===ch)return s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}else return null;if(n===Tv||n===lh||n===dh||n===uh)if(s=e.get("EXT_texture_compression_rgtc"),s!==null){if(n===al)return s.COMPRESSED_RED_RGTC1_EXT;if(n===lh)return s.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(n===dh)return s.COMPRESSED_RED_GREEN_RGTC2_EXT;if(n===uh)return s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}else return null;return n===qo?t.UNSIGNED_INT_24_8:t[n]!==void 0?t[n]:null}return{convert:i}}const TA=`
void main() {

	gl_Position = vec4( position, 1.0 );

}`,RA=`
uniform sampler2DArray depthColor;
uniform float depthWidth;
uniform float depthHeight;

void main() {

	vec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );

	if ( coord.x >= 1.0 ) {

		gl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;

	} else {

		gl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;

	}

}`;class MA{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,i,n){if(this.texture===null){const r=new Tn,s=e.properties.get(r);s.__webglTexture=i.texture,(i.depthNear!==n.depthNear||i.depthFar!==n.depthFar)&&(this.depthNear=i.depthNear,this.depthFar=i.depthFar),this.texture=r}}getMesh(e){if(this.texture!==null&&this.mesh===null){const i=e.cameras[0].viewport,n=new Ms({vertexShader:TA,fragmentShader:RA,uniforms:{depthColor:{value:this.texture},depthWidth:{value:i.z},depthHeight:{value:i.w}}});this.mesh=new Or(new Wl(20,20),n)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class PA extends la{constructor(e,i){super();const n=this;let r=null,s=1,o=null,c="local-floor",h=1,d=null,p=null,v=null,g=null,_=null,S=null;const E=new MA,M=i.getContextAttributes();let R=null,N=null;const b=[],m=[],w=new $t;let T=null;const P=new rr;P.viewport=new ji;const L=new rr;L.viewport=new ji;const k=[P,L],I=new $C;let z=null,K=null;this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(Me){let ze=b[Me];return ze===void 0&&(ze=new Zd,b[Me]=ze),ze.getTargetRaySpace()},this.getControllerGrip=function(Me){let ze=b[Me];return ze===void 0&&(ze=new Zd,b[Me]=ze),ze.getGripSpace()},this.getHand=function(Me){let ze=b[Me];return ze===void 0&&(ze=new Zd,b[Me]=ze),ze.getHandSpace()};function $(Me){const ze=m.indexOf(Me.inputSource);if(ze===-1)return;const ht=b[ze];ht!==void 0&&(ht.update(Me.inputSource,Me.frame,d||o),ht.dispatchEvent({type:Me.type,data:Me.inputSource}))}function te(){r.removeEventListener("select",$),r.removeEventListener("selectstart",$),r.removeEventListener("selectend",$),r.removeEventListener("squeeze",$),r.removeEventListener("squeezestart",$),r.removeEventListener("squeezeend",$),r.removeEventListener("end",te),r.removeEventListener("inputsourceschange",ee);for(let Me=0;Me<b.length;Me++){const ze=m[Me];ze!==null&&(m[Me]=null,b[Me].disconnect(ze))}z=null,K=null,E.reset(),e.setRenderTarget(R),_=null,g=null,v=null,r=null,N=null,Ve.stop(),n.isPresenting=!1,e.setPixelRatio(T),e.setSize(w.width,w.height,!1),n.dispatchEvent({type:"sessionend"})}this.setFramebufferScaleFactor=function(Me){s=Me,n.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(Me){c=Me,n.isPresenting===!0&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return d||o},this.setReferenceSpace=function(Me){d=Me},this.getBaseLayer=function(){return g!==null?g:_},this.getBinding=function(){return v},this.getFrame=function(){return S},this.getSession=function(){return r},this.setSession=async function(Me){if(r=Me,r!==null){if(R=e.getRenderTarget(),r.addEventListener("select",$),r.addEventListener("selectstart",$),r.addEventListener("selectend",$),r.addEventListener("squeeze",$),r.addEventListener("squeezestart",$),r.addEventListener("squeezeend",$),r.addEventListener("end",te),r.addEventListener("inputsourceschange",ee),M.xrCompatible!==!0&&await i.makeXRCompatible(),T=e.getPixelRatio(),e.getSize(w),typeof XRWebGLBinding<"u"&&"createProjectionLayer"in XRWebGLBinding.prototype){let ht=null,nt=null,rt=null;M.depth&&(rt=M.stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24,ht=M.stencil?Ko:Wo,nt=M.stencil?qo:ra);const jt={colorFormat:i.RGBA8,depthFormat:rt,scaleFactor:s};v=new XRWebGLBinding(r,i),g=v.createProjectionLayer(jt),r.updateRenderState({layers:[g]}),e.setPixelRatio(1),e.setSize(g.textureWidth,g.textureHeight,!1),N=new aa(g.textureWidth,g.textureHeight,{format:Sr,type:ss,depthTexture:new Bv(g.textureWidth,g.textureHeight,nt,void 0,void 0,void 0,void 0,void 0,void 0,ht),stencilBuffer:M.stencil,colorSpace:e.outputColorSpace,samples:M.antialias?4:0,resolveDepthBuffer:g.ignoreDepthValues===!1,resolveStencilBuffer:g.ignoreDepthValues===!1})}else{const ht={antialias:M.antialias,alpha:!0,depth:M.depth,stencil:M.stencil,framebufferScaleFactor:s};_=new XRWebGLLayer(r,i,ht),r.updateRenderState({baseLayer:_}),e.setPixelRatio(1),e.setSize(_.framebufferWidth,_.framebufferHeight,!1),N=new aa(_.framebufferWidth,_.framebufferHeight,{format:Sr,type:ss,colorSpace:e.outputColorSpace,stencilBuffer:M.stencil,resolveDepthBuffer:_.ignoreDepthValues===!1,resolveStencilBuffer:_.ignoreDepthValues===!1})}N.isXRRenderTarget=!0,this.setFoveation(h),d=null,o=await r.requestReferenceSpace(c),Ve.setContext(r),Ve.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(r!==null)return r.environmentBlendMode},this.getDepthTexture=function(){return E.getDepthTexture()};function ee(Me){for(let ze=0;ze<Me.removed.length;ze++){const ht=Me.removed[ze],nt=m.indexOf(ht);nt>=0&&(m[nt]=null,b[nt].disconnect(ht))}for(let ze=0;ze<Me.added.length;ze++){const ht=Me.added[ze];let nt=m.indexOf(ht);if(nt===-1){for(let jt=0;jt<b.length;jt++)if(jt>=m.length){m.push(ht),nt=jt;break}else if(m[jt]===null){m[jt]=ht,nt=jt;break}if(nt===-1)break}const rt=b[nt];rt&&rt.connect(ht)}}const de=new Ae,X=new Ae;function le(Me,ze,ht){de.setFromMatrixPosition(ze.matrixWorld),X.setFromMatrixPosition(ht.matrixWorld);const nt=de.distanceTo(X),rt=ze.projectionMatrix.elements,jt=ht.projectionMatrix.elements,Ct=rt[14]/(rt[10]-1),li=rt[14]/(rt[10]+1),di=(rt[9]+1)/rt[5],zt=(rt[9]-1)/rt[5],he=(rt[8]-1)/rt[0],mi=(jt[8]+1)/jt[0],ti=Ct*he,si=Ct*mi,yt=nt/(-he+mi),Xt=yt*-he;if(ze.matrixWorld.decompose(Me.position,Me.quaternion,Me.scale),Me.translateX(Xt),Me.translateZ(yt),Me.matrixWorld.compose(Me.position,Me.quaternion,Me.scale),Me.matrixWorldInverse.copy(Me.matrixWorld).invert(),rt[10]===-1)Me.projectionMatrix.copy(ze.projectionMatrix),Me.projectionMatrixInverse.copy(ze.projectionMatrixInverse);else{const Rt=Ct+yt,Ut=li+yt,Ii=ti-Xt,ue=si+(nt-Xt),ie=di*li/Ut*Rt,Re=zt*li/Ut*Rt;Me.projectionMatrix.makePerspective(Ii,ue,ie,Re,Rt,Ut),Me.projectionMatrixInverse.copy(Me.projectionMatrix).invert()}}function _e(Me,ze){ze===null?Me.matrixWorld.copy(Me.matrix):Me.matrixWorld.multiplyMatrices(ze.matrixWorld,Me.matrix),Me.matrixWorldInverse.copy(Me.matrixWorld).invert()}this.updateCamera=function(Me){if(r===null)return;let ze=Me.near,ht=Me.far;E.texture!==null&&(E.depthNear>0&&(ze=E.depthNear),E.depthFar>0&&(ht=E.depthFar)),I.near=L.near=P.near=ze,I.far=L.far=P.far=ht,(z!==I.near||K!==I.far)&&(r.updateRenderState({depthNear:I.near,depthFar:I.far}),z=I.near,K=I.far),P.layers.mask=Me.layers.mask|2,L.layers.mask=Me.layers.mask|4,I.layers.mask=P.layers.mask|L.layers.mask;const nt=Me.parent,rt=I.cameras;_e(I,nt);for(let jt=0;jt<rt.length;jt++)_e(rt[jt],nt);rt.length===2?le(I,P,L):I.projectionMatrix.copy(P.projectionMatrix),Se(Me,I,nt)};function Se(Me,ze,ht){ht===null?Me.matrix.copy(ze.matrixWorld):(Me.matrix.copy(ht.matrixWorld),Me.matrix.invert(),Me.matrix.multiply(ze.matrixWorld)),Me.matrix.decompose(Me.position,Me.quaternion,Me.scale),Me.updateMatrixWorld(!0),Me.projectionMatrix.copy(ze.projectionMatrix),Me.projectionMatrixInverse.copy(ze.projectionMatrixInverse),Me.isPerspectiveCamera&&(Me.fov=hh*2*Math.atan(1/Me.projectionMatrix.elements[5]),Me.zoom=1)}this.getCamera=function(){return I},this.getFoveation=function(){if(!(g===null&&_===null))return h},this.setFoveation=function(Me){h=Me,g!==null&&(g.fixedFoveation=Me),_!==null&&_.fixedFoveation!==void 0&&(_.fixedFoveation=Me)},this.hasDepthSensing=function(){return E.texture!==null},this.getDepthSensingMesh=function(){return E.getMesh(I)};let De=null;function We(Me,ze){if(p=ze.getViewerPose(d||o),S=ze,p!==null){const ht=p.views;_!==null&&(e.setRenderTargetFramebuffer(N,_.framebuffer),e.setRenderTarget(N));let nt=!1;ht.length!==I.cameras.length&&(I.cameras.length=0,nt=!0);for(let Ct=0;Ct<ht.length;Ct++){const li=ht[Ct];let di=null;if(_!==null)di=_.getViewport(li);else{const he=v.getViewSubImage(g,li);di=he.viewport,Ct===0&&(e.setRenderTargetTextures(N,he.colorTexture,he.depthStencilTexture),e.setRenderTarget(N))}let zt=k[Ct];zt===void 0&&(zt=new rr,zt.layers.enable(Ct),zt.viewport=new ji,k[Ct]=zt),zt.matrix.fromArray(li.transform.matrix),zt.matrix.decompose(zt.position,zt.quaternion,zt.scale),zt.projectionMatrix.fromArray(li.projectionMatrix),zt.projectionMatrixInverse.copy(zt.projectionMatrix).invert(),zt.viewport.set(di.x,di.y,di.width,di.height),Ct===0&&(I.matrix.copy(zt.matrix),I.matrix.decompose(I.position,I.quaternion,I.scale)),nt===!0&&I.cameras.push(zt)}const rt=r.enabledFeatures;if(rt&&rt.includes("depth-sensing")&&r.depthUsage=="gpu-optimized"&&v){const Ct=v.getDepthInformation(ht[0]);Ct&&Ct.isValid&&Ct.texture&&E.init(e,Ct,r.renderState)}}for(let ht=0;ht<b.length;ht++){const nt=m[ht],rt=b[ht];nt!==null&&rt!==void 0&&rt.update(nt,ze,d||o)}De&&De(Me,ze),ze.detectedPlanes&&n.dispatchEvent({type:"planesdetected",data:ze}),S=null}const Ve=new Hv;Ve.setAnimationLoop(We),this.setAnimationLoop=function(Me){De=Me},this.dispose=function(){}}}const zs=new as,AA=new Wi;function DA(t,e){function i(M,R){M.matrixAutoUpdate===!0&&M.updateMatrix(),R.value.copy(M.matrix)}function n(M,R){R.color.getRGB(M.fogColor.value,Lv(t)),R.isFog?(M.fogNear.value=R.near,M.fogFar.value=R.far):R.isFogExp2&&(M.fogDensity.value=R.density)}function r(M,R,N,b,m){R.isMeshBasicMaterial||R.isMeshLambertMaterial?s(M,R):R.isMeshToonMaterial?(s(M,R),v(M,R)):R.isMeshPhongMaterial?(s(M,R),p(M,R)):R.isMeshStandardMaterial?(s(M,R),g(M,R),R.isMeshPhysicalMaterial&&_(M,R,m)):R.isMeshMatcapMaterial?(s(M,R),S(M,R)):R.isMeshDepthMaterial?s(M,R):R.isMeshDistanceMaterial?(s(M,R),E(M,R)):R.isMeshNormalMaterial?s(M,R):R.isLineBasicMaterial?(o(M,R),R.isLineDashedMaterial&&c(M,R)):R.isPointsMaterial?h(M,R,N,b):R.isSpriteMaterial?d(M,R):R.isShadowMaterial?(M.color.value.copy(R.color),M.opacity.value=R.opacity):R.isShaderMaterial&&(R.uniformsNeedUpdate=!1)}function s(M,R){M.opacity.value=R.opacity,R.color&&M.diffuse.value.copy(R.color),R.emissive&&M.emissive.value.copy(R.emissive).multiplyScalar(R.emissiveIntensity),R.map&&(M.map.value=R.map,i(R.map,M.mapTransform)),R.alphaMap&&(M.alphaMap.value=R.alphaMap,i(R.alphaMap,M.alphaMapTransform)),R.bumpMap&&(M.bumpMap.value=R.bumpMap,i(R.bumpMap,M.bumpMapTransform),M.bumpScale.value=R.bumpScale,R.side===Un&&(M.bumpScale.value*=-1)),R.normalMap&&(M.normalMap.value=R.normalMap,i(R.normalMap,M.normalMapTransform),M.normalScale.value.copy(R.normalScale),R.side===Un&&M.normalScale.value.negate()),R.displacementMap&&(M.displacementMap.value=R.displacementMap,i(R.displacementMap,M.displacementMapTransform),M.displacementScale.value=R.displacementScale,M.displacementBias.value=R.displacementBias),R.emissiveMap&&(M.emissiveMap.value=R.emissiveMap,i(R.emissiveMap,M.emissiveMapTransform)),R.specularMap&&(M.specularMap.value=R.specularMap,i(R.specularMap,M.specularMapTransform)),R.alphaTest>0&&(M.alphaTest.value=R.alphaTest);const N=e.get(R),b=N.envMap,m=N.envMapRotation;b&&(M.envMap.value=b,zs.copy(m),zs.x*=-1,zs.y*=-1,zs.z*=-1,b.isCubeTexture&&b.isRenderTargetTexture===!1&&(zs.y*=-1,zs.z*=-1),M.envMapRotation.value.setFromMatrix4(AA.makeRotationFromEuler(zs)),M.flipEnvMap.value=b.isCubeTexture&&b.isRenderTargetTexture===!1?-1:1,M.reflectivity.value=R.reflectivity,M.ior.value=R.ior,M.refractionRatio.value=R.refractionRatio),R.lightMap&&(M.lightMap.value=R.lightMap,M.lightMapIntensity.value=R.lightMapIntensity,i(R.lightMap,M.lightMapTransform)),R.aoMap&&(M.aoMap.value=R.aoMap,M.aoMapIntensity.value=R.aoMapIntensity,i(R.aoMap,M.aoMapTransform))}function o(M,R){M.diffuse.value.copy(R.color),M.opacity.value=R.opacity,R.map&&(M.map.value=R.map,i(R.map,M.mapTransform))}function c(M,R){M.dashSize.value=R.dashSize,M.totalSize.value=R.dashSize+R.gapSize,M.scale.value=R.scale}function h(M,R,N,b){M.diffuse.value.copy(R.color),M.opacity.value=R.opacity,M.size.value=R.size*N,M.scale.value=b*.5,R.map&&(M.map.value=R.map,i(R.map,M.uvTransform)),R.alphaMap&&(M.alphaMap.value=R.alphaMap,i(R.alphaMap,M.alphaMapTransform)),R.alphaTest>0&&(M.alphaTest.value=R.alphaTest)}function d(M,R){M.diffuse.value.copy(R.color),M.opacity.value=R.opacity,M.rotation.value=R.rotation,R.map&&(M.map.value=R.map,i(R.map,M.mapTransform)),R.alphaMap&&(M.alphaMap.value=R.alphaMap,i(R.alphaMap,M.alphaMapTransform)),R.alphaTest>0&&(M.alphaTest.value=R.alphaTest)}function p(M,R){M.specular.value.copy(R.specular),M.shininess.value=Math.max(R.shininess,1e-4)}function v(M,R){R.gradientMap&&(M.gradientMap.value=R.gradientMap)}function g(M,R){M.metalness.value=R.metalness,R.metalnessMap&&(M.metalnessMap.value=R.metalnessMap,i(R.metalnessMap,M.metalnessMapTransform)),M.roughness.value=R.roughness,R.roughnessMap&&(M.roughnessMap.value=R.roughnessMap,i(R.roughnessMap,M.roughnessMapTransform)),R.envMap&&(M.envMapIntensity.value=R.envMapIntensity)}function _(M,R,N){M.ior.value=R.ior,R.sheen>0&&(M.sheenColor.value.copy(R.sheenColor).multiplyScalar(R.sheen),M.sheenRoughness.value=R.sheenRoughness,R.sheenColorMap&&(M.sheenColorMap.value=R.sheenColorMap,i(R.sheenColorMap,M.sheenColorMapTransform)),R.sheenRoughnessMap&&(M.sheenRoughnessMap.value=R.sheenRoughnessMap,i(R.sheenRoughnessMap,M.sheenRoughnessMapTransform))),R.clearcoat>0&&(M.clearcoat.value=R.clearcoat,M.clearcoatRoughness.value=R.clearcoatRoughness,R.clearcoatMap&&(M.clearcoatMap.value=R.clearcoatMap,i(R.clearcoatMap,M.clearcoatMapTransform)),R.clearcoatRoughnessMap&&(M.clearcoatRoughnessMap.value=R.clearcoatRoughnessMap,i(R.clearcoatRoughnessMap,M.clearcoatRoughnessMapTransform)),R.clearcoatNormalMap&&(M.clearcoatNormalMap.value=R.clearcoatNormalMap,i(R.clearcoatNormalMap,M.clearcoatNormalMapTransform),M.clearcoatNormalScale.value.copy(R.clearcoatNormalScale),R.side===Un&&M.clearcoatNormalScale.value.negate())),R.dispersion>0&&(M.dispersion.value=R.dispersion),R.iridescence>0&&(M.iridescence.value=R.iridescence,M.iridescenceIOR.value=R.iridescenceIOR,M.iridescenceThicknessMinimum.value=R.iridescenceThicknessRange[0],M.iridescenceThicknessMaximum.value=R.iridescenceThicknessRange[1],R.iridescenceMap&&(M.iridescenceMap.value=R.iridescenceMap,i(R.iridescenceMap,M.iridescenceMapTransform)),R.iridescenceThicknessMap&&(M.iridescenceThicknessMap.value=R.iridescenceThicknessMap,i(R.iridescenceThicknessMap,M.iridescenceThicknessMapTransform))),R.transmission>0&&(M.transmission.value=R.transmission,M.transmissionSamplerMap.value=N.texture,M.transmissionSamplerSize.value.set(N.width,N.height),R.transmissionMap&&(M.transmissionMap.value=R.transmissionMap,i(R.transmissionMap,M.transmissionMapTransform)),M.thickness.value=R.thickness,R.thicknessMap&&(M.thicknessMap.value=R.thicknessMap,i(R.thicknessMap,M.thicknessMapTransform)),M.attenuationDistance.value=R.attenuationDistance,M.attenuationColor.value.copy(R.attenuationColor)),R.anisotropy>0&&(M.anisotropyVector.value.set(R.anisotropy*Math.cos(R.anisotropyRotation),R.anisotropy*Math.sin(R.anisotropyRotation)),R.anisotropyMap&&(M.anisotropyMap.value=R.anisotropyMap,i(R.anisotropyMap,M.anisotropyMapTransform))),M.specularIntensity.value=R.specularIntensity,M.specularColor.value.copy(R.specularColor),R.specularColorMap&&(M.specularColorMap.value=R.specularColorMap,i(R.specularColorMap,M.specularColorMapTransform)),R.specularIntensityMap&&(M.specularIntensityMap.value=R.specularIntensityMap,i(R.specularIntensityMap,M.specularIntensityMapTransform))}function S(M,R){R.matcap&&(M.matcap.value=R.matcap)}function E(M,R){const N=e.get(R).light;M.referencePosition.value.setFromMatrixPosition(N.matrixWorld),M.nearDistance.value=N.shadow.camera.near,M.farDistance.value=N.shadow.camera.far}return{refreshFogUniforms:n,refreshMaterialUniforms:r}}function IA(t,e,i,n){let r={},s={},o=[];const c=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS);function h(N,b){const m=b.program;n.uniformBlockBinding(N,m)}function d(N,b){let m=r[N.id];m===void 0&&(S(N),m=p(N),r[N.id]=m,N.addEventListener("dispose",M));const w=b.program;n.updateUBOMapping(N,w);const T=e.render.frame;s[N.id]!==T&&(g(N),s[N.id]=T)}function p(N){const b=v();N.__bindingPointIndex=b;const m=t.createBuffer(),w=N.__size,T=N.usage;return t.bindBuffer(t.UNIFORM_BUFFER,m),t.bufferData(t.UNIFORM_BUFFER,w,T),t.bindBuffer(t.UNIFORM_BUFFER,null),t.bindBufferBase(t.UNIFORM_BUFFER,b,m),m}function v(){for(let N=0;N<c;N++)if(o.indexOf(N)===-1)return o.push(N),N;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}function g(N){const b=r[N.id],m=N.uniforms,w=N.__cache;t.bindBuffer(t.UNIFORM_BUFFER,b);for(let T=0,P=m.length;T<P;T++){const L=Array.isArray(m[T])?m[T]:[m[T]];for(let k=0,I=L.length;k<I;k++){const z=L[k];if(_(z,T,k,w)===!0){const K=z.__offset,$=Array.isArray(z.value)?z.value:[z.value];let te=0;for(let ee=0;ee<$.length;ee++){const de=$[ee],X=E(de);typeof de=="number"||typeof de=="boolean"?(z.__data[0]=de,t.bufferSubData(t.UNIFORM_BUFFER,K+te,z.__data)):de.isMatrix3?(z.__data[0]=de.elements[0],z.__data[1]=de.elements[1],z.__data[2]=de.elements[2],z.__data[3]=0,z.__data[4]=de.elements[3],z.__data[5]=de.elements[4],z.__data[6]=de.elements[5],z.__data[7]=0,z.__data[8]=de.elements[6],z.__data[9]=de.elements[7],z.__data[10]=de.elements[8],z.__data[11]=0):(de.toArray(z.__data,te),te+=X.storage/Float32Array.BYTES_PER_ELEMENT)}t.bufferSubData(t.UNIFORM_BUFFER,K,z.__data)}}}t.bindBuffer(t.UNIFORM_BUFFER,null)}function _(N,b,m,w){const T=N.value,P=b+"_"+m;if(w[P]===void 0)return typeof T=="number"||typeof T=="boolean"?w[P]=T:w[P]=T.clone(),!0;{const L=w[P];if(typeof T=="number"||typeof T=="boolean"){if(L!==T)return w[P]=T,!0}else if(L.equals(T)===!1)return L.copy(T),!0}return!1}function S(N){const b=N.uniforms;let m=0;const w=16;for(let P=0,L=b.length;P<L;P++){const k=Array.isArray(b[P])?b[P]:[b[P]];for(let I=0,z=k.length;I<z;I++){const K=k[I],$=Array.isArray(K.value)?K.value:[K.value];for(let te=0,ee=$.length;te<ee;te++){const de=$[te],X=E(de),le=m%w,_e=le%X.boundary,Se=le+_e;m+=_e,Se!==0&&w-Se<X.storage&&(m+=w-Se),K.__data=new Float32Array(X.storage/Float32Array.BYTES_PER_ELEMENT),K.__offset=m,m+=X.storage}}}const T=m%w;return T>0&&(m+=w-T),N.__size=m,N.__cache={},this}function E(N){const b={boundary:0,storage:0};return typeof N=="number"||typeof N=="boolean"?(b.boundary=4,b.storage=4):N.isVector2?(b.boundary=8,b.storage=8):N.isVector3||N.isColor?(b.boundary=16,b.storage=12):N.isVector4?(b.boundary=16,b.storage=16):N.isMatrix3?(b.boundary=48,b.storage=48):N.isMatrix4?(b.boundary=64,b.storage=64):N.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",N),b}function M(N){const b=N.target;b.removeEventListener("dispose",M);const m=o.indexOf(b.__bindingPointIndex);o.splice(m,1),t.deleteBuffer(r[b.id]),delete r[b.id],delete s[b.id]}function R(){for(const N in r)t.deleteBuffer(r[N]);o=[],r={},s={}}return{bind:h,update:d,dispose:R}}class FA{constructor(e={}){const{canvas:i=fC(),context:n=null,depth:r=!0,stencil:s=!1,alpha:o=!1,antialias:c=!1,premultipliedAlpha:h=!0,preserveDrawingBuffer:d=!1,powerPreference:p="default",failIfMajorPerformanceCaveat:v=!1,reverseDepthBuffer:g=!1}=e;this.isWebGLRenderer=!0;let _;if(n!==null){if(typeof WebGLRenderingContext<"u"&&n instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");_=n.getContextAttributes().alpha}else _=o;const S=new Uint32Array(4),E=new Int32Array(4);let M=null,R=null;const N=[],b=[];this.domElement=i,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=xs,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const m=this;let w=!1;this._outputColorSpace=nr;let T=0,P=0,L=null,k=-1,I=null;const z=new ji,K=new ji;let $=null;const te=new Ei(0);let ee=0,de=i.width,X=i.height,le=1,_e=null,Se=null;const De=new ji(0,0,de,X),We=new ji(0,0,de,X);let Ve=!1;const Me=new Uv;let ze=!1,ht=!1;const nt=new Wi,rt=new Wi,jt=new Ae,Ct=new ji,li={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let di=!1;function zt(){return L===null?le:1}let he=n;function mi(se,xe){return i.getContext(se,xe)}try{const se={alpha:!0,depth:r,stencil:s,antialias:c,premultipliedAlpha:h,preserveDrawingBuffer:d,powerPreference:p,failIfMajorPerformanceCaveat:v};if("setAttribute"in i&&i.setAttribute("data-engine",`three.js r${Ih}`),i.addEventListener("webglcontextlost",bt,!1),i.addEventListener("webglcontextrestored",Ze,!1),i.addEventListener("webglcontextcreationerror",Ge,!1),he===null){const xe="webgl2";if(he=mi(xe,se),he===null)throw mi(xe)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(se){throw console.error("THREE.WebGLRenderer: "+se.message),se}let ti,si,yt,Xt,Rt,Ut,Ii,ue,ie,Re,Pe,Oe,Ce,tt,et,ut,Qe,Ie,it,Pt,Mt,st,kt,ve;function ot(){ti=new zM(he),ti.init(),st=new CA(he,ti),si=new OM(he,ti,e,st),yt=new xA(he,ti),si.reverseDepthBuffer&&g&&yt.buffers.depth.setReversed(!0),Xt=new WM(he),Rt=new dA,Ut=new EA(he,ti,yt,Rt,si,st,Xt),Ii=new UM(m),ue=new VM(m),ie=new JC(he),kt=new NM(he,ie),Re=new GM(he,ie,Xt,kt),Pe=new XM(he,Re,ie,Xt),it=new KM(he,si,Ut),ut=new kM(Rt),Oe=new lA(m,Ii,ue,ti,si,kt,ut),Ce=new DA(m,Rt),tt=new hA,et=new _A(ti),Ie=new FM(m,Ii,ue,yt,Pe,_,h),Qe=new SA(m,Pe,si),ve=new IA(he,Xt,si,yt),Pt=new LM(he,ti,Xt),Mt=new qM(he,ti,Xt),Xt.programs=Oe.programs,m.capabilities=si,m.extensions=ti,m.properties=Rt,m.renderLists=tt,m.shadowMap=Qe,m.state=yt,m.info=Xt}ot();const Ke=new PA(m,he);this.xr=Ke,this.getContext=function(){return he},this.getContextAttributes=function(){return he.getContextAttributes()},this.forceContextLoss=function(){const se=ti.get("WEBGL_lose_context");se&&se.loseContext()},this.forceContextRestore=function(){const se=ti.get("WEBGL_lose_context");se&&se.restoreContext()},this.getPixelRatio=function(){return le},this.setPixelRatio=function(se){se!==void 0&&(le=se,this.setSize(de,X,!1))},this.getSize=function(se){return se.set(de,X)},this.setSize=function(se,xe,Ne=!0){if(Ke.isPresenting){console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting.");return}de=se,X=xe,i.width=Math.floor(se*le),i.height=Math.floor(xe*le),Ne===!0&&(i.style.width=se+"px",i.style.height=xe+"px"),this.setViewport(0,0,se,xe)},this.getDrawingBufferSize=function(se){return se.set(de*le,X*le).floor()},this.setDrawingBufferSize=function(se,xe,Ne){de=se,X=xe,le=Ne,i.width=Math.floor(se*Ne),i.height=Math.floor(xe*Ne),this.setViewport(0,0,se,xe)},this.getCurrentViewport=function(se){return se.copy(z)},this.getViewport=function(se){return se.copy(De)},this.setViewport=function(se,xe,Ne,Le){se.isVector4?De.set(se.x,se.y,se.z,se.w):De.set(se,xe,Ne,Le),yt.viewport(z.copy(De).multiplyScalar(le).round())},this.getScissor=function(se){return se.copy(We)},this.setScissor=function(se,xe,Ne,Le){se.isVector4?We.set(se.x,se.y,se.z,se.w):We.set(se,xe,Ne,Le),yt.scissor(K.copy(We).multiplyScalar(le).round())},this.getScissorTest=function(){return Ve},this.setScissorTest=function(se){yt.setScissorTest(Ve=se)},this.setOpaqueSort=function(se){_e=se},this.setTransparentSort=function(se){Se=se},this.getClearColor=function(se){return se.copy(Ie.getClearColor())},this.setClearColor=function(){Ie.setClearColor(...arguments)},this.getClearAlpha=function(){return Ie.getClearAlpha()},this.setClearAlpha=function(){Ie.setClearAlpha(...arguments)},this.clear=function(se=!0,xe=!0,Ne=!0){let Le=0;if(se){let Ee=!1;if(L!==null){const Ye=L.texture.format;Ee=Ye===Bh||Ye===Uh||Ye===kh}if(Ee){const Ye=L.texture.type,dt=Ye===ss||Ye===ra||Ye===Go||Ye===qo||Ye===Nh||Ye===Lh,mt=Ie.getClearColor(),vt=Ie.getClearAlpha(),It=mt.r,Nt=mt.g,Tt=mt.b;dt?(S[0]=It,S[1]=Nt,S[2]=Tt,S[3]=vt,he.clearBufferuiv(he.COLOR,0,S)):(E[0]=It,E[1]=Nt,E[2]=Tt,E[3]=vt,he.clearBufferiv(he.COLOR,0,E))}else Le|=he.COLOR_BUFFER_BIT}xe&&(Le|=he.DEPTH_BUFFER_BIT),Ne&&(Le|=he.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),he.clear(Le)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){i.removeEventListener("webglcontextlost",bt,!1),i.removeEventListener("webglcontextrestored",Ze,!1),i.removeEventListener("webglcontextcreationerror",Ge,!1),Ie.dispose(),tt.dispose(),et.dispose(),Rt.dispose(),Ii.dispose(),ue.dispose(),Pe.dispose(),kt.dispose(),ve.dispose(),Oe.dispose(),Ke.dispose(),Ke.removeEventListener("sessionstart",ic),Ke.removeEventListener("sessionend",nc),zr.stop()};function bt(se){se.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),w=!0}function Ze(){console.log("THREE.WebGLRenderer: Context Restored."),w=!1;const se=Xt.autoReset,xe=Qe.enabled,Ne=Qe.autoUpdate,Le=Qe.needsUpdate,Ee=Qe.type;ot(),Xt.autoReset=se,Qe.enabled=xe,Qe.autoUpdate=Ne,Qe.needsUpdate=Le,Qe.type=Ee}function Ge(se){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",se.statusMessage)}function St(se){const xe=se.target;xe.removeEventListener("dispose",St),Bt(xe)}function Bt(se){Ci(se),Rt.remove(se)}function Ci(se){const xe=Rt.get(se).programs;xe!==void 0&&(xe.forEach(function(Ne){Oe.releaseProgram(Ne)}),se.isShaderMaterial&&Oe.releaseShaderCache(se))}this.renderBufferDirect=function(se,xe,Ne,Le,Ee,Ye){xe===null&&(xe=li);const dt=Ee.isMesh&&Ee.matrixWorld.determinant()<0,mt=Xl(se,xe,Ne,Le,Ee);yt.setMaterial(Le,dt);let vt=Ne.index,It=1;if(Le.wireframe===!0){if(vt=Re.getWireframeAttribute(Ne),vt===void 0)return;It=2}const Nt=Ne.drawRange,Tt=Ne.attributes.position;let Zt=Nt.start*It,hi=(Nt.start+Nt.count)*It;Ye!==null&&(Zt=Math.max(Zt,Ye.start*It),hi=Math.min(hi,(Ye.start+Ye.count)*It)),vt!==null?(Zt=Math.max(Zt,0),hi=Math.min(hi,vt.count)):Tt!=null&&(Zt=Math.max(Zt,0),hi=Math.min(hi,Tt.count));const Mi=hi-Zt;if(Mi<0||Mi===1/0)return;kt.setup(Ee,Le,mt,Ne,vt);let Fi,ii=Pt;if(vt!==null&&(Fi=ie.get(vt),ii=Mt,ii.setIndex(Fi)),Ee.isMesh)Le.wireframe===!0?(yt.setLineWidth(Le.wireframeLinewidth*zt()),ii.setMode(he.LINES)):ii.setMode(he.TRIANGLES);else if(Ee.isLine){let _t=Le.linewidth;_t===void 0&&(_t=1),yt.setLineWidth(_t*zt()),Ee.isLineSegments?ii.setMode(he.LINES):Ee.isLineLoop?ii.setMode(he.LINE_LOOP):ii.setMode(he.LINE_STRIP)}else Ee.isPoints?ii.setMode(he.POINTS):Ee.isSprite&&ii.setMode(he.TRIANGLES);if(Ee.isBatchedMesh)if(Ee._multiDrawInstances!==null)Ba("THREE.WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),ii.renderMultiDrawInstances(Ee._multiDrawStarts,Ee._multiDrawCounts,Ee._multiDrawCount,Ee._multiDrawInstances);else if(ti.get("WEBGL_multi_draw"))ii.renderMultiDraw(Ee._multiDrawStarts,Ee._multiDrawCounts,Ee._multiDrawCount);else{const _t=Ee._multiDrawStarts,$i=Ee._multiDrawCounts,ai=Ee._multiDrawCount,zn=vt?ie.get(vt).bytesPerElement:1,Pr=Rt.get(Le).currentProgram.getUniforms();for(let _n=0;_n<ai;_n++)Pr.setValue(he,"_gl_DrawID",_n),ii.render(_t[_n]/zn,$i[_n])}else if(Ee.isInstancedMesh)ii.renderInstances(Zt,Mi,Ee.count);else if(Ne.isInstancedBufferGeometry){const _t=Ne._maxInstanceCount!==void 0?Ne._maxInstanceCount:1/0,$i=Math.min(Ne.instanceCount,_t);ii.renderInstances(Zt,Mi,$i)}else ii.render(Zt,Mi)};function ui(se,xe,Ne){se.transparent===!0&&se.side===Qr&&se.forceSinglePass===!1?(se.side=Un,se.needsUpdate=!0,ua(se,xe,Ne),se.side=Rs,se.needsUpdate=!0,ua(se,xe,Ne),se.side=Qr):ua(se,xe,Ne)}this.compile=function(se,xe,Ne=null){Ne===null&&(Ne=se),R=et.get(Ne),R.init(xe),b.push(R),Ne.traverseVisible(function(Ee){Ee.isLight&&Ee.layers.test(xe.layers)&&(R.pushLight(Ee),Ee.castShadow&&R.pushShadow(Ee))}),se!==Ne&&se.traverseVisible(function(Ee){Ee.isLight&&Ee.layers.test(xe.layers)&&(R.pushLight(Ee),Ee.castShadow&&R.pushShadow(Ee))}),R.setupLights();const Le=new Set;return se.traverse(function(Ee){if(!(Ee.isMesh||Ee.isPoints||Ee.isLine||Ee.isSprite))return;const Ye=Ee.material;if(Ye)if(Array.isArray(Ye))for(let dt=0;dt<Ye.length;dt++){const mt=Ye[dt];ui(mt,Ne,Ee),Le.add(mt)}else ui(Ye,Ne,Ee),Le.add(Ye)}),R=b.pop(),Le},this.compileAsync=function(se,xe,Ne=null){const Le=this.compile(se,xe,Ne);return new Promise(Ee=>{function Ye(){if(Le.forEach(function(dt){Rt.get(dt).currentProgram.isReady()&&Le.delete(dt)}),Le.size===0){Ee(se);return}setTimeout(Ye,10)}ti.get("KHR_parallel_shader_compile")!==null?Ye():setTimeout(Ye,10)})};let Vn=null;function ar(se){Vn&&Vn(se)}function ic(){zr.stop()}function nc(){zr.start()}const zr=new Hv;zr.setAnimationLoop(ar),typeof self<"u"&&zr.setContext(self),this.setAnimationLoop=function(se){Vn=se,Ke.setAnimationLoop(se),se===null?zr.stop():zr.start()},Ke.addEventListener("sessionstart",ic),Ke.addEventListener("sessionend",nc),this.render=function(se,xe){if(xe!==void 0&&xe.isCamera!==!0){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}if(w===!0)return;if(se.matrixWorldAutoUpdate===!0&&se.updateMatrixWorld(),xe.parent===null&&xe.matrixWorldAutoUpdate===!0&&xe.updateMatrixWorld(),Ke.enabled===!0&&Ke.isPresenting===!0&&(Ke.cameraAutoUpdate===!0&&Ke.updateCamera(xe),xe=Ke.getCamera()),se.isScene===!0&&se.onBeforeRender(m,se,xe,L),R=et.get(se,b.length),R.init(xe),b.push(R),rt.multiplyMatrices(xe.projectionMatrix,xe.matrixWorldInverse),Me.setFromProjectionMatrix(rt),ht=this.localClippingEnabled,ze=ut.init(this.clippingPlanes,ht),M=tt.get(se,N.length),M.init(),N.push(M),Ke.enabled===!0&&Ke.isPresenting===!0){const Ye=m.xr.getDepthSensingMesh();Ye!==null&&ro(Ye,xe,-1/0,m.sortObjects)}ro(se,xe,0,m.sortObjects),M.finish(),m.sortObjects===!0&&M.sort(_e,Se),di=Ke.enabled===!1||Ke.isPresenting===!1||Ke.hasDepthSensing()===!1,di&&Ie.addToRenderList(M,se),this.info.render.frame++,ze===!0&&ut.beginShadows();const Ne=R.state.shadowsArray;Qe.render(Ne,se,xe),ze===!0&&ut.endShadows(),this.info.autoReset===!0&&this.info.reset();const Le=M.opaque,Ee=M.transmissive;if(R.setupLights(),xe.isArrayCamera){const Ye=xe.cameras;if(Ee.length>0)for(let dt=0,mt=Ye.length;dt<mt;dt++){const vt=Ye[dt];sc(Le,Ee,se,vt)}di&&Ie.render(se);for(let dt=0,mt=Ye.length;dt<mt;dt++){const vt=Ye[dt];rc(M,se,vt,vt.viewport)}}else Ee.length>0&&sc(Le,Ee,se,xe),di&&Ie.render(se),rc(M,se,xe);L!==null&&P===0&&(Ut.updateMultisampleRenderTarget(L),Ut.updateRenderTargetMipmap(L)),se.isScene===!0&&se.onAfterRender(m,se,xe),kt.resetDefaultState(),k=-1,I=null,b.pop(),b.length>0?(R=b[b.length-1],ze===!0&&ut.setGlobalState(m.clippingPlanes,R.state.camera)):R=null,N.pop(),N.length>0?M=N[N.length-1]:M=null};function ro(se,xe,Ne,Le){if(se.visible===!1)return;if(se.layers.test(xe.layers)){if(se.isGroup)Ne=se.renderOrder;else if(se.isLOD)se.autoUpdate===!0&&se.update(xe);else if(se.isLight)R.pushLight(se),se.castShadow&&R.pushShadow(se);else if(se.isSprite){if(!se.frustumCulled||Me.intersectsSprite(se)){Le&&Ct.setFromMatrixPosition(se.matrixWorld).applyMatrix4(rt);const dt=Pe.update(se),mt=se.material;mt.visible&&M.push(se,dt,mt,Ne,Ct.z,null)}}else if((se.isMesh||se.isLine||se.isPoints)&&(!se.frustumCulled||Me.intersectsObject(se))){const dt=Pe.update(se),mt=se.material;if(Le&&(se.boundingSphere!==void 0?(se.boundingSphere===null&&se.computeBoundingSphere(),Ct.copy(se.boundingSphere.center)):(dt.boundingSphere===null&&dt.computeBoundingSphere(),Ct.copy(dt.boundingSphere.center)),Ct.applyMatrix4(se.matrixWorld).applyMatrix4(rt)),Array.isArray(mt)){const vt=dt.groups;for(let It=0,Nt=vt.length;It<Nt;It++){const Tt=vt[It],Zt=mt[Tt.materialIndex];Zt&&Zt.visible&&M.push(se,dt,Zt,Ne,Ct.z,Tt)}}else mt.visible&&M.push(se,dt,mt,Ne,Ct.z,null)}}const Ye=se.children;for(let dt=0,mt=Ye.length;dt<mt;dt++)ro(Ye[dt],xe,Ne,Le)}function rc(se,xe,Ne,Le){const Ee=se.opaque,Ye=se.transmissive,dt=se.transparent;R.setupLightsView(Ne),ze===!0&&ut.setGlobalState(m.clippingPlanes,Ne),Le&&yt.viewport(z.copy(Le)),Ee.length>0&&da(Ee,xe,Ne),Ye.length>0&&da(Ye,xe,Ne),dt.length>0&&da(dt,xe,Ne),yt.buffers.depth.setTest(!0),yt.buffers.depth.setMask(!0),yt.buffers.color.setMask(!0),yt.setPolygonOffset(!1)}function sc(se,xe,Ne,Le){if((Ne.isScene===!0?Ne.overrideMaterial:null)!==null)return;R.state.transmissionRenderTarget[Le.id]===void 0&&(R.state.transmissionRenderTarget[Le.id]=new aa(1,1,{generateMipmaps:!0,type:ti.has("EXT_color_buffer_half_float")||ti.has("EXT_color_buffer_float")?Jo:ss,minFilter:Js,samples:4,stencilBuffer:s,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:ci.workingColorSpace}));const Ye=R.state.transmissionRenderTarget[Le.id],dt=Le.viewport||z;Ye.setSize(dt.z*m.transmissionResolutionScale,dt.w*m.transmissionResolutionScale);const mt=m.getRenderTarget();m.setRenderTarget(Ye),m.getClearColor(te),ee=m.getClearAlpha(),ee<1&&m.setClearColor(16777215,.5),m.clear(),di&&Ie.render(Ne);const vt=m.toneMapping;m.toneMapping=xs;const It=Le.viewport;if(Le.viewport!==void 0&&(Le.viewport=void 0),R.setupLightsView(Le),ze===!0&&ut.setGlobalState(m.clippingPlanes,Le),da(se,Ne,Le),Ut.updateMultisampleRenderTarget(Ye),Ut.updateRenderTargetMipmap(Ye),ti.has("WEBGL_multisampled_render_to_texture")===!1){let Nt=!1;for(let Tt=0,Zt=xe.length;Tt<Zt;Tt++){const hi=xe[Tt],Mi=hi.object,Fi=hi.geometry,ii=hi.material,_t=hi.group;if(ii.side===Qr&&Mi.layers.test(Le.layers)){const $i=ii.side;ii.side=Un,ii.needsUpdate=!0,ac(Mi,Ne,Le,Fi,ii,_t),ii.side=$i,ii.needsUpdate=!0,Nt=!0}}Nt===!0&&(Ut.updateMultisampleRenderTarget(Ye),Ut.updateRenderTargetMipmap(Ye))}m.setRenderTarget(mt),m.setClearColor(te,ee),It!==void 0&&(Le.viewport=It),m.toneMapping=vt}function da(se,xe,Ne){const Le=xe.isScene===!0?xe.overrideMaterial:null;for(let Ee=0,Ye=se.length;Ee<Ye;Ee++){const dt=se[Ee],mt=dt.object,vt=dt.geometry,It=dt.group;let Nt=dt.material;Nt.allowOverride===!0&&Le!==null&&(Nt=Le),mt.layers.test(Ne.layers)&&ac(mt,xe,Ne,vt,Nt,It)}}function ac(se,xe,Ne,Le,Ee,Ye){se.onBeforeRender(m,xe,Ne,Le,Ee,Ye),se.modelViewMatrix.multiplyMatrices(Ne.matrixWorldInverse,se.matrixWorld),se.normalMatrix.getNormalMatrix(se.modelViewMatrix),Ee.onBeforeRender(m,xe,Ne,Le,se,Ye),Ee.transparent===!0&&Ee.side===Qr&&Ee.forceSinglePass===!1?(Ee.side=Un,Ee.needsUpdate=!0,m.renderBufferDirect(Ne,xe,Le,Ee,se,Ye),Ee.side=Rs,Ee.needsUpdate=!0,m.renderBufferDirect(Ne,xe,Le,Ee,se,Ye),Ee.side=Qr):m.renderBufferDirect(Ne,xe,Le,Ee,se,Ye),se.onAfterRender(m,xe,Ne,Le,Ee,Ye)}function ua(se,xe,Ne){xe.isScene!==!0&&(xe=li);const Le=Rt.get(se),Ee=R.state.lights,Ye=R.state.shadowsArray,dt=Ee.state.version,mt=Oe.getParameters(se,Ee.state,Ye,xe,Ne),vt=Oe.getProgramCacheKey(mt);let It=Le.programs;Le.environment=se.isMeshStandardMaterial?xe.environment:null,Le.fog=xe.fog,Le.envMap=(se.isMeshStandardMaterial?ue:Ii).get(se.envMap||Le.environment),Le.envMapRotation=Le.environment!==null&&se.envMap===null?xe.environmentRotation:se.envMapRotation,It===void 0&&(se.addEventListener("dispose",St),It=new Map,Le.programs=It);let Nt=It.get(vt);if(Nt!==void 0){if(Le.currentProgram===Nt&&Le.lightsStateVersion===dt)return cc(se,mt),Nt}else mt.uniforms=Oe.getUniforms(se),se.onBeforeCompile(mt,m),Nt=Oe.acquireProgram(mt,vt),It.set(vt,Nt),Le.uniforms=mt.uniforms;const Tt=Le.uniforms;return(!se.isShaderMaterial&&!se.isRawShaderMaterial||se.clipping===!0)&&(Tt.clippingPlanes=ut.uniform),cc(se,mt),Le.needsLights=Zl(se),Le.lightsStateVersion=dt,Le.needsLights&&(Tt.ambientLightColor.value=Ee.state.ambient,Tt.lightProbe.value=Ee.state.probe,Tt.directionalLights.value=Ee.state.directional,Tt.directionalLightShadows.value=Ee.state.directionalShadow,Tt.spotLights.value=Ee.state.spot,Tt.spotLightShadows.value=Ee.state.spotShadow,Tt.rectAreaLights.value=Ee.state.rectArea,Tt.ltc_1.value=Ee.state.rectAreaLTC1,Tt.ltc_2.value=Ee.state.rectAreaLTC2,Tt.pointLights.value=Ee.state.point,Tt.pointLightShadows.value=Ee.state.pointShadow,Tt.hemisphereLights.value=Ee.state.hemi,Tt.directionalShadowMap.value=Ee.state.directionalShadowMap,Tt.directionalShadowMatrix.value=Ee.state.directionalShadowMatrix,Tt.spotShadowMap.value=Ee.state.spotShadowMap,Tt.spotLightMatrix.value=Ee.state.spotLightMatrix,Tt.spotLightMap.value=Ee.state.spotLightMap,Tt.pointShadowMap.value=Ee.state.pointShadowMap,Tt.pointShadowMatrix.value=Ee.state.pointShadowMatrix),Le.currentProgram=Nt,Le.uniformsList=null,Nt}function oc(se){if(se.uniformsList===null){const xe=se.currentProgram.getUniforms();se.uniformsList=cl.seqWithValue(xe.seq,se.uniforms)}return se.uniformsList}function cc(se,xe){const Ne=Rt.get(se);Ne.outputColorSpace=xe.outputColorSpace,Ne.batching=xe.batching,Ne.batchingColor=xe.batchingColor,Ne.instancing=xe.instancing,Ne.instancingColor=xe.instancingColor,Ne.instancingMorph=xe.instancingMorph,Ne.skinning=xe.skinning,Ne.morphTargets=xe.morphTargets,Ne.morphNormals=xe.morphNormals,Ne.morphColors=xe.morphColors,Ne.morphTargetsCount=xe.morphTargetsCount,Ne.numClippingPlanes=xe.numClippingPlanes,Ne.numIntersection=xe.numClipIntersection,Ne.vertexAlphas=xe.vertexAlphas,Ne.vertexTangents=xe.vertexTangents,Ne.toneMapping=xe.toneMapping}function Xl(se,xe,Ne,Le,Ee){xe.isScene!==!0&&(xe=li),Ut.resetTextureUnits();const Ye=xe.fog,dt=Le.isMeshStandardMaterial?xe.environment:null,mt=L===null?m.outputColorSpace:L.isXRRenderTarget===!0?L.texture.colorSpace:Ja,vt=(Le.isMeshStandardMaterial?ue:Ii).get(Le.envMap||dt),It=Le.vertexColors===!0&&!!Ne.attributes.color&&Ne.attributes.color.itemSize===4,Nt=!!Ne.attributes.tangent&&(!!Le.normalMap||Le.anisotropy>0),Tt=!!Ne.morphAttributes.position,Zt=!!Ne.morphAttributes.normal,hi=!!Ne.morphAttributes.color;let Mi=xs;Le.toneMapped&&(L===null||L.isXRRenderTarget===!0)&&(Mi=m.toneMapping);const Fi=Ne.morphAttributes.position||Ne.morphAttributes.normal||Ne.morphAttributes.color,ii=Fi!==void 0?Fi.length:0,_t=Rt.get(Le),$i=R.state.lights;if(ze===!0&&(ht===!0||se!==I)){const _i=se===I&&Le.id===k;ut.setState(Le,se,_i)}let ai=!1;Le.version===_t.__version?(_t.needsLights&&_t.lightsStateVersion!==$i.state.version||_t.outputColorSpace!==mt||Ee.isBatchedMesh&&_t.batching===!1||!Ee.isBatchedMesh&&_t.batching===!0||Ee.isBatchedMesh&&_t.batchingColor===!0&&Ee.colorTexture===null||Ee.isBatchedMesh&&_t.batchingColor===!1&&Ee.colorTexture!==null||Ee.isInstancedMesh&&_t.instancing===!1||!Ee.isInstancedMesh&&_t.instancing===!0||Ee.isSkinnedMesh&&_t.skinning===!1||!Ee.isSkinnedMesh&&_t.skinning===!0||Ee.isInstancedMesh&&_t.instancingColor===!0&&Ee.instanceColor===null||Ee.isInstancedMesh&&_t.instancingColor===!1&&Ee.instanceColor!==null||Ee.isInstancedMesh&&_t.instancingMorph===!0&&Ee.morphTexture===null||Ee.isInstancedMesh&&_t.instancingMorph===!1&&Ee.morphTexture!==null||_t.envMap!==vt||Le.fog===!0&&_t.fog!==Ye||_t.numClippingPlanes!==void 0&&(_t.numClippingPlanes!==ut.numPlanes||_t.numIntersection!==ut.numIntersection)||_t.vertexAlphas!==It||_t.vertexTangents!==Nt||_t.morphTargets!==Tt||_t.morphNormals!==Zt||_t.morphColors!==hi||_t.toneMapping!==Mi||_t.morphTargetsCount!==ii)&&(ai=!0):(ai=!0,_t.__version=Le.version);let zn=_t.currentProgram;ai===!0&&(zn=ua(Le,xe,Ee));let Pr=!1,_n=!1,Is=!1;const Ri=zn.getUniforms(),un=_t.uniforms;if(yt.useProgram(zn.program)&&(Pr=!0,_n=!0,Is=!0),Le.id!==k&&(k=Le.id,_n=!0),Pr||I!==se){yt.buffers.depth.getReversed()?(nt.copy(se.projectionMatrix),gC(nt),vC(nt),Ri.setValue(he,"projectionMatrix",nt)):Ri.setValue(he,"projectionMatrix",se.projectionMatrix),Ri.setValue(he,"viewMatrix",se.matrixWorldInverse);const ri=Ri.map.cameraPosition;ri!==void 0&&ri.setValue(he,jt.setFromMatrixPosition(se.matrixWorld)),si.logarithmicDepthBuffer&&Ri.setValue(he,"logDepthBufFC",2/(Math.log(se.far+1)/Math.LN2)),(Le.isMeshPhongMaterial||Le.isMeshToonMaterial||Le.isMeshLambertMaterial||Le.isMeshBasicMaterial||Le.isMeshStandardMaterial||Le.isShaderMaterial)&&Ri.setValue(he,"isOrthographic",se.isOrthographicCamera===!0),I!==se&&(I=se,_n=!0,Is=!0)}if(Ee.isSkinnedMesh){Ri.setOptional(he,Ee,"bindMatrix"),Ri.setOptional(he,Ee,"bindMatrixInverse");const _i=Ee.skeleton;_i&&(_i.boneTexture===null&&_i.computeBoneTexture(),Ri.setValue(he,"boneTexture",_i.boneTexture,Ut))}Ee.isBatchedMesh&&(Ri.setOptional(he,Ee,"batchingTexture"),Ri.setValue(he,"batchingTexture",Ee._matricesTexture,Ut),Ri.setOptional(he,Ee,"batchingIdTexture"),Ri.setValue(he,"batchingIdTexture",Ee._indirectTexture,Ut),Ri.setOptional(he,Ee,"batchingColorTexture"),Ee._colorsTexture!==null&&Ri.setValue(he,"batchingColorTexture",Ee._colorsTexture,Ut));const sn=Ne.morphAttributes;if((sn.position!==void 0||sn.normal!==void 0||sn.color!==void 0)&&it.update(Ee,Ne,zn),(_n||_t.receiveShadow!==Ee.receiveShadow)&&(_t.receiveShadow=Ee.receiveShadow,Ri.setValue(he,"receiveShadow",Ee.receiveShadow)),Le.isMeshGouraudMaterial&&Le.envMap!==null&&(un.envMap.value=vt,un.flipEnvMap.value=vt.isCubeTexture&&vt.isRenderTargetTexture===!1?-1:1),Le.isMeshStandardMaterial&&Le.envMap===null&&xe.environment!==null&&(un.envMapIntensity.value=xe.environmentIntensity),_n&&(Ri.setValue(he,"toneMappingExposure",m.toneMappingExposure),_t.needsLights&&$l(un,Is),Ye&&Le.fog===!0&&Ce.refreshFogUniforms(un,Ye),Ce.refreshMaterialUniforms(un,Le,le,X,R.state.transmissionRenderTarget[se.id]),cl.upload(he,oc(_t),un,Ut)),Le.isShaderMaterial&&Le.uniformsNeedUpdate===!0&&(cl.upload(he,oc(_t),un,Ut),Le.uniformsNeedUpdate=!1),Le.isSpriteMaterial&&Ri.setValue(he,"center",Ee.center),Ri.setValue(he,"modelViewMatrix",Ee.modelViewMatrix),Ri.setValue(he,"normalMatrix",Ee.normalMatrix),Ri.setValue(he,"modelMatrix",Ee.matrixWorld),Le.isShaderMaterial||Le.isRawShaderMaterial){const _i=Le.uniformsGroups;for(let ri=0,so=_i.length;ri<so;ri++){const or=_i[ri];ve.update(or,zn),ve.bind(or,zn)}}return zn}function $l(se,xe){se.ambientLightColor.needsUpdate=xe,se.lightProbe.needsUpdate=xe,se.directionalLights.needsUpdate=xe,se.directionalLightShadows.needsUpdate=xe,se.pointLights.needsUpdate=xe,se.pointLightShadows.needsUpdate=xe,se.spotLights.needsUpdate=xe,se.spotLightShadows.needsUpdate=xe,se.rectAreaLights.needsUpdate=xe,se.hemisphereLights.needsUpdate=xe}function Zl(se){return se.isMeshLambertMaterial||se.isMeshToonMaterial||se.isMeshPhongMaterial||se.isMeshStandardMaterial||se.isShadowMaterial||se.isShaderMaterial&&se.lights===!0}this.getActiveCubeFace=function(){return T},this.getActiveMipmapLevel=function(){return P},this.getRenderTarget=function(){return L},this.setRenderTargetTextures=function(se,xe,Ne){const Le=Rt.get(se);Le.__autoAllocateDepthBuffer=se.resolveDepthBuffer===!1,Le.__autoAllocateDepthBuffer===!1&&(Le.__useRenderToTexture=!1),Rt.get(se.texture).__webglTexture=xe,Rt.get(se.depthTexture).__webglTexture=Le.__autoAllocateDepthBuffer?void 0:Ne,Le.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(se,xe){const Ne=Rt.get(se);Ne.__webglFramebuffer=xe,Ne.__useDefaultFramebuffer=xe===void 0};const Yl=he.createFramebuffer();this.setRenderTarget=function(se,xe=0,Ne=0){L=se,T=xe,P=Ne;let Le=!0,Ee=null,Ye=!1,dt=!1;if(se){const vt=Rt.get(se);if(vt.__useDefaultFramebuffer!==void 0)yt.bindFramebuffer(he.FRAMEBUFFER,null),Le=!1;else if(vt.__webglFramebuffer===void 0)Ut.setupRenderTarget(se);else if(vt.__hasExternalTextures)Ut.rebindTextures(se,Rt.get(se.texture).__webglTexture,Rt.get(se.depthTexture).__webglTexture);else if(se.depthBuffer){const Tt=se.depthTexture;if(vt.__boundDepthTexture!==Tt){if(Tt!==null&&Rt.has(Tt)&&(se.width!==Tt.image.width||se.height!==Tt.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");Ut.setupDepthRenderbuffer(se)}}const It=se.texture;(It.isData3DTexture||It.isDataArrayTexture||It.isCompressedArrayTexture)&&(dt=!0);const Nt=Rt.get(se).__webglFramebuffer;se.isWebGLCubeRenderTarget?(Array.isArray(Nt[xe])?Ee=Nt[xe][Ne]:Ee=Nt[xe],Ye=!0):se.samples>0&&Ut.useMultisampledRTT(se)===!1?Ee=Rt.get(se).__webglMultisampledFramebuffer:Array.isArray(Nt)?Ee=Nt[Ne]:Ee=Nt,z.copy(se.viewport),K.copy(se.scissor),$=se.scissorTest}else z.copy(De).multiplyScalar(le).floor(),K.copy(We).multiplyScalar(le).floor(),$=Ve;if(Ne!==0&&(Ee=Yl),yt.bindFramebuffer(he.FRAMEBUFFER,Ee)&&Le&&yt.drawBuffers(se,Ee),yt.viewport(z),yt.scissor(K),yt.setScissorTest($),Ye){const vt=Rt.get(se.texture);he.framebufferTexture2D(he.FRAMEBUFFER,he.COLOR_ATTACHMENT0,he.TEXTURE_CUBE_MAP_POSITIVE_X+xe,vt.__webglTexture,Ne)}else if(dt){const vt=Rt.get(se.texture),It=xe;he.framebufferTextureLayer(he.FRAMEBUFFER,he.COLOR_ATTACHMENT0,vt.__webglTexture,Ne,It)}else if(se!==null&&Ne!==0){const vt=Rt.get(se.texture);he.framebufferTexture2D(he.FRAMEBUFFER,he.COLOR_ATTACHMENT0,he.TEXTURE_2D,vt.__webglTexture,Ne)}k=-1},this.readRenderTargetPixels=function(se,xe,Ne,Le,Ee,Ye,dt,mt=0){if(!(se&&se.isWebGLRenderTarget)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");return}let vt=Rt.get(se).__webglFramebuffer;if(se.isWebGLCubeRenderTarget&&dt!==void 0&&(vt=vt[dt]),vt){yt.bindFramebuffer(he.FRAMEBUFFER,vt);try{const It=se.textures[mt],Nt=It.format,Tt=It.type;if(!si.textureFormatReadable(Nt)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");return}if(!si.textureTypeReadable(Tt)){console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");return}xe>=0&&xe<=se.width-Le&&Ne>=0&&Ne<=se.height-Ee&&(se.textures.length>1&&he.readBuffer(he.COLOR_ATTACHMENT0+mt),he.readPixels(xe,Ne,Le,Ee,st.convert(Nt),st.convert(Tt),Ye))}finally{const It=L!==null?Rt.get(L).__webglFramebuffer:null;yt.bindFramebuffer(he.FRAMEBUFFER,It)}}},this.readRenderTargetPixelsAsync=async function(se,xe,Ne,Le,Ee,Ye,dt,mt=0){if(!(se&&se.isWebGLRenderTarget))throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let vt=Rt.get(se).__webglFramebuffer;if(se.isWebGLCubeRenderTarget&&dt!==void 0&&(vt=vt[dt]),vt)if(xe>=0&&xe<=se.width-Le&&Ne>=0&&Ne<=se.height-Ee){yt.bindFramebuffer(he.FRAMEBUFFER,vt);const It=se.textures[mt],Nt=It.format,Tt=It.type;if(!si.textureFormatReadable(Nt))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!si.textureTypeReadable(Tt))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");const Zt=he.createBuffer();he.bindBuffer(he.PIXEL_PACK_BUFFER,Zt),he.bufferData(he.PIXEL_PACK_BUFFER,Ye.byteLength,he.STREAM_READ),se.textures.length>1&&he.readBuffer(he.COLOR_ATTACHMENT0+mt),he.readPixels(xe,Ne,Le,Ee,st.convert(Nt),st.convert(Tt),0);const hi=L!==null?Rt.get(L).__webglFramebuffer:null;yt.bindFramebuffer(he.FRAMEBUFFER,hi);const Mi=he.fenceSync(he.SYNC_GPU_COMMANDS_COMPLETE,0);return he.flush(),await mC(he,Mi,4),he.bindBuffer(he.PIXEL_PACK_BUFFER,Zt),he.getBufferSubData(he.PIXEL_PACK_BUFFER,0,Ye),he.deleteBuffer(Zt),he.deleteSync(Mi),Ye}else throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")},this.copyFramebufferToTexture=function(se,xe=null,Ne=0){const Le=Math.pow(2,-Ne),Ee=Math.floor(se.image.width*Le),Ye=Math.floor(se.image.height*Le),dt=xe!==null?xe.x:0,mt=xe!==null?xe.y:0;Ut.setTexture2D(se,0),he.copyTexSubImage2D(he.TEXTURE_2D,Ne,0,0,dt,mt,Ee,Ye),yt.unbindTexture()};const Jl=he.createFramebuffer(),Ql=he.createFramebuffer();this.copyTextureToTexture=function(se,xe,Ne=null,Le=null,Ee=0,Ye=null){Ye===null&&(Ee!==0?(Ba("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),Ye=Ee,Ee=0):Ye=0);let dt,mt,vt,It,Nt,Tt,Zt,hi,Mi;const Fi=se.isCompressedTexture?se.mipmaps[Ye]:se.image;if(Ne!==null)dt=Ne.max.x-Ne.min.x,mt=Ne.max.y-Ne.min.y,vt=Ne.isBox3?Ne.max.z-Ne.min.z:1,It=Ne.min.x,Nt=Ne.min.y,Tt=Ne.isBox3?Ne.min.z:0;else{const sn=Math.pow(2,-Ee);dt=Math.floor(Fi.width*sn),mt=Math.floor(Fi.height*sn),se.isDataArrayTexture?vt=Fi.depth:se.isData3DTexture?vt=Math.floor(Fi.depth*sn):vt=1,It=0,Nt=0,Tt=0}Le!==null?(Zt=Le.x,hi=Le.y,Mi=Le.z):(Zt=0,hi=0,Mi=0);const ii=st.convert(xe.format),_t=st.convert(xe.type);let $i;xe.isData3DTexture?(Ut.setTexture3D(xe,0),$i=he.TEXTURE_3D):xe.isDataArrayTexture||xe.isCompressedArrayTexture?(Ut.setTexture2DArray(xe,0),$i=he.TEXTURE_2D_ARRAY):(Ut.setTexture2D(xe,0),$i=he.TEXTURE_2D),he.pixelStorei(he.UNPACK_FLIP_Y_WEBGL,xe.flipY),he.pixelStorei(he.UNPACK_PREMULTIPLY_ALPHA_WEBGL,xe.premultiplyAlpha),he.pixelStorei(he.UNPACK_ALIGNMENT,xe.unpackAlignment);const ai=he.getParameter(he.UNPACK_ROW_LENGTH),zn=he.getParameter(he.UNPACK_IMAGE_HEIGHT),Pr=he.getParameter(he.UNPACK_SKIP_PIXELS),_n=he.getParameter(he.UNPACK_SKIP_ROWS),Is=he.getParameter(he.UNPACK_SKIP_IMAGES);he.pixelStorei(he.UNPACK_ROW_LENGTH,Fi.width),he.pixelStorei(he.UNPACK_IMAGE_HEIGHT,Fi.height),he.pixelStorei(he.UNPACK_SKIP_PIXELS,It),he.pixelStorei(he.UNPACK_SKIP_ROWS,Nt),he.pixelStorei(he.UNPACK_SKIP_IMAGES,Tt);const Ri=se.isDataArrayTexture||se.isData3DTexture,un=xe.isDataArrayTexture||xe.isData3DTexture;if(se.isDepthTexture){const sn=Rt.get(se),_i=Rt.get(xe),ri=Rt.get(sn.__renderTarget),so=Rt.get(_i.__renderTarget);yt.bindFramebuffer(he.READ_FRAMEBUFFER,ri.__webglFramebuffer),yt.bindFramebuffer(he.DRAW_FRAMEBUFFER,so.__webglFramebuffer);for(let or=0;or<vt;or++)Ri&&(he.framebufferTextureLayer(he.READ_FRAMEBUFFER,he.COLOR_ATTACHMENT0,Rt.get(se).__webglTexture,Ee,Tt+or),he.framebufferTextureLayer(he.DRAW_FRAMEBUFFER,he.COLOR_ATTACHMENT0,Rt.get(xe).__webglTexture,Ye,Mi+or)),he.blitFramebuffer(It,Nt,dt,mt,Zt,hi,dt,mt,he.DEPTH_BUFFER_BIT,he.NEAREST);yt.bindFramebuffer(he.READ_FRAMEBUFFER,null),yt.bindFramebuffer(he.DRAW_FRAMEBUFFER,null)}else if(Ee!==0||se.isRenderTargetTexture||Rt.has(se)){const sn=Rt.get(se),_i=Rt.get(xe);yt.bindFramebuffer(he.READ_FRAMEBUFFER,Jl),yt.bindFramebuffer(he.DRAW_FRAMEBUFFER,Ql);for(let ri=0;ri<vt;ri++)Ri?he.framebufferTextureLayer(he.READ_FRAMEBUFFER,he.COLOR_ATTACHMENT0,sn.__webglTexture,Ee,Tt+ri):he.framebufferTexture2D(he.READ_FRAMEBUFFER,he.COLOR_ATTACHMENT0,he.TEXTURE_2D,sn.__webglTexture,Ee),un?he.framebufferTextureLayer(he.DRAW_FRAMEBUFFER,he.COLOR_ATTACHMENT0,_i.__webglTexture,Ye,Mi+ri):he.framebufferTexture2D(he.DRAW_FRAMEBUFFER,he.COLOR_ATTACHMENT0,he.TEXTURE_2D,_i.__webglTexture,Ye),Ee!==0?he.blitFramebuffer(It,Nt,dt,mt,Zt,hi,dt,mt,he.COLOR_BUFFER_BIT,he.NEAREST):un?he.copyTexSubImage3D($i,Ye,Zt,hi,Mi+ri,It,Nt,dt,mt):he.copyTexSubImage2D($i,Ye,Zt,hi,It,Nt,dt,mt);yt.bindFramebuffer(he.READ_FRAMEBUFFER,null),yt.bindFramebuffer(he.DRAW_FRAMEBUFFER,null)}else un?se.isDataTexture||se.isData3DTexture?he.texSubImage3D($i,Ye,Zt,hi,Mi,dt,mt,vt,ii,_t,Fi.data):xe.isCompressedArrayTexture?he.compressedTexSubImage3D($i,Ye,Zt,hi,Mi,dt,mt,vt,ii,Fi.data):he.texSubImage3D($i,Ye,Zt,hi,Mi,dt,mt,vt,ii,_t,Fi):se.isDataTexture?he.texSubImage2D(he.TEXTURE_2D,Ye,Zt,hi,dt,mt,ii,_t,Fi.data):se.isCompressedTexture?he.compressedTexSubImage2D(he.TEXTURE_2D,Ye,Zt,hi,Fi.width,Fi.height,ii,Fi.data):he.texSubImage2D(he.TEXTURE_2D,Ye,Zt,hi,dt,mt,ii,_t,Fi);he.pixelStorei(he.UNPACK_ROW_LENGTH,ai),he.pixelStorei(he.UNPACK_IMAGE_HEIGHT,zn),he.pixelStorei(he.UNPACK_SKIP_PIXELS,Pr),he.pixelStorei(he.UNPACK_SKIP_ROWS,_n),he.pixelStorei(he.UNPACK_SKIP_IMAGES,Is),Ye===0&&xe.generateMipmaps&&he.generateMipmap($i),yt.unbindTexture()},this.copyTextureToTexture3D=function(se,xe,Ne=null,Le=null,Ee=0){return Ba('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(se,xe,Ne,Le,Ee)},this.initRenderTarget=function(se){Rt.get(se).__webglFramebuffer===void 0&&Ut.setupRenderTarget(se)},this.initTexture=function(se){se.isCubeTexture?Ut.setTextureCube(se,0):se.isData3DTexture?Ut.setTexture3D(se,0):se.isDataArrayTexture||se.isCompressedArrayTexture?Ut.setTexture2DArray(se,0):Ut.setTexture2D(se,0),yt.unbindTexture()},this.resetState=function(){T=0,P=0,L=null,yt.reset(),kt.reset()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return ts}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const i=this.getContext();i.drawingBufferColorSpace=ci._getDrawingBufferColorSpace(e),i.unpackColorSpace=ci._getUnpackColorSpace()}}const Qf={type:"change"},qh={type:"start"},qv={type:"end"},Kc=new Av,em=new bs,NA=Math.cos(70*pC.DEG2RAD),Ji=new Ae,Nn=2*Math.PI,xi={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},ru=1e-6;class LA extends ZC{constructor(e,i=null){super(e,i),this.state=xi.NONE,this.target=new Ae,this.cursor=new Ae,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:ka.ROTATE,MIDDLE:ka.DOLLY,RIGHT:ka.PAN},this.touches={ONE:Ia.ROTATE,TWO:Ia.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new Ae,this._lastQuaternion=new sa,this._lastTargetPosition=new Ae,this._quat=new sa().setFromUnitVectors(e.up,new Ae(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new Rf,this._sphericalDelta=new Rf,this._scale=1,this._panOffset=new Ae,this._rotateStart=new $t,this._rotateEnd=new $t,this._rotateDelta=new $t,this._panStart=new $t,this._panEnd=new $t,this._panDelta=new $t,this._dollyStart=new $t,this._dollyEnd=new $t,this._dollyDelta=new $t,this._dollyDirection=new Ae,this._mouse=new $t,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=kA.bind(this),this._onPointerDown=OA.bind(this),this._onPointerUp=UA.bind(this),this._onContextMenu=qA.bind(this),this._onMouseWheel=jA.bind(this),this._onKeyDown=VA.bind(this),this._onTouchStart=zA.bind(this),this._onTouchMove=GA.bind(this),this._onMouseDown=BA.bind(this),this._onMouseMove=HA.bind(this),this._interceptControlDown=WA.bind(this),this._interceptControlUp=KA.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(Qf),this.update(),this.state=xi.NONE}update(e=null){const i=this.object.position;Ji.copy(i).sub(this.target),Ji.applyQuaternion(this._quat),this._spherical.setFromVector3(Ji),this.autoRotate&&this.state===xi.NONE&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let n=this.minAzimuthAngle,r=this.maxAzimuthAngle;isFinite(n)&&isFinite(r)&&(n<-Math.PI?n+=Nn:n>Math.PI&&(n-=Nn),r<-Math.PI?r+=Nn:r>Math.PI&&(r-=Nn),n<=r?this._spherical.theta=Math.max(n,Math.min(r,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(n+r)/2?Math.max(n,this._spherical.theta):Math.min(r,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let s=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const o=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),s=o!=this._spherical.radius}if(Ji.setFromSpherical(this._spherical),Ji.applyQuaternion(this._quatInverse),i.copy(this.target).add(Ji),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let o=null;if(this.object.isPerspectiveCamera){const c=Ji.length();o=this._clampDistance(c*this._scale);const h=c-o;this.object.position.addScaledVector(this._dollyDirection,h),this.object.updateMatrixWorld(),s=!!h}else if(this.object.isOrthographicCamera){const c=new Ae(this._mouse.x,this._mouse.y,0);c.unproject(this.object);const h=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),s=h!==this.object.zoom;const d=new Ae(this._mouse.x,this._mouse.y,0);d.unproject(this.object),this.object.position.sub(d).add(c),this.object.updateMatrixWorld(),o=Ji.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;o!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(o).add(this.object.position):(Kc.origin.copy(this.object.position),Kc.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(Kc.direction))<NA?this.object.lookAt(this.target):(em.setFromNormalAndCoplanarPoint(this.object.up,this.target),Kc.intersectPlane(em,this.target))))}else if(this.object.isOrthographicCamera){const o=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),o!==this.object.zoom&&(this.object.updateProjectionMatrix(),s=!0)}return this._scale=1,this._performCursorZoom=!1,s||this._lastPosition.distanceToSquared(this.object.position)>ru||8*(1-this._lastQuaternion.dot(this.object.quaternion))>ru||this._lastTargetPosition.distanceToSquared(this.target)>ru?(this.dispatchEvent(Qf),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(e){return e!==null?Nn/60*this.autoRotateSpeed*e:Nn/60/60*this.autoRotateSpeed}_getZoomScale(e){const i=Math.abs(e*.01);return Math.pow(.95,this.zoomSpeed*i)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,i){Ji.setFromMatrixColumn(i,0),Ji.multiplyScalar(-e),this._panOffset.add(Ji)}_panUp(e,i){this.screenSpacePanning===!0?Ji.setFromMatrixColumn(i,1):(Ji.setFromMatrixColumn(i,0),Ji.crossVectors(this.object.up,Ji)),Ji.multiplyScalar(e),this._panOffset.add(Ji)}_pan(e,i){const n=this.domElement;if(this.object.isPerspectiveCamera){const r=this.object.position;Ji.copy(r).sub(this.target);let s=Ji.length();s*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*s/n.clientHeight,this.object.matrix),this._panUp(2*i*s/n.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/n.clientWidth,this.object.matrix),this._panUp(i*(this.object.top-this.object.bottom)/this.object.zoom/n.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(e,i){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const n=this.domElement.getBoundingClientRect(),r=e-n.left,s=i-n.top,o=n.width,c=n.height;this._mouse.x=r/o*2-1,this._mouse.y=-(s/c)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const i=this.domElement;this._rotateLeft(Nn*this._rotateDelta.x/i.clientHeight),this._rotateUp(Nn*this._rotateDelta.y/i.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let i=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(Nn*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),i=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-Nn*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),i=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(Nn*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),i=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-Nn*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),i=!0;break}i&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(this._pointers.length===1)this._rotateStart.set(e.pageX,e.pageY);else{const i=this._getSecondPointerPosition(e),n=.5*(e.pageX+i.x),r=.5*(e.pageY+i.y);this._rotateStart.set(n,r)}}_handleTouchStartPan(e){if(this._pointers.length===1)this._panStart.set(e.pageX,e.pageY);else{const i=this._getSecondPointerPosition(e),n=.5*(e.pageX+i.x),r=.5*(e.pageY+i.y);this._panStart.set(n,r)}}_handleTouchStartDolly(e){const i=this._getSecondPointerPosition(e),n=e.pageX-i.x,r=e.pageY-i.y,s=Math.sqrt(n*n+r*r);this._dollyStart.set(0,s)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(this._pointers.length==1)this._rotateEnd.set(e.pageX,e.pageY);else{const n=this._getSecondPointerPosition(e),r=.5*(e.pageX+n.x),s=.5*(e.pageY+n.y);this._rotateEnd.set(r,s)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const i=this.domElement;this._rotateLeft(Nn*this._rotateDelta.x/i.clientHeight),this._rotateUp(Nn*this._rotateDelta.y/i.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(this._pointers.length===1)this._panEnd.set(e.pageX,e.pageY);else{const i=this._getSecondPointerPosition(e),n=.5*(e.pageX+i.x),r=.5*(e.pageY+i.y);this._panEnd.set(n,r)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const i=this._getSecondPointerPosition(e),n=e.pageX-i.x,r=e.pageY-i.y,s=Math.sqrt(n*n+r*r);this._dollyEnd.set(0,s),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const o=(e.pageX+i.x)*.5,c=(e.pageY+i.y)*.5;this._updateZoomParameters(o,c)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let i=0;i<this._pointers.length;i++)if(this._pointers[i]==e.pointerId){this._pointers.splice(i,1);return}}_isTrackingPointer(e){for(let i=0;i<this._pointers.length;i++)if(this._pointers[i]==e.pointerId)return!0;return!1}_trackPointer(e){let i=this._pointerPositions[e.pointerId];i===void 0&&(i=new $t,this._pointerPositions[e.pointerId]=i),i.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const i=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[i]}_customWheelEvent(e){const i=e.deltaMode,n={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(i){case 1:n.deltaY*=16;break;case 2:n.deltaY*=100;break}return e.ctrlKey&&!this._controlActive&&(n.deltaY*=10),n}}function OA(t){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(t.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(t)&&(this._addPointer(t),t.pointerType==="touch"?this._onTouchStart(t):this._onMouseDown(t)))}function kA(t){this.enabled!==!1&&(t.pointerType==="touch"?this._onTouchMove(t):this._onMouseMove(t))}function UA(t){switch(this._removePointer(t),this._pointers.length){case 0:this.domElement.releasePointerCapture(t.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(qv),this.state=xi.NONE;break;case 1:const e=this._pointers[0],i=this._pointerPositions[e];this._onTouchStart({pointerId:e,pageX:i.x,pageY:i.y});break}}function BA(t){let e;switch(t.button){case 0:e=this.mouseButtons.LEFT;break;case 1:e=this.mouseButtons.MIDDLE;break;case 2:e=this.mouseButtons.RIGHT;break;default:e=-1}switch(e){case ka.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(t),this.state=xi.DOLLY;break;case ka.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(t),this.state=xi.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(t),this.state=xi.ROTATE}break;case ka.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(t),this.state=xi.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(t),this.state=xi.PAN}break;default:this.state=xi.NONE}this.state!==xi.NONE&&this.dispatchEvent(qh)}function HA(t){switch(this.state){case xi.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(t);break;case xi.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(t);break;case xi.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(t);break}}function jA(t){this.enabled===!1||this.enableZoom===!1||this.state!==xi.NONE||(t.preventDefault(),this.dispatchEvent(qh),this._handleMouseWheel(this._customWheelEvent(t)),this.dispatchEvent(qv))}function VA(t){this.enabled!==!1&&this._handleKeyDown(t)}function zA(t){switch(this._trackPointer(t),this._pointers.length){case 1:switch(this.touches.ONE){case Ia.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(t),this.state=xi.TOUCH_ROTATE;break;case Ia.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(t),this.state=xi.TOUCH_PAN;break;default:this.state=xi.NONE}break;case 2:switch(this.touches.TWO){case Ia.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(t),this.state=xi.TOUCH_DOLLY_PAN;break;case Ia.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(t),this.state=xi.TOUCH_DOLLY_ROTATE;break;default:this.state=xi.NONE}break;default:this.state=xi.NONE}this.state!==xi.NONE&&this.dispatchEvent(qh)}function GA(t){switch(this._trackPointer(t),this.state){case xi.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(t),this.update();break;case xi.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(t),this.update();break;case xi.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(t),this.update();break;case xi.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(t),this.update();break;default:this.state=xi.NONE}}function qA(t){this.enabled!==!1&&t.preventDefault()}function WA(t){t.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function KA(t){t.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}const XA=new Xa({jti:io(),iat:Fp(),exp:Fp()+60*60*24,version:3,scope:{appId:"07b887be-6091-4eae-9c58-a903e0bd72f4",rooms:[{name:"*",methods:["create","close"],member:{name:"*",methods:["publish","subscribe"]}}]}}).encode("5tl2lhpB/9NzBfhkVw8vDYZeA9SiCYi7ZumfaoEHqQ0="),tm=document.getElementById("local-video"),$A=document.getElementById("join"),ZA=document.getElementById("leave"),YA=document.getElementById("room-name"),fh=document.getElementById("remote-media-area"),im=document.getElementById("my-id");let su=null;$A.onclick=async()=>{const t=document.getElementById("is-sender").checked,e=await rv.Create(XA),i=await xE.FindOrCreate(e,{type:"p2p",name:YA.value}),n=await i.join();if(im.textContent=n.id,t){const{video:r}=await Zp.createMicrophoneAudioAndCameraStream();await n.publish(r);const s=await Zp.createDataStream();await n.publish(s);const o=document.createElement("video");o.autoplay=!0,o.playsInline=!0,o.muted=!0,r.attach(o),o.style.display="none",document.body.appendChild(o),await o.play(),setInterval(()=>{console.log(" [] :",o.videoWidth,"x",o.videoHeight)},1e3);const c=()=>{const h=Date.now();s.write(JSON.stringify({type:"frame",frameSentAt:h})),o.requestVideoFrameCallback(()=>c())};o.requestVideoFrameCallback(()=>c()),r.attach(tm),await tm.play()}else{const r=[],s=async h=>{var p;if(h.publisher.id===n.id)return;const{stream:d}=await n.subscribe(h.id);if(((p=d.track)==null?void 0:p.kind)==="video"){const v=document.createElement("video");v.autoplay=!0,v.playsInline=!0,v.muted=!0,v.setAttribute("crossorigin","anonymous"),d.attach(v),v.style.width="300px",v.style.border="1px solid #ccc",v.style.margin="10px",fh.appendChild(v),v.onloadedmetadata=()=>{console.log(" :",v.videoWidth,"x",v.videoHeight)};const g=document.createElement("video");g.autoplay=!0,g.playsInline=!0,g.muted=!0,g.setAttribute("crossorigin","anonymous"),d.attach(g),g.style.display="none",g.onloadedmetadata=()=>{console.log(" three.js  :",g.videoWidth,"x",g.videoHeight)};let _=!1;const S=()=>{!_&&r.length>0&&g.readyState>=2&&v.readyState>=2&&(_=!0,g.play(),v.play(),su=JA(g,()=>r.shift()))};g.onloadeddata=()=>S(),v.onloadeddata=()=>S();const E=setInterval(()=>{_?clearInterval(E):S()},100)}d.contentType==="data"&&(d.onData.add(v=>{try{const g=JSON.parse(v);if(g.type==="sync-request"){const _=Date.now();d.write(JSON.stringify({type:"sync-response",t1:g.t1,t2:_}))}else g.type==="frame"&&r.push(g.frameSentAt)}catch{}}),c(d))};let o=0;const c=h=>{const d=Date.now();h.write(JSON.stringify({type:"sync-request",t1:d}));const p=v=>{try{const g=JSON.parse(v);if(g.type==="sync-response"&&g.t1===d){const _=Date.now(),{t1:S,t2:E}=g,M=_-S,R=E-(S+M/2);o=R,console.log(` : offset = ${R} ms`),h.onData.remove(p)}}catch{}};h.onData.add(p)};i.publications.forEach(s),i.onStreamPublished.add(h=>s(h.publication))}ZA.onclick=async()=>{await n.leave(),await i.dispose(),im.textContent="",fh.innerHTML="",su&&su()}};function JA(t,e){const i=document.createElement("canvas");i.style.display="block",i.style.border="none",i.style.margin="0",i.style.width="100%",i.style.height="100%",i.style.maxWidth="none",i.style.maxHeight="none",i.style.cursor="pointer",fh.appendChild(i);const n=new VC,r=new rr(75,i.clientWidth/i.clientHeight,1,1100);r.position.set(0,0,.1);const s=new FA({canvas:i,antialias:!0});s.setSize(i.clientWidth,i.clientHeight),s.setPixelRatio(window.devicePixelRatio||1);const o=new zh(100,64,64);o.scale(-1,1,1);const c=new qC(t);c.minFilter=On,c.magFilter=On,c.format=Oh,c.generateMipmaps=!1;const h=new Vh({map:c}),d=new Or(o,h);n.add(d);const p=new LA(r,s.domElement);p.enableZoom=!0,p.zoomSpeed=1.2,p.minDistance=30,p.maxDistance=300,p.enablePan=!1,p.autoRotate=!1;const v=[];let g=performance.now(),_=0;const S=()=>{requestAnimationFrame(S),p.update(),s.render(n,r),_++;const R=performance.now(),N=R-g;if(N>=1e3){const m=_/N*1e3;console.log(` : ${m.toFixed(2)} fps`);const w=new Date().toLocaleTimeString();v.push({time:w,fps:m.toFixed(2),delay:""}),_=0,g=R}const b=e==null?void 0:e();if(b){const m=b+clockOffset,w=Date.now()-m;if(w>=0&&w<1e4){console.log(` : ${w} ms`);const T=new Date().toLocaleTimeString(),P=v[v.length-1];P&&P.time===T?P.delay=w:v.push({time:T,fps:"",delay:w})}else console.warn(` : ${w} ms`)}console.log("three.js :",t.videoWidth,"x",t.videoHeight),console.log("three.js canvas:",i.width,"x",i.height)};S();function E(){let R=`Time,FPS,Delay(ms)
`;v.forEach(w=>{R+=`${w.time},${w.fps},${w.delay}
`});const N=new Blob([R],{type:"text/csv"}),b=URL.createObjectURL(N),m=document.createElement("a");m.href=b,m.download="viewer_log.csv",m.click(),URL.revokeObjectURL(b)}const M=document.getElementById("downloadCsv");return M&&(M.onclick=E),()=>{clearInterval(infoInterval),i.remove(),s.dispose()}}
